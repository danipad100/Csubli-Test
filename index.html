<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Suite de Calculadoras</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&amp;display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#f7f7fb;--card:#fff;--ink:#222;--muted:#6b7280;
  --brand:#ff7aa2;--brand2:#7aa2ff;--ok:#22c55e;--danger:#ef4444;
  --radius:16px;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
  font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;line-height:1.35}
.app{max-width:1200px;margin:auto;padding:18px}
header{background:linear-gradient(120deg,var(--brand),var(--brand2));color:#fff;padding:18px;border-radius:var(--radius);
  box-shadow:0 10px 25px rgba(0,0,0,.10);display:flex;align-items:center;gap:14px;flex-wrap:wrap;justify-content:space-between}
header h1{margin:0;font-size:22px}
nav{display:flex;gap:8px;flex-wrap:wrap}
nav button{appearance:none;border:none;background:#ffffffee;color:#111;padding:10px 14px;border-radius:999px;font-weight:600;cursor:pointer;
  box-shadow:0 2px 6px rgba(0,0,0,.10);transition:.2s}
nav button.active{background:#111;color:#fff}
.view{display:none;margin-top:16px;padding:0}

.view.active{display:block}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
.card{grid-column:span 12;background:var(--card);border-radius:var(--radius);box-shadow:0 8px 20px rgba(0,0,0,.06);padding:16px;overflow:hidden}
@media(min-width:900px){.md-6{grid-column:span 6}.md-8{grid-column:span 8}.md-4{grid-column:span 4}.md-12{grid-column:span 12}.md-3{grid-column:span 3}}
label{font-size:12px;color:var(--muted);display:block;margin:6px 0 4px}
input[type="number"],input[type="text"],select{width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;font-size:14px}
input:focus,select:focus{outline:none;box-shadow:0 0 0 3px rgba(255,122,162,.25);border-color:#ffd1e1}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-start}
.btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
.btn.reset{background:var(--danger);color:#fff}
.btn.ok{background:var(--ok);color:#fff}
.btn.neutral{background:#111;color:#fff}
.muted{color:var(--muted)}
.result{font-weight:600}
.pill{display:inline-flex;align-items:center;gap:6px;background:#f3f4f6;border-radius:999px;padding:6px 10px;font-size:12px}
.sep{height:1px;background:#eee;margin:12px 0}
.tot{font-size:18px;font-weight:700}
.footer{margin:28px 0 8px;color:var(--muted);text-align:center}
.copy-btn{font-size:12px;border:none;background:#f3f4f6;border-radius:8px;padding:6px 8px;cursor:pointer}
.ud{background:#ffe8ee !important;font-weight:600}
.chk-label{font-weight:700}
#bloques{display:grid;grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap:14px;}
.color-preview{width:14px;height:14px;border-radius:4px;border:1px solid #e5e7eb;display:inline-block;vertical-align:middle;margin-right:6px}
/* Dark mode */
body.dark{background:#0f1115;color:#e5e7eb}
body.dark header{box-shadow:none}
body.dark .card{background:#151924;box-shadow:none;border:1px solid #23283a; background:#151924 !important;}
body.dark .pill,.dark .chip{background:#1b2030;border-color:#2a3147;color:#e5e7eb}
body.dark input[type="number"],body.dark input[type="text"],body.dark select{background:#0f1115;color:#e5e7eb;border-color:#2a3147}
body.dark .copy-btn{background:#1b2030;color:#e5e7eb}
body.dark nav button{background:#1b2030;color:#e5e7eb}
body.dark nav button.active{background:#e5e7eb;color:#0f1115}
body.dark .ud{background:#5e3c49 !important;color:#fff}
.center-actions{display:flex;gap:12px;justify-content:center;margin-top:12px;flex-wrap:wrap}
@media print{
  header, nav, .copy-btn, .btn.reset, .btn.ok, .btn.neutral, .footer, .center-actions{display:none !important}
  body{background:#fff}
  .view{display:none !important}
  .view.active{display:block !important}
  .card{box-shadow:none !important;border:1px solid #ddd}
}

/* === Vinil summary helpers === */
.mono{ font-variant-numeric: tabular-nums; }
#vinil_summary strong{ transition: opacity .15s ease; }
#vinil_summary strong.upd{ opacity:.25 }

/* Alinear todos los módulos al header */
.view > .grid{margin:0}

.view { padding: 0; margin-top: 16px }
.view > .grid { margin: 0 }

/* === Unificar estilo con módulo Etiquetas (aplica a Vinil y DTF) === */
#view-vinil #vinil_costos_directos,
#view-vinil #vinil_depreciacion,
#view-vinil #vinil_gi_card,
#view-vinil #vinil_summary,
#view-dtf .card.md-6,
#view-dtf .card.md-12 {
  background:#fff !important;
}

/* Títulos y espaciado consistentes */
#view-vinil h3, #view-vinil h4,
#view-dtf h3, #view-dtf h4 {
  margin:0 0 10px;
}

/* Costo Ud.  */
#view-vinil input.dep_ud{ background:#ffe8ee !important; font-weight:600; }

/* Costo x Mes  */
#view-vinil input.dep_mes{  background:#ffe8ee !important; font-weight:600; }


/* Bordes/preview DTF como Etiquetas */
#dtf_layout {
  border:1px solid #eee;
  border-radius:12px;
}

/* Cards más compactas como en Etiquetas */
#view-vinil .card, #view-dtf .card {
  padding:16px;
  box-shadow:0 8px 20px rgba(0,0,0,.06);
  border-radius:var(--radius);
}

/* === Costos indirectos — Método A (compacto) === */
.indA-card .row > div { min-width: 140px; }
.indA-card input[type="text"], .indA-card input[type="number"] { max-width:220px;border-radius:14px;padding:10px; }
.indA-pill { background:#eef6ff; }
.indA-ud { background:#eaf7ef;font-weight:600 }
.indA-small { max-width:120px }

/* === Costos indirectos (compacto) === */
.indA-card .row > div { min-width: 140px; }
.indA-card input[type="text"], .indA-card input[type="number"] { max-width:220px;border-radius:14px;padding:10px; }
.indA-pill { background:#eef6ff; }
.indA-ud { background:#eaf7ef;font-weight:600 }
.indA-small { max-width:120px }


/* === Mobile App Hamburger Menu === */
.burger{width:42px;height:42px;border-radius:12px;background:#ffffff22;display:grid;place-items:center;
  border:1px solid #ffffff3a;cursor:pointer;transition:.2s;-webkit-tap-highlight-color:transparent}
.burger:active{transform:scale(.96)}
.overlay{position:fixed;inset:0;background:rgba(15,17,21,.45);opacity:0;pointer-events:none;transition:opacity .25s ease}
.drawer{position:fixed;inset:0 auto 0 0;width:min(86vw,340px);background:var(--card);transform:translateX(-105%);
  transition:transform .28s ease;box-shadow:0 10px 40px rgba(0,0,0,.2);border-radius:0 18px 18px 0;display:flex;flex-direction:column;z-index:60}
.drawer header{display:flex;align-items:center;gap:10px;padding:16px;border-bottom:1px solid #eee}
.drawer .brand-dot{width:10px;height:10px;border-radius:50%;background:var(--brand);box-shadow: 14px 0 0 0 var(--brand2)}
.drawer .brand-name{font-weight:800}
.drawer .menu{padding:10px}
.menu .item{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:14px;cursor:pointer;user-select:none;
  -webkit-tap-highlight-color:transparent;transition:background .18s ease, transform .06s ease}
.menu .item:hover{background:#f3f4f6}
.menu .item:active{transform:scale(.98)}
.menu .item .ico{width:22px;height:22px;opacity:.9}
.menu .item .txt{font-weight:600}
.menu .group{margin:10px 10px 0;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.12em}
.menu .item[data-active="true"]{background:linear-gradient(120deg,#ffe3ee,#e8efff)}
/* Dark harmony */
body.dark .drawer{background:#151924;border:1px solid #23283a}
body.dark .menu .item:hover{background:#1b2030}
/* Active item contrast in dark mode */
body.dark .drawer .menu .item[data-active="true"]{
  background:linear-gradient(120deg,#ffe3ee,#e8efff);
  color:#111827;
}
body.dark .drawer .menu .item[data-active="true"] .txt{
  color:#111827;
}
body.dark .drawer .menu .item[data-active="true"] .ico{
  color:#111827;
}


/* === Drawer scroll fix === */
.drawer{height:100vh; max-height:100vh; overflow:hidden; z-index:1000}
.drawer .menu{flex:1; overflow-y:auto; padding-bottom:18px; overscroll-behavior:contain; -webkit-overflow-scrolling:touch}
.overlay{z-index:999}

.drawer .group{
  text-align:center!important;
  font-weight:600;
  letter-spacing:1px;
}

.drawer .group{
  text-align:center!important;
  font-weight:600;
  margin-top:10px;
  margin-bottom:6px;
  letter-spacing:1px;
}

.drawer header{
  display:flex;
  align-items:center;
  justify-content:center!important;
  text-align:center;
}
.drawer .brand-name{
  width:100%;
  text-align:center;
  font-weight:700;
}
.drawer .group{
  text-align:center!important;
  font-weight:600;
  margin-top:14px;
  margin-bottom:10px;
}

/* Force left alignment for menu items */
.drawer .menu .item{
  text-align:left!important;
  justify-content:flex-start!important;
}
.drawer .menu .item .txt{
  text-align:left!important;
}
<style>
:root{
  --bg:#f7f7fb;--card:#fff;--ink:#222;--muted:#6b7280;
  --brand:#ff7aa2;--brand2:#7aa2ff;--ok:#22c55e;--danger:#ef4444;
  --radius:16px;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
  font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;line-height:1.35}
.app{max-width:1200px;margin:auto;padding:18px}
header{background:linear-gradient(120deg,var(--brand),var(--brand2));color:#fff;padding:18px;border-radius:var(--radius);
  box-shadow:0 10px 25px rgba(0,0,0,.10);display:flex;align-items:center;gap:14px;flex-wrap:wrap;justify-content:space-between}
header h1{margin:0;font-size:22px}
nav{display:flex;gap:8px;flex-wrap:wrap}
nav button{appearance:none;border:none;background:#ffffffee;color:#111;padding:10px 14px;border-radius:999px;font-weight:600;cursor:pointer;
  box-shadow:0 2px 6px rgba(0,0,0,.10);transition:.2s}
nav button.active{background:#111;color:#fff}
.view{display:none;margin-top:16px;padding:0}

.view.active{display:block}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
.card{grid-column:span 12;background:var(--card);border-radius:var(--radius);box-shadow:0 8px 20px rgba(0,0,0,.06);padding:16px;overflow:hidden}
@media(min-width:900px){.md-6{grid-column:span 6}.md-8{grid-column:span 8}.md-4{grid-column:span 4}.md-12{grid-column:span 12}.md-3{grid-column:span 3}}
label{font-size:12px;color:var(--muted);display:block;margin:6px 0 4px}
input[type="number"],input[type="text"],select{width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;font-size:14px}
input:focus,select:focus{outline:none;box-shadow:0 0 0 3px rgba(255,122,162,.25);border-color:#ffd1e1}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-start}
.btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
.btn.reset{background:var(--danger);color:#fff}
.btn.ok{background:var(--ok);color:#fff}
.btn.neutral{background:#111;color:#fff}
.muted{color:var(--muted)}
.result{font-weight:600}
.pill{display:inline-flex;align-items:center;gap:6px;background:#f3f4f6;border-radius:999px;padding:6px 10px;font-size:12px}
.sep{height:1px;background:#eee;margin:12px 0}
.tot{font-size:18px;font-weight:700}
.footer{margin:28px 0 8px;color:var(--muted);text-align:center}
.copy-btn{font-size:12px;border:none;background:#f3f4f6;border-radius:8px;padding:6px 8px;cursor:pointer}
.ud{background:#ffe8ee !important;font-weight:600}
.chk-label{font-weight:700}
#bloques{display:grid;grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap:14px;}
.color-preview{width:14px;height:14px;border-radius:4px;border:1px solid #e5e7eb;display:inline-block;vertical-align:middle;margin-right:6px}
/* Dark mode */
body.dark{background:#0f1115;color:#e5e7eb}
body.dark header{box-shadow:none}
body.dark .card{background:#151924;box-shadow:none;border:1px solid #23283a; background:#151924 !important;}
body.dark .pill,.dark .chip{background:#1b2030;border-color:#2a3147;color:#e5e7eb}
body.dark input[type="number"],body.dark input[type="text"],body.dark select{background:#0f1115;color:#e5e7eb;border-color:#2a3147}
body.dark .copy-btn{background:#1b2030;color:#e5e7eb}
body.dark nav button{background:#1b2030;color:#e5e7eb}
body.dark nav button.active{background:#e5e7eb;color:#0f1115}
body.dark .ud{background:#5e3c49 !important;color:#fff}
.center-actions{display:flex;gap:12px;justify-content:center;margin-top:12px;flex-wrap:wrap}
@media print{
  header, nav, .copy-btn, .btn.reset, .btn.ok, .btn.neutral, .footer, .center-actions{display:none !important}
  body{background:#fff}
  .view{display:none !important}
  .view.active{display:block !important}
  .card{box-shadow:none !important;border:1px solid #ddd}
}

/* === Vinil summary helpers === */
.mono{ font-variant-numeric: tabular-nums; }
#vinil_summary strong{ transition: opacity .15s ease; }
#vinil_summary strong.upd{ opacity:.25 }

/* Alinear todos los módulos al header */
.view > .grid{margin:0}

.view { padding: 0; margin-top: 16px }
.view > .grid { margin: 0 }

/* === Unificar estilo con módulo Etiquetas (aplica a Vinil y DTF) === */
#view-vinil #vinil_costos_directos,
#view-vinil #vinil_depreciacion,
#view-vinil #vinil_gi_card,
#view-vinil #vinil_summary,
#view-dtf .card.md-6,
#view-dtf .card.md-12 {
  background:#fff !important;
}

/* Títulos y espaciado consistentes */
#view-vinil h3, #view-vinil h4,
#view-dtf h3, #view-dtf h4 {
  margin:0 0 10px;
}

/* Costo Ud.  */
#view-vinil input.dep_ud{ background:#ffe8ee !important; font-weight:600; }

/* Costo x Mes  */
#view-vinil input.dep_mes{  background:#ffe8ee !important; font-weight:600; }


/* Bordes/preview DTF como Etiquetas */
#dtf_layout {
  border:1px solid #eee;
  border-radius:12px;
}

/* Cards más compactas como en Etiquetas */
#view-vinil .card, #view-dtf .card {
  padding:16px;
  box-shadow:0 8px 20px rgba(0,0,0,.06);
  border-radius:var(--radius);
}

/* === Costos indirectos — Método A (compacto) === */
.indA-card .row > div { min-width: 140px; }
.indA-card input[type="text"], .indA-card input[type="number"] { max-width:220px;border-radius:14px;padding:10px; }
.indA-pill { background:#eef6ff; }
.indA-ud { background:#eaf7ef;font-weight:600 }
.indA-small { max-width:120px }

/* === Costos indirectos (compacto) === */
.indA-card .row > div { min-width: 140px; }
.indA-card input[type="text"], .indA-card input[type="number"] { max-width:220px;border-radius:14px;padding:10px; }
.indA-pill { background:#eef6ff; }
.indA-ud { background:#eaf7ef;font-weight:600 }
.indA-small { max-width:120px }


/* === Mobile App Hamburger Menu === */
.burger{width:42px;height:42px;border-radius:12px;background:#ffffff22;display:grid;place-items:center;
  border:1px solid #ffffff3a;cursor:pointer;transition:.2s;-webkit-tap-highlight-color:transparent}
.burger:active{transform:scale(.96)}
.overlay{position:fixed;inset:0;background:rgba(15,17,21,.45);opacity:0;pointer-events:none;transition:opacity .25s ease}
.drawer{position:fixed;inset:0 auto 0 0;width:min(86vw,340px);background:var(--card);transform:translateX(-105%);
  transition:transform .28s ease;box-shadow:0 10px 40px rgba(0,0,0,.2);border-radius:0 18px 18px 0;display:flex;flex-direction:column;z-index:60}
.drawer header{display:flex;align-items:center;gap:10px;padding:16px;border-bottom:1px solid #eee}
.drawer .brand-dot{width:10px;height:10px;border-radius:50%;background:var(--brand);box-shadow: 14px 0 0 0 var(--brand2)}
.drawer .brand-name{font-weight:800}
.drawer .menu{padding:10px}
.menu .item{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:14px;cursor:pointer;user-select:none;
  -webkit-tap-highlight-color:transparent;transition:background .18s ease, transform .06s ease}
.menu .item:hover{background:#f3f4f6}
.menu .item:active{transform:scale(.98)}
.menu .item .ico{width:22px;height:22px;opacity:.9}
.menu .item .txt{font-weight:600}
.menu .group{margin:10px 10px 0;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.12em}
.menu .item[data-active="true"]{background:linear-gradient(120deg,#ffe3ee,#e8efff)}
/* Dark harmony */
body.dark .drawer{background:#151924;border:1px solid #23283a}
body.dark .menu .item:hover{background:#1b2030}
/* Active item contrast in dark mode */
body.dark .drawer .menu .item[data-active="true"]{
  background:linear-gradient(120deg,#ffe3ee,#e8efff);
  color:#111827;
}
body.dark .drawer .menu .item[data-active="true"] .txt{
  color:#111827;
}
body.dark .drawer .menu .item[data-active="true"] .ico{
  color:#111827;
}


/* === Drawer scroll fix === */
.drawer{height:100vh; max-height:100vh; overflow:hidden; z-index:1000}
.drawer .menu{flex:1; overflow-y:auto; padding-bottom:18px; overscroll-behavior:contain; -webkit-overflow-scrolling:touch}
.overlay{z-index:999}

.drawer .group{
  text-align:center!important;
  font-weight:600;
  letter-spacing:1px;
}

.drawer .group{
  text-align:center!important;
  font-weight:600;
  margin-top:10px;
  margin-bottom:6px;
  letter-spacing:1px;
}

.drawer header{
  display:flex;
  align-items:center;
  justify-content:center!important;
  text-align:center;
}
.drawer .brand-name{
  width:100%;
  text-align:center;
  font-weight:700;
}
.drawer .group{
  text-align:center!important;
  font-weight:600;
  margin-top:14px;
  margin-bottom:10px;
}

/* Force left alignment for menu items */
.drawer .menu .item{
  text-align:left!important;
  justify-content:flex-start!important;
}
.drawer .menu .item .txt{
  text-align:left!important;
}

/* Menu label next to burger */
header .menu-label{
  font-weight:600;
  font-size:14px;
  color:#fff;
  margin-left:4px;
  opacity:0.92;
  user-select:none;
}
/* Ensure burger+label stay aligned */
header{ display:flex; align-items:center; gap:8px; }


/* Título más pequeño en móviles para que quepa en una sola línea */
@media (max-width: 840px){
  .app-header h1{
    font-size:16px;
    white-space:nowrap;
  }
}


/* Responsive nav overlay */
@media (max-width: 840px){
  nav{
    position: fixed;
    top: 64px;
    left: 12px;
    right: 12px;
    max-height: calc(100vh - 88px);
    overflow:auto;
    z-index: 1000;
  }
}


.menu-wrapper .menu-label{margin-left:2px !important;}

</style>
<style>input,select,textarea{font-size:16px!important}html,body{min-height:100vh;height:-webkit-fill-available}
/* Menu label next to burger */
header .menu-label{
  font-weight:600;
  font-size:14px;
  color:#fff;
  margin-left:4px;
  opacity:0.92;
  user-select:none;
}
/* Ensure burger+label stay aligned */
header{ display:flex; align-items:center; gap:8px; }


/* Responsive nav overlay */
@media (max-width: 840px){
  nav{
    position: fixed;
    top: 64px;
    left: 12px;
    right: 12px;
    max-height: calc(100vh - 88px);
    overflow:auto;
    z-index: 1000;
  }
}


.menu-wrapper .menu-label{margin-left:2px !important;}

</style>
<style id="papeleria-compact-css">
  /* Scope strictly to Papelería */
  #view-papeleria .row { gap: 8px; }
  #view-papeleria label { font-size: 13px; }

  /* Inputs / selects size equal to Sublimación */
  #view-papeleria input[type="text"],
  #view-papeleria input[type="number"],
  #view-papeleria select {
    height: 36px;
    padding: 6px 10px;
    font-size: 14px;
    line-height: 1.2;
  }
  /* Readonly unit fields (Costo Ud., costo x Mes) */
  #view-papeleria input.ud[readonly] {
    height: 36px;
    padding: 6px 10px;
    font-size: 14px;
  }
  /* Layout columns for Cant / Precio / Costo Ud. */
  #view-papeleria .row > div {
    min-width: 120px !important;
    flex: 1 1 0;
  }
  /* Compact selects for Sustrato/Adhesivo */
  #view-papeleria select {
    min-width: 240px;
  }
  /* Optional tighter vertical rhythm */
  #view-papeleria h4 { margin: 0 0 8px; }
  #view-papeleria .sep { margin: 10px 0; }

/* Menu label next to burger */
header .menu-label{
  font-weight:600;
  font-size:14px;
  color:#fff;
  margin-left:4px;
  opacity:0.92;
  user-select:none;
}
/* Ensure burger+label stay aligned */
header{ display:flex; align-items:center; gap:8px; }


/* Responsive nav overlay */
@media (max-width: 840px){
  nav{
    position: fixed;
    top: 64px;
    left: 12px;
    right: 12px;
    max-height: calc(100vh - 88px);
    overflow:auto;
    z-index: 1000;
  }
}


.menu-wrapper .menu-label{margin-left:2px !important;}

</style>
<style>
/* GI visual match — Papelería */
#view-papeleria input[type="number"]{height:38px}
#view-papeleria label{margin-bottom:4px;display:block}

/* Menu label next to burger */
header .menu-label{
  font-weight:600;
  font-size:14px;
  color:#fff;
  margin-left:4px;
  opacity:0.92;
  user-select:none;
}
/* Ensure burger+label stay aligned */
header{ display:flex; align-items:center; gap:8px; }


/* Responsive nav overlay */
@media (max-width: 840px){
  nav{
    position: fixed;
    top: 64px;
    left: 12px;
    right: 12px;
    max-height: calc(100vh - 88px);
    overflow:auto;
    z-index: 1000;
  }
}


.menu-wrapper .menu-label{margin-left:2px !important;}

</style>
<style>
/* --- Papelería: Alineación exacta de Ganancia/Impuestos (match Sublimación/Vinil) --- */
#view-papeleria #pap_gi_row .gi-col input[type="number"]{height:42px; padding:8px 12px; width:100%; box-sizing:border-box;}
#view-papeleria #pap_gi_row label{font-weight:500;}
/* Evita saltos verticales por checkbox */
#view-papeleria #pap_gi_row input[type="checkbox"]{transform: translateY(1px);}

/* Menu label next to burger */
header .menu-label{
  font-weight:600;
  font-size:14px;
  color:#fff;
  margin-left:4px;
  opacity:0.92;
  user-select:none;
}
/* Ensure burger+label stay aligned */
header{ display:flex; align-items:center; gap:8px; }


/* Responsive nav overlay */
@media (max-width: 840px){
  nav{
    position: fixed;
    top: 64px;
    left: 12px;
    right: 12px;
    max-height: calc(100vh - 88px);
    overflow:auto;
    z-index: 1000;
  }
}


.menu-wrapper .menu-label{margin-left:2px !important;}

</style>
<style>
/* --- Esferas: Mano de obra layout --- */
#view-esferas-navidenas #esf_mo_cfg{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;margin-top:6px}
#view-esferas-navidenas #esf_mo_cfg>div{flex:1 1 220px;min-width:200px}
#view-esferas-navidenas #esf_mo_cfg>div.mo-unidades{flex:1 1 100%;max-width:360px}
#view-esferas-navidenas #esf_mo_cfg input[type="text"]{width:100%}
/* --- end Esferas: Mano de obra layout --- */

/* Menu label next to burger */
header .menu-label{
  font-weight:600;
  font-size:14px;
  color:#fff;
  margin-left:4px;
  opacity:0.92;
  user-select:none;
}
/* Ensure burger+label stay aligned */
header{ display:flex; align-items:center; gap:8px; }


/* Responsive nav overlay */
@media (max-width: 840px){
  nav{
    position: fixed;
    top: 64px;
    left: 12px;
    right: 12px;
    max-height: calc(100vh - 88px);
    overflow:auto;
    z-index: 1000;
  }
}


.menu-wrapper .menu-label{margin-left:2px !important;}

</style>
<style>

/* === FIX — Alinear "Costo de Vinil" a la izquierda y centrar "MÓDULOS" === */
nav button {
  text-align: left !important;
  justify-content: flex-start !important;
  padding-left: 18px !important;
}
nav button.active {
  text-align: left !important;
  justify-content: flex-start !important;
}
.drawer .group {
  width: 100%;
  text-align: center !important;
  display: block;
  margin-top: 12px;
  margin-bottom: 8px;
}
/* Asegurar alineación izquierda en los items del menú */
.drawer .menu .item{
  text-align:left!important;
  justify-content:flex-start!important;
}
.drawer .menu .item .txt{
  text-align:left!important;
}


/* Menu label next to burger */
header .menu-label{
  font-weight:600;
  font-size:14px;
  color:#fff;
  margin-left:4px;
  opacity:0.92;
  user-select:none;
}
/* Ensure burger+label stay aligned */
header{ display:flex; align-items:center; gap:8px; }


/* Responsive nav overlay */
@media (max-width: 840px){
  nav{
    position: fixed;
    top: 64px;
    left: 12px;
    right: 12px;
    max-height: calc(100vh - 88px);
    overflow:auto;
    z-index: 1000;
  }
}


.menu-wrapper .menu-label{margin-left:2px !important;}

</style>
<style>
/* --- Burger optical centering tweak --- */
.burger { display:grid; place-items:center; padding:0; }
.burger svg { display:block; }

/* Menu label next to burger */
header .menu-label{
  font-weight:600;
  font-size:14px;
  color:#fff;
  margin-left:4px;
  opacity:0.92;
  user-select:none;
}
/* Ensure burger+label stay aligned */
header{ display:flex; align-items:center; gap:8px; }


/* Responsive nav overlay */
@media (max-width: 840px){
  nav{
    position: fixed;
    top: 64px;
    left: 12px;
    right: 12px;
    max-height: calc(100vh - 88px);
    overflow:auto;
    z-index: 1000;
  }
}


.menu-wrapper .menu-label{margin-left:2px !important;}

</style>
<style>
/* Burger minimal icon cleanup */
.burger { display:grid; place-items:center; }
.burger svg { display:block; }

/* Menu label next to burger */
header .menu-label{
  font-weight:600;
  font-size:14px;
  color:#fff;
  margin-left:4px;
  opacity:0.92;
  user-select:none;
}
/* Ensure burger+label stay aligned */
header{ display:flex; align-items:center; gap:8px; }


/* Responsive nav overlay */
@media (max-width: 840px){
  nav{
    position: fixed;
    top: 64px;
    left: 12px;
    right: 12px;
    max-height: calc(100vh - 88px);
    overflow:auto;
    z-index: 1000;
  }
}


.menu-wrapper .menu-label{margin-left:2px !important;}

</style>
<style>
/* Burger icon centering */
.burger { display:grid; place-items:center; }
.burger svg { display:block; }

/* Menu label next to burger */
header .menu-label{
  font-weight:600;
  font-size:14px;
  color:#fff;
  margin-left:4px;
  opacity:0.92;
  user-select:none;
}
/* Ensure burger+label stay aligned */
header{ display:flex; align-items:center; gap:8px; }


/* Responsive nav overlay */
@media (max-width: 840px){
  nav{
    position: fixed;
    top: 64px;
    left: 12px;
    right: 12px;
    max-height: calc(100vh - 88px);
    overflow:auto;
    z-index: 1000;
  }
}


.menu-wrapper .menu-label{margin-left:2px !important;}

</style>
<style>
/* Burger icon centering */
.burger { display:grid; place-items:center; }
.burger svg { display:block; }

/* Menu label next to burger */
header .menu-label{
  font-weight:600;
  font-size:14px;
  color:#fff;
  margin-left:4px;
  opacity:0.92;
  user-select:none;
}
/* Ensure burger+label stay aligned */
header{ display:flex; align-items:center; gap:8px; }


/* Responsive nav overlay */
@media (max-width: 840px){
  nav{
    position: fixed;
    top: 64px;
    left: 12px;
    right: 12px;
    max-height: calc(100vh - 88px);
    overflow:auto;
    z-index: 1000;
  }
}


.menu-wrapper .menu-label{margin-left:2px !important;}

</style>
<style>
/* THEME TOKENS */
:root{
  --bg: #f6f7fb;
  --text: #1b2430;
  --muted: #6b7280;
  --card: #ffffff;
  --card-border: #e5e7eb;
  --pill: #eef2ff;
  --pill-text: #1e293b;
  --accent: #2563eb;
  --accent-contrast: #ffffff;
  --danger: #ef4444;
  --input-bg: #ffffff;
  --input-border: #d1d5db;
  --shadow: 0 6px 18px rgba(2,6,23,.08);
}
html[data-theme="dark"]{
  --bg: #0f1115;            /* slate-900 */
  --text: #e5e7eb;
  --muted: #94a3b8;
  --card: #111827;          /* gray-900 */
  --card-border: #1f2937;   /* gray-800 */
  --pill: #111827;
  --pill-text: #e5e7eb;
  --accent: #60a5fa;        /* blue-400 */
  --accent-contrast: #0b1220;
  --danger: #f87171;
  --input-bg: #0b1220;
  --input-border: #1f2937;
  --shadow: 0 8px 24px rgba(0,0,0,.45);
}

/* APPLY TOKENS */
body{ background: var(--bg); color: var(--text); }
.card{ background: var(--card) !important; border:1px solid var(--card-border); box-shadow: var(--shadow); }
label, .muted{ color: var(--muted); }
input[type=number], input[type=text], select{
  background: var(--input-bg); color: var(--text); border:1px solid var(--input-border);
  border-radius: 10px; padding: 6px 10px;
}
input:disabled, select:disabled{ opacity:.6; cursor:not-allowed; }
button, .copy-btn, .btn{
  background: var(--accent); color: var(--accent-contrast); border:none; border-radius: 10px; padding: 8px 12px; font-weight:600;
}
button.reset{ background: transparent; color: var(--text); border:1px dashed var(--muted); }
button:hover{ filter: brightness(1.05); }
.pill{ background: var(--pill); color: var(--pill-text); border:1px solid var(--card-border); }
.sep{ border-bottom:1px dashed var(--card-border); opacity:.65; }
.excluded{ opacity: .55; filter: grayscale(15%); }

/* Focus & selection */
:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; border-radius: 8px; }
::selection{ background: var(--accent); color: var(--accent-contrast); }

/* Views behavior */
.view{ display:none; }
.view.active{ display:block; }

/* Scrollbar (WebKit) */
*::-webkit-scrollbar{ width:10px; height:10px; }
*::-webkit-scrollbar-thumb{ background: var(--card-border); border-radius: 12px; }
html[data-theme="dark"] *::-webkit-scrollbar-thumb{ background:#293445; }

/* === Vinil summary helpers === */
.mono{ font-variant-numeric: tabular-nums; }
#vinil_summary strong{ transition: opacity .15s ease; }
#vinil_summary strong.upd{ opacity:.25 }

/* Menu label next to burger */
header .menu-label{
  font-weight:600;
  font-size:14px;
  color:#fff;
  margin-left:4px;
  opacity:0.92;
  user-select:none;
}
/* Ensure burger+label stay aligned */
header{ display:flex; align-items:center; gap:8px; }


/* Responsive nav overlay */
@media (max-width: 840px){
  nav{
    position: fixed;
    top: 64px;
    left: 12px;
    right: 12px;
    max-height: calc(100vh - 88px);
    overflow:auto;
    z-index: 1000;
  }
}


.menu-wrapper .menu-label{margin-left:2px !important;}

</style>
<style id="view-active-compat">
/* Compatibilidad: si alguna vista usa atributo [active] en vez de clase .active */
.view[active]{ display:block; }

/* === Ajuste 2: asegurar estilo Etiquetas en Vinil + DTF === */
#view-vinil .card, #view-dtf .card{
  background:#fff !important;
  border:1px solid #e9eef5;
  box-shadow:0 8px 20px rgba(0,0,0,.06);
  border-radius:12px;
  padding:16px;
}
#view-vinil h3, #view-dtf h3{ margin:0 0 10px; font-weight:700; }
#view-vinil h4, #view-dtf h4{ margin:0 0 8px; font-weight:600; }

/* Campos 'Costo Ud.' con el mismo look rosa del módulo Etiquetas */
#view-vinil .dep_ud, #view-dtf .dep_ud,
#view-vinil .ud, #view-dtf .ud{
  background:#ffe8ee !important;
  font-weight:600;
}

/* Canvas / layout DTF bordeado como en Etiquetas */
#view-dtf #dtf_layout{
  border:1px solid #eee;
  border-radius:12px;
}

/* Menu label next to burger */
header .menu-label{
  font-weight:600;
  font-size:14px;
  color:#fff;
  margin-left:4px;
  opacity:0.92;
  user-select:none;
}
/* Ensure burger+label stay aligned */
header{ display:flex; align-items:center; gap:8px; }


/* Responsive nav overlay */
@media (max-width: 840px){
  nav{
    position: fixed;
    top: 64px;
    left: 12px;
    right: 12px;
    max-height: calc(100vh - 88px);
    overflow:auto;
    z-index: 1000;
  }
}


.menu-wrapper .menu-label{margin-left:2px !important;}

</style>
<style id="dark-fix-vinil-dtf-like-sublimacion">
/* === Dark mode fix: Vinil + DTF con el mismo look que Sublimación (solo CSS) === */
body.dark #view-vinil .card,
body.dark #view-dtf .card{
  background:#151924 !important;           /* mismo que Sublimación */
  color:#e5e7eb !important;
  border:1px solid #23283a !important;
  box-shadow:none !important;
}
body.dark #view-vinil .sep,
body.dark #view-dtf .sep{
  border-color:#23283a !important;
  opacity:.9;
}

/* inputs & selects */
body.dark #view-vinil input[type="text"],
body.dark #view-vinil input[type="number"],
body.dark #view-vinil select,
body.dark #view-dtf  input[type="text"],
body.dark #view-dtf  input[type="number"],
body.dark #view-dtf  select{
  background:#0f1115 !important;
  color:#e5e7eb !important;
  border-color:#2a3147 !important;
}
body.dark #view-vinil input:focus, body.dark #view-vinil select:focus,
body.dark #view-dtf  input:focus, body.dark #view-dtf  select:focus{
  outline:none;
  box-shadow:0 0 0 2px #3b82f6 !important;  /* foco azul */
  border-color:#3b82f6 !important;
}

/* pills y chips */
body.dark #view-vinil .pill, body.dark #view-vinil .chip,
body.dark #view-dtf  .pill, body.dark #view-dtf  .chip{
  background:#1b2030 !important;
  border-color:#2a3147 !important;
  color:#e5e7eb !important;
}
body.dark #view-vinil .pill .result, body.dark #view-vinil .chip .result,
body.dark #view-dtf  .pill .result, body.dark #view-dtf  .chip .result{
  background:#23283a !important;
  color:#e5e7eb !important;
}

/* botones */
body.dark #view-vinil .btn, body.dark #view-dtf .btn{
  background:#2563eb !important;
  color:#fff !important;
  border-color:#2563eb !important;
}

/* Menu label next to burger */
header .menu-label{
  font-weight:600;
  font-size:14px;
  color:#fff;
  margin-left:4px;
  opacity:0.92;
  user-select:none;
}
/* Ensure burger+label stay aligned */
header{ display:flex; align-items:center; gap:8px; }


/* Responsive nav overlay */
@media (max-width: 840px){
  nav{
    position: fixed;
    top: 64px;
    left: 12px;
    right: 12px;
    max-height: calc(100vh - 88px);
    overflow:auto;
    z-index: 1000;
  }
}


.menu-wrapper .menu-label{margin-left:2px !important;}

</style>
<style id="dark-vinil-below-merma">
/* ===== Dark mode Vinil: seccion inferior (no tocar Merma) ===== */
body.dark #view-vinil #vinil_costos_directos.card,
body.dark #view-vinil #vinil_depreciacion.card,
body.dark #view-vinil #vinil_summary.card,
body.dark #view-vinil #vin_ind_card.card,
body.dark #view-vinil #vinil_gi_card.card{
  background:#151924 !important;
  color:#e5e7eb !important;
  border:1px solid #23283a !important;
  box-shadow:none !important;
}

/* separadores */
body.dark #view-vinil #vinil_costos_directos .sep,
body.dark #view-vinil #vinil_depreciacion .sep,
body.dark #view-vinil #vinil_summary .sep,
body.dark #view-vinil #vin_ind_card .sep,
body.dark #view-vinil #vinil_gi_card .sep{
  background:#23283a !important;
  opacity:.9;
}

/* labels y textos secundarios */
body.dark #view-vinil #vinil_costos_directos label,
body.dark #view-vinil #vinil_depreciacion label,
body.dark #view-vinil #vinil_summary label,
body.dark #view-vinil #vin_ind_card label,
body.dark #view-vinil #vinil_gi_card label,
body.dark #view-vinil #vinil_costos_directos .muted,
body.dark #view-vinil #vinil_depreciacion .muted,
body.dark #view-vinil #vinil_summary .muted,
body.dark #view-vinil #vin_ind_card .muted,
body.dark #view-vinil #vinil_gi_card .muted{
  color:#94a3b8 !important;
}

/* inputs y selects */
body.dark #view-vinil #vinil_costos_directos input[type="text"],
body.dark #view-vinil #vinil_costos_directos input[type="number"],
body.dark #view-vinil #vinil_costos_directos select,
body.dark #view-vinil #vinil_depreciacion input[type="text"],
body.dark #view-vinil #vinil_depreciacion input[type="number"],
body.dark #view-vinil #vinil_depreciacion select,
body.dark #view-vinil #vinil_gi_card input[type="text"],
body.dark #view-vinil #vinil_gi_card input[type="number"],
body.dark #view-vinil #vinil_gi_card select,
body.dark #view-vinil #vin_ind_card input[type="text"],
body.dark #view-vinil #vin_ind_card input[type="number"],
body.dark #view-vinil #vin_ind_card select{
  background:#0f1115 !important;
  color:#e5e7eb !important;
  border-color:#2a3147 !important;
}
body.dark #view-vinil #vinil_costos_directos input:focus,
body.dark #view-vinil #vinil_costos_directos select:focus,
body.dark #view-vinil #vinil_depreciacion input:focus,
body.dark #view-vinil #vinil_depreciacion select:focus,
body.dark #view-vinil #vinil_gi_card input:focus,
body.dark #view-vinil #vinil_gi_card select:focus,
body.dark #view-vinil #vin_ind_card input:focus,
body.dark #view-vinil #vin_ind_card select:focus{
  outline:none; box-shadow:0 0 0 2px #3b82f6 !important; border-color:#3b82f6 !important;
}

/* pills y chips */
body.dark #view-vinil #vinil_costos_directos .pill,
body.dark #view-vinil #vinil_depreciacion .pill,
body.dark #view-vinil #vinil_summary .pill,
body.dark #view-vinil #vin_ind_card .pill,
body.dark #view-vinil #vinil_gi_card .pill{
  background:#1b2030 !important; border-color:#2a3147 !important; color:#e5e7eb !important;
}
body.dark #view-vinil #vinil_costos_directos .pill .result,
body.dark #view-vinil #vinil_depreciacion .pill .result,
body.dark #view-vinil #vinil_summary .pill .result,
body.dark #view-vinil #vin_ind_card .pill .result,
body.dark #view-vinil #vinil_gi_card .pill .result{
  background:#23283a !important; color:#e5e7eb !important; padding:2px 6px; border-radius:999px;
}

/* botones (primarios, copiar, configurar) */
body.dark #view-vinil #vinil_costos_directos .btn,
body.dark #view-vinil #vinil_depreciacion .btn,
body.dark #view-vinil #vinil_summary .btn,
body.dark #view-vinil #vin_ind_card .btn,
body.dark #view-vinil #vinil_gi_card .btn{
  background:#2563eb !important; color:#fff !important; border-color:#2563eb !important;
}
body.dark #view-vinil #vinil_summary .copy-btn,
body.dark #view-vinil #vinil_gi_card .copy-btn{
  background:#1b2030 !important; color:#e5e7eb !important;
}

/* títulos ligeramente más claros */
body.dark #view-vinil #vinil_costos_directos h3,
body.dark #view-vinil #vinil_depreciacion h3,
body.dark #view-vinil #vinil_summary h3,
body.dark #view-vinil #vin_ind_card h4,
body.dark #view-vinil #vinil_gi_card h4{
  color:#f3f4f6 !important;
}

/* Menu label next to burger */
header .menu-label{
  font-weight:600;
  font-size:14px;
  color:#fff;
  margin-left:4px;
  opacity:0.92;
  user-select:none;
}
/* Ensure burger+label stay aligned */
header{ display:flex; align-items:center; gap:8px; }


/* Responsive nav overlay */
@media (max-width: 840px){
  nav{
    position: fixed;
    top: 64px;
    left: 12px;
    right: 12px;
    max-height: calc(100vh - 88px);
    overflow:auto;
    z-index: 1000;
  }
}


.menu-wrapper .menu-label{margin-left:2px !important;}

</style>
<style id="vinil-depreciacion-dark-like-sublimacion">
/* === VINIL – Depreciación: modo oscuro igual a Sublimación (CSS-only) === */
body.dark #view-vinil #vinil_depreciacion.card{
  background: #0f1522 !important;
  border: 1px solid #1f2536 !important;
  border-radius: 14px !important;
  color: #e7ecf6 !important;
}

/* Labels y textos secundarios dentro de la tarjeta */
body.dark #view-vinil #vinil_depreciacion.card label,
body.dark #view-vinil #vinil_depreciacion.card .muted{
  color: #9fb0c6 !important;
}

/* Inputs base (Precio, Vida útil, etc.) */
body.dark #view-vinil #vinil_depreciacion.card input[type="text"]{
  background: #0f1115 !important;
  color: #e7ecf6 !important;
  border: 1px solid #2a3147 !important;
  border-radius: 12px !important;
}

/* Foco azul, igual que Sublimación */
body.dark #view-vinil #vinil_depreciacion.card input[type="text"]:focus{
  outline: none !important;
  box-shadow: 0 0 0 2px #3b82f6 !important;
  border-color: #3b82f6 !important;
}

/* Rosado para 'costo x Mes' y 'Costo Ud.' (como Sublimación) */
body.dark #view-vinil #vinil_depreciacion.card input.dep_mes,
body.dark #view-vinil #vinil_depreciacion.card input.dep_ud{
  background: #5e3c49 !important;
  color: #ffffff !important;
  border-color: #5e3c49 !important;
  border-radius: 12px !important;
}

/* Mantener rosado aunque sean de solo lectura */
body.dark #view-vinil #vinil_depreciacion.card input.dep_mes[readonly],
body.dark #view-vinil #vinil_depreciacion.card input.dep_ud[readonly]{
  opacity: 1 !important;
}

/* Menu label next to burger */
header .menu-label{
  font-weight:600;
  font-size:14px;
  color:#fff;
  margin-left:4px;
  opacity:0.92;
  user-select:none;
}
/* Ensure burger+label stay aligned */
header{ display:flex; align-items:center; gap:8px; }


/* Responsive nav overlay */
@media (max-width: 840px){
  nav{
    position: fixed;
    top: 64px;
    left: 12px;
    right: 12px;
    max-height: calc(100vh - 88px);
    overflow:auto;
    z-index: 1000;
  }
}


.menu-wrapper .menu-label{margin-left:2px !important;}

</style>
<style id="vinil-depreciacion-dark-hotfix">
/* HOTFIX — Limitar cambios SOLO a 'costo x Mes' y 'Costo Ud.' en Vinil/Depreciación */
body.dark #view-vinil #vinil_depreciacion.card input.dep_mes,
body.dark #view-vinil #vinil_depreciacion.card input.dep_ud{
  background:#5e3c49 !important;
  color:#ffffff !important;
  border-color:#5e3c49 !important;
  border-radius:12px !important;
}

/* Neutral para el resto de inputs de esa tarjeta (por si quedaron rosados/contrastados) */
body.dark #view-vinil #vinil_depreciacion.card input[type="text"]:not(.dep_mes):not(.dep_ud){
  background:#0f1115 !important;
  color:#e7ecf6 !important;
  border:1px solid #2a3147 !important;
  border-radius:12px !important;
  box-shadow:none !important;
}
/* Focus azul solo cuando no son dep_mes/dep_ud (los rosados no necesitan foco) */
body.dark #view-vinil #vinil_depreciacion.card input[type="text"]:not(.dep_mes):not(.dep_ud):focus{
  outline:none !important;
  box-shadow:0 0 0 2px #3b82f6 !important;
  border-color:#3b82f6 !important;
}

/* Menu label next to burger */
header .menu-label{
  font-weight:600;
  font-size:14px;
  color:#fff;
  margin-left:4px;
  opacity:0.92;
  user-select:none;
}
/* Ensure burger+label stay aligned */
header{ display:flex; align-items:center; gap:8px; }


/* Responsive nav overlay */
@media (max-width: 840px){
  nav{
    position: fixed;
    top: 64px;
    left: 12px;
    right: 12px;
    max-height: calc(100vh - 88px);
    overflow:auto;
    z-index: 1000;
  }
}


.menu-wrapper .menu-label{margin-left:2px !important;}

</style>
<style id="vinil-color-card-dark-restore">
/* === Restaurar card de Color (Vinil) en modo oscuro, sin tocar lógica === */
body.dark #view-vinil .calc-block{
  background:#151924 !important;
  border:1px solid #23283a !important;
  border-radius:12px !important;
}
body.dark #view-vinil .calc-block label{ color:#9fb0c6 !important; }
body.dark #view-vinil .calc-block select{
  background:#0f1115 !important;
  color:#e5e7eb !important;
  border-color:#2a3147 !important;
  border-radius:10px !important;
}
body.dark #view-vinil .calc-block input[type="text"],
body.dark #view-vinil .calc-block input[type="number"]{
  background:#0f1115 !important;
  color:#e5e7eb !important;
  border:1px solid #2a3147 !important;
  border-radius:10px !important;
}
body.dark #view-vinil .calc-block input:focus,
body.dark #view-vinil .calc-block select:focus{
  outline:none !important;
  box-shadow:0 0 0 2px #3b82f6 !important;
  border-color:#3b82f6 !important;
}
/* Texto 'Costo: $ 0,00' y botón Copiar */
body.dark #view-vinil .calc-block [id^="resultado"]{ color:#cbd5e1 !important; }
body.dark #view-vinil .calc-block .copy-btn{
  background:#2563eb !important; color:#fff !important; border-color:#2563eb !important;
  border-radius:10px !important;
}
/* Botón eliminar del bloque */
body.dark #view-vinil .calc-block .copy-btn[data-remove]{
  background:#ef4444 !important; border-color:#ef4444 !important;
}

/* Menu label next to burger */
header .menu-label{
  font-weight:600;
  font-size:14px;
  color:#fff;
  margin-left:4px;
  opacity:0.92;
  user-select:none;
}
/* Ensure burger+label stay aligned */
header{ display:flex; align-items:center; gap:8px; }


/* Responsive nav overlay */
@media (max-width: 840px){
  nav{
    position: fixed;
    top: 64px;
    left: 12px;
    right: 12px;
    max-height: calc(100vh - 88px);
    overflow:auto;
    z-index: 1000;
  }
}


.menu-wrapper .menu-label{margin-left:2px !important;}

</style>
<link rel="manifest" href="manifest.json"/>
<meta content="#ff7aa2" name="theme-color"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="default" name="apple-mobile-web-app-status-bar-style"/>
<link href="icon-180.png" rel="apple-touch-icon"/>
<link href="icon-192.png" rel="icon" sizes="192x192" type="image/png"/>
<link href="icon-512.png" rel="icon" sizes="512x512" type="image/png"/>
<style>input,select,textarea{font-size:16px!important}html,body{min-height:100vh;height:-webkit-fill-available}</style>
<!-- ===== MODULE: PAPELERÍA | COMPACT INPUTS CSS (matches Sublimación) ===== -->
<style id="papeleria-compact-css">
  /* Scope strictly to Papelería */
  #view-papeleria .row { gap: 8px; }
  #view-papeleria label { font-size: 13px; }

  /* Inputs / selects size equal to Sublimación */
  #view-papeleria input[type="text"],
  #view-papeleria input[type="number"],
  #view-papeleria select {
    height: 36px;
    padding: 6px 10px;
    font-size: 14px;
    line-height: 1.2;
  }
  /* Readonly unit fields (Costo Ud., costo x Mes) */
  #view-papeleria input.ud[readonly] {
    height: 36px;
    padding: 6px 10px;
    font-size: 14px;
  }
  /* Layout columns for Cant / Precio / Costo Ud. */
  #view-papeleria .row > div {
    min-width: 120px !important;
    flex: 1 1 0;
  }
  /* Compact selects for Sustrato/Adhesivo */
  #view-papeleria select {
    min-width: 240px;
  }
  /* Optional tighter vertical rhythm */
  #view-papeleria h4 { margin: 0 0 8px; }
  #view-papeleria .sep { margin: 10px 0; }
</style>
<style>
/* GI visual match — Papelería */
#view-papeleria input[type="number"]{height:38px}
#view-papeleria label{margin-bottom:4px;display:block}
</style>
<style>
/* --- Papelería: Alineación exacta de Ganancia/Impuestos (match Sublimación/Vinil) --- */
#view-papeleria #pap_gi_row .gi-col input[type="number"]{height:42px; padding:8px 12px; width:100%; box-sizing:border-box;}
#view-papeleria #pap_gi_row label{font-weight:500;}
/* Evita saltos verticales por checkbox */
#view-papeleria #pap_gi_row input[type="checkbox"]{transform: translateY(1px);}
</style>
<style>
/* --- Esferas: Mano de obra layout --- */
#view-esferas-navidenas #esf_mo_cfg{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;margin-top:6px}
#view-esferas-navidenas #esf_mo_cfg>div{flex:1 1 220px;min-width:200px}
#view-esferas-navidenas #esf_mo_cfg>div.mo-unidades{flex:1 1 100%;max-width:360px}
#view-esferas-navidenas #esf_mo_cfg input[type="text"]{width:100%}
/* --- end Esferas: Mano de obra layout --- */
</style>
<style>

/* === FIX — Alinear "Costo de Vinil" a la izquierda y centrar "MÓDULOS" === */
nav button {
  text-align: left !important;
  justify-content: flex-start !important;
  padding-left: 18px !important;
}
nav button.active {
  text-align: left !important;
  justify-content: flex-start !important;
}
.drawer .group {
  width: 100%;
  text-align: center !important;
  display: block;
  margin-top: 12px;
  margin-bottom: 8px;
}
/* Asegurar alineación izquierda en los items del menú */
.drawer .menu .item{
  text-align:left!important;
  justify-content:flex-start!important;
}
.drawer .menu .item .txt{
  text-align:left!important;
}

</style>
<style>
/* --- Burger optical centering tweak --- */
.burger { display:grid; place-items:center; padding:0; }
.burger svg { display:block; }
</style>
<style>
/* Burger minimal icon cleanup */
.burger { display:grid; place-items:center; }
.burger svg { display:block; }
</style>
<style>
/* Burger icon centering */
.burger { display:grid; place-items:center; }
.burger svg { display:block; }
</style>
<style>
/* Burger icon centering */
.burger { display:grid; place-items:center; }
.burger svg { display:block; }
</style>

<style>
/* Header fijo para que el botón de menú siempre sea accesible */
.app > header{
  position: sticky;
  top: 0;
  z-index: 950;
}
</style>
<style>
/* Header compacto en scroll (solo móviles) */
.app-header.header-compact .header-right{
  display:none !important;
}
</style>

<style>
/* === Dark Toggle (Sol/Luna) === */
.dark-toggle-pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  background:#ffffff33;
  color:#fff;
  cursor:pointer;
  user-select:none;
}
.dark-toggle-pill input{
  position:absolute;
  opacity:0;
  pointer-events:none;
}
.dark-toggle-pill .dt-ico{
  width:16px;height:16px;display:block;
}
.dark-toggle-pill .dt-sun{ display:none; }
.dark-toggle-pill input:checked ~ .dt-moon{ display:none; }
.dark-toggle-pill input:checked ~ .dt-sun{ display:block; }
body.dark .dark-toggle-pill{ background:#1b2030; color:#e5e7eb; }
</style>

<style id="reset-general-modern">
/* === Reset General — modern pill button (solo visual) === */
#btn_reset_general{
  background: #e56b73 !important;          /* rose apagado claro */
  color: #fff !important;
  border: 1px solid rgba(0,0,0,.06) !important;
  border-radius: 999px !important;         /* pill */
  padding: 10px 18px !important;
  font-weight: 700 !important;
  letter-spacing: .2px;
  box-shadow: 0 6px 16px rgba(229,107,115,.35) !important;
  transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
#btn_reset_general::before{
  content: "↺";
  font-size: 15px;
  line-height: 1;
  transform: translateY(-0.5px);
  opacity: .95;
}
#btn_reset_general:hover{
  transform: translateY(-1.5px);
  box-shadow: 0 10px 22px rgba(229,107,115,.45) !important;
  filter: brightness(1.03);
}
#btn_reset_general:active{
  transform: translateY(0);
  box-shadow: 0 4px 12px rgba(229,107,115,.35) !important;
  filter: brightness(.98);
}

/* Modo oscuro */
body.dark #btn_reset_general{
  background: #b84b55 !important;          /* rose profundo oscuro */
  border-color: rgba(255,255,255,.08) !important;
  box-shadow: 0 6px 18px rgba(184,75,85,.50) !important;
}
body.dark #btn_reset_general:hover{
  box-shadow: 0 10px 26px rgba(184,75,85,.60) !important;
}
</style>


<style id="pers-dep-nowrap-css">
/* Producto personalizable — Depreciación: mantener todo en una sola línea (desktop) */
#view-personalizado .pers-dep-row{ flex-wrap:nowrap !important; }
@media (max-width: 840px){
  #view-personalizado .pers-dep-row{ flex-wrap:wrap !important; overflow-x:visible !important; }
}
</style>


<style id="pers-ui-compact-dep">
/* Producto personalizable — Depreciación: inputs compactos (Meses / Cap./mes) */
#view-personalizado .pers-dep-col-meses input.pers-dep-meses{
  width: 100% !important;
  max-width: 72px !important;
}
#view-personalizado .pers-dep-col-cap input.pers-dep-capacidad{
  width: 100% !important;
  max-width: 96px !important;
}
</style>


<style id="boot-hide-app">
  /* Evitar parpadeo al restaurar última vista: ocultar app hasta aplicar vista inicial */
  html.booting .app{ visibility:hidden; }
</style>
<script>
  (function(){
    try{
      document.documentElement.classList.add('booting');
      var seen = localStorage.getItem('Suite.has_opened');
      var last = (localStorage.getItem('last_view') || '').trim();
      var target = (!seen) ? 'instrucciones' : (last || 'instrucciones');
      document.documentElement.setAttribute('data-start-view', target);
      // Safety: si algo falla, mostrar la app igualmente
      window.setTimeout(function(){ document.documentElement.classList.remove('booting'); }, 1500);
    }catch(e){
      document.documentElement.classList.add('booting');
      document.documentElement.setAttribute('data-start-view', 'instrucciones');
      window.setTimeout(function(){ document.documentElement.classList.remove('booting'); }, 1500);
    }
  })();
</script>

<style id="dark-scroll-bg-fix">
/* === V38_2 HOTFIX: Dark scroll background consistency (evita doble color al hacer scroll) === */
html[data-theme="dark"]{ background: var(--bg) !important; }
body.dark{ background: var(--bg) !important; }

</style>
</head>
<body data-app-version="V38.2">
<div class="app">
<header class="app-header"><div class="menu-wrapper" style="display:flex;align-items:center;gap:6px;"><button aria-expanded="false" aria-label="Abrir menú" class="burger" id="btnMenu" tabindex="0"><svg fill="none" height="24" stroke="currentColor" stroke-linecap="round" style="display:block" viewbox="0 0 24 24" width="24"><line stroke-width="2.2" x1="3" x2="21" y1="7" y2="7"></line><line stroke-width="2.2" x1="3" x2="21" y1="12" y2="12"></line><line stroke-width="2.2" x1="3" x2="21" y1="17" y2="17"></line></svg></button><span class="menu-label">Menú</span></div><h1>Suite de Calculadoras</h1>
<div class="header-right" style="display:flex;gap:8px;align-items:center">
<label class="dark-toggle-pill" title="Modo oscuro" aria-label="Modo oscuro">
  <input id="dark_toggle" type="checkbox"/>
  <svg class="dt-ico dt-moon" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 12.8A9 9 0 1 1 11.2 3a7 7 0 1 0 9.8 9.8z" fill="currentColor"/></svg>
  <svg class="dt-ico dt-sun" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="4.5" fill="currentColor"/><g stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="2" x2="12" y2="5"/><line x1="12" y1="19" x2="12" y2="22"/><line x1="2" y1="12" x2="5" y2="12"/><line x1="19" y1="12" x2="22" y2="12"/><line x1="4.6" y1="4.6" x2="6.8" y2="6.8"/><line x1="17.2" y1="17.2" x2="19.4" y2="19.4"/><line x1="17.2" y1="6.8" x2="19.4" y2="4.6"/><line x1="4.6" y1="19.4" x2="6.8" y2="17.2"/></g></svg>
  <span class="dt-text">Oscuro</span>
</label>
<button class="btn reset" id="btn_reset_general">Reset general</button></div>
</header>
<section class="view" id="view-vinil">
<div class="grid">
<div class="card md-12">
<h3 style="margin:0 0 2px">Calculadora de Costo de Vinil</h3>
<div class="muted">Precio basado en vinil de ancho estándar (editable) × 100 cm de largo</div>
<div style="margin-top:10px;max-width:420px">
<label>Ancho estándar del vinil (cm)</label>
<input id="ancho_estandar" min="1" type="number" value="51"/>
</div>
</div>
<div class="card md-12">
<div class="row" style="justify-content:space-between;align-items:center">
<div class="row" style="gap:8px;align-items:center">
<button class="btn ok" id="btn_add_color">Agregar color</button>
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap"><label style="min-width:120px">Merma (%)</label><input id="merma_pct" max="30" min="0" step="1" style="max-width:120px" type="number" value="0"/><input id="merma_range" max="30" min="0" step="1" style="flex:1;min-width:160px" type="range" value="0"/><label style="min-width:160px;margin-left:10px">Borde por lado (cm)</label><input id="borde_lado" min="0" step="0.1" style="max-width:120px" type="number" value="1"/><div class="pill">Ancho efectivo: <span id="ancho_efectivo">—</span></div></div>
</div>
<button class="btn reset" id="btn_reset_vinil">Reset</button>
</div>
<div class="sep"></div>
<div class="grid" id="bloques"></div>
<div class="sep"></div>
<div class="card md-12" id="vinil_costos_directos">
<h3 style="margin:0 0 6px">Costos directos</h3>
<div class="row" style="align-items:center;gap:10px;margin-bottom:8px">
<label style="display:inline-flex;align-items:center;gap:8px;margin:0">
<input id="cd_enabled" type="checkbox"/> Activar
    </label>
<select id="cd_item" style="max-width:220px">
<option value="algodon" data-ud="3.50">Camiseta de algodón</option>
<option value="poliester" data-ud="2.50">Camiseta de poliéster</option>
<option value="bolsa" data-ud="1.80">Bolsa ecológica (tela)</option>
<option value="delantal" data-ud="3.00">Delantal</option>
<option value="gorra" data-ud="2.20">Gorra</option>

<option value="taza_blanca" data-ud="1.20">Taza blanca</option>
<option value="taza_magica" data-ud="2.80">Taza mágica</option>
<option value="termo_metalico" data-ud="6.50">Termo metálico</option>
<option value="botella_plastica" data-ud="2.50">Botella plástica</option>
<option value="vaso_acrilico" data-ud="1.80">Vaso acrílico</option>

<option value="caja_pequena" data-ud="0.60">Caja de cartón pequeña</option>
<option value="caja_mediana" data-ud="1.00">Caja de cartón mediana</option>
<option value="carpeta" data-ud="0.90">Carpeta escolar</option>
<option value="libreta" data-ud="1.20">Libreta</option>
<option value="cuaderno" data-ud="1.50">Cuaderno</option>

<option value="llavero_acrilico" data-ud="0.70">Llavero acrílico</option>
<option value="portavasos" data-ud="0.90">Portavasos</option>
<option value="tabla_mdf_peq" data-ud="1.80">Tabla MDF pequeña</option>
<option value="acrilico_plano" data-ud="2.20">Acrílico plano</option>

<option value="otros" data-ud="0">Otros</option>
</select>
</div>
<div class="row" style="gap:14px;flex-wrap:wrap">
<div style="min-width:130px;flex:1">
<label>Cant.</label>
<input id="cd_cant" type="text" value="36"/>
</div>
<div style="min-width:160px;flex:1">
<label>Precio ($)</label>
<input id="cd_precio" type="text" value="90"/>
</div>
<div style="min-width:200px;flex:1">
<label>Costo Ud.</label>
<input id="cd_costo_ud" readonly="" type="text" value="$ 0,00"/>
</div>
<div style="min-width:160px;flex:1">
<label>Cantidad a utilizar</label>
<input id="cd_qty_use" min="0" step="1" type="number" value="1"/>
</div>
<div style="min-width:200px;flex:1">
<label>Costo utilizado</label>
<input class="ud" id="cd_costo_util" readonly="" type="text" value="$ 0,00"/>
</div>
</div>
<div class="sep"></div>
<div class="row" style="gap:8px;align-items:center">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input id="vin_d_papel_on" type="checkbox"/> Papel de sublimación
  </label>
</div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant.</label><input id="vin_d_papel_cant" min="0" step="1" type="number" value="100"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="vin_d_papel_precio" step="0.01" type="text" value="10,00"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="vin_d_papel_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:110px"><label>Cantidad a utilizar</label><input id="vin_d_papel_qty_use" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:130px"><label>Costo utilizado</label><input class="ud" id="vin_d_papel_util" readonly="" type="text" value="$ 0,00"/></div>
</div>
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input id="vin_d_cinta_on" type="checkbox"/> Cinta térmica
  </label>
</div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant.</label><input id="vin_d_cinta_cant" min="0" step="1" type="number" value="100"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="vin_d_cinta_precio" step="0.01" type="text" value="3,00"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="vin_d_cinta_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:110px"><label>Cantidad a utilizar</label><input id="vin_d_cinta_qty_use" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:130px"><label>Costo utilizado</label><input class="ud" id="vin_d_cinta_util" readonly="" type="text" value="$ 0,00"/></div>
</div>
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input id="vin_d_tinta_on" type="checkbox"/> Tinta de sublimación
  </label>
</div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant.</label><input id="vin_d_tinta_cant" min="0" step="1" type="number" value="300"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="vin_d_tinta_precio" step="0.01" type="text" value="40,00"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="vin_d_tinta_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:110px"><label>Cantidad a utilizar</label><input id="vin_d_tinta_qty_use" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:130px"><label>Costo utilizado</label><input class="ud" id="vin_d_tinta_util" readonly="" type="text" value="$ 0,00"/></div>
</div>
</div>


</div><div class="card md-12" id="vinil_depreciacion">
<h3 style="margin:0 0 6px">Depreciación de equipos <span class="muted">(base 2 años)</span></h3>
<div style="margin-top:6px">
<label style="display:inline-flex;align-items:center;gap:8px;margin:0 0 6px">
<input class="dep_enabled" data-row="impresora" type="checkbox"/> Impresora
    </label>
<div class="row" style="gap:14px;flex-wrap:wrap">
<div style="min-width:160px;flex:1">
<label>Precio ($)</label>
<input class="dep_precio" data-row="impresora" type="text" value="240"/>
</div>
<div style="min-width:160px;flex:1">
<label>costo x Mes</label>
<input class="dep_mes" data-row="impresora" readonly="" type="text" value="$ 0,00"/>
</div>
<div style="min-width:160px;flex:1">
<label>Costo Ud.</label>
<input class="dep_ud" data-row="impresora" readonly="" type="text" value="$ 0,00"/>
</div>
<div style="min-width:140px;flex:1">
<label>Cant. de usos</label>
<input class="dep_uses" data-row="impresora" min="0" step="1" type="number" value="1"/>
</div>
<div style="min-width:160px;flex:1">
<label>Costo utilizado</label>
<input class="ud dep_util" data-row="impresora" readonly="" type="text" value="$ 0,00"/>
</div>
</div>
</div>
<div style="margin-top:12px">
<label style="display:inline-flex;align-items:center;gap:8px;margin:0 0 6px">
<input class="dep_enabled" data-row="plancha" type="checkbox"/> Plancha térmica
    </label>
<div class="row" style="gap:14px;flex-wrap:wrap">
<div style="min-width:160px;flex:1">
<label>Precio ($)</label>
<input class="dep_precio" data-row="plancha" type="text" value="400"/>
</div>
<div style="min-width:160px;flex:1">
<label>costo x Mes</label>
<input class="dep_mes" data-row="plancha" readonly="" type="text" value="$ 0,00"/>
</div>
<div style="min-width:160px;flex:1">
<label>Costo Ud.</label>
<input class="dep_ud" data-row="plancha" readonly="" type="text" value="$ 0,00"/>
</div>
<div style="min-width:140px;flex:1">
<label>Cant. de usos</label>
<input class="dep_uses" data-row="plancha" min="0" step="1" type="number" value="1"/>
</div>
<div style="min-width:160px;flex:1">
<label>Costo utilizado</label>
<input class="ud dep_util" data-row="plancha" readonly="" type="text" value="$ 0,00"/>
</div>
</div>
</div>
<div style="margin-top:12px">
<label style="display:inline-flex;align-items:center;gap:8px;margin:0 0 6px">
<input class="dep_enabled" data-row="pc" type="checkbox"/> Computadora
    </label>
<div class="row" style="gap:14px;flex-wrap:wrap">
<div style="min-width:160px;flex:1">
<label>Precio ($)</label>
<input class="dep_precio" data-row="pc" type="text" value="350"/>
</div>
<div style="min-width:160px;flex:1">
<label>costo x Mes</label>
<input class="dep_mes" data-row="pc" readonly="" type="text" value="$ 0,00"/>
</div>
<div style="min-width:160px;flex:1">
<label>Costo Ud.</label>
<input class="dep_ud" data-row="pc" readonly="" type="text" value="$ 0,00"/>
</div>
<div style="min-width:140px;flex:1">
<label>Cant. de usos</label>
<input class="dep_uses" data-row="pc" min="0" step="1" type="number" value="1"/>
</div>
<div style="min-width:160px;flex:1">
<label>Costo utilizado</label>
<input class="ud dep_util" data-row="pc" readonly="" type="text" value="$ 0,00"/>
</div>
</div>
</div>
<div style="margin-top:12px">
<label style="display:inline-flex;align-items:center;gap:8px;margin:0 0 6px">
<input class="dep_enabled" data-row="plotter" type="checkbox"/> Plotter de corte
    </label>
<div class="row" style="gap:14px;flex-wrap:wrap">
<div style="min-width:160px;flex:1">
<label>Precio ($)</label>
<input class="dep_precio" data-row="plotter" type="text" value="400"/>
</div>
<div style="min-width:160px;flex:1">
<label>costo x Mes</label>
<input class="dep_mes" data-row="plotter" readonly="" type="text" value="$ 0,00"/>
</div>
<div style="min-width:160px;flex:1">
<label>Costo Ud.</label>
<input class="dep_ud" data-row="plotter" readonly="" type="text" value="$ 0,00"/>
</div>
<div style="min-width:140px;flex:1">
<label>Cant. de usos</label>
<input class="dep_uses" data-row="plotter" min="0" step="1" type="number" value="1"/>
</div>
<div style="min-width:160px;flex:1">
<label>Costo utilizado</label>
<input class="ud dep_util" data-row="plotter" readonly="" type="text" value="$ 0,00"/>
</div>
</div>
</div>
<div style="margin-top:12px">
<label style="display:inline-flex;align-items:center;gap:8px;margin:0 0 6px">
<input class="dep_enabled" data-row="cuchilla" type="checkbox"/> Cuchilla de corte
    </label>
<div class="row" style="gap:14px;flex-wrap:wrap">
<div style="min-width:160px;flex:1">
<label>Precio ($)</label>
<input class="dep_precio" data-row="cuchilla" type="text" value="30"/>
</div>
<div style="min-width:160px;flex:1">
<label>Vida útil (cortes)</label>
<input class="dep_vida" data-row="cuchilla" type="text" value="500"/>
</div>
<div style="min-width:160px;flex:1">
<label>Costo Ud.</label>
<input class="dep_ud" data-row="cuchilla" readonly="" type="text" value="$ 0,00"/>
</div>
<div style="min-width:140px;flex:1">
<label>Cant. de usos</label>
<input class="dep_uses" data-row="cuchilla" min="0" step="1" type="number" value="1"/>
</div>
<div style="min-width:160px;flex:1">
<label>Costo utilizado</label>
<input class="ud dep_util" data-row="cuchilla" readonly="" type="text" value="$ 0,00"/>
</div>
</div>
</div>
<div style="margin-top:12px">
<label style="display:inline-flex;align-items:center;gap:8px;margin:0 0 6px">
<input class="dep_enabled" data-row="tapete" type="checkbox"/> Tapete de corte (vida en usos)
  </label>
<div class="row" style="gap:14px;flex-wrap:wrap">
<div style="min-width:160px;flex:1"><label>Precio ($)</label>
<input class="dep_precio" data-row="tapete" type="text" value="12"/></div>
<div style="min-width:160px;flex:1"><label>Vida útil (usos)</label>
<input class="dep_vida" data-row="tapete" type="text" value="500"/></div>
<div style="min-width:160px;flex:1"><label>Costo Ud.</label>
<input class="dep_ud" data-row="tapete" readonly="" type="text" value="$ 0,00"/></div>
<div style="min-width:140px;flex:1">
<label>Cant. de usos</label>
<input class="dep_uses" data-row="tapete" min="0" step="1" type="number" value="1"/>
</div>
<div style="min-width:160px;flex:1">
<label>Costo utilizado</label>
<input class="ud dep_util" data-row="tapete" readonly="" type="text" value="$ 0,00"/>
</div>
</div>
</div>
</div><div class="card md-12" id="vinil_summary" style="padding:12px 16px">
<div class="row" style="justify-content:space-between;align-items-center;margin-bottom:6px">
<h3 style="margin:0">Resumen de Vinil</h3>
</div>
<div class="row" style="justify-content:space-between;flex-wrap:wrap;gap:8px">
<div class="pill">Directos: <span class="result" id="vinil_pro_directos">$0.00</span></div>
<div class="pill">Depreciación: <span class="result" id="vinil_pro_dep">$0.00</span></div>
<div class="pill">Adicionales (aj.): <span class="result" id="vinil_pro_adic">$0.00</span></div>
<div class="pill">Merma: <span class="result" id="vinil_pro_merma">0%</span></div>
</div>
<div class="sep"></div>
<div class="tot">Total Vinil: <span class="result" id="vinil_pro_total">$0.00</span></div>
</div>


<div class="card md-12 indA-card" id="vin_ind_card"><h4>Costos indirectos</h4><div class="row" style="gap:10px;align-items:center;flex-wrap:wrap"><label style="display:flex;align-items:center;gap:8px;margin:0"><input id="vin_ind_on" type="checkbox"/> Activar</label><div class="pill indA-pill">Costo Ud. (indirectos): <span class="result" id="vin_ind_ud">$ 0,00</span></div><div style="margin-left:auto"><button class="btn" id="vin_ind_cfg_btn">Configurar</button></div></div><div class="sep"></div><div id="vin_ind_cfg" style="display:none"><div class="row" style="gap:14px;flex-wrap:wrap"><div style="min-width:160px;flex:1"><label>Alquiler (mensual)</label><input id="vin_ind_alquiler" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Internet (mensual)</label><input id="vin_ind_internet" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Suscripciones (mensual)</label><input id="vin_ind_suscripciones" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Transporte (mensual)</label><input id="vin_ind_transporte" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Electricidad (mensual)</label><input id="vin_ind_electricidad" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Publicidad (mensual)</label><input id="vin_ind_publicidad" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Otros (mensual)</label><input id="vin_ind_otros" type="text" value="0,00"/></div><div style="min-width:120px"><label>Unidades/mes</label><input class="indA-small" id="vin_ind_units" min="1" step="1" type="number" value="100"/></div></div></div></div><div class="card md-12" id="vinil_gi_card">
<h4 style="margin:0 0 10px">Ganancia e Impuestos</h4>
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
<div class="pill">Total sin G/I: <span class="result" id="vin_subtotal_no_gi">$0.00</span></div>
</div>
<div class="sep"></div>
<div class="row" style="justify-content:space-between;align-items:center;gap:10px;margin-top:6px">
<label style="display:flex;align-items:center;gap:8px;margin:0">
<input id="vin_mo_on" type="checkbox"/> Mano de obra
    </label>
<button class="copy-btn" id="vin_mo_cfg_btn" type="button">Configurar</button>
</div>
<div class="row" id="vin_mo_cfg" style="display:none;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-top:6px">
<div style="min-width:160px"><label>Sueldo mensual ($)</label><input id="vin_mo_sueldo" type="text" value="400,00"/></div>
<div style="min-width:160px"><label>Horas al mes</label><input id="vin_mo_horas_mes" type="text" value="176"/></div>
<div style="min-width:140px"><label>Setup (min)</label><input id="vin_mo_setup" type="text" value="5,00"/></div>
<div style="min-width:180px"><label>Ejecución (min/ud)</label><input id="vin_mo_run" type="text" value="2,00"/></div>
<div style="min-width:140px"><label>Unidades</label><input id="vin_mo_units" type="text" value="1"/></div>
</div>
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px">
<div class="pill" id="vin_mo_pill" style="display:none">+ Mano de obra: <span class="result" id="vin_mo_val">$ 0,00</span></div>
</div>
<div class="sep"></div>
<div class="row">
<div style="flex:1;min-width:160px">
<label><input checked="" id="vin_chk_ganancia" type="checkbox"/> Ganancia (%)</label>
<input id="vin_ganancia" min="0" step="1" type="number" value="40"/>
</div>
<div style="flex:1;min-width:160px">
<label><input checked="" id="vin_chk_impuestos" type="checkbox"/> Impuestos (%)</label>
<input id="vin_impuestos" min="0" step="1" type="number" value="16"/>
</div>
</div>
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
<div class="pill">Subtotal: <span class="result" id="vin_subtotal">$0.00</span></div>
<div class="pill">+ Ganancia: <span class="result" id="vin_ganancia_val">$0.00</span></div>
<div class="pill">+ Impuestos: <span class="result" id="vin_impuestos_val">$0.00</span></div>
</div>
<div class="sep"></div>
<div class="tot">Precio de Venta: <span class="result" id="vin_total">$0.00</span></div>
<div class="row" style="gap:8px;justify-content:center">
<button class="copy-btn" id="vinil_pro_copy">Copiar</button>
<button class="copy-btn" id="vinil_pro_print">Exportar PDF / Imprimir</button>
</div>
</div>
<!-- Cantidad de productos (Vinil) – bloque no intrusivo -->
<div class="card md-12" id="vinil_qty_card">
  <div class="row" style="align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
    <div class="row" style="align-items:center;gap:8px;flex-wrap:wrap">
      <label class="chk-label" style="display:flex;align-items:center;gap:6px;margin:0">
        <input type="checkbox" id="vinil_qty_on"/>
        <span>Cantidad de productos</span>
      </label>
      <input type="number" id="vinil_qty" min="1" step="1" value="1" style="max-width:100px"/>
      <span class="muted">Multiplica los totales por Q (solo vista, no cambia los cálculos base).</span>
    </div>
  </div>
  <div class="sep"></div>
  <div class="row" style="flex-wrap:wrap;gap:8px">
    <div class="pill"><span>Base sin G/I ×Q</span><span class="result mono" id="vinil_qty_base">$ 0,00</span></div>
    <div class="pill"><span>Subtotal ×Q</span><span class="result mono" id="vinil_qty_subtotal">$ 0,00</span></div>
    <div class="pill"><span>Ganancia ×Q</span><span class="result mono" id="vinil_qty_g">$ 0,00</span></div>
    <div class="pill"><span>Impuestos ×Q</span><span class="result mono" id="vinil_qty_i">$ 0,00</span></div>
    <div class="pill"><span>Total ×Q</span><span class="result mono" id="vinil_qty_total">$ 0,00</span></div>
  </div>
</div>
<div id="vinil_legacy_hidden" style="display:none">
<strong class="mono" id="vinil_directos">$ 0,00</strong>
<strong class="mono" id="vinil_dep">$ 0,00</strong>
<strong class="mono" id="vinil_adicionales">$ 0,00</strong>
<div class="tot" id="totalFinal">Total Vinil: $ 0,00</div>

</div>
</div>
</section>
<!-- ===== MODULE: PAPELERÍA | END ===== -->
<section class="view" id="view-basica">
<div class="grid">
<div class="card md-4">
<h3>Calculadora Básica</h3>
<input id="calc-display" placeholder="0" readonly="" type="text"/>
<div class="sep"></div>
<div class="grid" style="grid-template-columns:repeat(4,1fr);gap:8px">
<button class="btn neutral" data-k="7">7</button>
<button class="btn neutral" data-k="8">8</button>
<button class="btn neutral" data-k="9">9</button>
<button class="btn ok" data-k="/">/</button>
<button class="btn neutral" data-k="4">4</button>
<button class="btn neutral" data-k="5">5</button>
<button class="btn neutral" data-k="6">6</button>
<button class="btn ok" data-k="*">×</button>
<button class="btn neutral" data-k="1">1</button>
<button class="btn neutral" data-k="2">2</button>
<button class="btn neutral" data-k="3">3</button>
<button class="btn ok" data-k="-">−</button>
<button class="btn neutral" data-k="0">0</button>
<button class="btn neutral" data-k=".">.</button>
<button class="btn reset" id="calc-clear">C</button>
<button class="btn ok" data-k="+">+</button>
<button class="btn ok" id="calc-eq">=</button>
</div>
<div class="muted" style="margin-top:8px">Usa el teclado: Enter, Backspace.</div>
</div>
<div class="card md-8">
<h3>Notas</h3>
<p class="muted">Calculadora integrada para operaciones rápidas mientras trabajas con las otras vistas.</p>
</div>
</div>
</section>
<section class="view" id="view-conversor">
<div class="grid">
<div class="card md-12">
<h3 style="margin:0 0 6px">Conversor de Unidades</h3>
<p class="muted">Herramientas rápidas para convertir longitudes, áreas, pesos, temperaturas y píxeles↔tamaño físico (DPI). Todo en un mismo lugar.</p>
<div class="sep"></div>
</div>
<div class="card md-6">
<h4 style="margin:0 0 8px">Longitud</h4>
<div class="row" style="gap:8px;align-items:flex-end;flex-wrap:wrap">
<div style="flex:1;min-width:140px">
<label>Valor</label>
<input id="len_val" step="0.0001" type="number" value="1"/>
</div>
<div style="flex:1;min-width:160px">
<label>De</label>
<select id="len_from">
<option value="mm">mm</option>
<option selected="" value="cm">cm</option>
<option value="m">m</option>
<option value="in">in</option>
<option value="ft">ft</option>
<option value="yd">yd</option>
</select>
</div>
<div style="flex:1;min-width:160px">
<label>A</label>
<select id="len_to">
<option value="mm">mm</option>
<option value="cm">cm</option>
<option value="m">m</option>
<option selected="" value="in">in</option>
<option value="ft">ft</option>
<option value="yd">yd</option>
</select>
</div>
<div style="flex:1;min-width:180px">
<label>Resultado</label>
<input class="ud" id="len_out" readonly="" type="text"/>
</div>
</div>
</div>
<div class="card md-6">
<h4 style="margin:0 0 8px">Área</h4>
<div class="row" style="gap:8px;align-items:flex-end;flex-wrap:wrap">
<div style="flex:1;min-width:140px">
<label>Valor</label>
<input id="area_val" step="0.0001" type="number" value="1"/>
</div>
<div style="flex:1;min-width:160px">
<label>De</label>
<select id="area_from">
<option selected="" value="cm2">cm²</option>
<option value="m2">m²</option>
<option value="in2">in²</option>
<option value="ft2">ft²</option>
</select>
</div>
<div style="flex:1;min-width:160px">
<label>A</label>
<select id="area_to">
<option value="cm2">cm²</option>
<option value="m2">m²</option>
<option value="in2">in²</option>
<option selected="" value="ft2">ft²</option>
</select>
</div>
<div style="flex:1;min-width:180px">
<label>Resultado</label>
<input class="ud" id="area_out" readonly="" type="text"/>
</div>
</div>
</div>
<div class="card md-6">
<h4 style="margin:0 0 8px">Peso</h4>
<div class="row" style="gap:8px;align-items:flex-end;flex-wrap:wrap">
<div style="flex:1;min-width:140px">
<label>Valor</label>
<input id="mass_val" step="0.0001" type="number" value="1"/>
</div>
<div style="flex:1;min-width:160px">
<label>De</label>
<select id="mass_from">
<option selected="" value="g">g</option>
<option value="kg">kg</option>
<option value="lb">lb</option>
<option value="oz">oz</option>
</select>
</div>
<div style="flex:1;min-width:160px">
<label>A</label>
<select id="mass_to">
<option value="g">g</option>
<option value="kg">kg</option>
<option selected="" value="lb">lb</option>
<option value="oz">oz</option>
</select>
</div>
<div style="flex:1;min-width:180px">
<label>Resultado</label>
<input class="ud" id="mass_out" readonly="" type="text"/>
</div>
</div>
</div>
<div class="card md-6">
<h4 style="margin:0 0 8px">Temperatura</h4>
<div class="row" style="gap:8px;align-items:flex-end;flex-wrap:wrap">
<div style="flex:1;min-width:140px">
<label>Valor</label>
<input id="tmp_val" step="0.01" type="number" value="0"/>
</div>
<div style="flex:1;min-width:160px">
<label>De</label>
<select id="tmp_from">
<option selected="" value="C">°C</option>
<option value="F">°F</option>
<option value="K">K</option>
</select>
</div>
<div style="flex:1;min-width:160px">
<label>A</label>
<select id="tmp_to">
<option value="C">°C</option>
<option selected="" value="F">°F</option>
<option value="K">K</option>
</select>
</div>
<div style="flex:1;min-width:180px">
<label>Resultado</label>
<input class="ud" id="tmp_out" readonly="" type="text"/>
</div>
</div>
</div>
<div class="card md-12">
<h4 style="margin:0 0 8px">Píxeles ↔ Tamaño físico (DPI)</h4>
<div class="row" style="gap:8px;align-items:flex-end;flex-wrap:wrap">
<div style="flex:1;min-width:140px">
<label>Anchura (cm)</label>
<input id="dpi_w_cm" step="0.01" type="number" value="10"/>
</div>
<div style="flex:1;min-width:140px">
<label>Altura (cm)</label>
<input id="dpi_h_cm" step="0.01" type="number" value="10"/>
</div>
<div style="flex:1;min-width:140px">
<label>DPI</label>
<input id="dpi_dpi" step="1" type="number" value="300"/>
</div>
<div style="flex:1;min-width:180px">
<label>Salida (px)</label>
<input class="ud" id="dpi_px_out" readonly="" type="text"/>
</div>
</div>
<div class="row" style="gap:8px;align-items:flex-end;flex-wrap:wrap;margin-top:8px">
<div style="flex:1;min-width:140px">
<label>Anchura (px)</label>
<input id="px_w" step="1" type="number" value="1181"/>
</div>
<div style="flex:1;min-width:140px">
<label>Altura (px)</label>
<input id="px_h" step="1" type="number" value="1181"/>
</div>
<div style="flex:1;min-width:140px">
<label>DPI</label>
<input id="px_dpi" step="1" type="number" value="300"/>
</div>
<div style="flex:1;min-width:220px">
<label>Salida (cm)</label>
<input class="ud" id="px_cm_out" readonly="" type="text"/>
</div>
</div>
<p class="muted" style="margin-top:6px">Fórmulas: px = cm × (DPI / 2.54); cm = px × (2.54 / DPI).</p>
</div></div>
</section>
<section class="view" id="view-sublimacion">
<div class="grid">
<div class="card md-12">
<h3 style="margin:0 0 6px">Cálculo de costos — Sublimación</h3>
<div class="sep"></div>
</div>
<!-- Costos directos -->
<div class="card md-6" style="background:#fff">
<h4 style="margin:0 0 10px">Costos directos</h4>
<!-- Producto principal -->
<div class="row" style="gap:8px;align-items:center;margin-top:6px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input checked="" id="sub_d_prod_on" type="checkbox"/>
<span>Producto</span>
</label>
<select id="sub_d_prod_select" style="min-width:240px">
<option value="taza11">Taza 11oz (pack 36)</option>
<option value="tazaMagica11">Taza mágica 11oz (pack 12)</option>
<option value="jarra">Jarra / Beer stein (pack 24)</option>
<option value="termo20">Termo 20oz (pack 24)</option>
<option value="camisetaPoly">Camiseta poliéster 100% (unidad)</option>
<option value="llavero50">Llavero (pack 50)</option>
<option value="mousepad50">Mousepad (pack 50)</option>
<option value="otros">Otros</option>
</select>
</div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant.</label><input id="sub_d_prod_cant" min="0" step="1" type="number" value="36"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="sub_d_prod_precio" min="0" step="0.01" type="text" value="60.00"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="sub_d_prod_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:140px"><label>Cantidad a utilizar</label><input id="sub_d_prod_use" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:140px"><label>Costo utilizado</label><input class="ud" id="sub_d_prod_used" readonly="" type="text"/></div>
</div>
<div class="sep"></div>
<!-- Papel -->
<div class="row" style="gap:8px;align-items:center">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input checked="" id="sub_d_papel_on" type="checkbox"/> Papel
            </label>
</div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant.</label><input id="sub_d_papel_cant" min="0" step="1" type="number" value="100"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="sub_d_papel_precio" min="0" step="0.01" type="text" value="10.00"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="sub_d_papel_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:140px"><label>Cantidad a utilizar</label><input id="sub_d_papel_use" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:140px"><label>Costo utilizado</label><input class="ud" id="sub_d_papel_used" readonly="" type="text"/></div>
</div>
<!-- Tinta -->
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input checked="" id="sub_d_tinta_on" type="checkbox"/> Tinta de sublimación
            </label>
</div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant.</label><input id="sub_d_tinta_cant" min="0" step="1" type="number" value="300"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="sub_d_tinta_precio" min="0" step="0.01" type="text" value="40.00"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="sub_d_tinta_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:140px"><label>Cantidad a utilizar</label><input id="sub_d_tinta_use" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:140px"><label>Costo utilizado</label><input class="ud" id="sub_d_tinta_used" readonly="" type="text"/></div>
</div>
<!-- Cinta térmica -->
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input checked="" id="sub_d_cinta_on" type="checkbox"/> Cinta térmica
            </label>
</div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant.</label><input id="sub_d_cinta_cant" min="0" step="1" type="number" value="100"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="sub_d_cinta_precio" min="0" step="0.01" type="text" value="3.00"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="sub_d_cinta_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:140px"><label>Cantidad a utilizar</label><input id="sub_d_cinta_use" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:140px"><label>Costo utilizado</label><input class="ud" id="sub_d_cinta_used" readonly="" type="text"/></div>
</div>
<!-- Empaque -->
<!-- Funda Retráctil -->
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input checked="" id="d_funda_on" type="checkbox"/> Funda Retráctil
  </label>
</div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant.</label><input id="d_funda_cant" min="0" step="1" type="number" value="50"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="d_funda_precio" min="0" step="0.01" type="text" value="15,00"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="d_funda_ud" readonly="" type="text"/></div>
</div>
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input checked="" id="sub_d_empaque_on" type="checkbox"/> Empaque
            </label>
</div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant.</label><input id="sub_d_empaque_cant" min="0" step="1" type="number" value="50"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="sub_d_empaque_precio" min="0" step="0.01" type="text" value="5.00"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="sub_d_empaque_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:140px"><label>Cantidad a utilizar</label><input id="sub_d_empaque_use" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:140px"><label>Costo utilizado</label><input class="ud" id="sub_d_empaque_used" readonly="" type="text"/></div>
</div>
</div>
<!-- Depreciación -->
<div class="card md-6" style="background:#fff">
<h4 style="margin:0 0 10px">Depreciación de equipos <span class="muted">(base 2 años)</span></h4>
<!-- Impresora -->
<div class="row" style="gap:8px;align-items:center">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input checked="" id="sub_e_impresora_on" type="checkbox"/> Impresora
            </label>
</div>
<div class="row">
<div style="flex:1;min-width:120px"><label>Precio ($)</label><input data-prod="100" id="sub_e_impresora_precio" min="0" step="0.01" type="text" value="240"/></div>
<div style="flex:1;min-width:120px"><label>costo x Mes</label><input class="ud" id="sub_e_impresora_mes" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Costo Ud.</label><input class="ud" id="sub_e_impresora_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Cant. de usos</label><input id="sub_e_impresora_uses" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:140px"><label>Costo utilizado</label><input class="ud" id="sub_e_impresora_used" readonly="" type="text"/></div>
</div>
<!-- Plancha -->
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input checked="" id="sub_e_plancha_on" type="checkbox"/> Plancha térmica
            </label>
</div>
<div class="row">
<div style="flex:1;min-width:120px"><label>Precio ($)</label><input data-prod="100" id="sub_e_plancha_precio" min="0" step="0.01" type="text" value="400"/></div>
<div style="flex:1;min-width:120px"><label>costo x Mes</label><input class="ud" id="sub_e_plancha_mes" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Costo Ud.</label><input class="ud" id="sub_e_plancha_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Cant. de usos</label><input id="sub_e_plancha_uses" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:140px"><label>Costo utilizado</label><input class="ud" id="sub_e_plancha_used" readonly="" type="text"/></div>
</div>
<!-- PC -->
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input checked="" id="sub_e_pc_on" type="checkbox"/> Computadora
            </label>
</div>
<div class="row">
<div style="flex:1;min-width:120px"><label>Precio ($)</label><input data-prod="100" id="sub_e_pc_precio" min="0" step="0.01" type="text" value="350"/></div>
<div style="flex:1;min-width:120px"><label>costo x Mes</label><input class="ud" id="sub_e_pc_mes" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Costo Ud.</label><input class="ud" id="sub_e_pc_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Cant. de usos</label><input id="sub_e_pc_uses" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:140px"><label>Costo utilizado</label><input class="ud" id="sub_e_pc_used" readonly="" type="text"/></div>
</div>
<!-- Prensa para tazas -->
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input checked="" id="sub_e_prensa_on" type="checkbox"/> Prensa para tazas
            </label>
</div>
<div class="row">
<div style="flex:1;min-width:120px"><label>Precio ($)</label><input data-prod="100" id="sub_e_prensa_precio" min="0" step="0.01" type="text" value="180"/></div>
<div style="flex:1;min-width:120px"><label>costo x Mes</label><input class="ud" id="sub_e_prensa_mes" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Costo Ud.</label><input class="ud" id="sub_e_prensa_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Cant. de usos</label><input id="sub_e_prensa_uses" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:140px"><label>Costo utilizado</label><input class="ud" id="sub_e_prensa_used" readonly="" type="text"/></div>
</div>
<!-- Resistencia -->
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input checked="" id="sub_e_res_on" type="checkbox"/> Resistencia para tazas o termos
            </label>
</div>
<div class="row">
<div style="flex:1;min-width:120px"><label>Precio ($)</label><input data-prod="100" id="sub_e_res_precio" min="0" step="0.01" type="text" value="50"/></div>
<div style="flex:1;min-width:120px"><label>costo x Mes</label><input class="ud" id="sub_e_res_mes" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Costo Ud.</label><input class="ud" id="sub_e_res_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Cant. de usos</label><input id="sub_e_res_uses" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:140px"><label>Costo utilizado</label><input class="ud" id="sub_e_res_used" readonly="" type="text"/></div>
</div>
<!-- Horno de Sublimación -->
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input id="e_horno_on" type="checkbox"/> Horno de Sublimación
  </label>
</div>
<div class="row">
<div style="flex:1;min-width:120px"><label>Precio ($)</label><input id="e_horno_precio" min="0" step="0.01" type="text" value="350,00"/></div>
<div style="flex:1;min-width:120px"><label>costo x Mes</label><input class="ud" id="e_horno_mes" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Costo Ud.</label><input class="ud" id="e_horno_ud" readonly="" type="text"/></div>
</div>
</div>
<!-- Costos indirectos -->
<div class="card md-12 indA-card" id="sub_v15_ind_card"><h4>Costos indirectos</h4><div class="row" style="gap:10px;align-items:center;flex-wrap:wrap"><label style="display:flex;align-items:center;gap:8px;margin:0"><input id="sub_v15_ind_on" type="checkbox"/> Activar</label><div class="pill indA-pill">Costo Ud. (indirectos): <span class="result" id="sub_v15_ind_ud">$ 0,00</span></div><div style="margin-left:auto"><button class="btn" id="sub_v15_ind_cfg_btn">Configurar</button></div></div><div class="sep"></div><div id="sub_v15_ind_cfg" style="display:none"><div class="row" style="gap:14px;flex-wrap:wrap"><div style="min-width:160px;flex:1"><label>Alquiler (mensual)</label><input id="sub_v15_ind_alquiler" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Internet (mensual)</label><input id="sub_v15_ind_internet" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Suscripciones (mensual)</label><input id="sub_v15_ind_suscripciones" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Transporte (mensual)</label><input id="sub_v15_ind_transporte" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Electricidad (mensual)</label><input id="sub_v15_ind_electricidad" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Publicidad (mensual)</label><input id="sub_v15_ind_publicidad" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Otros (mensual)</label><input id="sub_v15_ind_otros" type="text" value="0,00"/></div><div style="min-width:120px"><label>Unidades/mes</label><input class="indA-small" id="sub_v15_ind_units" min="1" step="1" type="number" value="100"/></div></div></div></div>

<!-- Totales / G&I / Mano de obra -->
<div class="card md-12">
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
<div class="pill">Total directos: <span class="result" id="sub_v15_total_directos">$0.00</span></div>
<div class="pill">Total depreciación: <span class="result" id="sub_v15_total_depr">$0.00</span></div>
<div class="pill">Total sin G/I: <span class="result" id="sub_v15_subtotal_no_gi">$0.00</span></div>
</div>
<div class="sep"></div>
<div class="row" style="justify-content:space-between;align-items:center;gap:10px;margin-top:6px">
<label style="display:flex;align-items:center;gap:8px;margin:0">
<input id="sub_v15_mo_on" type="checkbox"/> Mano de obra
            </label>
<button class="copy-btn" id="sub_v15_mo_cfg_btn" type="button">Configurar</button>
</div>
<div class="row" id="sub_v15_mo_cfg" style="display:none;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-top:6px">
<div style="min-width:160px"><label>Sueldo mensual ($)</label><input id="sub_v15_mo_sueldo" type="text" value="400,00"/></div>
<div style="min-width:160px"><label>Horas al mes</label><input id="sub_v15_mo_horas_mes" type="text" value="176"/></div>
<div style="min-width:140px"><label>Setup (min)</label><input id="sub_v15_mo_setup" type="text" value="5,00"/></div>
<div style="min-width:180px"><label>Ejecución (min/ud)</label><input id="sub_v15_mo_run" type="text" value="2,00"/></div>
<div style="min-width:140px"><label>Unidades</label><input id="sub_v15_mo_units" type="text" value="1"/></div>
</div>
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px">
<div class="pill" id="sub_v15_mo_pill" style="display:none">+ Mano de obra: <span class="result" id="sub_v15_mo_val">$ 0,00</span></div>
</div>
<div class="sep"></div>
<div class="row">
<div style="flex:1;min-width:160px"><label><input checked="" id="sub_v15_chk_ganancia" type="checkbox"/> Ganancia (%)</label><input id="sub_v15_ganancia" min="0" step="1" type="number" value="40"/></div>
<div style="flex:1;min-width:160px"><label><input checked="" id="sub_v15_chk_impuestos" type="checkbox"/> Impuestos (%)</label><input id="sub_v15_impuestos" min="0" step="1" type="number" value="16"/></div>
</div>
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
<div class="pill">Subtotal: <span class="result" id="sub_v15_subtotal">$0.00</span></div>
<div class="pill">+ Ganancia: <span class="result" id="sub_v15_ganancia_val">$0.00</span></div>
<div class="pill">+ Impuestos: <span class="result" id="sub_v15_impuestos_val">$0.00</span></div>
</div>
<div class="sep"></div>
<div class="tot">Precio de Venta: <span class="result" id="sub_v15_total">$0.00</span></div>
<div class="center-actions">
<button class="copy-btn" id="sub_v15_btn_print">Exportar a PDF / Imprimir</button>
<button class="copy-btn" id="sub_v15_btn_copy">Copiar</button>
<button class="btn reset" id="sub_v15_btn_reset">Reset</button>
</div>
</div>

<!-- Cantidad de productos (Sublimación) – bloque no intrusivo -->
<div class="card md-12" id="sub_qty_card">
  <div class="row" style="align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
    <div class="row" style="align-items:center;gap:8px;flex-wrap:wrap">
      <label class="chk-label" style="display:flex;align-items:center;gap:6px;margin:0">
        <input type="checkbox" id="sub_qty_on"/>
        <span>Cantidad de productos</span>
      </label>
      <input type="number" id="sub_qty" min="1" step="1" value="1" style="max-width:100px"/>
      <span class="muted">Multiplica los totales por Q (solo vista, no cambia los cálculos base).</span>
    </div>
  </div>
  <div class="sep"></div>
  <div class="row" style="flex-wrap:wrap;gap:8px">
    <div class="pill"><span>Base sin G/I ×Q</span><span class="result mono" id="sub_qty_base">$ 0,00</span></div>
    <div class="pill"><span>Subtotal ×Q</span><span class="result mono" id="sub_qty_subtotal">$ 0,00</span></div>
    <div class="pill"><span>Ganancia ×Q</span><span class="result mono" id="sub_qty_g">$ 0,00</span></div>
    <div class="pill"><span>Impuestos ×Q</span><span class="result mono" id="sub_qty_i">$ 0,00</span></div>
    <div class="pill"><span>Total ×Q</span><span class="result mono" id="sub_qty_total">$ 0,00</span></div>
  </div>
</div></section>
</section>
<section class="view" id="view-esferas-navidenas">
<div class="grid">
<div class="card md-12">
<h3 style="margin:0 0 6px">Cálculo de costos — Esferas navideñas</h3>
</div>
<!-- Costos directos -->
<div class="card md-6" id="esf_costos_directos" style="background:#fff">
<h4 style="margin:0 0 10px">Costos directos</h4>
<!-- Producto principal -->
<div class="row" style="gap:8px;align-items:center;margin-top:6px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input checked="" id="esf_d_prod_on" type="checkbox"/>
<span>Producto</span>
</label>
<select id="esf_d_prod_select" style="min-width:240px">
<option value="colores6">Esfera colores 6 cm</option>
<option value="colores7">Esfera colores 7 cm</option>
<option value="colores8">Esfera colores 8 cm</option>
<option value="blanca8">Esfera blanca 8 cm</option>
<option value="transparente8">Esfera transparente 8 cm</option>
<option value="rellena8">Rellena (foto) 8 cm</option>
<option value="rellena10">Rellena (foto) 10 cm</option>
<!-- Extras comunes -->
<option value="glitter8">Esfera glitter 8 cm</option>
<option value="mate8">Esfera mate 8 cm</option>
<option value="vidrio8">Esfera de vidrio 8 cm</option>
</select>
</div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant.</label><input id="esf_d_prod_cant" min="0" step="1" type="number" value="12"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="esf_d_prod_precio" type="text" value="24,00"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="esf_d_prod_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:110px"><label>Cant. a utilizar</label><input id="esf_d_prod_use" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:110px"><label>Costo utilizado</label><input class="ud" id="esf_d_prod_used" readonly="" type="text"/></div>
</div>
<div class="sep"></div>
<!-- Vinil adhesivo -->
<div class="row" style="gap:8px;align-items:center">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input id="esf_d_vinil_on" type="checkbox"/>
          Vinil adhesivo (cortes/uds)
        </label>
</div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant.</label><input id="esf_d_vinil_cant" min="0" step="1" type="number" value="100"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="esf_d_vinil_precio" type="text" value="8,00"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="esf_d_vinil_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:110px"><label>Cant. a utilizar</label><input id="esf_d_vinil_use" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:110px"><label>Costo utilizado</label><input class="ud" id="esf_d_vinil_used" readonly="" type="text"/></div>
</div>
<!-- Papel fotográfico (solo rellenas/foto) -->
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input id="esf_d_papel_on" type="checkbox"/>
          Papel fotográfico (para foto interior)
        </label>
</div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant.</label><input id="esf_d_papel_cant" min="0" step="1" type="number" value="100"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="esf_d_papel_precio" type="text" value="10,00"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="esf_d_papel_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:110px"><label>Cant. a utilizar</label><input id="esf_d_papel_use" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:110px"><label>Costo utilizado</label><input class="ud" id="esf_d_papel_used" readonly="" type="text"/></div>
</div>
<!-- Nieve artificial -->
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input id="esf_d_nieve_on" type="checkbox"/>
          Nieve artificial (bolsa/unid.)
        </label>
</div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant.</label><input id="esf_d_nieve_cant" min="0" step="1" type="number" value="50"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="esf_d_nieve_precio" type="text" value="6,00"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="esf_d_nieve_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:110px"><label>Cant. a utilizar</label><input id="esf_d_nieve_use" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:110px"><label>Costo utilizado</label><input class="ud" id="esf_d_nieve_used" readonly="" type="text"/></div>
</div>
<!-- Rellenos extra -->
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input id="esf_d_extra_on" type="checkbox"/>
          Rellenos extra (confeti, perlas, etc.)
        </label>
</div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant.</label><input id="esf_d_extra_cant" min="0" step="1" type="number" value="100"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="esf_d_extra_precio" type="text" value="8,00"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="esf_d_extra_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:110px"><label>Cant. a utilizar</label><input id="esf_d_extra_use" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:110px"><label>Costo utilizado</label><input class="ud" id="esf_d_extra_used" readonly="" type="text"/></div>
</div>
<!-- Cinta/Lazo (22.86 m por rollo, 0.5 m por esfera ≈ 45 uds/rollo) -->
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input id="esf_d_cinta_on" type="checkbox"/>
          Cinta/Lazo (rollo 22,86 m, 0,5 m por esfera)
        </label>
</div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Unidades por rollo</label><input id="esf_d_cinta_udxrollo" min="1" step="1" type="number" value="45"/></div>
<div style="flex:1;min-width:110px"><label>Precio del rollo ($)</label><input id="esf_d_cinta_precio" type="text" value="3,50"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="esf_d_cinta_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:110px"><label>Cant. a utilizar</label><input id="esf_d_cinta_use" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:110px"><label>Costo utilizado</label><input class="ud" id="esf_d_cinta_used" readonly="" type="text"/></div>
</div>
<!-- Silicón en barra -->
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input id="esf_d_silicon_on" type="checkbox"/>
          Silicón en barra (mini 11×100 mm aprox.)
        </label>
</div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant. de barras</label><input id="esf_d_silicon_cant" min="1" step="1" type="number" value="50"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="esf_d_silicon_precio" type="text" value="5,00"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="esf_d_silicon_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:110px"><label>Cant. a utilizar</label><input id="esf_d_silicon_use" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:110px"><label>Costo utilizado</label><input class="ud" id="esf_d_silicon_used" readonly="" type="text"/></div>
</div>
</div>
<!-- Depreciación -->
<div class="card md-6" id="esf_depreciacion" style="background:#fff">
<h4 style="margin:0 0 10px">Depreciación de equipos <span class="muted">(base 2 años)</span></h4>
<!-- Impresora -->
<div class="row" style="gap:8px;align-items:center">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input class="esf_dep_on" data-row="impresora" type="checkbox"/>
          Impresora
        </label>
</div>
<div class="row">
<div style="flex:1;min-width:120px"><label>Precio ($)</label><input class="esf_dep_precio" data-row="impresora" type="text" value="240"/></div>
<div style="flex:1;min-width:120px"><label>costo x Mes</label><input class="ud esf_dep_mes" data-row="impresora" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Costo Ud.</label><input class="ud esf_dep_ud" data-row="impresora" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Cant. de usos</label><input class="esf_dep_usos" data-row="impresora" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:120px"><label>Costo utilizado</label><input class="ud esf_dep_used" data-row="impresora" readonly="" type="text"/></div>
</div>
<!-- Plancha térmica -->
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input class="esf_dep_on" data-row="plancha" type="checkbox"/>
          Plancha térmica
        </label>
</div>
<div class="row">
<div style="flex:1;min-width:120px"><label>Precio ($)</label><input class="esf_dep_precio" data-row="plancha" type="text" value="400"/></div>
<div style="flex:1;min-width:120px"><label>costo x Mes</label><input class="ud esf_dep_mes" data-row="plancha" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Costo Ud.</label><input class="ud esf_dep_ud" data-row="plancha" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Cant. de usos</label><input class="esf_dep_usos" data-row="plancha" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:120px"><label>Costo utilizado</label><input class="ud esf_dep_used" data-row="plancha" readonly="" type="text"/></div>
</div>
<!-- Computadora -->
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input class="esf_dep_on" data-row="pc" type="checkbox"/>
          Computadora
        </label>
</div>
<div class="row">
<div style="flex:1;min-width:120px"><label>Precio ($)</label><input class="esf_dep_precio" data-row="pc" type="text" value="350"/></div>
<div style="flex:1;min-width:120px"><label>costo x Mes</label><input class="ud esf_dep_mes" data-row="pc" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Costo Ud.</label><input class="ud esf_dep_ud" data-row="pc" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Cant. de usos</label><input class="esf_dep_usos" data-row="pc" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:120px"><label>Costo utilizado</label><input class="ud esf_dep_used" data-row="pc" readonly="" type="text"/></div>
</div>
<!-- Plotter de corte -->
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input class="esf_dep_on" data-row="plotter" type="checkbox"/>
          Plotter de corte
        </label>
</div>
<div class="row">
<div style="flex:1;min-width:120px"><label>Precio ($)</label><input class="esf_dep_precio" data-row="plotter" type="text" value="400"/></div>
<div style="flex:1;min-width:120px"><label>costo x Mes</label><input class="ud esf_dep_mes" data-row="plotter" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Costo Ud.</label><input class="ud esf_dep_ud" data-row="plotter" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Cant. de usos</label><input class="esf_dep_usos" data-row="plotter" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:120px"><label>Costo utilizado</label><input class="ud esf_dep_used" data-row="plotter" readonly="" type="text"/></div>
</div>
<!-- Cuchilla de corte (vida en usos) -->
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input class="esf_dep_on" data-row="cuchilla" type="checkbox"/>
          Cuchilla de corte
        </label>
</div>
<div class="row">
<div style="flex:1;min-width:120px"><label>Precio ($)</label><input class="esf_dep_precio" data-row="cuchilla" type="text" value="30"/></div>
<div style="flex:1;min-width:120px"><label>Vida útil (cortes)</label><input class="esf_dep_vida" data-row="cuchilla" type="text" value="500"/></div>
<div style="flex:1;min-width:120px"><label>Costo Ud.</label><input class="ud esf_dep_ud" data-row="cuchilla" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Cant. de usos</label><input class="esf_dep_usos" data-row="cuchilla" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:120px"><label>Costo utilizado</label><input class="ud esf_dep_used" data-row="cuchilla" readonly="" type="text"/></div>
</div>
<!-- Tapete de corte (vida en usos) -->
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input class="esf_dep_on" data-row="tapete" type="checkbox"/>
          Tapete de corte (vida en usos)
        </label>
</div>
<div class="row">
<div style="flex:1;min-width:120px"><label>Precio ($)</label><input class="esf_dep_precio" data-row="tapete" type="text" value="12"/></div>
<div style="flex:1;min-width:120px"><label>Vida útil (usos)</label><input class="esf_dep_vida" data-row="tapete" type="text" value="500"/></div>
<div style="flex:1;min-width:120px"><label>Costo Ud.</label><input class="ud esf_dep_ud" data-row="tapete" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Cant. de usos</label><input class="esf_dep_usos" data-row="tapete" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:120px"><label>Costo utilizado</label><input class="ud esf_dep_used" data-row="tapete" readonly="" type="text"/></div>
</div>
<!-- Pistola de silicón -->
<div class="row" style="gap:8px;align-items:center;margin-top:10px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input class="esf_dep_on" data-row="pistola" type="checkbox"/>
          Pistola de silicón
        </label>
</div>
<div class="row">
<div style="flex:1;min-width:120px"><label>Precio ($)</label><input class="esf_dep_precio" data-row="pistola" type="text" value="18"/></div>
<div style="flex:1;min-width:120px"><label>costo x Mes</label><input class="ud esf_dep_mes" data-row="pistola" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Costo Ud.</label><input class="ud esf_dep_ud" data-row="pistola" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Cant. de usos</label><input class="esf_dep_usos" data-row="pistola" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:120px"><label>Costo utilizado</label><input class="ud esf_dep_used" data-row="pistola" readonly="" type="text"/></div>
</div>
</div>
<!-- Indirectos -->
<div class="card md-12 indA-card" id="esf_ind_card">
<h4>Costos indirectos</h4>
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
<label style="display:flex;align-items:center;gap:8px;margin:0"><input id="esf_ind_on" type="checkbox"/> Activar</label>
<div class="pill indA-pill">Costo Ud. (indirectos): <span class="result" id="esf_ind_ud">$ 0,00</span></div>
<div style="margin-left:auto"><button class="btn" id="esf_ind_cfg_btn">Configurar</button></div>
</div>
<div class="sep"></div>
<div id="esf_ind_cfg" style="display:none">
<div class="row" style="gap:14px;flex-wrap:wrap">
<div style="min-width:160px;flex:1"><label>Alquiler (mensual)</label><input id="esf_ind_alquiler" type="text" value="0,00"/></div>
<div style="min-width:160px;flex:1"><label>Internet (mensual)</label><input id="esf_ind_internet" type="text" value="0,00"/></div>
<div style="min-width:160px;flex:1"><label>Suscripciones (mensual)</label><input id="esf_ind_suscripciones" type="text" value="0,00"/></div>
<div style="min-width:160px;flex:1"><label>Transporte (mensual)</label><input id="esf_ind_transporte" type="text" value="0,00"/></div>
<div style="min-width:160px;flex:1"><label>Electricidad (mensual)</label><input id="esf_ind_electricidad" type="text" value="0,00"/></div>
<div style="min-width:160px;flex:1"><label>Publicidad (mensual)</label><input id="esf_ind_publicidad" type="text" value="0,00"/></div>
<div style="min-width:160px;flex:1"><label>Otros (mensual)</label><input id="esf_ind_otros" type="text" value="0,00"/></div>
<div style="min-width:120px"><label>Unidades/mes</label><input class="indA-small" id="esf_ind_units" min="1" step="1" type="number" value="100"/></div>
</div>
</div>
</div>
<!-- Totales / G&I / Mano de obra -->
<div class="card md-12" id="esf_gi_card">
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
<div class="pill">Total directos: <span class="result" id="esf_total_directos">$0.00</span></div>
<div class="pill">Total depreciación: <span class="result" id="esf_total_depr">$0.00</span></div>
<div class="pill">Total sin G/I: <span class="result" id="esf_subtotal_no_gi">$0.00</span></div>
</div>
<div class="sep"></div>
<div class="row" style="justify-content:space-between;align-items:center;gap:10px;margin-top:6px">
<label style="display:flex;align-items:center;gap:8px;margin:0"><input id="esf_mo_on" type="checkbox"/> Mano de obra</label>
<button class="copy-btn" id="esf_mo_cfg_btn" type="button">Configurar</button>
</div>
<div class="row" id="esf_mo_cfg" style="display:none;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-top:6px">
<div style="min-width:160px"><label>Sueldo mensual ($)</label><input id="esf_mo_sueldo" type="text" value="400,00"/></div>
<div style="min-width:160px"><label>Horas al mes</label><input id="esf_mo_horas_mes" type="text" value="176"/></div>
<div style="min-width:140px"><label>Setup (min)</label><input id="esf_mo_setup" type="text" value="5,00"/></div>
<div style="min-width:180px"><label>Ejecución (min/ud)</label><input id="esf_mo_run" type="text" value="2,00"/></div>
<div class="mo-unidades" style="min-width:140px"><label>Unidades</label><input id="esf_mo_units" type="text" value="1"/></div>
</div>
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px">
<div class="pill" id="esf_mo_pill" style="display:none">+ Mano de obra: <span class="result" id="esf_mo_val">$ 0,00</span></div>
</div>
<div class="sep"></div>
<div class="row">
<div style="flex:1;min-width:160px"><label><input checked="" id="esf_chk_ganancia" type="checkbox"/> Ganancia (%)</label><input id="esf_ganancia" min="0" step="1" type="number" value="40"/>
<label style="margin-top:6px">Modo ganancia:</label>
<select id="esf_modo_ganancia">
<option value="markup">Markup</option>
<option selected="" value="margen">Margen</option>
</select>
</div>
<div style="flex:1;min-width:160px"><label><input checked="" id="esf_chk_impuestos" type="checkbox"/> Impuestos (%)</label><input id="esf_impuestos" min="0" step="1" type="number" value="16"/></div>
</div>
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
<div class="pill">Subtotal: <span class="result" id="esf_subtotal">$0.00</span></div>
<div class="pill">+ Ganancia: <span class="result" id="esf_ganancia_val">$0.00</span></div>
<div class="pill">+ Impuestos: <span class="result" id="esf_impuestos_val">$0.00</span></div>
</div>
<div class="sep"></div>
<div class="row" style="justify-content:space-between;align-items:center">
<div class="tot">Precio de Venta: <span class="result" id="esf_total">$0.00</span></div>
<button class="btn reset" id="esf_btn_reset">Reset</button>
<div class="center-actions">
    <button class="copy-btn" id="esf_btn_print" type="button">Exportar a PDF / Imprimir</button>
  </div>
</div>
</div>

<!-- Cantidad de productos (Esferas navideñas) – bloque no intrusivo -->
<div class="card md-12" id="esf_qty_card">
  <div class="row" style="align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
    <div class="row" style="align-items:center;gap:8px;flex-wrap:wrap">
      <label class="chk-label" style="display:flex;align-items:center;gap:6px;margin:0">
        <input type="checkbox" id="esf_qty_on"/>
        <span>Cantidad de productos</span>
      </label>
      <input type="number" id="esf_qty" min="1" step="1" value="1" style="max-width:100px"/>
      <span class="muted">Multiplica los totales por Q (solo vista, no cambia los cálculos base).</span>
    </div>
  </div>
  <div class="sep"></div>
  <div class="row" style="flex-wrap:wrap;gap:8px">
    <div class="pill"><span>Base sin G/I ×Q</span><span class="result mono" id="esf_qty_base">$ 0,00</span></div>
    <div class="pill"><span>Subtotal ×Q</span><span class="result mono" id="esf_qty_subtotal">$ 0,00</span></div>
    <div class="pill"><span>Ganancia ×Q</span><span class="result mono" id="esf_qty_g">$ 0,00</span></div>
    <div class="pill"><span>Impuestos ×Q</span><span class="result mono" id="esf_qty_i">$ 0,00</span></div>
    <div class="pill"><span>Total ×Q</span><span class="result mono" id="esf_qty_total">$ 0,00</span></div>
  </div>
</div>

</div>
</section>
<section class="view" id="view-etiquetas">
<div class="grid">
<div class="card md-12">
<h3 style="margin:0 0 6px">Cálculo de costos — Etiquetas</h3>
<div class="sep"></div>
</div>
<div class="card md-6" style="background:#fff">
<h4 style="margin:0 0 10px">Costos directos</h4>

<div class="row" style="gap:8px;align-items:center;margin-top:6px">
  <label class="chk-label" style="display:flex;align-items:center;gap:8px">
    <input checked="" id="eti_d_prod_on" type="checkbox"/>
    <span id="eti_d_prod_label">Sustrato (papel / vinil / BOPP / térmico): <select id="eti_d_prod_select">
      <option>Vinil imprimible</option>
      <option>Papel fotográfico adhesivo</option>
      <option>Etiqueta PVC</option>
      <option>Etiqueta BOPP</option>
      <option>Holográfico</option>
      <option>Transparente</option>
      <option>Kraft</option>
      <option>Otros</option>
    </select></span>
  </label>
</div>
<div class="row">
  <div style="flex:1;min-width:110px"><label>Cant.</label><input id="eti_d_prod_cant" min="0" step="1" type="number" value="50"/></div>
  <div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="eti_d_prod_precio" min="0" step="0.01" type="number" value="20"/></div>
  <div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="eti_d_prod_ud" readonly="" type="text"/></div>
  <div style="flex:1;min-width:110px"><label>Cantidad a utilizar</label><input id="eti_d_prod_use" min="0" step="0.01" type="number" value="1"/></div>
  <div style="flex:1;min-width:110px"><label>Costo utilizado</label><input class="ud" id="eti_d_prod_used" readonly="" type="text"/></div>
</div>

<div class="sep"></div>
<div class="row" style="gap:8px;align-items:center"><label class="chk-label" style="display:flex;align-items:center;gap:8px"><input checked="" id="eti_d_adhesivo_on" type="checkbox"/> Adhesivo</label></div>
<div class="row">
  <div style="flex:1;min-width:110px"><label>Cant.</label><input id="eti_d_adhesivo_cant" min="0" step="1" type="number" value="500"/></div>
  <div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="eti_d_adhesivo_precio" min="0" step="0.01" type="number" value="15"/></div>
  <div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="eti_d_adhesivo_ud" readonly="" type="text"/></div>
  <div style="flex:1;min-width:110px"><label>Cantidad a utilizar</label><input id="eti_d_adhesivo_use" min="0" step="0.01" type="number" value="1"/></div>
  <div style="flex:1;min-width:110px"><label>Costo utilizado</label><input class="ud" id="eti_d_adhesivo_used" readonly="" type="text"/></div>
</div>

<div class="sep"></div>
<div class="row" style="gap:8px;align-items:center"><label class="chk-label" style="display:flex;align-items:center;gap:8px"><input checked="" id="eti_d_liner_on" type="checkbox"/> Liner / backing</label></div>
<div class="row">
  <div style="flex:1;min-width:110px"><label>Cant.</label><input id="eti_d_liner_cant" min="0" step="1" type="number" value="1000"/></div>
  <div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="eti_d_liner_precio" min="0" step="0.01" type="number" value="20"/></div>
  <div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="eti_d_liner_ud" readonly="" type="text"/></div>
  <div style="flex:1;min-width:110px"><label>Cantidad a utilizar</label><input id="eti_d_liner_use" min="0" step="0.01" type="number" value="1"/></div>
  <div style="flex:1;min-width:110px"><label>Costo utilizado</label><input class="ud" id="eti_d_liner_used" readonly="" type="text"/></div>
</div>

<div class="sep"></div>
<div class="row" style="gap:8px;align-items:center"><label class="chk-label" style="display:flex;align-items:center;gap:8px"><input checked="" id="eti_d_tinta_on" type="checkbox"/> Tinta</label></div>
<div class="row">
  <div style="flex:1;min-width:110px"><label>Cant.</label><input id="eti_d_tinta_cant" min="0" step="1" type="number" value="1000"/></div>
  <div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="eti_d_tinta_precio" min="0" step="0.01" type="number" value="30"/></div>
  <div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="eti_d_tinta_ud" readonly="" type="text"/></div>
  <div style="flex:1;min-width:110px"><label>Cantidad a utilizar</label><input id="eti_d_tinta_use" min="0" step="0.01" type="number" value="1"/></div>
  <div style="flex:1;min-width:110px"><label>Costo utilizado</label><input class="ud" id="eti_d_tinta_used" readonly="" type="text"/></div>
</div>

<div class="sep"></div>
<div class="row" style="gap:8px;align-items:center"><label class="chk-label" style="display:flex;align-items:center;gap:8px"><input checked="" id="eti_d_merma_on" type="checkbox"/> Merma y pruebas</label></div>
<div class="row">
  <div style="flex:1;min-width:110px"><label>Cant.</label><input id="eti_d_merma_cant" min="0" step="1" type="number" value="500"/></div>
  <div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="eti_d_merma_precio" min="0" step="0.01" type="number" value="5"/></div>
  <div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="eti_d_merma_ud" readonly="" type="text"/></div>
  <div style="flex:1;min-width:110px"><label>Cantidad a utilizar</label><input id="eti_d_merma_use" min="0" step="0.01" type="number" value="1"/></div>
  <div style="flex:1;min-width:110px"><label>Costo utilizado</label><input class="ud" id="eti_d_merma_used" readonly="" type="text"/></div>
</div>

<div class="sep"></div>
<div class="row" style="gap:8px;align-items:center"><label class="chk-label" style="display:flex;align-items:center;gap:8px"><input checked="" id="eti_d_laminado_on" type="checkbox"/> Laminado / barniz</label></div>
<div class="row">
  <div style="flex:1;min-width:110px"><label>Cant.</label><input id="eti_d_laminado_cant" min="0" step="1" type="number" value="20"/></div>
  <div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="eti_d_laminado_precio" min="0" step="0.01" type="number" value="10"/></div>
  <div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="eti_d_laminado_ud" readonly="" type="text"/></div>
  <div style="flex:1;min-width:110px"><label>Cantidad a utilizar</label><input id="eti_d_laminado_use" min="0" step="0.01" type="number" value="1"/></div>
  <div style="flex:1;min-width:110px"><label>Costo utilizado</label><input class="ud" id="eti_d_laminado_used" readonly="" type="text"/></div>
</div>

<div class="sep"></div>
<div class="row" style="gap:8px;align-items:center"><label class="chk-label" style="display:flex;align-items:center;gap:8px"><input checked="" id="eti_d_empaque_on" type="checkbox"/> Empaque</label></div>
<div class="row">
  <div style="flex:1;min-width:110px"><label>Cant.</label><input id="eti_d_empaque_cant" min="0" step="1" type="number" value="200"/></div>
  <div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="eti_d_empaque_precio" min="0" step="0.01" type="number" value="8"/></div>
  <div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="eti_d_empaque_ud" readonly="" type="text"/></div>
  <div style="flex:1;min-width:110px"><label>Cantidad a utilizar</label><input id="eti_d_empaque_use" min="0" step="0.01" type="number" value="1"/></div>
  <div style="flex:1;min-width:110px"><label>Costo utilizado</label><input class="ud" id="eti_d_empaque_used" readonly="" type="text"/></div>
</div>
</div>

<div class="card md-6" style="background:#fff">
<h4 style="margin:0 0 10px">Depreciación</h4>

<div class="row" style="gap:8px;align-items:center"><label class="chk-label" style="display:flex;align-items:center;gap:8px"><input checked="" id="eti_e_impresora_on" type="checkbox"/> Impresora de etiquetas</label></div>
<div class="row">
  <div style="flex:1;min-width:120px"><label>Precio ($)</label><input id="eti_e_impresora_precio" min="0" step="0.01" type="number" value="240"/></div>
  <div style="flex:1;min-width:120px"><label>costo x Mes</label><input class="ud" id="eti_e_impresora_mes" readonly="" type="text"/></div>
  <div style="flex:1;min-width:120px"><label>Costo Ud.</label><input class="ud" id="eti_e_impresora_ud" readonly="" type="text"/></div>
  <div style="flex:1;min-width:120px"><label>Cant. de usos</label><input id="eti_e_impresora_use" min="0" step="1" type="number" value="1"/></div>
  <div style="flex:1;min-width:120px"><label>Costo utilizado</label><input class="ud" id="eti_e_impresora_used" readonly="" type="text"/></div>
</div>

<div class="sep"></div>
<div class="row" style="gap:8px;align-items:center"><label class="chk-label" style="display:flex;align-items:center;gap:8px"><input checked="" id="eti_e_plotter_on" type="checkbox"/> Plotter de corte</label></div>
<div class="row">
  <div style="flex:1;min-width:120px"><label>Precio ($)</label><input id="eti_e_plotter_precio" min="0" step="0.01" type="number" value="400"/></div>
  <div style="flex:1;min-width:120px"><label>costo x Mes</label><input class="ud" id="eti_e_plotter_mes" readonly="" type="text"/></div>
  <div style="flex:1;min-width:120px"><label>Costo Ud.</label><input class="ud" id="eti_e_plotter_ud" readonly="" type="text"/></div>
  <div style="flex:1;min-width:120px"><label>Cant. de usos</label><input id="eti_e_plotter_use" min="0" step="1" type="number" value="1"/></div>
  <div style="flex:1;min-width:120px"><label>Costo utilizado</label><input class="ud" id="eti_e_plotter_used" readonly="" type="text"/></div>
</div>

<div class="sep"></div>
<div class="row" style="gap:8px;align-items:center"><label class="chk-label" style="display:flex;align-items:center;gap:8px"><input checked="" id="eti_e_guillotina_on" type="checkbox"/> Guillotina</label></div>
<div class="row">
  <div style="flex:1;min-width:120px"><label>Precio ($)</label><input id="eti_e_guillotina_precio" min="0" step="0.01" type="number" value="120"/></div>
  <div style="flex:1;min-width:120px"><label>costo x Mes</label><input class="ud" id="eti_e_guillotina_mes" readonly="" type="text"/></div>
  <div style="flex:1;min-width:120px"><label>Costo Ud.</label><input class="ud" id="eti_e_guillotina_ud" readonly="" type="text"/></div>
  <div style="flex:1;min-width:120px"><label>Cant. de usos</label><input id="eti_e_guillotina_use" min="0" step="1" type="number" value="1"/></div>
  <div style="flex:1;min-width:120px"><label>Costo utilizado</label><input class="ud" id="eti_e_guillotina_used" readonly="" type="text"/></div>
</div>

<div class="sep"></div>
<div class="row" style="gap:8px;align-items:center"><label class="chk-label" style="display:flex;align-items:center;gap:8px"><input checked="" id="eti_e_tapete_on" type="checkbox"/> Tapete de corte</label></div>
<div class="row">
  <div style="flex:1;min-width:120px"><label>Precio ($)</label><input id="eti_e_tapete_precio" min="0" step="0.01" type="number" value="15"/></div>
  <div style="flex:1;min-width:120px"><label>costo x Mes</label><input class="ud" id="eti_e_tapete_mes" readonly="" type="text"/></div>
  <div style="flex:1;min-width:120px"><label>Costo Ud.</label><input class="ud" id="eti_e_tapete_ud" readonly="" type="text"/></div>
  <div style="flex:1;min-width:120px"><label>Cant. de usos</label><input id="eti_e_tapete_use" min="0" step="1" type="number" value="1"/></div>
  <div style="flex:1;min-width:120px"><label>Costo utilizado</label><input class="ud" id="eti_e_tapete_used" readonly="" type="text"/></div>
</div>

<div class="sep"></div>
<div class="row" style="gap:8px;align-items:center"><label class="chk-label" style="display:flex;align-items:center;gap:8px"><input checked="" id="eti_e_cuchilla_on" type="checkbox"/> Cuchilla de corte</label></div>
<div class="row">
  <div style="flex:1;min-width:120px"><label>Precio ($)</label><input id="eti_e_cuchilla_precio" min="0" step="0.01" type="number" value="30"/></div>
  <div style="flex:1;min-width:120px"><label>Vida útil (cortes)</label><input id="eti_e_cuchilla_vida" min="1" step="1" type="number" value="100"/></div>
  <div style="flex:1;min-width:120px"><label>Costo por corte</label><input class="ud" id="eti_e_cuchilla_ud" readonly="" type="text"/></div>
  <div style="flex:1;min-width:120px"><label>Cant. de usos</label><input id="eti_e_cuchilla_use" min="0" step="1" type="number" value="1"/></div>
  <div style="flex:1;min-width:120px"><label>Costo utilizado</label><input class="ud" id="eti_e_cuchilla_used" readonly="" type="text"/></div>
</div>

<div class="sep"></div>
<div class="row" style="gap:8px;align-items:center"><label class="chk-label" style="display:flex;align-items:center;gap:8px"><input checked="" id="eti_e_troqueladora_on" type="checkbox"/> Troqueladora</label></div>
<div class="row">
  <div style="flex:1;min-width:120px"><label>Precio ($)</label><input id="eti_e_troqueladora_precio" min="0" step="0.01" type="number" value="300"/></div>
  <div style="flex:1;min-width:120px"><label>costo x Mes</label><input class="ud" id="eti_e_troqueladora_mes" readonly="" type="text"/></div>
  <div style="flex:1;min-width:120px"><label>Costo Ud.</label><input class="ud" id="eti_e_troqueladora_ud" readonly="" type="text"/></div>
  <div style="flex:1;min-width:120px"><label>Cant. de usos</label><input id="eti_e_troqueladora_use" min="0" step="1" type="number" value="1"/></div>
  <div style="flex:1;min-width:120px"><label>Costo utilizado</label><input class="ud" id="eti_e_troqueladora_used" readonly="" type="text"/></div>
</div>

<div class="sep"></div>
<div class="row" style="gap:8px;align-items:center"><label class="chk-label" style="display:flex;align-items:center;gap:8px"><input checked="" id="eti_e_pc_on" type="checkbox"/> Computadora (PC)</label></div>
<div class="row">
  <div style="flex:1;min-width:120px"><label>Precio ($)</label><input id="eti_e_pc_precio" min="0" step="0.01" type="number" value="350"/></div>
  <div style="flex:1;min-width:120px"><label>costo x Mes</label><input class="ud" id="eti_e_pc_mes" readonly="" type="text"/></div>
  <div style="flex:1;min-width:120px"><label>Costo Ud.</label><input class="ud" id="eti_e_pc_ud" readonly="" type="text"/></div>
  <div style="flex:1;min-width:120px"><label>Cant. de usos</label><input id="eti_e_pc_use" min="0" step="1" type="number" value="1"/></div>
  <div style="flex:1;min-width:120px"><label>Costo utilizado</label><input class="ud" id="eti_e_pc_used" readonly="" type="text"/></div>
</div>
</div>
<div class="card md-12 indA-card" id="eti_ind_card"><h4>Costos indirectos</h4><div class="row" style="gap:10px;align-items:center;flex-wrap:wrap"><label style="display:flex;align-items:center;gap:8px;margin:0"><input id="eti_ind_on" type="checkbox"/> Activar</label><div class="pill indA-pill">Costo Ud. (indirectos): <span class="result" id="eti_ind_ud">$ 0,00</span></div><div style="margin-left:auto"><button class="btn" id="eti_ind_cfg_btn">Configurar</button></div></div><div class="sep"></div><div id="eti_ind_cfg" style="display:none"><div class="row" style="gap:14px;flex-wrap:wrap"><div style="min-width:160px;flex:1"><label>Alquiler (mensual)</label><input id="eti_ind_alquiler" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Internet (mensual)</label><input id="eti_ind_internet" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Suscripciones (mensual)</label><input id="eti_ind_suscripciones" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Transporte (mensual)</label><input id="eti_ind_transporte" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Electricidad (mensual)</label><input id="eti_ind_electricidad" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Publicidad (mensual)</label><input id="eti_ind_publicidad" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Otros (mensual)</label><input id="eti_ind_otros" type="text" value="0,00"/></div><div style="min-width:120px"><label>Unidades/mes</label><input class="indA-small" id="eti_ind_units" min="1" step="1" type="number" value="100"/></div></div></div></div><div class="card md-12">
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
<div class="pill">Total directos: <span class="result" id="eti_total_directos">$0.00</span></div>
<div class="pill">Total depreciación: <span class="result" id="eti_total_depr">$0.00</span></div>
<div class="pill">Total sin G/I: <span class="result" id="eti_subtotal_no_gi">$0.00</span></div>
</div>
<div class="sep"></div>
<div class="row" style="justify-content:space-between;align-items:center;gap:10px;margin-top:6px">
<label style="display:flex;align-items:center;gap:8px;margin:0">
<input id="eti_mo_on" type="checkbox"/> Mano de obra
    </label>
<button class="copy-btn" id="eti_mo_cfg_btn" type="button">Configurar</button>
</div>
<div class="row" id="eti_mo_cfg" style="display:none;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-top:6px">
<div style="min-width:160px"><label>Sueldo mensual ($)</label><input id="eti_mo_sueldo" type="text" value="400,00"/></div>
<div style="min-width:160px"><label>Horas al mes</label><input id="eti_mo_horas_mes" type="text" value="176"/></div>
<div style="min-width:140px"><label>Setup (min)</label><input id="eti_mo_setup" type="text" value="5,00"/></div>
<div style="min-width:180px"><label>Ejecución (min/ud)</label><input id="eti_mo_run" type="text" value="2,00"/></div>
<div style="min-width:140px"><label>Unidades</label><input id="eti_mo_units" type="text" value="1"/></div>
</div>
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px">
<div class="pill" id="eti_mo_pill" style="display:none">+ Mano de obra: <span class="result" id="eti_mo_val">$ 0,00</span></div>
</div>	
<div class="sep"></div>
<div class="row">
<div style="flex:1;min-width:160px"><label><input checked="" id="eti_chk_ganancia" type="checkbox"/> Ganancia (%)</label><input id="eti_ganancia" min="0" step="1" type="number" value="40"/></div>
<div style="flex:1;min-width:160px"><label><input checked="" id="eti_chk_impuestos" type="checkbox"/> Impuestos (%)</label><input id="eti_impuestos" min="0" step="1" type="number" value="16"/></div>
</div>
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
<div class="pill">Subtotal: <span class="result" id="eti_subtotal">$0.00</span></div>
<div class="pill">+ Ganancia: <span class="result" id="eti_ganancia_val">$0.00</span></div>
<div class="pill">+ Impuestos: <span class="result" id="eti_impuestos_val">$0.00</span></div>
</div>
<div class="sep"></div>
<div class="tot">Precio de Venta: <span class="result" id="eti_total">$0.00</span></div>
<div class="center-actions">
<button class="copy-btn" id="btn_print_eti">Exportar a PDF / Imprimir</button>
<button class="copy-btn" id="btn_copy_eti">Copiar</button>
<button class="btn reset" id="btn_reset_eti">Reset</button>
</div>
</div>
</div>
</section>
<section class="view" id="view-empaques">
<div class="grid">
<div class="card md-12">
<h3 style="margin:0 0 6px">Cálculo de costos — Empaques</h3>
<div class="sep"></div>
</div>
<div class="card md-6" style="background:#fff">
<h4 style="margin:0 0 10px">Costos directos</h4>
<div class="row" style="gap:8px;align-items:center"><label class="chk-label" style="display:flex;align-items:center;gap:8px"><input checked="" id="emp_caja_on" type="checkbox"/> Caja</label></div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant.</label><input id="emp_caja_cant" min="0" step="1" type="number" value="50"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="emp_caja_precio" min="0" step="0.01" type="number" value="20"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="emp_caja_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:110px"><label>Cant. a utilizar</label><input id="emp_caja_use" min="0" step="0.01" type="number" value="1"/></div>
<div style="flex:1;min-width:130px"><label>Costo utilizado</label><input class="ud" id="emp_caja_used" readonly="" type="text" value="0,00"/></div>
</div>
<div class="row" style="gap:8px;align-items:center;margin-top:8px"><label class="chk-label" style="display:flex;align-items:center;gap:8px"><input checked="" id="emp_bolsa_on" type="checkbox"/> Bolsa</label></div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant.</label><input id="emp_bolsa_cant" min="0" step="1" type="number" value="100"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="emp_bolsa_precio" min="0" step="0.01" type="number" value="12"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="emp_bolsa_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:110px"><label>Cant. a utilizar</label><input id="emp_bolsa_use" min="0" step="0.01" type="number" value="1"/></div>
<div style="flex:1;min-width:130px"><label>Costo utilizado</label><input class="ud" id="emp_bolsa_used" readonly="" type="text" value="0,00"/></div>
</div>
<div class="row" style="gap:8px;align-items:center;margin-top:8px"><label class="chk-label" style="display:flex;align-items:center;gap:8px"><input checked="" id="emp_relleno_on" type="checkbox"/> Relleno / Protección</label></div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant.</label><input id="emp_relleno_cant" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="emp_relleno_precio" min="0" step="0.01" type="number" value="5"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="emp_relleno_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:110px"><label>Cant. a utilizar</label><input id="emp_relleno_use" min="0" step="0.01" type="number" value="1"/></div>
<div style="flex:1;min-width:130px"><label>Costo utilizado</label><input class="ud" id="emp_relleno_used" readonly="" type="text" value="0,00"/></div>
</div>
<div class="row" style="gap:8px;align-items:center;margin-top:8px"><label class="chk-label" style="display:flex;align-items:center;gap:8px"><input checked="" id="emp_etiqueta_on" type="checkbox"/> Etiqueta</label></div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant.</label><input id="emp_etiqueta_cant" min="0" step="1" type="number" value="100"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="emp_etiqueta_precio" min="0" step="0.01" type="number" value="8"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="emp_etiqueta_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:110px"><label>Cant. a utilizar</label><input id="emp_etiqueta_use" min="0" step="0.01" type="number" value="1"/></div>
<div style="flex:1;min-width:130px"><label>Costo utilizado</label><input class="ud" id="emp_etiqueta_used" readonly="" type="text" value="0,00"/></div>
</div>
<div class="row" style="gap:8px;align-items:center;margin-top:8px"><label class="chk-label" style="display:flex;align-items:center;gap:8px"><input id="emp_tarjeta_on" type="checkbox"/> Tarjeta de agradecimiento</label></div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant.</label><input id="emp_tarjeta_cant" min="0" step="1" type="number" value="50"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="emp_tarjeta_precio" min="0" step="0.01" type="number" value="6"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="emp_tarjeta_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:110px"><label>Cant. a utilizar</label><input id="emp_tarjeta_use" min="0" step="0.01" type="number" value="1"/></div>
<div style="flex:1;min-width:130px"><label>Costo utilizado</label><input class="ud" id="emp_tarjeta_used" readonly="" type="text" value="0,00"/></div>
</div>
<div class="row" style="gap:8px;align-items:center;margin-top:8px"><label class="chk-label" style="display:flex;align-items:center;gap:8px"><input id="emp_cinta_on" type="checkbox"/> Cinta adhesiva</label></div>
<div class="row">
<div style="flex:1;min-width:110px"><label>Cant.</label><input id="emp_cinta_cant" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:110px"><label>Precio ($)</label><input id="emp_cinta_precio" min="0" step="0.01" type="number" value="2"/></div>
<div style="flex:1;min-width:110px"><label>Costo Ud.</label><input class="ud" id="emp_cinta_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:110px"><label>Cant. a utilizar</label><input id="emp_cinta_use" min="0" step="0.01" type="number" value="1"/></div>
<div style="flex:1;min-width:130px"><label>Costo utilizado</label><input class="ud" id="emp_cinta_used" readonly="" type="text" value="0,00"/></div>
</div>
</div><div class="card md-6" style="background:#fff">
<h4 style="margin:0 0 10px">Depreciación <span class="muted">(opcional)</span></h4>
<div class="row" style="gap:8px;align-items:center"><label class="chk-label" style="display:flex;align-items:center;gap:8px"><input id="emp_impresora_on" type="checkbox"/> Impresora de etiquetas</label></div>
<div class="row">
<div style="flex:1;min-width:120px"><label>Precio ($)</label><input id="emp_impresora_precio" min="0" step="0.01" type="number" value="200"/></div>
<div style="flex:1;min-width:120px"><label>costo x Mes</label><input class="ud" id="emp_impresora_mes" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Costo Ud.</label><input class="ud" id="emp_impresora_ud" readonly="" type="text"/></div>
<div style="flex:1;min-width:120px"><label>Cant. de usos</label><input id="emp_impresora_use" min="0" step="1" type="number" value="1"/></div>
<div style="flex:1;min-width:130px"><label>Costo utilizado</label><input class="ud" id="emp_impresora_used" readonly="" type="text" value="0,00"/></div>
</div>
</div><div class="card md-12 indA-card" id="emp_ind_card"><h4>Costos indirectos</h4><div class="row" style="gap:10px;align-items:center;flex-wrap:wrap"><label style="display:flex;align-items:center;gap:8px;margin:0"><input id="emp_ind_on" type="checkbox"/> Activar</label><div class="pill indA-pill">Costo Ud. (indirectos): <span class="result" id="emp_ind_ud">$ 0,00</span></div><div style="margin-left:auto"><button class="btn" id="emp_ind_cfg_btn">Configurar</button></div></div><div class="sep"></div><div id="emp_ind_cfg" style="display:none"><div class="row" style="gap:14px;flex-wrap:wrap"><div style="min-width:160px;flex:1"><label>Alquiler (mensual)</label><input id="emp_ind_alquiler" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Internet (mensual)</label><input id="emp_ind_internet" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Suscripciones (mensual)</label><input id="emp_ind_suscripciones" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Transporte (mensual)</label><input id="emp_ind_transporte" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Electricidad (mensual)</label><input id="emp_ind_electricidad" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Publicidad (mensual)</label><input id="emp_ind_publicidad" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Otros (mensual)</label><input id="emp_ind_otros" type="text" value="0,00"/></div><div style="min-width:120px"><label>Unidades/mes</label><input class="indA-small" id="emp_ind_units" min="1" step="1" type="number" value="100"/></div></div></div></div><div class="card md-12" id="emp_totales_card">
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
<div class="pill">Total directos: <span class="result" id="emp_total_directos">$0.00</span></div>
<div class="pill">Total depreciación: <span class="result" id="emp_total_depr">$0.00</span></div>
<div class="pill">Total sin G/I: <span class="result" id="emp_subtotal_no_gi">$0.00</span></div>
</div>
<div class="sep"></div>
<div class="row" style="justify-content:space-between;align-items:center;gap:10px;margin-top:6px">
<label style="display:flex;align-items:center;gap:8px;margin:0">
<input id="emp_mo_on" type="checkbox"/> Mano de obra</label>
<button class="copy-btn" id="emp_mo_cfg_btn" type="button">Configurar</button>
</div>
<div class="row" id="emp_mo_cfg" style="display:none;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-top:6px">
<div style="min-width:160px"><label>Sueldo mensual ($)</label><input id="emp_mo_sueldo" type="text" value="400,00"/></div>
<div style="min-width:160px"><label>Horas al mes</label><input id="emp_mo_horas_mes" type="text" value="176"/></div>
<div style="min-width:140px"><label>Setup (min)</label><input id="emp_mo_setup" type="text" value="5,00"/></div>
<div style="min-width:180px"><label>Ejecución (min/ud)</label><input id="emp_mo_run" type="text" value="2,00"/></div>
<div style="min-width:140px"><label>Unidades</label><input id="emp_mo_units" type="text" value="1"/></div>
</div>
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px">
<div class="pill" id="emp_mo_pill" style="display:none">+ Mano de obra: <span class="result" id="emp_mo_val">$ 0,00</span></div>
</div>


<div class="sep"></div>
<div class="row">
<div style="flex:1;min-width:160px"><label><input checked="" id="emp_chk_ganancia" type="checkbox"/> Ganancia (%)</label><input id="emp_ganancia" min="0" step="1" type="number" value="30"/></div>
<div style="flex:1;min-width:160px"><label><input checked="" id="emp_chk_impuestos" type="checkbox"/> Impuestos (%)</label><input id="emp_impuestos" min="0" step="1" type="number" value="16"/></div>
</div>


<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
<div class="pill">Subtotal: <span class="result" id="emp_subtotal">$0.00</span></div>
<div class="pill">+ Ganancia: <span class="result" id="emp_ganancia_val">$0.00</span></div>
<div class="pill">+ Impuestos: <span class="result" id="emp_impuestos_val">$0.00</span></div>
</div>
<div class="sep"></div>
<div class="tot">Precio de Venta: <span class="result" id="emp_total">$0.00</span></div>
<div class="center-actions">
<button class="copy-btn" id="btn_print_emp">Exportar a PDF / Imprimir</button>
<button class="copy-btn" id="btn_copy_emp">Copiar</button>
<button class="btn reset" id="btn_reset_emp">Reset</button>
</div>
</div>
<div class="card md-12" id="emp_qty_card">
  <h4 style="margin:0 0 10px">Cantidad de productos</h4>
  <div class="row" style="align-items:center;gap:8px;flex-wrap:wrap">
    <label class="chk-label" style="display:flex;align-items:center;gap:6px;margin:0">
      <input type="checkbox" id="emp_qty_on">
      <span>Activar cantidad de productos</span>
    </label>
    <input type="number" id="emp_qty" min="1" step="1" value="1" style="max-width:100px">
    <span class="muted">Multiplica los totales de Empaques por la cantidad Q (solo vista, no cambia los cálculos base).</span>
  </div>
  <div class="sep"></div>
  <div class="row" style="flex-wrap:wrap;gap:8px">
    <div class="pill">
      <span>Base sin G/I ×Q</span>
      <span class="result mono" id="emp_qty_base">$ 0,00</span>
    </div>
    <div class="pill">
      <span>Subtotal ×Q</span>
      <span class="result mono" id="emp_qty_subtotal">$ 0,00</span>
    </div>
    <div class="pill">
      <span>Ganancia ×Q</span>
      <span class="result mono" id="emp_qty_g">$ 0,00</span>
    </div>
    <div class="pill">
      <span>Impuestos ×Q</span>
      <span class="result mono" id="emp_qty_i">$ 0,00</span>
    </div>
    <div class="pill">
      <span>Total ×Q</span>
      <span class="result mono" id="emp_qty_total">$ 0,00</span>
    </div>
  </div>
</div>
</div></section>
<section class="view" id="view-dtf">
<div class="grid">
<div class="card md-12">
<h3 style="margin:0 0 6px">Cálculo de costos — DTF (servicio externo)</h3>
<div class="sep"></div>
</div>
<div class="card md-6" style="background:#fff">
<h4 style="margin:0 0 10px">Costos directos del servicio</h4>
<div class="row" style="gap:8px;align-items:center;margin-top:6px">
<div style="flex:1;min-width:180px">
<label>Modalidad</label>
<select id="dtf_modalidad" title="Cómo te cobra el proveedor">
<option data-price="15" value="metro">Metro lineal (ancho 57 cm)</option>
<option data-price="7.5" value="tramo30">Tramo de 30 cm (ancho 57 cm)</option>
<option data-price="5" value="a3">Hoja A3</option>
</select>
</div>
<div style="flex:1;min-width:160px">
<label>Precio por unidad ($)</label>
<input id="dtf_precio_unit" min="0" step="0.01" type="number" value="15"/>
</div>
<div style="flex:1;min-width:160px">
<label><input checked="" id="dtf_resp_min" type="checkbox"/> Respetar mínimo de compra</label>
</div>
</div>
<div class="sep"></div>
<h4 style="margin:0 0 8px">Medida requerida</h4>
<div class="row" style="gap:8px;align-items:flex-end">
<div style="flex:1;min-width:160px">
<label>Largo requerido (cm)</label>
<input id="dtf_largo_cm" min="0" step="0.1" type="number" value="0"/>
</div>
<div style="flex:1;min-width:160px">
<label><input id="dtf_calc_por_diseno" type="checkbox"/> Calcular largo por diseños</label>
</div>
</div>
<div class="sep"></div>
<h4 style="margin:0 0 8px">Múltiples diseños</h4>
<div class="row" style="justify-content:space-between;align-items:center">
<button class="btn ok" id="dtf_add_diseno">Agregar diseño</button>
<div class="pill">Ancho útil fijo: 57 cm</div>
</div>
<div class="sep"></div>
<div class="grid" id="dtf_bloques"></div>
<div class="sep"></div>
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
<div style="min-width:140px">
<label>Separación (cm)</label>
<input id="dtf_sep" min="0" step="0.1" type="number" value="0.5"/>
</div>
<div style="min-width:180px">
<label>Tipo de panel</label>
<select id="dtf_panel_tipo">
<option data-price="15" value="metro">Metro 57×100 cm</option>
<option data-price="7.5" value="tramo30">Tramo 57×30 cm</option>
<option data-price="5" value="a3">Hoja A3 29.7×42 cm</option>
<option value="personalizado">Personalizado</option>
</select>
</div>
<div style="min-width:120px">
<label>Ancho panel (cm)</label>
<input id="dtf_panel_w" min="5" step="0.1" type="number" value="57"/>
</div>
<div style="min-width:120px">
<label>Alto panel (cm)</label>
<input id="dtf_panel_h" min="5" step="0.1" type="number" value="100"/>
</div>
<div style="min-width:160px">
<label><input id="dtf_autorot" type="checkbox"/> Auto-rotación 90°</label>
</div>
<button class="btn ok" id="dtf_preset_demo">Preset ejemplo</button>
<button class="btn neutral" id="dtf_preview_btn">Generar vista previa</button>
</div>
<div class="sep"></div>
<div class="card md-12" style="background:#fff">
<h4 style="margin:0 0 10px">Vista previa de distribución (57 cm × alto)</h4>
<canvas height="350" id="dtf_layout" style="max-width:100%;border-radius:12px;border:1px solid #eee" width="600"></canvas>
<div class="muted" id="dtf_layout_info" style="margin-top:6px"></div>
</div>
<div id="dtf_por_diseno" style="display:none;margin-top:8px">
<div class="row" style="gap:8px;align-items:flex-end;flex-wrap:wrap">
<div style="flex:1;min-width:130px">
<label>N° de diseños</label>
<input id="dtf_n" min="1" step="1" type="number" value="1"/>
</div>
<div style="flex:1;min-width:130px">
<label>Ancho diseño (cm)</label>
<input id="dtf_w" min="0" step="0.1" type="number" value="10"/>
</div>
<div style="flex:1;min-width:130px">
<label>Alto diseño (cm)</label>
<input id="dtf_h" min="0" step="0.1" type="number" value="10"/>
</div>
<div class="pill">Ancho útil: 57 cm</div>
</div>
<div class="muted" style="margin-top:6px">Colocación simple (sin rotación): columnas = ⌊57 / ancho⌋; filas = ⌈N / columnas⌉; largo = filas × alto.</div>
</div>
</div>
<div class="card md-6" style="background:#fff">
<h4 style="margin:0 0 10px">Costos directos — Prenda</h4>
<div class="row" style="gap:8px;align-items:center;margin-top:6px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input id="dtf_prenda_on" type="checkbox"/> Activar
            </label>
<select id="dtf_prenda_tipo" style="max-width:220px">
<option value="algodon">Camiseta de algodón</option>
<option value="poliester">Camiseta de poliéster</option>
</select>
</div>
<div style="min-width:120px">
<label>Cant. de Diseños</label>
<input id="dtf_prenda_disenos" type="text" value="1"/>
</div>
<div class="row" style="gap:14px;flex-wrap:wrap">
<div style="min-width:130px;flex:1">
<label>Cant. de prendas</label>
<input id="dtf_prenda_cant" min="0" step="1" type="number" value="0"/>
</div>
<div style="min-width:160px;flex:1">
<label>Precio paquete ($)</label>
<input id="dtf_prenda_precio" min="0" step="0.01" type="number" value="0"/>
</div>
<div style="min-width:200px;flex:1">
<label>Costo Ud. prenda</label>
<input id="dtf_prenda_costo_ud" readonly="" type="text" value="$ 0,00"/>
</div>
</div>
<div class="sep"></div>
<h4 style="margin:0 0 10px">Depreciación de equipos <span class="muted">(base 2 años)</span></h4>
<div class="row" style="gap:8px;align-items:center;margin:4px 0 6px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input id="dtf_dep_on" type="checkbox"/> <strong>Plancha térmica</strong>
</label>
</div>
<div class="row" style="gap:14px;flex-wrap:wrap">
<div style="min-width:160px;flex:1">
<label>Precio ($)</label>
<input id="dtf_dep_plancha_precio" type="text" value="400,00"/>
</div>
<div style="min-width:160px;flex:1">
<label>costo x Mes</label>
<input class="dep_mes" id="dtf_dep_plancha_mes" readonly="" type="text" value="$ 0,00"/>
</div>
<div style="min-width:160px;flex:1">
<label>Costo Ud.</label>
<input class="dep_ud" id="dtf_dep_plancha_ud" readonly="" type="text" value="$ 0,00"/>
</div>
</div>
<h4 style="margin:0 0 10px">Extras</h4>
<div class="row" style="gap:8px;align-items:center">
<div style="flex:1;min-width:160px">
<label>Envío del proveedor ($)</label>
<input id="dtf_extra_envio" min="0" step="0.01" type="number" value="0"/>
</div>
<div style="flex:1;min-width:160px">
<label>Diseño / retoques ($)</label>
<input id="dtf_extra_diseno" min="0" step="0.01" type="number" value="0"/>
</div>
<div style="flex:1;min-width:160px">
<label>Plancha térmica (costo por estampado) ($)</label>
<input id="dtf_extra_plancha" min="0" step="0.01" type="number" value="0"/>
</div>
</div>
<div class="row" style="gap:8px;align-items:center;margin-top:8px">
<div style="flex:1;min-width:160px">
<label>Otros ($)</label>
<input id="dtf_extra_otros" min="0" step="0.01" type="number" value="0"/>
</div>
</div>
</div>
<div class="card md-12 indA-card" id="dtf_ind_card"><h4>Costos indirectos</h4><div class="row" style="gap:10px;align-items:center;flex-wrap:wrap"><label style="display:flex;align-items:center;gap:8px;margin:0"><input id="dtf_ind_on" type="checkbox"/> Activar</label><div style="margin-left:auto"><button class="btn" id="dtf_ind_cfg_btn">Configurar</button></div><div class="pill indA-pill">Costo Ud. (indirectos): <span class="result" id="dtf_ind_ud">$ 0,00</span></div></div><div class="sep"></div><div id="dtf_ind_cfg" style="display:none"><div class="row" style="gap:14px;flex-wrap:wrap"><div style="min-width:160px;flex:1"><label>Alquiler (mensual)</label><input id="dtf_ind_alquiler" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Internet (mensual)</label><input id="dtf_ind_internet" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Suscripciones (mensual)</label><input id="dtf_ind_suscripciones" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Transporte (mensual)</label><input id="dtf_ind_transporte" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Electricidad (mensual)</label><input id="dtf_ind_electricidad" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Publicidad (mensual)</label><input id="dtf_ind_publicidad" type="text" value="0,00"/></div><div style="min-width:160px;flex:1"><label>Otros (mensual)</label><input id="dtf_ind_otros" type="text" value="0,00"/></div><div style="min-width:120px"><label>Unidades/mes</label><input class="indA-small" id="dtf_ind_units" min="1" step="1" type="number" value="100"/></div></div></div></div><div class="card md-12">

<!-- Totales / G&I / Mano de obra -->
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
<div class="pill">Unidades cobradas: <span class="result" id="dtf_unidades">0</span></div>
<div class="pill">Total directos: <span class="result" id="dtf_total_directos">$0.00</span></div>
<div class="pill">Prendas: <span class="result" id="dtf_total_prenda">$0.00</span></div>
<div class="pill">Depreciación plancha: <span class="result" id="dtf_total_dep">$0.00</span></div>
<div class="pill">Extras: <span class="result" id="dtf_total_extras">$0.00</span></div>
<div class="pill">Total sin G/I: <span class="result" id="dtf_subtotal_no_gi">$0.00</span></div>
</div>
<div class="sep"></div>
<div class="row" style="justify-content:space-between;align-items:center;gap:10px;margin-top:6px">
<label style="display:flex;align-items:center;gap:8px;margin:0">
<input id="dtf_mo_on" type="checkbox"/> Mano de obra
    </label>
<button class="copy-btn" id="dtf_mo_cfg_btn" type="button">Configurar</button>
</div>
<div class="row" id="dtf_mo_cfg" style="display:none;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-top:6px">
<div style="min-width:160px"><label>Sueldo mensual ($)</label><input id="dtf_mo_sueldo" type="text" value="400,00"/></div>
<div style="min-width:160px"><label>Horas al mes</label><input id="dtf_mo_horas_mes" type="text" value="176"/></div>
<div style="min-width:140px"><label>Setup (min)</label><input id="dtf_mo_setup" type="text" value="5,00"/></div>
<div style="min-width:180px"><label>Ejecución (min/ud)</label><input id="dtf_mo_run" type="text" value="2,00"/></div>
<div style="min-width:140px"><label>Unidades</label><input id="dtf_mo_units" type="text" value="1"/></div>
</div>
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px">
<div class="pill" id="dtf_mo_pill" style="display:none">+ Mano de obra: <span class="result" id="dtf_mo_val">$ 0,00</span></div>
</div>
<div class="sep"></div>
<div class="row">
<div style="flex:1;min-width:160px">
<label><input checked="" id="dtf_chk_ganancia" type="checkbox"/> Ganancia (%)</label>
<input id="dtf_ganancia" min="0" step="1" type="number" value="40"/>
</div>
<div style="flex:1;min-width:160px">
<label><input checked="" id="dtf_chk_impuestos" type="checkbox"/> Impuestos (%)</label>
<input id="dtf_impuestos" min="0" step="1" type="number" value="16"/>
</div>
</div>
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
<div class="pill">Subtotal: <span class="result" id="dtf_subtotal">$0.00</span></div>
<div class="pill">+ Ganancia: <span class="result" id="dtf_ganancia_val">$0.00</span></div>
<div class="pill">+ Impuestos: <span class="result" id="dtf_impuestos_val">$0.00</span></div>
</div>
<div class="sep"></div>
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
<div class="pill">Material a solicitar: <span class="result" id="dtf_mat_solicitar">—</span></div>
<div class="pill">Costo DTF por unidad: <span class="result" id="dtf_costo_ud_dtf">$0.00</span></div>
<div class="pill">Costo total por camiseta (estampada): <span class="result" id="dtf_costo_por_camiseta">$0.00</span></div>
</div>
<div class="sep"></div>
<div class="tot">Precio de Venta: <span class="result" id="dtf_total">$0.00</span></div>
<div class="center-actions">
<button class="copy-btn" id="btn_print_dtf">Exportar a PDF / Imprimir</button>
<button class="copy-btn" id="btn_copy_dtf">Copiar</button>
<button class="btn reset" id="btn_reset_dtf">Reset</button>
</div>
<div class="sep"></div>
</div>
</div>
</section>
<!-- ===== MODULE: PAPELERÍA | START ===== -->
<section class="view" id="view-papeleria">
<div class="grid">
<div class="card md-12">
<h3 style="margin:0 0 6px">Cálculo de costos — Papelería</h3>
<div class="sep"></div>
</div><div class="card md-6" style="background:#fff">
<h4>Costos directos</h4>
<!-- Sustrato A -->
<div class="row" style="gap:8px;align-items:center;">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input id="pap_d_sustrato1_on" type="checkbox"/> Sustrato A (cartulina/papel)
            </label>
<select id="pap_d_sustrato1_sel" style="min-width:220px">
<option>Cartulina opalina</option><option>Cartulina glitter</option><option>Cartulina kraft</option>
<option>Papel fotográfico</option><option>Papel adhesivo</option><option>Acetato</option><option>Otro</option>
</select>
</div>
<div class="row">
<div><label>Cant.</label><input id="pap_d_sustrato1_cant" type="number" value="50"/></div>
<div><label>Precio ($)</label><input id="pap_d_sustrato1_precio" type="text" value="20,00"/></div>
<div><label>Costo Ud.</label><input class="ud" id="pap_d_sustrato1_ud" readonly="" type="text"/></div>
<div><label>Cantidad a utilizar</label><input id="pap_d_sustrato1_use" type="number" value="1" min="0" step="0.01"/></div>
<div><label>Costo utilizado</label><input class="ud" id="pap_d_sustrato1_used" readonly="" type="text"/></div>
</div>
<!-- Sustrato B -->
<div class="row" style="gap:8px;align-items:center;margin-top:6px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input id="pap_d_sustrato2_on" type="checkbox"/> Sustrato B (cartulina/papel)
            </label>
<select id="pap_d_sustrato2_sel" style="min-width:220px">
<option>Cartulina opalina</option><option>Cartulina glitter</option><option>Cartulina kraft</option>
<option>Papel fotográfico</option><option>Papel adhesivo</option><option>Acetato</option><option>Otro</option>
</select>
</div>
<div class="row">
<div><label>Cant.</label><input id="pap_d_sustrato2_cant" type="number" value="0"/></div>
<div><label>Precio ($)</label><input id="pap_d_sustrato2_precio" type="text" value="0,00"/></div>
<div><label>Costo Ud.</label><input class="ud" id="pap_d_sustrato2_ud" readonly="" type="text"/></div>
<div><label>Cantidad a utilizar</label><input id="pap_d_sustrato2_use" type="number" value="1" min="0" step="0.01"/></div>
<div><label>Costo utilizado</label><input class="ud" id="pap_d_sustrato2_used" readonly="" type="text"/></div>
</div>
<!-- Adhesivo A -->
<div class="row" style="gap:8px;align-items:center;margin-top:6px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input id="pap_d_adh1_on" type="checkbox"/> Adhesivos/montaje A
            </label>
<select id="pap_d_adh1_sel" style="min-width:220px">
<option>Cinta doble faz</option><option>Foam 3D</option><option>Barras de silicón</option>
<option>Glue dots</option><option>Listón/cuerda</option><option>Otro</option>
</select>
</div>
<div class="row">
<div><label>Cant.</label><input id="pap_d_adh1_cant" type="number" value="1"/></div>
<div><label>Precio ($)</label><input id="pap_d_adh1_precio" type="text" value="3,00"/></div>
<div><label>Costo Ud.</label><input class="ud" id="pap_d_adh1_ud" readonly="" type="text"/></div>
<div><label>Cantidad a utilizar</label><input id="pap_d_adh1_use" type="number" value="1" min="0" step="0.01"/></div>
<div><label>Costo utilizado</label><input class="ud" id="pap_d_adh1_used" readonly="" type="text"/></div>
</div>
<!-- Adhesivo B -->
<div class="row" style="gap:8px;align-items:center;margin-top:6px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input id="pap_d_adh2_on" type="checkbox"/> Adhesivos/montaje B
            </label>
<select id="pap_d_adh2_sel" style="min-width:220px">
<option>Cinta doble faz</option><option>Foam 3D</option><option>Barras de silicón</option>
<option>Glue dots</option><option>Listón/cuerda</option><option>Otro</option>
</select>
</div>
<div class="row">
<div><label>Cant.</label><input id="pap_d_adh2_cant" type="number" value="0"/></div>
<div><label>Precio ($)</label><input id="pap_d_adh2_precio" type="text" value="0,00"/></div>
<div><label>Costo Ud.</label><input class="ud" id="pap_d_adh2_ud" readonly="" type="text"/></div>
<div><label>Cantidad a utilizar</label><input id="pap_d_adh2_use" type="number" value="1" min="0" step="0.01"/></div>
<div><label>Costo utilizado</label><input class="ud" id="pap_d_adh2_used" readonly="" type="text"/></div>
</div>
<!-- Extra shaker y Empaque -->
<div class="row" style="gap:8px;align-items:center;margin-top:6px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input id="pap_d_extra_on" type="checkbox"/> Extra (shaker/acetato/lentejuelas)
            </label>
</div>
<div class="row">
<div><label>Cant.</label><input id="pap_d_extra_cant" type="number" value="0"/></div>
<div><label>Precio ($)</label><input id="pap_d_extra_precio" type="text" value="0,00"/></div>
<div><label>Costo Ud.</label><input class="ud" id="pap_d_extra_ud" readonly="" type="text"/></div>
<div><label>Cantidad a utilizar</label><input id="pap_d_extra_use" type="number" value="1" min="0" step="0.01"/></div>
<div><label>Costo utilizado</label><input class="ud" id="pap_d_extra_used" readonly="" type="text"/></div>
</div>
<div class="row" style="gap:8px;align-items:center;margin-top:6px">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input id="pap_d_pack_on" type="checkbox"/> Empaque (bolsa/funda)
            </label>
</div>
<div class="row">
<div><label>Cant.</label><input id="pap_d_pack_cant" type="number" value="50"/></div>
<div><label>Precio ($)</label><input id="pap_d_pack_precio" type="text" value="5,00"/></div>
<div><label>Costo Ud.</label><input class="ud" id="pap_d_pack_ud" readonly="" type="text"/></div>
<div><label>Cantidad a utilizar</label><input id="pap_d_pack_use" type="number" value="1" min="0" step="0.01"/></div>
<div><label>Costo utilizado</label><input class="ud" id="pap_d_pack_used" readonly="" type="text"/></div>
</div>
</div><div class="card md-6" style="background:#fff">
<h4>Depreciación de equipos <span class="muted">(base 2 años)</span></h4>
<div class="row"><label class="chk-label"><input id="pap_e_plotter_on" type="checkbox"/> Plotter de corte</label></div>
<div class="row"><div><label>Precio ($)</label><input id="pap_e_plotter_precio" type="text" value="400"/></div><div><label>costo x Mes</label><input class="ud" id="pap_e_plotter_mes" readonly="" type="text"/></div><div><label>Costo Ud.</label><input class="ud" id="pap_e_plotter_ud" readonly="" type="text"/></div>
<div><label>Cant. de usos</label><input id="pap_e_plotter_usos" type="number" value="1" min="0" step="1"/></div>
<div><label>Costo utilizado</label><input class="ud" id="pap_e_plotter_used" readonly="" type="text"/></div></div>
<div class="row"><label class="chk-label"><input id="pap_e_imp_on" type="checkbox"/> Impresora</label></div>
<div class="row"><div><label>Precio ($)</label><input id="pap_e_imp_precio" type="text" value="240"/></div><div><label>costo x Mes</label><input class="ud" id="pap_e_imp_mes" readonly="" type="text"/></div><div><label>Costo Ud.</label><input class="ud" id="pap_e_imp_ud" readonly="" type="text"/></div>
<div><label>Cant. de usos</label><input id="pap_e_imp_usos" type="number" value="1" min="0" step="1"/></div>
<div><label>Costo utilizado</label><input class="ud" id="pap_e_imp_used" readonly="" type="text"/></div></div>
<div class="row"><label class="chk-label"><input id="pap_e_guillotina_on" type="checkbox"/> Guillotina</label></div>
<div class="row"><div><label>Precio ($)</label><input id="pap_e_guillotina_precio" type="text" value="120"/></div><div><label>costo x Mes</label><input class="ud" id="pap_e_guillotina_mes" readonly="" type="text"/></div><div><label>Costo Ud.</label><input class="ud" id="pap_e_guillotina_ud" readonly="" type="text"/></div>
<div><label>Cant. de usos</label><input id="pap_e_guillotina_usos" type="number" value="1" min="0" step="1"/></div>
<div><label>Costo utilizado</label><input class="ud" id="pap_e_guillotina_used" readonly="" type="text"/></div></div>
<div class="row"><label class="chk-label"><input id="pap_e_laminadora_on" type="checkbox"/> Laminadora</label></div>
<div class="row"><div><label>Precio ($)</label><input id="pap_e_laminadora_precio" type="text" value="150"/></div><div><label>costo x Mes</label><input class="ud" id="pap_e_laminadora_mes" readonly="" type="text"/></div><div><label>Costo Ud.</label><input class="ud" id="pap_e_laminadora_ud" readonly="" type="text"/></div>
<div><label>Cant. de usos</label><input id="pap_e_laminadora_usos" type="number" value="1" min="0" step="1"/></div>
<div><label>Costo utilizado</label><input class="ud" id="pap_e_laminadora_used" readonly="" type="text"/></div></div>
<div class="row"><label class="chk-label"><input id="pap_e_pc_on" type="checkbox"/> Computadora</label></div>
<div class="row"><div><label>Precio ($)</label><input id="pap_e_pc_precio" type="text" value="350"/></div><div><label>costo x Mes</label><input class="ud" id="pap_e_pc_mes" readonly="" type="text"/></div><div><label>Costo Ud.</label><input class="ud" id="pap_e_pc_ud" readonly="" type="text"/></div>
<div><label>Cant. de usos</label><input id="pap_e_pc_usos" type="number" value="1" min="0" step="1"/></div>
<div><label>Costo utilizado</label><input class="ud" id="pap_e_pc_used" readonly="" type="text"/></div></div>
<div class="row"><label class="chk-label"><input id="pap_e_cuchilla_on" type="checkbox"/> Cuchilla (vida en cortes)</label></div>
<div class="row"><div><label>Precio ($)</label><input id="pap_e_cuchilla_precio" type="text" value="30"/></div><div><label>Vida útil (cortes)</label><input id="pap_e_cuchilla_vida" type="number" value="500"/></div><div><label>Costo Ud.</label><input class="ud" id="pap_e_cuchilla_ud" readonly="" type="text"/></div>
<div><label>Cant. de usos</label><input id="pap_e_cuchilla_usos" type="number" value="1" min="0" step="1"/></div>
<div><label>Costo utilizado</label><input class="ud" id="pap_e_cuchilla_used" readonly="" type="text"/></div></div>
<div class="row"><label class="chk-label"><input id="pap_e_tapete_on" type="checkbox"/> Tapete (vida en usos)</label></div>
<div class="row"><div><label>Precio ($)</label><input id="pap_e_tapete_precio" type="text" value="12"/></div><div><label>Vida útil (usos)</label><input id="pap_e_tapete_vida" type="number" value="100"/></div><div><label>Costo Ud.</label><input class="ud" id="pap_e_tapete_ud" readonly="" type="text"/></div>
<div><label>Cant. de usos</label><input id="pap_e_tapete_usos" type="number" value="1" min="0" step="1"/></div>
<div><label>Costo utilizado</label><input class="ud" id="pap_e_tapete_used" readonly="" type="text"/></div></div>
</div><div class="card md-12 indA-card" id="pap_ind_card">
<h4>Costos indirectos</h4>
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
<label><input id="pap_ind_on" type="checkbox"/> Activar</label>
<div class="pill indA-pill">Costo Ud. (indirectos): <span class="result" id="pap_ind_ud">$ 0,00</span></div>
<div style="margin-left:auto"><button class="btn" id="pap_ind_cfg_btn" type="button">Configurar</button></div>
</div>
<div class="sep"></div>
<div id="pap_ind_cfg" style="display:none">
<div class="row" style="gap:14px;flex-wrap:wrap">
<div><label>Alquiler (mensual)</label><input id="pap_ind_alquiler" type="text" value="0,00"/></div>
<div><label>Internet (mensual)</label><input id="pap_ind_internet" type="text" value="0,00"/></div>
<div><label>Suscripciones (mensual)</label><input id="pap_ind_suscripciones" type="text" value="0,00"/></div>
<div><label>Transporte (mensual)</label><input id="pap_ind_transporte" type="text" value="0,00"/></div>
<div><label>Electricidad (mensual)</label><input id="pap_ind_electricidad" type="text" value="0,00"/></div>
<div><label>Publicidad (mensual)</label><input id="pap_ind_publicidad" type="text" value="0,00"/></div>
<div><label>Otros (mensual)</label><input id="pap_ind_otros" type="text" value="0,00"/></div>
<div><label>Unidades/mes</label><input id="pap_ind_units" type="number" value="100"/></div>
</div>
</div>
</div>
<div class="card md-12" id="pap_tot_card">
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
<div class="pill">Total directos: <span class="result" id="pap_total_directos">$0.00</span></div>
<div class="pill">Total depreciación: <span class="result" id="pap_total_depr">$0.00</span></div>
<div class="pill">Total sin G/I: <span class="result" id="pap_subtotal_no_gi">$0.00</span></div>
</div>
<div class="sep"></div>
<div class="row" style="justify-content:space-between;align-items:center;gap:10px;margin-top:6px">
<label style="display:flex;align-items:center;gap:8px;margin:0"><input id="pap_mo_on" type="checkbox"/> Mano de obra</label>
<button class="copy-btn" id="pap_mo_cfg_btn" type="button">Configurar</button>
</div>
<div class="row" id="pap_mo_cfg" style="display:none;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-top:6px">
<div><label>Sueldo mensual ($)</label><input id="pap_mo_sueldo" type="text" value="400,00"/></div>
<div><label>Horas al mes</label><input id="pap_mo_horas_mes" type="text" value="176"/></div>
<div><label>Setup (min)</label><input id="pap_mo_setup" type="text" value="5,00"/></div>
<div><label>Ejecución (min/ud)</label><input id="pap_mo_run" type="text" value="3,00"/></div>
<div><label>Unidades</label><input id="pap_mo_units" type="text" value="1"/></div>
</div>
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px">
<div class="pill" id="pap_mo_pill" style="display:none">+ Mano de obra: <span class="result" id="pap_mo_val">$ 0,00</span></div>
</div>
<div class="sep"></div>
<div class="row" id="pap_gi_row" style="gap:10px;align-items:flex-start;flex-wrap:wrap">
<div class="gi-col" style="flex:1;min-width:220px;display:flex;flex-direction:column">
<label style="display:flex;align-items:center;gap:8px;margin:0 0 4px">
<input id="pap_chk_ganancia" type="checkbox"/> Ganancia (%)
    </label>
<input id="pap_ganancia" min="0" step="1" type="number" value="40"/>
</div>
<div class="gi-col" style="flex:1;min-width:220px;display:flex;flex-direction:column">
<label style="display:flex;align-items:center;gap:8px;margin:0 0 4px">
<input id="pap_chk_impuestos" type="checkbox"/> Impuestos (%)
    </label>
<input id="pap_impuestos" min="0" step="1" type="number" value="16"/>
</div>
</div>
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
<div class="pill">Subtotal: <span class="result" id="pap_subtotal">$0.00</span></div>
<div class="pill">+ Ganancia: <span class="result" id="pap_ganancia_val">$0.00</span></div>
<div class="pill">+ Impuestos: <span class="result" id="pap_impuestos_val">$0.00</span></div>
</div>
<div class="sep"></div>
<div class="tot">Precio de Venta: <span class="result" id="pap_total">$0.00</span></div>
<div class="center-actions">
<button class="copy-btn" id="pap_btn_print">Exportar a PDF / Imprimir</button>
<button class="copy-btn" id="pap_btn_copy">Copiar</button>
<button class="btn reset" id="pap_btn_reset">Reset</button>
</div>
</div>
<!-- Cantidad de productos (Papelería) – bloque no intrusivo -->
<div class="card md-12" id="pap_qty_card">
  <div class="row" style="align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
    <div class="row" style="align-items:center;gap:8px;flex-wrap:wrap">
      <label class="chk-label" style="display:flex;align-items:center;gap:6px;margin:0">
        <input type="checkbox" id="pap_qty_on"/>
        <span>Cantidad de productos</span>
      </label>
      <input type="number" id="pap_qty" min="1" step="1" value="1" style="max-width:100px"/>
      <span class="muted">Multiplica los totales por Q (solo vista, no cambia los cálculos base).</span>
    </div>
  </div>
  <div class="sep"></div>
  <div class="row" style="flex-wrap:wrap;gap:8px">
    <div class="pill"><span>Base sin G/I ×Q</span><span class="result mono" id="pap_qty_base">$ 0,00</span></div>
    <div class="pill"><span>Subtotal ×Q</span><span class="result mono" id="pap_qty_subtotal">$ 0,00</span></div>
    <div class="pill"><span>Ganancia ×Q</span><span class="result mono" id="pap_qty_g">$ 0,00</span></div>
    <div class="pill"><span>Impuestos ×Q</span><span class="result mono" id="pap_qty_i">$ 0,00</span></div>
    <div class="pill"><span>Total ×Q</span><span class="result mono" id="pap_qty_total">$ 0,00</span></div>
  </div>
</div>

</div>
</section>
<section class="view" id="view-envios">
<div class="grid">
<div class="card md-12">
<h3 style="margin:0 0 6px">Costos de Envíos</h3>
<div class="sep"></div>
</div>
<div class="card md-6" style="background:#fff">
<h4 style="margin:0 0 10px">Mensajería / Flete <span (kg).\"="" (km)="" base="" del="" distancia="" fija,="" peso="" tarifa="" title='\"Costos' traslado:="" y="">ℹ️</span></h4>
<div class="row" style="gap:8px;align-items:center">
<label class="chk-label" style="display:flex;align-items:center;gap:8px">
<input id="env_mensajeria_on" type="checkbox"/> Activar mensajería
            </label>
</div>
<div class="row">
<div style="flex:1;min-width:120px"><label>Tipo</label>
<select id="env_tipo">
<option>Motorizado local</option>
<option>Mensajería urbana</option>
<option>Encomienda nacional</option>
<option>Internacional</option>
<option>Otro</option>
</select>
</div>
<div style="flex:1;min-width:120px"><label>Distancia (km)</label><input id="env_km" min="0" step="0.1" type="number" value="0"/></div>
<div style="flex:1;min-width:120px"><label>Tarifa base</label><input id="env_base" min="0" step="0.01" type="number" value="0"/></div>
</div>
<div class="row" style="margin-top:8px">
<div style="flex:1;min-width:120px"><label cada="" kilómetro="" por="" recorrido.\"="" title='\"Monto'>Tarifa por km</label><input id="env_tarifa_km" min="0" step="0.01" type="number" value="0"/></div>
<div style="flex:1;min-width:120px"><label>Peso (kg)</label><input id="env_kg" min="0" step="0.1" type="number" value="0"/></div>
<div style="flex:1;min-width:120px"><label>Tarifa por kg</label><input id="env_tarifa_kg" min="0" step="0.01" type="number" value="0"/></div>
</div>
</div>
<div class="card md-6" style="background:#fff">
<h4 style="margin:0 0 10px">Extras</h4>
<div class="row" style="gap:8px;align-items:center">
<label class="chk-label" style="display:flex;align-items:center;gap:8px"><input id="env_embalaje_on" type="checkbox"/> Embalaje extra</label>
<label class="chk-label" style="display:flex;align-items:center;gap:8px"><input id="env_fragil_on" type="checkbox"/> Manejo frágil</label>
<label class="chk-label" style="display:flex;align-items:center;gap:8px"><input id="env_seguro_on" type="checkbox"/> Seguro (%)</label>
</div>
<div class="row">
<div style="flex:1;min-width:120px"><label>Costo embalaje</label><input id="env_embalaje" min="0" step="0.01" type="number" value="0"/></div>
<div style="flex:1;min-width:120px"><label>Costo frágil</label><input id="env_fragil" min="0" step="0.01" type="number" value="0"/></div>
<div style="flex:1;min-width:120px"><label (mensajería="" +="" calculado="" extras="" seleccionados).\"="" sobre="" title='\"Porcentaje'>% Seguro</label><input id="env_seguro_pct" min="0" step="0.1" type="number" value="0"/></div>
</div>
<div class="row" style="margin-top:8px">
<div style="flex:1;min-width:120px"><label>Otros (monto)</label><input id="env_otros" min="0" step="0.01" type="number" value="0"/></div>
</div>
</div>
<div class="card md-12">
<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
<div class="pill">Total mensajería: <span class="result" id="env_total_mensajeria">$0.00</span></div>
<div class="pill">Extras: <span class="result" id="env_total_extras">$0.00</span></div>
</div>
<div class="sep"></div>
<div class="tot">Total Envíos: <span class="result" id="env_total">$0.00</span></div>
<div class="center-actions">
<button class="copy-btn" id="btn_copy_env">Copiar</button>
<button class="copy-btn" id="btn_print_env">Exportar a PDF / Imprimir</button>
<button class="btn reset" id="btn_reset_env">Reset</button>
</div>
</div></div></section>
<section cla<section="" class="view" id="view-resumen">
<div class="grid">
<div class="card md-12">
<h3 style="margin:0 0 6px">Resumen General</h3>
<div class="sep"></div>
<div class="row" style="gap:12px;flex-wrap:wrap;align-items:center">
<label class="chk-label"><input checked="" id="sum_incluir_vinil" type="checkbox"/> Incluir Vinil</label>
<label class="chk-label"><input checked="" id="sum_incluir_sublim" type="checkbox"/> Incluir Sublimación</label>
<label class="chk-label"><input checked="" id="sum_incluir_etiq" type="checkbox"/> Incluir Etiquetas</label>
<label class="chk-label"><input checked="" id="sum_incluir_emp" type="checkbox"/> Incluir Empaques</label>
<label class="chk-label"><input checked="" id="sum_incluir_pap" type="checkbox"/> Incluir Papelería</label>
<label class="chk-label"><input id="sum_incluir_env" type="checkbox"/> Incluir Envíos</label>
<label class="chk-label"><input id="sum_incluir_dtf" type="checkbox"/> Incluir DTF</label>
<label class="chk-label"><input checked="" id="sum_incluir_esf" type="checkbox"/> Incluir Esferas navideñas</label>
<label class="chk-label"><input checked="" id="sum_incluir_pers" type="checkbox"/> Incluir Producto personalizable</label>
</div>
<div class="sep"></div>
<div class="grid">
<div class="card md-3"><h4 style="margin:0 0 6px">Vinil</h4><div class="pill">Total: <span id="sum_vinil">$ 0,00</span></div></div>
<div class="card md-3"><h4 style="margin:0 0 6px">DTF</h4><div class="pill">Total: <span id="sum_dtf">$ 0,00</span></div></div>
<div class="sep"></div>
<div class="card md-12"><h4 style="margin:0 0 6px">Envíos</h4><div class="pill">Total: <span id="sum_env">$ 0,00</span></div></div>
<div class="card md-3"><h4 style="margin:0 0 6px">Sublimación</h4><div class="pill">Total: <span id="sum_sublim">$ 0,00</span></div></div>
<div class="card md-3"><h4 style="margin:0 0 6px">Etiquetas</h4><div class="pill">Total: <span id="sum_etiq">$ 0,00</span></div></div>
<div class="card md-3"><h4 style="margin:0 0 6px">Empaques</h4><div class="pill">Total: <span id="sum_emp">$ 0,00</span></div></div>
<div class="card md-3"><h4 style="margin:0 0 6px">Papelería</h4><div class="pill">Total: <span id="sum_pap">$ 0,00</span></div></div>
<div class="card md-3"><h4 style="margin:0 0 6px">Esferas navideñas</h4><div class="pill">Total: <span id="sum_esf">$ 0,00</span></div></div>
<div class="card md-3"><h4 style="margin:0 0 6px">Producto personalizable</h4><div class="pill">Total: <span id="sum_pers">$ 0,00</span></div></div>
</div>
<div class="sep"></div>
<div class="tot">Total General Seleccionado: <span class="result" id="sum_total">$ 0,00</span></div>
<div class="sep"></div>
<div class="center-actions">
<button class="copy-btn" id="btn_copy_sum">Copiar</button>
<button class="copy-btn" id="btn_print_sum">Exportar a PDF / Imprimir</button>
</div>
</div>
</div>
</section>
<script>
// === RESUMEN GENERAL (rebuild v2) ===
(function(){
  const $ = (id)=>document.getElementById(id);
  const text = (id)=>$(id)?.textContent || '';
  // EU-aware parser: "$ 1.234,56" -> 1234.56, "$ 10.50" -> 10.5
  function parseEUtxt(t){
    const s = String(t||'').replace(/[^0-9.,-]/g,'');
    if(s.includes(',')){
      return parseFloat(s.replace(/\./g,'').replace(',', '.')) || 0;
    }
    return parseFloat(s) || 0;
  }
  function fmtUSD(n){ return '$ ' + (Intl.NumberFormat('de-DE', {minimumFractionDigits:2, maximumFractionDigits:2}).format(isFinite(n)?n:0)); }

  // Sources (módulos)
  const SRC = {
    vinil:  'vin_total',
    sublim: 'sub_v15_total',
    etiq:   'eti_total',
    emp:    'emp_total',
    env:    'env_total',
    dtf:    'dtf_total',
    pap:    'pap_total',
    esf:    'esf_total',
    pers:   'pers_pv',
  };

  function mirrorText(){
    // Copia EXACTA del texto de cada módulo
    $('sum_vinil').textContent  = text(SRC.vinil);
    $('sum_sublim').textContent = text(SRC.sublim);
    $('sum_etiq').textContent   = text(SRC.etiq);
    $('sum_emp').textContent    = text(SRC.emp);
    $('sum_env').textContent    = text(SRC.env);
    $('sum_dtf').textContent    = text(SRC.dtf);
    $('sum_pap').textContent    = text(SRC.pap);
    $('sum_esf').textContent    = text(SRC.esf);
    $('sum_pers').textContent   = text(SRC.pers);
  }

  function compute(){
    // Lee texto EU y suma según checkboxes
    const incV  = $('sum_incluir_vinil').checked;
    const incS  = $('sum_incluir_sublim').checked;
    const incE  = $('sum_incluir_etiq').checked;
    const incM  = $('sum_incluir_emp').checked;
    const incN  = $('sum_incluir_env').checked;
    const incD  = $('sum_incluir_dtf').checked;
    const incP  = $('sum_incluir_pap').checked;
    const incEs = $('sum_incluir_esf').checked;
    const incPr = $('sum_incluir_pers').checked;

    const v   = parseEUtxt(text(SRC.vinil));
    const s   = parseEUtxt(text(SRC.sublim));
    const e   = parseEUtxt(text(SRC.etiq));
    const m   = parseEUtxt(text(SRC.emp));
    const n   = parseEUtxt(text(SRC.env));
    const d   = parseEUtxt(text(SRC.dtf));
    const p   = parseEUtxt(text(SRC.pap));
    const esf = parseEUtxt(text(SRC.esf));
    const pr  = parseEUtxt(text(SRC.pers));

    const total = (incV?v:0) + (incS?s:0) + (incE?e:0) + (incM?m:0) + (incN?n:0) + (incD?d:0) + (incP?p:0) + (incEs?esf:0) + (incPr?pr:0);
    $('sum_total').textContent = fmtUSD(total);
  }

  function update(){ mirrorText(); compute(); }

  // Observers: cuando cambian los totales de los módulos -> refrescar Resumen
  Object.values(SRC).forEach((id)=>{
    const el = $(id);
    if(!el) return;
    const obs = new MutationObserver(update);
    obs.observe(el, {childList:true, characterData:true, subtree:true});
  });

  // Checkboxes
    ['sum_incluir_vinil','sum_incluir_sublim','sum_incluir_etiq','sum_incluir_emp','sum_incluir_env','sum_incluir_dtf','sum_incluir_pap','sum_incluir_esf','sum_incluir_pers']
    .forEach(id=>$(id)?.addEventListener('change', update));

  // Acciones
  $('btn_copy_sum')?.addEventListener('click', ()=>{
    const lines=[
      'Resumen General',
      'Vinil = '+$('sum_vinil').textContent + ($('sum_incluir_vinil').checked?'':' (omitido)'),
      'Sublimación = '+$('sum_sublim').textContent + ($('sum_incluir_sublim').checked?'':' (omitida)'),
      'Etiquetas = '+$('sum_etiq').textContent + ($('sum_incluir_etiq').checked?'':' (omitidas)'),
      'Empaques = '+$('sum_emp').textContent + ($('sum_incluir_emp').checked?'':' (omitidos)'),
      'Envíos = '+$('sum_env').textContent + ($('sum_incluir_env').checked?'':' (omitidos)'),
      'DTF = '+$('sum_dtf').textContent + ($('sum_incluir_dtf').checked?'':' (omitido)'),
      'Papelería = '+$('sum_pap').textContent + ($('sum_incluir_pap').checked?'':' (omitida)'),
      'Esferas navideñas = '+$('sum_esf').textContent + ($('sum_incluir_esf').checked?'':' (omitidas)'),
      'Producto personalizable = '+$('sum_pers').textContent + ($('sum_incluir_pers').checked?'':' (omitido)'),
      'Total General = '+$('sum_total').textContent,
    ];

    navigator.clipboard?.writeText(lines.join('\n'));
  });
  $('btn_print_sum')?.addEventListener('click',()=>window.print());

  // Primera carga
  update();
})();
</script>
<section class="view active" id="view-instrucciones"><div class="grid">
<div class="card md-12">
<h3 style="margin:0 0 6px">Instrucciones / Configuración — Guía rápida para toda la Suite</h3>

<div class="sep"></div>
<h4>¿Qué es esta Suite?</h4>
<p>Es un conjunto de calculadoras para estimar costos y precios de venta por tipo de trabajo
      (Vinil, Sublimación, DTF, Papelería, Etiquetas, Empaques y Envíos). Puedes usar un solo módulo
      o varios a la vez y luego ver el total combinado en <b>Resumen General</b>. Todos los importes
      se ingresan en <b>formato europeo</b> (coma decimal), por ejemplo: <code>20,00</code>.</p>

<div class="sep"></div>
<h4>Actualizaciones (PWA)</h4>
<p style="margin:6px 0 0">Si tienes la Suite instalada como app (PWA), puedes buscar y aplicar actualizaciones desde aquí.</p>

<div class="row" style="margin-top:10px;gap:8px;align-items:center">
  <button class="btn neutral" id="btn_pwa_check_updates" type="button">Buscar actualizaciones</button>
  <button class="btn ok" id="btn_pwa_apply_update" type="button" style="display:none">Actualizar ahora</button>
  <span class="muted" id="pwa_update_status" style="margin-left:6px">—</span>
</div>



<div class="sep"></div>
<h4>Cómo funciona en general</h4>
<ul style="margin:6px 0 0 18px">
<li>En cada módulo verás <b>filas con checkbox</b>. Al activarlas, esa fila entra en el cálculo.</li>
<li>Cada fila activa calcula <b>Costo Ud.</b> = Precio ÷ Cantidad (ayuda a prorratear packs).</li>
<li>Usa <b>Reset</b> del módulo para volver a los valores iniciales (apaga todas las casillas).</li>
<li>El <b>Modo ganancia</b> permite elegir entre <b>Markup</b> o <b>Margen</b> (explicación abajo).</li>
<li>Si necesitas, activa <b>Mano de obra</b> y/o <b>Costos indirectos</b> (más abajo se explica).</li>
<li>En varios módulos verás el card <b>Cantidad de productos</b>: ajusta los precios cuando produces más de 1 unidad.</li>
</ul>

<div class="sep"></div>
<h4>Formato de números (muy importante)</h4>
<ul style="margin:6px 0 0 18px">
<li>Siempre usa <b>coma decimal</b>: escribe <code>10,50</code> en lugar de <code>10.50</code>.</li>
<li>No uses separadores de miles: en vez de <code>1.500,00</code> coloca <code>1500,00</code>.</li>
<li>Si colocas punto en vez de coma, el sistema puede interpretar mal el valor o dejarlo en 0.</li>
</ul>

<div class="sep"></div>
<h4>Explicación por módulo</h4>

<h5>1) Vinil</h5>
<p>Calcula el costo para trabajos en vinil. Define el ancho efectivo (merma/bordes), agrega colores,
      y usa <b>Costos directos</b> (por ejemplo camisetas), <b>Depreciación de equipos</b> (plancha, plotter, PC, etc.).
      Luego aplica Ganancia/Impuestos y, si deseas, <b>Mano de obra</b>. El bloque “Resumen de Vinil” te muestra
      directos, depreciación, adicionales y el total del módulo. El card de <b>Cantidad de productos</b> te permite ver
      cuánto cambia el precio cuando haces varias piezas.</p>


<h5>2) Sublimación</h5>
<p>Pensado para tazas, termos, camisetas y otros productos de sublimación. Activa los insumos que uses
      (papel, tinta, cinta, empaque, funda retráctil, etc.) y la <b>Depreciación</b> (impresora, plancha, PC, prensa, resistencias, horno).
      Al final aplica Ganancia/Impuestos y, si corresponde, <b>Mano de obra</b>. Cuenta con botón para imprimir o copiar el desglose
      y también con card de <b>Cantidad de productos</b> para tandas.</p>


<h5>3) Esferas navideñas</h5>
<p>Diseñado para calcular el costo de tus esferas navideñas personalizadas. Activa los insumos que uses
      (esfera, relleno, lazos, vinil o impresión, empaque, etc.), suma si corresponde <b>Depreciación</b> y <b>Mano de obra</b>,
      y usa el card de <b>Cantidad de productos</b> para ver cómo cambia el costo por unidad cuando haces tandas para la temporada.</p>

<h5>4) DTF (terceros)</h5>
<p>Para cuando compras DTF a terceros: registra las cantidades/precios y deja que el módulo calcule el costo por unidad.
      Puedes sumar <b>Costos indirectos</b> (si aplica) y luego <b>Ganancia/Impuestos</b>. Útil para integrar con otros módulos
      cuando el DTF es solo una parte del producto final.</p>


<h5>5) Papelería (nuevo)</h5>
<p>Enfocado en cajitas, toppers, tarjetas, shakers, etc. Incluye <b>Sustrato A/B</b> y <b>Adhesivo A/B</b> (listas desplegables para usar dos tipos si necesitas),
      además de <b>Extras</b> (shaker/acetato/lentejuelas) y <b>Empaque</b>. En <b>Depreciación</b> contempla plotter, impresora, guillotina, <b>laminadora</b>, PC
      y por vida útil cuchilla/tapete. Puedes añadir <b>Costos indirectos</b> y <b>Mano de obra</b> con el botón <b>Configurar</b>.
      El card de <b>Cantidad de productos</b> te ayuda a ver el costo real por unidad cuando haces tandas grandes.</p>


<h5>6) Etiquetas</h5>
<p>Para etiquetas adhesivas (vinil imprimible, PVC, BOPP, holográfico, transparente, kraft, etc.). Activa insumos (tinta, laminado en frío, etc.),
      configura <b>Depreciación</b> (cuchilla/plotter/impresora) y usa <b>Costos indirectos</b> y <b>Mano de obra</b> si te aplican. Al final aplica Ganancia/Impuestos
      para obtener el precio de venta. También incluye card de <b>Cantidad de productos</b> para calcular tirajes.</p>


<h5>7) Empaques</h5>
<p>Para costos de cajas, bolsas, rellenos u otros materiales de empaque. Igual que los demás: activa lo que uses, prorratea cantidades,
      añade, si corresponde, <b>Costos indirectos</b> y luego Ganancia/Impuestos. Usa el card de <b>Cantidad de productos</b> para lotes de empaques.</p>


<h5>8) Envíos</h5>
<p>Registra costos de envío (tarifas, extras, seguro, otros) y prorratéalo si es por lote. Este módulo no calcula impresión,
      solo logística. El resultado puede sumarse en el <b>Resumen General</b> junto a otros módulos.</p>


<h5>9) Resumen General</h5>
<p>Refleja el total de cada módulo (espejo del <code>..._total</code> de cada uno). Puedes <b>incluir/omitir</b> módulos con sus toggles.
      El <b>Total General</b> suma solo los activados. Ideal para cotizaciones con múltiples técnicas (ej., Empaques + Papelería + DTF).</p>


<h5>10) Conversor de Unidades</h5>
<p>Herramientas rápidas para convertir longitudes, áreas, pesos, temperaturas y para pasar de píxeles a tamaño físico (y viceversa) usando DPI.
      Útil para verificar que tus artes tengan el tamaño y resolución adecuados.</p>


<h5>11) Calculadora Básica</h5>
<p>Una calculadora simple integrada para operaciones rápidas (con soporte de teclado). No afecta los cálculos de los módulos.</p>


<h5>12) Producto personalizable</h5>
<p>Úsalo para cotizar cualquier producto/servicio que no encaje al 100% en los otros módulos (combos, packs, pedidos especiales, etc.).</p>
<ul style="margin:6px 0 0 18px">
  <li><b>Ficha</b>: nombre, versión y notas.</li>
  <li><b>Estructura</b>: arma el costo con <b>Costos directos</b>, <b>Depreciación</b>, <b>Indirectos</b>, <b>Mano de obra</b> y <b>Ganancia/Impuestos</b> (igual que en la Suite).</li>
  <li><b>Material por área (cm²)</b>: activa el checkbox. Usa <b>Configurar</b> para desplegar. Elige modo (<b>Precio por cm²</b> o <b>Precio por rollo</b>), coloca ancho/alto a usar, cantidad y merma. El total se suma a los <b>Costos directos</b> y a los totales del módulo.</li>
  <li><b>Guardar / Cargar</b>: conserva tus productos para reutilizarlos.</li>
  <li><b>Exportar / Importar</b>: respalda listas en JSON o CSV.</li>
</ul>

<div class="sep"></div>
<h4>Elementos comunes y fórmulas</h4>
<ul style="margin:6px 0 0 18px">
<li><b>Depreciación</b>: reparte el costo de equipos a lo largo del tiempo o vida útil.</li>
<li><b>Costos indirectos</b>: gastos mensuales (alquiler, internet, electricidad, etc.) prorrateados por <b>unidades/mes</b>.</li>
<li><b>Mano de obra</b> (Configurar): <code>MO = (Sueldo mensual ÷ Horas/mes) × ((Setup + (Ejecución × Unidades)) ÷ 60)</code>.</li>
<b>Ejemplo</b>: Para sublimar una taza.
<b>Setup (min)</b> El tiempo que vas a necesitar para la previa elaboración de la taza (diseño, corte del papel).
<b>Run (min) o ejecucíon</b>  cuanto tiempo tarda en sublimarse esa taza.
<b>Unidades</b> ( normalmente vas a colocar una sola unidad)</li>
<li><b>Ganancia</b>:
  <ul style="margin:6px 0 0 16px">
    <li><b>Markup</b>: <code>Precio = Subtotal × (1 + g%)</code></li>
    <li><b>Margen</b>: <code>Precio = Subtotal ÷ (1 − g%)</code></li>
  </ul>
</li>
<li><b>Impuestos (%)</b>: se calculan sobre la base imponible (subtotal + ganancia) y se suman al final.</li>
</ul>

<div class="sep"></div>
<h4>Ejemplo rápido: Markup vs Margen</h4>
<ul style="margin:6px 0 0 18px">
<li>Si tu costo es <b>10,00</b> y quieres <b>50% de Markup</b> → Precio = 10,00 × (1 + 0,50) = <b>15,00</b>.</li>
<li>Si tu costo es <b>10,00</b> y quieres <b>50% de Margen</b> → Precio = 10,00 ÷ (1 − 0,50) = <b>20,00</b>.</li>
<li>Conclusión: con el mismo porcentaje, el <b>Margen</b> siempre da un precio más alto que el <b>Markup</b>.</li>
</ul>

<div class="sep"></div>
<h4>Cantidad de productos (cómo leer ese card)</h4>
<ul style="margin:6px 0 0 18px">
<li>Te permite ver el precio por unidad y por lote cuando produces varias piezas.</li>
<li>Si colocas, por ejemplo, 1 / 10 / 50 unidades, verás cómo mejora el costo unitario al subir la cantidad.</li>
<li>Úsalo para decidir descuentos por volumen sin perder tu margen real.</li>
</ul>

<div class="sep"></div>
<h4>Preguntas frecuentes (FAQ rápidas)</h4>
<ul style="margin:6px 0 0 18px">
<li><b>1. ¿Qué sueldo coloco si trabajo yo solo?</b><br/>Puedes tomar un sueldo “objetivo” (lo que quieres ganar al mes) y usarlo en Mano de obra como referencia.</li>
<li><b>2. ¿Qué hago si el precio me sale muy alto?</b><br/>Revisa si activaste insumos que no usas, si la cantidad es muy baja o si estás usando Margen con un porcentaje muy alto.</li>
<li><b>3. ¿Qué uso: Markup o Margen?</b><br/>Markup es más sencillo de entender; Margen es más preciso para asegurar el porcentaje de ganancia real. Puedes probar ambos.</li>
<li><b>4. ¿Debo activar siempre los impuestos?</b><br/>Actívalos solo si realmente facturas con impuestos y quieres que el precio final ya los incluya.</li>
</ul>

<div class="sep"></div>
<h4>Consejos finales</h4>
<ul style="margin:6px 0 0 18px">
<li>Activa solo lo que uses (evita inflar costos).</li>
<li>Guarda precios reales para obtener <b>Costo Ud.</b> precisos.</li>
<li>Usa <b>Imprimir</b> o <b>Copiar</b> para compartir cotizaciones.</li>
<li>Para tandas/lotes, usa <b>Resumen General</b> y combina módulos según el proyecto.</li>
<li>Revisa de vez en cuando tus costos (insumos, sueldos, alquiler, etc.) para mantener tus precios actualizados.</li>
</ul>

<div class="sep"></div>
<div class="center-actions">
<button class="copy-btn" onclick="window.scrollTo({top:0,behavior:'smooth'})" type="button">Volver arriba</button>
<button class="copy-btn" onclick="window.print()" type="button">Exportar a PDF / Imprimir</button>
</div>
</div>
</div></section><footer class="footer">Suite creada por @subli_mada</footer>
</div>
<script>
// ============ Helpers (formato, UI, clipboard) ============
const USD_FMT = new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'});
const BS_FMT  = new Intl.NumberFormat('es-VE',{minimumFractionDigits:2,maximumFractionDigits:2});
function fmtUSD(n){return '$ ' + fmtEU(isFinite(n)?n:0)}
function fmtBs(n){return 'Bs '+BS_FMT.format(isFinite(n)?n:0)}
function parseNum(v){ if(typeof v==='number') return v; if(!v) return 0; v=String(v).replace(/[^0-9.,-]/g,'').replace(/,/g,''); return parseFloat(v)||0; }

function copyText(t){
  if(navigator.clipboard && window.isSecureContext){
    navigator.clipboard.writeText(t).then(()=>alert('Copiado')).catch(()=>fallbackCopy(t));
  }else{ fallbackCopy(t); }
}
function fallbackCopy(t){
  const ta=document.createElement('textarea'); ta.value=t; ta.style.position='fixed'; ta.style.left='-9999px';
  document.body.appendChild(ta); ta.focus(); ta.select();
  try{ document.execCommand('copy'); alert('Copiado'); }catch(e){ alert('No se pudo copiar');}
  document.body.removeChild(ta);
}
function qs(id){return document.getElementById(id)}

// Dark mode
(function initDark(){
  const t=qs('dark_toggle'); const on=localStorage.getItem('dark_on')==='1';
  document.body.classList.toggle('dark',on); if(t) t.checked=on;
  t&&t.addEventListener('change',()=>{const on=t.checked;document.body.classList.toggle('dark',on);localStorage.setItem('dark_on',on?'1':'0');});
})();

// ============ Navegación ============
(function initNav(){
  const buttons=[...document.querySelectorAll('nav button')];
  const views={divisas:qs('view-divisas'),vinil:qs('view-vinil'),basica:qs('view-basica'),sublimacion:qs('view-sublimacion'),etiquetas:qs('view-etiquetas'),empaques:qs('view-empaques'),resumen:qs('view-resumen')};
  buttons.forEach(btn=>btn.addEventListener('click',()=>{
    buttons.forEach(b=>b.classList.remove('active')); btn.classList.add('active');
    Object.values(views).forEach(v=>v.classList.remove('active')); views[btn.dataset.view].classList.add('active');
  }));
})();

// DIVISAS REMOVIDO// ============ VINIL (con persistencia) ============
(() => {
  const qs = (s)=>document.querySelector(s);
  const qa = (s)=>Array.from(document.querySelectorAll(s));

  // Paleta de colores segura (no importa para cálculos)
  const colores = {
    "Blanco":"#ffffff","Negro":"#000000","Rojo":"#ff0000","Azul":"#0000ff","Verde":"#008000",
    "Amarillo":"#ffff00","Naranja":"#ffa500","Morado":"#800080","Rosa":"#ffc0cb","Turquesa":"#40e0d0",
    "Gris":"#808080","Marrón":"#8b4513","Beige":"#f5f5dc","Plateado":"#c0c0c0","Dorado":"#ffd700",
    "Celeste":"#87ceeb","Lima":"#00ff00","Ninguno":"#ffffff"
  };

  let contador = 0;

  // Helpers formato EU
  function parseEU(v){
    if (v==null) return 0;
    v = String(v).trim().replace(/[^\d.,-]/g,'');
    if (!v) return 0;
    if (v.indexOf(',')>=0){ v = v.replace(/\./g,'').replace(',', '.'); }
    return parseFloat(v)||0;
  }
  function fmtEU(n, dec=2){
    if (!isFinite(n)) n=0;
    const s = Number(n).toFixed(dec);
    const [a,b] = s.split('.');
    return a.replace(/\B(?=(\d{3})+(?!\d))/g,'.') + (dec?(','+b):'');
  }
  function fmtUSD(n){ return '$ '+fmtEU(n); }

  function onlyEUInput(el){
    if(!el) return;
    el.addEventListener('input', ()=>{ el.value = el.value.replace(/[^\d.,-]/g,''); });
    el.addEventListener('blur', ()=>{ el.value = fmtEU(parseEU(el.value)); vinil_actualizarTotal(); vinil_save(); });
  }

  function blockHTML(id){
    return `
    <div class="calc-block" id="block${id}" style="border:1px solid #eee;border-radius:12px;padding:12px;background:#fff">
      <div class="row" style="align-items:center;justify-content:space-between">
        <label style="margin:0">Color</label>
        <button class="copy-btn" data-remove="${id}">Eliminar</button>
      </div>
      <div class="row" style="align-items:center;margin:6px 0 8px">
        <span class="color-preview" id="preview${id}" style="background:#fff"></span>
        <select id="color${id}" style="flex:1;padding:10px;border-radius:12px;border:1px solid #e5e7eb">
          ${Object.keys(colores).map(c=>`<option value="${c}">${c}</option>`).join('')}
        </select>
      </div>
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <div style="min-width:160px;flex:1">
          <label>Precio/m ($)</label>
          <input type="text" id="precio${id}" placeholder="0,00"/>
        </div>
        <div style="min-width:160px;flex:1">
          <label>Alto (cm)</label>
          <input type="text" id="alto${id}" placeholder="0"/>
        </div>
        <div style="min-width:160px;flex:1">
          <label>Ancho (cm)</label>
          <input type="text" id="ancho${id}" placeholder="0"/>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="md-12" id="resultado${id}" style="font-weight:600">Costo: $ 0,00</div>
        <button class="copy-btn" data-copy="${id}">Copiar</button>
      </div>
    </div>`;
  }

  function cambiarColor(id){
    const val = qs('#color'+id).value;
    const color = colores[val] || '#fff';
    const block = qs('#block'+id);
    const preview = qs('#preview'+id);
    if (preview) preview.style.backgroundColor = color;
    if (block){ block.style.borderColor = color+'55'; block.style.boxShadow='0 3px 10px '+color+'25'; }
  }

  function calcular(id){
    const anchoStd = parseEU(qs('#ancho_estandar')?.value) || 0;
    const precio = parseEU(qs('#precio'+id)?.value) || 0;
    const alto   = parseEU(qs('#alto'+id)?.value)   || 0;
    const ancho  = parseEU(qs('#ancho'+id)?.value)  || 0;
    const resEl  = qs('#resultado'+id);

    if(!anchoStd || !precio || !alto || !ancho){
      if(resEl) resEl.textContent = 'Costo: $ 0,00';
      vinil_actualizarTotal(); return;
    }
    const base = anchoStd * 100;             // cm2 por metro del rollo (anchoStd cm x 100 cm largo)
    const precioCm2 = precio / base;         // $/cm2
    const total = precioCm2 * alto * ancho;  // $ por la pieza
    if(resEl) resEl.textContent = 'Costo: $ '+fmtEU(total);
    vinil_actualizarTotal();
  }

  function agregarBloque(){
    contador++;
    const wrap = document.createElement('div');
    wrap.className = 'md-4';
    wrap.innerHTML = blockHTML(contador);
    const cont = qs('#bloques'); if (cont) cont.appendChild(wrap);

    // listeners
    qs('#color'+contador).addEventListener('change', ()=>cambiarColor(contador));
    ['precio','alto','ancho'].forEach(p=>{
      const el = qs('#'+p+contador);
      onlyEUInput(el);
      el.addEventListener('input', ()=>calcular(contador));
    });
    wrap.querySelector('[data-copy]')?.addEventListener('click', ()=>{
      const r = qs('#resultado'+contador)?.textContent || '';
      navigator.clipboard.writeText(r);
    });
    wrap.querySelector('[data-remove]')?.addEventListener('click', ()=>{
      wrap.remove(); vinil_actualizarTotal(); vinil_save();
    });

    cambiarColor(contador);
  }

  function vinil_actualizarTotal(){
    let total = 0;
    qa('[id^="resultado"]').forEach(el=>{
      let t = (el.textContent||'').replace('Costo:','').replace(/[^0-9.,-]/g,'');
      if (t.indexOf(',')>=0){ t = t.replace(/\./g,'').replace(',', '.'); }
      total += parseFloat(t)||0;
    });
        // Update material (adicionales) with the raw sum of bloques
    var adicEl = qs("#vinil_adicionales"); if (adicEl) { adicEl.textContent = "$ " + fmtEU(total); }
// Merma legacy disabled; handled by Vinil Pro merma slider
const extras = (typeof window._vinilExtras === 'number') ? window._vinilExtras : 0;
    const grand = total + extras;

    const lbl = qs('#totalFinal');
    if (lbl) lbl.textContent = 'Total Vinil: $ ' + fmtEU(grand);
  }

  function vinil_save(){
    const data = {
      ancho_estandar: qs('#ancho_estandar')?.value || '',
      margenError: !!qs('#margenError')?.checked,
      bloques: qa('[id^="block"]').map((b)=>{
        const id = b.id.replace('block','');
        return {
          color: qs('#color'+id)?.value || 'Ninguno',
          precio: qs('#precio'+id)?.value || '',
          alto: qs('#alto'+id)?.value || '',
          ancho: qs('#ancho'+id)?.value || ''
        };
      })
    };
    try{ localStorage.setItem('vinil_state', JSON.stringify(data)); }catch(e){}
  }

  function vinil_load(){
    let data=null;
    try{ data = JSON.parse(localStorage.getItem('vinil_state')||'null'); }catch(e){ data=null; }
    if (!data){
      contador=0; qs('#bloques')?.replaceChildren(); agregarBloque(); return;
    }
    // restore
    qs('#ancho_estandar') && (qs('#ancho_estandar').value = data.ancho_estandar || '51');
    if (qs('#margenError')) qs('#margenError').checked = !!data.margenError;
    qs('#bloques')?.replaceChildren();
    contador=0;
    (data.bloques||[]).forEach(b=>{
      agregarBloque();
      const id = contador;
      if (qs('#color'+id)) qs('#color'+id).value = b.color || 'Ninguno';
      ['precio','alto','ancho'].forEach(k=>{
        const el = qs('#'+k+id); if (el){ el.value = b[k] || ''; }
      });
      cambiarColor(id);
      calcular(id);
    });
    vinil_actualizarTotal();
  }

  // Bindings UI
  qs('#btn_add_color')?.addEventListener('click', agregarBloque);
  qs('#btn_reset_vinil')?.addEventListener('click', vinil_reset);
  qs('#ancho_estandar')?.addEventListener('input', ()=>{ vinil_actualizarTotal(); vinil_save(); });
  qs('#margenError')?.addEventListener('change', ()=>{ vinil_actualizarTotal(); vinil_save(); });

  // Expose updater for external use
  window.vinil_actualizarTotal = vinil_actualizarTotal;

  // Primera carga
  vinil_load();
  vinil_actualizarTotal();
})();
// ============ Calculadora básica ============
const disp=qs('calc-display');
document.querySelectorAll('#view-basica [data-k]').forEach(b=>b.addEventListener('click',()=>{ disp.value=(disp.value==='0'?'':disp.value)+b.dataset.k; }));
qs('calc-clear').addEventListener('click',()=>disp.value='');
qs('calc-eq').addEventListener('click',()=>{ try{ const out=eval(disp.value.replace(/[^0-9+\-*/().]/g,'')); disp.value=String(out);}catch(e){ disp.value='Error'; } });
document.addEventListener('keydown',e=>{ if(/^[0-9()+\-*/.]$/.test(e.key)){ disp.value=(disp.value==='0'?'':disp.value)+e.key; } else if(e.key==='Enter'){ qs('calc-eq').click(); } else if(e.key==='Backspace'){ disp.value=disp.value.slice(0,-1);} });

// ============ SUBLIMACIÓN ============
function setText(id,n){ qs(id).value=fmtUSD(n) }
function setSpan(id,n){ qs(id).textContent=fmtUSD(n) }
function valNum(id){ const v=parseNum(qs(id).value); return v<0?0:v }
function unitCost(en,precio,cant){ if(!en) return 0; if(!precio||!cant) return 0; return precio/cant }

const SUB_PRESETS={"Taza":{cant:36,precio:90},"Taza Magica":{cant:36,precio:144},"Jarra Cervecera":{cant:24,precio:96},
"Termo":{cant:24,precio:180},"Camiseta":{cant:20,precio:100},"Llavero":{cant:50,precio:75},"Mousepad":{cant:50,precio:100},
"Rompecabezas":{cant:20,precio:80},"Boligrafo":{cant:50,precio:65},"Otros":{cant:1,precio:2.5}};

function sub_applyPreset(){ const sel=qs('d_prod_select'); const p=SUB_PRESETS[sel.value]; if(!p) return; qs('d_prod_cant').value=p.cant; qs('d_prod_precio').value=p.precio; sub_update(); }

const SUB_KEYS=['d_prod_on','d_prod_cant','d_prod_precio','d_papel_on','d_papel_cant','d_papel_precio','d_tinta_on','d_tinta_cant','d_tinta_precio','d_cinta_on','d_cinta_cant','d_cinta_precio','d_empaque_on','d_empaque_cant','d_empaque_precio','e_impresora_on','e_impresora_precio','e_plancha_on','e_plancha_precio','e_pc_on','e_pc_precio','sub_ganancia','sub_impuestos','chk_ganancia','chk_impuestos','d_prod_select','d_funda_on','d_funda_cant','d_funda_precio','e_horno_on','e_horno_precio'];
function sub_save(){ const d={}; SUB_KEYS.forEach(k=>{ const el=qs(k); if(!el) return; d[k]= (el.type==='checkbox')?(el.checked?1:0):el.value; }); localStorage.setItem('sublimacion_state',JSON.stringify(d)); }
function sub_load(){ const raw=localStorage.getItem('sublimacion_state'); if(!raw) return; try{ const d=JSON.parse(raw); Object.keys(d).forEach(k=>{const el=qs(k); if(!el) return; if(el.type==='checkbox') el.checked=!!d[k]; else el.value=d[k];}); }catch(e){} }
document.addEventListener('input',e=>{ const id=e.target&&e.target.id; if(id && SUB_KEYS.includes(id)) sub_save(); });
document.addEventListener('change',e=>{ const id=e.target&&e.target.id; if(id && SUB_KEYS.includes(id)) sub_save(); });

function sub_update(){
  window.sub_update = sub_update;

  const d0=unitCost(qs('d_prod_on').checked, valNum('d_prod_precio'), valNum('d_prod_cant')); setText('d_prod_ud', d0);
  const d1=unitCost(qs('d_papel_on').checked, valNum('d_papel_precio'), valNum('d_papel_cant')); setText('d_papel_ud', d1);
  const d2=unitCost(qs('d_tinta_on').checked, valNum('d_tinta_precio'), valNum('d_tinta_cant')); setText('d_tinta_ud', d2);
  const d3=unitCost(qs('d_cinta_on').checked, valNum('d_cinta_precio'), valNum('d_cinta_cant')); setText('d_cinta_ud', d3);
  const d4=unitCost(qs('d_empaque_on').checked, valNum('d_empaque_precio'), valNum('d_empaque_cant')); setText('d_empaque_ud', d4);
  const _f_prec=valNum('d_funda_precio'), _f_cant=valNum('d_funda_cant'); const _f_ud=(_f_prec&&_f_cant)?(_f_prec/_f_cant):0; setText('d_funda_ud', _f_ud); const d5 = qs('d_funda_on').checked ? _f_ud : 0;
  const totalDirectos=d0+d1+d2+d3+d4+d5; setSpan('sub_total_directos', totalDirectos);

  function dep(chk,precioId,mesId,udId){ const en=qs(chk).checked; const precio=valNum(precioId); const mes=precio/24; const ud=mes/100; setText(mesId,mes); setText(udId,ud); return en?ud:0; }
  const e1=dep('e_impresora_on','e_impresora_precio','e_impresora_mes','e_impresora_ud');
  const e2=dep('e_plancha_on','e_plancha_precio','e_plancha_mes','e_plancha_ud');
  const e3=dep('e_pc_on','e_pc_precio','e_pc_mes','e_pc_ud');
  const e4=dep('e_horno_on','e_horno_precio','e_horno_mes','e_horno_ud');
  const totalDepr=e1+e2+e3+e4; setSpan('sub_total_depr', totalDepr);

  const subtotal=totalDirectos+totalDepr; setSpan('sub_subtotal_no_gi', subtotal);
  const g=Math.max(0,parseNum(qs('sub_ganancia').value))/100;
  const i=Math.max(0,parseNum(qs('sub_impuestos').value))/100;
  const ganVal=qs('chk_ganancia').checked? subtotal*g : 0;
  const subMasGan=subtotal+ganVal;
  const impVal=qs('chk_impuestos').checked? subMasGan*i : 0;
  const total=subMasGan+impVal;
  setSpan('sub_subtotal', subtotal); setSpan('sub_ganancia_val', ganVal); setSpan('sub_impuestos_val', impVal); setSpan('sub_total', total); setSpan('sub_v15_total', total);
}
function sub_reset(){
  localStorage.removeItem('sublimacion_state');
  const d={d_prod_cant:36,d_prod_precio:90,d_papel_cant:100,d_papel_precio:10,d_tinta_cant:300,d_tinta_precio:40,d_cinta_cant:100,d_cinta_precio:3,d_empaque_cant:50,d_empaque_precio:5,e_impresora_precio:240,e_plancha_precio:400,e_pc_precio:350,sub_ganancia:40,sub_impuestos:16};
  Object.keys(d).forEach(k=>{ if(qs(k)) qs(k).value=d[k]; });
  

  // Consumo real: defaults de uso
  [
    'eti_d_prod_use',
    'eti_d_adhesivo_use',
    'eti_d_liner_use',
    'eti_d_tinta_use',
    'eti_d_merma_use',
    'eti_d_laminado_use',
    'eti_d_empaque_use',
    'eti_e_impresora_use',
    'eti_e_plotter_use',
    'eti_e_guillotina_use',
    'eti_e_tapete_use',
    'eti_e_troqueladora_use',
    'eti_e_pc_use',
    'eti_e_cuchilla_use'
  ].forEach(id=>{ if(qs(id)) qs(id).value='1'; });
['d_prod_on','d_papel_on','d_tinta_on','d_cinta_on','d_empaque_on','e_impresora_on','e_plancha_on','e_pc_on','chk_ganancia','chk_impuestos'].forEach(id=>{ if(qs(id)) qs(id).checked=true; });
  if(qs('d_prod_select')) qs('d_prod_select').value='Taza';
  sub_update();
}
qs('d_prod_select').addEventListener('change',sub_applyPreset);
document.querySelectorAll('#view-sublimacion input').forEach(el=>{
  if(el.type==='number' || el.type==='checkbox') el.addEventListener('input', sub_update);
});
qs('btn_print_sub').addEventListener('click',()=>window.print());
qs('btn_copy_sub').addEventListener('click',()=>{
  const lines=[
    'Producto: '+(qs('d_prod_select')?.value||''),
    'Directos = '+qs('sub_total_directos').textContent,
    'Depreciación = '+qs('sub_total_depr').textContent,
    'Total sin G/I = '+qs('sub_subtotal_no_gi').textContent,
    'Subtotal = '+qs('sub_subtotal').textContent,
    'Ganancia ('+qs('sub_ganancia').value+'%) = '+qs('sub_ganancia_val').textContent + (qs('chk_ganancia').checked?'':' (omitida)'),
    'Impuestos ('+qs('sub_impuestos').value+'%) = '+qs('sub_impuestos_val').textContent + (qs('chk_impuestos').checked?'':' (omitidos)'),
    'Precio de Venta = '+qs('sub_v15_total').textContent
  ]; copyText(lines.join('\\n'));
});
qs('btn_reset_sub').addEventListener('click',sub_reset);
sub_load(); sub_applyPreset(); sub_update();

// ============ ETIQUETAS (cuchilla por cortes) ============
function eti_setText(id,n){ qs(id).value=fmtUSD(n) }
function eti_setSpan(id,n){ qs(id).textContent=fmtUSD(n) }
function eti_valNum(id){ const v=parseNum(qs(id).value); return v<0?0:v }
function eti_unitCost(precio,cant){ if(!precio||!cant) return 0; return precio/cant }
const ETI_PRESETS={"Vinil imprimible":{cant:20,precio:13},"Papel fotográfico adhesivo":{cant:50,precio:13},"Etiqueta PVC":{cant:20,precio:15},"Etiqueta BOPP":{cant:20,precio:16},"Holográfico":{cant:20,precio:18},"Transparente":{cant:20,precio:14},"Kraft":{cant:20,precio:12},"Otros":{cant:1,precio:2.5}};
function eti_applyPreset(){ const sel=qs('eti_d_prod_select'); const p=ETI_PRESETS[sel.value]; if(!p) return; qs('eti_d_prod_cant').value=p.cant; qs('eti_d_prod_precio').value=p.precio; eti_update(); }

const ETI_KEYS=['eti_d_prod_on','eti_d_prod_cant','eti_d_prod_precio','eti_d_prod_select','eti_d_adhesivo_on','eti_d_adhesivo_cant','eti_d_adhesivo_precio','eti_d_liner_on','eti_d_liner_cant','eti_d_liner_precio','eti_d_tinta_on','eti_d_tinta_cant','eti_d_tinta_precio','eti_d_merma_on','eti_d_merma_cant','eti_d_merma_precio','eti_d_laminado_on','eti_d_laminado_cant','eti_d_laminado_precio','eti_d_empaque_on','eti_d_empaque_cant','eti_d_empaque_precio','eti_e_impresora_on','eti_e_impresora_precio','eti_e_plotter_on','eti_e_plotter_precio','eti_e_guillotina_on','eti_e_guillotina_precio','eti_e_tapete_on','eti_e_tapete_precio','eti_e_troqueladora_on','eti_e_troqueladora_precio','eti_e_pc_on','eti_e_pc_precio','eti_e_cuchilla_on','eti_e_cuchilla_precio','eti_e_cuchilla_vida','eti_d_prod_use','eti_d_adhesivo_use','eti_d_liner_use','eti_d_tinta_use','eti_d_merma_use','eti_d_laminado_use','eti_d_empaque_use','eti_e_impresora_use','eti_e_plotter_use','eti_e_guillotina_use','eti_e_tapete_use','eti_e_troqueladora_use','eti_e_pc_use','eti_e_cuchilla_use','eti_ganancia','eti_impuestos','eti_chk_ganancia','eti_chk_impuestos'];
function eti_save(){ const d={}; ETI_KEYS.forEach(k=>{ const el=qs(k); if(!el) return; d[k]=(el.type==='checkbox')?(el.checked?1:0):el.value; }); localStorage.setItem('etiquetas_state',JSON.stringify(d)); }
function eti_load(){ const raw=localStorage.getItem('etiquetas_state'); if(!raw) return; try{ const d=JSON.parse(raw); Object.keys(d).forEach(k=>{ const el=qs(k); if(!el) return; if(el.type==='checkbox') el.checked=!!d[k]; else el.value=d[k];}); }catch(e){} }
document.addEventListener('input',e=>{ const id=e.target&&e.target.id; if(id && ETI_KEYS.includes(id)) eti_save(); });
document.addEventListener('change',e=>{ const id=e.target&&e.target.id; if(id && ETI_KEYS.includes(id)) eti_save(); });

function eti_update(){
  const useNum = (id)=>{ const el=qs(id); const v=el?parseNum(el.value):1; return v<0?0:v; };
  const d0_raw=eti_unitCost(eti_valNum('eti_d_prod_precio'), eti_valNum('eti_d_prod_cant')); eti_setText('eti_d_prod_ud', d0_raw);
  const d0_used_raw=d0_raw*useNum('eti_d_prod_use'); eti_setText('eti_d_prod_used', d0_used_raw);
  const d0 = qs('eti_d_prod_on').checked ? d0_used_raw : 0;
  const d1_raw=eti_unitCost(eti_valNum('eti_d_adhesivo_precio'), eti_valNum('eti_d_adhesivo_cant')); eti_setText('eti_d_adhesivo_ud', d1_raw);
  const d1_used_raw=d1_raw*useNum('eti_d_adhesivo_use'); eti_setText('eti_d_adhesivo_used', d1_used_raw);
  const d1 = qs('eti_d_adhesivo_on').checked ? d1_used_raw : 0;
  const d2_raw=eti_unitCost(eti_valNum('eti_d_liner_precio'), eti_valNum('eti_d_liner_cant')); eti_setText('eti_d_liner_ud', d2_raw);
  const d2_used_raw=d2_raw*useNum('eti_d_liner_use'); eti_setText('eti_d_liner_used', d2_used_raw);
  const d2 = qs('eti_d_liner_on').checked ? d2_used_raw : 0;
  const d3_raw=eti_unitCost(eti_valNum('eti_d_tinta_precio'), eti_valNum('eti_d_tinta_cant')); eti_setText('eti_d_tinta_ud', d3_raw);
  const d3_used_raw=d3_raw*useNum('eti_d_tinta_use'); eti_setText('eti_d_tinta_used', d3_used_raw);
  const d3 = qs('eti_d_tinta_on').checked ? d3_used_raw : 0;
  const d4_raw=eti_unitCost(eti_valNum('eti_d_merma_precio'), eti_valNum('eti_d_merma_cant')); eti_setText('eti_d_merma_ud', d4_raw);
  const d4_used_raw=d4_raw*useNum('eti_d_merma_use'); eti_setText('eti_d_merma_used', d4_used_raw);
  const d4 = qs('eti_d_merma_on').checked ? d4_used_raw : 0;
  const d5_raw=eti_unitCost(eti_valNum('eti_d_laminado_precio'), eti_valNum('eti_d_laminado_cant')); eti_setText('eti_d_laminado_ud', d5_raw);
  const d5_used_raw=d5_raw*useNum('eti_d_laminado_use'); eti_setText('eti_d_laminado_used', d5_used_raw);
  const d5 = qs('eti_d_laminado_on').checked ? d5_used_raw : 0;
  const d6_raw=eti_unitCost(eti_valNum('eti_d_empaque_precio'), eti_valNum('eti_d_empaque_cant')); eti_setText('eti_d_empaque_ud', d6_raw);
  const d6_used_raw=d6_raw*useNum('eti_d_empaque_use'); eti_setText('eti_d_empaque_used', d6_used_raw);
  const d6 = qs('eti_d_empaque_on').checked ? d6_used_raw : 0;
  const totalDirectos=d0+d1+d2+d3+d4+d5+d6; eti_setSpan('eti_total_directos', totalDirectos);

  // Cuchilla por cortes
  const cuch_precio=eti_valNum('eti_e_cuchilla_precio');
  const cuch_vida=Math.max(1, parseInt(qs('eti_e_cuchilla_vida').value||'100',10));
  const cuch_porCorte=cuch_precio/cuch_vida;
  eti_setText('eti_e_cuchilla_ud', cuch_porCorte);
  const cuch_used_raw=cuch_porCorte*useNum('eti_e_cuchilla_use');
  eti_setText('eti_e_cuchilla_used', cuch_used_raw);
  let e1 = qs('eti_e_cuchilla_on').checked ? cuch_used_raw : 0;

  function dep(chk,precioId,mesId,udId,useId,usedId){
    const en=qs(chk).checked;
    const precio=eti_valNum(precioId);
    const mes=precio/24;
    const ud=mes/100;
    if(qs(mesId)) eti_setText(mesId,mes);
    if(qs(udId)) eti_setText(udId,ud);
    const used=ud*useNum(useId);
    if(qs(usedId)) eti_setText(usedId,used);
    return en?used:0;
  }
  const e2=dep('eti_e_plotter_on','eti_e_plotter_precio','eti_e_plotter_mes','eti_e_plotter_ud','eti_e_plotter_use','eti_e_plotter_used');
  const e3=dep('eti_e_impresora_on','eti_e_impresora_precio','eti_e_impresora_mes','eti_e_impresora_ud','eti_e_impresora_use','eti_e_impresora_used');
  const e4=dep('eti_e_guillotina_on','eti_e_guillotina_precio','eti_e_guillotina_mes','eti_e_guillotina_ud','eti_e_guillotina_use','eti_e_guillotina_used');
  const e5=dep('eti_e_tapete_on','eti_e_tapete_precio','eti_e_tapete_mes','eti_e_tapete_ud','eti_e_tapete_use','eti_e_tapete_used');
  const e6=dep('eti_e_troqueladora_on','eti_e_troqueladora_precio','eti_e_troqueladora_mes','eti_e_troqueladora_ud','eti_e_troqueladora_use','eti_e_troqueladora_used');
  const e7=dep('eti_e_pc_on','eti_e_pc_precio','eti_e_pc_mes','eti_e_pc_ud','eti_e_pc_use','eti_e_pc_used');
  const totalDepr=e1+e2+e3+e4+e5+e6+e7; eti_setSpan('eti_total_depr', totalDepr);

  const subtotal=totalDirectos+totalDepr; eti_setSpan('eti_subtotal_no_gi', subtotal);
  const g=Math.max(0,parseNum(qs('eti_ganancia').value))/100;
  const i=Math.max(0,parseNum(qs('eti_impuestos').value))/100;
  const ganVal=qs('eti_chk_ganancia').checked? subtotal*g : 0;
  const subMasGan=subtotal+ganVal;
  const impVal=qs('eti_chk_impuestos').checked? subMasGan*i : 0;
  const total=subMasGan+impVal;
  eti_setSpan('eti_subtotal', subtotal); eti_setSpan('eti_ganancia_val', ganVal); eti_setSpan('eti_impuestos_val', impVal); eti_setSpan('eti_total', total);
}
function eti_reset(){
  localStorage.removeItem('etiquetas_state');

  const d={
    eti_d_prod_cant:50,eti_d_prod_precio:20,
    eti_d_adhesivo_cant:500,eti_d_adhesivo_precio:15,
    eti_d_liner_cant:1000,eti_d_liner_precio:20,
    eti_d_tinta_cant:1000,eti_d_tinta_precio:30,
    eti_d_merma_cant:500,eti_d_merma_precio:5,
    eti_d_laminado_cant:20,eti_d_laminado_precio:10,
    eti_d_empaque_cant:200,eti_d_empaque_precio:8,

    eti_e_impresora_precio:240,
    eti_e_plotter_precio:400,
    eti_e_guillotina_precio:120,
    eti_e_tapete_precio:15,
    eti_e_cuchilla_precio:30,eti_e_cuchilla_vida:100,
    eti_e_troqueladora_precio:300,
    eti_e_pc_precio:350,

    eti_ganancia:40,eti_impuestos:16
  };

  Object.keys(d).forEach(k=>{ if(qs(k)) qs(k).value=d[k]; });

  [
    'eti_d_prod_on','eti_d_adhesivo_on','eti_d_liner_on','eti_d_tinta_on','eti_d_merma_on','eti_d_laminado_on','eti_d_empaque_on',
    'eti_e_impresora_on','eti_e_plotter_on','eti_e_guillotina_on','eti_e_tapete_on','eti_e_cuchilla_on','eti_e_troqueladora_on','eti_e_pc_on',
    'eti_chk_ganancia','eti_chk_impuestos'
  ].forEach(id=>{ if(qs(id)) qs(id).checked=false; });

  if(qs('eti_d_prod_select')) qs('eti_d_prod_select').value='Vinil imprimible';
  eti_update();
}
qs('eti_d_prod_select').addEventListener('change',eti_applyPreset);
document.querySelectorAll('#view-etiquetas input').forEach(el=>{
  if(el.type==='number' || el.type==='checkbox') el.addEventListener('input', eti_update);
});
qs('btn_print_eti').addEventListener('click',()=>window.print());
qs('btn_copy_eti').addEventListener('click',()=>{
  const lines=[
    'Tipo: '+(qs('eti_d_prod_select')?.value||''),
    'Directos = '+qs('eti_total_directos').textContent,
    'Depreciación = '+qs('eti_total_depr').textContent,
    'Total sin G/I = '+qs('eti_subtotal_no_gi').textContent,
    'Subtotal = '+qs('eti_subtotal').textContent,
    'Ganancia ('+qs('eti_ganancia').value+'%) = '+qs('eti_ganancia_val').textContent + (qs('eti_chk_ganancia').checked?'':' (omitida)'),
    'Impuestos ('+qs('eti_impuestos').value+'%) = '+qs('eti_impuestos_val').textContent + (qs('eti_chk_impuestos').checked?'':' (omitidos)'),
    'Vida cuchilla (cortes) = '+(qs('eti_e_cuchilla_vida')?.value||''),
    'Precio de Venta = '+qs('eti_total').textContent
  ]; copyText(lines.join('\\n'));
});
qs('btn_reset_eti').addEventListener('click',eti_reset);
eti_load(); eti_applyPreset(); eti_update();

// ============ EMPAQUES ============
function emp_setText(id,n){ qs(id).value=fmtUSD(n) }
function emp_setSpan(id,n){ qs(id).textContent=fmtUSD(n) }
function emp_valNum(id){ const v=parseNum(qs(id).value); return v<0?0:v }
function emp_unitCost(precio,cant){ if(!precio||!cant) return 0; return precio/cant }
const EMP_KEYS=['emp_caja_on','emp_caja_cant','emp_caja_precio','emp_bolsa_on','emp_bolsa_cant','emp_bolsa_precio','emp_relleno_on','emp_relleno_cant','emp_relleno_precio','emp_etiqueta_on','emp_etiqueta_cant','emp_etiqueta_precio','emp_tarjeta_on','emp_tarjeta_cant','emp_tarjeta_precio','emp_cinta_on','emp_cinta_cant','emp_cinta_precio','emp_caja_use','emp_bolsa_use','emp_relleno_use','emp_etiqueta_use','emp_tarjeta_use','emp_cinta_use','emp_impresora_use','emp_impresora_on','emp_impresora_precio','emp_ganancia','emp_impuestos','emp_chk_ganancia','emp_chk_impuestos'];
function emp_save(){ const d={}; EMP_KEYS.forEach(k=>{ const el=qs(k); if(!el) return; d[k]=(el.type==='checkbox')?(el.checked?1:0):el.value; }); localStorage.setItem('empaques_state',JSON.stringify(d)); }
function emp_load(){ const raw=localStorage.getItem('empaques_state'); if(!raw) return; try{ const d=JSON.parse(raw); Object.keys(d).forEach(k=>{ const el=qs(k); if(!el) return; if(el.type==='checkbox') el.checked=!!d[k]; else el.value=d[k];}); }catch(e){} }
document.addEventListener('input',e=>{ const id=e.target&&e.target.id; if(id && EMP_KEYS.includes(id)) emp_save(); });
document.addEventListener('change',e=>{ const id=e.target&&e.target.id; if(id && EMP_KEYS.includes(id)) emp_save(); });

function emp_update(){
  function safe(n){ n=Number(n); if(!isFinite(n)||isNaN(n)) return 0; return n<0?0:n; }

  // --- Directos (Costo Ud. + Costo utilizado siempre visibles) ---
  const ud0=safe(emp_unitCost(emp_valNum('emp_caja_precio'), emp_valNum('emp_caja_cant'))); emp_setText('emp_caja_ud', ud0);
  const use0=safe(emp_valNum('emp_caja_use')); const used0=safe(ud0*use0); emp_setText('emp_caja_used', used0);

  const ud1=safe(emp_unitCost(emp_valNum('emp_bolsa_precio'), emp_valNum('emp_bolsa_cant'))); emp_setText('emp_bolsa_ud', ud1);
  const use1=safe(emp_valNum('emp_bolsa_use')); const used1=safe(ud1*use1); emp_setText('emp_bolsa_used', used1);

  const ud2=safe(emp_unitCost(emp_valNum('emp_relleno_precio'), emp_valNum('emp_relleno_cant'))); emp_setText('emp_relleno_ud', ud2);
  const use2=safe(emp_valNum('emp_relleno_use')); const used2=safe(ud2*use2); emp_setText('emp_relleno_used', used2);

  const ud3=safe(emp_unitCost(emp_valNum('emp_etiqueta_precio'), emp_valNum('emp_etiqueta_cant'))); emp_setText('emp_etiqueta_ud', ud3);
  const use3=safe(emp_valNum('emp_etiqueta_use')); const used3=safe(ud3*use3); emp_setText('emp_etiqueta_used', used3);

  const ud4=safe(emp_unitCost(emp_valNum('emp_tarjeta_precio'), emp_valNum('emp_tarjeta_cant'))); emp_setText('emp_tarjeta_ud', ud4);
  const use4=safe(emp_valNum('emp_tarjeta_use')); const used4=safe(ud4*use4); emp_setText('emp_tarjeta_used', used4);

  const ud5=safe(emp_unitCost(emp_valNum('emp_cinta_precio'), emp_valNum('emp_cinta_cant'))); emp_setText('emp_cinta_ud', ud5);
  const use5=safe(emp_valNum('emp_cinta_use')); const used5=safe(ud5*use5); emp_setText('emp_cinta_used', used5);

  const totalDirectos =
    (qs('emp_caja_on').checked?used0:0) +
    (qs('emp_bolsa_on').checked?used1:0) +
    (qs('emp_relleno_on').checked?used2:0) +
    (qs('emp_etiqueta_on').checked?used3:0) +
    (qs('emp_tarjeta_on').checked?used4:0) +
    (qs('emp_cinta_on').checked?used5:0);
  emp_setSpan('emp_total_directos', safe(totalDirectos));

  // --- Depreciación (mes/ud siempre visibles; usado siempre visible) ---
  function depUsed(chk,precioId,mesId,udId,useId,usedId){
    const precio=safe(emp_valNum(precioId));
    const mes=safe(precio/24);
    const ud=safe(mes/100);
    emp_setText(mesId, mes);
    emp_setText(udId, ud);
    const uses=safe(emp_valNum(useId));
    const used=safe(ud*uses);
    emp_setText(usedId, used);
    return (qs(chk).checked? used : 0);
  }
  const e1=depUsed('emp_impresora_on','emp_impresora_precio','emp_impresora_mes','emp_impresora_ud','emp_impresora_use','emp_impresora_used');
  const totalDepr=safe(e1); emp_setSpan('emp_total_depr', totalDepr);

  const subtotal=safe(totalDirectos+totalDepr); emp_setSpan('emp_subtotal_no_gi', subtotal);
  const g=Math.max(0,parseNum(qs('emp_ganancia').value))/100;
  const i=Math.max(0,parseNum(qs('emp_impuestos').value))/100;
  const ganVal=qs('emp_chk_ganancia').checked? subtotal*g : 0;
  const subMasGan=subtotal+ganVal;
  const impVal=qs('emp_chk_impuestos').checked? subMasGan*i : 0;
  const total=subMasGan+impVal;
  emp_setSpan('emp_subtotal', subtotal);
  emp_setSpan('emp_ganancia_val', ganVal);
  emp_setSpan('emp_impuestos_val', impVal);
  emp_setSpan('emp_total', total);
}
function emp_reset(){
  localStorage.removeItem('empaques_state');
  const d={emp_caja_cant:50,emp_caja_precio:20,emp_bolsa_cant:100,emp_bolsa_precio:12,emp_relleno_cant:1,emp_relleno_precio:5,emp_etiqueta_cant:100,emp_etiqueta_precio:8,emp_tarjeta_cant:50,emp_tarjeta_precio:6,emp_cinta_cant:1,emp_cinta_precio:2,emp_impresora_precio:200,emp_ganancia:30,emp_impuestos:16};
  Object.keys(d).forEach(k=>{ if(qs(k)) qs(k).value=d[k]; });
  ['emp_caja_use','emp_bolsa_use','emp_relleno_use','emp_etiqueta_use','emp_tarjeta_use','emp_cinta_use','emp_impresora_use'].forEach(id=>{ if(qs(id)) qs(id).value=1; });
  ['emp_caja_on','emp_bolsa_on','emp_relleno_on','emp_etiqueta_on','emp_tarjeta_on','emp_cinta_on','emp_impresora_on','emp_chk_ganancia','emp_chk_impuestos'].forEach(id=>{ if(qs(id)) qs(id).checked=true; });
  emp_update();
}
document.querySelectorAll('#view-empaques input').forEach(el=>{
  if(el.type==='number' || el.type==='checkbox') el.addEventListener('input', emp_update);
});
qs('btn_print_emp').addEventListener('click',()=>window.print());
qs('btn_copy_emp').addEventListener('click',()=>{
  const lines=[
    'Empaques — Directos = '+qs('emp_total_directos').textContent,
    'Depreciación = '+qs('emp_total_depr').textContent,
    'Total sin G/I = '+qs('emp_subtotal_no_gi').textContent,
    'Subtotal = '+qs('emp_subtotal').textContent,
    'Ganancia ('+qs('emp_ganancia').value+'%) = '+qs('emp_ganancia_val').textContent + (qs('emp_chk_ganancia').checked?'':' (omitida)'),
    'Impuestos ('+qs('emp_impuestos').value+'%) = '+qs('emp_impuestos_val').textContent + (qs('emp_chk_impuestos').checked?'':' (omitidos)'),
    'Precio de Venta = '+qs('emp_total').textContent
  ]; copyText(lines.join('\\n'));
});
qs('btn_reset_emp').addEventListener('click',emp_reset);
emp_load(); emp_update();

// ============ RESUMEN GENERAL ============
function sum_parseMoney(txt){
  const s = String(txt||'').replace('Costo total:','').replace(/[^0-9.,-]/g,'');
  if(s.includes(',')){
    const t = s.replace(/\./g,'').replace(',', '.');
    const n = parseFloat(t); return isFinite(n)?n:0;
  }
  const n = parseFloat(s); return isFinite(n)?n:0;
}
  const n = parseFloat(s); return isFinite(n)?n:0;
}
function sum_update(){
  const incV=qs('sum_incluir_vinil').checked, incS=qs('sum_incluir_sublim').checked, incE=qs('sum_incluir_etiq').checked, incEmp=qs('sum_incluir_emp').checked;
    const v = sum_parseMoney(qs('vin_total')?.textContent);
    const s = sum_parseMoney(qs('sub_v15_total')?.textContent);
    const e = sum_parseMoney(qs('eti_total')?.textContent);
    const m = sum_parseMoney(qs('emp_total')?.textContent);
  qs('sum_vinil').textContent = fmtUSD(v);
  qs('sum_sublim').textContent = (qs('sub_v15_total')?.textContent || '$ 0,00');
  qs('sum_etiq').textContent = fmtUSD(e);
  qs('sum_emp').textContent = fmtUSD(m);
  const total = (incV?v:0)+(incS?s:0)+(incE?e:0)+(incEmp?m:0);
  qs('sum_total').textContent = fmtUSD(total);
  const bcv = parseNum(qs('tasa_bcv')?.value);
  const par = parseNum(qs('tasa_paralelo')?.value);
  qs('sum_bcv').textContent = bcv? fmtBs(bcv): '—';
  qs('sum_par').textContent = par? fmtBs(par): '—';
}
['sum_incluir_vinil','sum_incluir_sublim','sum_incluir_etiq','sum_incluir_emp'].forEach(id=>{ const el=qs(id); if(el) el.addEventListener('change', sum_update); });
qs('btn_copy_sum').addEventListener('click',()=>{
  const lines=[
    'Resumen General',
    'Vinil = '+qs('sum_vinil').textContent + (qs('sum_incluir_vinil').checked?'':' (omitido)'),
    'Sublimación = '+qs('sum_sublim').textContent + (qs('sum_incluir_sublim').checked?'':' (omitida)'),
    'Etiquetas = '+qs('sum_etiq').textContent + (qs('sum_incluir_etiq').checked?'':' (omitidas)'),
    'Empaques = '+qs('sum_emp').textContent + (qs('sum_incluir_emp').checked?'':' (omitidos)'),
    'Total General = '+qs('sum_total').textContent,
    'Precio BCV = '+qs('sum_bcv').textContent,
    'Precio Paralelo = '+qs('sum_par').textContent
  ]; copyText(lines.join('\\n'));
});
qs('btn_print_sum').addEventListener('click',()=>window.print());
['vin_total','sub_v15_total','eti_total','emp_total'].forEach(id=>{
  const obEl = qs(id);
  if(obEl){
    const obs = new MutationObserver(sum_update);
    obs.observe(obEl, {childList:true, characterData:true, subtree:true});
  }
});
['tasa_bcv','tasa_paralelo'].forEach(id=>qs(id)?.addEventListener('input', sum_update));
sum_update();

// ============ DTF (servicio externo) ============
(() => {
  const $ = (id) => document.getElementById(id);
  const fmt = (n)=>'$ ' + fmtEU(isFinite(n)?n:0);
  const num = (el)=>parseNum(el?.value);
  const clamp = (n)=>isFinite(n)?n:0;

  const MODO = { metro:'metro', tramo30:'tramo30', a3:'a3' };
  const ANCHO_CM = 57;

  function unidadesCobradas(mod, largo_cm, respMin){
    if(mod===MODO.a3){
      // En A3, el usuario define cuántas hojas necesita vía largo => interpretamos 1 unidad por cada 42 cm de largo ocupado (aprox alto de A3 a lo ancho de 57 cm).
      // Para evitar suposiciones fuertes, tratamos largo_cm como múltiplos de 1 hoja si respMin está activo.
      const hojaEquiv = 42; // cm aprox de alto util por "fila" para A3 cuando ANCHO=57 (aproximación práctica)
      let u = largo_cm/hojaEquiv;
      if(respMin) u = Math.ceil(Math.max(1,u));
      return Math.max(0,u);
    }
    const unidad = (mod===MODO.metro)?100:30;
    let u = largo_cm / unidad;
    if(respMin) u = Math.ceil(Math.max(1,u));
    return Math.max(0,u);
  }

  function recompute(){
    // --- EXTENSION HOOK (multi-diseños actualiza largo si aplica) ---
    try{ if(window.recomputeDTF_Ext) window.recomputeDTF_Ext(); }catch(e){}
    const mod = $("dtf_modalidad").value;
    const respMin = $("dtf_resp_min").checked;

    // Largo directo o por diseños
    let largo = num($("dtf_largo_cm"));

    if($("dtf_calc_por_diseno").checked){
      const N = Math.max(1, Math.floor(num($("dtf_n"))));
      const w = Math.max(0, num($("dtf_w")));
      const h = Math.max(0, num($("dtf_h")));
      const cols = Math.max(1, Math.floor(ANCHO_CM / Math.max(1,w)));
      const filas = Math.ceil(N / cols);
      const largo_calc = filas * h;
      $("dtf_largo_cm").value = String(largo_calc.toFixed(1));
      largo = largo_calc;
    }

    // Precio por unidad
    let punit = num($("dtf_precio_unit"));

    // Unidades cobrada por el proveedor
    const u = unidadesCobradas(mod, largo, respMin);
    $("dtf_unidades").textContent = isFinite(u)?u.toString():"0";

    const directos = clamp(u * punit);

    const extras = clamp(num($("dtf_extra_envio")) + num($("dtf_extra_diseno")) + num($("dtf_extra_plancha")) + num($("dtf_extra_otros")));
    // Costos prenda
    let prenda_ud = 0, prenda_total = 0;
    if ($("dtf_prenda_on")?.checked){
      const pcant = Math.max(0, num($("dtf_prenda_cant")));
      const pprecio = Math.max(0, num($("dtf_prenda_precio")));
      prenda_ud = (pcant>0)? (pprecio/pcant) : 0;
      $("dtf_prenda_costo_ud") && ($("dtf_prenda_costo_ud").value = fmt(prenda_ud));
      // Si tenemos conteo de estampados por bloques, lo usamos; si no, usamos pcant directo
      let estampados = 0;
      try{
        if(window.dtf_estampados_cache!=null) estampados = window.dtf_estampados_cache;
      }catch(e){}
      if(estampados<=0) estampados = pcant;
      prenda_total = prenda_ud * estampados;
    }else{
      $("dtf_prenda_costo_ud") && ($("dtf_prenda_costo_ud").value = "$ 0,00");
    }

    // Depreciación plancha (por estampado)
    let dep_ud = 0, dep_total = 0;
    const depPrecio = num($("dtf_dep_plancha_precio"));
    const depVida = Math.max(1, num($("dtf_dep_plancha_vida")));
    if ($("dtf_dep_on")?.checked){
      dep_ud = depPrecio / depVida;
    } else {
      dep_ud = 0;
    }
    $("dtf_dep_plancha_ud") && ($("dtf_dep_plancha_ud").value = fmt(dep_ud));
    // Conteo de estampados
    let estampados_calc = 0;
    try{
      if(window.dtf_estampados_cache!=null) estampados_calc = window.dtf_estampados_cache;
    }catch(e){}
    dep_total = dep_ud * Math.max(0, estampados_calc);

    const sinGI = directos + extras + prenda_total + dep_total;

    // Ganancia / Impuestos
    const useG = $("dtf_chk_ganancia").checked;
    const useI = $("dtf_chk_impuestos").checked;
    const gPct = useG ? num($("dtf_ganancia"))/100 : 0;
    const iPct = useI ? num($("dtf_impuestos"))/100 : 0;

    const subtotal = sinGI;
    const gVal = subtotal * gPct;
    const iVal = (subtotal + gVal) * iPct;
    const total = subtotal + gVal + iVal;

    $("dtf_total_directos").textContent = fmt(directos);
    $("dtf_total_extras").textContent   = fmt(extras);
    // --- Cálculos unitarios y costo por camiseta ---
    try{
      const cont = document.getElementById("dtf_bloques");
      let N = 0;
      if(cont && cont.children.length){
        cont.querySelectorAll('.card.md-12').forEach(card=>{
          const id = card.querySelector('[data-remove]')?.getAttribute('data-remove');
          N += parseFloat(document.getElementById('dtf_n'+id)?.value||"0")||0;
        });
      }else{
        N = parseFloat(document.getElementById("dtf_n")?.value||"0")||0;
      }
      const envio = parseFloat(document.getElementById("dtf_extra_envio")?.value||"0")||0;
      const dis   = parseFloat(document.getElementById("dtf_extra_diseno")?.value||"0")||0;
      const otros = parseFloat(document.getElementById("dtf_extra_otros")?.value||"0")||0;
      const pla   = parseFloat(document.getElementById("dtf_extra_plancha")?.value||"0")||0;
      const extras_unit = N>0 ? ((envio+dis+otros)/N) : 0;
      const perDTF = N>0 ? (directos/N) : 0;
      const costo_ud_dtf = perDTF + extras_unit + pla;
      const costo_camiseta = prenda_ud + dep_ud + costo_ud_dtf;
      const el1 = document.getElementById("dtf_costo_ud_dtf");
      const el2 = document.getElementById("dtf_costo_por_camiseta");
      el1 && (el1.textContent = fmt(costo_ud_dtf));
      el2 && (el2.textContent = fmt(costo_camiseta));
    }catch(e){}
    $("dtf_total_prenda") && ($("dtf_total_prenda").textContent = fmt(prenda_total));
    $("dtf_total_dep") && ($("dtf_total_dep").textContent = fmt(dep_total));
    $("dtf_subtotal_no_gi").textContent = fmt(sinGI);
    $("dtf_subtotal").textContent       = fmt(subtotal);
    $("dtf_ganancia_val").textContent   = fmt(gVal);
    $("dtf_impuestos_val").textContent  = fmt(iVal);
    $("dtf_total").textContent          = fmt(total);

    // Actualizar Resumen General línea DTF si existe (se usa el Precio de Venta final)
    const sum_dtf = document.getElementById("sum_dtf");
    if(sum_dtf) sum_dtf.textContent = fmt(total);
    // Cache estampados estimados para otros cálculos
    try{ window.dtf_estampados_cache = (function(){
      // Si se usó cálculo por múltiples diseños, sumamos cantidades
      const cont = document.getElementById("dtf_bloques");
      if(cont && cont.children.length){
        let e=0;
        cont.querySelectorAll('.card.md-12').forEach(card=>{
          const id = card.querySelector('[data-remove]')?.getAttribute('data-remove');
          const n = parseNum(document.getElementById('dtf_n'+id)?.value)||0;
          e += n;
        });
        return e;
      }
      // fallback a N del bloque simple si estaba activo
      const nSimple = parseNum(document.getElementById("dtf_n")?.value)||0;
      return Math.max(0,nSimple);
    })(); }catch(e){}

    // Dibujar gráfico
    try{
      const canvas = document.getElementById("dtf_chart");
      const labels = ["Directos","Prendas","Deprec.","Extras","Subtotal","+Ganancia","+Impuestos","Total"];
      const subtotalChart = subtotal;
      const gValChart = gVal;
      const iValChart = iVal;
      const data = [directos, prenda_total, dep_total, extras, subtotalChart, gValChart, iValChart, total];
      drawBarChart(canvas, labels, data);
    }catch(e){}
  }

  // Modalidad cambia: ajusta precio sugerido
  $("dtf_modalidad")?.addEventListener("change", () => {
    const mod = $("dtf_modalidad").value;
    if(mod==="metro") $("dtf_precio_unit").value = "15";
    else if(mod==="tramo30") $("dtf_precio_unit").value = (15*0.3).toFixed(2);
    else if(mod==="a3") $("dtf_precio_unit").value = "5";
    recompute();
  });

  // Mostrar/ocultar cálculo por diseños
  $("dtf_calc_por_diseno")?.addEventListener("change", () => {
    const on = $("dtf_calc_por_diseno").checked;
    $("dtf_por_diseno").style.display = on ? "block" : "none";
    recompute();
  });

  // Inputs que disparan cálculo
  ["dtf_precio_unit","dtf_resp_min","dtf_largo_cm","dtf_n","dtf_w","dtf_h","dtf_prenda_on","dtf_prenda_cant","dtf_prenda_precio","dtf_dep_on","dtf_dep_plancha_precio","dtf_dep_plancha_vida",
   "dtf_extra_envio","dtf_extra_diseno","dtf_extra_plancha","dtf_extra_otros",
   "dtf_chk_ganancia","dtf_ganancia","dtf_chk_impuestos","dtf_impuestos"].forEach(id=>{
    const el = $(id); el && el.addEventListener("input", recompute);
    el && el.addEventListener("change", recompute);
  });

  // Botones
  $("btn_reset_dtf")?.addEventListener("click", ()=>{
    $("dtf_modalidad").value = "metro";
    $("dtf_precio_unit").value = "15";
    $("dtf_resp_min").checked = true;
    $("dtf_largo_cm").value = "0";
    $("dtf_calc_por_diseno").checked = false;
    $("dtf_por_diseno").style.display = "none";
    $("dtf_n").value = "1"; $("dtf_w").value="10"; $("dtf_h").value="10";
    $("dtf_extra_envio").value="0"; $("dtf_extra_diseno").value="0";
    $("dtf_extra_plancha").value="0"; $("dtf_extra_otros").value="0";
    $("dtf_chk_ganancia").checked=true; $("dtf_ganancia").value="40";
    $("dtf_chk_impuestos").checked=true; $("dtf_impuestos").value="16";
    recompute();
  });

$("btn_reset_dtf")?.addEventListener("click", ()=>{
  // Reset valores numéricos a defaults suaves
  $("dtf_modalidad").value = "metro";
  $("dtf_precio_unit").value = "15";
  $("dtf_largo_cm").value = "0";
  $("dtf_n").value = "1"; $("dtf_w").value="10"; $("dtf_h").value="10";
  $("dtf_extra_envio").value="0"; $("dtf_extra_diseno").value="0";
  $("dtf_extra_plancha").value="0"; $("dtf_extra_otros").value="0";
  $("dtf_ganancia").value="40"; $("dtf_impuestos").value="16";
  $("dtf_prenda_cant").value="0"; $("dtf_prenda_precio").value="0";
  $("dtf_dep_plancha_precio").value="400"; // Panel de vista previa
  const panelTipo = document.getElementById("dtf_panel_tipo");
  if(panelTipo) panelTipo.value = "metro";
  const pw = document.getElementById("dtf_panel_w");
  const ph = document.getElementById("dtf_panel_h");
  if(pw) pw.value = "57"; if(ph) ph.value = "100";
  const sep = document.getElementById("dtf_sep"); if(sep) sep.value = "0.5";

  // Apagar TODOS los checkboxes dentro del módulo DTF
  const view = document.getElementById("view-dtf");
  if(view){
    view.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
  }

  // Ocultar el panel simple por diseño si estaba visible
  const porDis = document.getElementById("dtf_por_diseno");
  if(porDis) porDis.style.display = "none";

  // Vaciar bloques múltiples
  const bloques = document.getElementById("dtf_bloques");
  if(bloques) bloques.innerHTML = "";

  // Recalcular
  if(typeof recompute === "function") recompute();
});

$("btn_copy_dtf")?.addEventListener("click", ()=>{
    const txt = [
      "DTF (terceros)",
      "Proveedor: "+($("#dtf_proveedor")?.value||"-"),
      "Modalidad: "+($("#dtf_modalidad")?.selectedOptions?.[0]?.text||"-"),
      "Precio por unidad: "+($("#dtf_precio_unit")?.value||"0"),
      "Unidades cobradas: "+($("#dtf_unidades")?.textContent||"0"),
      "Total directos: "+($("#dtf_total_directos")?.textContent||"$0.00"),
      "Extras: "+($("#dtf_total_extras")?.textContent||"$0.00"),
      "Subtotal sin G/I: "+($("#dtf_subtotal_no_gi")?.textContent||"$0.00"),
      "Subtotal: "+($("#dtf_subtotal")?.textContent||"$0.00"),
      "+ Ganancia: "+($("#dtf_ganancia_val")?.textContent||"$0.00"),
      "+ Impuestos: "+($("#dtf_impuestos_val")?.textContent||"$0.00"),
      "Precio de Venta: "+($("#dtf_total")?.textContent||"$0.00")
    ].join("\n");
    copyText(txt);
  });

  $("btn_print_dtf")?.addEventListener("click", ()=>{
    const old = document.querySelectorAll(".view.active");
    old.forEach(v=>v.classList.remove("active"));
    const v = document.getElementById("view-dtf");
    v && v.classList.add("active");
    window.print();
  });

  // Inicial
  recompute();
})();

// ============ Resumen General — integrar DTF ============
(() => {
  const $ = (id)=>document.getElementById(id);
  // Extiende suma total para incluir DTF si está marcado
  const sumHook = () => {
    const parseMoney = (t)=>parseNum((t||"").toString().replace(/[^0-9.,-]/g,''));
    const inc = (id, onId) => ($(onId)?.checked ? parseMoney($(id)?.textContent||"0") : 0);
    // Los elementos existentes ya hacen su suma; ajustamos si hay total general en pantalla
    const totalEl = $("sum_total");
    if(!totalEl) return;
    // Recupera el total actual mostrado (puede haber sido calculado por otro bloque)
    // y ajusta sumando DTF si corresponde. Por seguridad, recalculamos desde cero con lo que exista.
    let t = 0;
    t += inc("sum_vinil","sum_incluir_vinil");
    t += inc("sum_sublim","sum_incluir_sublim");
    t += inc("sum_etiq","sum_incluir_etiq");
    t += inc("sum_emp","sum_incluir_emp");
    t += inc("sum_env","sum_incluir_env");
    t += inc("sum_dtf","sum_incluir_dtf");
    totalEl.textContent = '$ ' + fmtEU(isFinite(t)?t:0);
  };

  ["sum_incluir_vinil","sum_incluir_sublim","sum_incluir_etiq","sum_incluir_emp","sum_incluir_env","sum_incluir_dtf"].forEach(id=>{
    const el = document.getElementById(id);
    el && el.addEventListener("change", sumHook);
  });

  // Observa cambios de totales individuales
  const obs = new MutationObserver(sumHook);
  ["sum_vinil","sum_sublim","sum_etiq","sum_emp","sum_env","sum_dtf"].forEach(id=>{
    const el = document.getElementById(id);
    el && obs.observe(el,{childList:true,subtree:true,characterData:true});
  });
  sumHook();
})();

// === Helpers: draw a simple bar chart on a canvas (no external libs) ===
function drawBarChart(canvas, labels, data){
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = '#f9fafb';
  ctx.fillRect(0,0,W,H);
  // Axes padding
  const padL = 50, padR = 20, padT = 20, padB = 40;
  const plotW = W - padL - padR, plotH = H - padT - padB;
  // Grid
  ctx.strokeStyle = '#e5e7eb';
  ctx.lineWidth = 1;
  const maxV = Math.max(1, Math.max.apply(null, data));
  const steps = 4;
  for(let i=0;i<=steps;i++){
    const y = padT + plotH - (i/steps)*plotH;
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+plotW,y); ctx.stroke();
    const v = (maxV*i/steps);
    ctx.fillStyle='#6b7280'; ctx.font='12px sans-serif';
    ctx.fillText('$'+v.toFixed(0), 6, y+4);
  }
  // Bars
  const n = data.length;
  const barW = Math.max(10, plotW/(n*1.5));
  const gap = (plotW - n*barW)/(n-1>0?(n-1):1);
  data.forEach((v,i)=>{
    const x = padL + i*(barW+gap);
    const h = (v/maxV)*plotH;
    const y = padT + plotH - h;
    ctx.fillStyle = '#7aa2ff'; // auto color (kept simple)
    ctx.fillRect(x,y,barW,h);
    ctx.fillStyle='#111'; ctx.font='12px sans-serif';
    ctx.save(); ctx.translate(x+barW/2, H-8); ctx.rotate(-Math.PI/8);
    ctx.textAlign='center'; ctx.fillText(labels[i],0,0); ctx.restore();
  });
}

// === DTF module extensions ===
(() => {
  const $ = (id) => document.getElementById(id);
  const fmt = (n)=>'$ ' + fmtEU(isFinite(n)?n:0);
  const num = (el)=>parseNum(el?.value);
  const clamp = (n)=>isFinite(n)?n:0;
  const ANCHO_CM = 57;

  // ---- Múltiples diseños ----
  let dtf_counter = 0;
  const bloques = $("dtf_bloques");
  function blockHTML(id){
    return `
    <div class="calc-block" id="dtf_block${id}" style="border:1px solid #eee;border-radius:12px;padding:12px;background:#fff">
      <div class="row" style="align-items:center;justify-content:space-between">
        <label style="margin:0">Diseño</label>
        <button class="copy-btn" data-remove="${id}">Eliminar</button>
      </div>
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <div style="min-width:150px;flex:1">
          <label>Ancho (cm)</label>
          <input type="number" id="dtf_w${id}" step="0.1" min="0" value="10"/>
        </div>
        <div style="min-width:150px;flex:1">
          <label>Alto (cm)</label>
          <input type="number" id="dtf_h${id}" step="0.1" min="0" value="10"/>
        </div>
        <div style="min-width:150px;flex:1">
          <label>Cantidad</label>
          <input type="number" id="dtf_n${id}" step="1" min="1" value="1"/>
        </div>
      </div>
    </div>`;
  }
  function addBlock(){
    dtf_counter++;
    const id = dtf_counter;
    const div = document.createElement('div');
    div.className='card md-12';
    div.innerHTML = blockHTML(id);
    bloques.appendChild(div);
    // listeners
    ["dtf_w"+id,"dtf_h"+id,"dtf_n"+id].forEach(k=>{
      const el = document.getElementById(k);
      el && el.addEventListener('input', recomputeDTF_Ext);
      el && el.addEventListener('change', recomputeDTF_Ext);
    });
    div.querySelector('[data-remove]')?.addEventListener('click', ()=>{
      div.remove(); recomputeDTF_Ext();
    });
    recomputeDTF_Ext();
  }
  if (window.__DTF_USE_OLD__ === true) { $("dtf_add_diseno")?.addEventListener("click", addBlock); }

  // ---- Cálculo largo por múltiples diseños ----
  function largoPorBloques(){
    const cards = bloques?.querySelectorAll('.card.md-12') || [];
    let largoTotal = 0;
    let estampados = 0;
    cards.forEach(card=>{
      const id = card.querySelector('[data-remove]')?.getAttribute('data-remove');
      const w = parseNum(document.getElementById('dtf_w'+id)?.value);
      const h = parseNum(document.getElementById('dtf_h'+id)?.value);
      const n = Math.max(1, Math.floor(parseNum(document.getElementById('dtf_n'+id)?.value)));
      if(w>0 && h>0 && n>0){
        const cols = Math.max(1, Math.floor(ANCHO_CM / Math.max(1,w)));
        const filas = Math.ceil(n / cols);
        largoTotal += filas * h;
        estampados += n;
      }
    });
    return {largoTotal, estampados};
  }

  // Hook original recompute to include prenda + depreciación + multi-diseños + chart
  const oldRecompute = window.recompute || null; // in case
  function recomputeDTF_Ext(){
    const respMin = $("dtf_resp_min")?.checked;
    const mod = $("dtf_modalidad")?.value;

    // Largo base del input
    let largo = num($("dtf_largo_cm"));

    // Si hay bloques, usamos su cálculo (sobrescribe)
    const res = largoPorBloques();
    if(res.largoTotal>0){
      largo = res.largoTotal;
      $("dtf_largo_cm").value = String(largo.toFixed(1));
    }

    // Unidades cobradas según modalidad (reutiliza lógica existente)
    // Encontrar función ya definida en el otro bloque
  }
  window.recomputeDTF_Ext = recomputeDTF_Ext;

  // Interceptar la función recompute original del módulo DTF anterior
  // Buscamos por el texto único dtf_unidades en listeners para ubicar el scope.
  // En su lugar, re-ejecutamos el cálculo original y luego extendemos.
})();

// ===== DTF Layout Preview (57 cm width) =====
(() => {
  const $ = (id)=>document.getElementById(id);
  const ANCHO_CM = 57;

  function collectDesigns(){
    const cont = $("dtf_bloques");
    const items = [];
    cont?.querySelectorAll('.card.md-12').forEach(card=>{
      const id = card.querySelector('[data-remove]')?.getAttribute('data-remove');
      const w = parseNum(document.getElementById('dtf_w'+id)?.value) || 0;
      const h = parseNum(document.getElementById('dtf_h'+id)?.value) || 0;
      const n = Math.max(0, Math.floor(parseNum(document.getElementById('dtf_n'+id)?.value) || 0));
      if(w>0 && h>0 && n>0){
        items.push({w,h,n});
      }
    });
    return items;
  }

  // Simple shelf-packing (no rotación), left-to-right, top-to-bottom
  function packShelf(items, panelH, sep){
    // Expand items list (could be large; still fine for our use)
    const list = [];
    items.forEach(it=>{ for(let i=0;i<it.n;i++) list.push({w:it.w, h:it.h}); });
    // Sort by height desc then width desc (heuristic)
    list.sort((a,b)=> (b.h - a.h) || (b.w - a.w));

    const placements = [];
    let x=0, y=0, rowH=0;
    const W = ANCHO_CM;

    let unplaced = 0;
    for(const r of list){
      if(r.w > W){ unplaced++; continue; } // too wide
      if(x===0){ // new row
        if(y + r.h > panelH + 1e-6){ unplaced++; continue; }
        placements.push({x:0, y, w:r.w, h:r.h});
        x = r.w + sep;
        rowH = Math.max(rowH, r.h);
      }else{
        if(x + r.w <= W + 1e-6){
          if(y + r.h > panelH + 1e-6){ unplaced++; continue; }
          placements.push({x, y, w:r.w, h:r.h});
          x += r.w + sep;
          rowH = Math.max(rowH, r.h);
        }else{
          // next row
          y += rowH + sep;
          if(y + r.h > panelH + 1e-6){ unplaced++; continue; }
          placements.push({x:0, y, w:r.w, h:r.h});
          x = r.w + sep;
          rowH = r.h;
        }
      }
    }
    const usedH = placements.length ? (placements[placements.length-1].y + rowH) : 0;
    return {placements, usedH, unplaced};
  }

  function drawLayout(canvas, panelH, placements, sep){
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const Wpx = canvas.width, Hpx = canvas.height;
    ctx.clearRect(0,0,Wpx,Hpx);

    // Scale so that 57cm width fits horizontally, and panelH fits vertically
    const sx = Wpx / ANCHO_CM;
    const sy = Hpx / Math.max(panelH,1);
    const s = Math.min(sx, sy);

    // Background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,Wpx,Hpx);

    // Panel border
    ctx.strokeStyle = '#111';
    ctx.lineWidth = 2;
    ctx.strokeRect(0, 0, ANCHO_CM*s, panelH*s);

    // Draw placements
    let idx = 0;
    for(const p of placements){
      const x = p.x*s;
      const y = p.y*s;
      const w = p.w*s;
      const h = p.h*s;
      // fill
      const hue = (idx*47)%360;
      ctx.fillStyle = `hsl(${hue} 70% 70%)`;
      ctx.fillRect(x,y,w,h);
      // border
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 1;
      ctx.strokeRect(x,y,w,h);
      // label
      ctx.fillStyle = '#111';
      ctx.font = '12px sans-serif';
      ctx.fillText(`${p.w}×${p.h}`, x+4, y+14);
      idx++;
    }

    // Rulers text
    ctx.fillStyle = '#6b7280';
    ctx.font = '12px sans-serif';
    ctx.fillText('57 cm', (ANCHO_CM*s)/2 - 18, Hpx - 6);
    ctx.save();
    ctx.rotate(-Math.PI/2);
    ctx.fillText(panelH+' cm', - (panelH*s)/2 - 18, 12);
    ctx.restore();
  }

  function generatePreview(){
    const items = collectDesigns();
    const sep = parseNum($("dtf_sep")?.value) || 0;
    const panelH = parseNum($("dtf_panel_h")?.value) || 100;

    const res = packShelf(items, panelH, sep);
    drawLayout($("dtf_layout"), panelH, res.placements, sep);

    // Actualiza info y largo
    const info = `Colocados: ${res.placements.length} elementos • Sin colocar: ${res.unplaced} • Alto usado: ${res.usedH.toFixed(1)} cm`;
    $("dtf_layout_info").textContent = info;
    // Si cabe dentro del panel, actualizamos largo de pedido al alto usado (o al panel si prefieres)
    if(res.usedH>0){
      $("dtf_largo_cm").value = String(Math.min(res.usedH, panelH).toFixed(1));
      const evt = new Event('input'); $("dtf_largo_cm").dispatchEvent(evt);
    }
  }

  $("dtf_preview_btn")?.addEventListener('click', generatePreview);

  // Preset solicitado por Daniel: 10×(10×10), 20×(8×8), 1×(25×35), separación 0.5, panel 100
  $("dtf_preset_demo")?.addEventListener('click', ()=>{
    const cont = $("dtf_bloques");
    cont.innerHTML = "";
    // helper to add block
    function add(w,h,n){
      const e = document.createElement('div');
      e.className='card md-12';
      const id = (window.dtf_counter = (window.dtf_counter||0) + 1);
      e.innerHTML = `
        <div class="calc-block" id="dtf_block${id}" style="border:1px solid #eee;border-radius:12px;padding:12px;background:#fff">
          <div class="row" style="align-items:center;justify-content:space-between">
            <label style="margin:0">Diseño</label>
            <button class="copy-btn" data-remove="${id}">Eliminar</button>
          </div>
          <div class="row" style="gap:12px;flex-wrap:wrap">
            <div style="min-width:150px;flex:1">
              <label>Ancho (cm)</label>
              <input type="number" id="dtf_w${id}" step="0.1" min="0" value="${w}"/>
            </div>
            <div style="min-width:150px;flex:1">
              <label>Alto (cm)</label>
              <input type="number" id="dtf_h${id}" step="0.1" min="0" value="${h}"/>
            </div>
            <div style="min-width:150px;flex:1">
              <label>Cantidad</label>
              <input type="number" id="dtf_n${id}" step="1" min="1" value="${n}"/>
            </div>
          </div>
        </div>`;
      cont.appendChild(e);
      ["dtf_w"+id,"dtf_h"+id,"dtf_n"+id].forEach(k=>{
        const el = document.getElementById(k);
        el && el.addEventListener('input', ()=>{});
        el && el.addEventListener('change', ()=>{});
      });
      e.querySelector('[data-remove]')?.addEventListener('click', ()=>{ e.remove(); });
    }
    add(10,10,10);
    add(8,8,20);
    add(25,35,1);
    $("dtf_sep").value = "0.5";
    $("dtf_panel_h").value = "100";
  });

  // Auto preview when changing key params
  ["dtf_sep","dtf_panel_h"].forEach(id=>{
    const el = $(id);
    el && el.addEventListener('input', ()=>{});
    el && el.addEventListener('change', ()=>{});
  });

})();
</script>
<style>
/* THEME TOKENS */
:root{
  --bg: #f6f7fb;
  --text: #1b2430;
  --muted: #6b7280;
  --card: #ffffff;
  --card-border: #e5e7eb;
  --pill: #eef2ff;
  --pill-text: #1e293b;
  --accent: #2563eb;
  --accent-contrast: #ffffff;
  --danger: #ef4444;
  --input-bg: #ffffff;
  --input-border: #d1d5db;
  --shadow: 0 6px 18px rgba(2,6,23,.08);
}
html[data-theme="dark"]{
  --bg: #0f172a;            /* slate-900 */
  --text: #e5e7eb;
  --muted: #94a3b8;
  --card: #111827;          /* gray-900 */
  --card-border: #1f2937;   /* gray-800 */
  --pill: #111827;
  --pill-text: #e5e7eb;
  --accent: #60a5fa;        /* blue-400 */
  --accent-contrast: #0b1220;
  --danger: #f87171;
  --input-bg: #0b1220;
  --input-border: #1f2937;
  --shadow: 0 8px 24px rgba(0,0,0,.45);
}

/* APPLY TOKENS */
body{ background: var(--bg); color: var(--text); }
.card{ background: var(--card) !important; border:1px solid var(--card-border); box-shadow: var(--shadow); }
label, .muted{ color: var(--muted); }
input[type=number], input[type=text], select{
  background: var(--input-bg); color: var(--text); border:1px solid var(--input-border);
  border-radius: 10px; padding: 6px 10px;
}
input:disabled, select:disabled{ opacity:.6; cursor:not-allowed; }
button, .copy-btn, .btn{
  background: var(--accent); color: var(--accent-contrast); border:none; border-radius: 10px; padding: 8px 12px; font-weight:600;
}
button.reset{ background: transparent; color: var(--text); border:1px dashed var(--muted); }
button:hover{ filter: brightness(1.05); }
.pill{ background: var(--pill); color: var(--pill-text); border:1px solid var(--card-border); }
.sep{ border-bottom:1px dashed var(--card-border); opacity:.65; }
.excluded{ opacity: .55; filter: grayscale(15%); }

/* Focus & selection */
:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; border-radius: 8px; }
::selection{ background: var(--accent); color: var(--accent-contrast); }

/* Views behavior */
.view{ display:none; }
.view.active{ display:block; }

/* Scrollbar (WebKit) */
*::-webkit-scrollbar{ width:10px; height:10px; }
*::-webkit-scrollbar-thumb{ background: var(--card-border); border-radius: 12px; }
html[data-theme="dark"] *::-webkit-scrollbar-thumb{ background:#293445; }

/* === Vinil summary helpers === */
.mono{ font-variant-numeric: tabular-nums; }
#vinil_summary strong{ transition: opacity .15s ease; }
#vinil_summary strong.upd{ opacity:.25 }
</style>
<script>
// THEME TOGGLE (Dark/Light) polished
(function(){
  const cb = document.getElementById('dark_toggle');
  const THEME_KEY = 'theme_pref';
  function apply(mode){
    document.documentElement.setAttribute('data-theme', mode==='dark' ? 'dark' : 'light');
    if(cb) cb.checked = (mode==='dark');
    try{ localStorage.setItem(THEME_KEY, mode); }catch(_){}
  }
  const saved = (localStorage.getItem(THEME_KEY)||'').toLowerCase();
  apply(saved || (window.matchMedia && matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
  if(cb){
    cb.addEventListener('change', ()=> apply(cb.checked ? 'dark' : 'light'));
  }
})();

// NAV (init seguro + persistencia de última vista)
// - Primera apertura: Instrucciones
// - Siguientes aperturas: última vista guardada
(function(){
  const DEFAULT_VIEW = 'instrucciones';
  const LAST_KEY = 'last_view';
  const SEEN_KEY = 'Suite.has_opened';

  function ready(fn){
    if (document.readyState !== 'loading') fn();
    else document.addEventListener('DOMContentLoaded', fn);
  }

  function setLast(view){
    try{
      localStorage.setItem(LAST_KEY, view);
      localStorage.setItem(SEEN_KEY, '1');
    }catch(_){}
  }

  function getInitial(){
    try{
      const seen = localStorage.getItem(SEEN_KEY);
      const last = (localStorage.getItem(LAST_KEY) || '').trim();
      if (!seen) return DEFAULT_VIEW;
      return last || DEFAULT_VIEW;
    }catch(_){ return DEFAULT_VIEW; }
  }

  function show(view){
    // Ocultar todas las vistas
    document.querySelectorAll('.view').forEach(v=>{ v.style.display='none'; v.classList.remove('active'); });

    // Mostrar la vista destino
    const sec = document.getElementById('view-' + view);
    if (sec){
      sec.style.display = '';
      sec.classList.add('active');
    }else if (window.selectView && typeof window.selectView === 'function'){
      // Fallback: usar el router del drawer si existe
      try{ window.selectView(view); }catch(_){}
    }

    // Si la vista aún no existe (por inyección tardía), reintentar una vez en el siguiente tick.
    // Si sigue sin existir, volver a la vista por defecto para evitar pantalla en blanco.
    if (!document.getElementById('view-' + view)){
      setTimeout(()=>{
        const late = document.getElementById('view-' + view);
        if (late){
          document.querySelectorAll('.view').forEach(v=>{ v.style.display='none'; v.classList.remove('active'); });
          late.style.display='';
          late.classList.add('active');
          setLast(view);
        }else if (view !== DEFAULT_VIEW){
          show(DEFAULT_VIEW);
        }
      }, 0);
      return;
    }

    // Estado visual en nav (si existe)
    document.querySelectorAll('#nav button').forEach(b=>b.classList.remove('active'));
    const btn = document.querySelector('#nav button[data-view="' + view + '"]');
    if (btn) btn.classList.add('active');

    setLast(view);
  }

  ready(function(){
    // Bind nav buttons (si existen)
    document.querySelectorAll('#nav button[data-view]').forEach(btn=>{
      btn.addEventListener('click', ()=>show(btn.getAttribute('data-view')));
    });

    // Vista inicial (defer): permite que vistas inyectadas en DOMContentLoaded (ej: Producto personalizable) existan antes de mostrar
    setTimeout(()=>show(getInitial()), 0);
  });
})();


// Helpers
const debounce = (fn, ms=180) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
function num(v){ return parseFloat(v)||0; }
function clamp0(n){ return isFinite(n) && n>=0 ? n : 0; }
function fmtUSD(n){ return '$ ' + fmtEU(n); }

// ENVIOS (fix V19 EU)
(function(){
  function parseEU(v){
    if (v == null) return 0;
    let s = String(v);
    if (typeof v === 'object' && v) s = (v.value ?? v.textContent ?? '').toString();
    s = s.trim().replace(/[^0-9.,-]/g, '');
    if (!s) return 0;
    if (s.includes(',')) s = s.replace(/\./g,'').replace(',', '.');
    const n = parseFloat(s);
    return isFinite(n) ? n : 0;
  }
  function clamp0(n){ n = +n; return isFinite(n) && n>0 ? n : 0; }
  const fmtIntl = (Intl && Intl.NumberFormat) ? new Intl.NumberFormat('de-DE', {minimumFractionDigits:2, maximumFractionDigits:2}) : null;
  function moneyEU(n){
    n = isFinite(n) ? +n : 0;
    if (fmtIntl) return '$ ' + fmtIntl.format(n);
    const s = n.toFixed(2), p = s.split('.'); return '$ ' + p[0].replace(/\B(?=(\d{3})+(?!\d))/g,'.') + ',' + p[1];
  }
  function setText(id, n){ const el=document.getElementById(id); if(el) el.textContent = moneyEU(n); }

  function calc(){
    const on  = !!document.getElementById('env_mensajeria_on')?.checked;
    const base= clamp0(parseEU(document.getElementById('env_base')));
    const km  = clamp0(parseEU(document.getElementById('env_km')));
    const tkm = clamp0(parseEU(document.getElementById('env_tarifa_km')));
    const kg  = clamp0(parseEU(document.getElementById('env_kg')));
    const tkg = clamp0(parseEU(document.getElementById('env_tarifa_kg')));
    const mens = on ? (base + km*tkm + kg*tkg) : 0;

    const embOn = !!document.getElementById('env_embalaje_on')?.checked;
    const fraOn = !!document.getElementById('env_fragil_on')?.checked;
    const segOn = !!document.getElementById('env_seguro_on')?.checked;
    const emb   = embOn ? clamp0(parseEU(document.getElementById('env_embalaje'))) : 0;
    const fra   = fraOn ? clamp0(parseEU(document.getElementById('env_fragil'))) : 0;
    const pct   = segOn ? clamp0(parseEU(document.getElementById('env_seguro_pct'))) : 0;
    const otros = clamp0(parseEU(document.getElementById('env_otros')));
    const segVal= segOn ? ( (mens + emb + fra + otros) * (pct/100) ) : 0;
    const extras= emb + fra + segVal + otros;

    setText('env_total_mensajeria', mens);
    setText('env_total_extras', extras);
    setText('env_total', mens + extras);
    try{ if (typeof window.resumen_update === 'function') window.resumen_update(); }catch(_){}
  }

  function syncDisabled(){
    const on  = !!document.getElementById('env_mensajeria_on')?.checked;
    ['env_base','env_km','env_tarifa_km','env_kg','env_tarifa_kg'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.disabled = !on;
    });
    const embOn = !!document.getElementById('env_embalaje_on')?.checked;
    const fraOn = !!document.getElementById('env_fragil_on')?.checked;
    const segOn = !!document.getElementById('env_seguro_on')?.checked;
    const e=document.getElementById('env_embalaje'); if(e) e.disabled = !embOn;
    const f=document.getElementById('env_fragil');  if(f) f.disabled = !fraOn;
    const s=document.getElementById('env_seguro_pct'); if(s) s.disabled = !segOn;
  }

  function onInput(e){
    const ids = new Set(['env_mensajeria_on','env_km','env_base','env_tarifa_km','env_kg','env_tarifa_kg','env_embalaje_on','env_fragil_on','env_seguro_on','env_embalaje','env_fragil','env_seguro_pct','env_otros']);
    const t = e && e.target && e.target.id;
    if (t && !ids.has(t)) return;
    syncDisabled(); calc();
  }

  ['env_mensajeria_on','env_km','env_base','env_tarifa_km','env_kg','env_tarifa_kg','env_embalaje_on','env_fragil_on','env_seguro_on','env_embalaje','env_fragil','env_seguro_pct','env_otros']
    .forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener('input', onInput); el.addEventListener('change', onInput); }});

  document.getElementById('btn_copy_env')?.addEventListener('click', ()=>{
    const t = document.getElementById('env_total')?.textContent || '$ 0,00';
    try{ navigator.clipboard.writeText(t); }catch(_){}
  });
  document.getElementById('btn_print_env')?.addEventListener('click', ()=>window.print());
  document.getElementById('btn_reset_env')?.addEventListener('click', ()=>{
    const defaults = {
      env_mensajeria_on: false, env_km: 0, env_base: 0, env_tarifa_km: 0, env_kg: 0, env_tarifa_kg: 0,
      env_embalaje_on: false, env_fragil_on: false, env_seguro_on: false,
      env_embalaje: 0, env_fragil: 0, env_seguro_pct: 0, env_otros: 0
    };
    Object.keys(defaults).forEach(k=>{
      const el=document.getElementById(k);
      if (!el) return;
      if (el.type==='checkbox') el.checked = !!defaults[k];
      else el.value = defaults[k];
    });
    syncDisabled(); calc();
  });

  window.addEventListener('load', ()=>{ syncDisabled(); calc(); });
})();// Validation for numbers: >=0 and normalize
(function(){
  const onInput = debounce((e)=>{
    const el = e.target;
    if(!el || el.type!=='number') return;
    if(el.value === '') return;
    el.value = clamp0(parseFloat((el.value||'').toString().replace(',', '.')));
  }, 100);
  document.addEventListener('input', onInput);
  document.addEventListener('change', (e)=>{
    const el = e.target; if(!el || el.type!=='number') return;
    el.value = clamp0(parseFloat((el.value||'').toString().replace(',', '.')));
  });
})();

// RESUMEN totals incl. Envios
(function(){
  function readUSD(sel){
  const el = document.querySelector(sel);
  if(!el) return 0;
  const raw = (el.textContent || el.value || "").trim();
  if(!raw) return 0;
  // Mantener sólo dígitos, coma y punto; luego normalizar
  let s = raw.replace(/[^0-9.,-]/g, "");
  const hasDot = s.indexOf(".") !== -1;
  const hasComma = s.indexOf(",") !== -1;
  if (hasDot && hasComma) { // 1.234,56
    s = s.replace(/\./g, "").replace(/,/g, ".");
  } else if (hasComma && !hasDot) { // 1234,56
    s = s.replace(/,/g, ".");
  } // sólo punto o entero -> queda igual
  const v = parseFloat(s);
  return isNaN(v) ? 0 : v;
}
  function readVin(){ const el=document.getElementById('totalFinal'); if(!el) return 0; const raw=(el.textContent||'').replace(/[^0-9.,-]/g,'').replace(/,/g,''); return parseFloat(raw)||0; }
  function readEnv(){
    const g=(id)=>parseFloat(document.getElementById(id)?.value)||0;
    const on=(id)=>document.getElementById(id)?.checked;
    const base=g('env_base'), km=g('env_km'), tkm=g('env_tarifa_km'), kg=g('env_kg'), tkg=g('env_tarifa_kg');
    const mens=on('env_mensajeria_on')?(base+km*tkm+kg*tkg):0;
    const exEmbal=on('env_embalaje_on')?g('env_embalaje'):0;
    const exFrag=on('env_fragil_on')?g('env_fragil'):0;
    const exSeguro=on('env_seguro_on')?((mens+exEmbal+exFrag)*(g('env_seguro_pct')/100)):0;
    const exOtros=g('env_otros');
    return mens+exEmbal+exFrag+exSeguro+exOtros;
  }
  window.resumen_update=function(){
    const vin=readVin();
    const sub=readUSD('#sub_v15_total');
    const etq=readUSD('#eti_total');
    const emp=readUSD('#emp_total');
    const env=readEnv();
    const set=(id,v)=>{ const el=document.getElementById(id); if(el) el.textContent=fmtUSD(v); };
    set('sum_vinil',vin); set('sum_sublim',sub); set('sum_etiq',etq); set('sum_emp',emp); set('sum_env',env);
    let total=0;
    if(document.getElementById('sum_incluir_vinil')?.checked) total+=vin;
    if(document.getElementById('sum_incluir_sublim')?.checked) total+=sub;
    if(document.getElementById('sum_incluir_etiq')?.checked) total+=etq;
    if(document.getElementById('sum_incluir_emp')?.checked) total+=emp;
    if(document.getElementById('sum_incluir_env')?.checked) total+=env;
    set('sum_total',total);
    const bcv=parseFloat(document.getElementById('tasa_bcv')?.value);
    const par=parseFloat(document.getElementById('tasa_paralelo')?.value);
    const sb=document.getElementById('sum_bcv'), sp=document.getElementById('sum_par');
    if(sb) sb.textContent = isFinite(bcv)? ('Bs '+(total*bcv).toFixed(2)) : '—';
    if(sp) sp.textContent = isFinite(par)? ('Bs '+(total*par).toFixed(2)) : '—';
  };
  ['sum_incluir_vinil','sum_incluir_sublim','sum_incluir_etiq','sum_incluir_emp','sum_incluir_env'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.addEventListener('change', window.resumen_update);
  });
  document.addEventListener('input', ()=>{ try{ window.resumen_update(); }catch(_){}});
  document.addEventListener('change', ()=>{ try{ window.resumen_update(); }catch(_){}});
  window.addEventListener('load', ()=>{ try{ window.resumen_update(); }catch(_){}});
})();

// RESUMEN Copy/Print
(function(){
  const btnC = document.getElementById('btn_copy_resumen');
  if(btnC) btnC.addEventListener('click', ()=>{
    const G = id => (document.getElementById(id)?.textContent||'').trim();
    const lines = [
      `Vinil: ${G('sum_vinil')}`, `Sublimación: ${G('sum_sublim')}`, `Etiquetas: ${G('sum_etiq')}`,
      `Empaques: ${G('sum_emp')}`, `Envíos: ${G('sum_env')}`, `TOTAL: ${G('sum_total')}`
    ];
    (navigator.clipboard?.writeText||(()=>{}))(lines.join('\\n'));
  });
  document.getElementById('btn_print_resumen')?.addEventListener('click', ()=>window.print());
})();
</script>
<script>
/* == FINAL EU v8 (checkbox recompute fix) == */
(function(){
  // EU parse for parseFloat
  (function(){
    const nativeParseFloat = Number.parseFloat || parseFloat;
    const patched = function(v){
      if (typeof v === 'string'){
        v = v.trim();
        const m = v.match(/-?\d[\d\.,]*/);
        if (m) v = m[0];
        if (v.indexOf(',') !== -1){
          v = v.replace(/\./g,'').replace(',', '.');
        }
      }
      return nativeParseFloat(v);
    };
    window.parseFloat = patched;
    if (Number.parseFloat) Number.parseFloat = patched;
  })();

  function formatEU(n, minFrac){
    if (n == null || n === '' || isNaN(n)) return '';
    const d = (typeof minFrac === 'number') ? minFrac : 2;
    const raw = Number(n).toFixed(d);
    const parts = raw.split('.');
    const intp = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    const frac = parts[1] || '';
    return intp + (frac?(','+frac):'');
  }
  window.formatEU = formatEU;

  // Global EU-aware parseNum (overrides original)
  window.parseNum = function(v){
    if (typeof v === 'number') return isFinite(v)?v:0;
    if (!v) return 0;
    let s = String(v).trim();
    const m = s.match(/-?\d[\d\.,]*/);
    if (!m) return 0;
    s = m[0];
    if (s.indexOf(',') !== -1){
      s = s.replace(/\./g,'').replace(',', '.');
    }
    const n = Number.parseFloat(s);
    return isFinite(n)? n : 0;
  };

  // Inputs EU for money/rate (not quantities)
  const moneyKeys = ['usd','precio','monto','bs','bolivar','bolívar','bcv','paralelo','tasa'];
  const qtyKeys   = ['cant','cantidad','ancho','alto','largo','cm','ud','mes','unidad','px','calc-display'];
  function isMoneyLike(input){
    const t=((input.id||'')+' '+(input.name||'')+' '+(input.placeholder||'')+' '+(input.className||'')).toLowerCase();
    if (qtyKeys.some(k=>t.includes(k))) return false;
    return moneyKeys.some(k=>t.includes(k));
  }
  function setupMoneyInput(input){
    if (input.type === 'number') input.type = 'text';
    input.setAttribute('inputmode','decimal');
    input.setAttribute('autocomplete','off');
    input.dataset.euMoney='1';
    input.addEventListener('input', function(){
      const v=input.value; const cleaned=v.replace(/[^\d\.,-]/g,'');
      if (cleaned!==v) input.value=cleaned;
    });
    input.addEventListener('blur', function(){
      const val=input.value; if (!val) return;
      const num=window.parseFloat(val); if (!isNaN(num)) input.value=formatEU(num,2);
    });
  }
  function initMoneyInputs(){
    document.querySelectorAll('input').forEach(inp=>{ if (isMoneyLike(inp)) setupMoneyInput(inp); });
  }

  // Result formatting pass
  const resultIds=['equiv_paralelo','bs_bcv','bs_paralelo','usd_desde_bs','equiv_en_bcv_ext','equiv_en_paralelo_ext','valor_bs_tasa_bcv_ext',
    'diff_bs','gap_pct','sub_total_directos','sub_total_depr','sub_subtotal_no_gi','sub_subtotal','sub_ganancia_val','sub_impuestos_val','sub_total',
    'eti_sub_total_directos','eti_sub_total_depr','eti_sub_subtotal_no_gi','eti_sub_subtotal','eti_sub_ganancia_val','eti_sub_impuestos_val','eti_sub_total',
    'emp_sub_total_directos','emp_sub_total_depr','emp_sub_subtotal_no_gi','emp_sub_subtotal','emp_sub_ganancia_val','emp_sub_impuestos_val','emp_total',
    'env_total_mensajeria','env_total_extras','env_total','sum_vinil','sum_env','sum_sublim','sum_etiq','sum_emp','sum_total','sum_bcv','sum_par'];
  function eurofyAll(){
    resultIds.forEach(id=>{
      const el=document.getElementById(id); if(!el) return;
      const txt=el.textContent||'';
      el.textContent=txt.replace(/(-?\d{1,3}(?:[.,]\d{3})*(?:[.,]\d+)?|-?\d+(?:[.,]\d+)?)/g,function(m){
        if (m.indexOf(',')!==-1) return m;
        let v=m; if(/\d,\d{3}/.test(v)&&v.indexOf('.')>-1) v=v.replace(/,/g,'');
        const num=Number.parseFloat(v); if (!isFinite(num)) return m;
        let decs=2; const dm=m.match(/[.,](\d+)/); if(dm) decs=Math.min(Math.max(dm[1].length,2),4);
        return formatEU(num,decs);
      });
    });
  }

  // Resumen General (EU-aware + checkboxes)
  window.resumen_update = function(){
    const getText = id => (document.getElementById(id)?.textContent || '');
    const vin = window.parseNum(getText('totalFinal'));
    const sub = window.parseNum(getText('sub_total'));
    const etq = window.parseNum(getText('eti_total'));
    const emp = window.parseNum(getText('emp_total'));
    const readEnv = (function(){
      const g=id=>Number.parseFloat(document.getElementById(id)?.value)||0;
      const on=id=>document.getElementById(id)?.checked;
      const base=g('env_base'), km=g('env_km'), tkm=g('env_tarifa_km'), kg=g('env_kg'), tkg=g('env_tarifa_kg');
      const mens=on('env_mensajeria_on')?(base+km*tkm+kg*tkg):0;
      const exEmbal=on('env_embalaje_on')?g('env_embalaje'):0;
      const exFrag=on('env_fragil_on')?g('env_fragil'):0;
      const exSeguro=on('env_seguro_on')?((mens+exEmbal+exFrag)*(g('env_seguro_pct')/100)):0;
      const exOtros=g('env_otros');
      return mens+exEmbal+exFrag+exSeguro+exOtros;
    })();
    const env = readEnv;
    const set=(id,v)=>{ const el=document.getElementById(id); if(el) el.textContent='$ '+formatEU(isFinite(v)?v:0,2); };
    set('sum_vinil',vin); set('sum_sublim',sub); set('sum_etiq',etq); set('sum_emp',emp); set('sum_env',env);

    let total=0;
    if(document.getElementById('sum_incluir_vinil')?.checked) total+=vin;
    if(document.getElementById('sum_incluir_sublim')?.checked) total+=sub;
    if(document.getElementById('sum_incluir_etiq')?.checked) total+=etq;
    if(document.getElementById('sum_incluir_emp')?.checked) total+=emp;
    if(document.getElementById('sum_incluir_env')?.checked) total+=env;
    set('sum_total', total);

    const bcv=Number.parseFloat(document.getElementById('tasa_bcv')?.value);
    const par=Number.parseFloat(document.getElementById('tasa_paralelo')?.value);
    const sb=document.getElementById('sum_bcv'), sp=document.getElementById('sum_par');
    if (sb) sb.textContent = isFinite(bcv)? ('Bs '+formatEU(total*bcv,2)) : '—';
    if (sp) sp.textContent = isFinite(par)? ('Bs '+formatEU(total*par,2)) : '—';

    eurofyAll();
  };

  // Default checkbox states
  function initCheckboxes(){
    document.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ cb.checked=false; });
    ['sum_incluir_vinil','sum_incluir_sublim','sum_incluir_etiq','sum_incluir_emp'].forEach(id=>{ const el=document.getElementById(id); if(el) el.checked=true; });
  }

  // Reset general
  function generalReset(){
    ['btn_reset_div','btn_reset_vinil','btn_reset_sub','btn_reset_eti','btn_reset_emp','btn_reset_env'].forEach(id=>{ const b=document.getElementById(id); if(b) try{ b.click(); }catch(e){} });
    document.querySelectorAll('input[data-euMoney="1"]').forEach(inp=>{ inp.value=''; });
    initCheckboxes();
    // Recompute all modules to reflect new checkbox states
    try{ if (typeof window.sub_update === 'function') window.sub_update(); }catch(_){}
    try{ if (typeof window.eti_update === 'function') window.eti_update(); }catch(_){}
    try{ if (typeof window.emp_update === 'function') window.emp_update(); }catch(_){}
    try{ window.resumen_update(); }catch(_){}
    eurofyAll();
  }
  function initGeneralResetButton(){
    const btn=document.getElementById('btn_reset_general'); if (btn) btn.addEventListener('click', generalReset);
  }

  // Hooks
  function wrap(name){
    const f=window[name];
    if (typeof f === 'function'){
      window[name]=function(){ const r=f.apply(this, arguments); try{ window.resumen_update(); }catch(_){ } return r; };
    }
  }
  ['divisas_update','calcDirectos','calcEtiquetas','calcEmpaques','calcEnvios','calcResumenGeneral','calcSublimacion','calcVinil','calcBasica','updateResumen','updateAll'].forEach(wrap);
  let tmr=null; function schedule(){ if(tmr) clearTimeout(tmr); tmr=setTimeout(function(){ try{ window.resumen_update(); }catch(_){ } }, 120); }
  ['input','change','click'].forEach(ev=>document.addEventListener(ev, schedule, true));

  if (typeof window.fmtUSD === 'function') window.fmtUSD = n => '$ ' + formatEU(isFinite(n)?Number(n):0, 2);
  if (typeof window.fmtBs  === 'function') window.fmtBs  = n => 'Bs ' + formatEU(isFinite(n)?Number(n):0, 2);

  function init(){
    initMoneyInputs();
    initCheckboxes();
    // Recompute each module once after we changed their checkboxes programáticamente
    try{ if (typeof window.sub_update === 'function') window.sub_update(); }catch(_){}
    try{ if (typeof window.eti_update === 'function') window.eti_update(); }catch(_){}
    try{ if (typeof window.emp_update === 'function') window.emp_update(); }catch(_){}
    initGeneralResetButton();
    try{ window.resumen_update(); }catch(_){}
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>
<script>
// === Per-window Reset: ensure local checkboxes are OFF after pressing Reset ===
(function(){
  function off(ids){ ids.forEach(id=>{ const el=document.getElementById(id); if(el) el.checked=false; }); }
  function bind(btnId, ids, updater){
    const btn = document.getElementById(btnId);
    if (!btn) return;
    btn.addEventListener('click', function(){
      // Wait a tick so the native reset logic runs first (if any)
      setTimeout(function(){
        off(ids);
        try{ if (typeof updater==='function') updater(); }catch(e){}
        try{ if (typeof window.resumen_update==='function') window.resumen_update(); }catch(e){}
      }, 0);
    });
  }

  // Sublimación
  bind('btn_reset_sub', ['chk_ganancia','chk_impuestos'], function(){ if (typeof window.sub_update==='function') window.sub_update(); });

  // Etiquetas
  bind('btn_reset_eti', ['eti_chk_ganancia','eti_chk_impuestos'], function(){ if (typeof window.eti_update==='function') window.eti_update(); });

  // Empaques
  bind('btn_reset_emp', ['emp_chk_ganancia','emp_chk_impuestos'], function(){ if (typeof window.emp_update==='function') window.emp_update(); });

  // Envíos
  bind('btn_reset_env', ['env_mensajeria_on','env_embalaje_on','env_fragil_on','env_seguro_on'], function(){ if (typeof window.env_update==='function') window.env_update(); });
})();
</script>
<script>
(function(){
  function q(sel){ try{return document.querySelector(sel);}catch(e){return null;} }
  function qa(sel){ try{return Array.from(document.querySelectorAll(sel));}catch(e){return [];} }
  // EU helpers
  function parseEU(v){
    if (v==null) return 0;
    v = String(v).trim().replace(/[^\d.,-]/g,'');
    if (!v) return 0;
    if (v.indexOf(',')>=0){ v = v.replace(/\./g,'').replace(',', '.'); }
    return parseFloat(v)||0;
  }
  function fmtEU(n, dec=2){
    if (!isFinite(n)) n=0;
    const s = Number(n).toFixed(dec);
    const [a,b] = s.split('.');
    return a.replace(/\B(?=(\d{3})+(?!\d))/g,'.') + (dec?(','+b):'');
  }
  function onlyEUInput(el){
    if(!el) return;
    el.addEventListener('input', ()=>{ el.value = el.value.replace(/[^\d.,-]/g,''); });
    el.addEventListener('blur', ()=>{ el.value = fmtEU(parseEU(el.value)); });
  }
  function setMoney(el, n){ if(el) el.value = '$ ' + fmtEU(n); }
  function setText(el, n){ if(el){ el.textContent = '$ ' + fmtEU(n); } }

  // Attach EU inputs
  [q('#cd_cant'), q('#cd_precio')].forEach(onlyEUInput);
  ['impresora','plancha','pc','plotter','cuchilla'].forEach(k=>{
    onlyEUInput(q('.dep_precio[data-row="'+k+'"]'));
    const v = q('.dep_vida[data-row="'+k+'"]'); if (v) onlyEUInput(v);
  });

  function recalc(){
    // Directos (mostrar siempre; sumar solo si está activado)
    const _cde=q('#cd_enabled'); const enabled = _cde && _cde.checked ? true : false;
    const _cc=q('#cd_cant'); const cant = parseEU(_cc && _cc.value);
    const _cp=q('#cd_precio'); const precio = parseEU(_cp && _cp.value);
    const directos_calc = (cant>0) ? (precio/cant) : 0;
    setMoney(q('#cd_costo_ud'), directos_calc);
    const directos = enabled ? directos_calc : 0;

    // Depreciación (mostrar siempre; sumar solo marcados)
    let depSum = 0;
    ['impresora','plancha','pc','plotter','cuchilla'].forEach(k=>{
      const _on = q('.dep_enabled[data-row="'+k+'"]'); const on = _on && _on.checked ? true : false;
      const _p = q('.dep_precio[data-row="'+k+'"]'); const precio = parseEU(_p && _p.value);
      if (k==='cuchilla'){
        const _v = q('.dep_vida[data-row="'+k+'"]'); const vida = parseEU(_v && _v.value);
        const ud_calc = (vida>0) ? (precio/vida) : 0;
        setMoney(q('.dep_ud[data-row="'+k+'"]'), ud_calc);
        const mesEl = q('.dep_mes[data-row="'+k+'"]'); if (mesEl) setMoney(mesEl, 0);
        if (on) depSum += ud_calc;
      }else{
        const mes_calc = precio/24;
        const ud_calc = mes_calc/100;
        setMoney(q('.dep_mes[data-row="'+k+'"]'), mes_calc);
        setMoney(q('.dep_ud[data-row="'+k+'"]'), ud_calc);
        if (on) depSum += ud_calc;
      }
    });

    // Resumen vinil

    setText(q('#vinil_directos'), directos);
    setText(q('#vinil_dep'), depSum);
    // set by main updater (material): see vinil_actualizarTotal()

    const ext = q('#vinil_ext_total'); if (ext) ext.textContent = 'Adicionales vinil: $' + fmtEU(directos + depSum);
  }
  // push extras to main total
  try{ window._vinilExtras = directos + depSum; if (typeof vinil_actualizarTotal==='function') vinil_actualizarTotal(); }catch(e){} 
}

  // Bind
  ['#cd_cant','#cd_precio'].forEach(sel=>{var el=q(sel); if(el) el.addEventListener('input', recalc);});
  // Selector de producto (solo preset de precio, sin tocar cálculos)
  var _ci=q('#cd_item');
  if(_ci) _ci.addEventListener('change', function(){
    try{
      var ud = parseEU((_ci.options[_ci.selectedIndex] && _ci.options[_ci.selectedIndex].getAttribute('data-ud')) || '');
      if(isFinite(ud) && ud>0){
        var _c=q('#cd_cant'); var cant = parseEU(_c && _c.value);
        if(!(cant>0)) cant = 1;
        var total = ud * cant;
        var _p=q('#cd_precio'); if(_p) _p.value = fmtEU(total, 2);
      }
    }catch(e){}
    recalc();
  });
  var _ee=q('#cd_enabled'); if(_ee) _ee.addEventListener('change', recalc);
  var _ei=q('#cd_enabled'); if(_ei) _ei.addEventListener('input', recalc);
  qa('.dep_enabled,.dep_precio,.dep_vida').forEach(function(el){ el.addEventListener('input', recalc); });
  qa('.dep_enabled').forEach(function(el){ el.addEventListener('change', recalc); });

  // Reset de adicionales (sin afectar bloques de vinil)
  var _br=q('#btn_reset_vinil_extra'); if(_br) _br.addEventListener('click', function(){
    ['impresora','plancha','pc','plotter','cuchilla'].forEach(k=>{
      const chk = q('.dep_enabled[data-row="'+k+'"]'); if (chk) chk.checked=false;
    });
    const cd = q('#cd_enabled'); if (cd) cd.checked=false;
    recalc();
  });

  // Copiar desglose
  var _bc=q('#btn_copy_vinil'); if(_bc) _bc.addEventListener('click', function(){
    const t = `Directos: ${q('#vinil_directos').textContent}
Depreciación: ${q('#vinil_dep').textContent}
Adicionales vinil: ${q('#vinil_adicionales').textContent}`;
    navigator.clipboard.writeText(t);
  });

  // Kick + safety interval
  recalc();

})();
</script>
<script>
(function(){
  function q(sel){ try{return document.querySelector(sel);}catch(e){return null;} }
  function qa(sel){ try{return Array.prototype.slice.call(document.querySelectorAll(sel));}catch(e){return [];} }
  function parseEU(v){
    if (v==null) return 0;
    v = String(v).replace(/[^\d.,-]/g,'').trim();
    if (!v) return 0;
    if (v.indexOf(',')>=0){ v = v.replace(/\./g,'').replace(',', '.'); }
    return parseFloat(v)||0;
  }
  function fmtEU(n, dec){
    if (dec===void 0) dec=2;
    if (!isFinite(n)) n=0;
    var s = Number(n).toFixed(dec);
    var p = s.split('.');
    var a = p[0].replace(/\B(?=(\d{3})+(?!\d))/g,'.');
    return dec ? (a+','+p[1]) : a;
  }
  function setMoneyInput(el, n){ if(el){ el.value = '$ ' + fmtEU(n); } }
  function setMoneyText(el, n){ if(el){ el.textContent = '$ ' + fmtEU(n); } }

  function recalcExtras(){
    var elEnabled = q('#cd_enabled');
    var enabled = !!(elEnabled && elEnabled.checked);
    var cant = parseEU(q('#cd_cant') && q('#cd_cant').value);
    var precio = parseEU(q('#cd_precio') && q('#cd_precio').value);
    var cd_ud = (cant>0) ? (precio/cant) : 0;
    setMoneyInput(q('#cd_costo_ud'), cd_ud);
    var totalDirectos = enabled ? cd_ud : 0;

    var filas = ['impresora','plancha','pc','plotter','cuchilla'];
    var depSum = 0;
    for (var i=0;i<filas.length;i++){
      var k = filas[i];
      var on = !!(q('.dep_enabled[data-row="'+k+'"]') && q('.dep_enabled[data-row="'+k+'"]').checked);
      var precioEl = q('.dep_precio[data-row="'+k+'"]');
      var precioRow = parseEU(precioEl && precioEl.value);
      if (k==='cuchilla'){
        var vida = parseEU(q('.dep_vida[data-row="'+k+'"]') && q('.dep_vida[data-row="'+k+'"]').value);
        var udc = (vida>0) ? (precioRow/vida) : 0;
        setMoneyInput(q('.dep_ud[data-row="'+k+'"]'), udc);
        var mEl = q('.dep_mes[data-row="'+k+'"]'); if (mEl) setMoneyInput(mEl, 0);
        if (on) depSum += udc;
      }else{
        var mes = precioRow/24;
        var ud = mes/100; // changed from 300 to 100 per request
        setMoneyInput(q('.dep_mes[data-row="'+k+'"]'), mes);
        setMoneyInput(q('.dep_ud[data-row="'+k+'"]'), ud);
        if (on) depSum += ud;
      }
    }

    setMoneyText(q('#vinil_directos'), totalDirectos);
    setMoneyText(q('#vinil_dep'), depSum);
    setMoneyText(q('#vinil_adicionales'), totalDirectos + depSum);
    var ext = q('#vinil_ext_total'); if (ext) ext.textContent = 'Adicionales vinil: $ ' + fmtEU(totalDirectos + depSum);

    try {
      window._vinilExtras = totalDirectos + depSum;
      if (typeof window.vinil_actualizarTotal === 'function'){ window.vinil_actualizarTotal(); }
    } catch(e){}
  }

  if (typeof window.vinil_actualizarTotal !== 'function'){
    window.vinil_actualizarTotal = function(){
      var total = 0;
      qa('[id^="resultado"]').forEach(function(el){
        var t = (el.textContent||'').replace('Costo:','').replace(/[^0-9.,-]/g,'');
        if (t.indexOf(',')>=0){ t = t.replace(/\./g,'').replace(',', '.'); }
        total += parseFloat(t)||0;
      });
      var me = q('#margenError'); if (me && me.checked) total *= 1.2;
      var extras = (typeof window._vinilExtras==='number') ? window._vinilExtras : 0;
      var grand = total + extras;
      var lbl = q('#totalFinal'); if (lbl) lbl.textContent = 'Total Vinil: $ ' + fmtEU(grand);
    };
  }

  ['#cd_cant','#cd_precio'].forEach(function(sel){
    var el = q(sel); if(el) el.addEventListener('input', recalcExtras, false);
  });
  var _ce = q('#cd_enabled'); if (_ce){ _ce.addEventListener('change', recalcExtras, false); _ce.addEventListener('input', recalcExtras, false); }
  qa('.dep_enabled,.dep_precio,.dep_vida').forEach(function(el){ el.addEventListener('input', recalcExtras, false); });
  qa('.dep_enabled').forEach(function(el){ el.addEventListener('change', recalcExtras, false); });

  function kick(){ try{ recalcExtras(); window.vinil_actualizarTotal(); }catch(e){} }
  if (document.readyState === 'complete' || document.readyState === 'interactive'){ setTimeout(kick,0); }
  document.addEventListener('DOMContentLoaded', kick, false);
  setTimeout(kick, 200);
})();
</script>
<script>
(function(){
  function q(s){ try{return document.querySelector(s);}catch(e){return null;} }
  function qa(s){ try{return Array.prototype.slice.call(document.querySelectorAll(s));}catch(e){return [];} }
  function parseEU(v){ if(v==null) return 0; v=String(v).replace(/[^\d.,-]/g,'').trim(); if(!v) return 0; if(v.indexOf(',')>=0){ v=v.replace(/\./g,'').replace(',', '.'); } return parseFloat(v)||0; }
  function parseEUin(el){ return parseEU(el && el.value); }
  function fmtEU(n,dec){ if(dec===void 0) dec=2; if(!isFinite(n)) n=0; var s=Number(n).toFixed(dec); var p=s.split('.'); return p[0].replace(/\B(?=(\d{3})+(?!\d))/g,'.') + (dec?(','+p[1]):''); }
  function money(n){ return '$ '+fmtEU(n); }
  function setMoneyInput(el,n){ if(el){ el.value = money(n); } }
  function setMoneyText(el,n){ if(el){ el.textContent = money(n); } }

  // -------- SUBLIMACIÓN --------
  function recalcSub(){
    var cant = parseEUin(q('#d_prod_cant')), prec = parseEUin(q('#d_prod_precio'));
    var prod_ud = (cant>0)? (prec/cant) : 0; setMoneyInput(q('#d_prod_ud'), prod_ud);
    var items = ['papel','tinta','cinta','empaque']; var directos = 0; var _pon=q('#d_prod_on'); if(_pon && _pon.checked){ directos += prod_ud; }
    for (var i=0;i<items.length;i++){
      var k=items[i]; var on = !!(q('#d_'+k+'_on') && q('#d_'+k+'_on').checked);
      var udk = (function(){ var c=parseEUin(q('#d_'+k+'_cant')), p=parseEUin(q('#d_'+k+'_precio')); return (c>0)?(p/c):0; })();
      setMoneyInput(q('#d_'+k+'_ud'), udk);
      if(on) directos += udk;
    }
    setMoneyText(q('#sub_total_directos'), directos);

    var dep = 0, eq=['impresora','plancha','pc'];
    for (var j=0;j<eq.length;j++){
      var e=eq[j]; var onE=!!(q('#e_'+e+'_on')&&q('#e_'+e+'_on').checked);
      var pE=parseEUin(q('#e_'+e+'_precio')); var mes=pE/24; var ud=mes/100;
      setMoneyInput(q('#e_'+e+'_mes'), mes); setMoneyInput(q('#e_'+e+'_ud'), ud);
      if(onE) dep += ud;
    }
    setMoneyText(q('#sub_total_depr'), dep);
    var base = directos + dep; setMoneyText(q('#sub_subtotal_no_gi'), base);

    var g_on=!!(q('#chk_ganancia')&&q('#chk_ganancia').checked);
    var i_on=!!(q('#chk_impuestos')&&q('#chk_impuestos').checked);
    var g = g_on ? base * (parseEUin(q('#sub_ganancia'))/100) : 0;
    var iv = i_on ? (base+g) * (parseEUin(q('#sub_impuestos'))/100) : 0;
    setMoneyText(q('#sub_subtotal'), base);
    setMoneyText(q('#sub_ganancia_val'), g);
    setMoneyText(q('#sub_impuestos_val'), iv);
    setMoneyText(q('#sub_total'), base + g + iv);
  }
  qa('#view-sublimacion input').forEach(function(el){ el.addEventListener('input',recalcSub,false); el.addEventListener('change',recalcSub,false); });
  var _rs=q('#btn_reset_sub'); if(_rs){ _rs.addEventListener('click', function(){ setTimeout(recalcSub, 50); }, false); }
  setTimeout(recalcSub,0); document.addEventListener('DOMContentLoaded', function(){ setTimeout(recalcSub,100); }, false);

  // -------- ETIQUETAS --------
  function recalcEti(){
    if(typeof eti_update==='function') return;
    // Producto base
    var cant=parseEUin(q('#eti_d_prod_cant')), pre=parseEUin(q('#eti_d_prod_precio'));
    var prod_ud=(cant>0)?(pre/cant):0; setMoneyInput(q('#eti_d_prod_ud'), prod_ud);
    var items=['papel','tinta','laminado'];
    var directos=0; var _epon=q('#eti_d_prod_on'); if(_epon && _epon.checked){ directos += prod_ud; }
    for(var i=0;i<items.length;i++){
      var k=items[i]; var on=!!(q('#eti_d_'+k+'_on') && q('#eti_d_'+k+'_on').checked);
      var udk=(function(){ var c=parseEUin(q('#eti_d_'+k+'_cant')), p=parseEUin(q('#eti_d_'+k+'_precio')); return (c>0)?(p/c):0; })();
      setMoneyInput(q('#eti_d_'+k+'_ud'), udk);
      if(on) directos += udk;
    }
    setMoneyText(q('#eti_total_directos'), directos);

    // Depreciación: cuchilla (precio/vida), plotter/impresora (precio/24)/100
    var dep=0;
    var cuch_prec=parseEUin(q('#eti_e_cuchilla_precio')), cuch_vida=parseEUin(q('#eti_e_cuchilla_vida'));
    var cuch_ud=(cuch_vida>0)?(cuch_prec/cuch_vida):0; setMoneyInput(q('#eti_e_cuchilla_ud'), cuch_ud);
    var onC=!!(q('#eti_e_cuchilla_on')&&q('#eti_e_cuchilla_on').checked); if(onC) dep+=cuch_ud;
    var eq=[['plotter'],['impresora']];
    for(var j=0;j<eq.length;j++){
      var e=eq[j][0]; var pE=parseEUin(q('#eti_e_'+e+'_precio')); var mes=pE/24; var ud=mes/100;
      setMoneyInput(q('#eti_e_'+e+'_mes'), mes); setMoneyInput(q('#eti_e_'+e+'_ud'), ud);
      var onE=!!(q('#eti_e_'+e+'_on')&&q('#eti_e_'+e+'_on').checked); if(onE) dep+=ud;
    }
    setMoneyText(q('#eti_total_depr'), dep);

    var base=directos+dep; setMoneyText(q('#eti_subtotal_no_gi'), base);
    var g_on=!!(q('#eti_ganancia')&&q('#eti_ganancia').previousElementSibling && q('#eti_ganancia').previousElementSibling.checked);
    var i_on=!!(q('#eti_impuestos')&&q('#eti_impuestos').previousElementSibling && q('#eti_impuestos').previousElementSibling.checked);
    // Los checkboxes de G/I en etiquetas están delante del input (en el mismo label). Detectarlos de forma robusta:
    var chkG = document.querySelector('#eti_ganancia') ? document.querySelector('#eti_ganancia').parentElement.querySelector('input[type="checkbox"]') : null;
    var chkI = document.querySelector('#eti_impuestos') ? document.querySelector('#eti_impuestos').parentElement.querySelector('input[type="checkbox"]') : null;
    var g = (chkG && chkG.checked) ? base * (parseEUin(q('#eti_ganancia'))/100) : 0;
    var iv = (chkI && chkI.checked) ? (base+g) * (parseEUin(q('#eti_impuestos'))/100) : 0;
    setMoneyText(q('#eti_subtotal'), base);
    setMoneyText(q('#eti_ganancia_val'), g);
    setMoneyText(q('#eti_impuestos_val'), iv);
    setMoneyText(q('#eti_total'), base + g + iv);
  }
  qa('#view-etiquetas input, #view-etiquetas select').forEach(function(el){ el.addEventListener('input',recalcEti,false); el.addEventListener('change',recalcEti,false); });
  var _re=q('#btn_reset_eti'); if(_re){ _re.addEventListener('click', function(){ setTimeout(recalcEti, 50); }, false); }
  setTimeout(recalcEti,0); document.addEventListener('DOMContentLoaded', function(){ setTimeout(recalcEti,100); }, false);

  
// === Etiquetas — Cantidad de productos (Q) ===
(function(){
  function $id(id){ return document.getElementById(id); }

  function parseEUAny(src){
    if (src == null) return 0;
    if (typeof src === 'number') return isFinite(src) ? src : 0;
    var raw = '';
    if (src && src.nodeType){
      raw = (src.textContent || src.value || '').trim();
    } else {
      raw = ('' + src).trim();
    }
    if (!raw) return 0;
    var v;
    try {
      if (typeof euParse === 'function'){ v = euParse(raw); if (!isNaN(v)) return v; }
    } catch(e){}
    try {
      if (typeof parseEU === 'function'){ v = parseEU(raw); if (!isNaN(v)) return v; }
    } catch(e){}
    try {
      if (typeof parseEUin === 'function'){
        if (src && src.nodeType){ v = parseEUin(src); if (!isNaN(v)) return v; }
        v = parseEUin(raw); if (!isNaN(v)) return v;
      }
    } catch(e){}
    try {
      if (typeof parseNum === 'function'){ v = parseNum(raw); if (!isNaN(v)) return v; }
    } catch(e){}
    raw = raw.replace(/[^0-9,.-]/g,'');
    if (raw.indexOf(',') >= 0 && raw.indexOf('.') >= 0){
      raw = raw.replace(/\./g,'').replace(',', '.');
    } else if (raw.indexOf(',') >= 0){
      raw = raw.replace(',', '.');
    }
    v = parseFloat(raw);
    return isNaN(v) ? 0 : v;
  }

  function fmtEUAny(n){
    if (!isFinite(n)) n = 0;
    try {
      if (typeof fmtEU === 'function') return fmtEU(n);
    } catch(e){}
    try {
      if (typeof fmtUSD === 'function') return fmtUSD(n);
    } catch(e){}
    var sign = n < 0 ? '-' : '';
    n = Math.abs(n);
    var s = n.toFixed(2);
    var parts = s.split('.');
    var intPart = parts[0];
    var dec = parts[1];
    intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return sign + '$ ' + intPart + ',' + dec;
  }

  function getNumericFromSpanOrInput(id){
    var el = $id(id);
    if (!el) return 0;
    var raw = ('value' in el) ? el.value : (el.textContent || el.innerText || '');
    return parseEUAny(raw);
  }

  function setResult(id, val){
    var el = $id(id);
    if (!el) return;
    el.textContent = fmtEUAny(val);
  }

  function recalcEtiQty(){
    var qtyOn    = $id('eti_qty_on');
    var qtyInput = $id('eti_qty');
    if (!qtyOn || !qtyInput) return;

    var Q = parseInt(qtyInput.value, 10);
    if (!Q || Q < 1) Q = 1;
    if (qtyInput.value !== String(Q)) qtyInput.value = String(Q);

    if (!qtyOn.checked){
      setResult('eti_qty_base', 0);
      setResult('eti_qty_subtotal', 0);
      setResult('eti_qty_g', 0);
      setResult('eti_qty_i', 0);
      setResult('eti_qty_total', 0);
      return;
    }

    // Base sin G/I por unidad (Directos + Depr + Indirectos, sin MO)
    var base = getNumericFromSpanOrInput('eti_subtotal_no_gi');

    // Valores por unidad YA calculados por el módulo Etiquetas
    var subtotalUnit = getNumericFromSpanOrInput('eti_subtotal');
    var gUnit        = getNumericFromSpanOrInput('eti_ganancia_val');
    var iUnit        = getNumericFromSpanOrInput('eti_impuestos_val');
    var totalUnit    = getNumericFromSpanOrInput('eti_total');

    var baseQ     = base * Q;
    var subtotalQ = subtotalUnit * Q;
    var gQ        = gUnit * Q;
    var iQ        = iUnit * Q;
    var totalQ    = totalUnit * Q;

    setResult('eti_qty_base', baseQ);
    setResult('eti_qty_subtotal', subtotalQ);
    setResult('eti_qty_g', gQ);
    setResult('eti_qty_i', iQ);
    setResult('eti_qty_total', totalQ);
  }

  function attachEtiQtyEvents(){
    var qtyOn    = $id('eti_qty_on');
    var qtyInput = $id('eti_qty');

    if (qtyOn)   qtyOn.addEventListener('change', recalcEtiQty);
    if (qtyInput){
      qtyInput.addEventListener('change', recalcEtiQty);
      qtyInput.addEventListener('input', recalcEtiQty);
    }

    var chkG = $id('eti_chk_ganancia');
    var gPct = $id('eti_ganancia');
    var chkI = $id('eti_chk_impuestos');
    var iPct = $id('eti_impuestos');
    var modo = $id('eti_modo_ganancia');
    var moOn = $id('eti_mo_on');
    var moCfg= $id('eti_mo_cfg');

    if (chkG) chkG.addEventListener('change', recalcEtiQty);
    if (gPct){
      gPct.addEventListener('change', recalcEtiQty);
      gPct.addEventListener('input', recalcEtiQty);
    }
    if (chkI) chkI.addEventListener('change', recalcEtiQty);
    if (iPct){
      iPct.addEventListener('change', recalcEtiQty);
      iPct.addEventListener('input', recalcEtiQty);
    }
    if (modo) modo.addEventListener('change', recalcEtiQty);
    if (moOn) moOn.addEventListener('change', recalcEtiQty);
    if (moCfg){
      moCfg.addEventListener('change', recalcEtiQty);
      moCfg.addEventListener('input', recalcEtiQty);
    }
  }

  function attachEtiQtyObservers(){
    if (!window.MutationObserver) return;
    var observer = new MutationObserver(recalcEtiQty);
    [
      'eti_subtotal_no_gi',
      'eti_subtotal',
      'eti_ganancia_val',
      'eti_impuestos_val',
      'eti_total',
      'eti_mo_val'
    ].forEach(function(id){
      var el = $id(id);
      if (el) observer.observe(el, {childList:true, characterData:true, subtree:true});
    });
  }

  function ensureEtiQtyCard(){
    var view = $id('view-etiquetas');
    if (!view) return;
    if ($id('eti_qty_card')) return;

    var grid = view.querySelector('.grid') || view;
    var card = document.createElement('div');
    card.className = 'card md-12';
    card.id = 'eti_qty_card';
    card.innerHTML =
      '<h4 style="margin:0 0 10px">Cantidad de productos</h4>' +
      '<div class="row" style="gap:8px;align-items:flex-end;flex-wrap:wrap">' +
        '<div style="min-width:160px">' +
          '<label style="display:flex;align-items:center;gap:8px;margin:0">' +
            '<input id="eti_qty_on" type="checkbox">' +
            'Cantidad de productos' +
          '</label>' +
        '</div>' +
        '<div style="min-width:120px;max-width:140px">' +
          '<label>Cantidad (Q)</label>' +
          '<input id="eti_qty" type="number" min="1" step="1" value="1">' +
        '</div>' +
      '</div>' +
      '<div class="sep"></div>' +
      '<div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">' +
        '<div class="pill">Base sin G/I × Q: <span class="result mono" id="eti_qty_base">$ 0,00</span></div>' +
        '<div class="pill">Subtotal × Q: <span class="result mono" id="eti_qty_subtotal">$ 0,00</span></div>' +
        '<div class="pill">Ganancia × Q: <span class="result mono" id="eti_qty_g">$ 0,00</span></div>' +
        '<div class="pill">Impuestos × Q: <span class="result mono" id="eti_qty_i">$ 0,00</span></div>' +
        '<div class="pill">Total × Q: <span class="result mono" id="eti_qty_total">$ 0,00</span></div>' +
      '</div>';

    // Insert as the last card inside Etiquetas (no intrusivo)
    grid.appendChild(card);
  }

  function initEtiQty(){
    ensureEtiQtyCard();
    attachEtiQtyEvents();
    attachEtiQtyObservers();
    recalcEtiQty();
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive'){
    initEtiQty();
  } else {
    window.addEventListener('load', initEtiQty);
  }
})();
;


  // -------- EMPAQUES --------
  function recalcEmp(){
    function safe(n){ n=Number(n); if(!isFinite(n)||isNaN(n)) return 0; return n<0?0:n; }

    function ud(cantId, precId, udId){
      var c=parseEUin(q('#'+cantId)), p=parseEUin(q('#'+precId));
      var val=(c>0)?(p/c):0;
      setMoneyInput(q('#'+udId), val);
      return safe(val);
    }
    function usedVal(udVal, useId, usedId){
      var u=parseEUin(q('#'+useId));
      var used=safe(udVal * safe(u));
      setMoneyInput(q('#'+usedId), used);
      return used;
    }

    var items=[
      ['emp_caja_on','emp_caja_cant','emp_caja_precio','emp_caja_ud','emp_caja_use','emp_caja_used'],
      ['emp_bolsa_on','emp_bolsa_cant','emp_bolsa_precio','emp_bolsa_ud','emp_bolsa_use','emp_bolsa_used'],
      ['emp_relleno_on','emp_relleno_cant','emp_relleno_precio','emp_relleno_ud','emp_relleno_use','emp_relleno_used'],
      ['emp_cinta_on','emp_cinta_cant','emp_cinta_precio','emp_cinta_ud','emp_cinta_use','emp_cinta_used'],
      ['emp_etiqueta_on','emp_etiqueta_cant','emp_etiqueta_precio','emp_etiqueta_ud','emp_etiqueta_use','emp_etiqueta_used'],
      ['emp_tarjeta_on','emp_tarjeta_cant','emp_tarjeta_precio','emp_tarjeta_ud','emp_tarjeta_use','emp_tarjeta_used']
    ];

    var directos=0;
    for(var i=0;i<items.length;i++){
      var it=items[i];
      var on=!!(q('#'+it[0])&&q('#'+it[0]).checked);
      var u=ud(it[1], it[2], it[3]);
      var used=usedVal(u, it[4], it[5]); // SIEMPRE visible
      if(on) directos+=used;
    }
    setMoneyText(q('#emp_total_directos'), safe(directos));

    // Depreciación
    var dep=0;
    var pE=parseEUin(q('#emp_impresora_precio'));
    var mes=safe(pE/24);
    var udE=safe(mes/100);
    setMoneyInput(q('#emp_impresora_mes'), mes);
    setMoneyInput(q('#emp_impresora_ud'), udE);
    var usedE = usedVal(udE, 'emp_impresora_use', 'emp_impresora_used'); // SIEMPRE visible
    var onE=!!(q('#emp_impresora_on')&&q('#emp_impresora_on').checked);
    if(onE) dep+=usedE;
    setMoneyText(q('#emp_total_depr'), safe(dep));

    var base=safe(directos+dep);
    setMoneyText(q('#emp_subtotal_no_gi'), base);

    var chkG = document.querySelector('#emp_ganancia') ? document.querySelector('#emp_ganancia').parentElement.querySelector('input[type="checkbox"]') : null;
    var chkI = document.querySelector('#emp_impuestos') ? document.querySelector('#emp_impuestos').parentElement.querySelector('input[type="checkbox"]') : null;
    var g = (chkG && chkG.checked) ? base * (parseEUin(q('#emp_ganancia'))/100) : 0;
    var iv = (chkI && chkI.checked) ? (base+g) * (parseEUin(q('#emp_impuestos'))/100) : 0;
    setMoneyText(q('#emp_subtotal'), base);
    setMoneyText(q('#emp_ganancia_val'), g);
    setMoneyText(q('#emp_impuestos_val'), iv);
    setMoneyText(q('#emp_total'), base + g + iv);
  }
  qa('#view-empaques input').forEach(function(el){ el.addEventListener('input',recalcEmp,false); el.addEventListener('change',recalcEmp,false); });
  var _rp=q('#btn_reset_emp'); if(_rp){ _rp.addEventListener('click', function(){ setTimeout(recalcEmp, 50); }, false); }
  setTimeout(recalcEmp,0); document.addEventListener('DOMContentLoaded', function(){ setTimeout(recalcEmp,100); }, false);
})();
</script>
<script>
(function(){
  function q(s){ try{return document.querySelector(s);}catch(e){return null;} }
  function qa(s){ try{return Array.prototype.slice.call(document.querySelectorAll(s));}catch(e){return [];} }
  function num(el){ if(!el) return 0; var v=String(el.value||'').replace(/[^\d.,-]/g,'').trim(); if(!v) return 0; if(v.indexOf(',')>=0){ v=v.replace(/\./g,'').replace(',', '.'); } return parseFloat(v)||0; }
  function fmt(n,d){ if(d===void 0) d=2; if(!isFinite(n)) n=0; var s=Number(n).toFixed(d), p=s.split('.'); return p[0].replace(/\B(?=(\d{3})+(?!\d))/g,'.')+(d?(','+p[1]):''); }
  function money(n){ return '$ '+fmt(n); }
  function setIn(id,val){ var el=document.getElementById(id); if(el) el.value = money(val); }
  function setTx(id,val){ var el=document.getElementById(id); if(el) el.textContent = money(val); }

  // ---------- Sublimación ----------
  function sub_calc(){
    // Producto base
    var prod_cant=num(q('#d_prod_cant')), prod_prec=num(q('#d_prod_precio'));
    var prod_ud=(prod_cant>0)?(prod_prec/prod_cant):0;
    setIn('d_prod_ud', prod_ud);
    var directos=0; if (q('#d_prod_on') && q('#d_prod_on').checked) directos+=prod_ud;

    // Insumos
    function ud(id){ var c=num(q('#d_'+id+'_cant')), p=num(q('#d_'+id+'_precio')); var v=(c>0)?(p/c):0; setIn('d_'+id+'_ud', v); return v; }
    ['papel','tinta','cinta','empaque'].forEach(function(k){
      var v=ud(k); if (q('#d_'+k+'_on') && q('#d_'+k+'_on').checked) directos+=v;
    });

    setTx('sub_total_directos', directos);

    // Depreciación
    var dep=0;
    ['impresora','plancha','pc'].forEach(function(k){
      var p=num(q('#e_'+k+'_precio')); var mes=p/24; var ud=mes/100;
      setIn('e_'+k+'_mes', mes); setIn('e_'+k+'_ud', ud);
      if (q('#e_'+k+'_on') && q('#e_'+k+'_on').checked) dep+=ud;
    });
    setTx('sub_total_depr', dep);

    var base=directos+dep; setTx('sub_subtotal_no_gi', base);

    var g=(q('#chk_ganancia')&&q('#chk_ganancia').checked)? base*(num(q('#sub_ganancia'))/100) : 0;
    var i=(q('#chk_impuestos')&&q('#chk_impuestos').checked)? (base+g)*(num(q('#sub_impuestos'))/100) : 0;

    setTx('sub_subtotal', base);
    setTx('sub_ganancia_val', g);
    setTx('sub_impuestos_val', i);
    setTx('sub_total', base+g+i);
  }

  // Force override of any previous handlers
  window.sub_update = sub_calc;

  // Bind events
  qa('#view-sublimacion input, #view-sublimacion select').forEach(function(el){
    el.addEventListener('input', sub_calc, false);
    el.addEventListener('change', sub_calc, false);
  });
  var _rs=document.getElementById('btn_reset_sub'); if(_rs){ _rs.addEventListener('click', function(){ setTimeout(sub_calc, 0); }, false); }

  // ---------- Etiquetas ----------
  function eti_calc(){
    function use(id){ var el=document.getElementById(id); var v=el?num(el):1; return (v<0)?0:v; }
    var directos=0;
    var prod_cant=num(q('#eti_d_prod_cant')), prod_prec=num(q('#eti_d_prod_precio'));
    var prod_ud=(prod_cant>0)?(prod_prec/prod_cant):0; setIn('eti_d_prod_ud', prod_ud);
    var prod_used=prod_ud*use('eti_d_prod_use'); setIn('eti_d_prod_used', prod_used);
    if (q('#eti_d_prod_on')&&q('#eti_d_prod_on').checked) directos+=prod_used;
    function ud(id){ var c=num(q('#eti_d_'+id+'_cant')), p=num(q('#eti_d_'+id+'_precio')); var v=(c>0)?(p/c):0; setIn('eti_d_'+id+'_ud', v); return v; }
    // Mantener cálculo de outputs siempre; el checkbox solo controla si suma.
    ['adhesivo','liner','tinta','merma','laminado','empaque'].forEach(function(k){
      var v=ud(k);
      var used=v*use('eti_d_'+k+'_use'); setIn('eti_d_'+k+'_used', used);
      if (q('#eti_d_'+k+'_on')&&q('#eti_d_'+k+'_on').checked) directos+=used;
    });
    setTx('eti_total_directos', directos);

    var dep=0;
    var cuch_prec=num(q('#eti_e_cuchilla_precio')), cuch_vida=num(q('#eti_e_cuchilla_vida'));
    var cuch_ud=(cuch_vida>0)?(cuch_prec/cuch_vida):0; setIn('eti_e_cuchilla_ud', cuch_ud);
    var cuch_used=cuch_ud*use('eti_e_cuchilla_use'); setIn('eti_e_cuchilla_used', cuch_used);
    if (q('#eti_e_cuchilla_on') && q('#eti_e_cuchilla_on').checked) dep+=cuch_used;
    ['plotter','impresora','guillotina','tapete','troqueladora','pc'].forEach(function(k){
      var p=num(q('#eti_e_'+k+'_precio'));
      var mes=p/24;
      var ud=mes/100;
      setIn('eti_e_'+k+'_mes', mes);
      setIn('eti_e_'+k+'_ud', ud);
      var used=ud*use('eti_e_'+k+'_use'); setIn('eti_e_'+k+'_used', used);
      if (q('#eti_e_'+k+'_on') && q('#eti_e_'+k+'_on').checked) dep+=used;
    });
    setTx('eti_total_depr', dep);

    var base=directos+dep; setTx('eti_subtotal_no_gi', base);
    // Detect checkboxes adyacentes a inputs de %
    function chkFor(inputId){ var el=document.getElementById(inputId); return el ? (el.parentElement.querySelector('input[type="checkbox"]')) : null; }
    var g_on=chkFor('eti_ganancia'); var i_on=chkFor('eti_impuestos');
    var g=(g_on && g_on.checked)? base*(num(q('#eti_ganancia'))/100) : 0;
    var i=(i_on && i_on.checked)? (base+g)*(num(q('#eti_impuestos'))/100) : 0;

    setTx('eti_subtotal', base);
    setTx('eti_ganancia_val', g);
    setTx('eti_impuestos_val', i);
    setTx('eti_total', base+g+i);
  }
  window.eti_update = eti_calc;
  qa('#view-etiquetas input, #view-etiquetas select').forEach(function(el){
    el.addEventListener('input', eti_calc, false);
    el.addEventListener('change', eti_calc, false);
  });
  var _re=document.getElementById('btn_reset_eti'); if(_re){ _re.addEventListener('click', function(){ setTimeout(eti_calc, 0); }, false); }

  // ---------- Empaques ----------
  function emp_calc(){
    function safe(n){ n=Number(n); if(!isFinite(n)||isNaN(n)) n=0; return n<0?0:n; }
    function ud(prefix){
      var c=num(q('#'+prefix+'_cant')), p=num(q('#'+prefix+'_precio'));
      var v=(c>0)?(p/c):0;
      setIn(prefix+'_ud', v);
      return safe(v);
    }
    function used(prefix, udVal){
      var u=num(q('#'+prefix+'_use'));
      var v=safe(udVal * safe(u));
      setIn(prefix+'_used', v);
      return v;
    }

    var items=['emp_caja','emp_bolsa','emp_relleno','emp_cinta','emp_etiqueta','emp_tarjeta'];
    var directos=0;
    items.forEach(function(id){
      var u=ud(id);
      var us=used(id, u); // SIEMPRE visible
      if (q('#'+id+'_on') && q('#'+id+'_on').checked) directos+=us;
    });
    setTx('emp_total_directos', safe(directos));

    var dep=0;
    var p=num(q('#emp_impresora_precio'));
    var mes=safe(p/24);
    var uE=safe(mes/100);
    setIn('emp_impresora_mes', mes);
    setIn('emp_impresora_ud', uE);
    var usesE=num(q('#emp_impresora_use'));
    var usedE=safe(uE * safe(usesE));
    setIn('emp_impresora_used', usedE); // SIEMPRE visible
    if (q('#emp_impresora_on') && q('#emp_impresora_on').checked) dep+=usedE;
    setTx('emp_total_depr', safe(dep));

    var base=safe(directos+dep);
    setTx('emp_subtotal_no_gi', base);
    function chkFor(id){ var el=document.getElementById(id); return el ? (el.parentElement.querySelector('input[type="checkbox"]')) : null; }
    var g_on=chkFor('emp_ganancia'), i_on=chkFor('emp_impuestos');
    var g=(g_on && g_on.checked)? base*(num(q('#emp_ganancia'))/100):0;
    var i=(i_on && i_on.checked)? (base+g)*(num(q('#emp_impuestos'))/100):0;
    setTx('emp_subtotal', base);
    setTx('emp_ganancia_val', g);
    setTx('emp_impuestos_val', i);
    setTx('emp_total', base+g+i);
  }
  window.emp_update = emp_calc;
  qa('#view-empaques input, #view-empaques select').forEach(function(el){
    el.addEventListener('input', emp_calc, false);
    el.addEventListener('change', emp_calc, false);
  });
  var _rp=document.getElementById('btn_reset_emp'); if(_rp){ _rp.addEventListener('click', function(){ setTimeout(emp_calc, 0); }, false); }

  // Final kick: asegura estado coherente tras cargas/resets/presets
  function kick(){ try{ sub_calc(); eti_calc(); emp_calc(); }catch(e){} }
  if (document.readyState === 'complete' || document.readyState === 'interactive'){ setTimeout(kick,0); }
  document.addEventListener('DOMContentLoaded', kick, false);
  setTimeout(kick, 150);
})();
</script>
<style id="view-active-compat">
/* Compatibilidad: si alguna vista usa atributo [active] en vez de clase .active */
.view[active]{ display:block; }

/* === Ajuste 2: asegurar estilo Etiquetas en Vinil + DTF === */
#view-vinil .card, #view-dtf .card{
  background:#fff !important;
  border:1px solid #e9eef5;
  box-shadow:0 8px 20px rgba(0,0,0,.06);
  border-radius:12px;
  padding:16px;
}
#view-vinil h3, #view-dtf h3{ margin:0 0 10px; font-weight:700; }
#view-vinil h4, #view-dtf h4{ margin:0 0 8px; font-weight:600; }

/* Campos 'Costo Ud.' con el mismo look rosa del módulo Etiquetas */
#view-vinil .dep_ud, #view-dtf .dep_ud,
#view-vinil .ud, #view-dtf .ud{
  background:#ffe8ee !important;
  font-weight:600;
}

/* Canvas / layout DTF bordeado como en Etiquetas */
#view-dtf #dtf_layout{
  border:1px solid #eee;
  border-radius:12px;
}
</style>
<script>
// === Vinil Pro v46 (summary at bottom) ===
(function(){
  const qs = (s)=>document.querySelector(s);
  const qa = (s)=>Array.from(document.querySelectorAll(s));
  const parseNum = window.parseNum || (v=>{ v=String(v||'').replace(/[^0-9.,-]/g,'').replace(/,/g,''); return parseFloat(v)||0; });
  const fmtUSD = window.fmtUSD || (n=> new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(isFinite(n)?n:0));

  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
  const adjustDebounced = debounce(vinil_pro_adjust, 150);

  function syncMerma(e){
    const pct = Math.max(0, Math.min(30, parseFloat(qs('#merma_pct')?.value||0)));
    if(e && e.target && e.target.id==='merma_range'){
      qs('#merma_pct').value = qs('#merma_range').value;
    }else{
      qs('#merma_range').value = pct;
    }
    adjustDebounced();
  }

  function anchoEfectivo(){
    const ancho = parseFloat(qs('#ancho_estandar')?.value||0);
    const borde = parseFloat(qs('#borde_lado')?.value||0);
    const eff = Math.max(0, ancho - 2*borde);
    const span = qs('#ancho_efectivo');
    if(span){
      span.textContent = (isFinite(ancho)&&isFinite(borde)) ? `${ancho} − 2×${borde} = ${eff.toFixed(1)} cm` : '—';
      span.style.color = eff>0 ? '' : '#ef4444';
      span.style.fontWeight = eff>0 ? '' : '700';
    }
    return eff;
  }

  function getNumText(id){
    const el = qs(id);
    if(!el) return 0;
    return parseNum(el.textContent);
  }

  function vinil_pro_adjust(){
    try{ if(window.vinil_actualizarTotal){ window.vinil_actualizarTotal(); } }catch(e){}

    const directos = getNumText('#vinil_directos');
    const dep      = getNumText('#vinil_dep');
    const adicRaw  = getNumText('#vinil_adicionales');

    const mermaPct = Math.max(0, Math.min(30, parseFloat(qs('#merma_pct')?.value||0)));
    const adicAdj  = adicRaw * (1 + mermaPct/100);
    const total    = directos + dep + adicAdj;

    qs('#vinil_pro_directos') && (qs('#vinil_pro_directos').textContent = fmtUSD(directos));
    qs('#vinil_pro_dep') && (qs('#vinil_pro_dep').textContent = fmtUSD(dep));
    qs('#vinil_pro_adic') && (qs('#vinil_pro_adic').textContent = fmtUSD(adicAdj));
    qs('#vinil_pro_merma') && (qs('#vinil_pro_merma').textContent = mermaPct.toFixed(0)+'%');
    qs('#vinil_pro_total') && (qs('#vinil_pro_total').textContent = fmtUSD(total));

    // Actualiza etiqueta inferior existente si la hay
    const totalFinal = document.getElementById('totalFinal');
    if(totalFinal){
      const span = totalFinal.querySelector('.result') || totalFinal;
      if(span) span.textContent = fmtUSD(total);
      if(totalFinal.textContent && totalFinal.textContent.indexOf('Total Vinil')===-1){
        totalFinal.innerHTML = 'Total Vinil: <span class="result">'+fmtUSD(total)+'</span>';
      }
    }
    anchoEfectivo();
    vin_gi_calc();
  }

  // --- Ganancia/Impuestos (Vinil) ---
  function vin_gi_calc(){
    const base = getNumText('#vinil_pro_total'); // total vinil ya con merma
    const chkG = qs('#vin_chk_ganancia')?.checked;
    const chkI = qs('#vin_chk_impuestos')?.checked;
    const pG = parseFloat(qs('#vin_ganancia')?.value||0) || 0;
    const pI = parseFloat(qs('#vin_impuestos')?.value||0) || 0;
    const g = chkG ? base * (pG/100) : 0;
    const i = chkI ? (base + g) * (pI/100) : 0;

    qs('#vin_subtotal_no_gi') && (qs('#vin_subtotal_no_gi').textContent = fmtUSD(base));
    qs('#vin_subtotal') && (qs('#vin_subtotal').textContent = fmtUSD(base));
    qs('#vin_ganancia_val') && (qs('#vin_ganancia_val').textContent = fmtUSD(g));
    qs('#vin_impuestos_val') && (qs('#vin_impuestos_val').textContent = fmtUSD(i));
    qs('#vin_total') && (qs('#vin_total').textContent = fmtUSD(base + g + i));
  }

  // Encadenar con actualizador original si expuesto globalmente
  if(window.vinil_actualizarTotal && !window._vinilProWrapped){
    const orig = window.vinil_actualizarTotal;
    window.vinil_actualizarTotal = function(){ orig(); adjustDebounced(); };
    window._vinilProWrapped = true;
  }

  // Listeners
  ['#vin_ganancia','#vin_impuestos','#vin_chk_ganancia','#vin_chk_impuestos'].forEach(function(sel){
    const el = qs(sel);
    if(el){
      el.addEventListener('input', vin_gi_calc, false);
      el.addEventListener('change', vin_gi_calc, false);
    }
  });

  qs('#merma_pct') && qs('#merma_pct').addEventListener('input', syncMerma);
  qs('#merma_range') && qs('#merma_range').addEventListener('input', syncMerma);
  qs('#borde_lado') && qs('#borde_lado').addEventListener('input', adjustDebounced);
  qs('#ancho_estandar') && qs('#ancho_estandar').addEventListener('input', adjustDebounced);

  ['#bloques','#vinil_costos_directos','#vinil_depreciacion'].forEach(sel=>{
    const el = qs(sel); if(!el) return;
    el.addEventListener('input', adjustDebounced, true);
    el.addEventListener('change', adjustDebounced, true);
  });

  const btnReset = qs('#btn_reset_vinil');
  if(btnReset && !btnReset._vinilPro){
    btnReset._vinilPro = true;
    btnReset.addEventListener('click', ()=>{
      if(qs('#merma_pct')) qs('#merma_pct').value = 0;
      if(qs('#merma_range')) qs('#merma_range').value = 0;
      if(qs('#borde_lado')) qs('#borde_lado').value = 1;
      setTimeout(adjustDebounced, 50);
    });
  }

  // Copy / Print helpers
  function copyText(t){
    if(navigator.clipboard && window.isSecureContext){
      navigator.clipboard.writeText(t).then(()=>alert('Copiado')).catch(()=>alert('No se pudo copiar'));
    }else{
      const ta=document.createElement('textarea'); ta.value=t; ta.style.position='fixed'; ta.style.left='-9999px';
      document.body.appendChild(ta); ta.focus(); ta.select();
      try{ document.execCommand('copy'); alert('Copiado'); }catch(e){ alert('No se pudo copiar');}
      document.body.removeChild(ta);
    }
  }
  qs('#vinil_pro_copy') && qs('#vinil_pro_copy').addEventListener('click', ()=>{
    const t = [
      'Resumen de Vinil',
      'Directos: '+(qs('#vinil_pro_directos')?.textContent||'-'),
      'Depreciación: '+(qs('#vinil_pro_dep')?.textContent||'-'),
      'Adicionales (aj.): '+(qs('#vinil_pro_adic')?.textContent||'-'),
      'Merma: '+(qs('#vinil_pro_merma')?.textContent||'-'),
      'Total Vinil: '+(qs('#vinil_pro_total')?.textContent||'-')
    ].join('\n');
    copyText(t);
  });
  qs('#vinil_pro_print') && qs('#vinil_pro_print').addEventListener('click', ()=>{ window.print(); });

  // Kickoff
  setTimeout(adjustDebounced, 0); setTimeout(vin_gi_calc, 10);
})();
</script>
<script>
// Instrucciones: copiar/imprimir
(function(){
  const copyBtn = document.getElementById('btn_copy_help');
  const printBtn = document.getElementById('btn_print_help');
  const area = document.getElementById('help_content');
  function textFrom(el){ return el ? el.innerText.replace(/\n\n+/g,'\n') : ''; }
  copyBtn?.addEventListener('click', ()=>{
    const t = textFrom(area);
    if(!t) return;
    if(navigator.clipboard?.writeText){ navigator.clipboard.writeText(t); alert('Guía copiada'); }
  });
  printBtn?.addEventListener('click', ()=> window.print());
})();
</script>

<script>
/* PWA: Buscar actualizaciones (Service Worker) — Suite Csubli */
(function(){
  const btnCheck = document.getElementById('btn_pwa_check_updates');
  const btnApply = document.getElementById('btn_pwa_apply_update');
  const statusEl = document.getElementById('pwa_update_status');

  function setStatus(t){ if(statusEl) statusEl.textContent = t; }
  function hasSW(){ return ('serviceWorker' in navigator); }

  const PWA_VER = 'v38_2_3';
  // Registro ÚNICO del Service Worker (con bust de versión) para evitar falsos positivos.
  try{
    window.addEventListener('load', function(){
      if(hasSW()) navigator.serviceWorker.register('./sw.js?v='+encodeURIComponent(PWA_VER)).catch(function(){});
    });
  }catch(e){}


  let reloading = false;
  function listenControllerChange(){
    if(!hasSW()) return;
    navigator.serviceWorker.addEventListener('controllerchange', function(){
      if(reloading) return;
      reloading = true;
      // Recargar para tomar el nuevo SW y assets actualizados
      window.location.reload();
    });
  }

  async function getReg(){
    if(!hasSW()) return null;
    try{
      return await navigator.serviceWorker.getRegistration();
    }catch(e){
      return null;
    }
  }

  function showApply(show){
    if(!btnApply) return;
    btnApply.style.display = show ? '' : 'none';
  }

  
  async function getSWVersion(sw){
    return new Promise(function(resolve){
      try{
        if(!sw) return resolve(null);
        const ch = new MessageChannel();
        const t = setTimeout(function(){ resolve(null); }, 800);
        ch.port1.onmessage = function(ev){
          clearTimeout(t);
          const d = ev && ev.data ? ev.data : null;
          if(d && d.type === 'VERSION') return resolve(d.version || null);
          resolve(null);
        };
        sw.postMessage({ type:'GET_VERSION' }, [ch.port2]);
      }catch(e){
        resolve(null);
      }
    });
  }
async function checkUpdates(){
    showApply(false);

    if(!hasSW()){
      setStatus('Este navegador no soporta actualizaciones PWA.');
      return;
    }

    const reg = await getReg();
    if(!reg){
      setStatus('No hay Service Worker registrado (instala la PWA para actualizar).');
      return;
    }

    listenControllerChange();

    setStatus('Buscando actualizaciones…');
    try{
      await reg.update(); // fuerza verificación contra el servidor
    }catch(e){
      setStatus('No se pudo buscar actualizaciones.');
      return;
    }
    // Si ya hay uno esperando
    if(reg.waiting){
      // Confirmar que realmente es una versión distinta (evita falsos positivos)
      try{
        const vA = await getSWVersion(reg.active);
        const vW = await getSWVersion(reg.waiting);
        if(vA && vW && vA === vW){
          setStatus('Ya estás en la última versión.');
          showApply(false);
          return;
        }
      }catch(e){}
      setStatus('Actualización disponible.');
      showApply(true);
      return;
    }
// Si está instalando, esperar estado
    if(reg.installing){
      const w = reg.installing;
      w.addEventListener('statechange', function(){
        if(w.state === 'installed'){
          // Si hay controlador activo, es update; si no, primera instalación
          if(navigator.serviceWorker.controller){
            setStatus('Actualización disponible.');
            showApply(true);
          }else{
            setStatus('Listo (primera instalación).');
          }
        }else if(w.state === 'activating'){
          setStatus('Aplicando actualización…');
        }
      });
      return;
    }

    // Detectar updatefound posterior
    reg.addEventListener('updatefound', function(){
      const nw = reg.installing;
      if(!nw) return;
      nw.addEventListener('statechange', function(){
        if(nw.state === 'installed'){
          if(navigator.serviceWorker.controller){
            setStatus('Actualización disponible.');
            showApply(true);
          }else{
            setStatus('Listo (primera instalación).');
          }
        }
      });
    });

    // Si no apareció nada, asumir que está al día
    setTimeout(function(){
      // Si en ~1s no cambió a "disponible", declaramos al día
      if(statusEl && statusEl.textContent === 'Buscando actualizaciones…'){
        setStatus('Ya estás en la última versión.');
      }
    }, 1200);
  }

  async function applyUpdate(){
    if(!hasSW()) return;
    const reg = await getReg();
    if(!reg || !reg.waiting){
      setStatus('No hay actualización pendiente.');
      showApply(false);
      return;
    }
    setStatus('Aplicando actualización…');
    try{
      // Ordenar al SW en espera que se active de inmediato
      reg.waiting.postMessage({ type: 'SKIP_WAITING' });
      // La recarga real ocurre con controllerchange
    }catch(e){
      setStatus('No se pudo aplicar la actualización.');
    }
  }

  btnCheck && btnCheck.addEventListener('click', checkUpdates);
  btnApply && btnApply.addEventListener('click', applyUpdate);
  // Compat: expone helper para botones antiguos
  window.SuitePWA = window.SuitePWA || {};
  window.SuitePWA.checkUpdates = checkUpdates;
  window.SuitePWA.applyUpdate = applyUpdate;


  // Si hay un SW esperando al cargar, mostrarlo
  (async function(){
    if(!btnCheck) return; // si no existe UI, no tocar
    if(!hasSW()){
      setStatus('PWA no disponible en este navegador.');
      return;
    }
    const reg = await getReg();
    if(reg && reg.waiting){
      try{
        const vA = await getSWVersion(reg.active);
        const vW = await getSWVersion(reg.waiting);
        if(vA && vW && vA === vW){
          setStatus('Ya estás en la última versión.');
          showApply(false);
          return;
        }
      }catch(e){}
      setStatus('Actualización disponible.');
      showApply(true);
    }else{
      setStatus('—');
    }
  })();
  })();
})();
</script>


<script>
// ===== DTF Layout Preview (configurable panel, auto-rotación, multipanel) =====
(function(){
  const $ = (id)=>document.getElementById(id);
  const parseNum = (v)=>{
    if(v==null) return 0;
    const t = String(v).replace(/[^\d\.\-]/g,'');
    const n = parseFloat(t); return isFinite(n)?n:0;
  };

  function collectDesigns(){
    const cont = $("dtf_bloques");
    const items = [];
    cont?.querySelectorAll('.card.md-12').forEach(card=>{
      const id = card.querySelector('[data-remove]')?.getAttribute('data-remove');
      const w = parseNum(document.getElementById('dtf_w'+id)?.value) || 0;
      const h = parseNum(document.getElementById('dtf_h'+id)?.value) || 0;
      const n = Math.max(0, Math.floor(parseNum(document.getElementById('dtf_n'+id)?.value) || 0));
      if(w>0 && h>0 && n>0){ items.push({w,h,n}); }
    });
    return items;
  }

  // Shelf packing multipanel con rotación opcional
  function packShelfMultipanel(items, panelW, panelH, sep, autorot){
    const list = [];
    items.forEach(it=>{ for(let i=0;i<it.n;i++) list.push({w:it.w, h:it.h}); });
    list.sort((a,b)=> Math.max(b.w,b.h) - Math.max(a.w,a.h));

    const panels = [];
    function packIntoNewPanel(){
      const placements = [];
      let x=0, y=0, rowH=0;
      for(const r of list){
        if(r._placed) continue;
        let w=r.w, h=r.h;

        if(autorot){
          if(w>panelW && h<=panelW){ const t=w; w=h; h=t; }
          // escoger orientación que deje menos desperdicio horizontal si ambas caben
          if(w<=panelW && h<=panelW){
            const waste0 = Math.max(0, panelW - (x===0 ? w : Math.min(w, Math.max(0, panelW-x))));
            const waste1 = Math.max(0, panelW - (x===0 ? h : Math.min(h, Math.max(0, panelW-x))));
            if(h<=panelW && waste1 < waste0){ const t=w; w=h; h=t; }
          }
        }
        if(w>panelW) continue;

        if(x===0){
          if(y + h > panelH + 1e-6) continue;
          placements.push({x:0,y,w,h}); r._placed=true;
          x = w + sep; rowH = Math.max(rowH, h);
        }else{
          if(x + w <= panelW + 1e-6){
            if(y + h > panelH + 1e-6) continue;
            placements.push({x,y,w,h}); r._placed=true;
            x += w + sep; rowH = Math.max(rowH, h);
          }else{
            y += rowH + sep;
            if(y + h > panelH + 1e-6) continue;
            placements.push({x:0,y,w,h}); r._placed=true;
            x = w + sep; rowH = h;
          }
        }
      }
      const usedH = placements.length ? (placements[placements.length-1].y + rowH) : 0;
      panels.push({placements, usedH});
    }

    let guard=0;
    while(list.some(it=>!it._placed) && guard<500){
      packIntoNewPanel(); guard++;
      if(panels[panels.length-1].placements.length===0) break;
    }

    const placedCount = list.filter(it=>it._placed).length;
    const total = list.length;
    return {panels, placedCount, total};
  }

  function drawLayout(canvas, panelW, panelH, panels, sep){
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const Wpx = canvas.width, Hpx = canvas.height;
    ctx.clearRect(0,0,Wpx,Hpx);

    const stackH = Math.max(panelH * Math.min(panels.length,3), panelH);
    const sx = Wpx / Math.max(panelW,1);
    const sy = Hpx / Math.max(stackH,1);
    const s = Math.min(sx, sy);

    ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,Wpx,Hpx);

    let offsetY = 0, idx=0;
    panels.slice(0,3).forEach((panel)=>{
      ctx.strokeStyle='#111'; ctx.lineWidth=2;
      ctx.strokeRect(0, offsetY, panelW*s, panelH*s);

      for(const p of panel.placements){
        const x=p.x*s, y=offsetY + p.y*s, w=p.w*s, h=p.h*s;
        const hue=(idx*47)%360;
        ctx.fillStyle=`hsl(${hue} 70% 70%)`; ctx.fillRect(x,y,w,h);
        ctx.strokeStyle='#333'; ctx.lineWidth=1; ctx.strokeRect(x,y,w,h);
        ctx.fillStyle='#111'; ctx.font='12px sans-serif'; ctx.fillText(`${p.w}×${p.h}`, x+4, y+14);
        idx++;
      }

      ctx.fillStyle='#6b7280'; ctx.font='12px sans-serif';
      ctx.fillText(panelW+' cm', (panelW*s)/2 - 18, offsetY + panelH*s - 6);
      ctx.save(); ctx.rotate(-Math.PI/2);
      ctx.fillText(panelH+' cm', - (offsetY + (panelH*s)/2 + 18), 12);
      ctx.restore();
      offsetY += (panelH*s) + 12;
    });
  }

  function generatePreview(){
    const items = collectDesigns();
    const sep = parseNum($("dtf_sep")?.value) || 0;
    const tipo = $("dtf_panel_tipo")?.value || "metro";
    let panelW = parseNum($("dtf_panel_w")?.value) || 57;
    let panelH = parseNum($("dtf_panel_h")?.value) || 100;
    if(tipo==="metro"){ panelW=57; panelH=100; }
    else if(tipo==="tramo30"){ panelW=57; panelH=30; }
    else if(tipo==="a3"){ panelW=29.7; panelH=42; }
    const autorot = $("dtf_autorot")?.checked;

    const res = packShelfMultipanel(items, panelW, panelH, sep, autorot);
    drawLayout($("dtf_layout"), panelW, panelH, res.panels, sep);

    const usados = res.panels.length; const placed = res.placedCount; const total = res.total;
    $("dtf_layout_info").textContent = `Paneles usados: ${usados} • Colocados: ${placed}/${total}`;

    // Sincroniza con la lógica de unidades cobradas / material a solicitar
    try{
      let e=0; items.forEach(it=> e += it.n);
      window.dtf_estampados_cache = e;
      const modalidad = document.getElementById("dtf_modalidad")?.value;
      if(modalidad === "a3"){
        document.getElementById("dtf_unidades").textContent = String(usados);
        document.getElementById("dtf_mat_solicitar").textContent = usados + " hoja(s) A3";
      }else{
        const altoTotal = panelH * usados; // cm totales
        const unidad = (modalidad==="metro") ? 100 : 30;
        const u = Math.ceil(altoTotal / unidad);
        document.getElementById("dtf_unidades").textContent = String(u);
        const metros = (unidad===100) ? (u) : (u*0.3);
        document.getElementById("dtf_mat_solicitar").textContent = (unidad===100 ? (metros+" m") : (u+" tramo(s) de 30 cm"));
        document.getElementById("dtf_largo_cm").value = String(altoTotal.toFixed(1));
      }
      const evt = new Event('input'); document.getElementById("dtf_largo_cm").dispatchEvent(evt);
    }catch(e){}
  }

  $("dtf_preview_btn")?.addEventListener('click', generatePreview);

  $("dtf_preset_demo")?.addEventListener('click', ()=>{
    const cont = $("dtf_bloques"); cont.innerHTML = "";
    function add(w,h,n){
      const e = document.createElement('div');
      e.className='card md-12';
      const id = (window.dtf_counter = (window.dtf_counter||0) + 1);
      e.innerHTML = `
        <div class="calc-block" id="dtf_block${id}" style="border:1px solid #eee;border-radius:12px;padding:12px;background:#fff">
          <div class="row" style="align-items:center;justify-content:space-between">
            <label style="margin:0">Diseño</label>
            <button class="copy-btn" data-remove="${id}">Eliminar</button>
          </div>
          <div class="row" style="gap:12px;flex-wrap:wrap">
            <div style="min-width:150px;flex:1">
              <label>Ancho (cm)</label>
              <input type="number" id="dtf_w${id}" step="0.1" min="0" value="${w}"/>
            </div>
            <div style="min-width:150px;flex:1">
              <label>Alto (cm)</label>
              <input type="number" id="dtf_h${id}" step="0.1" min="0" value="${h}"/>
            </div>
            <div style="min-width:150px;flex:1">
              <label>Cantidad</label>
              <input type="number" id="dtf_n${id}" step="1" min="1" value="${Math.max(1,n)}"/>
            </div>
          </div>
        </div>`;
      cont.appendChild(e);
    }
    add(15,15,20);
    $("dtf_sep").value="0.5";
    $("dtf_panel_tipo").value="metro";
    $("dtf_panel_w").value="57"; $("dtf_panel_h").value="100";
  });

  // Sincroniza selector de tipo con ancho/alto
  (function(){
    const sel = $("dtf_panel_tipo");
    sel?.addEventListener('change', ()=>{
      const t = sel.value;
      if(t==="metro"){ $("dtf_panel_w").value="57"; $("dtf_panel_h").value="100"; }
      else if(t==="tramo30"){ $("dtf_panel_w").value="57"; $("dtf_panel_h").value="30"; }
      else if(t==="a3"){ $("dtf_panel_w").value="29.7"; $("dtf_panel_h").value="42"; }
    });
  })();
})();
</script>
<script>
/* === DTF MODULE OVERLAY — scoped to #view-dtf (won't touch other modules) === */
(function(){
  const root = document.getElementById('view-dtf');
  if(!root) return;

  // ---------- helpers ----------
  const $  = (id)=> root.querySelector('#'+id);
  const $$ = (sel, ctx=root)=> Array.prototype.slice.call(ctx.querySelectorAll(sel));
  function parseEU(raw){
    if(raw==null) return 0;
    let v = String(raw).trim();
    v = v.replace(/[^\d,.\-]/g, '');
    if (v.includes('.') && v.includes(',')){ v = v.replace(/\./g,'').replace(',', '.'); }
    else if (v.includes(',')){ v = v.replace(',', '.'); }
    const n = parseFloat(v);
    return isFinite(n) ? n : 0;
  }
  const toUSD = (n)=> (n||0).toLocaleString('en-US', {style:'currency', currency:'USD', maximumFractionDigits: 2});

  // ---------- constants ----------
  const W_METRO=57, A3W=29.7, A3H=42;

  // ---------- cards ----------
  function cards(){ return $$('#dtf_bloques > .card.md-12'); }
  function ensureId(card){
    let id = card.getAttribute('data-id');
    if(id) return id;
    const rm = card.querySelector('[data-remove]');
    if(rm){ id = rm.getAttribute('data-remove'); card.setAttribute('data-id', id); return id; }
    const m = card.innerHTML.match(/id="dtf_(?:w|h|n|cost_ud|cost_total)(\d+)"/);
    if(m){ id = m[1]; card.setAttribute('data-id', id); return id; }
    id = String(($$('#dtf_bloques [data-id]').length||0) + 1);
    card.setAttribute('data-id', id);
    return id;
  }
  function renumber(){ cards().forEach((c,i)=>{ const lbl=c.querySelector('label'); if(lbl) lbl.textContent='Diseño '+(i+1); }); }
  function wireCard(card){
    const id = ensureId(card);
    ['dtf_w'+id,'dtf_h'+id,'dtf_n'+id].forEach(k=>{
      const el = card.querySelector('#'+k);
      if(!el) return;
      const c = el.cloneNode(true);
      el.parentNode.replaceChild(c, el);
      c.addEventListener('input', recompute);
    });
    const del = card.querySelector('[data-remove]');
    if(del){
      const c = del.cloneNode(true);
      del.parentNode.replaceChild(c, del);
      c.addEventListener('click', ()=>{ card.remove(); renumber(); recompute(); });
    }
    const cp = card.querySelector('[data-copy]');
    if(cp){
      const c = cp.cloneNode(true);
      cp.parentNode.replaceChild(c, cp);
      c.addEventListener('click', ()=>{
        const w=card.querySelector('#dtf_w'+id)?.value||'-';
        const h=card.querySelector('#dtf_h'+id)?.value||'-';
        const n=card.querySelector('#dtf_n'+id)?.value||'-';
        const cud=card.querySelector('#dtf_cost_ud'+id)?.textContent||'$0.00';
        const tot=card.querySelector('#dtf_cost_total'+id)?.textContent||'$0.00';
        const idx = cards().indexOf(card)+1;
        navigator.clipboard?.writeText(`Diseño ${idx}\nMedida: ${w}×${h} cm\nCantidad: ${n}\nDTF (ud): ${cud}\nTotal diseño (DTF): ${tot}`);
      });
    }
  }
  function addCard(){
    const cont = $('#dtf_bloques'); if(!cont) return;
    const id = String(($$('#dtf_bloques [data-id]').length||0)+1);
    const node = document.createElement('div');
    node.className='card md-12';
    node.setAttribute('data-id', id);
    node.innerHTML = `
      <div class="calc-block" id="dtf_block${id}" style="border:1px solid #eee;border-radius:12px;padding:12px;background:#fff">
        <div class="row" style="align-items:center;justify-content:space-between">
          <label style="margin:0">Diseño</label>
          <button type="button" class="copy-btn" data-remove="${id}">Eliminar</button>
        </div>
        <div class="row" style="gap:12px;flex-wrap:wrap">
          <div style="min-width:140px;flex:1">
            <label>Ancho (cm)</label>
            <input type="number" id="dtf_w${id}" step="0.1" min="0" value="10"/>
          </div>
          <div style="min-width:140px;flex:1">
            <label>Alto (cm)</label>
            <input type="number" id="dtf_h${id}" step="0.1" min="0" value="10"/>
          </div>
          <div style="min-width:140px;flex:1">
            <label>Cantidad</label>
            <input type="number" id="dtf_n${id}" step="1" min="1" value="1"/>
          </div>
        </div>
        <div class="row" style="gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px">
          <div class="pill">DTF (ud): <span class="result" id="dtf_cost_ud${id}">$0.00</span></div>
          <div class="pill">Total diseño (DTF): <span class="result" id="dtf_cost_total${id}">$0.00</span></div>
          <button type="button" class="copy-btn" data-copy="${id}">Copiar</button>
        </div>
      </div>`;
    cont.appendChild(node);
    wireCard(node);
    renumber();
    recompute();
  }

  // ---------- costos ----------
  const colsFor = (wPanel,wItem,sep)=> Math.max(1, Math.floor((wPanel+sep)/(wItem+sep)));
  const costMetroUD  = (w,h,sep,precio)=> ( (h+sep) / colsFor(W_METRO,w,sep) / 100 ) * precio;
  const costTramoUD  = (w,h,sep,precio)=> Math.max(1, Math.ceil( (h+sep)/colsFor(W_METRO,w,sep)/30 )) * precio;
  const costA3UD     = (w,h,sep,precio)=> { const c=colsFor(A3W,w,sep); const f=Math.max(1, Math.floor((A3H+sep)/(h+sep))); return precio/Math.max(1,c*f); };
  function bestUD(w,h,sep,precio,modalidad,autorot){
    const base = modalidad==='metro' ? costMetroUD(w,h,sep,precio)
               : modalidad==='tramo30' ? costTramoUD(w,h,sep,precio)
               : costA3UD(w,h,sep,precio);
    if(!autorot) return base;
    const rot  = modalidad==='metro' ? costMetroUD(h,w,sep,precio)
               : modalidad==='tramo30' ? costTramoUD(h,w,sep,precio)
               : costA3UD(h,w,sep,precio);
    return Math.min(base, rot);
  }

  function recompute(){
    const modalidad = $('#dtf_modalidad')?.value || 'metro';
    const precio    = parseEU($('#dtf_precio_unit')?.value);
    const sep       = parseEU($('#dtf_sep')?.value);
    const autorot   = !!$('#dtf_autorot')?.checked;

    let dtf_total=0, unidades=0;
    cards().forEach(card=>{
      const id = ensureId(card);
      const w = parseEU(card.querySelector('#dtf_w'+id)?.value);
      const h = parseEU(card.querySelector('#dtf_h'+id)?.value);
      const n = Math.max(0, Math.floor(parseEU(card.querySelector('#dtf_n'+id)?.value)));
      if(w>0 && h>0 && n>0 && precio>0){
        const cud = bestUD(w,h,sep,precio,modalidad,autorot);
        const el1 = card.querySelector('#dtf_cost_ud'+id);
        const el2 = card.querySelector('#dtf_cost_total'+id);
        if(el1) el1.textContent = toUSD(cud);
        if(el2) el2.textContent = toUSD(cud*n);
        dtf_total += cud*n; unidades += n;
      }else{
        const el1 = card.querySelector('#dtf_cost_ud'+id);
        const el2 = card.querySelector('#dtf_cost_total'+id);
        if(el1) el1.textContent = toUSD(0);
        if(el2) el2.textContent = toUSD(0);
      }
    });

    // prenda
    let prenda_ud=0, prenda_total=0;
    if($('#dtf_prenda_on')?.checked){
      const cant = Math.max(0, parseEU($('#dtf_prenda_cant')?.value));
      const pack = Math.max(0, parseEU($('#dtf_prenda_precio')?.value));
      if(cant>0) prenda_ud = pack/cant;
      const out = $('#dtf_prenda_costo_ud'); if(out) out.value = toUSD(prenda_ud);
      prenda_total = prenda_ud * unidades;
    }else{ const out=$('#dtf_prenda_costo_ud'); if(out) out.value = "$ 0,00"; }

    // depreciación plancha
    let dep_ud=0, dep_total=0;
    if($('#dtf_dep_on')?.checked){
      const p = parseEU($('#dtf_dep_plancha_precio')?.value);
      const vida = Math.max(1, parseEU($('#dtf_dep_plancha_vida')?.value));
      dep_ud = p/vida;
    }
    const depOut = $('#dtf_dep_plancha_ud'); if(depOut) depOut.value = toUSD(dep_ud);
    dep_total = dep_ud * unidades;

    // extras
    const extra_envio   = parseEU($('#dtf_extra_envio')?.value);
    const extra_diseno  = parseEU($('#dtf_extra_diseno')?.value);
    const extra_plancha = parseEU($('#dtf_extra_plancha')?.value) * unidades;
    const extra_otros   = parseEU($('#dtf_extra_otros')?.value);
    const extras_total  = extra_envio + extra_diseno + extra_plancha + extra_otros;

    const sinGI = dtf_total + prenda_total + dep_total + extras_total;
    const subtotal = sinGI;

    const gPct = ($('#dtf_chk_ganancia')?.checked ? parseEU($('#dtf_ganancia')?.value) : 0);
    const iPct = ($('#dtf_chk_impuestos')?.checked ? parseEU($('#dtf_impuestos')?.value) : 0);
    const gVal = subtotal * (gPct/100);
    const iVal = (subtotal + gVal) * (iPct/100);
    const total = subtotal + gVal + iVal;

    const set = (id,val)=>{ const el=$('#'+id); if(el) el.textContent = val; };
    set('dtf_unidades', String(unidades));
    set('dtf_total_directos', toUSD(dtf_total));
    set('dtf_total_prenda', toUSD(prenda_total));
    set('dtf_total_dep', toUSD(dep_total));
    set('dtf_total_extras', toUSD(extras_total));
    set('dtf_subtotal_no_gi', toUSD(sinGI));
    set('dtf_subtotal', toUSD(subtotal));
    set('dtf_ganancia_val', toUSD(gVal));
    set('dtf_impuestos_val', toUSD(iVal));
    set('dtf_total', toUSD(total));
    set('dtf_costo_ud_dtf', toUSD(unidades ? dtf_total/unidades : 0));
    set('dtf_costo_por_camiseta', toUSD(unidades ? (sinGI/unidades) : 0));

    // material solicitar aprox: usar preview packing
    const {panels, label} = generatePreview(true);
    if(panels){
      if(($('#dtf_panel_tipo')?.value||'metro')==='a3'){ set('dtf_mat_solicitar', `${panels.length} hoja(s) A3`); }
      else if(($('#dtf_panel_tipo')?.value||'metro')==='tramo30'){ set('dtf_mat_solicitar', `${panels.length} tramo(s) 57×30 cm`); }
      else{ // metro
        let totalCm=0;
        panels.forEach((p,i)=>{ totalCm += (i<panels.length-1)? 100 : Math.min(100, p.usedH); });
        set('dtf_mat_solicitar', `${(totalCm/100).toFixed(2)} m (aprox)`);
      }
    } else set('dtf_mat_solicitar','—');
  }

  // ---------- preview ----------
  function getPanelDims(){
    const tipo = $('#dtf_panel_tipo')?.value || 'metro';
    if(tipo==='metro') return {W:57,H:100,label:'57×100 cm'};
    if(tipo==='tramo30') return {W:57,H:30,label:'57×30 cm'};
    if(tipo==='a3') return {W:29.7,H:42,label:'29.7×42 cm'};
    return {W:Math.max(5,parseEU($('#dtf_panel_w')?.value)), H:Math.max(5,parseEU($('#dtf_panel_h')?.value)), label: `${parseEU($('#dtf_panel_w')?.value)}×${parseEU($('#dtf_panel_h')?.value)} cm`};
  }
  function collectRects(){
    const rs=[]; cards().forEach(card=>{ const id=ensureId(card); const w=parseEU(card.querySelector('#dtf_w'+id)?.value); const h=parseEU(card.querySelector('#dtf_h'+id)?.value); const n=Math.max(0, Math.floor(parseEU(card.querySelector('#dtf_n'+id)?.value))); for(let i=0;i<n;i++) rs.push({w,h}); });
    return rs;
  }
  function pack(rects, W, H, sep, autorot){
    const edge = sep/2;
    rects = rects.slice().sort((a,b)=>Math.max(b.w,b.h)-Math.max(a.w,a.h));
    const res=[]; let cur={placements:[], x:edge, y:edge, rowH:0};
    const fit=(o)=> (cur.x+o.w <= W-edge+1e-9) && (cur.y + Math.max(cur.rowH,o.h) <= H-edge+1e-9);
    const place=(o)=>{ cur.placements.push({x:cur.x,y:cur.y,w:o.w,h:o.h,rot:o.rot}); cur.x += o.w + sep; cur.rowH = Math.max(cur.rowH,o.h); };
    const newRow=()=>{ cur.x=edge; cur.y = cur.y + cur.rowH + sep; cur.rowH = 0; };
    const newPanel=()=>{ if(cur.placements.length) res.push(cur); cur={placements:[], x:edge, y:edge, rowH:0}; };

    rects.forEach(r=>{
      const opts = autorot ? [{w:r.w,h:r.h,rot:false},{w:r.h,h:r.w,rot:true}] : [{w:r.w,h:r.h,rot:false}];
      opts.sort((A,B)=>A.w-B.w);
      let ok=false;
      for(const o of opts){ if(fit(o)){ place(o); ok=true; break; } }
      if(!ok){ newRow(); for(const o of opts){ if(fit(o)){ place(o); ok=true; break; } } }
      if(!ok){ newPanel(); const o=opts.find(o=>o.w<=W-2*edge && o.h<=H-2*edge) || opts[0]; place(o); }
    });
    if(cur.placements.length) res.push(cur);
    return res.map(p=>({placements:p.placements, usedH: Math.min(H, p.y + p.rowH + edge)}));
  }
  function draw(panels, W, H){
    const canvas = $('#dtf_layout'); if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const PAD=12, GAP=16;
    const cols = Math.min(3, Math.max(1, Math.ceil(Math.sqrt(panels.length||1))));
    const rows = Math.ceil((panels.length||1)/cols);
    const w = PAD*2 + cols * ((W*(600 - (cols+1)*GAP)/cols)/W) + (cols-1)*GAP;
    const h = PAD*2 + rows * ((H*(600 - (cols+1)*GAP)/cols)/W) + (rows-1)*GAP;
    const availW = 600; const scale = (availW - (cols+1)*GAP) / cols / W;
    const pW = W*scale, pH = H*scale;
    canvas.width = Math.max(600, Math.ceil(w));
    canvas.height= Math.max(350, Math.ceil(h));
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.font='12px Poppins, Arial'; ctx.textBaseline='top';
    const color=(i)=>`hsl(${(i*37)%360} 70% 75%)`;
    for(let i=0;i<panels.length;i++){
      const row=Math.floor(i/cols), col=i%cols, ox=PAD + col*(pW+GAP), oy=PAD + row*(pH+GAP);
      ctx.strokeStyle='#333'; ctx.strokeRect(ox,oy,pW,pH);
      panels[i].placements.forEach((pl,j)=>{
        const x=ox+pl.x*scale, y=oy+pl.y*scale, w=pl.w*scale, h=pl.h*scale;
        ctx.fillStyle=color(j); ctx.fillRect(x,y,w,h);
        ctx.strokeStyle='#222'; ctx.strokeRect(x,y,w,h);
        ctx.fillStyle='#222'; ctx.fillText(`${Math.round(pl.w)}×${Math.round(pl.h)}`, x+3, y+3);
      });
    }
  }
  function generatePreview(silent){
    const sep = parseEU($('#dtf_sep')?.value);
    const autorot = !!$('#dtf_autorot')?.checked;
    const {W,H,label} = getPanelDims();
    const rects = collectRects();
    const panels = pack(rects, W, H, sep, autorot);
    draw(panels, W, H);
    if(!silent){ const info=$('#dtf_layout_info'); if(info) info.textContent = `Colocados: ${rects.length} • Paneles: ${panels.length} • Panel: ${label} • Sep: ${sep} cm`; }
    return {panels, label};
  }
  window.generatePreview = generatePreview;

  // ---------- bindings ----------
  function bind(){
    const add = $('#dtf_add_diseno'); if(add){ const c=add.cloneNode(true); add.parentNode.replaceChild(c,add); c.addEventListener('click', addCard); }
    const pv = $('#dtf_preview_btn'); if(pv){ const c=pv.cloneNode(true); pv.parentNode.replaceChild(c,pv); c.addEventListener('click', ()=>generatePreview(false)); }
    ['dtf_modalidad','dtf_precio_unit','dtf_sep','dtf_panel_tipo','dtf_panel_w','dtf_panel_h','dtf_autorot',
     'dtf_prenda_on','dtf_prenda_cant','dtf_prenda_precio','dtf_dep_on','dtf_dep_plancha_precio','dtf_dep_plancha_vida',
     'dtf_extra_envio','dtf_extra_diseno','dtf_extra_plancha','dtf_extra_otros',
     'dtf_chk_ganancia','dtf_ganancia','dtf_chk_impuestos','dtf_impuestos']
    .forEach(id=>{ const el=$('#'+id); if(el){ const c=el.cloneNode(true); el.parentNode.replaceChild(c,el); ['input','change'].forEach(ev=>c.addEventListener(ev, recompute)); }});

    // Wire existing cards
    cards().forEach(wireCard);
    renumber();
    recompute();
    generatePreview(false);
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind);
  else bind();
})();
</script>
<script>
(function(){
  const root = document.getElementById('view-dtf'); if(!root) return;
  const $  = (sel, ctx=root) => ctx.querySelector(sel);
  const $$ = (sel, ctx=root) => Array.prototype.slice.call(ctx.querySelectorAll(sel));
  const fmtUSD = (n)=> ('$ ' + (typeof fmtEU==='function' ? fmtEU(n||0) : (Number(n||0).toFixed(2).replace('.',','))));
  const parseEU = (v)=>{
    if(v==null) return 0; v = String(v).trim();
    v = v.replace(/[^\d,.\-]/g, '');
    if(v.includes('.') && v.includes(',')) v = v.replace(/\./g, '').replace(',', '.');
    else if(v.includes(',')) v = v.replace(',', '.');
    const n = parseFloat(v); return isFinite(n) ? n : 0;
  };

  // --- UI short-hands
  const ui = {
    modalidad:  $('#dtf_modalidad'),
    precio:     $('#dtf_precio_unit'),
    respMin:    $('#dtf_resp_min'),
    largo:      $('#dtf_largo_cm'),
    calcPorDis: $('#dtf_calc_por_diseno'),
    add:        $('#dtf_add_diseno'),
    bloques:    $('#dtf_bloques'),
    sep:        $('#dtf_sep'),
    panelTipo:  $('#dtf_panel_tipo'),
    panelW:     $('#dtf_panel_w'),
    panelH:     $('#dtf_panel_h'),
    autorot:    $('#dtf_autorot'),
    previewBtn: $('#dtf_preview_btn'),
    presetBtn:  $('#dtf_preset_demo'),
    canvas:     $('#dtf_layout'),
    info:       $('#dtf_layout_info'),
    // resumen
    spanUnid:   $('#dtf_unidades'),
    spanDir:    $('#dtf_total_directos'),
    spanPrenda: $('#dtf_total_prenda'),
    spanDep:    $('#dtf_total_dep'),
    spanExtras: $('#dtf_total_extras'),
    spanNoGI:   $('#dtf_subtotal_no_gi'),
    chkG:       $('#dtf_chk_ganancia'),
    valG:       $('#dtf_ganancia'),
    chkI:       $('#dtf_chk_impuestos'),
    valI:       $('#dtf_impuestos'),
    spanSub:    $('#dtf_subtotal'),
    spanGVal:   $('#dtf_ganancia_val'),
    spanIVal:   $('#dtf_impuestos_val'),
    spanMat:    $('#dtf_mat_solicitar'),
    spanCud:    $('#dtf_costo_ud_dtf'),
    spanCam:    $('#dtf_costo_por_camiseta'),
    spanTotal:  $('#dtf_total'),
    // prenda/dep/extras inputs
    prOn:       $('#dtf_prenda_on'),
    prCant:     $('#dtf_prenda_cant'),
    prPrecio:   $('#dtf_prenda_precio'),
        prDis: $('#dtf_prenda_disenos'),
    prUd:       $('#dtf_prenda_costo_ud'),
    depOn:      $('#dtf_dep_on'),
    depP:       $('#dtf_dep_plancha_precio'),
        depMes: $('#dtf_dep_plancha_mes'),
    depVida:    $('#dtf_dep_plancha_vida'),
    depUd:      $('#dtf_dep_plancha_ud'),
    exEnv:      $('#dtf_extra_envio'),
    exDis:      $('#dtf_extra_diseno'),
    exPla:      $('#dtf_extra_plancha'),
    exOt:       $('#dtf_extra_otros'),
  };

  // --- Extend modalidad with "personalizado (proporcional)"
  (function ensurePersonalizadoModalidad(){
    if(ui.modalidad && !ui.modalidad.querySelector('option[value="personalizado"]')){
      const op = document.createElement('option');
      op.value = 'personalizado';
      op.textContent = 'Panel personalizado (proporcional)';
      ui.modalidad.appendChild(op);
    }
  })();

  // --- helpers
  function dims(){
    const tipo = ui.panelTipo?.value || 'metro';
    let W=57, H=100, label='57×100', kind='metro';
    if(tipo==='metro'){ W=57; H=100; label='57×100'; kind='metro'; }
    if(tipo==='tramo30'){ W=57; H=30; label='57×30'; kind='tramo30'; }
    if(tipo==='a3'){ W=29.7; H=42; label='29.7×42'; kind='a3'; }
    if(tipo==='personalizado'){
      W = parseEU(ui.panelW?.value)||57;
      H = parseEU(ui.panelH?.value)||100;
      label = `${W}×${H}`;
      kind='personalizado';
    }
    return {W,H,label,kind};
  }
  function designsList(){
    const arr=[]; $$('#dtf_bloques .card.md-12').forEach((card,idx)=>{
      const id = card.getAttribute('data-id') || String(idx+1);
      const w = parseEU(card.querySelector('.w')?.value);
      const h = parseEU(card.querySelector('.h')?.value);
      const n = Math.max(0, Math.floor(parseEU(card.querySelector('.n')?.value)));
      if(w>0 && h>0 && n>0) arr.push({id, name:`Diseño ${idx+1}`, w, h, n, card});
    });
    return arr;
  }
  function addCard(pref={w:10,h:10,n:1}){
    const id = Date.now().toString(36).slice(-6);
    const wrap = document.createElement('div');
    wrap.className='card md-12';
    wrap.setAttribute('data-id', id);
    wrap.innerHTML = `
      <div class="row" style="align-items:flex-end;gap:8px">
        <div style="flex:1;min-width:120px"><label>Ancho (cm)</label><input type="number" step="0.1" class="w" value="${pref.w}"/></div>
        <div style="flex:1;min-width:120px"><label>Alto (cm)</label><input type="number" step="0.1" class="h" value="${pref.h}"/></div>
        <div style="flex:1;min-width:120px"><label>Cantidad</label><input type="number" step="1" class="n" value="${pref.n}"/></div>
        <button class="btn reset del">Eliminar</button>
      </div>
      <div class="row" style="gap:8px;margin-top:8px">
        <div class="pill">DTF (ud): <span class="result cud">$0.00</span></div>
        <div class="pill">Total diseño (DTF): <span class="result ctot">$0.00</span></div>
        <button class="copy-btn copy">Copiar</button>
      </div>`;
    wrap.querySelector('.del').addEventListener('click', ()=>{ wrap.remove(); computeAll(false); });
    wrap.querySelector('.copy').addEventListener('click', ()=>{
      const w = parseEU(wrap.querySelector('.w').value),
            h = parseEU(wrap.querySelector('.h').value),
            n = parseEU(wrap.querySelector('.n').value),
            cud = wrap.querySelector('.cud').textContent,
            ctot= wrap.querySelector('.ctot').textContent;
      navigator.clipboard?.writeText(`Diseño ${w}×${h} (${n} ud) — DTF(ud): ${cud} — Total: ${ctot}`);
    });
    ['.w','.h','.n'].forEach(s=> wrap.querySelector(s).addEventListener('input', ()=>computeAll(false)));
    ui.bloques.appendChild(wrap);
  }

  // --- packer Shelf
  function packShelf(rects, W, H, sep, autorot){
    const edge = sep/2;
    rects = rects.slice().sort((a,b)=>Math.max(b.w,b.h)-Math.max(a.w,a.h));
    const panels=[];
    let cur={placements:[], x:edge, y:edge, rowH:0, usedH:0};
    const fitW=(ow)=> (cur.x + ow <= W - edge + 1e-9);
    rects.forEach(r=>{
      const opts = autorot ? [{w:r.w,h:r.h},{w:r.h,h:r.w}] : [{w:r.w,h:r.h}];
      let o = null;
      for(const c of opts){ if(fitW(c.w)){ o = c; break; } }
      if(!o){
        // nueva fila
        cur.y += cur.rowH + sep;
        cur.x = edge;
        cur.rowH = 0;
        cur.usedH = Math.max(cur.usedH, cur.y - edge);
        // si no cabe en altura, panel nuevo
        const maxH = Math.max(r.h, r.w);
        if(cur.usedH + maxH + sep > H - edge + 1e-9){
          panels.push(cur); cur={placements:[], x:edge, y:edge, rowH:0, usedH:0};
        }
        for(const c of opts){ if(fitW(c.w)){ o=c; break; } }
      }
      if(!o){ panels.push(cur); cur={placements:[], x:edge, y:edge, rowH:0, usedH:0}; o=opts[0]; }
      cur.placements.push({x:cur.x, y:cur.y, w:o.w, h:o.h});
      cur.x += o.w + sep;
      cur.rowH = Math.max(cur.rowH, o.h);
      cur.usedH = Math.max(cur.usedH, cur.y - edge + cur.rowH);
    });
    if(cur.placements.length) panels.push(cur);
    // clamp
    return panels.map(p=>({placements:p.placements, usedH: Math.min(H, Math.max(p.usedH, 0)), H}));
  }

  // --- draw preview
  function draw(panels, W, H){
    const cv = ui.canvas; if(!cv) return;
    const ctx = cv.getContext('2d');
    const PAD=12, GAP=16;
    const cols = Math.min(3, Math.max(1, Math.ceil(Math.sqrt(panels.length||1))));
    const rows = Math.ceil((panels.length||1)/cols);
    const scale = (600-(cols+1)*GAP)/cols/W;
    const pW = W*scale, pH = H*scale;
    cv.width = Math.max(600, Math.ceil(PAD*2 + cols*pW + (cols-1)*GAP));
    cv.height= Math.max(350, Math.ceil(PAD*2 + rows*pH + (rows-1)*GAP));
    ctx.clearRect(0,0,cv.width,cv.height);
    ctx.font='12px Poppins, Arial';
    ctx.textBaseline='top';
    const color = i=>`hsl(${(i*37)%360} 70% 75%)`;
    panels.forEach((panel,i)=>{
      const row = Math.floor(i/cols), col=i%cols;
      const ox = PAD + col*(pW+GAP), oy = PAD + row*(pH+GAP);
      ctx.strokeStyle='#111827'; ctx.strokeRect(ox,oy,pW,pH);
      panel.placements.forEach((pl,j)=>{
        const x=ox+pl.x*scale, y=oy+pl.y*scale, w=pl.w*scale, h=pl.h*scale;
        ctx.fillStyle=color(j); ctx.fillRect(x,y,w,h);
        ctx.strokeStyle='#374151'; ctx.strokeRect(x,y,w,h);
        ctx.fillStyle='#111827'; ctx.fillText(`${Math.round(pl.w)}×${Math.round(pl.h)}`, x+3, y+3);
      });
      // measurements
      ctx.save(); ctx.rotate(-Math.PI/2); ctx.fillStyle='#6b7280'; ctx.fillText(`${Math.round(H)} cm`, -(oy+pH-10), ox-12); ctx.restore();
      ctx.fillStyle='#6b7280'; ctx.fillText(`${Math.round(W)} cm`, ox+pW-40, oy+pH+4);
    });
  }

  // --- main compute
  function computeAll(drawIt=false){
    const D = dims();
    const sep = parseEU(ui.sep?.value)||0;
    const autorot = !!ui.autorot?.checked;
    const precio = parseEU(ui.precio?.value)||0;
    const modalidad = ui.modalidad?.value || 'metro';
    const ds = designsList();

    // construir rects
    const rects=[];
    ds.forEach(d=>{ for(let i=0;i<d.n;i++){ rects.push({w:d.w, h:d.h, did:d.id}); } });
    const panels = packShelf(rects, D.W, D.H, sep, autorot);
    if(drawIt) draw(panels, D.W, D.H);

    // calcular largo total usado (cm) y materiales
    let largo_cm = 0;
    if(D.kind==='metro'){
      // suma alturas de paneles; el último usa usedH real
      panels.forEach((p,i)=>{ largo_cm += (i<panels.length-1)? D.H : Math.min(D.H, p.usedH||0); });
      ui.spanMat.textContent = `${(largo_cm/100).toFixed(2)} m (aprox)`;
    }else if(D.kind==='tramo30'){
      largo_cm = panels.length * 30;
      ui.spanMat.textContent = `${panels.length} tramo(s) 57×30 cm`;
    }else if(D.kind==='a3'){
      ui.spanMat.textContent = `${panels.length} hoja(s) A3`;
      // aproximar largo como hojas * alto
      largo_cm = panels.length * D.H;
    }else{ // personalizado
      const sumUsed = panels.reduce((a,p)=>a + Math.min(D.H, p.usedH||0), 0);
      largo_cm = sumUsed; // para proporcional
      ui.spanMat.textContent = `${(sumUsed/Math.max(D.H,1e-9)).toFixed(2)} panel(es) ${D.label}`;
    }
    if(ui.largo){ ui.largo.value = (largo_cm||0).toFixed(1); }

    // ---- costo material según modalidad (cómo te cobra el proveedor)
    let unidades=0, costo_material=0, matLabel='';
    if(modalidad==='metro'){
      unidades = (largo_cm/100);
      if(ui.respMin?.checked) unidades = Math.ceil(unidades + 1e-9); // redondeo a metro
      costo_material = precio * unidades;
      matLabel = `${unidades.toFixed(2)} m`;
    }else if(modalidad==='tramo30'){
      unidades = largo_cm/30;
      if(ui.respMin?.checked) unidades = Math.ceil(unidades + 1e-9);
      costo_material = precio * unidades;
      matLabel = `${unidades.toFixed(0)} tramo(s)`;
    }else if(modalidad==='a3'){
      unidades = panels.length;
      if(ui.respMin?.checked) unidades = Math.ceil(unidades + 1e-9);
      costo_material = precio * unidades;
      matLabel = `${unidades} hoja(s)`;
    }else{ // personalizado (proporcional)
      unidades = largo_cm / Math.max(D.H, 1e-9); // fracción de panel
      if(ui.respMin?.checked) unidades = Math.ceil(unidades + 1e-9);
      costo_material = precio * unidades;
      matLabel = `${unidades.toFixed(2)} panel(es)`;
    }
    ui.spanUnid.textContent = ds.reduce((a,b)=>a+b.n,0);
    ui.spanDir.textContent  = fmtUSD(costo_material);
    ui.spanMat.textContent  = `${ui.spanMat.textContent} • Cobro: ${matLabel}`;

        // ---- costos prenda y dep (SIEMPRE visibles)
// Regla: total diseños (bloques) / Cant. de Diseños  => prendas equivalentes
let total_prenda=0, costo_ud_prenda=0;
{
  const cant = parseEU(ui.prCant?.value)||0; // sigue informativo
  const prec = parseEU(ui.prPrecio?.value)||0;
  const dis  = Math.max(1, parseEU(ui.prDis?.value)||1); // Cant. de Diseños por prenda
  const totalDis = (ds.reduce((a,b)=>a+b.n,0)); // total diseños (sumatoria de "Cantidad" en cada bloque)
  const prendasEq = totalDis / dis;
  costo_ud_prenda = cant>0 ? (prec/cant) : 0; // visible siempre
  total_prenda = (ui.prOn?.checked ? (prendasEq * costo_ud_prenda) : 0);
}
if(ui.prUd) ui.prUd.value = fmtUSD(costo_ud_prenda);
let total_dep=0, dep_ud=0;
    {
      const prec = parseEU(ui.depP?.value)||0;
      const mes  = prec / 24;
      dep_ud = mes / 100;
      if(ui.depMes) ui.depMes.value = fmtUSD(mes);
      total_dep = (ui.depOn?.checked ? (dep_ud * (ds.reduce((a,b)=>a+b.n,0))) : 0);
    }
    if(ui.depUd) ui.depUd.value = fmtUSD(dep_ud);

    // ---- Extras
    const extras_fijos = (parseEU(ui.exEnv?.value)||0) + (parseEU(ui.exDis?.value)||0) + (parseEU(ui.exOt?.value)||0);
    const extra_plancha = (parseEU(ui.exPla?.value)||0) * (ds.reduce((a,b)=>a+b.n,0));
    const total_extras = extras_fijos + extra_plancha;

    ui.spanPrenda.textContent = fmtUSD(total_prenda);
    ui.spanDep.textContent    = fmtUSD(total_dep);
    ui.spanExtras.textContent = fmtUSD(total_extras);

    const subtotal_no_gi = costo_material + total_prenda + total_dep + total_extras;
    ui.spanNoGI.textContent   = fmtUSD(subtotal_no_gi);

    // --- G/I
    const gan = ui.chkG?.checked ? (parseEU(ui.valG?.value)||0)/100 : 0;
    const imp = ui.chkI?.checked ? (parseEU(ui.valI?.value)||0)/100 : 0;
    const valG = subtotal_no_gi * gan;
    const valI = (subtotal_no_gi + valG) * imp;
    const subtotal = subtotal_no_gi + valG;
    const total = subtotal_no_gi + valG + valI;

    ui.spanSub.textContent  = fmtUSD(subtotal_no_gi);
    ui.spanGVal.textContent = fmtUSD(valG);
    ui.spanIVal.textContent = fmtUSD(valI);
    ui.spanTotal.textContent= fmtUSD(total);

    // --- costo por unidad (DTF material y total camiseta)
    const uds = Math.max(1, ds.reduce((a,b)=>a+b.n,0));
    ui.spanCud.textContent = fmtUSD(costo_material / uds);
    ui.spanCam.textContent = fmtUSD(subtotal_no_gi / uds);

    // --- prorrateo por área (para cada diseño)
    const SEP = sep;
    const areaItems = ds.map(d=> ({id:d.id, area:(d.w+SEP)*(d.h+SEP)*(d.n)}));
    const A = areaItems.reduce((a,b)=>a+b.area,0) || 1;
    const perDesign = {};
    areaItems.forEach(it=>{
      const d = ds.find(x=>x.id===it.id);
      const cost_i = costo_material * (it.area/A);
      const cud_i = cost_i / Math.max(1, d.n);
      perDesign[d.id] = {name:d.name, cud:cud_i, total:cost_i, card:d.card};
    });
    // pintar tarjetas
    ds.forEach(d=>{
      const t = perDesign[d.id];
      if(!t) return;
      d.card.querySelector('.cud').textContent  = fmtUSD(t.cud);
      d.card.querySelector('.ctot').textContent = fmtUSD(t.total);
    });

    // --- info
    if(ui.info){
      ui.info.textContent = `Paneles usados: ${panels.length} • Colocados: ${rects.length}/${rects.length} • Panel: ${D.label} cm`;
    }
  }

  // Events
  function bind(){
  if(window.__DTF_BOUND__) return; window.__DTF_BOUND__=true;
    // add design
    ui.add?.addEventListener('click', ()=>{ addCard({w:10,h:10,n:1}); computeAll(false); });
    // demo
    ui.presetBtn?.addEventListener('click', ()=>{
      ui.bloques.innerHTML='';
      addCard({w:25,h:25,n:1}); addCard({w:10,h:25,n:2}); addCard({w:10,h:10,n:6});
      computeAll(false);
    });
    // panel tipo change -> enable W/H
    ui.panelTipo?.addEventListener('change', ()=>{
      const isPers = ui.panelTipo.value==='personalizado';
      ui.panelW.disabled = ui.panelH.disabled = !isPers? true : false;
      computeAll(false);
    });
    // modalidad change (incluye personalizado proporcional)
    ui.modalidad?.addEventListener('change', computeAll);
    [ui.precio, ui.respMin, ui.largo, ui.sep, ui.panelW, ui.panelH, ui.autorot,
     ui.chkG, ui.valG, ui.chkI, ui.valI,
     ui.prOn, ui.prCant, ui.prPrecio, ui.depOn, ui.depP, ui.depVida, ui.exEnv, ui.exDis, ui.exPla, ui.exOt
    ].forEach(el=> el && ['input','change'].forEach(ev=> el.addEventListener(ev, ()=>computeAll(false))));
    ui.previewBtn?.addEventListener('click', ()=>computeAll(true));

    // si no hay tarjetas, agrega una
    if(!ui.bloques.querySelector('.card.md-12')) addCard({w:10,h:10,n:1});
    computeAll(false);
  }

  // start
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind); else bind();
})();
</script>
<script>
// VINIL_DEP_FORCE_V2 — corrige cálculo y sincroniza Resumen (actualiza #vinil_dep y #vinil_pro_dep)
(function(){
  function money(n){ return '$ ' + (typeof fmtEU==='function' ? fmtEU(n||0) : (Number(n||0).toFixed(2).replace('.',','))); }
  function num(v){
    if(v==null) return 0;
    if(v.value!==undefined) v=v.value;
    v=String(v).replace(/[^\d.,-]/g,'');
    if((v.match(/,/g)||[]).length===1 && !(v.includes('.'))) v=v.replace(',', '.'); else v=v.replace(/,/g,'');
    var x=parseFloat(v); return isNaN(x)?0:x;
  }
  var PROD_DEFAULTS = { impresora:100, plancha:100, pc:100, plotter:100 };

  function ensureProd(){
    Object.keys(PROD_DEFAULTS).forEach(function(row){
      var chk = document.querySelector('#view-vinil .dep_enabled[data-row="'+row+'"]') ||
                document.querySelector('.dep_enabled[data-row="'+row+'"]');
      if(chk){
        var p = parseFloat(chk.getAttribute('data-prod')||'0')||0;
        if(!p){ chk.setAttribute('data-prod', String(PROD_DEFAULTS[row])); }
      }
      var pEl = document.querySelector('#view-vinil .dep_precio[data-row="'+row+'"]') ||
                document.querySelector('.dep_precio[data-row="'+row+'"]');
      if(pEl){
        var p2 = 0;
        if(pEl.dataset && pEl.dataset.prod) p2 = parseFloat(pEl.dataset.prod)||0;
        if(!p2){ try{ pEl.dataset.prod = String(PROD_DEFAULTS[row]); }catch(e){} }
      }
    });
  }

  function calcRow(row){
    var pEl  = document.querySelector('#view-vinil .dep_precio[data-row="'+row+'"]') ||
               document.querySelector('.dep_precio[data-row="'+row+'"]');
    var mesEl= document.querySelector('#view-vinil .dep_mes[data-row="'+row+'"]') ||
               document.querySelector('.dep_mes[data-row="'+row+'"]');
    var udEl = document.querySelector('#view-vinil .dep_ud[data-row="'+row+'"]') ||
               document.querySelector('.dep_ud[data-row="'+row+'"]');
    var chk  = document.querySelector('#view-vinil .dep_enabled[data-row="'+row+'"]') ||
               document.querySelector('.dep_enabled[data-row="'+row+'"]');
    if(!pEl || !udEl) return 0;
    var price = num(pEl);
    var prod  = 0;
    if(chk && chk.getAttribute('data-prod')) prod = parseFloat(chk.getAttribute('data-prod'))||0;
    if(!prod && pEl.dataset && pEl.dataset.prod) prod = parseFloat(pEl.dataset.prod)||0;
    var mes = price/24;
    var ud  = prod>0 ? mes/prod : 0;
    if(mesEl) mesEl.value = money(mes);
    udEl.value = money(ud);
    return (!chk || chk.checked) ? ud : 0;
  }

  function calcCuchilla(){
    var pEl  = document.querySelector('#view-vinil .dep_precio[data-row="cuchilla"]') ||
               document.querySelector('.dep_precio[data-row="cuchilla"]');
    var vidaEl = document.querySelector('#view-vinil .dep_vida[data-row="cuchilla"]') ||
                 document.querySelector('.dep_vida[data-row="cuchilla"]');
    var udEl = document.querySelector('#view-vinil .dep_ud[data-row="cuchilla"]') ||
               document.querySelector('.dep_ud[data-row="cuchilla"]');
    var chk  = document.querySelector('#view-vinil .dep_enabled[data-row="cuchilla"]') ||
               document.querySelector('.dep_enabled[data-row="cuchilla"]');
    if(!pEl || !udEl) return 0;
    var price = num(pEl), vida = Math.max(1, num(vidaEl||{value:'500'}));
    var ud = price/vida;
    if(udEl) udEl.value = money(ud);
    return (!chk || chk.checked) ? ud : 0;
  }

  function refreshVinil(){ /* unified */ }catch(e){} } }catch(e){}
    try{ if(window.vinil_actualizarTotal){ window.vinil_actualizarTotal(); } }catch(e){}
  }

  function staged(){ [0,60,120,250,500,1000].forEach(function(ms){ setTimeout(refreshVinil, ms); }); }

  document.addEventListener('DOMContentLoaded', staged);
  var sec = document.getElementById('view-vinil');
  if(sec){
    sec.addEventListener('input', staged);
    sec.addEventListener('change', staged);
  }
  // Reset hooks
  var btnLocal = document.getElementById('btn_reset_vinil');
  if(btnLocal){ btnLocal.addEventListener('click', function(){ setTimeout(staged, 60); }); }
  var btnGlobal = document.getElementById('btn_reset_general');
  if(btnGlobal){ btnGlobal.addEventListener('click', function(){ setTimeout(staged, 120); }); }
  document.addEventListener('reset', function(){ setTimeout(staged, 60); });

  // Expose adjust globally for other scripts to call if needed
  window.vinil_dep_force_adjust = staged;

  window.addEventListener('load', staged);
  setTimeout(staged, 50);
})();
</script>
<script>
(function(){
  // Utilidades numéricas con formato US para consistencia interna
  const fmt = (n)=>{ if(!isFinite(n)) return '$ 0,00'; const v = (Math.round(n*100)/100).toFixed(2); const parts = v.split('.'); const intp = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.'); return '$ ' + intp + ',' + parts[1];};
  const q = (sel, root=document)=>root.querySelector(sel);
  const all = (sel, root=document)=>Array.from(root.querySelectorAll(sel));

  // ====== Costos directos ======
  const directos = [
    {on:'#d_prod_on', cant:'#d_prod_cant', precio:'#d_prod_precio', ud:'#d_prod_ud'},
    {on:'#d_papel_on', cant:'#d_papel_cant', precio:'#d_papel_precio', ud:'#d_papel_ud'},
    {on:'#d_tinta_on', cant:'#d_tinta_cant', precio:'#d_tinta_precio', ud:'#d_tinta_ud'},
    {on:'#d_cinta_on', cant:'#d_cinta_cant', precio:'#d_cinta_precio', ud:'#d_cinta_ud'},
    {on:'#d_empaque_on', cant:'#d_empaque_cant', precio:'#d_empaque_precio', ud:'#d_empaque_ud'},
  ];

  function calcDirectos(){
    let tot = 0;
    directos.forEach(d=>{
      const on = q(d.on)?.checked;
      const cant = parseFloat(q(d.cant)?.value||"0");
      const precio = parseFloat(q(d.precio)?.value||"0");
      const ud = (cant>0)? (precio/cant) : 0;
      if (q(d.ud)) q(d.ud).value = fmt(ud);
      if (on) tot += ud;
    });
    q('#sub_total_directos').textContent = fmt(tot);
    return tot;
  }

  // ====== Depreciación ======
  // Para items por mes (24 meses) con producción/mes en data-prod
  const depMes = [
    {on:'#e_impresora_on', precio:'#e_impresora_precio', mes:'#e_impresora_mes', ud:'#e_impresora_ud'},
    {on:'#e_plancha_on',   precio:'#e_plancha_precio',   mes:'#e_plancha_mes',   ud:'#e_plancha_ud'},
    {on:'#e_pc_on',        precio:'#e_pc_precio',        mes:'#e_pc_mes',        ud:'#e_pc_ud'},
    {on:'#e_prensa_on',    precio:'#e_prensa_precio',    mes:'#e_prensa_mes',    ud:'#e_prensa_ud'},
    {on:'#e_resistencia_on',precio:'#e_resistencia_precio',mes:'#e_resistencia_mes',ud:'#e_resistencia_ud'},
  ];

  function calcDepreciacion(){
    let tot = 0;
    depMes.forEach(d=>{
      const on = q(d.on)?.checked;
      const precioEl = q(d.precio);
      if (!precioEl) return;
      const precio = parseFloat(precioEl.value||"0");
      const prodMes = parseFloat(precioEl.getAttribute('data-prod')||"100"); // por defecto 100 uds/mes
      const costoMes = precio / 24;
      const costoUd  = (prodMes>0)? (costoMes / prodMes) : 0;
      if (q(d.mes)) q(d.mes).value = fmt(costoMes);
      if (q(d.ud))  q(d.ud).value  = fmt(costoUd);
      if (on) tot += costoUd;
    });
    q('#sub_total_depr').textContent = fmt(tot);
    return tot;
  }

  // ====== Ganancia / Impuestos ======
  function calcGI(subtotalNoGI){
    const chkG = q('#chk_ganancia')?.checked;
    const chkI = q('#chk_impuestos')?.checked;
    const gPct = parseFloat(q('#sub_ganancia')?.value||"0")/100;
    const iPct = parseFloat(q('#sub_impuestos')?.value||"0")/100;

    const gVal = chkG ? subtotalNoGI * gPct : 0;
    const sub  = subtotalNoGI + gVal;
    const iVal = chkI ? sub * iPct : 0;
    const total = sub + iVal;

    q('#sub_subtotal').textContent = fmt(sub);
    q('#sub_ganancia_val').textContent = fmt(gVal);
    q('#sub_impuestos_val').textContent = fmt(iVal);
    q('#sub_total').textContent = fmt(total);
  }

  // ====== Orquestador ======
  function recalc(){
    const tDir = calcDirectos();
    const tDep = calcDepreciacion();
    const subtotalNoGI = tDir + tDep;
    q('#sub_subtotal_no_gi').textContent = fmt(subtotalNoGI);
    calcGI(subtotalNoGI);
  }

  // ====== Eventos ======
  const inputs = [
    '#d_prod_on','#d_prod_cant','#d_prod_precio',
    '#d_papel_on','#d_papel_cant','#d_papel_precio',
    '#d_tinta_on','#d_tinta_cant','#d_tinta_precio',
    '#d_cinta_on','#d_cinta_cant','#d_cinta_precio',
    '#d_empaque_on','#d_empaque_cant','#d_empaque_precio',
    '#e_impresora_on','#e_impresora_precio',
    '#e_plancha_on','#e_plancha_precio',
    '#e_pc_on','#e_pc_precio',
    '#e_prensa_on','#e_prensa_precio',
    '#e_resistencia_on','#e_resistencia_precio',
    '#chk_ganancia','#chk_impuestos','#sub_ganancia','#sub_impuestos'
  ];
  inputs.forEach(sel=>{
    const el = q(sel);
    if (el) el.addEventListener('input', recalc);
    if (el) el.addEventListener('change', recalc);
  });

  // Reset (si existe)
  const btnReset = q('#btn_reset_sub');
  if (btnReset){
    btnReset.addEventListener('click', ()=>{
      const defaults = {
        '#d_prod_on': true, '#d_prod_cant': '36', '#d_prod_precio': '90',
        '#d_papel_on': true, '#d_papel_cant': '100', '#d_papel_precio': '10',
        '#d_tinta_on': true, '#d_tinta_cant': '300', '#d_tinta_precio': '40',
        '#d_cinta_on': true, '#d_cinta_cant': '100', '#d_cinta_precio': '3',
        '#d_empaque_on': true, '#d_empaque_cant': '50', '#d_empaque_precio': '5',
        '#e_impresora_on': false, '#e_impresora_precio': '240',
        '#e_plancha_on': false,   '#e_plancha_precio': '400',
        '#e_pc_on': false,        '#e_pc_precio': '350',
        '#e_prensa_on': false,    '#e_prensa_precio': '180',
        '#e_resistencia_on': false, '#e_resistencia_precio': '50',
        '#chk_ganancia': true, '#sub_ganancia': '40',
        '#chk_impuestos': true, '#sub_impuestos': '16'
      };
      for (const k in defaults){
        const el = q(k);
        if (!el) continue;
        if (typeof defaults[k] === 'boolean') el.checked = defaults[k];
        else el.value = defaults[k];
      }
      recalc();
    });
  }

  // Print / Copy (opcionales, no rompen si no existen helpers globales)
  function copyResumen(){
    const txt = `SUBLIMACIÓN
Directos: ${q('#sub_total_directos').textContent}
Depreciación: ${q('#sub_total_depr').textContent}
Subtotal sin G/I: ${q('#sub_subtotal_no_gi').textContent}
Subtotal: ${q('#sub_subtotal').textContent}
+ Ganancia: ${q('#sub_ganancia_val').textContent}
+ Impuestos: ${q('#sub_impuestos_val').textContent}
Precio de Venta: ${q('#sub_total').textContent}`;
    if (navigator.clipboard) navigator.clipboard.writeText(txt);
  }
  const btnCopy = q('#btn_copy_sub');
  if (btnCopy) btnCopy.addEventListener('click', copyResumen);

  // Inicial
  recalc();
  window.addEventListener('load', recalc);
})();
</script>
<script>
(function(){
  function fmt(x){
    if (Number.isNaN(x) || !isFinite(x)) return "—";
    return (Math.round(x * 10000)/10000).toString();
  }

  // Longitud
  const lenVal = document.getElementById('len_val');
  const lenFrom = document.getElementById('len_from');
  const lenTo = document.getElementById('len_to');
  const lenOut = document.getElementById('len_out');
  const lenFactors = { mm:0.1, cm:1, m:100, in:2.54, ft:30.48, yd:91.44 }; // to cm

  function updLen(){
    const v = parseFloat(lenVal.value||"0");
    const cm = v * (lenFactors[lenFrom.value] || 1);
    const res = cm / (lenFactors[lenTo.value] || 1);
    lenOut.value = fmt(res);
  }
  ['input','change'].forEach(evt=>{
    lenVal?.addEventListener(evt, updLen);
    lenFrom?.addEventListener(evt, updLen);
    lenTo?.addEventListener(evt, updLen);
  });

  // Área
  const areaVal = document.getElementById('area_val');
  const areaFrom = document.getElementById('area_from');
  const areaTo = document.getElementById('area_to');
  const areaOut = document.getElementById('area_out');
  const areaFactors = { cm2:1, m2:10000, in2:6.4516, ft2:929.0304 }; // to cm2

  function updArea(){
    const v = parseFloat(areaVal.value||"0");
    const cm2 = v * (areaFactors[areaFrom.value] || 1);
    const res = cm2 / (areaFactors[areaTo.value] || 1);
    areaOut.value = fmt(res);
  }
  ['input','change'].forEach(evt=>{
    areaVal?.addEventListener(evt, updArea);
    areaFrom?.addEventListener(evt, updArea);
    areaTo?.addEventListener(evt, updArea);
  });

  // Masa/Peso
  const massVal = document.getElementById('mass_val');
  const massFrom = document.getElementById('mass_from');
  const massTo = document.getElementById('mass_to');
  const massOut = document.getElementById('mass_out');
  const massFactors = { g:1, kg:1000, lb:453.59237, oz:28.349523125 }; // to grams

  function updMass(){
    const v = parseFloat(massVal.value||"0");
    const g = v * (massFactors[massFrom.value] || 1);
    const res = g / (massFactors[massTo.value] || 1);
    massOut.value = fmt(res);
  }
  ['input','change'].forEach(evt=>{
    massVal?.addEventListener(evt, updMass);
    massFrom?.addEventListener(evt, updMass);
    massTo?.addEventListener(evt, updMass);
  });

  // Temperatura
  const tmpVal = document.getElementById('tmp_val');
  const tmpFrom = document.getElementById('tmp_from');
  const tmpTo = document.getElementById('tmp_to');
  const tmpOut = document.getElementById('tmp_out');

  function toK(v, u){
    if(u==='C') return v + 273.15;
    if(u==='F') return (v - 32) * 5/9 + 273.15;
    if(u==='K') return v;
    return v;
  }
  function fromK(k, u){
    if(u==='C') return k - 273.15;
    if(u==='F') return (k - 273.15) * 9/5 + 32;
    if(u==='K') return k;
    return k;
  }
  function updTmp(){
    const v = parseFloat(tmpVal.value||"0");
    const K = toK(v, tmpFrom.value);
    const res = fromK(K, tmpTo.value);
    tmpOut.value = fmt(res);
  }
  ['input','change'].forEach(evt=>{
    tmpVal?.addEventListener(evt, updTmp);
    tmpFrom?.addEventListener(evt, updTmp);
    tmpTo?.addEventListener(evt, updTmp);
  });

  // DPI
  const dpiWcm = document.getElementById('dpi_w_cm');
  const dpiHcm = document.getElementById('dpi_h_cm');
  const dpiDpi = document.getElementById('dpi_dpi');
  const dpiPxOut = document.getElementById('dpi_px_out');

  function updPx(){
    const wcm = parseFloat(dpiWcm.value||"0");
    const hcm = parseFloat(dpiHcm.value||"0");
    const dpi = parseFloat(dpiDpi.value||"0");
    const pxf = dpi/2.54;
    const pxW = Math.round(wcm * pxf);
    const pxH = Math.round(hcm * pxf);
    if(isFinite(pxW) && isFinite(pxH)) dpiPxOut.value = pxW + " × " + pxH;
    else dpiPxOut.value = "—";
  }
  ['input','change'].forEach(evt=>{
    dpiWcm?.addEventListener(evt, updPx);
    dpiHcm?.addEventListener(evt, updPx);
    dpiDpi?.addEventListener(evt, updPx);
  });

  const pxW = document.getElementById('px_w');
  const pxH = document.getElementById('px_h');
  const pxDpi = document.getElementById('px_dpi');
  const pxCmOut = document.getElementById('px_cm_out');
  function updCm(){
    const w = parseFloat(pxW.value||"0");
    const h = parseFloat(pxH.value||"0");
    const dpi = parseFloat(pxDpi.value||"0");
    const cmf = 2.54/dpi;
    const cmW = w * cmf;
    const cmH = h * cmf;
    if(isFinite(cmW) && isFinite(cmH)) pxCmOut.value = fmt(cmW) + " × " + fmt(cmH);
    else pxCmOut.value = "—";
  }
  ['input','change'].forEach(evt=>{
    pxW?.addEventListener(evt, updCm);
    pxH?.addEventListener(evt, updCm);
    pxDpi?.addEventListener(evt, updCm);
  });

  // Initialize if elements exist (only on conversor view)
  function init(){
    if(lenVal) updLen();
    if(areaVal) updArea();
    if(massVal) updMass();
    if(tmpVal) updTmp();
    if(dpiWcm) updPx();
    if(pxW) updCm();
  }
  document.addEventListener('DOMContentLoaded', init);
  setTimeout(init, 50);
})();
</script>
<script>
(function(){
  // Namespace
  window.Suite = window.Suite || {};

  // ===== Helpers: EU formatting (comma decimal) =====
  // parseEU: "1.234,56" -> 1234.56 ; also accepts "1234.56"
  Suite.parseEU = function(v){
    if (v == null) return 0;
    if (typeof v === 'number') return v;
    v = (''+v).trim();
    if (!v) return 0;
    // Remove currency and spaces
    v = v.replace(/[^\d,.\-]/g,'');
    // If has comma, assume EU
    if (v.indexOf(',') >= 0){
      v = v.replace(/\./g,'').replace(',', '.');
    }
    return Number(v || 0);
  };

  // euroStr: format WITHOUT changing precision (for strings that already come with decimals).
  Suite.euroStr = function(s){
    if (s == null) return '';
    s = ''+s;
    // Do not change thousands grouping here; just swap decimal point to comma when appropriate
    // Replace only decimal point in numeric tokens: 12.34 -> 12,34 ; keep dots in non-numeric words.
    return s.replace(/(\d+)\.(\d+)/g, '$1,$2');
  };

  // euro: format a Number to EU with given decimals; if decimals is null, default = 2
  Suite.euro = function(n, decimals){
    if (n == null || isNaN(n)) n = 0;
    if (decimals == null) decimals = 2;
    // Use Intl then swap space to non-breaking and ensure currency-like spacing
    const s = n.toLocaleString('de-DE', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    return s;
  };

  // Format an element value/text with EU decimal, preserving currency prefix if present like "$ 1,23"
  Suite.euroInto = function(el, n, decimals){
    const node = (typeof el === 'string') ? document.getElementById(el) : el;
    if (!node) return;
    const v = Suite.euro(n, decimals);
    if (node.tagName === 'INPUT'){
      // If it already has $ or other symbol, preserve
      const hasCurrency = /^\s*[$€Bs\.]/.test(node.value || '');
      node.value = hasCurrency ? (node.value.replace(/^\s*[$€Bs\.]+\s*/, '$ ') + v) : v;
    }else{
      node.textContent = v;
    }
  };

  // ===== Resets consistentes (plantilla) =====
  function resetScope(scope){
    const root = (typeof scope === 'string') ? document.querySelector(scope) : scope;
    if (!root) return;
    // 1) Checkboxes OFF
    root.querySelectorAll('input[type="checkbox"]').forEach(chk => { chk.checked = false; });
    // 2) Restaurar data-default si existe
    root.querySelectorAll('input, select, textarea').forEach(el => {
      if (el.hasAttribute('data-default')) {
        const d = el.getAttribute('data-default');
        if (el.type === 'checkbox') el.checked = (d === 'true');
        else el.value = d;
      }
    });
    // 3) Disparar eventos para recalcular
    root.querySelectorAll('input, select, textarea').forEach(el => {
      el.dispatchEvent(new Event('input', { bubbles:true }));
      el.dispatchEvent(new Event('change', { bubbles:true }));
    });
  }

  // Vincular botones reset por módulo si existen (sin romper lógicas propias)
  const resets = [
    ['#view-vinil'      , '#btn_reset_vinil'     ],
    ['#view-sublimacion', '#btn_reset_sub'       ],
    ['#view-etiquetas'  , '#btn_reset_eti'       ],
    ['#view-empaques'   , '#btn_reset_emp'       ],
    ['#view-dtf'        , '#btn_reset_dtf'       ]
  ];
  resets.forEach(([scopeSel, btnSel]) => {
    const scope = document.querySelector(scopeSel);
    const btn = document.querySelector(btnSel);
    if (scope && btn && !btn.__suiteHooked){
      btn.__suiteHooked = true;
      btn.addEventListener('click', () => resetScope(scope));
    }
  });

  // Reset General
  const btnResetGeneral = document.getElementById('btn_reset_general');
  if (btnResetGeneral && !btnResetGeneral.__suiteHooked){
    btnResetGeneral.__suiteHooked = true;
    btnResetGeneral.addEventListener('click', () => {
      const app = document.querySelector('.app') || document.body;
      resetScope(app);
    });
  }

  // ===== Formato EU global en campos ".ud" y ".result" =====
  // Observa mutaciones y reemplaza "." por "," en tokens numéricos sin tocar la lógica
  function applyEUToNode(node){
    if (!node) return;
    // INPUT readonly (ud) -> sustituir punto decimal por coma en su value
    if (node.tagName === 'INPUT'){
      if (node.readOnly || node.classList.contains('ud')){
        node.value = Suite.euroStr(node.value);
      }
    } else {
      // Spans .result, etc.
      if (node.classList && (node.classList.contains('result') || node.classList.contains('ud'))){
        node.textContent = Suite.euroStr(node.textContent);
      }
    }
  }

  const app = document.querySelector('.app') || document.body;
  // Initial pass
  app.querySelectorAll('.ud, .result, input.ud').forEach(el => applyEUToNode(el));

  // Observe changes
  const mo = new MutationObserver((muts)=>{
    for (const m of muts){
      if (m.type === 'childList'){
        m.addedNodes && m.addedNodes.forEach(n => {
          if (n.nodeType === 1){
            if (n.matches && n.matches('.ud, .result, input.ud')) applyEUToNode(n);
            n.querySelectorAll && n.querySelectorAll('.ud, .result, input.ud').forEach(el => applyEUToNode(el));
          }
        });
      }
      if (m.type === 'characterData'){
        const p = m.target.parentElement;
        if (p && (p.classList.contains('ud') || p.classList.contains('result'))) applyEUToNode(p);
      }
      if (m.type === 'attributes'){
        const el = m.target;
        if (el && (el.classList.contains('ud') || el.classList.contains('result') || (el.tagName==='INPUT' && el.readOnly))){
          applyEUToNode(el);
        }
      }
    }
  });
  mo.observe(app, { childList:true, subtree:true, characterData:true, attributes:true, attributeFilter:['value','class'] });

  // ===== Conversor: SOLO separador decimal EU en salidas =====
  const conversor = document.getElementById('view-conversor');
  if (conversor){
    const outIds = ['len_out','area_out','mass_out','tmp_out','dpi_px_out','px_cm_out'];
    function euConversorOutputs(){
      outIds.forEach(id => {
        const el = document.getElementById(id);
        if (el){
          // No tocar los cálculos ni redondeo originales; sólo cambio visual del separador
          el.value = Suite.euroStr(el.value);
        }
      });
    }
    // Re-aplicar en cualquier cambio dentro del conversor
    conversor.addEventListener('input', euConversorOutputs, true);
    conversor.addEventListener('change', euConversorOutputs, true);
    // Primer pase
    euConversorOutputs();
  }

  // ===== Dark mode toggle persists event formatting =====
  const darkT = document.getElementById('dark_toggle');
  if (darkT && !darkT.__suiteHooked){
    darkT.__suiteHooked = true;
    darkT.addEventListener('change', ()=>{
      document.body.classList.toggle('dark', darkT.checked);
      // Re-aplicar formato EU a la vista actual
      app.querySelectorAll('.ud, .result, input.ud').forEach(el => applyEUToNode(el));
    });
  }
})();
</script>
<script>
// === Hard-ensure EU formatting for Vinil → Depreciación ===
(function(){
  function fmtEU(n, dec){ 
    if (!isFinite(n)) n=0;
    dec = (dec===undefined)?2:dec;
    const s = Number(n).toFixed(dec);
    const parts = s.split('.');
    const a = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,'.');
    return a + (dec?(','+parts[1]):'');
  }
  function money(n){ return '$ ' + fmtEU(n); }
  function parseAny(v){
    if (v==null) return 0;
    if (typeof v === 'number') return v;
    v = String(v).trim();
    if (!v) return 0;
    // strip currency and spaces
    v = v.replace(/[^0-9,.-]/g,'');
    // if has comma, treat as EU
    if (v.indexOf(',') >= 0) { v = v.replace(/\./g,'').replace(',', '.'); }
    return parseFloat(v) || 0;
  }
  function ensureVinilEU(){
    var root = document.getElementById('view-vinil');
    if (!root) return;
    var changed = false;
    root.querySelectorAll('input.dep_mes, input.dep_ud').forEach(function(el){
      var n = parseAny(el.value);
      var eu = money(n);
      if (el.value !== eu) { el.value = eu; changed = true; }
    });
    // Solo formatea; el resumen de Depreciación se calcula en el recálculo principal del módulo
    return changed;
  }
  // First pass at start & after small delays
  document.addEventListener('DOMContentLoaded', function(){
    ensureVinilEU();
    [50,150,400,800,1600].forEach(function(ms){ setTimeout(ensureVinilEU, ms); });
  });
  // Re-run on any input/change in Vinil
  var root = document.getElementById('view-vinil');
  if (root){
    ['input','change'].forEach(function(evt){
      root.addEventListener(evt, ensureVinilEU, {passive:true});
    });
  }
})();
</script>
<script>
// === Ensure EU formatting for DTF chips on load and changes ===
(function(){
  function fmtEU(n, dec){ 
    if (!isFinite(n)) n=0;
    dec = (dec==null)?2:dec;
    const s = Number(n).toFixed(dec);
    const [a,b] = s.split('.');
    return a.replace(/\B(?=(\d{3})+(?!\d))/g,'.') + (dec?(','+b):'');
  }
  function money(n){ return '$ ' + fmtEU(n); }
  function parseAny(s){
    if (s==null) return 0;
    if (typeof s === 'number') return s;
    s = String(s).trim();
    if (!s) return 0;
    s = s.replace(/[^0-9,.-]/g,'');
    if (s.indexOf(',') >= 0){ s = s.replace(/\./g,'').replace(',', '.'); }
    return parseFloat(s) || 0;
  }
  const ids = [
    'dtf_total_directos','dtf_total_prenda','dtf_total_dep','dtf_total_extras','dtf_subtotal_no_gi',
    'dtf_subtotal','dtf_ganancia_val','dtf_impuestos_val','dtf_costo_ud_dtf','dtf_costo_por_camiseta',
    'sub_subtotal_no_gi','sub_ganancia_val','sub_impuestos_val','sub_total','dtf_total'
  ];
  function ensure(){
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      const n = parseAny(el.textContent);
      const eu = money(n);
      if (el.textContent !== eu) el.textContent = eu;
    });
  }
  document.addEventListener('DOMContentLoaded', function(){
    ensure();
    [60,200,600,1200].forEach(ms=>setTimeout(ensure, ms));
  });
  // Listen within DTF view for any change to re-ensure quickly
  const dtf = document.getElementById('view-dtf');
  if (dtf){
    dtf.addEventListener('input', ensure, {passive:true});
    dtf.addEventListener('change', ensure, {passive:true});
  }
})();
</script>
<script>
(() => {
  function parseAny(s){
    if (s == null) return 0;
    if (typeof s === 'number') return s;
    s = String(s).trim();
    if (!s) return 0;
    s = s.replace(/[^0-9,\.\-]/g,'');
    if (s.indexOf(',') >= 0){ s = s.replace(/\./g,'').replace(',', '.'); }
    return parseFloat(s) || 0;
  }
  function fmtEU2(n){
    try { if (typeof fmtEU === 'function') return fmtEU(n); } catch(e){}
    if (!isFinite(n)) n = 0;
    const s = Number(n).toFixed(2);
    const parts = s.split('.');
    const a = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,'.');
    return a + ',' + parts[1];
  }
  function money2(n){ return '$ ' + fmtEU2(n); }

  function mirrorDTF(){
    const src = document.getElementById('dtf_total');            // visible en módulo DTF
    const dst = document.getElementById('dtf_total_resumen');     // visible en Resumen
    if (src && dst) dst.textContent = src.textContent;

    // Mantener compatibilidad con el agregador anterior
    const sum = document.getElementById('sum_dtf');
    if (src && sum) sum.textContent = src.textContent;

    // Recalcular Total General Seleccionado
    const get = id => parseAny(document.getElementById(id)?.textContent);
    const set = (id,v)=>{ const el=document.getElementById(id); if(el) el.textContent = money2(isFinite(v)?v:0); };

    const vin = get('sum_vinil'), sub = get('sum_sublim'), etq = get('sum_etiq'),
          emp = get('sum_emp'),   env = get('sum_env'),   dtf = get('sum_dtf');

    let total = 0;
    if (document.getElementById('sum_incluir_vinil')?.checked) total += vin;
    if (document.getElementById('sum_incluir_sublim')?.checked) total += sub;
    if (document.getElementById('sum_incluir_etiq')?.checked)  total += etq;
    if (document.getElementById('sum_incluir_emp')?.checked)   total += emp;
    if (document.getElementById('sum_incluir_env')?.checked)   total += env;
    if (document.getElementById('sum_incluir_dtf')?.checked)   total += dtf;

    set('sum_total', total);
  }

  // Disparar al cargar y cuando algo cambie en DTF
  document.addEventListener('DOMContentLoaded', mirrorDTF);
  const dtfView = document.getElementById('view-dtf');
  if (dtfView){
    dtfView.addEventListener('input',  mirrorDTF, {passive:true});
    dtfView.addEventListener('change', mirrorDTF, {passive:true});
  }
  // Si existe recompute() en DTF, intenta engancharlo
  try {
    const original = window.recompute;
    if (typeof original === 'function'){
      window.recompute = function(){ original.apply(this, arguments); mirrorDTF(); };
    }
  } catch(e){}
})();
</script>
<script>
(function(){
  function parseAny(s){
    if (s == null) return 0;
    if (typeof s === 'number') return s;
    s = String(s).trim();
    if (!s) return 0;
    s = s.replace(/[^0-9,.\-]/g,'');
    if (s.indexOf(',') >= 0){ s = s.replace(/\./g,'').replace(',', '.'); }
    return parseFloat(s) || 0;
  }
  function moneyEU(n){ try { return '$ ' + fmtEU(isFinite(n)?n:0); } catch(e){ 
    if (!isFinite(n)) n=0; const s=Number(n).toFixed(2); const [a,b]=s.split('.');
    return '$ ' + a.replace(/\B(?=(\d{3})+(?!\d))/g,'.') + ',' + b;
  }}

  // Define/update window.resumen_update to include DTF
  window.resumen_update = function(){
    const get = id => parseAny(document.getElementById(id)?.textContent);
    let vin=get('sum_vinil'), sub=get('sum_sublim'), etq=get('sum_etiq'),
        emp=get('sum_emp'),   env=get('sum_env'),   dtf=get('sum_dtf');

    let total = 0;
    if (document.getElementById('sum_incluir_vinil')?.checked) total += vin;
    if (document.getElementById('sum_incluir_sublim')?.checked) total += sub;
    if (document.getElementById('sum_incluir_etiq')?.checked)  total += etq;
    if (document.getElementById('sum_incluir_emp')?.checked)   total += emp;
    if (document.getElementById('sum_incluir_env')?.checked)   total += env;
    if (document.getElementById('sum_incluir_dtf')?.checked)   total += dtf;

    const el = document.getElementById('sum_total');
    if (el) el.textContent = moneyEU(total);
  };

  // Wire up checkbox changes to call resumen_update
  document.addEventListener('DOMContentLoaded', function(){
    ['sum_incluir_vinil','sum_incluir_sublim','sum_incluir_etiq','sum_incluir_emp','sum_incluir_env','sum_incluir_dtf']
      .forEach(id => {
        const el = document.getElementById(id);
        if (el){
          el.addEventListener('input', window.resumen_update, {passive:true});
          el.addEventListener('change', window.resumen_update, {passive:true});
        }
      });
    // Initial compute in case values are present
    window.resumen_update();
  });

  // If we already injected DTF mirror, hook it to call resumen_update afterwards
  try{
    const original_mirror = window.__mirrorDTF__;
    if (typeof original_mirror === 'function'){
      window.__mirrorDTF__ = function(){ original_mirror(); window.resumen_update(); };
    }
  }catch(e){}
})();
</script>
<script>
(() => {
  const $  = s => document.querySelector(s);

  // ---------- Parsing & Formato EU (optimizado, sin parpadeos) ----------
  // 1) Parser robusto (acepta "1.234,56" o "1234.56")
  function parseAny(txt){
    if (txt == null) return 0;
    const raw = String(txt).trim().replace(/[^0-9,.\-]/g,'');
    if (!raw) return 0;
    const norm = raw.includes(',') ? raw.replace(/\./g,'').replace(',', '.') : raw;
    const v = parseFloat(norm);
    return isFinite(v) ? v : 0;
  }

  // 2) Formateador estable con Intl, con fallback manual
  const _fmtIntl = (() => {
    try {
      // Locale con coma decimal; forzamos 2 decimales fijos.
      const nf = new Intl.NumberFormat('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      return (n) => '$ ' + nf.format(isFinite(n) ? +n : 0);
    } catch(e) {
      return null;
    }
  })();

  function moneyEU(n){
    // Si la suite define fmtEU, úsalo (evita doble formateo)
    try { if (typeof fmtEU === 'function') return '$ ' + fmtEU(isFinite(n)?+n:0); } catch {}
    if (_fmtIntl) return _fmtIntl(n);
    // Fallback manual
    n = isFinite(n) ? +n : 0;
    const s = n.toFixed(2);
    const [a,b] = s.split('.');
    return '$ ' + a.replace(/\B(?=(\d{3})+(?!\d))/g, '.') + ',' + b;
  }

  // 3) Evitar parpadeos: sólo escribir si cambia
  function setTextIfChanged(el, text){
    if (!el) return;
    if (el.textContent !== text) el.textContent = text;
  }
  function setMoneyById(id, n){
    const el = document.getElementById(id);
    if (el) setTextIfChanged(el, moneyEU(n));
  }

  // ---------- Lectores de totales de módulos ----------
  const T = id => document.getElementById(id)?.textContent || '';
  const readVin  = () => parseAny(T('vin_total') || T('totalFinal'));
  const readSub  = () => parseAny(T('sub_total'));
  const readEti  = () => parseAny(T('eti_total'));
  const readEmp  = () => parseAny(T('emp_total'));
  const readDTF  = () => parseAny(T('dtf_total'));
  const readEnv  = () => parseAny(T('env_total'));

  function values(){
    return { vin:readVin(), sub:readSub(), eti:readEti(), emp:readEmp(), dtf:readDTF(), env:readEnv() };
  }

  // ---------- Refresco del Resumen (optimizado con rAF) ----------
  let rafId = 0;
  function _doRefresh(){
    rafId = 0;
    const v = values();
    setMoneyById('sum_vinil',  v.vin);
    setMoneyById('sum_sublim', v.sub);
    setMoneyById('sum_etiq',   v.eti);
    setMoneyById('sum_emp',    v.emp);
    setMoneyById('sum_dtf',    v.dtf);
    setMoneyById('sum_env',    v.env);

    let total = 0;
    if (document.getElementById('sum_incluir_vinil')?.checked)  total += v.vin;
    if (document.getElementById('sum_incluir_sublim')?.checked) total += v.sub;
    if (document.getElementById('sum_incluir_etiq')?.checked)   total += v.eti;
    if (document.getElementById('sum_incluir_emp')?.checked)    total += v.emp;
    if (document.getElementById('sum_incluir_env')?.checked)    total += v.env;
    if (document.getElementById('sum_incluir_dtf')?.checked)    total += v.dtf;
    setMoneyById('sum_total', total);
  }
  function refreshResumen(){
    if (rafId) return;                // coalescing
    rafId = requestAnimationFrame(_doRefresh);
  }
  window.resumen_refresh = refreshResumen;

  // ---------- Utilitarios ----------
  function copyResumen(){
    const g = id => document.getElementById(id)?.textContent?.trim() || '';
    const lines = [
      `Vinil: ${g('sum_vinil')}`,
      `Sublimación: ${g('sum_sublim')}`,
      `Etiquetas: ${g('sum_etiq')}`,
      `Empaques: ${g('sum_emp')}`,
      `Envíos: ${g('sum_env')}`,
      `DTF: ${g('sum_dtf')}`,
      `TOTAL: ${g('sum_total')}`
    ];
    navigator.clipboard?.writeText?.(lines.join('\n'));
  }

  // ---------- Wire-up ----------
  document.addEventListener('DOMContentLoaded', () => {
    refreshResumen();

    // Cambios en switches del propio resumen
    ['sum_incluir_vinil','sum_incluir_sublim','sum_incluir_etiq','sum_incluir_emp','sum_incluir_env','sum_incluir_dtf']
      .forEach(id => {
        const el = document.getElementById(id);
        el?.addEventListener('change', refreshResumen, {passive:true});
        el?.addEventListener('input',  refreshResumen, {passive:true});
      });

    // Escucha cambios básicos en módulos (inputs)
    ['view-vinil','view-sublimacion','view-etiquetas','view-empaques','view-envios','view-dtf']
      .forEach(view => {
        const root = document.getElementById(view);
        root?.addEventListener('input',  refreshResumen, {passive:true});
        root?.addEventListener('change', refreshResumen, {passive:true});
      });

    document.getElementById('btn_copy_resumen')?.addEventListener('click', copyResumen);
    document.getElementById('btn_print_resumen')?.addEventListener('click', () => window.print());
  });
})();
</script>
<script>
(function(){
  function euParse(x){
    if (window.Suite && typeof Suite.parseEU === 'function') return Suite.parseEU(x);
    if (x == null) return 0;
    const s = String(x).trim();
    if (!s) return 0;
    const clean = s.replace(/[^0-9,.-]/g,'');
    if (clean.indexOf(',') >= 0){
      const last = clean.lastIndexOf(',');
      const left = clean.slice(0,last).replace(/\./g,'');
      const right = clean.slice(last+1);
      return parseFloat(left + '.' + right) || 0;
    }
    return parseFloat(clean) || 0;
  }
  function euro(n){
    let out = null;
    if (window.Suite && typeof Suite.euro === 'function'){
      try { out = Suite.euro(n); } catch(e){ out = null; }
    }
    if (!out || typeof out !== 'string' || !out.trim()){
      out = (n||0).toLocaleString('es-ES',{ minimumFractionDigits:2, maximumFractionDigits:2 });
    }
    // Asegurar el prefijo $ siempre
    if (!/\$/u.test(out)) out = '$ ' + out;
    return out;
  }catch(e){}
    }
    let out = (n||0).toLocaleString('es-ES',{ minimumFractionDigits:2, maximumFractionDigits:2 });
    // asegurar prefijo $ si falta
    if (!/^\s*\$/u.test(out)) out = '$ ' + out;
    return out;
  }

  // MO simple por sueldo mensual
  function moCalc(pref){
    const sueldo = euParse(document.getElementById(pref+'_mo_sueldo')?.value);
    const horasMes = Math.max(1, euParse(document.getElementById(pref+'_mo_horas_mes')?.value) || 176);
    const setup = euParse(document.getElementById(pref+'_mo_setup')?.value);
    const run = euParse(document.getElementById(pref+'_mo_run')?.value);
    const U = Math.max(0, euParse(document.getElementById(pref+'_mo_units')?.value) || 0);
    const tarifaH = horasMes > 0 ? (sueldo / horasMes) : 0;  // $/h
    const horas = (setup + run * U) / 60;                     // h
    const total = tarifaH * horas;
    const unit = U > 0 ? (total / U) : total;
    return { total, unit, U };
  }

  function applyToModule(cfg){
    const {pref, baseNoGIId, subtotalId, chkGId, pGId, chkIId, pIId, gValId, iValId, totalId} = cfg;
    const baseEl = document.getElementById(baseNoGIId);
    if (!baseEl) return;
    // Lee subtotal sin G/I ya pintado por el módulo
    let base = euParse(baseEl.textContent);
    // Suma MO si activo
    const on = document.getElementById(pref+'_mo_on')?.checked;
    const mo = moCalc(pref);
    const pill = document.getElementById(pref+'_mo_pill');
    if (on){
      base += mo.total;
      if (pill){
        pill.style.display='inline-flex';
        const valEl = document.getElementById(pref+'_mo_val');
        if (valEl) valEl.textContent = euro(mo.total);
      }
    }else{
      if (pill) pill.style.display='none';
    }
    // Recalcular G/I y Total del módulo
    const chkG = document.getElementById(chkGId)?.checked;
    const chkI = document.getElementById(chkIId)?.checked;
    const pG = euParse(document.getElementById(pGId)?.value);
    const pI = euParse(document.getElementById(pIId)?.value);
    const g = chkG ? base * (pG/100) : 0;
    const i = chkI ? (base + g) * (pI/100) : 0;

    const subEl = document.getElementById(subtotalId); if (subEl) subEl.textContent = euro(base);
    const gEl = document.getElementById(gValId); if (gEl) gEl.textContent = euro(g);
    const iEl = document.getElementById(iValId); if (iEl) iEl.textContent = euro(i);
    const tEl = document.getElementById(totalId); if (tEl) tEl.textContent = euro(base + g + i);
  }

  function wire(pref){
    // Abrir/cerrar panel con botón
    document.addEventListener('click', function(e){
      const btn = e.target.closest('#'+pref+'_mo_cfg_btn');
      if(btn){
        const panel = document.getElementById(pref+'_mo_cfg');
        if(panel){
          const isHidden = getComputedStyle(panel).display === 'none';
          panel.style.display = isHidden ? 'flex' : 'none';
        }
      }
    });
    // Abrir panel al marcar el checkbox
    const cb = document.getElementById(pref+'_mo_on');
    if (cb){
      cb.addEventListener('change', ()=>{
        const panel = document.getElementById(pref+'_mo_cfg');
        if (panel && cb.checked) panel.style.display='flex';
        refreshAll();
      });
    }
    // Inputs de MO con parser EU
    ['sueldo','horas_mes','setup','run','units'].forEach(k=>{
      const el = document.getElementById(pref+'_mo_'+k);
      if (el){
        ['input','change'].forEach(ev=>el.addEventListener(ev, refreshAll));
      }
    });
  }

  function refreshAll(){
    [
      {pref:'vin', baseNoGIId:'vin_subtotal_no_gi', subtotalId:'vin_subtotal', chkGId:'vin_chk_ganancia', pGId:'vin_ganancia', chkIId:'vin_chk_impuestos', pIId:'vin_impuestos', gValId:'vin_ganancia_val', iValId:'vin_impuestos_val', totalId:'vin_total'},
      {pref:'dtf', baseNoGIId:'dtf_subtotal_no_gi', subtotalId:'dtf_subtotal', chkGId:'dtf_chk_ganancia', pGId:'dtf_ganancia', chkIId:'dtf_chk_impuestos', pIId:'dtf_impuestos', gValId:'dtf_ganancia_val', iValId:'dtf_impuestos_val', totalId:'dtf_total'},
      {pref:'sub', baseNoGIId:'sub_subtotal_no_gi', subtotalId:'sub_subtotal', chkGId:'chk_ganancia', pGId:'sub_ganancia', chkIId:'chk_impuestos', pIId:'sub_impuestos', gValId:'sub_ganancia_val', iValId:'sub_impuestos_val', totalId:'sub_total'},
      {pref:'eti', baseNoGIId:'eti_subtotal_no_gi', subtotalId:'eti_subtotal', chkGId:'eti_chk_ganancia', pGId:'eti_ganancia', chkIId:'eti_chk_impuestos', pIId:'eti_impuestos', gValId:'eti_ganancia_val', iValId:'eti_impuestos_val', totalId:'eti_total'},
      {pref:'emp', baseNoGIId:'emp_subtotal_no_gi', subtotalId:'emp_subtotal', chkGId:'emp_chk_ganancia', pGId:'emp_ganancia', chkIId:'emp_chk_impuestos', pIId:'emp_impuestos', gValId:'emp_ganancia_val', iValId:'emp_impuestos_val', totalId:'emp_total'},
    ].forEach(applyToModule);
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    ['vin','dtf','sub','eti','emp'].forEach(wire);
    // Sincronización suave con los cálculos existentes
    const tick = ()=>{ requestAnimationFrame(()=>{ refreshAll(); setTimeout(tick, 120); }); };
    tick();
  });
})();
</script>
<script>
/* MO CORE START */
  // === VINIL: actualizar solo G/I/Total usando observer, sin tocar "Total Vinil" ===
  function vin_apply_once(){
    const ids = {baseNoGI:'vin_subtotal_no_gi', subtotal:'vin_subtotal', chkG:'vin_chk_ganancia', pG:'vin_ganancia', chkI:'vin_chk_impuestos', pI:'vin_impuestos', gVal:'vin_ganancia_val', iVal:'vin_impuestos_val', total:'vin_total'};
    const baseEl = document.getElementById(ids.baseNoGI); if(!baseEl) return;
    let base = euParse(baseEl.textContent);
    const on  = document.getElementById('vin_mo_on')?.checked;
    let mo = 0;
    if(on){
      const sueldo = euParse(document.getElementById('vin_mo_sueldo')?.value);
      const hmes   = Math.max(1, euParse(document.getElementById('vin_mo_horas_mes')?.value) || 176);
      const setup  = euParse(document.getElementById('vin_mo_setup')?.value);
      const run    = euParse(document.getElementById('vin_mo_run')?.value);
      const U      = Math.max(0, euParse(document.getElementById('vin_mo_units')?.value) || 0);
      const tarifa = hmes>0 ? (sueldo/hmes) : 0;
      mo = tarifa * ((setup + run*U)/60);
      const pill = document.getElementById('vin_mo_pill'); if(pill){ pill.style.display='inline-flex'; const v=document.getElementById('vin_mo_val'); if(v) v.textContent = euro(mo); }
    }else{ const pill = document.getElementById('vin_mo_pill'); if(pill) pill.style.display='none'; }
    const subtotal = base + mo;
    const chkG = document.getElementById(ids.chkG)?.checked;
    const chkI = document.getElementById(ids.chkI)?.checked;
    const pG = euParse(document.getElementById(ids.pG)?.value);
    const pI = euParse(document.getElementById(ids.pI)?.value);
    const g = chkG ? subtotal*(pG/100) : 0;
    const i = chkI ? (subtotal+g)*(pI/100) : 0;
    const set = (id,val)=>{ const el=document.getElementById(id); if(!el) return; const txt=euro(val); if(el.textContent!==txt) el.textContent=txt; };
    set(ids.subtotal, subtotal);
    set(ids.gVal, g);
    set(ids.iVal, i);
    set(ids.total, subtotal+g+i);
  }
  function vin_bind_observer(){
    const tgt = document.getElementById('vin_subtotal_no_gi');
    if(!tgt || tgt.__mo_observed__) return;
    const obs = new MutationObserver(()=>vin_apply_once());
    obs.observe(tgt, {characterData:true, subtree:true, childList:true});
    tgt.__mo_observed__ = true;
  }

(function(){
  function euParse(x){ try{ if(typeof parseEU==='function') return parseEU(x); }catch(e){}
    if(x==null) return 0; const s=String(x).trim(); if(!s) return 0;
    const t=s.replace(/[^0-9,.-]/g,'');
    if(t.includes(',')){ const i=t.lastIndexOf(','); return parseFloat((t.slice(0,i).replace(/\./g,''))+'.'+t.slice(i+1))||0; }
    return parseFloat(t)||0;
  }
  function euro(n){ try{ if(typeof fmtUSD==='function') return fmtUSD(n); }catch(e){}
    let out=(n||0).toLocaleString('es-ES',{ minimumFractionDigits:2, maximumFractionDigits:2 });
    if(!/^\s*\$/u.test(out)) out = '$ ' + out;
    return out;
  }
  function moCalc(pref){
    const sueldo = euParse(document.getElementById(pref+'_mo_sueldo')?.value);
    const hmes   = Math.max(1, euParse(document.getElementById(pref+'_mo_horas_mes')?.value) || 176);
    const setup  = euParse(document.getElementById(pref+'_mo_setup')?.value);
    const run    = euParse(document.getElementById(pref+'_mo_run')?.value);
    const U      = Math.max(0, euParse(document.getElementById(pref+'_mo_units')?.value) || 0);
    const tarifa = hmes>0 ? (sueldo/hmes) : 0;
    const horas  = (setup + run*U)/60;
    const total  = tarifa * horas;
    return {total, U};
  }
  function apply(pref, ids){
    const baseEl = document.getElementById(ids.baseNoGI);
    if(!baseEl) return;
    let base = euParse(baseEl.textContent);
    const on  = document.getElementById(pref+'_mo_on')?.checked;
    let mo=0;
    if(on){
      mo = moCalc(pref).total;
      const pill = document.getElementById(pref+'_mo_pill');
      if(pill){ pill.style.display='inline-flex'; const v=document.getElementById(pref+'_mo_val'); if(v) v.textContent = euro(mo); }
    }else{
      const pill = document.getElementById(pref+'_mo_pill'); if(pill) pill.style.display='none';
    }
    const subtotal = base + mo;
    // G/I
    const chkG = document.getElementById(ids.chkG)?.checked;
    const chkI = document.getElementById(ids.chkI)?.checked;
    const pG = euParse(document.getElementById(ids.pG)?.value);
    const pI = euParse(document.getElementById(ids.pI)?.value);
    const g = chkG ? subtotal*(pG/100) : 0;
    const i = chkI ? (subtotal+g)*(pI/100) : 0;
    // paint
    const set = (id,val)=>{ const el=document.getElementById(id); if(!el) return; const txt=euro(val); if(el.textContent!==txt) el.textContent=txt; };
    
    // (vin) handled via observer below

    set(ids.gVal, g);
    set(ids.iVal, i);
    set(ids.total, subtotal + g + i);
  }
  const CFGS = [
    {pref:'vin', ids:{baseNoGI:'vin_subtotal_no_gi', subtotal:'vin_subtotal', chkG:'vin_chk_ganancia', pG:'vin_ganancia', chkI:'vin_chk_impuestos', pI:'vin_impuestos', gVal:'vin_ganancia_val', iVal:'vin_impuestos_val', total:'vin_total'}},
    {pref:'dtf', ids:{baseNoGI:'dtf_subtotal_no_gi', subtotal:'dtf_subtotal', chkG:'dtf_chk_ganancia', pG:'dtf_ganancia', chkI:'dtf_chk_impuestos', pI:'dtf_impuestos', gVal:'dtf_ganancia_val', iVal:'dtf_impuestos_val', total:'dtf_total'}},
    {pref:'sub', ids:{baseNoGI:'sub_subtotal_no_gi', subtotal:'sub_subtotal', chkG:'chk_ganancia', pG:'sub_ganancia', chkI:'chk_impuestos', pI:'sub_impuestos', gVal:'sub_ganancia_val', iVal:'sub_impuestos_val', total:'sub_total'}},
    {pref:'eti', ids:{baseNoGI:'eti_subtotal_no_gi', subtotal:'eti_subtotal', chkG:'eti_chk_ganancia', pG:'eti_ganancia', chkI:'eti_chk_impuestos', pI:'eti_impuestos', gVal:'eti_ganancia_val', iVal:'eti_impuestos_val', total:'eti_total'}},
    {pref:'emp', ids:{baseNoGI:'emp_subtotal_no_gi', subtotal:'emp_subtotal', chkG:'emp_chk_ganancia', pG:'emp_ganancia', chkI:'emp_chk_impuestos', pI:'emp_impuestos', gVal:'emp_ganancia_val', iVal:'emp_impuestos_val', total:'emp_total'}},
  ];
  // Toggle panel (delegated)
  document.addEventListener('click', function(ev){
    const btn = ev.target.closest('button[id$="_mo_cfg_btn"]');
    if(btn){
      const pref = btn.id.replace('_mo_cfg_btn','');
      const panel = document.getElementById(pref+'_mo_cfg');
      if(panel){ const show = getComputedStyle(panel).display==='none'; panel.style.display = show? 'flex':'none'; }
    }
  });
  // Checkbox opens panel and triggers
  ['vin','dtf','sub','eti','emp'].forEach(function(pref){
    const cb = document.getElementById(pref+'_mo_on');
    if(cb){ cb.addEventListener('change', function(){ const panel=document.getElementById(pref+'_mo_cfg'); if(panel && cb.checked) panel.style.display='flex';  if(pref==='vin') vin_bind_observer(); }); }
    ['sueldo','horas_mes','setup','run','units'].forEach(function(k){
      const el = document.getElementById(pref+'_mo_'+k); if(el){ ['input','change'].forEach(function(ev){ el.addEventListener(ev, tick); }); }
    });
  });
  function tick(){ CFGS.forEach(c=>apply(c.pref, c.ids)); }
  // gentle sync loop
  let __mo_last=0; const __mo_loop=()=>{ const now=performance.now(); if(now-__mo_last>350){ __mo_last=now; tick(); } requestAnimationFrame(__mo_loop); }; requestAnimationFrame(__mo_loop);
  document.addEventListener('DOMContentLoaded', function(){ vin_bind_observer(); tick(); });
})();
/* MO CORE END */
</script>
<script id="sub_patch_v14">
(()=>{

  if (window.__SUB_V14_PATCHED__) return;
  window.__SUB_V14_PATCHED__ = true;

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const inView = $('#view-sublimacion') || document;

  // --- Safe EU parsing / formatting (event-driven, sin MutationObserver)
  const toEU = (n) => {
    if (!isFinite(n)) n = 0;
    const s = Number(n).toFixed(2);
    return '$ ' + s.replace('.', ',');
  };
  const parseEU = (v) => {
    if (v == null) return 0;
    if (typeof v === 'number') return v;
    let s = String(v).trim();
    if (s === '') return 0;
    s = s.replace(/[^0-9,.\-]/g, '');
    const hasComma = s.indexOf(',') >= 0;
    const hasDot = s.indexOf('.') >= 0;
    if (hasComma && hasDot) {
      s = s.replace(/\./g, '').replace(',', '.');
    } else if (hasComma && !hasDot) {
      s = s.replace(',', '.');
    }
    const num = parseFloat(s);
    return isFinite(num) ? num : 0;
  };

  const traceOn = location.hash.includes('trace');
  const TRACE = (...args)=>{ if(traceOn) console.log('[SUB]', ...args); };

  // --- Mapeo de elementos de Sublimación
  const ids = [
    'd_prod_on','d_prod_cant','d_prod_precio','d_prod_ud',
    'd_papel_on','d_papel_cant','d_papel_precio','d_papel_ud',
    'd_tinta_on','d_tinta_cant','d_tinta_precio','d_tinta_ud',
    'd_cinta_on','d_cinta_cant','d_cinta_precio','d_cinta_ud',
    'd_empaque_on','d_empaque_cant','d_empaque_precio','d_empaque_ud',
    'e_impresora_on','e_impresora_precio','e_impresora_mes','e_impresora_ud',
    'e_plancha_on','e_plancha_precio','e_plancha_mes','e_plancha_ud',
    'e_pc_on','e_pc_precio','e_pc_mes','e_pc_ud',
    'e_prensa_on','e_prensa_precio','e_prensa_mes','e_prensa_ud',
    'e_resistencia_on','e_resistencia_precio','e_resistencia_mes','e_resistencia_ud',
    'sub_total_directos','sub_total_depr','sub_subtotal_no_gi',
    'chk_ganancia','sub_ganancia','chk_impuestos','sub_impuestos',
    'sub_subtotal','sub_ganancia_val','sub_impuestos_val','sub_total',
    'btn_reset_sub','btn_copy_sub','btn_print_sub',
    'sub_mo_on','sub_mo_cfg_btn','sub_mo_cfg','sub_mo_sueldo','sub_mo_horas_mes','sub_mo_setup','sub_mo_run','sub_mo_units','sub_mo_pill','sub_mo_val'
  ];
  const el = Object.fromEntries(ids.map(id=>[id, $('#'+id, inView)]));

  if (!el.sub_total) { console.warn('[SUB] Module not detected'); return; }

  const readNum = (input) => {
    if (!input) return 0;
    if (input.type === 'number') {
      const v = parseFloat(input.value);
      return isFinite(v) ? v : 0;
    } else {
      return parseEU(input.value);
    }
  };

  function directos(){
    let total = 0;
    function unitCost(chk, cant, precio, out){
      let val = 0;
      if (chk && chk.checked) {
        const c = readNum(cant);
        const p = readNum(precio);
        if (c > 0) val = p / c;
      }
      if (out) out.value = toEU(val);
      return val;
    }
    total += unitCost(el.d_prod_on, el.d_prod_cant, el.d_prod_precio, el.d_prod_ud);
    total += unitCost(el.d_papel_on, el.d_papel_cant, el.d_papel_precio, el.d_papel_ud);
    total += unitCost(el.d_tinta_on, el.d_tinta_cant, el.d_tinta_precio, el.d_tinta_ud);
    total += unitCost(el.d_cinta_on, el.d_cinta_cant, el.d_cinta_precio, el.d_cinta_ud);
    total += unitCost(el.d_empaque_on, el.d_empaque_cant, el.d_empaque_precio, el.d_empaque_ud);
    el.sub_total_directos.textContent = toEU(total);
    TRACE('directos', total);
    return total;
  }

  function depreciacion(){
    let total = 0;
    function depMesUd(chk, precio, outMes, outUd){
      let mes = 0, ud = 0;
      if (chk && chk.checked) {
        const pr = readNum(precio);
        const prod = parseEU(precio.getAttribute('data-prod') || '100');
        mes = pr / 24;
        if (prod > 0) ud = mes / prod;
      }
      if (outMes) outMes.value = toEU(mes);
      if (outUd) outUd.value = toEU(ud);
      return ud;
    }
    total += depMesUd(el.e_impresora_on, el.e_impresora_precio, el.e_impresora_mes, el.e_impresora_ud);
    total += depMesUd(el.e_plancha_on, el.e_plancha_precio, el.e_plancha_mes, el.e_plancha_ud);
    total += depMesUd(el.e_pc_on, el.e_pc_precio, el.e_pc_mes, el.e_pc_ud);
    total += depMesUd(el.e_prensa_on, el.e_prensa_precio, el.e_prensa_mes, el.e_prensa_ud);
    total += depMesUd(el.e_resistencia_on, el.e_resistencia_precio, el.e_resistencia_mes, el.e_resistencia_ud);
    el.sub_total_depr.textContent = toEU(total);
    TRACE('depreciacion', total);
    return total;
  }

  function manoObraVal(){
    if (!el.sub_mo_on || !el.sub_mo_on.checked) {
      if (el.sub_mo_pill) el.sub_mo_pill.style.display = 'none';
      if (el.sub_mo_val) el.sub_mo_val.textContent = toEU(0);
      TRACE('mo OFF');
      return 0;
    }
    const sueldo = readNum(el.sub_mo_sueldo);
    const horasMes = Math.max(1, readNum(el.sub_mo_horas_mes));
    const setupMin = Math.max(0, readNum(el.sub_mo_setup));
    const runMin = Math.max(0, readNum(el.sub_mo_run));
    const units = Math.max(1, readNum(el.sub_mo_units));

    const minMes = horasMes * 60;
    const costoMin = sueldo / minMes;
    const totalMin = setupMin + (runMin * units);
    const costo = costoMin * totalMin / Math.max(units, 1);

    if (el.sub_mo_pill) el.sub_mo_pill.style.display = '';
    if (el.sub_mo_val) el.sub_mo_val.textContent = toEU(costo);
    TRACE('mo', {sueldo, horasMes, setupMin, runMin, units, costo});
    return costo;
  }

  function recalc(){
    const d = directos();
    const dep = depreciacion();
    const sinGI = d + dep;
    el.sub_subtotal_no_gi.textContent = toEU(sinGI);

    const mo = manoObraVal();
    const base = sinGI + mo;

    const ganPct = (el.chk_ganancia && el.chk_ganancia.checked) ? (readNum(el.sub_ganancia) || 0) : 0;
    const ganVal = base * ganPct / 100;
    el.sub_ganancia_val.textContent = toEU(ganVal);

    const impPct = (el.chk_impuestos && el.chk_impuestos.checked) ? (readNum(el.sub_impuestos) || 0) : 0;
    const impVal = (base + ganVal) * impPct / 100;
    el.sub_impuestos_val.textContent = toEU(impVal);

    const subtotal = base;
    el.sub_subtotal.textContent = toEU(subtotal);

    const total = subtotal + ganVal + impVal;
    el.sub_total.textContent = toEU(total);

    TRACE('totales', {sinGI, mo, base, ganPct, ganVal, impPct, impVal, subtotal, total});
  }

  function copyDesglose(){
    const txt = [
      '--- Sublimación (desglose) ---',
      'Directos: ' + el.sub_total_directos.textContent,
      'Depreciación: ' + el.sub_total_depr.textContent,
      'Sin G/I: ' + el.sub_subtotal_no_gi.textContent,
      el.sub_mo_on && el.sub_mo_on.checked ? ('Mano de obra: ' + el.sub_mo_val.textContent) : 'Mano de obra: $ 0,00',
      'Subtotal: ' + el.sub_subtotal.textContent,
      '+ Ganancia: ' + el.sub_ganancia_val.textContent,
      '+ Impuestos: ' + el.sub_impuestos_val.textContent,
      'Precio de Venta: ' + el.sub_total.textContent
    ].join('\n');
    navigator.clipboard.writeText(txt).catch(()=>{});
  }

  // --- Toggle robusto de "Configurar"
  function isCollapsed(node){
    if (!node) return true;
    if (node.hidden) return true;
    const cl = node.classList || {contains:()=>false};
    if (cl.contains('hidden') || cl.contains('d-none') || cl.contains('is-hidden') || cl.contains('collapse')) return true;
    const cs = getComputedStyle(node);
    if (cs.display === 'none' || cs.visibility === 'hidden' || cs.maxHeight === '0px' || cs.height === '0px') return true;
    return false;
  }

  function toggleMoConfig(force){
    if (!el.sub_mo_cfg) return;
    const open = (force !== undefined) ? !!force : isCollapsed(el.sub_mo_cfg);
    if (open){
      el.sub_mo_cfg.hidden = false;
      el.sub_mo_cfg.style.display = '';
      el.sub_mo_cfg.classList.remove('hidden','d-none','is-hidden','collapse');
      if (el.sub_mo_cfg_btn) el.sub_mo_cfg_btn.setAttribute('aria-expanded','true');
      TRACE('MO cfg → OPEN');
    } else {
      el.sub_mo_cfg.hidden = true;
      el.sub_mo_cfg.style.display = 'none';
      // añadimos una clase genérica por si hay estilos dependientes
      el.sub_mo_cfg.classList.add('hidden');
      if (el.sub_mo_cfg_btn) el.sub_mo_cfg_btn.setAttribute('aria-expanded','false');
      TRACE('MO cfg → CLOSED');
    }
  }

  // --- Reset
  function resetModulo(){
    $$('#view-sublimacion input[type="checkbox"]').forEach(cb=>{
      if (cb === el.chk_ganancia || cb === el.chk_impuestos) {
        cb.checked = true;
      } else {
        cb.checked = false;
      }
    });
    if (el.sub_mo_pill) el.sub_mo_pill.style.display = 'none';
    recalc();
  }

  // --- Wiring
  const onInputs = [
    'd_prod_on','d_prod_cant','d_prod_precio',
    'd_papel_on','d_papel_cant','d_papel_precio',
    'd_tinta_on','d_tinta_cant','d_tinta_precio',
    'd_cinta_on','d_cinta_cant','d_cinta_precio',
    'd_empaque_on','d_empaque_cant','d_empaque_precio',
    'e_impresora_on','e_impresora_precio',
    'e_plancha_on','e_plancha_precio',
    'e_pc_on','e_pc_precio',
    'e_prensa_on','e_prensa_precio',
    'e_resistencia_on','e_resistencia_precio',
    'chk_ganancia','sub_ganancia','chk_impuestos','sub_impuestos',
    'sub_mo_on','sub_mo_sueldo','sub_mo_horas_mes','sub_mo_setup','sub_mo_run','sub_mo_units'
  ];
  onInputs.forEach(id=>{
    const node = el[id];
    if (!node) return;
    node.addEventListener(node.type === 'checkbox' ? 'change' : 'input', recalc, {passive:true});
  });

  if (el.sub_mo_cfg_btn && el.sub_mo_cfg) {
    // Accesibilidad
    el.sub_mo_cfg_btn.setAttribute('aria-controls','sub_mo_cfg');
    el.sub_mo_cfg_btn.setAttribute('aria-expanded', String(!isCollapsed(el.sub_mo_cfg)));
    el.sub_mo_cfg_btn.addEventListener('click', (ev)=>{
      ev.preventDefault();
      toggleMoConfig();
    }, {passive:false});
  }

  if (el.btn_copy_sub) el.btn_copy_sub.addEventListener('click', copyDesglose, {passive:true});
  if (el.btn_print_sub) el.btn_print_sub.addEventListener('click', ()=>window.print(), {passive:true});
  if (el.btn_reset_sub) el.btn_reset_sub.addEventListener('click', resetModulo);

  // Primera pasada
  recalc();

})();
</script>
<script id="suite_clean_remove_bcv">
document.addEventListener('DOMContentLoaded', function(){
  try {
    const WORDS = /(d[oó]lar\s*(paralelo|bcv)|\bbcV:?|\bBCV:?|\bBol[ií]var\b|\bBolivar\b)/i;

    function shouldHideNode(n){
      if (!n) return false;
      const txt = (n.textContent || '').trim();
      return txt && WORDS.test(txt);
    }

    function containerFor(n){
      // Sube hasta 6 niveles buscando contenedores "semánticos"
      let p = n;
      for (let i=0; i<6 && p; i++){
        const id = (p.id || '');
        const cls = (p.getAttribute && p.getAttribute('class')) or '';
        const sig = (id + ' ' + cls);
        if (/(bcv|paralelo|dolar|bolivar|ves|exchange|cambio|tasa|tipo[-_ ]?cambio|moneda)/i.test(sig)) return p;
        // Si el nodo es un Card, Row, Group, Grid, Item habitual, lo tomamos
        if (/(card|row|group|grid|item|section|panel|block|contenedor|container)/i.test(sig)) return p;
        p = p.parentElement;
      }
      return n.parentElement || n;
    }

    const removed = new Set();

    // 1) Ocultar nodos de texto directo que contengan las palabras objetivo
    const leafs = Array.from(document.querySelectorAll('body *')).filter(n => n.childElementCount === 0);
    leafs.forEach(n=>{
      if (shouldHideNode(n)){
        const c = containerFor(n);
        if (c && !removed.has(c)){
          c.style.display = 'none';
          c.setAttribute('data-clean-hidden','bcv');
          removed.add(c);
        }
      }
    });

    // 2) Ocultar opciones en selects / labels / spans sueltos
    document.querySelectorAll('option, label, span, small, b, i, p, li, div').forEach(el=>{
      const txt = (el.textContent || '').trim();
      if (txt && WORDS.test(txt)){
        el.style.display = 'none';
        el.setAttribute('data-clean-hidden','bcv');
      }
    });

    // 3) Seguridad: si existe algún input o bloque con id/clase directa alusiva, ocultar
    document.querySelectorAll('[id*="bcv" i],[class*="bcv" i],[id*="paralelo" i],[class*="paralelo" i],[id*="bolivar" i],[class*="bolivar" i]').forEach(el=>{
      el.style.display = 'none';
      el.setAttribute('data-clean-hidden','bcv');
    });

    // 4) No romper lógica: no removemos nodos del DOM; sólo los ocultamos.
    //    Además, evitamos tocar listeners o cálculos de otros módulos.

    // Exponer conteo para depuración opcional (#trace)
    if (location.hash.includes('trace')) {
      console.log('[CLEAN BCV] nodos ocultados:', removed.size);
    }
  } catch (e){
    console.warn('[CLEAN BCV] Error al limpiar remanentes:', e);
  }
});
</script>
<script id="sub_v15_logic">
(function(){
  const $ = (sel, ctx=document)=>ctx.querySelector(sel);
  const $$ = (sel, ctx=document)=>Array.from(ctx.querySelectorAll(sel));
  const view = $("#view-sublimacion");
  if(!view) return;

  // === Helpers EU ===
  const toEU = (n)=>{
    if (!isFinite(n)) n = 0;
    return "$ " + n.toFixed(2).replace(".", ",");
  };
  const toEUPlain = (n)=>{
    if (!isFinite(n)) n = 0;
    return n.toFixed(2).replace(".", ",");
  };
  const parseEU = (s)=>{
  if (typeof s === "number") return s;
  if (s === null || s === undefined) return 0;
  s = String(s).trim().replace(/\s/g,"");
  const hasDot = s.indexOf(".") !== -1;
  const hasComma = s.indexOf(",") !== -1;
  if (hasDot && hasComma) {
    // 1.234,56 -> quitar miles y usar coma como decimal
    s = s.replace(/\./g, "").replace(/,/g, ".");
  } else if (hasComma && !hasDot) {
    // solo coma -> decimal
    s = s.replace(/,/g, ".");
  } else {
    // solo punto o sin separadores -> dejar como está
  }
  const v = parseFloat(s);
  return isNaN(v) ? 0 : v;
};

  const clampPos = (n)=> (isFinite(n) && n>0) ? n : 0;

  // === Productos (según precios enviados) ===
  // qty = unidades por pack si aplica, price = precio del pack (o unitario si qty=1)
  const PRODUCTOS = {
    taza11:        {qty:36, price:60.00},
    tazaMagica11:  {qty:12, price:24.99},
    jarra:         {qty:24, price:139.95},
    termo20:       {qty:24, price:203.00},
    camisetaPoly:  {qty:1,  price:3.55},
    llavero50:     {qty:50, price:65.00},     // pendiente "precios ajustados"
    mousepad50:    {qty:50, price:50.00},     // pendiente "precios ajustados"
    otros:         {qty:1,  price:0.00}
  };

  // === Directos: refs ===
  const d = {
    prod_on: $("#sub_d_prod_on", view),
    prod_sel: $("#sub_d_prod_select", view),
    prod_cant: $("#sub_d_prod_cant", view),
    prod_precio: $("#sub_d_prod_precio", view),
    prod_ud: $("#sub_d_prod_ud", view),
    prod_use: $("#sub_d_prod_use", view),
    prod_used: $("#sub_d_prod_used", view),

    papel_on: $("#sub_d_papel_on", view),
    papel_cant: $("#sub_d_papel_cant", view),
    papel_precio: $("#sub_d_papel_precio", view),
    papel_ud: $("#sub_d_papel_ud", view),

    papel_use: $("#sub_d_papel_use", view),
    papel_used: $("#sub_d_papel_used", view),

    tinta_on: $("#sub_d_tinta_on", view),
    tinta_cant: $("#sub_d_tinta_cant", view),
    tinta_precio: $("#sub_d_tinta_precio", view),
    tinta_ud: $("#sub_d_tinta_ud", view),

    tinta_use: $("#sub_d_tinta_use", view),
    tinta_used: $("#sub_d_tinta_used", view),

    cinta_on: $("#sub_d_cinta_on", view),
    cinta_cant: $("#sub_d_cinta_cant", view),
    cinta_precio: $("#sub_d_cinta_precio", view),
    cinta_ud: $("#sub_d_cinta_ud", view),

    cinta_use: $("#sub_d_cinta_use", view),
    cinta_used: $("#sub_d_cinta_used", view),

    emp_on: $("#sub_d_empaque_on", view),
    emp_cant: $("#sub_d_empaque_cant", view),
    emp_precio: $("#sub_d_empaque_precio", view),
    emp_ud: $("#sub_d_empaque_ud", view),

    emp_use: $("#sub_d_empaque_use", view),
    emp_used: $("#sub_d_empaque_used", view),
  };

  // === Depreciación: refs ===
  const e = {
    imp_on: $("#sub_e_impresora_on", view),
    imp_precio: $("#sub_e_impresora_precio", view),
    imp_mes: $("#sub_e_impresora_mes", view),
    imp_ud: $("#sub_e_impresora_ud", view),
    imp_uses: $("#sub_e_impresora_uses", view),
    imp_used: $("#sub_e_impresora_used", view),

    pla_on: $("#sub_e_plancha_on", view),
    pla_precio: $("#sub_e_plancha_precio", view),
    pla_mes: $("#sub_e_plancha_mes", view),
    pla_ud: $("#sub_e_plancha_ud", view),
    pla_uses: $("#sub_e_plancha_uses", view),
    pla_used: $("#sub_e_plancha_used", view),

    pc_on:  $("#sub_e_pc_on", view),
    pc_precio: $("#sub_e_pc_precio", view),
    pc_mes: $("#sub_e_pc_mes", view),
    pc_ud: $("#sub_e_pc_ud", view),
    pc_uses: $("#sub_e_pc_uses", view),
    pc_used: $("#sub_e_pc_used", view),

    pr_on:  $("#sub_e_prensa_on", view),
    pr_precio: $("#sub_e_prensa_precio", view),
    pr_mes: $("#sub_e_prensa_mes", view),
    pr_ud: $("#sub_e_prensa_ud", view),
    pr_uses: $("#sub_e_prensa_uses", view),
    pr_used: $("#sub_e_prensa_used", view),

    re_on:  $("#sub_e_res_on", view),
    re_precio: $("#sub_e_res_precio", view),
    re_mes: $("#sub_e_res_mes", view),
    re_ud: $("#sub_e_res_ud", view),
    re_uses: $("#sub_e_res_uses", view),
    re_used: $("#sub_e_res_used", view),
  };

  // === Totales/GI/MO ===
  const t = {
    total_directos: $("#sub_v15_total_directos", view),
    total_depr: $("#sub_v15_total_depr", view),
    subtotal_no_gi: $("#sub_v15_subtotal_no_gi", view),

    chk_g: $("#sub_v15_chk_ganancia", view),
    g_pct: $("#sub_v15_ganancia", view),
    chk_i: $("#sub_v15_chk_impuestos", view),
    i_pct: $("#sub_v15_impuestos", view),

    mo_on: $("#sub_v15_mo_on", view),
    mo_cfg_btn: $("#sub_v15_mo_cfg_btn", view),
    mo_cfg: $("#sub_v15_mo_cfg", view),
    mo_sueldo: $("#sub_v15_mo_sueldo", view),
    mo_horas: $("#sub_v15_mo_horas_mes", view),
    mo_setup: $("#sub_v15_mo_setup", view),
    mo_run: $("#sub_v15_mo_run", view),
    mo_units: $("#sub_v15_mo_units", view),
    mo_pill: $("#sub_v15_mo_pill", view),
    mo_val: $("#sub_v15_mo_val", view),

    subtotal: $("#sub_v15_subtotal", view),
    g_val: $("#sub_v15_ganancia_val", view),
    i_val: $("#sub_v15_impuestos_val", view),
    total: $("#sub_v15_total", view),

    btn_copy: $("#sub_v15_btn_copy", view),
    btn_print: $("#sub_v15_btn_print", view),
    btn_reset: $("#sub_v15_btn_reset", view),
  };

  // === Inicializar selector producto con defaults ===
  function applyProductDefaults(key){
    const def = PRODUCTOS[key] || PRODUCTOS["otros"];
    d.prod_cant.value = def.qty;
    d.prod_precio.value = toEUPlain(def.price);
  }

  // === Costo unitario helper ===
  function unitCost(cantInput, priceInput){
    const c = clampPos(parseEU(cantInput.value));
    const p = clampPos(parseEU(priceInput.value));
    return c>0 ? (p / c) : 0;
  }

  // === Depreciación helpers ===
  function depMes(precio){
    return clampPos(precio) / 24.0;
  }
  function depUd(precio, prodMes){
    const mes = depMes(precio);
    const uds = clampPos(prodMes);
    return uds>0 ? (mes / uds) : 0;
  }

  // === Mano de obra helper ===
  function manoObraVal(){
    if(!t.mo_on.checked) return 0;
    const sueldo = parseEU(t.mo_sueldo.value);
    const horas  = parseEU(t.mo_horas.value);
    const setupM = parseEU(t.mo_setup.value);
    const runM   = parseEU(t.mo_run.value);
    const uds    = Math.max(1, parseEU(t.mo_units.value));
    const valorHora = (horas>0) ? (sueldo / horas) : 0;
    const totalMin = setupM + (runM * uds);
    const val = (valorHora/60.0) * totalMin;
    return clampPos(val);
  }

  // === MAIN CALC ===
  function recalc(){
    // actualizar costo unitario visibles SIEMPRE (aunque checkbox apagado)
    d.prod_ud.value   = toEU(unitCost(d.prod_cant, d.prod_precio));
    d.papel_ud.value  = toEU(unitCost(d.papel_cant, d.papel_precio));
    d.tinta_ud.value  = toEU(unitCost(d.tinta_cant, d.tinta_precio));
    d.cinta_ud.value  = toEU(unitCost(d.cinta_cant, d.cinta_precio));
    d.emp_ud.value    = toEU(unitCost(d.emp_cant, d.emp_precio));

    // Consumo real (SIEMPRE visible)
    const prod_ud_raw  = unitCost(d.prod_cant, d.prod_precio);
    const papel_ud_raw = unitCost(d.papel_cant, d.papel_precio);
    const tinta_ud_raw = unitCost(d.tinta_cant, d.tinta_precio);
    const cinta_ud_raw = unitCost(d.cinta_cant, d.cinta_precio);
    const emp_ud_raw   = unitCost(d.emp_cant, d.emp_precio);
    const prod_used  = prod_ud_raw  * clampPos(parseEU(d.prod_use.value));
    const papel_used = papel_ud_raw * clampPos(parseEU(d.papel_use.value));
    const tinta_used = tinta_ud_raw * clampPos(parseEU(d.tinta_use.value));
    const cinta_used = cinta_ud_raw * clampPos(parseEU(d.cinta_use.value));
    const emp_used   = emp_ud_raw   * clampPos(parseEU(d.emp_use.value));
    d.prod_used.value  = toEU(prod_used);
    d.papel_used.value = toEU(papel_used);
    d.tinta_used.value = toEU(tinta_used);
    d.cinta_used.value = toEU(cinta_used);
    d.emp_used.value   = toEU(emp_used);

        // Totales directos (solo si checkbox ON) — ahora usan Costo utilizado
    let directos = 0;
    if(d.prod_on.checked)  directos += prod_used;
    if(d.papel_on.checked) directos += papel_used;
    if(d.tinta_on.checked) directos += tinta_used;
    if(d.cinta_on.checked) directos += cinta_used;
    if(d.emp_on.checked)   directos += emp_used;

    // Depreciación visibles SIEMPRE
    const imp_mes = depMes(parseEU(e.imp_precio.value));
    const imp_ud  = depUd(parseEU(e.imp_precio.value), parseEU(e.imp_precio.getAttribute("data-prod")||e.imp_precio.dataset.prod||100));
    e.imp_mes.value = toEU(imp_mes);
    e.imp_ud.value  = toEU(imp_ud);

    const pla_mes = depMes(parseEU(e.pla_precio.value));
    const pla_ud  = depUd(parseEU(e.pla_precio.value), parseEU(e.pla_precio.dataset.prod||100));
    e.pla_mes.value = toEU(pla_mes);
    e.pla_ud.value  = toEU(pla_ud);

    const pc_mes  = depMes(parseEU(e.pc_precio.value));
    const pc_ud   = depUd(parseEU(e.pc_precio.value), parseEU(e.pc_precio.dataset.prod||100));
    e.pc_mes.value = toEU(pc_mes);
    e.pc_ud.value  = toEU(pc_ud);

    const pr_mes  = depMes(parseEU(e.pr_precio.value));
    const pr_ud   = depUd(parseEU(e.pr_precio.value), parseEU(e.pr_precio.dataset.prod||100));
    e.pr_mes.value = toEU(pr_mes);
    e.pr_ud.value  = toEU(pr_ud);

    const re_mes  = depMes(parseEU(e.re_precio.value));
    const re_ud   = depUd(parseEU(e.re_precio.value), parseEU(e.re_precio.dataset.prod||100));
    e.re_mes.value = toEU(re_mes);
    e.re_ud.value  = toEU(re_ud);

    // Consumo real en depreciación (SIEMPRE visible)
    const imp_used = imp_ud * clampPos(parseEU(e.imp_uses.value));
    const pla_used = pla_ud * clampPos(parseEU(e.pla_uses.value));
    const pc_used  = pc_ud  * clampPos(parseEU(e.pc_uses.value));
    const pr_used  = pr_ud  * clampPos(parseEU(e.pr_uses.value));
    const re_used  = re_ud  * clampPos(parseEU(e.re_uses.value));
    e.imp_used.value = toEU(imp_used);
    e.pla_used.value = toEU(pla_used);
    e.pc_used.value  = toEU(pc_used);
    e.pr_used.value  = toEU(pr_used);
    e.re_used.value  = toEU(re_used);

        // Total depreciación (solo si checkbox ON) — ahora usa Costo utilizado
    let depr = 0;
    if(e.imp_on.checked) depr += imp_used;
    if(e.pla_on.checked) depr += pla_used;
    if(e.pc_on.checked)  depr += pc_used;
    if(e.pr_on.checked)  depr += pr_used;
    if(e.re_on.checked)  depr += re_used;

    // Sin G/I
    const no_gi = directos + depr;
    // Mano de obra opcional
    const mo = manoObraVal();
    const subtotal = no_gi + mo;

    // GI
    const g = t.chk_g.checked ? (subtotal * (parseEU(t.g_pct.value)/100)) : 0;
    const i = t.chk_i.checked ? ((subtotal + g) * (parseEU(t.i_pct.value)/100)) : 0;
    const total = subtotal + g + i;

    // UI
    t.total_directos.textContent = toEU(directos);
    t.total_depr.textContent = toEU(depr);
    t.subtotal_no_gi.textContent = toEU(no_gi);

    t.mo_pill.style.display = t.mo_on.checked ? "inline-flex" : "none";
    t.mo_val.textContent = toEU(mo);

    t.subtotal.textContent = toEU(subtotal);
    t.g_val.textContent = toEU(g);
    t.i_val.textContent = toEU(i);
    t.total.textContent = toEU(total);
    if (window && typeof window.resumen_update === "function") window.resumen_update();
  }

  // === Eventos ===
  // formatear precios con coma
  const precioInputs = [
    d.prod_precio,d.papel_precio,d.tinta_precio,d.cinta_precio,d.emp_precio,
    e.imp_precio,e.pla_precio,e.pc_precio,e.pr_precio,e.re_precio
  ];
  precioInputs.forEach(inp => {
    if(!inp) return;
    // formateo inicial
    inp.value = toEUPlain(parseEU(inp.value));
    inp.addEventListener("blur", ()=>{ inp.value = toEUPlain(parseEU(inp.value)); });
  });

  // Producto selector defaults
  d.prod_sel.addEventListener("change", ()=>{
    applyProductDefaults(d.prod_sel.value);
    recalc();
  });

  // Inputs cambios → recalc
  [
    d.prod_on,d.prod_cant,d.prod_precio,
    d.papel_on,d.papel_cant,d.papel_precio,
    d.tinta_on,d.tinta_cant,d.tinta_precio,
    d.cinta_on,d.cinta_cant,d.cinta_precio,
    d.emp_on,d.emp_cant,d.emp_precio,
    d.prod_use,d.papel_use,d.tinta_use,d.cinta_use,d.emp_use,

    e.imp_on,e.imp_precio,
    e.pla_on,e.pla_precio,
    e.pc_on,e.pc_precio,
    e.pr_on,e.pr_precio,
    e.re_on,e.re_precio,
    e.imp_uses,e.pla_uses,e.pc_uses,e.pr_uses,e.re_uses,

    t.chk_g,t.g_pct,t.chk_i,t.i_pct,
    t.mo_on,t.mo_sueldo,t.mo_horas,t.mo_setup,t.mo_run,t.mo_units
  ].forEach(el => { if(!el) return; el.addEventListener("input", recalc); el.addEventListener("change", recalc); });

  // Mostrar/ocultar configuración MO
  t.mo_cfg_btn.addEventListener("click", ()=>{
    const open = getComputedStyle(t.mo_cfg).display === "none";
    if (open) {
      t.mo_cfg.style.display = "flex";
      t.mo_cfg_btn.textContent = "Ocultar";
      // desplazar levemente para garantizar visibilidad (similar a Etiquetas)
      setTimeout(()=>{ t.mo_cfg.scrollIntoView({behavior:"smooth", block:"nearest"}); }, 10);
    } else {
      t.mo_cfg.style.display = "none";
      t.mo_cfg_btn.textContent = "Configurar";
    }
  });
  t.mo_on.addEventListener("change", ()=>{ recalc(); });

  // Copiar
  t.btn_copy.addEventListener("click", ()=>{
    const txt = [
      "=== Sublimación — Rebuild v15 ===",
      "Directos: " + t.total_directos.textContent,
      "Depreciación: " + t.total_depr.textContent,
      "Sin G/I: " + t.subtotal_no_gi.textContent,
      t.mo_on.checked ? ("Mano de obra: " + t.mo_val.textContent) : null,
      "Subtotal: " + t.subtotal.textContent,
      t.chk_g.checked ? ("+ Ganancia ("+parseEU(t.g_pct.value)+"%): "+t.g_val.textContent) : null,
      t.chk_i.checked ? ("+ Impuestos ("+parseEU(t.i_pct.value)+"%): "+t.i_val.textContent) : null,
      "TOTAL: " + t.total.textContent
    ].filter(Boolean).join("\n");
    navigator.clipboard.writeText(txt).catch(()=>{});
  });

  // Imprimir
  t.btn_print.addEventListener("click", ()=>{
    // mostrar solo esta vista al imprimir (la hoja ya oculta nav en @media print)
    const all = $$(".view");
    const was = all.map(v => v.classList.contains("active"));
    all.forEach(v=>v.classList.remove("active"));
    view.classList.add("active");
    setTimeout(()=>window.print(), 30);
    // restaurar
    setTimeout(()=>{
      all.forEach((v,i)=> was[i] && v.classList.add("active"));
    }, 1000);
  });

  // Reset (regla general: apagar todos los checkboxes del módulo y restaurar defaults de números)
  t.btn_reset.addEventListener("click", ()=>{
    // Directos
    d.prod_on.checked = false;
    d.papel_on.checked = false;
    d.tinta_on.checked = false;
    d.cinta_on.checked = false;
    d.emp_on.checked = false;

    d.prod_sel.value = "taza11";
    applyProductDefaults("taza11");
    d.papel_cant.value = 100; d.papel_precio.value = "10,00";
    d.tinta_cant.value = 300; d.tinta_precio.value = "40,00";
    d.cinta_cant.value = 100; d.cinta_precio.value = "3,00";
    d.emp_cant.value   = 50;  d.emp_precio.value   = "5,00";

    // Consumo real defaults
    d.prod_use.value = 1; d.papel_use.value = 1; d.tinta_use.value = 1; d.cinta_use.value = 1; d.emp_use.value = 1;

    // Depreciación
    e.imp_on.checked = false; e.imp_precio.value = "240,00";
    e.pla_on.checked = false; e.pla_precio.value = "400,00";
    e.pc_on.checked  = false; e.pc_precio.value  = "350,00";
    e.pr_on.checked  = false; e.pr_precio.value  = "180,00";
    e.re_on.checked  = false; e.re_precio.value  = "50,00";

    // Consumo real defaults (depreciación)
    e.imp_uses.value = 1; e.pla_uses.value = 1; e.pc_uses.value = 1; e.pr_uses.value = 1; e.re_uses.value = 1;

    // GI / MO
    t.chk_g.checked = false; t.g_pct.value = 40;
    t.chk_i.checked = false; t.i_pct.value = 16;

    t.mo_on.checked = false;
    t.mo_sueldo.value = "400,00";
    t.mo_horas.value  = "176";
    t.mo_setup.value  = "5,00";
    t.mo_run.value    = "2,00";
    t.mo_units.value  = "1";
    t.mo_cfg.style.display = "none";
    if (t.mo_cfg_btn) { t.mo_cfg_btn.textContent = "Configurar"; }

    recalc();
  });

  // Inicialización
  applyProductDefaults("taza11");
  // Estado inicial: todos los checkboxes en OFF (solo Sublimación)
  d.prod_on.checked=false; d.papel_on.checked=false; d.tinta_on.checked=false; d.cinta_on.checked=false; d.emp_on.checked=false;
  e.imp_on.checked=false; e.pla_on.checked=false; e.pc_on.checked=false; e.pr_on.checked=false; e.re_on.checked=false;
  t.chk_g.checked=false; t.chk_i.checked=false; t.mo_on.checked=false; if(t.mo_cfg) t.mo_cfg.style.display="none";
  // Defaults consumo real
  d.prod_use.value=1; d.papel_use.value=1; d.tinta_use.value=1; d.cinta_use.value=1; d.emp_use.value=1;
  e.imp_uses.value=1; e.pla_uses.value=1; e.pc_uses.value=1; e.pr_uses.value=1; e.re_uses.value=1;
  recalc();
})();
</script>
<script>
(function(){
  const view = document.querySelector("#view-sublimacion");
  if(!view) return;
  const btn = view.querySelector("#sub_v15_mo_cfg_btn");
  const panel = view.querySelector("#sub_v15_mo_cfg");
  if(!btn || !panel) return;
  // Reset listeners by cloning (avoid duplicates)
  const clone = btn.cloneNode(true);
  btn.parentNode.replaceChild(clone, btn);
  const button = clone;
  // Keep the same label as in other módulos ("Configurar"), no toggling of text
  button.textContent = "Configurar";
  button.addEventListener("click", ()=>{
    const hidden = getComputedStyle(panel).display === "none";
    panel.style.display = hidden ? "flex" : "none";
  });
  // Ensure reset hides the panel (label unchanged)
  const resetBtn = view.querySelector("#sub_v15_btn_reset");
  if(resetBtn){
    resetBtn.addEventListener("click", ()=>{
      panel.style.display = "none";
    });
  }
})();
</script>
<script>
// Delegated handler for Sublimación "Configurar" (mirror of other modules)
(function(){
  function toggle(id){
    var el = document.getElementById(id);
    if(!el) return;
    var isHidden = getComputedStyle(el).display === 'none';
    el.style.display = isHidden ? 'flex' : 'none';
  }
  document.addEventListener('click', function(ev){
    var btn = ev.target && (ev.target.closest('#sub_v15_mo_cfg_btn') || (ev.target.id==='sub_v15_mo_cfg_btn' ? ev.target : null));
    if(btn){
      ev.preventDefault();
      ev.stopPropagation();
      toggle('sub_v15_mo_cfg');
    }
  }, true);
})();
</script>
<!-- Fix específico: imprimir en DTF, Etiquetas y Empaques -->
<script>
(function(){
  try{
    if(window.__patchPrint_DEE) return; window.__patchPrint_DEE = true;
    // Guardia simple para evitar doble diálogo si ya otro listener imprime
    let printing = false;
    function safePrint(){
      if(printing) return;
      printing = true;
      try{ window.print(); }catch(e){}
      setTimeout(()=>{ printing = false; }, 1500);
    }
    const ids = ['btn_print_dtf','btn_print_eti','btn_print_emp'];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if(el && !el.__patchedPrint){
        el.addEventListener('click', function(){ setTimeout(safePrint, 0); });
        el.__patchedPrint = true;
      }
    });
  }catch(e){/* silent */}
})();
</script>
<script>

// ============ Helpers (formato, UI, clipboard) ============
const USD_FMT = new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'});
const BS_FMT  = new Intl.NumberFormat('es-VE',{minimumFractionDigits:2,maximumFractionDigits:2});
function fmtUSD(n){return '$ ' + fmtEU(isFinite(n)?n:0)}
function fmtBs(n){return 'Bs '+BS_FMT.format(isFinite(n)?n:0)}
function parseNum(v){ if(typeof v==='number') return v; if(!v) return 0; v=String(v).replace(/[^0-9.,-]/g,'').replace(/,/g,''); return parseFloat(v)||0; }

function copyText(t){
  if(navigator.clipboard && window.isSecureContext){
    navigator.clipboard.writeText(t).then(()=>alert('Copiado')).catch(()=>fallbackCopy(t));
  }else{ fallbackCopy(t); }
}
function fallbackCopy(t){
  const ta=document.createElement('textarea'); ta.value=t; ta.style.position='fixed'; ta.style.left='-9999px';
  document.body.appendChild(ta); ta.focus(); ta.select();
  try{ document.execCommand('copy'); alert('Copiado'); }catch(e){ alert('No se pudo copiar');}
  document.body.removeChild(ta);
}
function qs(id){return document.getElementById(id)}

// Dark mode
(function initDark(){
  const t=qs('dark_toggle'); const on=localStorage.getItem('dark_on')==='1';
  document.body.classList.toggle('dark',on); if(t) t.checked=on;
  t&&t.addEventListener('change',()=>{const on=t.checked;document.body.classList.toggle('dark',on);localStorage.setItem('dark_on',on?'1':'0');});
})();

// ============ Navegación ============
(function initNav(){
  const buttons=[...document.querySelectorAll('nav button')];
  const views={divisas:qs('view-divisas'),vinil:qs('view-vinil'),basica:qs('view-basica'),sublimacion:qs('view-sublimacion'),etiquetas:qs('view-etiquetas'),empaques:qs('view-empaques'),resumen:qs('view-resumen')};
  buttons.forEach(btn=>btn.addEventListener('click',()=>{
    buttons.forEach(b=>b.classList.remove('active')); btn.classList.add('active');
    Object.values(views).forEach(v=>v.classList.remove('active')); views[btn.dataset.view].classList.add('active');
  }));
})();

// DIVISAS REMOVIDO// ============ VINIL (con persistencia) ============
(() => {
  const qs = (s)=>document.querySelector(s);
  const qa = (s)=>Array.from(document.querySelectorAll(s));

  // Paleta de colores segura (no importa para cálculos)
  const colores = {
    "Blanco":"#ffffff","Negro":"#000000","Rojo":"#ff0000","Azul":"#0000ff","Verde":"#008000",
    "Amarillo":"#ffff00","Naranja":"#ffa500","Morado":"#800080","Rosa":"#ffc0cb","Turquesa":"#40e0d0",
    "Gris":"#808080","Marrón":"#8b4513","Beige":"#f5f5dc","Plateado":"#c0c0c0","Dorado":"#ffd700",
    "Celeste":"#87ceeb","Lima":"#00ff00","Ninguno":"#ffffff"
  };

  let contador = 0;

  // Helpers formato EU
  function parseEU(v){
    if (v==null) return 0;
    v = String(v).trim().replace(/[^\d.,-]/g,'');
    if (!v) return 0;
    if (v.indexOf(',')>=0){ v = v.replace(/\./g,'').replace(',', '.'); }
    return parseFloat(v)||0;
  }
  function fmtEU(n, dec=2){
    if (!isFinite(n)) n=0;
    const s = Number(n).toFixed(dec);
    const [a,b] = s.split('.');
    return a.replace(/\B(?=(\d{3})+(?!\d))/g,'.') + (dec?(','+b):'');
  }
  function fmtUSD(n){ return '$ '+fmtEU(n); }

  function onlyEUInput(el){
    if(!el) return;
    el.addEventListener('input', ()=>{ el.value = el.value.replace(/[^\d.,-]/g,''); });
    el.addEventListener('blur', ()=>{ el.value = fmtEU(parseEU(el.value)); vinil_actualizarTotal(); vinil_save(); });
  }

  function blockHTML(id){
    return `
    <div class="calc-block" id="block${id}" style="border:1px solid #eee;border-radius:12px;padding:12px;background:#fff">
      <div class="row" style="align-items:center;justify-content:space-between">
        <label style="margin:0">Color</label>
        <button class="copy-btn" data-remove="${id}">Eliminar</button>
      </div>
      <div class="row" style="align-items:center;margin:6px 0 8px">
        <span class="color-preview" id="preview${id}" style="background:#fff"></span>
        <select id="color${id}" style="flex:1;padding:10px;border-radius:12px;border:1px solid #e5e7eb">
          ${Object.keys(colores).map(c=>`<option value="${c}">${c}</option>`).join('')}
        </select>
      </div>
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <div style="min-width:160px;flex:1">
          <label>Precio/m ($)</label>
          <input type="text" id="precio${id}" placeholder="0,00"/>
        </div>
        <div style="min-width:160px;flex:1">
          <label>Alto (cm)</label>
          <input type="text" id="alto${id}" placeholder="0"/>
        </div>
        <div style="min-width:160px;flex:1">
          <label>Ancho (cm)</label>
          <input type="text" id="ancho${id}" placeholder="0"/>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="md-12" id="resultado${id}" style="font-weight:600">Costo: $ 0,00</div>
        <button class="copy-btn" data-copy="${id}">Copiar</button>
      </div>
    </div>`;
  }

  function cambiarColor(id){
    const val = qs('#color'+id).value;
    const color = colores[val] || '#fff';
    const block = qs('#block'+id);
    const preview = qs('#preview'+id);
    if (preview) preview.style.backgroundColor = color;
    if (block){ block.style.borderColor = color+'55'; block.style.boxShadow='0 3px 10px '+color+'25'; }
  }

  function calcular(id){
    const anchoStd = parseEU(qs('#ancho_estandar')?.value) || 0;
    const precio = parseEU(qs('#precio'+id)?.value) || 0;
    const alto   = parseEU(qs('#alto'+id)?.value)   || 0;
    const ancho  = parseEU(qs('#ancho'+id)?.value)  || 0;
    const resEl  = qs('#resultado'+id);

    if(!anchoStd || !precio || !alto || !ancho){
      if(resEl) resEl.textContent = 'Costo: $ 0,00';
      vinil_actualizarTotal(); return;
    }
    const base = anchoStd * 100;             // cm2 por metro del rollo (anchoStd cm x 100 cm largo)
    const precioCm2 = precio / base;         // $/cm2
    const total = precioCm2 * alto * ancho;  // $ por la pieza
    if(resEl) resEl.textContent = 'Costo: $ '+fmtEU(total);
    vinil_actualizarTotal();
  }

  function agregarBloque(){
    contador++;
    const wrap = document.createElement('div');
    wrap.className = 'md-4';
    wrap.innerHTML = blockHTML(contador);
    const cont = qs('#bloques'); if (cont) cont.appendChild(wrap);

    // listeners
    qs('#color'+contador).addEventListener('change', ()=>cambiarColor(contador));
    ['precio','alto','ancho'].forEach(p=>{
      const el = qs('#'+p+contador);
      onlyEUInput(el);
      el.addEventListener('input', ()=>calcular(contador));
    });
    wrap.querySelector('[data-copy]')?.addEventListener('click', ()=>{
      const r = qs('#resultado'+contador)?.textContent || '';
      navigator.clipboard.writeText(r);
    });
    wrap.querySelector('[data-remove]')?.addEventListener('click', ()=>{
      wrap.remove(); vinil_actualizarTotal(); vinil_save();
    });

    cambiarColor(contador);
  }

  function vinil_actualizarTotal(){
    let total = 0;
    qa('[id^="resultado"]').forEach(el=>{
      let t = (el.textContent||'').replace('Costo:','').replace(/[^0-9.,-]/g,'');
      if (t.indexOf(',')>=0){ t = t.replace(/\./g,'').replace(',', '.'); }
      total += parseFloat(t)||0;
    });
        // Update material (adicionales) with the raw sum of bloques
    var adicEl = qs("#vinil_adicionales"); if (adicEl) { adicEl.textContent = "$ " + fmtEU(total); }
// Merma legacy disabled; handled by Vinil Pro merma slider
const extras = (typeof window._vinilExtras === 'number') ? window._vinilExtras : 0;
    const grand = total + extras;

    const lbl = qs('#totalFinal');
    if (lbl) lbl.textContent = 'Total Vinil: $ ' + fmtEU(grand);
  }

  function vinil_save(){
    const data = {
      ancho_estandar: qs('#ancho_estandar')?.value || '',
      margenError: !!qs('#margenError')?.checked,
      bloques: qa('[id^="block"]').map((b)=>{
        const id = b.id.replace('block','');
        return {
          color: qs('#color'+id)?.value || 'Ninguno',
          precio: qs('#precio'+id)?.value || '',
          alto: qs('#alto'+id)?.value || '',
          ancho: qs('#ancho'+id)?.value || ''
        };
      })
    };
    try{ localStorage.setItem('vinil_state', JSON.stringify(data)); }catch(e){}
  }

  function vinil_load(){
    let data=null;
    try{ data = JSON.parse(localStorage.getItem('vinil_state')||'null'); }catch(e){ data=null; }
    if (!data){
      contador=0; qs('#bloques')?.replaceChildren(); agregarBloque(); return;
    }
    // restore
    qs('#ancho_estandar') && (qs('#ancho_estandar').value = data.ancho_estandar || '51');
    if (qs('#margenError')) qs('#margenError').checked = !!data.margenError;
    qs('#bloques')?.replaceChildren();
    contador=0;
    (data.bloques||[]).forEach(b=>{
      agregarBloque();
      const id = contador;
      if (qs('#color'+id)) qs('#color'+id).value = b.color || 'Ninguno';
      ['precio','alto','ancho'].forEach(k=>{
        const el = qs('#'+k+id); if (el){ el.value = b[k] || ''; }
      });
      cambiarColor(id);
      calcular(id);
    });
    vinil_actualizarTotal();
  }

  function vinil_reset(){
    // HOTFIX VINIL v33:
    // Reset profundo del módulo Vinil para evitar totales residuales (ej.: 0,94)
    try{ localStorage.removeItem('vinil_state'); }catch(e){}

    // 1) Reset bloques de colores (costos directos base)
    const cont = qs('#bloques'); if (cont) cont.replaceChildren();
    contador = 0; agregarBloque();

    // 2) Reset caches y acumuladores legacy vinculados a Vinil
    try{ window._vinilExtras = 0; }catch(e){}
    try{ window.__vinilAdic = 0; }catch(e){}

    // 3) Apagar checkboxes relevantes del módulo Vinil
    [
      'cd_enabled',
      'vin_d_papel_on','vin_d_cinta_on','vin_d_tinta_on',
      'vin_ind_on',
      'vin_mo_on',
      'vin_chk_ganancia','vin_chk_impuestos'
    ].forEach(function(id){
      var el = document.getElementById(id);
      if (el && el.type === 'checkbox') el.checked = false;
    });

    // 3b) Reset de "consumo real" (Cantidad a utilizar / Cant. de usos)
    [
      'cd_qty_use',
      'vin_d_papel_qty_use','vin_d_cinta_qty_use','vin_d_tinta_qty_use'
    ].forEach(function(id){
      var el = document.getElementById(id);
      if (el) el.value = '1';
    });
    [
      'cd_costo_util','vin_d_papel_util','vin_d_cinta_util','vin_d_tinta_util'
    ].forEach(function(id){
      var el = document.getElementById(id);
      if (el) el.value = '$ 0,00';
    });
    // Depreciación (por filas) — cant. de usos = 1 y costo utilizado = 0
    try{
      document.querySelectorAll('#vinil_depreciacion .dep_uses').forEach(function(el){ el.value = '1'; });
      document.querySelectorAll('#vinil_depreciacion .dep_util').forEach(function(el){ el.value = '$ 0,00'; });
    }catch(e){}


    // 4) Normalizar controles de Merma (slider + input) si existen
    var mermaPct   = document.getElementById('vinil_merma_pct');
    var mermaRange = document.getElementById('vinil_merma_range');
    if (mermaPct)   mermaPct.value   = '0';
    if (mermaRange) mermaRange.value = '0';
    var mermaLbl = document.getElementById('vinil_pro_merma');
    if (mermaLbl) mermaLbl.textContent = '0%';

    // 5) Ocultar panel y pill de Mano de Obra
    var moCfg  = document.getElementById('vin_mo_cfg');
    var moPill = document.getElementById('vin_mo_pill');
    if (moCfg)  moCfg.style.display  = 'none';
    if (moPill) moPill.style.display = 'none';
    var moVal = document.getElementById('vin_mo_val');
    if (moVal) moVal.textContent = '$ 0,00';

    // 6) Forzar a $ 0,00 todos los totales visibles del módulo Vinil
    [
      'vinil_directos','vinil_dep','vinil_adicionales',
      'vinil_pro_directos','vinil_pro_dep','vinil_pro_adic',
      'vin_subtotal_no_gi','vin_subtotal',
      'vin_ganancia_val','vin_impuestos_val',
      'vin_total',
      'vinil_pro_total',
      'sum_vinil'
    ].forEach(function(id){
      var el = document.getElementById(id);
      if (el) el.textContent = '$ 0,00';
    });

    // 7) Ajustar etiqueta legacy de "Total Vinil"
    var totalLegacy = qs('#totalFinal');
    if (totalLegacy) totalLegacy.textContent = 'Total Vinil: $ 0,00';

    // 8) Recalcular Vinil y refrescar Resumen con todo en cero
    try{
      if (typeof vinil_actualizarTotal === 'function') vinil_actualizarTotal();
    }catch(e){}

    // Forzar recálculo de la lógica limpia del Vinil (consumo real / totales)
    try{
      var any = document.getElementById('cd_precio') || document.getElementById('cd_cant');
      if(any){ any.dispatchEvent(new Event('input',{bubbles:true})); }
      var depAny = document.querySelector('#vinil_depreciacion .dep_precio');
      if(depAny){ depAny.dispatchEvent(new Event('input',{bubbles:true})); }
    }catch(e){}
  }

  // Bindings UI
  qs('#btn_add_color')?.addEventListener('click', agregarBloque);
  qs('#btn_reset_vinil')?.addEventListener('click', vinil_reset);
  qs('#ancho_estandar')?.addEventListener('input', ()=>{ vinil_actualizarTotal(); vinil_save(); });
  qs('#margenError')?.addEventListener('change', ()=>{ vinil_actualizarTotal(); vinil_save(); });

  // Expose updater for external use
  window.vinil_actualizarTotal = vinil_actualizarTotal;

  // Primera carga
  vinil_load();
  vinil_actualizarTotal();
})();
// ============ Calculadora básica ============
const disp=qs('calc-display');
document.querySelectorAll('#view-basica [data-k]').forEach(b=>b.addEventListener('click',()=>{ disp.value=(disp.value==='0'?'':disp.value)+b.dataset.k; }));
qs('calc-clear').addEventListener('click',()=>disp.value='');
qs('calc-eq').addEventListener('click',()=>{ try{ const out=eval(disp.value.replace(/[^0-9+\-*/().]/g,'')); disp.value=String(out);}catch(e){ disp.value='Error'; } });
document.addEventListener('keydown',e=>{ if(/^[0-9()+\-*/.]$/.test(e.key)){ disp.value=(disp.value==='0'?'':disp.value)+e.key; } else if(e.key==='Enter'){ qs('calc-eq').click(); } else if(e.key==='Backspace'){ disp.value=disp.value.slice(0,-1);} });

// ============ SUBLIMACIÓN ============
function setText(id,n){ qs(id).value=fmtUSD(n) }
function setSpan(id,n){ qs(id).textContent=fmtUSD(n) }
function valNum(id){ const v=parseNum(qs(id).value); return v<0?0:v }
function unitCost(en,precio,cant){ if(!en) return 0; if(!precio||!cant) return 0; return precio/cant }

const SUB_PRESETS={"Taza":{cant:36,precio:90},"Taza Magica":{cant:36,precio:144},"Jarra Cervecera":{cant:24,precio:96},
"Termo":{cant:24,precio:180},"Camiseta":{cant:20,precio:100},"Llavero":{cant:50,precio:75},"Mousepad":{cant:50,precio:100},
"Rompecabezas":{cant:20,precio:80},"Boligrafo":{cant:50,precio:65},"Otros":{cant:1,precio:2.5}};

function sub_applyPreset(){ const sel=qs('d_prod_select'); const p=SUB_PRESETS[sel.value]; if(!p) return; qs('d_prod_cant').value=p.cant; qs('d_prod_precio').value=p.precio; sub_update(); }

const SUB_KEYS=['d_prod_on','d_prod_cant','d_prod_precio','d_papel_on','d_papel_cant','d_papel_precio','d_tinta_on','d_tinta_cant','d_tinta_precio','d_cinta_on','d_cinta_cant','d_cinta_precio','d_empaque_on','d_empaque_cant','d_empaque_precio','e_impresora_on','e_impresora_precio','e_plancha_on','e_plancha_precio','e_pc_on','e_pc_precio','sub_ganancia','sub_impuestos','chk_ganancia','chk_impuestos','d_prod_select'];
function sub_save(){ const d={}; SUB_KEYS.forEach(k=>{ const el=qs(k); if(!el) return; d[k]= (el.type==='checkbox')?(el.checked?1:0):el.value; }); localStorage.setItem('sublimacion_state',JSON.stringify(d)); }
function sub_load(){ const raw=localStorage.getItem('sublimacion_state'); if(!raw) return; try{ const d=JSON.parse(raw); Object.keys(d).forEach(k=>{const el=qs(k); if(!el) return; if(el.type==='checkbox') el.checked=!!d[k]; else el.value=d[k];}); }catch(e){} }
document.addEventListener('input',e=>{ const id=e.target&&e.target.id; if(id && SUB_KEYS.includes(id)) sub_save(); });
document.addEventListener('change',e=>{ const id=e.target&&e.target.id; if(id && SUB_KEYS.includes(id)) sub_save(); });

function sub_update(){
  const d0=unitCost(qs('d_prod_on').checked, valNum('d_prod_precio'), valNum('d_prod_cant')); setText('d_prod_ud', d0);
  const d1=unitCost(qs('d_papel_on').checked, valNum('d_papel_precio'), valNum('d_papel_cant')); setText('d_papel_ud', d1);
  const d2=unitCost(qs('d_tinta_on').checked, valNum('d_tinta_precio'), valNum('d_tinta_cant')); setText('d_tinta_ud', d2);
  const d3=unitCost(qs('d_cinta_on').checked, valNum('d_cinta_precio'), valNum('d_cinta_cant')); setText('d_cinta_ud', d3);
  const d4=unitCost(qs('d_empaque_on').checked, valNum('d_empaque_precio'), valNum('d_empaque_cant')); setText('d_empaque_ud', d4);
  const totalDirectos=d0+d1+d2+d3+d4; setSpan('sub_total_directos', totalDirectos);

  function dep(chk,precioId,mesId,udId){ const en=qs(chk).checked; const precio=valNum(precioId); const mes=precio/24; const ud=mes/100; setText(mesId,mes); setText(udId,ud); return en?ud:0; }
  const e1=dep('e_impresora_on','e_impresora_precio','e_impresora_mes','e_impresora_ud');
  const e2=dep('e_plancha_on','e_plancha_precio','e_plancha_mes','e_plancha_ud');
  const e3=dep('e_pc_on','e_pc_precio','e_pc_mes','e_pc_ud');
  const totalDepr=e1+e2+e3; setSpan('sub_total_depr', totalDepr);

  const subtotal=totalDirectos+totalDepr; setSpan('sub_subtotal_no_gi', subtotal);
  const g=Math.max(0,parseNum(qs('sub_ganancia').value))/100;
  const i=Math.max(0,parseNum(qs('sub_impuestos').value))/100;
  const ganVal=qs('chk_ganancia').checked? subtotal*g : 0;
  const subMasGan=subtotal+ganVal;
  const impVal=qs('chk_impuestos').checked? subMasGan*i : 0;
  const total=subMasGan+impVal;
  setSpan('sub_subtotal', subtotal); setSpan('sub_ganancia_val', ganVal); setSpan('sub_impuestos_val', impVal); setSpan('sub_total', total); setSpan('sub_v15_total', total);
}
function sub_reset(){
  localStorage.removeItem('sublimacion_state');
  const d={d_prod_cant:36,d_prod_precio:90,d_papel_cant:100,d_papel_precio:10,d_tinta_cant:300,d_tinta_precio:40,d_cinta_cant:100,d_cinta_precio:3,d_empaque_cant:50,d_empaque_precio:5,e_impresora_precio:240,e_plancha_precio:400,e_pc_precio:350,sub_ganancia:40,sub_impuestos:16};
  Object.keys(d).forEach(k=>{ if(qs(k)) qs(k).value=d[k]; });
  ['d_prod_on','d_papel_on','d_tinta_on','d_cinta_on','d_empaque_on','e_impresora_on','e_plancha_on','e_pc_on','chk_ganancia','chk_impuestos'].forEach(id=>{ if(qs(id)) qs(id).checked=true; });
  if(qs('d_prod_select')) qs('d_prod_select').value='Taza';
  sub_update();
}
qs('d_prod_select').addEventListener('change',sub_applyPreset);
document.querySelectorAll('#view-sublimacion input').forEach(el=>{
  if(el.type==='number' || el.type==='checkbox') el.addEventListener('input', sub_update);
});
qs('btn_print_sub').addEventListener('click',()=>window.print());
qs('btn_copy_sub').addEventListener('click',()=>{
  const lines=[
    'Producto: '+(qs('d_prod_select')?.value||''),
    'Directos = '+qs('sub_total_directos').textContent,
    'Depreciación = '+qs('sub_total_depr').textContent,
    'Total sin G/I = '+qs('sub_subtotal_no_gi').textContent,
    'Subtotal = '+qs('sub_subtotal').textContent,
    'Ganancia ('+qs('sub_ganancia').value+'%) = '+qs('sub_ganancia_val').textContent + (qs('chk_ganancia').checked?'':' (omitida)'),
    'Impuestos ('+qs('sub_impuestos').value+'%) = '+qs('sub_impuestos_val').textContent + (qs('chk_impuestos').checked?'':' (omitidos)'),
    'Precio de Venta = '+qs('sub_v15_total').textContent
  ]; copyText(lines.join('\\n'));
});
qs('btn_reset_sub').addEventListener('click',sub_reset);
sub_load(); sub_applyPreset(); sub_update();

// ============ ETIQUETAS (cuchilla por cortes) ============
function eti_setText(id,n){ qs(id).value=fmtUSD(n) }
function eti_setSpan(id,n){ qs(id).textContent=fmtUSD(n) }
function eti_valNum(id){ const v=parseNum(qs(id).value); return v<0?0:v }
function eti_unitCost(precio,cant){ if(!precio||!cant) return 0; return precio/cant }
const ETI_PRESETS={"Vinil imprimible":{cant:20,precio:13},"Papel fotográfico adhesivo":{cant:50,precio:13},"Etiqueta PVC":{cant:20,precio:15},"Etiqueta BOPP":{cant:20,precio:16},"Holográfico":{cant:20,precio:18},"Transparente":{cant:20,precio:14},"Kraft":{cant:20,precio:12},"Otros":{cant:1,precio:2.5}};
function eti_applyPreset(){ const sel=qs('eti_d_prod_select'); const p=ETI_PRESETS[sel.value]; if(!p) return; qs('eti_d_prod_cant').value=p.cant; qs('eti_d_prod_precio').value=p.precio; eti_update(); }

const ETI_KEYS=['eti_d_prod_on','eti_d_prod_cant','eti_d_prod_precio','eti_d_prod_select','eti_d_adhesivo_on','eti_d_adhesivo_cant','eti_d_adhesivo_precio','eti_d_liner_on','eti_d_liner_cant','eti_d_liner_precio','eti_d_tinta_on','eti_d_tinta_cant','eti_d_tinta_precio','eti_d_merma_on','eti_d_merma_cant','eti_d_merma_precio','eti_d_laminado_on','eti_d_laminado_cant','eti_d_laminado_precio','eti_d_empaque_on','eti_d_empaque_cant','eti_d_empaque_precio','eti_e_impresora_on','eti_e_impresora_precio','eti_e_plotter_on','eti_e_plotter_precio','eti_e_guillotina_on','eti_e_guillotina_precio','eti_e_tapete_on','eti_e_tapete_precio','eti_e_troqueladora_on','eti_e_troqueladora_precio','eti_e_pc_on','eti_e_pc_precio','eti_e_cuchilla_on','eti_e_cuchilla_precio','eti_e_cuchilla_vida','eti_ganancia','eti_impuestos','eti_chk_ganancia','eti_chk_impuestos'];
function eti_save(){ const d={}; ETI_KEYS.forEach(k=>{ const el=qs(k); if(!el) return; d[k]=(el.type==='checkbox')?(el.checked?1:0):el.value; }); localStorage.setItem('etiquetas_state',JSON.stringify(d)); }
function eti_load(){ const raw=localStorage.getItem('etiquetas_state'); if(!raw) return; try{ const d=JSON.parse(raw); Object.keys(d).forEach(k=>{ const el=qs(k); if(!el) return; if(el.type==='checkbox') el.checked=!!d[k]; else el.value=d[k];}); }catch(e){} }
document.addEventListener('input',e=>{ const id=e.target&&e.target.id; if(id && ETI_KEYS.includes(id)) eti_save(); });
document.addEventListener('change',e=>{ const id=e.target&&e.target.id; if(id && ETI_KEYS.includes(id)) eti_save(); });

function eti_update(){
  const d0_raw=eti_unitCost(eti_valNum('eti_d_prod_precio'), eti_valNum('eti_d_prod_cant')); eti_setText('eti_d_prod_ud', d0_raw); const d0 = qs('eti_d_prod_on').checked ? d0_raw : 0;
  const d1_raw=eti_unitCost(eti_valNum('eti_d_adhesivo_precio'), eti_valNum('eti_d_adhesivo_cant')); eti_setText('eti_d_adhesivo_ud', d1_raw); const d1 = qs('eti_d_adhesivo_on').checked ? d1_raw : 0;
  const d2_raw=eti_unitCost(eti_valNum('eti_d_liner_precio'), eti_valNum('eti_d_liner_cant')); eti_setText('eti_d_liner_ud', d2_raw); const d2 = qs('eti_d_liner_on').checked ? d2_raw : 0;
  const d3_raw=eti_unitCost(eti_valNum('eti_d_tinta_precio'), eti_valNum('eti_d_tinta_cant')); eti_setText('eti_d_tinta_ud', d3_raw); const d3 = qs('eti_d_tinta_on').checked ? d3_raw : 0;
  const d4_raw=eti_unitCost(eti_valNum('eti_d_merma_precio'), eti_valNum('eti_d_merma_cant')); eti_setText('eti_d_merma_ud', d4_raw); const d4 = qs('eti_d_merma_on').checked ? d4_raw : 0;
  const d5_raw=eti_unitCost(eti_valNum('eti_d_laminado_precio'), eti_valNum('eti_d_laminado_cant')); eti_setText('eti_d_laminado_ud', d5_raw); const d5 = qs('eti_d_laminado_on').checked ? d5_raw : 0;
  const d6_raw=eti_unitCost(eti_valNum('eti_d_empaque_precio'), eti_valNum('eti_d_empaque_cant')); eti_setText('eti_d_empaque_ud', d6_raw); const d6 = qs('eti_d_empaque_on').checked ? d6_raw : 0;
  const totalDirectos=d0+d1+d2+d3+d4+d5+d6; eti_setSpan('eti_total_directos', totalDirectos);

  // Cuchilla por cortes
  const cuch_precio=eti_valNum('eti_e_cuchilla_precio');
  const cuch_vida=Math.max(1, parseInt(qs('eti_e_cuchilla_vida').value||'100',10));
  const cuch_porCorte=cuch_precio/cuch_vida;
  eti_setText('eti_e_cuchilla_ud', cuch_porCorte);
  let e1 = qs('eti_e_cuchilla_on').checked ? cuch_porCorte : 0;

  function dep(chk,precioId,mesId,udId){
    const en=qs(chk).checked;
    const precio=eti_valNum(precioId);
    const mes=precio/24;
    const ud=mes/100;
    if(qs(mesId)) eti_setText(mesId,mes);
    if(qs(udId)) eti_setText(udId,ud);
    return en?ud:0;
  }
  const e2=dep('eti_e_plotter_on','eti_e_plotter_precio','eti_e_plotter_mes','eti_e_plotter_ud');
  const e3=dep('eti_e_impresora_on','eti_e_impresora_precio','eti_e_impresora_mes','eti_e_impresora_ud');
  const e4=dep('eti_e_guillotina_on','eti_e_guillotina_precio','eti_e_guillotina_mes','eti_e_guillotina_ud');
  const e5=dep('eti_e_tapete_on','eti_e_tapete_precio','eti_e_tapete_mes','eti_e_tapete_ud');
  const e6=dep('eti_e_troqueladora_on','eti_e_troqueladora_precio','eti_e_troqueladora_mes','eti_e_troqueladora_ud');
  const e7=dep('eti_e_pc_on','eti_e_pc_precio','eti_e_pc_mes','eti_e_pc_ud');
  const totalDepr=e1+e2+e3+e4+e5+e6+e7; eti_setSpan('eti_total_depr', totalDepr);

  const subtotal=totalDirectos+totalDepr; eti_setSpan('eti_subtotal_no_gi', subtotal);
  const g=Math.max(0,parseNum(qs('eti_ganancia').value))/100;
  const i=Math.max(0,parseNum(qs('eti_impuestos').value))/100;
  const ganVal=qs('eti_chk_ganancia').checked? subtotal*g : 0;
  const subMasGan=subtotal+ganVal;
  const impVal=qs('eti_chk_impuestos').checked? subMasGan*i : 0;
  const total=subMasGan+impVal;
  eti_setSpan('eti_subtotal', subtotal); eti_setSpan('eti_ganancia_val', ganVal); eti_setSpan('eti_impuestos_val', impVal); eti_setSpan('eti_total', total);
}
function eti_reset(){
  localStorage.removeItem('etiquetas_state');

  const d={
    eti_d_prod_cant:50,eti_d_prod_precio:20,
    eti_d_adhesivo_cant:500,eti_d_adhesivo_precio:15,
    eti_d_liner_cant:1000,eti_d_liner_precio:20,
    eti_d_tinta_cant:1000,eti_d_tinta_precio:30,
    eti_d_merma_cant:500,eti_d_merma_precio:5,
    eti_d_laminado_cant:20,eti_d_laminado_precio:10,
    eti_d_empaque_cant:200,eti_d_empaque_precio:8,

    eti_e_impresora_precio:240,
    eti_e_plotter_precio:400,
    eti_e_guillotina_precio:120,
    eti_e_tapete_precio:15,
    eti_e_cuchilla_precio:30,eti_e_cuchilla_vida:100,
    eti_e_troqueladora_precio:300,
    eti_e_pc_precio:350,

    eti_ganancia:40,eti_impuestos:16
  };

  Object.keys(d).forEach(k=>{ if(qs(k)) qs(k).value=d[k]; });

  [
    'eti_d_prod_on','eti_d_adhesivo_on','eti_d_liner_on','eti_d_tinta_on','eti_d_merma_on','eti_d_laminado_on','eti_d_empaque_on',
    'eti_e_impresora_on','eti_e_plotter_on','eti_e_guillotina_on','eti_e_tapete_on','eti_e_cuchilla_on','eti_e_troqueladora_on','eti_e_pc_on',
    'eti_chk_ganancia','eti_chk_impuestos'
  ].forEach(id=>{ if(qs(id)) qs(id).checked=false; });

  if(qs('eti_d_prod_select')) qs('eti_d_prod_select').value='Vinil imprimible';
  eti_update();
}
qs('eti_d_prod_select').addEventListener('change',eti_applyPreset);
document.querySelectorAll('#view-etiquetas input').forEach(el=>{
  if(el.type==='number' || el.type==='checkbox') el.addEventListener('input', eti_update);
});
qs('btn_print_eti').addEventListener('click',()=>window.print());
qs('btn_copy_eti').addEventListener('click',()=>{
  const lines=[
    'Tipo: '+(qs('eti_d_prod_select')?.value||''),
    'Directos = '+qs('eti_total_directos').textContent,
    'Depreciación = '+qs('eti_total_depr').textContent,
    'Total sin G/I = '+qs('eti_subtotal_no_gi').textContent,
    'Subtotal = '+qs('eti_subtotal').textContent,
    'Ganancia ('+qs('eti_ganancia').value+'%) = '+qs('eti_ganancia_val').textContent + (qs('eti_chk_ganancia').checked?'':' (omitida)'),
    'Impuestos ('+qs('eti_impuestos').value+'%) = '+qs('eti_impuestos_val').textContent + (qs('eti_chk_impuestos').checked?'':' (omitidos)'),
    'Vida cuchilla (cortes) = '+(qs('eti_e_cuchilla_vida')?.value||''),
    'Precio de Venta = '+qs('eti_total').textContent
  ]; copyText(lines.join('\\n'));
});
qs('btn_reset_eti').addEventListener('click',eti_reset);
eti_load(); eti_applyPreset(); eti_update();

// ============ EMPAQUES ============
function emp_setText(id,n){ qs(id).value=fmtUSD(n) }
function emp_setSpan(id,n){ qs(id).textContent=fmtUSD(n) }
function emp_valNum(id){ const v=parseNum(qs(id).value); return v<0?0:v }
function emp_unitCost(precio,cant){ if(!precio||!cant) return 0; return precio/cant }
const EMP_KEYS=['emp_caja_on','emp_caja_cant','emp_caja_precio','emp_bolsa_on','emp_bolsa_cant','emp_bolsa_precio','emp_relleno_on','emp_relleno_cant','emp_relleno_precio','emp_etiqueta_on','emp_etiqueta_cant','emp_etiqueta_precio','emp_tarjeta_on','emp_tarjeta_cant','emp_tarjeta_precio','emp_cinta_on','emp_cinta_cant','emp_cinta_precio','emp_caja_use','emp_bolsa_use','emp_relleno_use','emp_etiqueta_use','emp_tarjeta_use','emp_cinta_use','emp_impresora_use','emp_impresora_on','emp_impresora_precio','emp_ganancia','emp_impuestos','emp_chk_ganancia','emp_chk_impuestos'];
function emp_save(){ const d={}; EMP_KEYS.forEach(k=>{ const el=qs(k); if(!el) return; d[k]=(el.type==='checkbox')?(el.checked?1:0):el.value; }); localStorage.setItem('empaques_state',JSON.stringify(d)); }
function emp_load(){ const raw=localStorage.getItem('empaques_state'); if(!raw) return; try{ const d=JSON.parse(raw); Object.keys(d).forEach(k=>{ const el=qs(k); if(!el) return; if(el.type==='checkbox') el.checked=!!d[k]; else el.value=d[k];}); }catch(e){} }
document.addEventListener('input',e=>{ const id=e.target&&e.target.id; if(id && EMP_KEYS.includes(id)) emp_save(); });
document.addEventListener('change',e=>{ const id=e.target&&e.target.id; if(id && EMP_KEYS.includes(id)) emp_save(); });

function emp_update(){
  function safe(n){ n=Number(n); if(!isFinite(n)||isNaN(n)) return 0; return n<0?0:n; }

  // --- Directos (Costo Ud. + Costo utilizado siempre visibles) ---
  const ud0=safe(emp_unitCost(emp_valNum('emp_caja_precio'), emp_valNum('emp_caja_cant'))); emp_setText('emp_caja_ud', ud0);
  const use0=safe(emp_valNum('emp_caja_use')); const used0=safe(ud0*use0); emp_setText('emp_caja_used', used0);

  const ud1=safe(emp_unitCost(emp_valNum('emp_bolsa_precio'), emp_valNum('emp_bolsa_cant'))); emp_setText('emp_bolsa_ud', ud1);
  const use1=safe(emp_valNum('emp_bolsa_use')); const used1=safe(ud1*use1); emp_setText('emp_bolsa_used', used1);

  const ud2=safe(emp_unitCost(emp_valNum('emp_relleno_precio'), emp_valNum('emp_relleno_cant'))); emp_setText('emp_relleno_ud', ud2);
  const use2=safe(emp_valNum('emp_relleno_use')); const used2=safe(ud2*use2); emp_setText('emp_relleno_used', used2);

  const ud3=safe(emp_unitCost(emp_valNum('emp_etiqueta_precio'), emp_valNum('emp_etiqueta_cant'))); emp_setText('emp_etiqueta_ud', ud3);
  const use3=safe(emp_valNum('emp_etiqueta_use')); const used3=safe(ud3*use3); emp_setText('emp_etiqueta_used', used3);

  const ud4=safe(emp_unitCost(emp_valNum('emp_tarjeta_precio'), emp_valNum('emp_tarjeta_cant'))); emp_setText('emp_tarjeta_ud', ud4);
  const use4=safe(emp_valNum('emp_tarjeta_use')); const used4=safe(ud4*use4); emp_setText('emp_tarjeta_used', used4);

  const ud5=safe(emp_unitCost(emp_valNum('emp_cinta_precio'), emp_valNum('emp_cinta_cant'))); emp_setText('emp_cinta_ud', ud5);
  const use5=safe(emp_valNum('emp_cinta_use')); const used5=safe(ud5*use5); emp_setText('emp_cinta_used', used5);

  const totalDirectos =
    (qs('emp_caja_on').checked?used0:0) +
    (qs('emp_bolsa_on').checked?used1:0) +
    (qs('emp_relleno_on').checked?used2:0) +
    (qs('emp_etiqueta_on').checked?used3:0) +
    (qs('emp_tarjeta_on').checked?used4:0) +
    (qs('emp_cinta_on').checked?used5:0);
  emp_setSpan('emp_total_directos', safe(totalDirectos));

  // --- Depreciación (mes/ud siempre visibles; usado siempre visible) ---
  function depUsed(chk,precioId,mesId,udId,useId,usedId){
    const precio=safe(emp_valNum(precioId));
    const mes=safe(precio/24);
    const ud=safe(mes/100);
    emp_setText(mesId, mes);
    emp_setText(udId, ud);
    const uses=safe(emp_valNum(useId));
    const used=safe(ud*uses);
    emp_setText(usedId, used);
    return (qs(chk).checked? used : 0);
  }
  const e1=depUsed('emp_impresora_on','emp_impresora_precio','emp_impresora_mes','emp_impresora_ud','emp_impresora_use','emp_impresora_used');
  const totalDepr=safe(e1); emp_setSpan('emp_total_depr', totalDepr);

  const subtotal=safe(totalDirectos+totalDepr); emp_setSpan('emp_subtotal_no_gi', subtotal);
  const g=Math.max(0,parseNum(qs('emp_ganancia').value))/100;
  const i=Math.max(0,parseNum(qs('emp_impuestos').value))/100;
  const ganVal=qs('emp_chk_ganancia').checked? subtotal*g : 0;
  const subMasGan=subtotal+ganVal;
  const impVal=qs('emp_chk_impuestos').checked? subMasGan*i : 0;
  const total=subMasGan+impVal;
  emp_setSpan('emp_subtotal', subtotal);
  emp_setSpan('emp_ganancia_val', ganVal);
  emp_setSpan('emp_impuestos_val', impVal);
  emp_setSpan('emp_total', total);
}
function emp_reset(){
  localStorage.removeItem('empaques_state');
  const d={emp_caja_cant:50,emp_caja_precio:20,emp_bolsa_cant:100,emp_bolsa_precio:12,emp_relleno_cant:1,emp_relleno_precio:5,emp_etiqueta_cant:100,emp_etiqueta_precio:8,emp_tarjeta_cant:50,emp_tarjeta_precio:6,emp_cinta_cant:1,emp_cinta_precio:2,emp_impresora_precio:200,emp_ganancia:30,emp_impuestos:16};
  Object.keys(d).forEach(k=>{ if(qs(k)) qs(k).value=d[k]; });
  ['emp_caja_use','emp_bolsa_use','emp_relleno_use','emp_etiqueta_use','emp_tarjeta_use','emp_cinta_use','emp_impresora_use'].forEach(id=>{ if(qs(id)) qs(id).value=1; });
  ['emp_caja_on','emp_bolsa_on','emp_relleno_on','emp_etiqueta_on','emp_tarjeta_on','emp_cinta_on','emp_impresora_on','emp_chk_ganancia','emp_chk_impuestos'].forEach(id=>{ if(qs(id)) qs(id).checked=true; });
  emp_update();
}
document.querySelectorAll('#view-empaques input').forEach(el=>{
  if(el.type==='number' || el.type==='checkbox') el.addEventListener('input', emp_update);
});
qs('btn_print_emp').addEventListener('click',()=>window.print());
qs('btn_copy_emp').addEventListener('click',()=>{
  const lines=[
    'Empaques — Directos = '+qs('emp_total_directos').textContent,
    'Depreciación = '+qs('emp_total_depr').textContent,
    'Total sin G/I = '+qs('emp_subtotal_no_gi').textContent,
    'Subtotal = '+qs('emp_subtotal').textContent,
    'Ganancia ('+qs('emp_ganancia').value+'%) = '+qs('emp_ganancia_val').textContent + (qs('emp_chk_ganancia').checked?'':' (omitida)'),
    'Impuestos ('+qs('emp_impuestos').value+'%) = '+qs('emp_impuestos_val').textContent + (qs('emp_chk_impuestos').checked?'':' (omitidos)'),
    'Precio de Venta = '+qs('emp_total').textContent
  ]; copyText(lines.join('\\n'));
});
qs('btn_reset_emp').addEventListener('click',emp_reset);
emp_load(); emp_update();

// ============ RESUMEN GENERAL ============
function sum_parseMoney(txt){
  const s = String(txt||'').replace('Costo total:','').replace(/[^0-9.,-]/g,'');
  // EU-aware: if it contains a comma, treat comma as decimal and dots as thousands
  if(s.includes(',')){
    const t = s.replace(/\./g,'').replace(',', '.');
    const n = parseFloat(t); return isFinite(n)?n:0;
  }
  const n = parseFloat(s); return isFinite(n)?n:0;
}
function sum_update(){
  const incV=qs('sum_incluir_vinil').checked, incS=qs('sum_incluir_sublim').checked, incE=qs('sum_incluir_etiq').checked, incEmp=qs('sum_incluir_emp').checked;
    const v = sum_parseMoney(qs('vin_total')?.textContent);
    const s = sum_parseMoney(qs('sub_v15_total')?.textContent);
    const e = sum_parseMoney(qs('eti_total')?.textContent);
    const m = sum_parseMoney(qs('emp_total')?.textContent);
  qs('sum_vinil').textContent = fmtUSD(v);
  qs('sum_sublim').textContent = (qs('sub_v15_total')?.textContent || '$ 0,00');
  qs('sum_etiq').textContent = fmtUSD(e);
  qs('sum_emp').textContent = fmtUSD(m);
  const total = (incV?v:0)+(incS?s:0)+(incE?e:0)+(incEmp?m:0);
  qs('sum_total').textContent = fmtUSD(total);
  const bcv = parseNum(qs('tasa_bcv')?.value);
  const par = parseNum(qs('tasa_paralelo')?.value);
  qs('sum_bcv').textContent = bcv? fmtBs(bcv): '—';
  qs('sum_par').textContent = par? fmtBs(par): '—';
}
['sum_incluir_vinil','sum_incluir_sublim','sum_incluir_etiq','sum_incluir_emp'].forEach(id=>{ const el=qs(id); if(el) el.addEventListener('change', sum_update); });
qs('btn_copy_sum').addEventListener('click',()=>{
  const lines=[
    'Resumen General',
    'Vinil = '+qs('sum_vinil').textContent + (qs('sum_incluir_vinil').checked?'':' (omitido)'),
    'Sublimación = '+qs('sum_sublim').textContent + (qs('sum_incluir_sublim').checked?'':' (omitida)'),
    'Etiquetas = '+qs('sum_etiq').textContent + (qs('sum_incluir_etiq').checked?'':' (omitidas)'),
    'Empaques = '+qs('sum_emp').textContent + (qs('sum_incluir_emp').checked?'':' (omitidos)'),
    'Total General = '+qs('sum_total').textContent,
    'Precio BCV = '+qs('sum_bcv').textContent,
    'Precio Paralelo = '+qs('sum_par').textContent
  ]; copyText(lines.join('\\n'));
});
qs('btn_print_sum').addEventListener('click',()=>window.print());
['vin_total','sub_v15_total','eti_total','emp_total'].forEach(id=>{
  const obEl = qs(id);
  if(obEl){
    const obs = new MutationObserver(sum_update);
    obs.observe(obEl, {childList:true, characterData:true, subtree:true});
  }
});
['tasa_bcv','tasa_paralelo'].forEach(id=>qs(id)?.addEventListener('input', sum_update));
sum_update();

// ============ DTF (servicio externo) ============
(() => {
  const $ = (id) => document.getElementById(id);
  const fmt = (n)=>'$ ' + fmtEU(isFinite(n)?n:0);
  const num = (el)=>parseNum(el?.value);
  const clamp = (n)=>isFinite(n)?n:0;

  const MODO = { metro:'metro', tramo30:'tramo30', a3:'a3' };
  const ANCHO_CM = 57;

  function unidadesCobradas(mod, largo_cm, respMin){
    if(mod===MODO.a3){
      // En A3, el usuario define cuántas hojas necesita vía largo => interpretamos 1 unidad por cada 42 cm de largo ocupado (aprox alto de A3 a lo ancho de 57 cm).
      // Para evitar suposiciones fuertes, tratamos largo_cm como múltiplos de 1 hoja si respMin está activo.
      const hojaEquiv = 42; // cm aprox de alto util por "fila" para A3 cuando ANCHO=57 (aproximación práctica)
      let u = largo_cm/hojaEquiv;
      if(respMin) u = Math.ceil(Math.max(1,u));
      return Math.max(0,u);
    }
    const unidad = (mod===MODO.metro)?100:30;
    let u = largo_cm / unidad;
    if(respMin) u = Math.ceil(Math.max(1,u));
    return Math.max(0,u);
  }

  function recompute(){
    // --- EXTENSION HOOK (multi-diseños actualiza largo si aplica) ---
    try{ if(window.recomputeDTF_Ext) window.recomputeDTF_Ext(); }catch(e){}
    const mod = $("dtf_modalidad").value;
    const respMin = $("dtf_resp_min").checked;

    // Largo directo o por diseños
    let largo = num($("dtf_largo_cm"));

    if($("dtf_calc_por_diseno").checked){
      const N = Math.max(1, Math.floor(num($("dtf_n"))));
      const w = Math.max(0, num($("dtf_w")));
      const h = Math.max(0, num($("dtf_h")));
      const cols = Math.max(1, Math.floor(ANCHO_CM / Math.max(1,w)));
      const filas = Math.ceil(N / cols);
      const largo_calc = filas * h;
      $("dtf_largo_cm").value = String(largo_calc.toFixed(1));
      largo = largo_calc;
    }

    // Precio por unidad
    let punit = num($("dtf_precio_unit"));

    // Unidades cobrada por el proveedor
    const u = unidadesCobradas(mod, largo, respMin);
    $("dtf_unidades").textContent = isFinite(u)?u.toString():"0";

    const directos = clamp(u * punit);

    const extras = clamp(num($("dtf_extra_envio")) + num($("dtf_extra_diseno")) + num($("dtf_extra_plancha")) + num($("dtf_extra_otros")));
    // Costos prenda
    let prenda_ud = 0, prenda_total = 0;
    if ($("dtf_prenda_on")?.checked){
      const pcant = Math.max(0, num($("dtf_prenda_cant")));
      const pprecio = Math.max(0, num($("dtf_prenda_precio")));
      prenda_ud = (pcant>0)? (pprecio/pcant) : 0;
      $("dtf_prenda_costo_ud") && ($("dtf_prenda_costo_ud").value = fmt(prenda_ud));
      // Si tenemos conteo de estampados por bloques, lo usamos; si no, usamos pcant directo
      let estampados = 0;
      try{
        if(window.dtf_estampados_cache!=null) estampados = window.dtf_estampados_cache;
      }catch(e){}
      if(estampados<=0) estampados = pcant;
      prenda_total = prenda_ud * estampados;
    }else{
      $("dtf_prenda_costo_ud") && ($("dtf_prenda_costo_ud").value = "$ 0,00");
    }

    // Depreciación plancha (por estampado)
    let dep_ud = 0, dep_total = 0;
    const depPrecio = num($("dtf_dep_plancha_precio"));
    const depVida = Math.max(1, num($("dtf_dep_plancha_vida")));
    if ($("dtf_dep_on")?.checked){
      dep_ud = depPrecio / depVida;
    } else {
      dep_ud = 0;
    }
    $("dtf_dep_plancha_ud") && ($("dtf_dep_plancha_ud").value = fmt(dep_ud));
    // Conteo de estampados
    let estampados_calc = 0;
    try{
      if(window.dtf_estampados_cache!=null) estampados_calc = window.dtf_estampados_cache;
    }catch(e){}
    dep_total = dep_ud * Math.max(0, estampados_calc);

    const sinGI = directos + extras + prenda_total + dep_total;

    // Ganancia / Impuestos
    const useG = $("dtf_chk_ganancia").checked;
    const useI = $("dtf_chk_impuestos").checked;
    const gPct = useG ? num($("dtf_ganancia"))/100 : 0;
    const iPct = useI ? num($("dtf_impuestos"))/100 : 0;

    const subtotal = sinGI;
    const gVal = subtotal * gPct;
    const iVal = (subtotal + gVal) * iPct;
    const total = subtotal + gVal + iVal;

    $("dtf_total_directos").textContent = fmt(directos);
    $("dtf_total_extras").textContent   = fmt(extras);
    // --- Cálculos unitarios y costo por camiseta ---
    try{
      const cont = document.getElementById("dtf_bloques");
      let N = 0;
      if(cont && cont.children.length){
        cont.querySelectorAll('.card.md-12').forEach(card=>{
          const id = card.querySelector('[data-remove]')?.getAttribute('data-remove');
          N += parseFloat(document.getElementById('dtf_n'+id)?.value||"0")||0;
        });
      }else{
        N = parseFloat(document.getElementById("dtf_n")?.value||"0")||0;
      }
      const envio = parseFloat(document.getElementById("dtf_extra_envio")?.value||"0")||0;
      const dis   = parseFloat(document.getElementById("dtf_extra_diseno")?.value||"0")||0;
      const otros = parseFloat(document.getElementById("dtf_extra_otros")?.value||"0")||0;
      const pla   = parseFloat(document.getElementById("dtf_extra_plancha")?.value||"0")||0;
      const extras_unit = N>0 ? ((envio+dis+otros)/N) : 0;
      const perDTF = N>0 ? (directos/N) : 0;
      const costo_ud_dtf = perDTF + extras_unit + pla;
      const costo_camiseta = prenda_ud + dep_ud + costo_ud_dtf;
      const el1 = document.getElementById("dtf_costo_ud_dtf");
      const el2 = document.getElementById("dtf_costo_por_camiseta");
      el1 && (el1.textContent = fmt(costo_ud_dtf));
      el2 && (el2.textContent = fmt(costo_camiseta));
    }catch(e){}
    $("dtf_total_prenda") && ($("dtf_total_prenda").textContent = fmt(prenda_total));
    $("dtf_total_dep") && ($("dtf_total_dep").textContent = fmt(dep_total));
    $("dtf_subtotal_no_gi").textContent = fmt(sinGI);
    $("dtf_subtotal").textContent       = fmt(subtotal);
    $("dtf_ganancia_val").textContent   = fmt(gVal);
    $("dtf_impuestos_val").textContent  = fmt(iVal);
    $("dtf_total").textContent          = fmt(total);

    // Actualizar Resumen General línea DTF si existe (se usa el Precio de Venta final)
    const sum_dtf = document.getElementById("sum_dtf");
    if(sum_dtf) sum_dtf.textContent = fmt(total);
    // Cache estampados estimados para otros cálculos
    try{ window.dtf_estampados_cache = (function(){
      // Si se usó cálculo por múltiples diseños, sumamos cantidades
      const cont = document.getElementById("dtf_bloques");
      if(cont && cont.children.length){
        let e=0;
        cont.querySelectorAll('.card.md-12').forEach(card=>{
          const id = card.querySelector('[data-remove]')?.getAttribute('data-remove');
          const n = parseNum(document.getElementById('dtf_n'+id)?.value)||0;
          e += n;
        });
        return e;
      }
      // fallback a N del bloque simple si estaba activo
      const nSimple = parseNum(document.getElementById("dtf_n")?.value)||0;
      return Math.max(0,nSimple);
    })(); }catch(e){}

    // Dibujar gráfico
    try{
      const canvas = document.getElementById("dtf_chart");
      const labels = ["Directos","Prendas","Deprec.","Extras","Subtotal","+Ganancia","+Impuestos","Total"];
      const subtotalChart = subtotal;
      const gValChart = gVal;
      const iValChart = iVal;
      const data = [directos, prenda_total, dep_total, extras, subtotalChart, gValChart, iValChart, total];
      drawBarChart(canvas, labels, data);
    }catch(e){}
  }

  // Modalidad cambia: ajusta precio sugerido
  $("dtf_modalidad")?.addEventListener("change", () => {
    const mod = $("dtf_modalidad").value;
    if(mod==="metro") $("dtf_precio_unit").value = "15";
    else if(mod==="tramo30") $("dtf_precio_unit").value = (15*0.3).toFixed(2);
    else if(mod==="a3") $("dtf_precio_unit").value = "5";
    recompute();
  });

  // Mostrar/ocultar cálculo por diseños
  $("dtf_calc_por_diseno")?.addEventListener("change", () => {
    const on = $("dtf_calc_por_diseno").checked;
    $("dtf_por_diseno").style.display = on ? "block" : "none";
    recompute();
  });

  // Inputs que disparan cálculo
  ["dtf_precio_unit","dtf_resp_min","dtf_largo_cm","dtf_n","dtf_w","dtf_h","dtf_prenda_on","dtf_prenda_cant","dtf_prenda_precio","dtf_dep_on","dtf_dep_plancha_precio","dtf_dep_plancha_vida",
   "dtf_extra_envio","dtf_extra_diseno","dtf_extra_plancha","dtf_extra_otros",
   "dtf_chk_ganancia","dtf_ganancia","dtf_chk_impuestos","dtf_impuestos"].forEach(id=>{
    const el = $(id); el && el.addEventListener("input", recompute);
    el && el.addEventListener("change", recompute);
  });

  // Botones
  $("btn_reset_dtf")?.addEventListener("click", ()=>{
    $("dtf_modalidad").value = "metro";
    $("dtf_precio_unit").value = "15";
    $("dtf_resp_min").checked = true;
    $("dtf_largo_cm").value = "0";
    $("dtf_calc_por_diseno").checked = false;
    $("dtf_por_diseno").style.display = "none";
    $("dtf_n").value = "1"; $("dtf_w").value="10"; $("dtf_h").value="10";
    $("dtf_extra_envio").value="0"; $("dtf_extra_diseno").value="0";
    $("dtf_extra_plancha").value="0"; $("dtf_extra_otros").value="0";
    $("dtf_chk_ganancia").checked=true; $("dtf_ganancia").value="40";
    $("dtf_chk_impuestos").checked=true; $("dtf_impuestos").value="16";
    recompute();
  });

$("btn_reset_dtf")?.addEventListener("click", ()=>{
  // Reset valores numéricos a defaults suaves
  $("dtf_modalidad").value = "metro";
  $("dtf_precio_unit").value = "15";
  $("dtf_largo_cm").value = "0";
  $("dtf_n").value = "1"; $("dtf_w").value="10"; $("dtf_h").value="10";
  $("dtf_extra_envio").value="0"; $("dtf_extra_diseno").value="0";
  $("dtf_extra_plancha").value="0"; $("dtf_extra_otros").value="0";
  $("dtf_ganancia").value="40"; $("dtf_impuestos").value="16";
  $("dtf_prenda_cant").value="0"; $("dtf_prenda_precio").value="0";
  $("dtf_dep_plancha_precio").value="400"; // Panel de vista previa
  const panelTipo = document.getElementById("dtf_panel_tipo");
  if(panelTipo) panelTipo.value = "metro";
  const pw = document.getElementById("dtf_panel_w");
  const ph = document.getElementById("dtf_panel_h");
  if(pw) pw.value = "57"; if(ph) ph.value = "100";
  const sep = document.getElementById("dtf_sep"); if(sep) sep.value = "0.5";

  // Apagar TODOS los checkboxes dentro del módulo DTF
  const view = document.getElementById("view-dtf");
  if(view){
    view.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
  }

  // Ocultar el panel simple por diseño si estaba visible
  const porDis = document.getElementById("dtf_por_diseno");
  if(porDis) porDis.style.display = "none";

  // Vaciar bloques múltiples
  const bloques = document.getElementById("dtf_bloques");
  if(bloques) bloques.innerHTML = "";

  // Recalcular
  if(typeof recompute === "function") recompute();
});

$("btn_copy_dtf")?.addEventListener("click", ()=>{
    const txt = [
      "DTF (terceros)",
      "Proveedor: "+($("#dtf_proveedor")?.value||"-"),
      "Modalidad: "+($("#dtf_modalidad")?.selectedOptions?.[0]?.text||"-"),
      "Precio por unidad: "+($("#dtf_precio_unit")?.value||"0"),
      "Unidades cobradas: "+($("#dtf_unidades")?.textContent||"0"),
      "Total directos: "+($("#dtf_total_directos")?.textContent||"$0.00"),
      "Extras: "+($("#dtf_total_extras")?.textContent||"$0.00"),
      "Subtotal sin G/I: "+($("#dtf_subtotal_no_gi")?.textContent||"$0.00"),
      "Subtotal: "+($("#dtf_subtotal")?.textContent||"$0.00"),
      "+ Ganancia: "+($("#dtf_ganancia_val")?.textContent||"$0.00"),
      "+ Impuestos: "+($("#dtf_impuestos_val")?.textContent||"$0.00"),
      "Precio de Venta: "+($("#dtf_total")?.textContent||"$0.00")
    ].join("\n");
    copyText(txt);
  });

  $("btn_print_dtf")?.addEventListener("click", ()=>{
    const old = document.querySelectorAll(".view.active");
    old.forEach(v=>v.classList.remove("active"));
    const v = document.getElementById("view-dtf");
    v && v.classList.add("active");
    window.print();
  });

  // Inicial
  recompute();
})();

// ============ Resumen General — integrar DTF ============
(() => {
  const $ = (id)=>document.getElementById(id);
  // Extiende suma total para incluir DTF si está marcado
  const sumHook = () => {
    const parseMoney = (t)=>parseNum((t||"").toString().replace(/[^0-9.,-]/g,''));
    const inc = (id, onId) => ($(onId)?.checked ? parseMoney($(id)?.textContent||"0") : 0);
    // Los elementos existentes ya hacen su suma; ajustamos si hay total general en pantalla
    const totalEl = $("sum_total");
    if(!totalEl) return;
    // Recupera el total actual mostrado (puede haber sido calculado por otro bloque)
    // y ajusta sumando DTF si corresponde. Por seguridad, recalculamos desde cero con lo que exista.
    let t = 0;
    t += inc("sum_vinil","sum_incluir_vinil");
    t += inc("sum_sublim","sum_incluir_sublim");
    t += inc("sum_etiq","sum_incluir_etiq");
    t += inc("sum_emp","sum_incluir_emp");
    t += inc("sum_env","sum_incluir_env");
    t += inc("sum_dtf","sum_incluir_dtf");
    totalEl.textContent = '$ ' + fmtEU(isFinite(t)?t:0);
  };

  ["sum_incluir_vinil","sum_incluir_sublim","sum_incluir_etiq","sum_incluir_emp","sum_incluir_env","sum_incluir_dtf"].forEach(id=>{
    const el = document.getElementById(id);
    el && el.addEventListener("change", sumHook);
  });

  // Observa cambios de totales individuales
  const obs = new MutationObserver(sumHook);
  ["sum_vinil","sum_sublim","sum_etiq","sum_emp","sum_env","sum_dtf"].forEach(id=>{
    const el = document.getElementById(id);
    el && obs.observe(el,{childList:true,subtree:true,characterData:true});
  });
  sumHook();
})();

// === Helpers: draw a simple bar chart on a canvas (no external libs) ===
function drawBarChart(canvas, labels, data){
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = '#f9fafb';
  ctx.fillRect(0,0,W,H);
  // Axes padding
  const padL = 50, padR = 20, padT = 20, padB = 40;
  const plotW = W - padL - padR, plotH = H - padT - padB;
  // Grid
  ctx.strokeStyle = '#e5e7eb';
  ctx.lineWidth = 1;
  const maxV = Math.max(1, Math.max.apply(null, data));
  const steps = 4;
  for(let i=0;i<=steps;i++){
    const y = padT + plotH - (i/steps)*plotH;
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+plotW,y); ctx.stroke();
    const v = (maxV*i/steps);
    ctx.fillStyle='#6b7280'; ctx.font='12px sans-serif';
    ctx.fillText('$'+v.toFixed(0), 6, y+4);
  }
  // Bars
  const n = data.length;
  const barW = Math.max(10, plotW/(n*1.5));
  const gap = (plotW - n*barW)/(n-1>0?(n-1):1);
  data.forEach((v,i)=>{
    const x = padL + i*(barW+gap);
    const h = (v/maxV)*plotH;
    const y = padT + plotH - h;
    ctx.fillStyle = '#7aa2ff'; // auto color (kept simple)
    ctx.fillRect(x,y,barW,h);
    ctx.fillStyle='#111'; ctx.font='12px sans-serif';
    ctx.save(); ctx.translate(x+barW/2, H-8); ctx.rotate(-Math.PI/8);
    ctx.textAlign='center'; ctx.fillText(labels[i],0,0); ctx.restore();
  });
}

// === DTF module extensions ===
(() => {
  const $ = (id) => document.getElementById(id);
  const fmt = (n)=>'$ ' + fmtEU(isFinite(n)?n:0);
  const num = (el)=>parseNum(el?.value);
  const clamp = (n)=>isFinite(n)?n:0;
  const ANCHO_CM = 57;

  // ---- Múltiples diseños ----
  let dtf_counter = 0;
  const bloques = $("dtf_bloques");
  function blockHTML(id){
    return `
    <div class="calc-block" id="dtf_block${id}" style="border:1px solid #eee;border-radius:12px;padding:12px;background:#fff">
      <div class="row" style="align-items:center;justify-content:space-between">
        <label style="margin:0">Diseño</label>
        <button class="copy-btn" data-remove="${id}">Eliminar</button>
      </div>
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <div style="min-width:150px;flex:1">
          <label>Ancho (cm)</label>
          <input type="number" id="dtf_w${id}" step="0.1" min="0" value="10"/>
        </div>
        <div style="min-width:150px;flex:1">
          <label>Alto (cm)</label>
          <input type="number" id="dtf_h${id}" step="0.1" min="0" value="10"/>
        </div>
        <div style="min-width:150px;flex:1">
          <label>Cantidad</label>
          <input type="number" id="dtf_n${id}" step="1" min="1" value="1"/>
        </div>
      </div>
    </div>`;
  }
  function addBlock(){
    dtf_counter++;
    const id = dtf_counter;
    const div = document.createElement('div');
    div.className='card md-12';
    div.innerHTML = blockHTML(id);
    bloques.appendChild(div);
    // listeners
    ["dtf_w"+id,"dtf_h"+id,"dtf_n"+id].forEach(k=>{
      const el = document.getElementById(k);
      el && el.addEventListener('input', recomputeDTF_Ext);
      el && el.addEventListener('change', recomputeDTF_Ext);
    });
    div.querySelector('[data-remove]')?.addEventListener('click', ()=>{
      div.remove(); recomputeDTF_Ext();
    });
    recomputeDTF_Ext();
  }
  if (window.__DTF_USE_OLD__ === true) { $("dtf_add_diseno")?.addEventListener("click", addBlock); }

  // ---- Cálculo largo por múltiples diseños ----
  function largoPorBloques(){
    const cards = bloques?.querySelectorAll('.card.md-12') || [];
    let largoTotal = 0;
    let estampados = 0;
    cards.forEach(card=>{
      const id = card.querySelector('[data-remove]')?.getAttribute('data-remove');
      const w = parseNum(document.getElementById('dtf_w'+id)?.value);
      const h = parseNum(document.getElementById('dtf_h'+id)?.value);
      const n = Math.max(1, Math.floor(parseNum(document.getElementById('dtf_n'+id)?.value)));
      if(w>0 && h>0 && n>0){
        const cols = Math.max(1, Math.floor(ANCHO_CM / Math.max(1,w)));
        const filas = Math.ceil(n / cols);
        largoTotal += filas * h;
        estampados += n;
      }
    });
    return {largoTotal, estampados};
  }

  // Hook original recompute to include prenda + depreciación + multi-diseños + chart
  const oldRecompute = window.recompute || null; // in case
  function recomputeDTF_Ext(){
    const respMin = $("dtf_resp_min")?.checked;
    const mod = $("dtf_modalidad")?.value;

    // Largo base del input
    let largo = num($("dtf_largo_cm"));

    // Si hay bloques, usamos su cálculo (sobrescribe)
    const res = largoPorBloques();
    if(res.largoTotal>0){
      largo = res.largoTotal;
      $("dtf_largo_cm").value = String(largo.toFixed(1));
    }

    // Unidades cobradas según modalidad (reutiliza lógica existente)
    // Encontrar función ya definida en el otro bloque
  }
  window.recomputeDTF_Ext = recomputeDTF_Ext;

  // Interceptar la función recompute original del módulo DTF anterior
  // Buscamos por el texto único dtf_unidades en listeners para ubicar el scope.
  // En su lugar, re-ejecutamos el cálculo original y luego extendemos.
})();

// ===== DTF Layout Preview (57 cm width) =====
(() => {
  const $ = (id)=>document.getElementById(id);
  const ANCHO_CM = 57;

  function collectDesigns(){
    const cont = $("dtf_bloques");
    const items = [];
    cont?.querySelectorAll('.card.md-12').forEach(card=>{
      const id = card.querySelector('[data-remove]')?.getAttribute('data-remove');
      const w = parseNum(document.getElementById('dtf_w'+id)?.value) || 0;
      const h = parseNum(document.getElementById('dtf_h'+id)?.value) || 0;
      const n = Math.max(0, Math.floor(parseNum(document.getElementById('dtf_n'+id)?.value) || 0));
      if(w>0 && h>0 && n>0){
        items.push({w,h,n});
      }
    });
    return items;
  }

  // Simple shelf-packing (no rotación), left-to-right, top-to-bottom
  function packShelf(items, panelH, sep){
    // Expand items list (could be large; still fine for our use)
    const list = [];
    items.forEach(it=>{ for(let i=0;i<it.n;i++) list.push({w:it.w, h:it.h}); });
    // Sort by height desc then width desc (heuristic)
    list.sort((a,b)=> (b.h - a.h) || (b.w - a.w));

    const placements = [];
    let x=0, y=0, rowH=0;
    const W = ANCHO_CM;

    let unplaced = 0;
    for(const r of list){
      if(r.w > W){ unplaced++; continue; } // too wide
      if(x===0){ // new row
        if(y + r.h > panelH + 1e-6){ unplaced++; continue; }
        placements.push({x:0, y, w:r.w, h:r.h});
        x = r.w + sep;
        rowH = Math.max(rowH, r.h);
      }else{
        if(x + r.w <= W + 1e-6){
          if(y + r.h > panelH + 1e-6){ unplaced++; continue; }
          placements.push({x, y, w:r.w, h:r.h});
          x += r.w + sep;
          rowH = Math.max(rowH, r.h);
        }else{
          // next row
          y += rowH + sep;
          if(y + r.h > panelH + 1e-6){ unplaced++; continue; }
          placements.push({x:0, y, w:r.w, h:r.h});
          x = r.w + sep;
          rowH = r.h;
        }
      }
    }
    const usedH = placements.length ? (placements[placements.length-1].y + rowH) : 0;
    return {placements, usedH, unplaced};
  }

  function drawLayout(canvas, panelH, placements, sep){
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const Wpx = canvas.width, Hpx = canvas.height;
    ctx.clearRect(0,0,Wpx,Hpx);

    // Scale so that 57cm width fits horizontally, and panelH fits vertically
    const sx = Wpx / ANCHO_CM;
    const sy = Hpx / Math.max(panelH,1);
    const s = Math.min(sx, sy);

    // Background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,Wpx,Hpx);

    // Panel border
    ctx.strokeStyle = '#111';
    ctx.lineWidth = 2;
    ctx.strokeRect(0, 0, ANCHO_CM*s, panelH*s);

    // Draw placements
    let idx = 0;
    for(const p of placements){
      const x = p.x*s;
      const y = p.y*s;
      const w = p.w*s;
      const h = p.h*s;
      // fill
      const hue = (idx*47)%360;
      ctx.fillStyle = `hsl(${hue} 70% 70%)`;
      ctx.fillRect(x,y,w,h);
      // border
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 1;
      ctx.strokeRect(x,y,w,h);
      // label
      ctx.fillStyle = '#111';
      ctx.font = '12px sans-serif';
      ctx.fillText(`${p.w}×${p.h}`, x+4, y+14);
      idx++;
    }

    // Rulers text
    ctx.fillStyle = '#6b7280';
    ctx.font = '12px sans-serif';
    ctx.fillText('57 cm', (ANCHO_CM*s)/2 - 18, Hpx - 6);
    ctx.save();
    ctx.rotate(-Math.PI/2);
    ctx.fillText(panelH+' cm', - (panelH*s)/2 - 18, 12);
    ctx.restore();
  }

  function generatePreview(){
    const items = collectDesigns();
    const sep = parseNum($("dtf_sep")?.value) || 0;
    const panelH = parseNum($("dtf_panel_h")?.value) || 100;

    const res = packShelf(items, panelH, sep);
    drawLayout($("dtf_layout"), panelH, res.placements, sep);

    // Actualiza info y largo
    const info = `Colocados: ${res.placements.length} elementos • Sin colocar: ${res.unplaced} • Alto usado: ${res.usedH.toFixed(1)} cm`;
    $("dtf_layout_info").textContent = info;
    // Si cabe dentro del panel, actualizamos largo de pedido al alto usado (o al panel si prefieres)
    if(res.usedH>0){
      $("dtf_largo_cm").value = String(Math.min(res.usedH, panelH).toFixed(1));
      const evt = new Event('input'); $("dtf_largo_cm").dispatchEvent(evt);
    }
  }

  $("dtf_preview_btn")?.addEventListener('click', generatePreview);

  // Preset solicitado por Daniel: 10×(10×10), 20×(8×8), 1×(25×35), separación 0.5, panel 100
  $("dtf_preset_demo")?.addEventListener('click', ()=>{
    const cont = $("dtf_bloques");
    cont.innerHTML = "";
    // helper to add block
    function add(w,h,n){
      const e = document.createElement('div');
      e.className='card md-12';
      const id = (window.dtf_counter = (window.dtf_counter||0) + 1);
      e.innerHTML = `
        <div class="calc-block" id="dtf_block${id}" style="border:1px solid #eee;border-radius:12px;padding:12px;background:#fff">
          <div class="row" style="align-items:center;justify-content:space-between">
            <label style="margin:0">Diseño</label>
            <button class="copy-btn" data-remove="${id}">Eliminar</button>
          </div>
          <div class="row" style="gap:12px;flex-wrap:wrap">
            <div style="min-width:150px;flex:1">
              <label>Ancho (cm)</label>
              <input type="number" id="dtf_w${id}" step="0.1" min="0" value="${w}"/>
            </div>
            <div style="min-width:150px;flex:1">
              <label>Alto (cm)</label>
              <input type="number" id="dtf_h${id}" step="0.1" min="0" value="${h}"/>
            </div>
            <div style="min-width:150px;flex:1">
              <label>Cantidad</label>
              <input type="number" id="dtf_n${id}" step="1" min="1" value="${n}"/>
            </div>
          </div>
        </div>`;
      cont.appendChild(e);
      ["dtf_w"+id,"dtf_h"+id,"dtf_n"+id].forEach(k=>{
        const el = document.getElementById(k);
        el && el.addEventListener('input', ()=>{});
        el && el.addEventListener('change', ()=>{});
      });
      e.querySelector('[data-remove]')?.addEventListener('click', ()=>{ e.remove(); });
    }
    add(10,10,10);
    add(8,8,20);
    add(25,35,1);
    $("dtf_sep").value = "0.5";
    $("dtf_panel_h").value = "100";
  });

  // Auto preview when changing key params
  ["dtf_sep","dtf_panel_h"].forEach(id=>{
    const el = $(id);
    el && el.addEventListener('input', ()=>{});
    el && el.addEventListener('change', ()=>{});
  });

})();

</script>
<script>

(function(){
  function q(sel){ try{return document.querySelector(sel);}catch(e){return null;} }
  function qa(sel){ try{return Array.from(document.querySelectorAll(sel));}catch(e){return [];} }
  // EU helpers
  function parseEU(v){
    if (v==null) return 0;
    v = String(v).trim().replace(/[^\d.,-]/g,'');
    if (!v) return 0;
    if (v.indexOf(',')>=0){ v = v.replace(/\./g,'').replace(',', '.'); }
    return parseFloat(v)||0;
  }
  function fmtEU(n, dec=2){
    if (!isFinite(n)) n=0;
    const s = Number(n).toFixed(dec);
    const [a,b] = s.split('.');
    return a.replace(/\B(?=(\d{3})+(?!\d))/g,'.') + (dec?(','+b):'');
  }
  function onlyEUInput(el){
    if(!el) return;
    el.addEventListener('input', ()=>{ el.value = el.value.replace(/[^\d.,-]/g,''); });
    el.addEventListener('blur', ()=>{ el.value = fmtEU(parseEU(el.value)); });
  }
  function setMoney(el, n){ if(el) el.value = '$ ' + fmtEU(n); }
  function setText(el, n){ if(el){ el.textContent = '$ ' + fmtEU(n); } }

  // Attach EU inputs
  [q('#cd_cant'), q('#cd_precio')].forEach(onlyEUInput);
  ['impresora','plancha','pc','plotter','cuchilla'].forEach(k=>{
    onlyEUInput(q('.dep_precio[data-row="'+k+'"]'));
    const v = q('.dep_vida[data-row="'+k+'"]'); if (v) onlyEUInput(v);
  });

  function recalc(){
    // Directos (mostrar siempre; sumar solo si está activado)
    const _cde=q('#cd_enabled'); const enabled = _cde && _cde.checked ? true : false;
    const _cc=q('#cd_cant'); const cant = parseEU(_cc && _cc.value);
    const _cp=q('#cd_precio'); const precio = parseEU(_cp && _cp.value);
    const directos_calc = (cant>0) ? (precio/cant) : 0;
    setMoney(q('#cd_costo_ud'), directos_calc);
    const directos = enabled ? directos_calc : 0;

    // Depreciación (mostrar siempre; sumar solo marcados)
    let depSum = 0;
    ['impresora','plancha','pc','plotter','cuchilla'].forEach(k=>{
      const _on = q('.dep_enabled[data-row="'+k+'"]'); const on = _on && _on.checked ? true : false;
      const _p = q('.dep_precio[data-row="'+k+'"]'); const precio = parseEU(_p && _p.value);
      if (k==='cuchilla'){
        const _v = q('.dep_vida[data-row="'+k+'"]'); const vida = parseEU(_v && _v.value);
        const ud_calc = (vida>0) ? (precio/vida) : 0;
        setMoney(q('.dep_ud[data-row="'+k+'"]'), ud_calc);
        const mesEl = q('.dep_mes[data-row="'+k+'"]'); if (mesEl) setMoney(mesEl, 0);
        if (on) depSum += ud_calc;
      }else{
        const mes_calc = precio/24;
        const ud_calc = mes_calc/100;
        setMoney(q('.dep_mes[data-row="'+k+'"]'), mes_calc);
        setMoney(q('.dep_ud[data-row="'+k+'"]'), ud_calc);
        if (on) depSum += ud_calc;
      }
    });

    // Resumen vinil

    setText(q('#vinil_directos'), directos);
    setText(q('#vinil_dep'), depSum);
    // set by main updater (material): see vinil_actualizarTotal()

    const ext = q('#vinil_ext_total'); if (ext) ext.textContent = 'Adicionales vinil: $' + fmtEU(directos + depSum);
  }
  // push extras to main total
  try{ window._vinilExtras = directos + depSum; if (typeof vinil_actualizarTotal==='function') vinil_actualizarTotal(); }catch(e){} 
}

  // Bind
  ['#cd_cant','#cd_precio'].forEach(sel=>{var el=q(sel); if(el) el.addEventListener('input', recalc);});
  var _ee=q('#cd_enabled'); if(_ee) _ee.addEventListener('change', recalc);
  var _ei=q('#cd_enabled'); if(_ei) _ei.addEventListener('input', recalc);
  qa('.dep_enabled,.dep_precio,.dep_vida').forEach(function(el){ el.addEventListener('input', recalc); });
  qa('.dep_enabled').forEach(function(el){ el.addEventListener('change', recalc); });

  // Reset de adicionales (sin afectar bloques de vinil)
  var _br=q('#btn_reset_vinil_extra'); if(_br) _br.addEventListener('click', function(){
    ['impresora','plancha','pc','plotter','cuchilla'].forEach(k=>{
      const chk = q('.dep_enabled[data-row="'+k+'"]'); if (chk) chk.checked=false;
    });
    const cd = q('#cd_enabled'); if (cd) cd.checked=false;
    recalc();
  });

  // Copiar desglose
  var _bc=q('#btn_copy_vinil'); if(_bc) _bc.addEventListener('click', function(){
    const t = `Directos: ${q('#vinil_directos').textContent}
Depreciación: ${q('#vinil_dep').textContent}
Adicionales vinil: ${q('#vinil_adicionales').textContent}`;
    navigator.clipboard.writeText(t);
  });

  // Kick + safety interval
  recalc();

})();

</script>
<script>

// === Vinil Pro v46 (summary at bottom) ===
(function(){
  const qs = (s)=>document.querySelector(s);
  const qa = (s)=>Array.from(document.querySelectorAll(s));
  const parseNum = window.parseNum || (v=>{ v=String(v||'').replace(/[^0-9.,-]/g,'').replace(/,/g,''); return parseFloat(v)||0; });
  const fmtUSD = window.fmtUSD || (n=> new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(isFinite(n)?n:0));

  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
  const adjustDebounced = debounce(vinil_pro_adjust, 150);

  function syncMerma(e){
    const pct = Math.max(0, Math.min(30, parseFloat(qs('#merma_pct')?.value||0)));
    if(e && e.target && e.target.id==='merma_range'){
      qs('#merma_pct').value = qs('#merma_range').value;
    }else{
      qs('#merma_range').value = pct;
    }
    adjustDebounced();
  }

  function anchoEfectivo(){
    const ancho = parseFloat(qs('#ancho_estandar')?.value||0);
    const borde = parseFloat(qs('#borde_lado')?.value||0);
    const eff = Math.max(0, ancho - 2*borde);
    const span = qs('#ancho_efectivo');
    if(span){
      span.textContent = (isFinite(ancho)&&isFinite(borde)) ? `${ancho} − 2×${borde} = ${eff.toFixed(1)} cm` : '—';
      span.style.color = eff>0 ? '' : '#ef4444';
      span.style.fontWeight = eff>0 ? '' : '700';
    }
    return eff;
  }

  function getNumText(id){
    const el = qs(id);
    if(!el) return 0;
    return parseNum(el.textContent);
  }

  function vinil_pro_adjust(){
    try{ if(window.vinil_actualizarTotal){ window.vinil_actualizarTotal(); } }catch(e){}

    const directos = getNumText('#vinil_directos');
    const dep      = getNumText('#vinil_dep');
    const adicRaw  = getNumText('#vinil_adicionales');

    const mermaPct = Math.max(0, Math.min(30, parseFloat(qs('#merma_pct')?.value||0)));
    const adicAdj  = adicRaw * (1 + mermaPct/100);
    const total    = directos + dep + adicAdj;

    qs('#vinil_pro_directos') && (qs('#vinil_pro_directos').textContent = fmtUSD(directos));
    qs('#vinil_pro_dep') && (qs('#vinil_pro_dep').textContent = fmtUSD(dep));
    qs('#vinil_pro_adic') && (qs('#vinil_pro_adic').textContent = fmtUSD(adicAdj));
    qs('#vinil_pro_merma') && (qs('#vinil_pro_merma').textContent = mermaPct.toFixed(0)+'%');
    qs('#vinil_pro_total') && (qs('#vinil_pro_total').textContent = fmtUSD(total));

    // Actualiza etiqueta inferior existente si la hay
    const totalFinal = document.getElementById('totalFinal');
    if(totalFinal){
      const span = totalFinal.querySelector('.result') || totalFinal;
      if(span) span.textContent = fmtUSD(total);
      if(totalFinal.textContent && totalFinal.textContent.indexOf('Total Vinil')===-1){
        totalFinal.innerHTML = 'Total Vinil: <span class="result">'+fmtUSD(total)+'</span>';
      }
    }
    anchoEfectivo();
    vin_gi_calc();
  }

  // --- Ganancia/Impuestos (Vinil) ---
  function vin_gi_calc(){
    const base = getNumText('#vinil_pro_total'); // total vinil ya con merma
    const chkG = qs('#vin_chk_ganancia')?.checked;
    const chkI = qs('#vin_chk_impuestos')?.checked;
    const pG = parseFloat(qs('#vin_ganancia')?.value||0) || 0;
    const pI = parseFloat(qs('#vin_impuestos')?.value||0) || 0;
    const g = chkG ? base * (pG/100) : 0;
    const i = chkI ? (base + g) * (pI/100) : 0;

    qs('#vin_subtotal_no_gi') && (qs('#vin_subtotal_no_gi').textContent = fmtUSD(base));
    qs('#vin_subtotal') && (qs('#vin_subtotal').textContent = fmtUSD(base));
    qs('#vin_ganancia_val') && (qs('#vin_ganancia_val').textContent = fmtUSD(g));
    qs('#vin_impuestos_val') && (qs('#vin_impuestos_val').textContent = fmtUSD(i));
    qs('#vin_total') && (qs('#vin_total').textContent = fmtUSD(base + g + i));
  }

  // Encadenar con actualizador original si expuesto globalmente
  if(window.vinil_actualizarTotal && !window._vinilProWrapped){
    const orig = window.vinil_actualizarTotal;
    window.vinil_actualizarTotal = function(){ orig(); adjustDebounced(); };
    window._vinilProWrapped = true;
  }

  // Listeners
  ['#vin_ganancia','#vin_impuestos','#vin_chk_ganancia','#vin_chk_impuestos'].forEach(function(sel){
    const el = qs(sel);
    if(el){
      el.addEventListener('input', vin_gi_calc, false);
      el.addEventListener('change', vin_gi_calc, false);
    }
  });

  qs('#merma_pct') && qs('#merma_pct').addEventListener('input', syncMerma);
  qs('#merma_range') && qs('#merma_range').addEventListener('input', syncMerma);
  qs('#borde_lado') && qs('#borde_lado').addEventListener('input', adjustDebounced);
  qs('#ancho_estandar') && qs('#ancho_estandar').addEventListener('input', adjustDebounced);

  ['#bloques','#vinil_costos_directos','#vinil_depreciacion'].forEach(sel=>{
    const el = qs(sel); if(!el) return;
    el.addEventListener('input', adjustDebounced, true);
    el.addEventListener('change', adjustDebounced, true);
  });

  const btnReset = qs('#btn_reset_vinil');
  if(btnReset && !btnReset._vinilPro){
    btnReset._vinilPro = true;
    btnReset.addEventListener('click', ()=>{
      if(qs('#merma_pct')) qs('#merma_pct').value = 0;
      if(qs('#merma_range')) qs('#merma_range').value = 0;
      if(qs('#borde_lado')) qs('#borde_lado').value = 1;
      setTimeout(adjustDebounced, 50);
    });
  }

  // Copy / Print helpers
  function copyText(t){
    if(navigator.clipboard && window.isSecureContext){
      navigator.clipboard.writeText(t).then(()=>alert('Copiado')).catch(()=>alert('No se pudo copiar'));
    }else{
      const ta=document.createElement('textarea'); ta.value=t; ta.style.position='fixed'; ta.style.left='-9999px';
      document.body.appendChild(ta); ta.focus(); ta.select();
      try{ document.execCommand('copy'); alert('Copiado'); }catch(e){ alert('No se pudo copiar');}
      document.body.removeChild(ta);
    }
  }
  qs('#vinil_pro_copy') && qs('#vinil_pro_copy').addEventListener('click', ()=>{
    const t = [
      'Resumen de Vinil',
      'Directos: '+(qs('#vinil_pro_directos')?.textContent||'-'),
      'Depreciación: '+(qs('#vinil_pro_dep')?.textContent||'-'),
      'Adicionales (aj.): '+(qs('#vinil_pro_adic')?.textContent||'-'),
      'Merma: '+(qs('#vinil_pro_merma')?.textContent||'-'),
      'Total Vinil: '+(qs('#vinil_pro_total')?.textContent||'-')
    ].join('\n');
    copyText(t);
  });
  qs('#vinil_pro_print') && qs('#vinil_pro_print').addEventListener('click', ()=>{ window.print(); });

  // Kickoff
  setTimeout(adjustDebounced, 0); setTimeout(vin_gi_calc, 10);
})();

</script>
<script>

// ===== DTF Layout Preview (configurable panel, auto-rotación, multipanel) =====
(function(){
  const $ = (id)=>document.getElementById(id);
  const parseNum = (v)=>{
    if(v==null) return 0;
    const t = String(v).replace(/[^\d\.\-]/g,'');
    const n = parseFloat(t); return isFinite(n)?n:0;
  };

  function collectDesigns(){
    const cont = $("dtf_bloques");
    const items = [];
    cont?.querySelectorAll('.card.md-12').forEach(card=>{
      const id = card.querySelector('[data-remove]')?.getAttribute('data-remove');
      const w = parseNum(document.getElementById('dtf_w'+id)?.value) || 0;
      const h = parseNum(document.getElementById('dtf_h'+id)?.value) || 0;
      const n = Math.max(0, Math.floor(parseNum(document.getElementById('dtf_n'+id)?.value) || 0));
      if(w>0 && h>0 && n>0){ items.push({w,h,n}); }
    });
    return items;
  }

  // Shelf packing multipanel con rotación opcional
  function packShelfMultipanel(items, panelW, panelH, sep, autorot){
    const list = [];
    items.forEach(it=>{ for(let i=0;i<it.n;i++) list.push({w:it.w, h:it.h}); });
    list.sort((a,b)=> Math.max(b.w,b.h) - Math.max(a.w,a.h));

    const panels = [];
    function packIntoNewPanel(){
      const placements = [];
      let x=0, y=0, rowH=0;
      for(const r of list){
        if(r._placed) continue;
        let w=r.w, h=r.h;

        if(autorot){
          if(w>panelW && h<=panelW){ const t=w; w=h; h=t; }
          // escoger orientación que deje menos desperdicio horizontal si ambas caben
          if(w<=panelW && h<=panelW){
            const waste0 = Math.max(0, panelW - (x===0 ? w : Math.min(w, Math.max(0, panelW-x))));
            const waste1 = Math.max(0, panelW - (x===0 ? h : Math.min(h, Math.max(0, panelW-x))));
            if(h<=panelW && waste1 < waste0){ const t=w; w=h; h=t; }
          }
        }
        if(w>panelW) continue;

        if(x===0){
          if(y + h > panelH + 1e-6) continue;
          placements.push({x:0,y,w,h}); r._placed=true;
          x = w + sep; rowH = Math.max(rowH, h);
        }else{
          if(x + w <= panelW + 1e-6){
            if(y + h > panelH + 1e-6) continue;
            placements.push({x,y,w,h}); r._placed=true;
            x += w + sep; rowH = Math.max(rowH, h);
          }else{
            y += rowH + sep;
            if(y + h > panelH + 1e-6) continue;
            placements.push({x:0,y,w,h}); r._placed=true;
            x = w + sep; rowH = h;
          }
        }
      }
      const usedH = placements.length ? (placements[placements.length-1].y + rowH) : 0;
      panels.push({placements, usedH});
    }

    let guard=0;
    while(list.some(it=>!it._placed) && guard<500){
      packIntoNewPanel(); guard++;
      if(panels[panels.length-1].placements.length===0) break;
    }

    const placedCount = list.filter(it=>it._placed).length;
    const total = list.length;
    return {panels, placedCount, total};
  }

  function drawLayout(canvas, panelW, panelH, panels, sep){
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const Wpx = canvas.width, Hpx = canvas.height;
    ctx.clearRect(0,0,Wpx,Hpx);

    const stackH = Math.max(panelH * Math.min(panels.length,3), panelH);
    const sx = Wpx / Math.max(panelW,1);
    const sy = Hpx / Math.max(stackH,1);
    const s = Math.min(sx, sy);

    ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,Wpx,Hpx);

    let offsetY = 0, idx=0;
    panels.slice(0,3).forEach((panel)=>{
      ctx.strokeStyle='#111'; ctx.lineWidth=2;
      ctx.strokeRect(0, offsetY, panelW*s, panelH*s);

      for(const p of panel.placements){
        const x=p.x*s, y=offsetY + p.y*s, w=p.w*s, h=p.h*s;
        const hue=(idx*47)%360;
        ctx.fillStyle=`hsl(${hue} 70% 70%)`; ctx.fillRect(x,y,w,h);
        ctx.strokeStyle='#333'; ctx.lineWidth=1; ctx.strokeRect(x,y,w,h);
        ctx.fillStyle='#111'; ctx.font='12px sans-serif'; ctx.fillText(`${p.w}×${p.h}`, x+4, y+14);
        idx++;
      }

      ctx.fillStyle='#6b7280'; ctx.font='12px sans-serif';
      ctx.fillText(panelW+' cm', (panelW*s)/2 - 18, offsetY + panelH*s - 6);
      ctx.save(); ctx.rotate(-Math.PI/2);
      ctx.fillText(panelH+' cm', - (offsetY + (panelH*s)/2 + 18), 12);
      ctx.restore();
      offsetY += (panelH*s) + 12;
    });
  }

  function generatePreview(){
    const items = collectDesigns();
    const sep = parseNum($("dtf_sep")?.value) || 0;
    const tipo = $("dtf_panel_tipo")?.value || "metro";
    let panelW = parseNum($("dtf_panel_w")?.value) || 57;
    let panelH = parseNum($("dtf_panel_h")?.value) || 100;
    if(tipo==="metro"){ panelW=57; panelH=100; }
    else if(tipo==="tramo30"){ panelW=57; panelH=30; }
    else if(tipo==="a3"){ panelW=29.7; panelH=42; }
    const autorot = $("dtf_autorot")?.checked;

    const res = packShelfMultipanel(items, panelW, panelH, sep, autorot);
    drawLayout($("dtf_layout"), panelW, panelH, res.panels, sep);

    const usados = res.panels.length; const placed = res.placedCount; const total = res.total;
    $("dtf_layout_info").textContent = `Paneles usados: ${usados} • Colocados: ${placed}/${total}`;

    // Sincroniza con la lógica de unidades cobradas / material a solicitar
    try{
      let e=0; items.forEach(it=> e += it.n);
      window.dtf_estampados_cache = e;
      const modalidad = document.getElementById("dtf_modalidad")?.value;
      if(modalidad === "a3"){
        document.getElementById("dtf_unidades").textContent = String(usados);
        document.getElementById("dtf_mat_solicitar").textContent = usados + " hoja(s) A3";
      }else{
        const altoTotal = panelH * usados; // cm totales
        const unidad = (modalidad==="metro") ? 100 : 30;
        const u = Math.ceil(altoTotal / unidad);
        document.getElementById("dtf_unidades").textContent = String(u);
        const metros = (unidad===100) ? (u) : (u*0.3);
        document.getElementById("dtf_mat_solicitar").textContent = (unidad===100 ? (metros+" m") : (u+" tramo(s) de 30 cm"));
        document.getElementById("dtf_largo_cm").value = String(altoTotal.toFixed(1));
      }
      const evt = new Event('input'); document.getElementById("dtf_largo_cm").dispatchEvent(evt);
    }catch(e){}
  }

  $("dtf_preview_btn")?.addEventListener('click', generatePreview);

  $("dtf_preset_demo")?.addEventListener('click', ()=>{
    const cont = $("dtf_bloques"); cont.innerHTML = "";
    function add(w,h,n){
      const e = document.createElement('div');
      e.className='card md-12';
      const id = (window.dtf_counter = (window.dtf_counter||0) + 1);
      e.innerHTML = `
        <div class="calc-block" id="dtf_block${id}" style="border:1px solid #eee;border-radius:12px;padding:12px;background:#fff">
          <div class="row" style="align-items:center;justify-content:space-between">
            <label style="margin:0">Diseño</label>
            <button class="copy-btn" data-remove="${id}">Eliminar</button>
          </div>
          <div class="row" style="gap:12px;flex-wrap:wrap">
            <div style="min-width:150px;flex:1">
              <label>Ancho (cm)</label>
              <input type="number" id="dtf_w${id}" step="0.1" min="0" value="${w}"/>
            </div>
            <div style="min-width:150px;flex:1">
              <label>Alto (cm)</label>
              <input type="number" id="dtf_h${id}" step="0.1" min="0" value="${h}"/>
            </div>
            <div style="min-width:150px;flex:1">
              <label>Cantidad</label>
              <input type="number" id="dtf_n${id}" step="1" min="1" value="${Math.max(1,n)}"/>
            </div>
          </div>
        </div>`;
      cont.appendChild(e);
    }
    add(15,15,20);
    $("dtf_sep").value="0.5";
    $("dtf_panel_tipo").value="metro";
    $("dtf_panel_w").value="57"; $("dtf_panel_h").value="100";
  });

  // Sincroniza selector de tipo con ancho/alto
  (function(){
    const sel = $("dtf_panel_tipo");
    sel?.addEventListener('change', ()=>{
      const t = sel.value;
      if(t==="metro"){ $("dtf_panel_w").value="57"; $("dtf_panel_h").value="100"; }
      else if(t==="tramo30"){ $("dtf_panel_w").value="57"; $("dtf_panel_h").value="30"; }
      else if(t==="a3"){ $("dtf_panel_w").value="29.7"; $("dtf_panel_h").value="42"; }
    });
  })();
})();

</script>
<script>

/* === DTF MODULE OVERLAY — scoped to #view-dtf (won't touch other modules) === */
(function(){
  const root = document.getElementById('view-dtf');
  if(!root) return;

  // ---------- helpers ----------
  const $  = (id)=> root.querySelector('#'+id);
  const $$ = (sel, ctx=root)=> Array.prototype.slice.call(ctx.querySelectorAll(sel));
  function parseEU(raw){
    if(raw==null) return 0;
    let v = String(raw).trim();
    v = v.replace(/[^\d,.\-]/g, '');
    if (v.includes('.') && v.includes(',')){ v = v.replace(/\./g,'').replace(',', '.'); }
    else if (v.includes(',')){ v = v.replace(',', '.'); }
    const n = parseFloat(v);
    return isFinite(n) ? n : 0;
  }
  const toUSD = (n)=> (n||0).toLocaleString('en-US', {style:'currency', currency:'USD', maximumFractionDigits: 2});

  // ---------- constants ----------
  const W_METRO=57, A3W=29.7, A3H=42;

  // ---------- cards ----------
  function cards(){ return $$('#dtf_bloques > .card.md-12'); }
  function ensureId(card){
    let id = card.getAttribute('data-id');
    if(id) return id;
    const rm = card.querySelector('[data-remove]');
    if(rm){ id = rm.getAttribute('data-remove'); card.setAttribute('data-id', id); return id; }
    const m = card.innerHTML.match(/id="dtf_(?:w|h|n|cost_ud|cost_total)(\d+)"/);
    if(m){ id = m[1]; card.setAttribute('data-id', id); return id; }
    id = String(($$('#dtf_bloques [data-id]').length||0) + 1);
    card.setAttribute('data-id', id);
    return id;
  }
  function renumber(){ cards().forEach((c,i)=>{ const lbl=c.querySelector('label'); if(lbl) lbl.textContent='Diseño '+(i+1); }); }
  function wireCard(card){
    const id = ensureId(card);
    ['dtf_w'+id,'dtf_h'+id,'dtf_n'+id].forEach(k=>{
      const el = card.querySelector('#'+k);
      if(!el) return;
      const c = el.cloneNode(true);
      el.parentNode.replaceChild(c, el);
      c.addEventListener('input', recompute);
    });
    const del = card.querySelector('[data-remove]');
    if(del){
      const c = del.cloneNode(true);
      del.parentNode.replaceChild(c, del);
      c.addEventListener('click', ()=>{ card.remove(); renumber(); recompute(); });
    }
    const cp = card.querySelector('[data-copy]');
    if(cp){
      const c = cp.cloneNode(true);
      cp.parentNode.replaceChild(c, cp);
      c.addEventListener('click', ()=>{
        const w=card.querySelector('#dtf_w'+id)?.value||'-';
        const h=card.querySelector('#dtf_h'+id)?.value||'-';
        const n=card.querySelector('#dtf_n'+id)?.value||'-';
        const cud=card.querySelector('#dtf_cost_ud'+id)?.textContent||'$0.00';
        const tot=card.querySelector('#dtf_cost_total'+id)?.textContent||'$0.00';
        const idx = cards().indexOf(card)+1;
        navigator.clipboard?.writeText(`Diseño ${idx}\nMedida: ${w}×${h} cm\nCantidad: ${n}\nDTF (ud): ${cud}\nTotal diseño (DTF): ${tot}`);
      });
    }
  }
  function addCard(){
    const cont = $('#dtf_bloques'); if(!cont) return;
    const id = String(($$('#dtf_bloques [data-id]').length||0)+1);
    const node = document.createElement('div');
    node.className='card md-12';
    node.setAttribute('data-id', id);
    node.innerHTML = `
      <div class="calc-block" id="dtf_block${id}" style="border:1px solid #eee;border-radius:12px;padding:12px;background:#fff">
        <div class="row" style="align-items:center;justify-content:space-between">
          <label style="margin:0">Diseño</label>
          <button type="button" class="copy-btn" data-remove="${id}">Eliminar</button>
        </div>
        <div class="row" style="gap:12px;flex-wrap:wrap">
          <div style="min-width:140px;flex:1">
            <label>Ancho (cm)</label>
            <input type="number" id="dtf_w${id}" step="0.1" min="0" value="10"/>
          </div>
          <div style="min-width:140px;flex:1">
            <label>Alto (cm)</label>
            <input type="number" id="dtf_h${id}" step="0.1" min="0" value="10"/>
          </div>
          <div style="min-width:140px;flex:1">
            <label>Cantidad</label>
            <input type="number" id="dtf_n${id}" step="1" min="1" value="1"/>
          </div>
        </div>
        <div class="row" style="gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px">
          <div class="pill">DTF (ud): <span class="result" id="dtf_cost_ud${id}">$0.00</span></div>
          <div class="pill">Total diseño (DTF): <span class="result" id="dtf_cost_total${id}">$0.00</span></div>
          <button type="button" class="copy-btn" data-copy="${id}">Copiar</button>
        </div>
      </div>`;
    cont.appendChild(node);
    wireCard(node);
    renumber();
    recompute();
  }

  // ---------- costos ----------
  const colsFor = (wPanel,wItem,sep)=> Math.max(1, Math.floor((wPanel+sep)/(wItem+sep)));
  const costMetroUD  = (w,h,sep,precio)=> ( (h+sep) / colsFor(W_METRO,w,sep) / 100 ) * precio;
  const costTramoUD  = (w,h,sep,precio)=> Math.max(1, Math.ceil( (h+sep)/colsFor(W_METRO,w,sep)/30 )) * precio;
  const costA3UD     = (w,h,sep,precio)=> { const c=colsFor(A3W,w,sep); const f=Math.max(1, Math.floor((A3H+sep)/(h+sep))); return precio/Math.max(1,c*f); };
  function bestUD(w,h,sep,precio,modalidad,autorot){
    const base = modalidad==='metro' ? costMetroUD(w,h,sep,precio)
               : modalidad==='tramo30' ? costTramoUD(w,h,sep,precio)
               : costA3UD(w,h,sep,precio);
    if(!autorot) return base;
    const rot  = modalidad==='metro' ? costMetroUD(h,w,sep,precio)
               : modalidad==='tramo30' ? costTramoUD(h,w,sep,precio)
               : costA3UD(h,w,sep,precio);
    return Math.min(base, rot);
  }

  function recompute(){
    const modalidad = $('#dtf_modalidad')?.value || 'metro';
    const precio    = parseEU($('#dtf_precio_unit')?.value);
    const sep       = parseEU($('#dtf_sep')?.value);
    const autorot   = !!$('#dtf_autorot')?.checked;

    let dtf_total=0, unidades=0;
    cards().forEach(card=>{
      const id = ensureId(card);
      const w = parseEU(card.querySelector('#dtf_w'+id)?.value);
      const h = parseEU(card.querySelector('#dtf_h'+id)?.value);
      const n = Math.max(0, Math.floor(parseEU(card.querySelector('#dtf_n'+id)?.value)));
      if(w>0 && h>0 && n>0 && precio>0){
        const cud = bestUD(w,h,sep,precio,modalidad,autorot);
        const el1 = card.querySelector('#dtf_cost_ud'+id);
        const el2 = card.querySelector('#dtf_cost_total'+id);
        if(el1) el1.textContent = toUSD(cud);
        if(el2) el2.textContent = toUSD(cud*n);
        dtf_total += cud*n; unidades += n;
      }else{
        const el1 = card.querySelector('#dtf_cost_ud'+id);
        const el2 = card.querySelector('#dtf_cost_total'+id);
        if(el1) el1.textContent = toUSD(0);
        if(el2) el2.textContent = toUSD(0);
      }
    });

    // prenda
    let prenda_ud=0, prenda_total=0;
    if($('#dtf_prenda_on')?.checked){
      const cant = Math.max(0, parseEU($('#dtf_prenda_cant')?.value));
      const pack = Math.max(0, parseEU($('#dtf_prenda_precio')?.value));
      if(cant>0) prenda_ud = pack/cant;
      const out = $('#dtf_prenda_costo_ud'); if(out) out.value = toUSD(prenda_ud);
      prenda_total = prenda_ud * unidades;
    }else{ const out=$('#dtf_prenda_costo_ud'); if(out) out.value = "$ 0,00"; }

    // depreciación plancha
    let dep_ud=0, dep_total=0;
    if($('#dtf_dep_on')?.checked){
      const p = parseEU($('#dtf_dep_plancha_precio')?.value);
      const vida = Math.max(1, parseEU($('#dtf_dep_plancha_vida')?.value));
      dep_ud = p/vida;
    }
    const depOut = $('#dtf_dep_plancha_ud'); if(depOut) depOut.value = toUSD(dep_ud);
    dep_total = dep_ud * unidades;

    // extras
    const extra_envio   = parseEU($('#dtf_extra_envio')?.value);
    const extra_diseno  = parseEU($('#dtf_extra_diseno')?.value);
    const extra_plancha = parseEU($('#dtf_extra_plancha')?.value) * unidades;
    const extra_otros   = parseEU($('#dtf_extra_otros')?.value);
    const extras_total  = extra_envio + extra_diseno + extra_plancha + extra_otros;

    const sinGI = dtf_total + prenda_total + dep_total + extras_total;
    const subtotal = sinGI;

    const gPct = ($('#dtf_chk_ganancia')?.checked ? parseEU($('#dtf_ganancia')?.value) : 0);
    const iPct = ($('#dtf_chk_impuestos')?.checked ? parseEU($('#dtf_impuestos')?.value) : 0);
    const gVal = subtotal * (gPct/100);
    const iVal = (subtotal + gVal) * (iPct/100);
    const total = subtotal + gVal + iVal;

    const set = (id,val)=>{ const el=$('#'+id); if(el) el.textContent = val; };
    set('dtf_unidades', String(unidades));
    set('dtf_total_directos', toUSD(dtf_total));
    set('dtf_total_prenda', toUSD(prenda_total));
    set('dtf_total_dep', toUSD(dep_total));
    set('dtf_total_extras', toUSD(extras_total));
    set('dtf_subtotal_no_gi', toUSD(sinGI));
    set('dtf_subtotal', toUSD(subtotal));
    set('dtf_ganancia_val', toUSD(gVal));
    set('dtf_impuestos_val', toUSD(iVal));
    set('dtf_total', toUSD(total));
    set('dtf_costo_ud_dtf', toUSD(unidades ? dtf_total/unidades : 0));
    set('dtf_costo_por_camiseta', toUSD(unidades ? (sinGI/unidades) : 0));

    // material solicitar aprox: usar preview packing
    const {panels, label} = generatePreview(true);
    if(panels){
      if(($('#dtf_panel_tipo')?.value||'metro')==='a3'){ set('dtf_mat_solicitar', `${panels.length} hoja(s) A3`); }
      else if(($('#dtf_panel_tipo')?.value||'metro')==='tramo30'){ set('dtf_mat_solicitar', `${panels.length} tramo(s) 57×30 cm`); }
      else{ // metro
        let totalCm=0;
        panels.forEach((p,i)=>{ totalCm += (i<panels.length-1)? 100 : Math.min(100, p.usedH); });
        set('dtf_mat_solicitar', `${(totalCm/100).toFixed(2)} m (aprox)`);
      }
    } else set('dtf_mat_solicitar','—');
  }

  // ---------- preview ----------
  function getPanelDims(){
    const tipo = $('#dtf_panel_tipo')?.value || 'metro';
    if(tipo==='metro') return {W:57,H:100,label:'57×100 cm'};
    if(tipo==='tramo30') return {W:57,H:30,label:'57×30 cm'};
    if(tipo==='a3') return {W:29.7,H:42,label:'29.7×42 cm'};
    return {W:Math.max(5,parseEU($('#dtf_panel_w')?.value)), H:Math.max(5,parseEU($('#dtf_panel_h')?.value)), label: `${parseEU($('#dtf_panel_w')?.value)}×${parseEU($('#dtf_panel_h')?.value)} cm`};
  }
  function collectRects(){
    const rs=[]; cards().forEach(card=>{ const id=ensureId(card); const w=parseEU(card.querySelector('#dtf_w'+id)?.value); const h=parseEU(card.querySelector('#dtf_h'+id)?.value); const n=Math.max(0, Math.floor(parseEU(card.querySelector('#dtf_n'+id)?.value))); for(let i=0;i<n;i++) rs.push({w,h}); });
    return rs;
  }
  function pack(rects, W, H, sep, autorot){
    const edge = sep/2;
    rects = rects.slice().sort((a,b)=>Math.max(b.w,b.h)-Math.max(a.w,a.h));
    const res=[]; let cur={placements:[], x:edge, y:edge, rowH:0};
    const fit=(o)=> (cur.x+o.w <= W-edge+1e-9) && (cur.y + Math.max(cur.rowH,o.h) <= H-edge+1e-9);
    const place=(o)=>{ cur.placements.push({x:cur.x,y:cur.y,w:o.w,h:o.h,rot:o.rot}); cur.x += o.w + sep; cur.rowH = Math.max(cur.rowH,o.h); };
    const newRow=()=>{ cur.x=edge; cur.y = cur.y + cur.rowH + sep; cur.rowH = 0; };
    const newPanel=()=>{ if(cur.placements.length) res.push(cur); cur={placements:[], x:edge, y:edge, rowH:0}; };

    rects.forEach(r=>{
      const opts = autorot ? [{w:r.w,h:r.h,rot:false},{w:r.h,h:r.w,rot:true}] : [{w:r.w,h:r.h,rot:false}];
      opts.sort((A,B)=>A.w-B.w);
      let ok=false;
      for(const o of opts){ if(fit(o)){ place(o); ok=true; break; } }
      if(!ok){ newRow(); for(const o of opts){ if(fit(o)){ place(o); ok=true; break; } } }
      if(!ok){ newPanel(); const o=opts.find(o=>o.w<=W-2*edge && o.h<=H-2*edge) || opts[0]; place(o); }
    });
    if(cur.placements.length) res.push(cur);
    return res.map(p=>({placements:p.placements, usedH: Math.min(H, p.y + p.rowH + edge)}));
  }
  function draw(panels, W, H){
    const canvas = $('#dtf_layout'); if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const PAD=12, GAP=16;
    const cols = Math.min(3, Math.max(1, Math.ceil(Math.sqrt(panels.length||1))));
    const rows = Math.ceil((panels.length||1)/cols);
    const w = PAD*2 + cols * ((W*(600 - (cols+1)*GAP)/cols)/W) + (cols-1)*GAP;
    const h = PAD*2 + rows * ((H*(600 - (cols+1)*GAP)/cols)/W) + (rows-1)*GAP;
    const availW = 600; const scale = (availW - (cols+1)*GAP) / cols / W;
    const pW = W*scale, pH = H*scale;
    canvas.width = Math.max(600, Math.ceil(w));
    canvas.height= Math.max(350, Math.ceil(h));
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.font='12px Poppins, Arial'; ctx.textBaseline='top';
    const color=(i)=>`hsl(${(i*37)%360} 70% 75%)`;
    for(let i=0;i<panels.length;i++){
      const row=Math.floor(i/cols), col=i%cols, ox=PAD + col*(pW+GAP), oy=PAD + row*(pH+GAP);
      ctx.strokeStyle='#333'; ctx.strokeRect(ox,oy,pW,pH);
      panels[i].placements.forEach((pl,j)=>{
        const x=ox+pl.x*scale, y=oy+pl.y*scale, w=pl.w*scale, h=pl.h*scale;
        ctx.fillStyle=color(j); ctx.fillRect(x,y,w,h);
        ctx.strokeStyle='#222'; ctx.strokeRect(x,y,w,h);
        ctx.fillStyle='#222'; ctx.fillText(`${Math.round(pl.w)}×${Math.round(pl.h)}`, x+3, y+3);
      });
    }
  }
  function generatePreview(silent){
    const sep = parseEU($('#dtf_sep')?.value);
    const autorot = !!$('#dtf_autorot')?.checked;
    const {W,H,label} = getPanelDims();
    const rects = collectRects();
    const panels = pack(rects, W, H, sep, autorot);
    draw(panels, W, H);
    if(!silent){ const info=$('#dtf_layout_info'); if(info) info.textContent = `Colocados: ${rects.length} • Paneles: ${panels.length} • Panel: ${label} • Sep: ${sep} cm`; }
    return {panels, label};
  }
  window.generatePreview = generatePreview;

  // ---------- bindings ----------
  function bind(){
    const add = $('#dtf_add_diseno'); if(add){ const c=add.cloneNode(true); add.parentNode.replaceChild(c,add); c.addEventListener('click', addCard); }
    const pv = $('#dtf_preview_btn'); if(pv){ const c=pv.cloneNode(true); pv.parentNode.replaceChild(c,pv); c.addEventListener('click', ()=>generatePreview(false)); }
    ['dtf_modalidad','dtf_precio_unit','dtf_sep','dtf_panel_tipo','dtf_panel_w','dtf_panel_h','dtf_autorot',
     'dtf_prenda_on','dtf_prenda_cant','dtf_prenda_precio','dtf_dep_on','dtf_dep_plancha_precio','dtf_dep_plancha_vida',
     'dtf_extra_envio','dtf_extra_diseno','dtf_extra_plancha','dtf_extra_otros',
     'dtf_chk_ganancia','dtf_ganancia','dtf_chk_impuestos','dtf_impuestos']
    .forEach(id=>{ const el=$('#'+id); if(el){ const c=el.cloneNode(true); el.parentNode.replaceChild(c,el); ['input','change'].forEach(ev=>c.addEventListener(ev, recompute)); }});

    // Wire existing cards
    cards().forEach(wireCard);
    renumber();
    recompute();
    generatePreview(false);
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind);
  else bind();
})();

</script>
<script>
// DTF duplicate block removed to avoid double-binding.
</script>
<script>
(function(){
  try{
    function hideVinilExtras(){
      var borde = document.getElementById('borde_lado');
      if(borde){
        try{ borde.value = '0'; borde.dispatchEvent(new Event('input',{bubbles:true})); }catch(e){}
        if(borde.previousElementSibling && borde.previousElementSibling.tagName==='LABEL'){
          borde.previousElementSibling.style.display='none';
        }
        borde.style.display='none';
      }
      var anchoEf = document.getElementById('ancho_efectivo');
      if(anchoEf && anchoEf.parentElement){
        anchoEf.parentElement.style.display='none';
      }
    }
    if(document.readyState==='loading'){
      document.addEventListener('DOMContentLoaded', hideVinilExtras, {once:true});
    }else{ hideVinilExtras(); }
  }catch(e){}
})();
</script>
<script>
(function(){
  function parseEU(v){
    if (v==null) return 0;
    if (typeof v==='number') return v;
    v = (''+v).trim();
    if (!v) return 0;
    v = v.replace(/[^0-9,.\-]/g,'');
    const lastComma = v.lastIndexOf(',');
    const lastDot = v.lastIndexOf('.');
    if (lastComma > lastDot) { v = v.replace(/\./g,'').replace(',','.'); } else { v = v.replace(/,/g,''); }
    const n = parseFloat(v);
    return isFinite(n) ? n : 0;
  }
  function toEU(n){
    const s = Number(n||0).toFixed(2);
    const parts = s.split('.');
    const intp = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return '$ ' + intp + ',' + parts[1];
  }

  function registerIndirectos(cfg){
    const on = document.getElementById(cfg.ids.on);
    if(!on) return;
    const unitInp = document.getElementById(cfg.ids.units);
    const outUd = document.getElementById(cfg.ids.outUd);
    const fields = cfg.fields.map(id=>document.getElementById(id)).filter(Boolean);
    const baseSubtotalEl = document.getElementById(cfg.ids.baseSubtotal);

    let muteObserver = false;
    let inRecalc = false;
    let debounceTimer = null;
    let lastNative = null; // baseline del subtotal del módulo (sin indirectos)

    function calcUd(){
      const units = Math.max(1, parseInt(unitInp.value||'0',10) || 0);
      const sumMensual = fields.reduce((a,inp)=> a + parseEU(inp.value), 0);
      const ud = sumMensual / units;
      outUd.textContent = toEU(on.checked ? ud : 0);
      return on.checked ? ud : 0;
    }

    function recalc(){
      if (inRecalc) return;
      inRecalc = true;
      try{
        if(!baseSubtotalEl) return;
        const extra = calcUd();
        const base0 = (lastNative==null)? parseEU(baseSubtotalEl.textContent) : lastNative;
        const desired = on.checked ? (base0 + extra) : base0;

        const currentVal = parseEU(baseSubtotalEl.textContent);
        const delta = Math.abs((desired||0) - currentVal);
        if (delta > 0.0005){
          muteObserver = true;
          baseSubtotalEl.textContent = toEU(desired);
          setTimeout(()=>{
            try{ baseSubtotalEl.dispatchEvent(new Event('input', {bubbles:true})); }catch(e){}
            muteObserver = false;
          }, 0);
        }
      } finally {
        inRecalc = false;
      }
    }

    [on, unitInp, ...fields].forEach(el=> el && el.addEventListener('input', recalc));

    if (baseSubtotalEl){
      const mo = new MutationObserver(()=>{
        if (muteObserver) return;
        // Si el cambio viene del módulo nativo, actualizamos siempre el baseline
        try { lastNative = parseEU(baseSubtotalEl.textContent); } catch(e){}
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(recalc, 16);
      });
      mo.observe(baseSubtotalEl, {characterData:true, subtree:true, childList:true});

      setTimeout(recalc, 50);
      setTimeout(recalc, 250);
    }
      on.addEventListener('change', recalc);

}

  })();
</script><script>
(function(){
  function bindCfg(prefix){
    var btn = document.getElementById(prefix + "_ind_cfg_btn");
    var panel = document.getElementById(prefix + "_ind_cfg");
    if(!btn || !panel) return;
    btn.addEventListener("click", function(){
      panel.style.display = (panel.style.display === "none" || panel.style.display === "") ? "block" : "none";
    });
  }
  ["sub_v15","vin","eti","emp"].forEach(bindCfg);
})();
</script><script>
// === Blindado: Costos indirectos (VINIL) — aislado del resto ===
(function(){
  const view = document.getElementById("view-vinil");
  if (!view) return;

  // Helpers EU
  function parseEU(v){
    if (v==null) return 0;
    if (typeof v==='number') return v;
    v = (''+v).trim();
    if (!v) return 0;
    v = v.replace(/[^0-9,.\-]/g,'');
    const lastComma = v.lastIndexOf(',');
    const lastDot = v.lastIndexOf('.');
    if (lastComma > lastDot) { v = v.replace(/\./g,'').replace(',', '.'); } else { v = v.replace(/,/g,''); }
    const n = parseFloat(v);
    return isFinite(n) ? n : 0;
  }
  function toEU(n){
    const s = Number(n||0).toFixed(2);
    const parts = s.split('.');
    const intp = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return '$ ' + intp + ',' + parts[1];
  }

  const ids = {
    on:'vin_ind_on',
    units:'vin_ind_units',
    outUd:'vin_ind_ud',
    baseSubtotal:'vin_subtotal_no_gi'
  };
  const fields = [
    'vin_ind_alquiler','vin_ind_internet','vin_ind_suscripciones',
    'vin_ind_transporte','vin_ind_electricidad','vin_ind_publicidad','vin_ind_otros'
  ];

  const on = document.getElementById(ids.on);
  if (!on) return;
  const unitInp = document.getElementById(ids.units);
  const outUd = document.getElementById(ids.outUd);
  const baseSubtotalEl = document.getElementById(ids.baseSubtotal); // solo lectura; no se modifica
  const flds = fields.map(id => document.getElementById(id)).filter(Boolean);

  function calcUd(){
    const units = Math.max(1, parseInt(unitInp.value||'0',10) || 0);
    const sumMensual = flds.reduce((a,inp)=> a + parseEU(inp.value), 0);
    const ud = units > 0 ? (sumMensual / units) : 0;
    outUd.textContent = toEU(on.checked ? ud : 0);
  }

  function recalc(){
    // Solo recalculamos el costo unitario de indirectos y lo pintamos en su pill.
    // El subtotal del módulo VINIL ya incorpora este valor por su propia lógica interna.
    calcUd();
  }

  [on, unitInp, ...flds].forEach(el => el && el.addEventListener('input', recalc));
  on.addEventListener('change', recalc);

  // Recalcular al iniciar para reflejar valores guardados
  setTimeout(recalc, 50);
  setTimeout(recalc, 250);
})();
</script><script>
// === Blindado: Costos indirectos (ETI) — aislado del resto ===
(function(){
  const view = document.getElementById("view-etiquetas");
  if (!view) return;

  function parseEU(v){
    if (v==null) return 0;
    if (typeof v==='number') return v;
    v = (''+v).trim();
    if (!v) return 0;
    v = v.replace(/[^0-9,.\-]/g,'');
    const lastComma = v.lastIndexOf(',');
    const lastDot = v.lastIndexOf('.');
    if (lastComma > lastDot) { v = v.replace(/\./g,'').replace(',','.'); } else { v = v.replace(/,/g,''); }
    const n = parseFloat(v);
    return isFinite(n) ? n : 0;
  }
  function toEU(n){
    const s = Number(n||0).toFixed(2);
    const parts = s.split('.');
    const intp = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return '$ ' + intp + ',' + parts[1];
  }

  const ids = {
    on:'eti_ind_on', units:'eti_ind_units', outUd:'eti_ind_ud', baseSubtotal:'eti_subtotal_no_gi', subEl:'eti_subtotal'
  };
  const fields = ['eti_ind_alquiler','eti_ind_internet','eti_ind_suscripciones','eti_ind_transporte','eti_ind_electricidad','eti_ind_publicidad','eti_ind_otros'];

  const on = document.getElementById(ids.on);
  if(!on) return;
  const unitInp = document.getElementById(ids.units);
  const outUd = document.getElementById(ids.outUd);
  const baseSubtotalEl = document.getElementById(ids.baseSubtotal);
  const subEl = document.getElementById(ids.subEl);
  const flds = fields.map(id=>document.getElementById(id)).filter(Boolean);

  let muteObserver = false;
  let inRecalc = false;
  let debounceTimer = null;
  let lastNative = null;

  function calcUd(){
    const units = Math.max(1, parseInt(unitInp.value||'0',10) || 0);
    const sumMensual = flds.reduce((a,inp)=> a + parseEU(inp.value), 0);
    const ud = sumMensual / units;
    outUd.textContent = toEU(on.checked ? ud : 0);
    return on.checked ? ud : 0;
  }

  function recalc(){
    if (inRecalc) return;
    inRecalc = true;
    try{
      if(!baseSubtotalEl) return;
      const extra = calcUd();
      const base0 = (lastNative==null)? parseEU(baseSubtotalEl.textContent) : lastNative;
      const desired = on.checked ? (base0 + extra) : base0;
      if (subEl) { try { subEl.textContent = toEU(desired); } catch(e){} }

      const currentVal = parseEU(baseSubtotalEl.textContent);
      const delta = Math.abs((desired||0) - currentVal);
      if (delta > 0.0005){
        muteObserver = true;
        baseSubtotalEl.textContent = toEU(desired);
        setTimeout(()=>{
          try{ baseSubtotalEl.dispatchEvent(new Event('input', {bubbles:true})); }catch(e){}
          muteObserver = false;
        }, 0);
      }
    } finally {
      inRecalc = false;
    }
  }

  [on, unitInp, ...flds].forEach(el=> el && el.addEventListener('input', recalc));
  on.addEventListener('change', recalc);

  if (baseSubtotalEl){
    const mo = new MutationObserver(()=>{
      if (muteObserver) return;
      try { lastNative = parseEU(baseSubtotalEl.textContent); } catch(e){}
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(recalc, 16);
    });
    mo.observe(baseSubtotalEl, {characterData:true, subtree:true, childList:true});
    setTimeout(recalc, 50);
    setTimeout(recalc, 250);
  }
})();
</script><script>
// === Blindado: Costos indirectos (EMP) — aislado del resto ===
(function(){
  const view = document.getElementById("view-empaques");
  if (!view) return;

  function parseEU(v){
    if (v==null) return 0;
    if (typeof v==='number') return v;
    v = (''+v).trim();
    if (!v) return 0;
    v = v.replace(/[^0-9,.\-]/g,'');
    const lastComma = v.lastIndexOf(',');
    const lastDot = v.lastIndexOf('.');
    if (lastComma > lastDot) { v = v.replace(/\./g,'').replace(',','.'); } else { v = v.replace(/,/g,''); }
    const n = parseFloat(v);
    return isFinite(n) ? n : 0;
  }
  function toEU(n){
    const s = Number(n||0).toFixed(2);
    const parts = s.split('.');
    const intp = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return '$ ' + intp + ',' + parts[1];
  }

  const ids = {
    on:'emp_ind_on', units:'emp_ind_units', outUd:'emp_ind_ud', baseSubtotal:'emp_subtotal_no_gi', subEl:'emp_subtotal'
  };
  const fields = ['emp_ind_alquiler','emp_ind_internet','emp_ind_suscripciones','emp_ind_transporte','emp_ind_electricidad','emp_ind_publicidad','emp_ind_otros'];

  const on = document.getElementById(ids.on);
  if(!on) return;
  const unitInp = document.getElementById(ids.units);
  const outUd = document.getElementById(ids.outUd);
  const baseSubtotalEl = document.getElementById(ids.baseSubtotal);
  const subEl = document.getElementById(ids.subEl);
  const flds = fields.map(id=>document.getElementById(id)).filter(Boolean);

  let muteObserver = false;
  let inRecalc = false;
  let debounceTimer = null;
  let lastNative = null;

  function calcUd(){
    const units = Math.max(1, parseInt(unitInp.value||'0',10) || 0);
    const sumMensual = flds.reduce((a,inp)=> a + parseEU(inp.value), 0);
    const ud = sumMensual / units;
    outUd.textContent = toEU(on.checked ? ud : 0);
    return on.checked ? ud : 0;
  }

  function recalc(){
    if (inRecalc) return;
    inRecalc = true;
    try{
      if(!baseSubtotalEl) return;
      const extra = calcUd();
      const base0 = (lastNative==null)? parseEU(baseSubtotalEl.textContent) : lastNative;
      const desired = on.checked ? (base0 + extra) : base0;
      if (subEl) { try { subEl.textContent = toEU(desired); } catch(e){} }

      const currentVal = parseEU(baseSubtotalEl.textContent);
      const delta = Math.abs((desired||0) - currentVal);
      if (delta > 0.0005){
        muteObserver = true;
        baseSubtotalEl.textContent = toEU(desired);
        setTimeout(()=>{
          try{ baseSubtotalEl.dispatchEvent(new Event('input', {bubbles:true})); }catch(e){}
          muteObserver = false;
        }, 0);
      }
    } finally {
      inRecalc = false;
    }
  }

  [on, unitInp, ...flds].forEach(el=> el && el.addEventListener('input', recalc));
  on.addEventListener('change', recalc);

  if (baseSubtotalEl){
    const mo = new MutationObserver(()=>{
      if (muteObserver) return;
      try { lastNative = parseEU(baseSubtotalEl.textContent); } catch(e){}
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(recalc, 16);
    });
    mo.observe(baseSubtotalEl, {characterData:true, subtree:true, childList:true});
    setTimeout(recalc, 50);
    setTimeout(recalc, 250);
  }
})();
</script><script>
// === Blindado: Costos indirectos (SUBLIMACIÓN) — controla Subtotal, G/I y Total ===
(function(){
  const view = document.getElementById("view-sublimacion");
  if (!view) return;

  function $(id){ return document.getElementById(id); }
  function parseEU(v){
    if (v==null) return 0;
    if (typeof v==='number') return v;
    v = (''+v).trim();
    if (!v) return 0;
    v = v.replace(/[^0-9,.\-]/g,'');
    const lastComma = v.lastIndexOf(',');
    const lastDot = v.lastIndexOf('.');
    if (lastComma > lastDot) { v = v.replace(/\./g,'').replace(',','.'); } else { v = v.replace(/,/g,''); }
    const n = parseFloat(v);
    return isFinite(n) ? n : 0;
  }
  function toEU(n){
    const s = Number(n||0).toFixed(2);
    const parts = s.split('.');
    const intp = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return '$ ' + intp + ',' + parts[1];
  }

  const ids = {
    on:'sub_v15_ind_on', units:'sub_v15_ind_units', outUd:'sub_v15_ind_ud', baseSubtotal:'sub_v15_subtotal_no_gi',
    // GI + Subtotal + Total
    chkG:'sub_v15_chk_ganancia', valG:'sub_v15_ganancia',
    chkI:'sub_v15_chk_impuestos', valI:'sub_v15_impuestos',
    subEl:'sub_v15_subtotal', gPill:'sub_v15_ganancia_val', iPill:'sub_v15_impuestos_val', totalEl:'sub_v15_total',
    // Mano de obra
    moOn:'sub_v15_mo_on', moSueldo:'sub_v15_mo_sueldo', moHoras:'sub_v15_mo_horas_mes',
    moSetup:'sub_v15_mo_setup', moRun:'sub_v15_mo_run', moUnits:'sub_v15_mo_units', moPill:'sub_v15_mo_pill', moVal:'sub_v15_mo_val'
  };
  const fields = ['sub_v15_ind_alquiler','sub_v15_ind_internet','sub_v15_ind_suscripciones','sub_v15_ind_transporte','sub_v15_ind_electricidad','sub_v15_ind_publicidad','sub_v15_ind_otros'];

  const on = $(ids.on);
  if(!on) return;
  const unitInp = $(ids.units);
  const outUd = $(ids.outUd);
  const baseSubtotalEl = $(ids.baseSubtotal);
  const flds = fields.map(function(id){ return $(id); }).filter(Boolean);

  const chkG = $(ids.chkG), valG = $(ids.valG);
  const chkI = $(ids.chkI), valI = $(ids.valI);
  const subEl = $(ids.subEl), gP = $(ids.gPill), iP = $(ids.iPill), tot = $(ids.totalEl);
  const moOn = $(ids.moOn), moS = $(ids.moSueldo), moH = $(ids.moHoras), moSet = $(ids.moSetup), moRun = $(ids.moRun), moU = $(ids.moUnits), moP = $(ids.moPill), moV = $(ids.moVal);

  let muteObserver = false;
  let inRecalc = false;
  let debounceTimer = null;
  let lastNative = null;

  function calcUd(){
    const units = Math.max(1, parseInt(unitInp.value||'0',10) || 0);
    const sumMensual = flds.reduce((a,inp)=> a + parseEU(inp.value), 0);
    const ud = sumMensual / units;
    outUd.textContent = toEU(on.checked ? ud : 0);
    return on.checked ? ud : 0;
  }

  function manoObraVal(){
    if (!moOn || !moOn.checked) return 0;
    const sueldo = parseEU(moS.value);
    const horas  = Math.max(1, parseEU(moH.value));
    const setupM = parseEU(moSet.value);
    const runM   = parseEU(moRun.value);
    const units  = Math.max(1, parseEU(moU.value));
    const valorHora = sueldo / horas;
    const costoMin = valorHora / 60.0;
    const totalMO = (setupM * costoMin + runM * costoMin) / units;
    if (moP) moP.style.display = "inline-flex";
    if (moV) moV.textContent = toEU(totalMO);
    return totalMO;
  }

  function recalc(){
    if (inRecalc) return;
    inRecalc = true;
    try{
      if(!baseSubtotalEl) return;
      const extra = calcUd();
      const currentVal = parseEU(baseSubtotalEl.textContent);
      let dEl = document.getElementById('sub_v15_total_directos');
      let depEl = document.getElementById('sub_v15_total_depr');
      let directos = dEl ? parseEU(dEl.textContent) : 0;
      let deprec  = depEl ? parseEU(depEl.textContent) : 0;
      let base0 = directos + deprec;
      if (base0 < 0) base0 = 0;
      lastNative = base0;
      lastNative = base0;
      let subtotalAdj = on.checked ? (base0 + extra) : base0;
      if (subtotalAdj < 0) subtotalAdj = 0;

      // Actualizar subtotal visible y GI/Total aquí mismo (para no depender del recalc nativo)
      if (subEl) subEl.textContent = toEU(subtotalAdj);

      const gPct = (chkG && chkG.checked) ? (parseEU(valG.value)/100) : 0;
      const gVal = subtotalAdj * gPct;
      const iPct = (chkI && chkI.checked) ? (parseEU(valI.value)/100) : 0;
      const iVal = (subtotalAdj + gVal) * iPct;
      if (gP) gP.textContent = toEU(gVal);
      if (iP) iP.textContent = toEU(iVal);

      const mo = manoObraVal();
      if (tot) tot.textContent = toEU(subtotalAdj + gVal + iVal + mo);

      // Mantener sincronizado el label de "Total sin G/I"
      if (!muteObserver){
        muteObserver = true;
        baseSubtotalEl.textContent = toEU(subtotalAdj);
        setTimeout(()=>{ muteObserver = false; }, 0);
      }
    } finally {
      inRecalc = false;
    }
  }

  [on, unitInp, chkG, valG, chkI, valI, moOn, moS, moH, moSet, moRun, moU, ...flds].forEach(el=> el && el.addEventListener('input', recalc));
  if (on) on.addEventListener('change', recalc);

  if (baseSubtotalEl){
    const mo = new MutationObserver(()=>{
      if (muteObserver) return;
      try {
        const extraNow = calcUd();
        const curr = parseEU(baseSubtotalEl.textContent);
        if (!on.checked) { lastNative = curr; }
      } catch(e){}
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(recalc, 16);
    });
    mo.observe(baseSubtotalEl, {characterData:true, subtree:true, childList:true});
    setTimeout(recalc, 50);
    setTimeout(recalc, 250);
  }
})();
</script><script>
(function(){var b=document.getElementById("dtf_ind_cfg_btn");var p=document.getElementById("dtf_ind_cfg"); if(b&&p){b.addEventListener('click',function(){p.style.display=(p.style.display==='none'||!p.style.display)?'block':'none';});}})();
</script>
<script>
// === Blindado: Costos indirectos (DTF) ===
(function(){
  const $ = id => document.getElementById(id);
  const view = document.getElementById("view-dtf");
  if (!view) return;

  function parseEU(v){
    if (v==null) return 0;
    if (typeof v==='number') return v;
    v = (''+v).trim();
    if (!v) return 0;
    v = v.replace(/[^0-9,.\-]/g,'');
    const lastComma = v.lastIndexOf(',');
    const lastDot = v.lastIndexOf('.');
    if (lastComma > lastDot) { v = v.replace(/\./g,'').replace(',','.'); } else { v = v.replace(/,/g,''); }
    const n = parseFloat(v);
    return isFinite(n) ? n : 0;
  }
  function toEU(n){
    const s = Number(n||0).toFixed(2);
    const parts = s.split('.');
    const intp = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return '$ ' + intp + ',' + parts[1];
  }

  const ids = {
    on:'dtf_ind_on', units:'dtf_ind_units', outUd:'dtf_ind_ud', baseNoGi:'dtf_subtotal_no_gi',
    spanSub:'dtf_subtotal', spanG:'dtf_ganancia_val', spanI:'dtf_impuestos_val', spanTot:'dtf_total',
    chkG:'dtf_chk_ganancia', valG:'dtf_ganancia', chkI:'dtf_chk_impuestos', valI:'dtf_impuestos'
  };
  const on = $(ids.on);
  if (!on) return;

  const unitInp = $(ids.units);
  const outUd = $(ids.outUd);
  const baseNoGiEl = $(ids.baseNoGi);
  const spanSub = $(ids.spanSub), spanG = $(ids.spanG), spanI = $(ids.spanI), spanTot = $(ids.spanTot);
  const chkG = $(ids.chkG), valG = $(ids.valG), chkI = $(ids.chkI), valI = $(ids.valI);

  const fields = ['alquiler','internet','suscripciones','transporte','electricidad','publicidad','otros'].map(k => $('dtf_ind_'+k)).filter(Boolean);

  function costoUd(){
    const units = Math.max(1, parseInt(unitInp?.value||'0',10) || 0);
    const suma = fields.reduce((a,inp) => a + parseEU(inp.value), 0);
    const ud = suma / units;
    if (outUd) outUd.textContent = toEU(on.checked ? ud : 0);
    return on.checked ? ud : 0;
  }

  let inRecalc = false, debounceTimer = null, mute = false;

  function recalc(){
    if (inRecalc) return; inRecalc = true;
    try{
      const extra = costoUd();
      const base = parseEU(baseNoGiEl?.textContent||'0');
      const subtotal_no_gi = Math.max(0, base + extra);
      // reflejar
      if (baseNoGiEl){
        mute = true;
        baseNoGiEl.textContent = toEU(subtotal_no_gi);
        setTimeout(()=>{ try{ baseNoGiEl.dispatchEvent(new Event('input',{bubbles:true})); }catch(e){} mute=false; }, 0);
      }
      // calcular G/I y total igual que UI nativa
      const gPct = (chkG && chkG.checked) ? (parseEU(valG.value)/100) : 0;
      const iPct = (chkI && chkI.checked) ? (parseEU(valI.value)/100) : 0;
      const valGNum = subtotal_no_gi * gPct;
      const valINum = (subtotal_no_gi + valGNum) * iPct;
      if (spanSub) spanSub.textContent = toEU(subtotal_no_gi);
      if (spanG) spanG.textContent = toEU(valGNum);
      if (spanI) spanI.textContent = toEU(valINum);
      if (spanTot) spanTot.textContent = toEU(subtotal_no_gi + valGNum + valINum);
    } finally { inRecalc = false; }
  }

  // eventos
  [on, unitInp, ...fields].forEach(el => el && el.addEventListener('input', recalc));
  if (on) on.addEventListener('change', recalc);
  if (chkG) chkG.addEventListener('change', recalc);
  if (chkI) chkI.addEventListener('change', recalc);
  if (valG) valG.addEventListener('input', recalc);
  if (valI) valI.addEventListener('input', recalc);

  if (baseNoGiEl){
    const mo = new MutationObserver(()=>{ if(mute) return; clearTimeout(debounceTimer); debounceTimer=setTimeout(recalc,16); });
    mo.observe(baseNoGiEl, {characterData:true,childList:true,subtree:true});
    setTimeout(recalc,50); setTimeout(recalc,250);
  }
})();
</script>
<style id="dark-fix-vinil-dtf-like-sublimacion">
/* === Dark mode fix: Vinil + DTF con el mismo look que Sublimación (solo CSS) === */
body.dark #view-vinil .card,
body.dark #view-dtf .card{
  background:#151924 !important;           /* mismo que Sublimación */
  color:#e5e7eb !important;
  border:1px solid #23283a !important;
  box-shadow:none !important;
}
body.dark #view-vinil .sep,
body.dark #view-dtf .sep{
  border-color:#23283a !important;
  opacity:.9;
}

/* inputs & selects */
body.dark #view-vinil input[type="text"],
body.dark #view-vinil input[type="number"],
body.dark #view-vinil select,
body.dark #view-dtf  input[type="text"],
body.dark #view-dtf  input[type="number"],
body.dark #view-dtf  select{
  background:#0f1115 !important;
  color:#e5e7eb !important;
  border-color:#2a3147 !important;
}
body.dark #view-vinil input:focus, body.dark #view-vinil select:focus,
body.dark #view-dtf  input:focus, body.dark #view-dtf  select:focus{
  outline:none;
  box-shadow:0 0 0 2px #3b82f6 !important;  /* foco azul */
  border-color:#3b82f6 !important;
}

/* pills y chips */
body.dark #view-vinil .pill, body.dark #view-vinil .chip,
body.dark #view-dtf  .pill, body.dark #view-dtf  .chip{
  background:#1b2030 !important;
  border-color:#2a3147 !important;
  color:#e5e7eb !important;
}
body.dark #view-vinil .pill .result, body.dark #view-vinil .chip .result,
body.dark #view-dtf  .pill .result, body.dark #view-dtf  .chip .result{
  background:#23283a !important;
  color:#e5e7eb !important;
}

/* botones */
body.dark #view-vinil .btn, body.dark #view-dtf .btn{
  background:#2563eb !important;
  color:#fff !important;
  border-color:#2563eb !important;
}
</style>
<style id="dark-vinil-below-merma">
/* ===== Dark mode Vinil: seccion inferior (no tocar Merma) ===== */
body.dark #view-vinil #vinil_costos_directos.card,
body.dark #view-vinil #vinil_depreciacion.card,
body.dark #view-vinil #vinil_summary.card,
body.dark #view-vinil #vin_ind_card.card,
body.dark #view-vinil #vinil_gi_card.card{
  background:#151924 !important;
  color:#e5e7eb !important;
  border:1px solid #23283a !important;
  box-shadow:none !important;
}

/* separadores */
body.dark #view-vinil #vinil_costos_directos .sep,
body.dark #view-vinil #vinil_depreciacion .sep,
body.dark #view-vinil #vinil_summary .sep,
body.dark #view-vinil #vin_ind_card .sep,
body.dark #view-vinil #vinil_gi_card .sep{
  background:#23283a !important;
  opacity:.9;
}

/* labels y textos secundarios */
body.dark #view-vinil #vinil_costos_directos label,
body.dark #view-vinil #vinil_depreciacion label,
body.dark #view-vinil #vinil_summary label,
body.dark #view-vinil #vin_ind_card label,
body.dark #view-vinil #vinil_gi_card label,
body.dark #view-vinil #vinil_costos_directos .muted,
body.dark #view-vinil #vinil_depreciacion .muted,
body.dark #view-vinil #vinil_summary .muted,
body.dark #view-vinil #vin_ind_card .muted,
body.dark #view-vinil #vinil_gi_card .muted{
  color:#94a3b8 !important;
}

/* inputs y selects */
body.dark #view-vinil #vinil_costos_directos input[type="text"],
body.dark #view-vinil #vinil_costos_directos input[type="number"],
body.dark #view-vinil #vinil_costos_directos select,
body.dark #view-vinil #vinil_depreciacion input[type="text"],
body.dark #view-vinil #vinil_depreciacion input[type="number"],
body.dark #view-vinil #vinil_depreciacion select,
body.dark #view-vinil #vinil_gi_card input[type="text"],
body.dark #view-vinil #vinil_gi_card input[type="number"],
body.dark #view-vinil #vinil_gi_card select,
body.dark #view-vinil #vin_ind_card input[type="text"],
body.dark #view-vinil #vin_ind_card input[type="number"],
body.dark #view-vinil #vin_ind_card select{
  background:#0f1115 !important;
  color:#e5e7eb !important;
  border-color:#2a3147 !important;
}
body.dark #view-vinil #vinil_costos_directos input:focus,
body.dark #view-vinil #vinil_costos_directos select:focus,
body.dark #view-vinil #vinil_depreciacion input:focus,
body.dark #view-vinil #vinil_depreciacion select:focus,
body.dark #view-vinil #vinil_gi_card input:focus,
body.dark #view-vinil #vinil_gi_card select:focus,
body.dark #view-vinil #vin_ind_card input:focus,
body.dark #view-vinil #vin_ind_card select:focus{
  outline:none; box-shadow:0 0 0 2px #3b82f6 !important; border-color:#3b82f6 !important;
}

/* pills y chips */
body.dark #view-vinil #vinil_costos_directos .pill,
body.dark #view-vinil #vinil_depreciacion .pill,
body.dark #view-vinil #vinil_summary .pill,
body.dark #view-vinil #vin_ind_card .pill,
body.dark #view-vinil #vinil_gi_card .pill{
  background:#1b2030 !important; border-color:#2a3147 !important; color:#e5e7eb !important;
}
body.dark #view-vinil #vinil_costos_directos .pill .result,
body.dark #view-vinil #vinil_depreciacion .pill .result,
body.dark #view-vinil #vinil_summary .pill .result,
body.dark #view-vinil #vin_ind_card .pill .result,
body.dark #view-vinil #vinil_gi_card .pill .result{
  background:#23283a !important; color:#e5e7eb !important; padding:2px 6px; border-radius:999px;
}

/* botones (primarios, copiar, configurar) */
body.dark #view-vinil #vinil_costos_directos .btn,
body.dark #view-vinil #vinil_depreciacion .btn,
body.dark #view-vinil #vinil_summary .btn,
body.dark #view-vinil #vin_ind_card .btn,
body.dark #view-vinil #vinil_gi_card .btn{
  background:#2563eb !important; color:#fff !important; border-color:#2563eb !important;
}
body.dark #view-vinil #vinil_summary .copy-btn,
body.dark #view-vinil #vinil_gi_card .copy-btn{
  background:#1b2030 !important; color:#e5e7eb !important;
}

/* títulos ligeramente más claros */
body.dark #view-vinil #vinil_costos_directos h3,
body.dark #view-vinil #vinil_depreciacion h3,
body.dark #view-vinil #vinil_summary h3,
body.dark #view-vinil #vin_ind_card h4,
body.dark #view-vinil #vinil_gi_card h4{
  color:#f3f4f6 !important;
}
</style>
<style id="vinil-depreciacion-dark-like-sublimacion">
/* === VINIL – Depreciación: modo oscuro igual a Sublimación (CSS-only) === */
body.dark #view-vinil #vinil_depreciacion.card{
  background: #0f1522 !important;
  border: 1px solid #1f2536 !important;
  border-radius: 14px !important;
  color: #e7ecf6 !important;
}

/* Labels y textos secundarios dentro de la tarjeta */
body.dark #view-vinil #vinil_depreciacion.card label,
body.dark #view-vinil #vinil_depreciacion.card .muted{
  color: #9fb0c6 !important;
}

/* Inputs base (Precio, Vida útil, etc.) */
body.dark #view-vinil #vinil_depreciacion.card input[type="text"]{
  background: #0f1115 !important;
  color: #e7ecf6 !important;
  border: 1px solid #2a3147 !important;
  border-radius: 12px !important;
}

/* Foco azul, igual que Sublimación */
body.dark #view-vinil #vinil_depreciacion.card input[type="text"]:focus{
  outline: none !important;
  box-shadow: 0 0 0 2px #3b82f6 !important;
  border-color: #3b82f6 !important;
}

/* Rosado para 'costo x Mes' y 'Costo Ud.' (como Sublimación) */
body.dark #view-vinil #vinil_depreciacion.card input.dep_mes,
body.dark #view-vinil #vinil_depreciacion.card input.dep_ud{
  background: #5e3c49 !important;
  color: #ffffff !important;
  border-color: #5e3c49 !important;
  border-radius: 12px !important;
}

/* Mantener rosado aunque sean de solo lectura */
body.dark #view-vinil #vinil_depreciacion.card input.dep_mes[readonly],
body.dark #view-vinil #vinil_depreciacion.card input.dep_ud[readonly]{
  opacity: 1 !important;
}
</style>
<style id="vinil-depreciacion-dark-hotfix">
/* HOTFIX — Limitar cambios SOLO a 'costo x Mes' y 'Costo Ud.' en Vinil/Depreciación */
body.dark #view-vinil #vinil_depreciacion.card input.dep_mes,
body.dark #view-vinil #vinil_depreciacion.card input.dep_ud{
  background:#5e3c49 !important;
  color:#ffffff !important;
  border-color:#5e3c49 !important;
  border-radius:12px !important;
}

/* Neutral para el resto de inputs de esa tarjeta (por si quedaron rosados/contrastados) */
body.dark #view-vinil #vinil_depreciacion.card input[type="text"]:not(.dep_mes):not(.dep_ud){
  background:#0f1115 !important;
  color:#e7ecf6 !important;
  border:1px solid #2a3147 !important;
  border-radius:12px !important;
  box-shadow:none !important;
}
/* Focus azul solo cuando no son dep_mes/dep_ud (los rosados no necesitan foco) */
body.dark #view-vinil #vinil_depreciacion.card input[type="text"]:not(.dep_mes):not(.dep_ud):focus{
  outline:none !important;
  box-shadow:0 0 0 2px #3b82f6 !important;
  border-color:#3b82f6 !important;
}
</style>
<style id="vinil-color-card-dark-restore">
/* === Restaurar card de Color (Vinil) en modo oscuro, sin tocar lógica === */
body.dark #view-vinil .calc-block{
  background:#151924 !important;
  border:1px solid #23283a !important;
  border-radius:12px !important;
}
body.dark #view-vinil .calc-block label{ color:#9fb0c6 !important; }
body.dark #view-vinil .calc-block select{
  background:#0f1115 !important;
  color:#e5e7eb !important;
  border-color:#2a3147 !important;
  border-radius:10px !important;
}
body.dark #view-vinil .calc-block input[type="text"],
body.dark #view-vinil .calc-block input[type="number"]{
  background:#0f1115 !important;
  color:#e5e7eb !important;
  border:1px solid #2a3147 !important;
  border-radius:10px !important;
}
body.dark #view-vinil .calc-block input:focus,
body.dark #view-vinil .calc-block select:focus{
  outline:none !important;
  box-shadow:0 0 0 2px #3b82f6 !important;
  border-color:#3b82f6 !important;
}
/* Texto 'Costo: $ 0,00' y botón Copiar */
body.dark #view-vinil .calc-block [id^="resultado"]{ color:#cbd5e1 !important; }
body.dark #view-vinil .calc-block .copy-btn{
  background:#2563eb !important; color:#fff !important; border-color:#2563eb !important;
  border-radius:10px !important;
}
/* Botón eliminar del bloque */
body.dark #view-vinil .calc-block .copy-btn[data-remove]{
  background:#ef4444 !important; border-color:#ef4444 !important;
}
</style>
<script>
(function(){
  const root = document.getElementById('view-dtf') || document.querySelector('[id*="view-dtf"]');
  if(!root) return;
  const optMetro = root.querySelector('option[value="metro"]');
  const sel = optMetro ? optMetro.closest('select') : root.querySelector('select');
  if(!sel) return;

  // Try to find the "Precio por unidad ($)" input inside the same card/row
  function findPriceInput(){
    // Look for a label that mentions "Precio por unidad"
    const lbl = Array.from(root.querySelectorAll('label')).find(l => /precio\s*por\s*unidad/i.test(l.textContent));
    if(lbl){
      const container = lbl.parentElement;
      const inp = container.querySelector('input');
      if(inp) return inp;
    }
    // Fallback: the first input after the select
    let el = sel;
    for(let i=0;i<8;i++){
      el = el && el.nextElementSibling;
      if(el){
        const inp = el.querySelector && el.querySelector('input');
        if(inp) return inp;
        if(el.tagName === 'INPUT') return el;
      }
    }
    return null;
  }

  const priceInput = findPriceInput();
  if(!priceInput) return;

  function applyRef(){
    const opt = sel.options[sel.selectedIndex];
    const ref = parseFloat(opt && opt.dataset && opt.dataset.price);
    if(!isFinite(ref)) return;
    priceInput.placeholder = ref;
    // Autocompletar solo si el usuario no escribió aún o si fue autofill previo
    const v = (priceInput.value || '').trim();
    priceInput.value = String(ref);
    priceInput.dataset.autofill = '1';
  }

  sel.addEventListener('change', applyRef);
  priceInput.addEventListener('input', () => { priceInput.dataset.autofill = '0'; });
  // Inicial
  applyRef();
})();
</script>
<script>
(function(){
  function toNumEUUS(v){
    if(typeof v === 'number') return v;
    if(!v) return 0;
    v = String(v).replace(/[^0-9,.-]/g,'');
    // if contains comma but no dot, treat comma as decimal
    if (v.indexOf(',')>=0 && v.indexOf('.')<0){ v = v.replace(',', '.'); }
    else { v = v.replace(/,/g,''); }
    var n = parseFloat(v);
    return isFinite(n)? n : 0;
  }
  function fmtLocal(n){
    try { return (typeof fmtUSD==='function') ? fmtUSD(n) : ('$ ' + (Number(n||0)).toFixed(2)); }
    catch(e){ return '$ ' + (Number(n||0)).toFixed(2); }
  }
  function updFunda(){
    var q = toNumEUUS(document.getElementById('d_funda_cant')?.value);
    var p = toNumEUUS(document.getElementById('d_funda_precio')?.value);
    var ud = (q>0) ? (p/q) : 0;
    var el = document.getElementById('d_funda_ud'); if(el) el.value = fmtLocal(ud);
    try{ if(window.sub_update) window.sub_update(); }catch(e){}
  }
  function updHorno(){
    var p = toNumEUUS(document.getElementById('e_horno_precio')?.value);
    var mes = p/24;
    var ud  = mes/100;
    var mEl = document.getElementById('e_horno_mes'); if(mEl) mEl.value = fmtLocal(mes);
    var uEl = document.getElementById('e_horno_ud');  if(uEl) uEl.value  = fmtLocal(ud);
    try{ if(window.sub_update) window.sub_update(); }catch(e){}
  }
  ['d_funda_cant','d_funda_precio','d_funda_on'].forEach(function(id){
    var el = document.getElementById(id); if(!el) return;
    el.addEventListener('input', updFunda); el.addEventListener('change', updFunda);
  });
  ['e_horno_precio','e_horno_on'].forEach(function(id){
    var el = document.getElementById(id); if(!el) return;
    el.addEventListener('input', updHorno); el.addEventListener('change', updHorno);
  });
  // run once on load
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', function(){ updFunda(); updHorno();}); }
  else { updFunda(); updHorno(); }
})();
</script>
<!-- SUBLIMACIÓN V19 PATCH: totales, checkboxes y formato UE -->
<script id="sub_patch_v19_fix" type="text/javascript">
(function(){
  const $ = (sel)=>document.querySelector(sel);
  const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
  const fmtEU = (n)=>{
    if (!isFinite(n)) n = 0;
    const s = n.toFixed(2);
    const [intp, dec] = s.split(".");
    const intEU = intp.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return "$ " + intEU + "," + dec;
  };
  const parseEU = (v)=>{
    if (typeof v !== "string") return (isFinite(v)?Number(v):0);
    v = v.trim();
    if (!v) return 0;
    // Accept "$ 1.234,56", "1.234,56", "1234.56", "1,234.56"
    v = v.replace(/[^\d,.\-]/g,"");         // keep digits , . -
    // If both comma and dot exist, assume EU "1.234,56" or US "1,234.56":
    const hasComma = v.includes(",");
    const hasDot = v.includes(".");
    if (hasComma && hasDot){
      // If comma is after dot => likely EU "1.234,56"
      if (v.lastIndexOf(",") > v.lastIndexOf(".")){
        v = v.replace(/\./g,"").replace(",","."); // 1.234,56 -> 1234.56
      }else{
        v = v.replace(/,/g,""); // 1,234.56 -> 1234.56
      }
    }else if (hasComma && !hasDot){
      v = v.replace(",","."); // "12,5" -> "12.5"
    }else{
      // only dot or plain number -> do nothing
    }
    const n = Number(v);
    return isFinite(n) ? n : 0;
  };

  function setVal(id, n){
    const el = $("#"+id);
    if (el) el.value = fmtEU(n);
  }

  function ud(precio, cant){
    cant = Number(cant);
    if (!cant) return 0;
    return precio / cant;
  }

  // === DIRECTOS ===
  function calcDirectos(){
    // [on,cant,precio,ud]
    const rows = [
      ["sub_d_prod_on","sub_d_prod_cant","sub_d_prod_precio","sub_d_prod_ud"],
      ["sub_d_papel_on","sub_d_papel_cant","sub_d_papel_precio","sub_d_papel_ud"],
      ["sub_d_tinta_on","sub_d_tinta_cant","sub_d_tinta_precio","sub_d_tinta_ud"],
      ["sub_d_cinta_on","sub_d_cinta_cant","sub_d_cinta_precio","sub_d_cinta_ud"],
      ["d_funda_on","d_funda_cant","d_funda_precio","d_funda_ud"],
      ["sub_d_empaque_on","sub_d_empaque_cant","sub_d_empaque_precio","sub_d_empaque_ud"]
    ];
    let total = 0;
    for(const [onId, cantId, precioId, udId] of rows){
      const cant = parseEU($("#"+cantId)?.value||"0");
      const precio = parseEU($("#"+precioId)?.value||"0");
      const unit = ud(precio,cant);
      if ($("#"+udId)) $("#"+udId).value = fmtEU(unit);
      const on = $("#"+onId)?.checked;
      if (on) total += unit;
    }
    return total;
  }

  // Depreciación: base 24 meses; costo ud = (precio/24) / prodMes
  function calcDepreciacion(){
    const prodDefault = 100; // unidades / mes default
    const depRows = [
      ["sub_e_impresora_on","sub_e_impresora_precio","sub_e_impresora_mes","sub_e_impresora_ud", prodDefault],
      ["sub_e_plancha_on","sub_e_plancha_precio","sub_e_plancha_mes","sub_e_plancha_ud", prodDefault],
      ["sub_e_pc_on","sub_e_pc_precio","sub_e_pc_mes","sub_e_pc_ud", prodDefault],
      ["sub_e_prensa_on","sub_e_prensa_precio","sub_e_prensa_mes","sub_e_prensa_ud", prodDefault],
      ["sub_e_res_on","sub_e_res_precio","sub_e_res_mes","sub_e_res_ud", prodDefault],
      ["e_horno_on","e_horno_precio","e_horno_mes","e_horno_ud", prodDefault]
    ];
    let total = 0;
    for (const [onId, precioId, mesId, udId, prodMesDefault] of depRows){
      const precio = parseEU($("#"+precioId)?.value||"0");
      const prodMesAttr = $("#"+precioId)?.getAttribute("data-prod");
      const prodMes = parseEU(prodMesAttr||"") || prodMesDefault;
      const cMes = precio / 24;
      const cUd = cMes / (prodMes || prodDefault);
      if ($("#"+mesId)) $("#"+mesId).value = fmtEU(cMes);
      if ($("#"+udId)) $("#"+udId).value = fmtEU(cUd);
      const on = $("#"+onId)?.checked;
      if (on) total += cUd;
    }
    return total;
  }

  // Costos indirectos (método A) de este módulo
  function calcIndirectosUd(){
    const on = $("#sub_v15_ind_on")?.checked;
    if (!on) { return 0; }
    const ids = [
      "sub_v15_ind_alquiler","sub_v15_ind_internet","sub_v15_ind_suscripciones",
      "sub_v15_ind_transporte","sub_v15_ind_electricidad","sub_v15_ind_publicidad","sub_v15_ind_otros"
    ];
    const units = parseEU($("#sub_v15_ind_units")?.value||"100") || 100;
    let mensual = 0;
    for (const id of ids){ mensual += parseEU($("#"+id)?.value||"0"); }
    const perUd = units ? (mensual/units) : 0;
    $("#sub_v15_ind_ud").textContent = fmtEU(perUd);
    return perUd;
  }

  // Mano de obra por unidad
  function calcMO(){
    const on = $("#sub_v15_mo_on")?.checked;
    const pill = $("#sub_v15_mo_pill");
    if (!on){
      if (pill) pill.style.display = "none";
      return 0;
    }
    const sueldo = parseEU($("#sub_v15_mo_sueldo")?.value||"0");
    const horasMes = parseEU($("#sub_v15_mo_horas_mes")?.value||"176") || 176;
    const setupMin = parseEU($("#sub_v15_mo_setup")?.value||"0");
    const runMin = parseEU($("#sub_v15_mo_run")?.value||"0");
    const units = parseEU($("#sub_v15_mo_units")?.value||"1") || 1;
    const horaVal = horasMes ? (sueldo/horasMes) : 0;
    const totalMin = setupMin + runMin * units;
    const costo = (horaVal * (totalMin/60)) / (units || 1);
    $("#sub_v15_mo_val").textContent = fmtEU(costo);
    if (pill) pill.style.display = "inline-flex";
    return costo;
  }

  function recalc(){
    // Navegar solo si la vista está presente en DOM
    const root = $("#view-sublimacion");
    if (!root || root.style.display === "none") {
      // still recalc because values may be used in resumen general later
    }
    const directos = calcDirectos();
    const dep = calcDepreciacion();
    const ind = calcIndirectosUd();
    const mo = calcMO();

    $("#sub_v15_total_directos").textContent = fmtEU(directos);
    $("#sub_v15_total_depr").textContent = fmtEU(dep);
    const sinGI = directos + dep + ind + mo;
    $("#sub_v15_subtotal_no_gi").textContent = fmtEU(sinGI);

    // Ganancia / Impuestos
    const gOn = $("#sub_v15_chk_ganancia")?.checked;
    const iOn = $("#sub_v15_chk_impuestos")?.checked;
    const gPct = parseEU($("#sub_v15_ganancia")?.value||"0");
    const iPct = parseEU($("#sub_v15_impuestos")?.value||"0");

    const gVal = gOn ? (sinGI * (gPct/100)) : 0;
    $("#sub_v15_ganancia_val").textContent = fmtEU(gVal);

    const baseImp = sinGI + gVal;
    const iVal = iOn ? (baseImp * (iPct/100)) : 0;
    $("#sub_v15_impuestos_val").textContent = fmtEU(iVal);

    const subtotal = sinGI;
    $("#sub_v15_subtotal").textContent = fmtEU(subtotal);

    const total = baseImp + iVal;
    $("#sub_v15_total").textContent = fmtEU(total);
  }

  function bind(){
    const ids = [
      // directos
      "sub_d_prod_on","sub_d_prod_cant","sub_d_prod_precio",
      "sub_d_papel_on","sub_d_papel_cant","sub_d_papel_precio",
      "sub_d_tinta_on","sub_d_tinta_cant","sub_d_tinta_precio",
      "sub_d_cinta_on","sub_d_cinta_cant","sub_d_cinta_precio",
      "d_funda_on","d_funda_cant","d_funda_precio",
      "sub_d_empaque_on","sub_d_empaque_cant","sub_d_empaque_precio",
      // dep
      "sub_e_impresora_on","sub_e_impresora_precio",
      "sub_e_plancha_on","sub_e_plancha_precio",
      "sub_e_pc_on","sub_e_pc_precio",
      "sub_e_prensa_on","sub_e_prensa_precio",
      "sub_e_res_on","sub_e_res_precio",
      "e_horno_on","e_horno_precio",
      // GI / MO / Ind
      "sub_v15_ind_on","sub_v15_ind_alquiler","sub_v15_ind_internet","sub_v15_ind_suscripciones",
      "sub_v15_ind_transporte","sub_v15_ind_electricidad","sub_v15_ind_publicidad","sub_v15_ind_otros","sub_v15_ind_units",
      "sub_v15_chk_ganancia","sub_v15_ganancia","sub_v15_chk_impuestos","sub_v15_impuestos",
      "sub_v15_mo_on","sub_v15_mo_sueldo","sub_v15_mo_horas_mes","sub_v15_mo_setup","sub_v15_mo_run","sub_v15_mo_units"
    ];
    ids.forEach(id=>{
      const el = $("#"+id);
      if (!el) return;
      el.addEventListener("input", recalc, {passive:true});
      el.addEventListener("change", recalc, {passive:true});
    });
  }

  document.addEventListener("DOMContentLoaded", function(){
    bind();
    // Primera corrida para poblar todos los "Costo Ud." y "costo x Mes"
    recalc();
  });
})();
</script>
<script id="sub_patch_v19_reset_fix">
(function(){
  function forceUncheckAll(root){
    const cbs = root.querySelectorAll('input[type="checkbox"]');
    cbs.forEach(cb => {
      cb.checked = false;
      cb.indeterminate = false;
      // fire both events so any listeners update UI
      cb.dispatchEvent(new Event('input', {bubbles:true}));
      cb.dispatchEvent(new Event('change', {bubbles:true}));
      // Tailwind/shadcn-like toggles (aria-checked / data-state)
      const label = cb.closest('label');
      if (label) {
        label.removeAttribute('data-state');
        label.removeAttribute('aria-checked');
        label.classList.remove('is-checked','checked');
      }
      // DaisyUI / custom toggles
      const parent = cb.parentElement;
      if (parent) {
        parent.classList.remove('toggle-checked','switch-checked','is-checked');
        if (parent.hasAttribute('data-state')) parent.removeAttribute('data-state');
        if (parent.hasAttribute('aria-checked')) parent.removeAttribute('aria-checked');
      }
    });
  }

  function resetSublimacion(e){
    const root = document.querySelector('#view-sublimacion');
    if (!root) return;
    // Only react if the click happened inside the module
    if (e && !root.contains(e.target)) return;
    // Uncheck all cbs visually and logically
    forceUncheckAll(root);
    // Zero out pills that depend on toggles (optional - UI nicety)
    ['sub_v15_ganancia_val','sub_v15_impuestos_val'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.textContent = "$ 0,00";
    });
    // Recalc if the module script exists
    try { 
      const ev = new Event('recalc_request');
      root.dispatchEvent(ev);
    } catch(_) {}
    // If a global recalc() exists (from earlier patch), call it
    try { if (typeof recalc === 'function') recalc(); } catch(_) {}
  }

  function bindReset(){
    const root = document.querySelector('#view-sublimacion');
    if (!root) return;
    // Candidates for reset triggers within the module
    const candidates = [
      '#sub_reset',
      '#sublimacion_reset',
      '#btn_sub_reset',
      '#reset_sublimacion',
      '[data-sub="reset"]',
      '[data-action="reset"]',
      '.btn-reset'
    ];
    let bound = false;
    for (const sel of candidates){
      root.querySelectorAll(sel).forEach(btn=>{
        btn.addEventListener('click', function(){
          setTimeout(resetSublimacion, 0);
        });
        bound = true;
      });
    }
    // As fallback, intercept Reset General if it bubbles inside module
    document.addEventListener('click', (ev)=>{
      const trg = ev.target;
      if (!trg) return;
      const txt = (trg.textContent||'').trim().toLowerCase();
      if (txt === 'reset' || txt === 'reset general'){
        setTimeout(resetSublimacion, 0);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', bindReset);
})();
</script>
<!-- DTF PREVIEW UX PATCH: legend + rotation markers -->
<script id="dtf_preview_markers">
(function(){
  function annotateRotMarkers(result){
    try{
      const panels = (result && result.panels) || [];
      const canvas = document.getElementById('dtf_layout');
      if(!canvas || !panels.length) return;
      const ctx = canvas.getContext('2d');
      const info = document.getElementById('dtf_layout_info');
      const autorot = !!document.getElementById('dtf_autorot')?.checked;
      if(info){
        const base = info.textContent || "";
        if(!/Auto-rotación:/i.test(base)){
          info.textContent = base + ' • Auto-rotación: ' + (autorot ? 'ON' : 'OFF');
        }else{
          info.textContent = base.replace(/Auto-rotación:\s*(ON|OFF)/i, 'Auto-rotación: '+(autorot?'ON':'OFF'));
        }
      }
      // replicate geometry used in original draw()
      // panel size (cm)
      const tipo = document.getElementById('dtf_panel_tipo')?.value || 'metro';
      const W = (tipo==='metro') ? 57 : Number((document.getElementById('dtf_panel_w')?.value||'30').replace(',','.')) || 30;
      const H = (tipo==='metro') ? (Number((document.getElementById('dtf_panel_h')?.value||'100').replace(',','.')) || 100) : Number((document.getElementById('dtf_panel_h')?.value||'42').replace(',','.')) || 42;
      const PAD=12, GAP=16, availW=600;
      const cols = Math.min(3, Math.max(1, Math.ceil(Math.sqrt(panels.length||1))));
      const pW = (W*(availW - (cols+1)*GAP)/cols)/W;
      const scale = (availW - (cols+1)*GAP) / cols / W;
      ctx.save();
      ctx.font = '10px Poppins, Arial';
      ctx.fillStyle = '#111';
      for(let i=0;i<panels.length;i++){
        const rows = Math.ceil((panels.length||1)/cols);
        const pH = (H*(availW - (cols+1)*GAP)/cols)/W;
        const row=Math.floor(i/cols), col=i%cols, ox=PAD + col*(pW+GAP), oy=PAD + row*(pH+GAP);
        panels[i].placements.forEach((pl)=>{
          if(!pl.rot) return;
          const x=ox + pl.x*scale, y=oy + pl.y*scale;
          const w=pl.w*scale, h=pl.h*scale;
          // draw a small 90° badge
          ctx.fillStyle = 'rgba(0,0,0,0.7)';
          ctx.fillRect(x+w-18, y+2, 16, 12);
          ctx.fillStyle = '#fff';
          ctx.fillText('90°', x+w-16, y+4);
        });
      }
      ctx.restore();
    }catch(e){ /* silent */ }
  }

  // Wrap generatePreview to add markers after drawing
  const tryWrap = ()=>{
    if(typeof window.generatePreview === 'function' && !window._dtfWrapped){
      const _orig = window.generatePreview;
      window.generatePreview = function(silent){
        const res = _orig.call(this, silent);
        annotateRotMarkers(res);
        return res;
      };
      window._dtfWrapped = true;
    }
  };
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', tryWrap);
  else tryWrap();
})();
</script>
<!-- DTF RANDOM ORIENTATION PATCH: repurpose 'Auto-rotación 90°' -->
<script id="dtf_random_orient_patch">
(function(){
  function text(node, s){ if(node) node.textContent = s; }
  function qs(sel, ctx=document){ return ctx.querySelector(sel); }
  function qsa(sel, ctx=document){ return Array.prototype.slice.call(ctx.querySelectorAll(sel)); }
  function parseEU(raw){
    if(raw==null) return 0;
    let v = String(raw).trim();
    v = v.replace(/[^\d,.\-]/g, '');
    if (v.includes('.') && v.includes(',')){ v = v.replace(/\./g,'').replace(',', '.'); }
    else if (v.includes(',')){ v = v.replace(',', '.'); }
    const n = parseFloat(v);
    return isFinite(n) ? n : 0;
  }

  function renameToggle(){
    const cb = qs('#dtf_autorot'); if(!cb) return;
    // Change visible label to "Orientación aleatoria"
    let labelEl = document.querySelector('label[for="dtf_autorot"]');
    if(!labelEl){
      // try closest label wrapper
      labelEl = cb.closest('label') || cb.parentElement?.querySelector('label');
    }
    if(labelEl){ text(labelEl, 'Orientación aleatoria'); }

    // Detach existing listeners by cloning (prevents recompute() de costos al cambiar este toggle)
    const c = cb.cloneNode(true);
    cb.parentNode.replaceChild(c, cb);
    // Optional: keep a tiny visual indicator update
    c.addEventListener('change', ()=>{
      const info = qs('#dtf_layout_info');
      if(info){
        const base = info.textContent || '';
        const note = (c.checked ? 'ON' : 'OFF');
        if(/Orientación aleatoria:/i.test(base)){
          info.textContent = base.replace(/Orientación aleatoria:\s*(ON|OFF)/i, 'Orientación aleatoria: '+note);
        }else{
          info.textContent = base + (base ? ' • ' : '') + 'Orientación aleatoria: ' + note;
        }
      }
    });
  }

  // Read current panel dims
  function getPanelDims(){
    const tipo = qs('#dtf_panel_tipo')?.value || 'metro';
    let W,H,label;
    if(tipo==='metro'){
      W = 57;
      H = parseEU(qs('#dtf_panel_h')?.value) || 100;
      label = `Metro ${W}×${H} cm`;
    }else{
      W = parseEU(qs('#dtf_panel_w')?.value) || 30;
      H = parseEU(qs('#dtf_panel_h')?.value) || 42;
      label = `Panel ${W}×${H} cm`;
    }
    return {W,H,label};
  }

  // Collect rectangles from cards (width, height, count); returns flat array
  function collectRects(){
    const cards = qsa('#dtf_bloques > .card.md-12');
    const rects = [];
    cards.forEach(card=>{
      const id = card.getAttribute('data-id') || '';
      const w = parseEU(card.querySelector('#dtf_w'+id)?.value);
      const h = parseEU(card.querySelector('#dtf_h'+id)?.value);
      const n = Math.max(0, Math.floor(parseEU(card.querySelector('#dtf_n'+id)?.value)));
      if(w>0 && h>0 && n>0){
        for(let i=0;i<n;i++){ rects.push({w, h}); }
      }
    });
    return rects;
  }

  // First-fit packing with simple rows (like original), returning panels with placements and used height
  function pack(rects, W, H, sep){
    const edge = sep; // minimal margins
    const res = [];
    let cur = {placements:[], x:edge, y:edge, rowH:0};
    const fit=(o)=> (cur.x+o.w <= W-edge+1e-9) && (cur.y + Math.max(cur.rowH,o.h) <= H-edge+1e-9);
    const place=(o)=>{ cur.placements.push({x:cur.x,y:cur.y,w:o.w,h:o.h,rot:o.rot||false}); cur.x += o.w + sep; cur.rowH = Math.max(cur.rowH,o.h); };
    const newRow=()=>{ cur.x=edge; cur.y = cur.y + cur.rowH + sep; cur.rowH = 0; };
    const newPanel=()=>{ if(cur.placements.length) res.push({placements:cur.placements.slice(), y:cur.y, rowH:cur.rowH}); cur={placements:[], x:edge, y:edge, rowH:0}; };

    rects.forEach(r=>{
      const o = {w:r.w, h:r.h, rot:false};
      if(!fit(o)){
        // try new row
        newRow();
        if(!fit(o)){
          // new panel
          newPanel();
        }
      }
      if(fit(o)){ place(o); }
      else{
        // If still doesn't fit, try rotated as fallback
        const ro = {w:r.h, h:r.w, rot:true};
        if(!fit(ro)){ newRow(); if(!fit(ro)){ newPanel(); } }
        if(fit(ro)) place(ro);
        else { /* worst-case: force new panel & place */ newPanel(); place(ro); }
      }
    });
    if(cur.placements.length) res.push({placements:cur.placements.slice(), y:cur.y, rowH:cur.rowH});
    // compute used height
    const panels = res.map(p=>({placements:p.placements, usedH: Math.min(H, p.y + p.rowH)}));
    return panels;
  }

  // Draw panels on #dtf_layout (replicates original style)
  function drawPanels(panels, W, H){
    const canvas = qs('#dtf_layout'); if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const PAD=12, GAP=16, availW=600;
    const cols = Math.min(3, Math.max(1, Math.ceil(Math.sqrt(panels.length||1))));
    const rows = Math.ceil((panels.length||1)/cols);
    const pW = (W*(availW - (cols+1)*GAP)/cols)/W;
    const pH = (H*(availW - (cols+1)*GAP)/cols)/W;
    const scale = (availW - (cols+1)*GAP) / cols / W;

    const w = PAD*2 + cols * pW + (cols-1)*GAP;
    const h = PAD*2 + rows * pH + (rows-1)*GAP;
    canvas.width = Math.max(600, Math.ceil(w));
    canvas.height= Math.max(350, Math.ceil(h));
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.font='12px Poppins, Arial'; ctx.textBaseline='top';
    const color=(i)=>`hsl(${(i*37)%360} 70% 75%)`;

    for(let i=0;i<panels.length;i++){
      const row=Math.floor(i/cols), col=i%cols, ox=PAD + col*(pW+GAP), oy=PAD + row*(pH+GAP);
      ctx.strokeStyle='#333'; ctx.strokeRect(ox,oy,pW,pH);
      panels[i].placements.forEach((pl,j)=>{
        const x=ox+pl.x*scale, y=oy+pl.y*scale, w=pl.w*scale, h=pl.h*scale;
        ctx.fillStyle=color(j); ctx.fillRect(x,y,w,h);
        ctx.strokeStyle='#222'; ctx.strokeRect(x,y,w,h);
        ctx.fillStyle='#222'; ctx.fillText(`${Math.round(pl.w)}×${Math.round(pl.h)}`, x+3, y+3);
        if(pl.rot){
          ctx.fillStyle='rgba(0,0,0,0.7)'; ctx.fillRect(x+w-18,y+2,16,12);
          ctx.fillStyle='#fff'; ctx.fillText('90°', x+w-16, y+4);
        }
      });
    }
  }

  // Randomized orientation + shuffle search
  function randomize(arr){ return arr.map(v=>v).sort(()=>Math.random()-0.5); }

  function optimizeLayout(rects, W, H, sep, tries){
    let best=null;
    for(let t=0;t<tries;t++){
      // random orientation choice per rect
      const muts = rects.map(r=> Math.random()<0.5 ? {w:r.w,h:r.h} : {w:r.h,h:r.w, rot:true});
      // random order
      const sh = randomize(muts);
      const panels = pack(sh, W, H, sep);
      // score: fewer panels first, then total used height sum
      const score = panels.length*10000 + panels.reduce((a,p)=>a + p.usedH, 0);
      if(!best || score < best.score){ best = {panels, score}; }
    }
    return best ? best.panels : pack(rects, W, H, sep);
  }

  function wrapGeneratePreview(){
    if(typeof window.generatePreview !== 'function') return;
    if(window._dtfRandomWrapped) return;
    const _orig = window.generatePreview;
    window.generatePreview = function(silent){
      const ret = _orig.call(this, silent);
      const toggle = qs('#dtf_autorot');
      if(!toggle || !toggle.checked){ return ret; }
      // When activated, ignore original rotation rules and do random-orientation optimization for preview only
      try{
        const sep = parseEU(qs('#dtf_sep')?.value);
        const {W,H,label} = getPanelDims();
        const rects = collectRects();
        // number of tries scales with items (min 60, max 300)
        const tries = Math.max(60, Math.min(300, rects.length * 20));
        const best = optimizeLayout(rects, W, H, sep, tries);
        drawPanels(best, W, H);
        // update info line
        const info = qs('#dtf_layout_info');
        if(info){ info.textContent = `Paneles: ${best.length} • Panel: ${label} • Sep: ${sep} cm • Orientación aleatoria: ON`; }
      }catch(e){ /* swallow errors to avoid breaking */ }
      return ret;
    };
    window._dtfRandomWrapped = true;
  }

  function init(){
    renameToggle();
    wrapGeneratePreview();
  }
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>
<!-- Remove visible text "Orientación aleatoria" but keep the checkbox -->
<script id="remove_orient_aleatoria_text">
document.addEventListener('DOMContentLoaded', function(){
  // 1) Clear label text while preserving control(s)
  document.querySelectorAll('label').forEach(function(lbl){
    if (/Orientación aleatoria/i.test(lbl.textContent || '')) {
      // remove only text nodes; keep inputs/spans
      Array.from(lbl.childNodes).forEach(function(n){
        if (n.nodeType === Node.TEXT_NODE) n.textContent = '';
      });
    }
  });
  // 2) Also remove any stray text nodes near the buttons row
  document.querySelectorAll('#view-dtf *').forEach(function(el){
    Array.from(el.childNodes || []).forEach(function(n){
      if (n.nodeType === Node.TEXT_NODE && /Orientación aleatoria/i.test(n.textContent || '')) {
        n.textContent = '';
      }
    });
  });
});
</script>
<script>
// ===== Margen/Markup FORZADO — Todos los módulos (sub_v15_, vin_, eti_, emp_, dtf_) =====
(function(){
  function q(id){ return document.getElementById(id); }
  function parseEU(v){
    if (v==null) return 0;
    v = String(v).replace(/[^\d.,-]/g,'').trim();
    if (!v) return 0;
    if (v.indexOf(',')>=0){ v = v.replace(/\./g,'').replace(',', '.'); }
    var n = parseFloat(v);
    return isNaN(n) ? 0 : n;
  }
  function fmt(n){
  var v = (typeof n === 'number') ? n : parseFloat(n) || 0;
  if (!isFinite(v)) v = 0;
  try{
    // Forzar siempre formato europeo: miles con punto, decimales con coma
    return v.toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2});
  }catch(_){
    // Fallback manual si el locale no está disponible
    var x = Math.round(v * 100) / 100;
    var parts = x.toFixed(2).split('.');
    var a = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,'.');
    return a + ',' + parts[1];
  }
}
  function set$(id,n){ var el=q(id); if(el){ el.textContent = '$ ' + fmt(n); } }
  function ensureSelector(prefix){
    var g = q(prefix+'ganancia'); if (!g) return;
    if (q(prefix+'ganancia_mode')) return;
    var host = g.parentElement || g;
    var row = document.createElement('div');
    // Responsive: allow wrap so the selector no desborde en móvil
    row.style = 'display:flex;align-items:center;gap:8px;margin:6px 0;flex-wrap:wrap';
    var label = document.createElement('label');
    label.style='min-width:120px;flex:0 0 auto;';
    label.textContent='Modo ganancia:';
    var sel = document.createElement('select');
    sel.id=prefix+'ganancia_mode';
    sel.style='flex:1 1 160px;min-width:140px;max-width:100%;';
    sel.innerHTML = '<option value="margen">Margen</option><option value="markup">Markup</option>';
    try{ sel.value = localStorage.getItem(prefix+'ganancia_mode') || 'margen'; }catch(_){ sel.value='margen'; }
    sel.addEventListener('change', function(){ try{ localStorage.setItem(prefix+'ganancia_mode', sel.value);}catch(_){} });
    row.appendChild(label); row.appendChild(sel);
    host.appendChild(row);
  }
  
function compute(prefix){
    var subEl = q(prefix+'subtotal_no_gi') || q(prefix+'subtotal');
    var gEl = q(prefix+'ganancia'), iEl = q(prefix+'impuestos');
    if (!subEl || !gEl || !iEl) return null;
    var subtotal = parseEU(subEl.textContent);

    // === Mano de Obra (sumada al subtotal si está activa) ===
    try{
      var moOn = !!q(prefix+'mo_on')?.checked;
      if (moOn){
        var s  = parseEU(q(prefix+'mo_sueldo')?.value);
        var h  = parseEU(q(prefix+'mo_horas_mes')?.value); if (!isFinite(h) || h<=0) h = 176;
        var st = parseEU(q(prefix+'mo_setup')?.value);
        var rn = parseEU(q(prefix+'mo_run')?.value);
        var u  = parseEU(q(prefix+'mo_units')?.value); if (!isFinite(u) || u<=0) u = 1;
        var hora = s / h;
        var totalMin = st + (rn * u);
        var totalMO  = hora * (totalMin/60.0);
        var mo_ud    = totalMO / u;

        // Mostrar píldora y valor de MO si existen
        var pill = q(prefix+'mo_pill');
        if (pill) pill.style.display = (mo_ud>0) ? '' : 'none';
        if (q(prefix+'mo_val')) set$(prefix+'mo_val', mo_ud);

        subtotal += mo_ud;
      }else{
        // ocultar píldora si existe
        var pillOff = q(prefix+'mo_pill'); if (pillOff) pillOff.style.display = 'none';
      }
    }catch(e){ /* no romper cálculo base */ }

    var g = Math.max(0, parseEU(gEl.value))/100;
    var i = Math.max(0, parseEU(iEl.value))/100;
    var gOn = !!q(prefix+'chk_ganancia')?.checked;
    var iOn = !!q(prefix+'chk_impuestos')?.checked;
    var mode = (q(prefix+'ganancia_mode')?.value || (localStorage.getItem(prefix+'ganancia_mode') || 'margen'));
    var price = subtotal;
    if (gOn){
      if (mode === 'margen'){
        price = (subtotal>0 && g<1) ? subtotal/(1-g) : subtotal;
      }else{
        price = subtotal*(1+g);
      }
    }
    var gan = price - subtotal;
    var imp = iOn ? price*i : 0;
    var total = price + imp;
    return {subtotal, gan, imp, total};
}

  var PREFIXES = ['sub_v15_','vin_','eti_','emp_','dtf_','pap_'];
  function step(){
    PREFIXES.forEach(function(P){
      if (!q(P+'ganancia')) return;
      ensureSelector(P);
      var r = compute(P); if (!r) return;
      set$(P+'ganancia_val', r.gan);
      set$(P+'impuestos_val', r.imp);
      set$(P+'total', r.total);
      if (q(P+'subtotal')) set$(P+'subtotal', r.subtotal);
    });
  }
  function loop(){ try{ step(); }finally{ window.requestAnimationFrame(loop); } }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', loop);
  else loop();
})();
</script>
<script>
(function(){
  if (!document.getElementById('view-papeleria')) return;
  const q=id=>document.getElementById(id);
  const parseEU=(v)=>{ if(typeof v==='number') return v; v=(v||'').toString().trim().replace(/\./g,'').replace(',','.'); let n=parseFloat(v); return isNaN(n)?0:n; };
  const fmtEU=(n)=>'$ '+(isFinite(n)?n:0).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2});

  function unitUd(cant,precio){ cant=parseEU(cant); precio=parseEU(precio); return cant>0?precio/cant:0; }
  function depMes(precio){ return parseEU(precio)/24; }
  function depUd(mes){ return mes/100; }

  function recalc(){
    // directos (consumo real)
    let directos = 0;

    function directItem(key){
      const ud = unitUd(q('pap_d_'+key+'_cant').value, q('pap_d_'+key+'_precio').value);
      const udEl = q('pap_d_'+key+'_ud');
      if (udEl) udEl.value = fmtEU(ud);

      const useEl = q('pap_d_'+key+'_use');
      let use = useEl ? parseEU(useEl.value) : 1;
      if (!isFinite(use) || use < 0){ use = 0; if (useEl) useEl.value = '0'; }
      const used = ud * use;

      const usedEl = q('pap_d_'+key+'_used');
      if (usedEl) usedEl.value = fmtEU(used);

      if (q('pap_d_'+key+'_on').checked) directos += used;
    }

    ['sustrato1','sustrato2','adh1','adh2','extra','pack'].forEach(directItem);

    // depreciación (consumo real)
    let depr = 0;

    function usosValue(id){
      const el = q(id);
      let v = el ? parseEU(el.value) : 1;
      if (!isFinite(v) || v < 0){ v = 0; if (el) el.value = '0'; }
      return v;
    }

    function depItem(key){
      const precioId = 'pap_e_'+key+'_precio';
      const mesId    = 'pap_e_'+key+'_mes';
      const udId     = 'pap_e_'+key+'_ud';

      const m = depMes(q(precioId).value);
      if (q(mesId)) q(mesId).value = fmtEU(m);

      const ud = depUd(m);
      if (q(udId)) q(udId).value = fmtEU(ud);

      const used = ud * usosValue('pap_e_'+key+'_usos');
      if (q('pap_e_'+key+'_used')) q('pap_e_'+key+'_used').value = fmtEU(used);

      if (q('pap_e_'+key+'_on').checked) depr += used;
    }

    function depVida(key){
      const p = parseEU(q('pap_e_'+key+'_precio').value);
      const v = parseEU(q('pap_e_'+key+'_vida').value);
      const ud = v>0 ? (p/v) : 0;
      if (q('pap_e_'+key+'_ud')) q('pap_e_'+key+'_ud').value = fmtEU(ud);

      const used = ud * usosValue('pap_e_'+key+'_usos');
      if (q('pap_e_'+key+'_used')) q('pap_e_'+key+'_used').value = fmtEU(used);

      if (q('pap_e_'+key+'_on').checked) depr += used;
    }

    ['plotter','imp','laminadora','guillotina','pc'].forEach(depItem);
    ['cuchilla','tapete'].forEach(depVida);

    // indirectos
    let ind = 0;
    if (q('pap_ind_on').checked){
      const sum = ['alquiler','internet','suscripciones','transporte','electricidad','publicidad','otros']
        .map(k=>parseEU(q('pap_ind_'+k).value)).reduce((a,b)=>a+b,0);
      const units = Math.max(1, parseEU(q('pap_ind_units').value||'100'));
      ind = sum/units;
      q('pap_ind_ud').textContent = fmtEU(ind);
    }else{
      q('pap_ind_ud').textContent = fmtEU(0);
    }

    const subtotal_no_gi = directos + depr + ind;
    document.getElementById('pap_total_directos').textContent = fmtEU(directos);
    document.getElementById('pap_total_depr').textContent = fmtEU(depr);
    document.getElementById('pap_subtotal_no_gi').textContent = fmtEU(subtotal_no_gi);
  }

  // toggles
  const btnInd = document.getElementById('pap_ind_cfg_btn');
  if (btnInd){ btnInd.addEventListener('click', ()=>{
      const p=document.getElementById('pap_ind_cfg'); const s=getComputedStyle(p).display==='none'; p.style.display=s?'block':'none';
      btnInd.textContent = s?'Ocultar':'Configurar';
  });}
  // Robust toggle for Mano de Obra (Papelería) — patrón documento-level, con !important para display
document.addEventListener('click', function(ev){
  var btn = ev.target && (ev.target.closest('#pap_mo_cfg_btn') || (ev.target.id==='pap_mo_cfg_btn' ? ev.target : null));
  if(btn){
    ev.preventDefault();
    ev.stopPropagation();
    var panel = document.getElementById('pap_mo_cfg');
    if(panel){
      var isHidden = getComputedStyle(panel).display === 'none' || panel.style.display === 'none';
      if(isHidden){
        panel.style.setProperty('display','flex','important');
        btn.textContent = 'Ocultar';
      }else{
        panel.style.setProperty('display','none','important');
        btn.textContent = 'Configurar';
      }
    }
  }
}, true);

  // events
  document.querySelectorAll('#view-papeleria input, #view-papeleria select').forEach(el=>{
    if (['pap_ganancia','pap_impuestos','pap_mo_on','pap_mo_sueldo','pap_mo_horas_mes','pap_mo_setup','pap_mo_run','pap_mo_units','pap_chk_ganancia','pap_chk_impuestos'].includes(el.id)) {
      // handled by global compute; still trigger subtotal refresh
    }
    el.addEventListener('input', recalc);
    el.addEventListener('change', recalc);
  });

  recalc();
})();
</script>
<!-- ===== MODULE: PAPELERÍA | LOGIC (totals + depreciation + directos) ===== -->
<script>
(function initPapeleriaModule(){
  const root = document.getElementById('view-papeleria');
  if(!root) return;

  const $  = (sel)=> root.querySelector(sel);
  const $$ = (sel)=> Array.from(root.querySelectorAll(sel));

  function parseEU(v){
    if(v==null) return 0;
    if(typeof v==='number') return v;
    let s = String(v).trim().replace(/[^0-9.,\-]/g,'');
    if(s.includes(',') && s.includes('.')) s = s.replace(/\./g,'').replace(',', '.');
    else if(s.includes(',')) s = s.replace(',', '.');
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }
  function fmtUSD(n){
    try { return '$ ' + new Intl.NumberFormat('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2}).format(+n||0); }
    catch(_){ const x = Math.round(((+n)||0)*100)/100; return '$ ' + x.toFixed(2).replace('.',','); }
  }

  // ===== Directos helpers =====
  function unitCostRow({on,cant,precio,ud}){
    const qty  = parseEU($(cant)?.value);
    const pr   = parseEU($(precio)?.value);
    const val  = (qty>0) ? pr/qty : 0;
    const elUd = $(ud); if(elUd) elUd.value = fmtUSD(val);
    return ($(on)?.checked ?? false) ? val : 0;
  }

  // ===== Depreciación helpers =====
  const UNITS_PER_MONTH_DEFAULT = 100;
  function depMonthRow({on,precio,mes,ud}){
    const price = parseEU($(precio)?.value);
    const perMonth = price/24;
    const elMes = $(mes), elUd = $(ud);
    if(elMes) elMes.value = fmtUSD(perMonth);
    const perUnit = perMonth/UNITS_PER_MONTH_DEFAULT;
    if(elUd) elUd.value = fmtUSD(perUnit);
    return ($(on)?.checked ?? false) ? perUnit : 0;
  }
  function depLifeRow({on,precio,vida,ud}){
    const p = parseEU($(precio)?.value);
    const v = Math.max(1, parseEU($(vida)?.value));
    const perUse = p/v;
    const elUd = $(ud); if(elUd) elUd.value = fmtUSD(perUse);
    return ($(on)?.checked ?? false) ? perUse : 0;
  }

  // ===== Totales =====
  function recalc(){
    // Directos
    const d1 = unitCostRow({on:'#pap_d_sustrato1_on', cant:'#pap_d_sustrato1_cant', precio:'#pap_d_sustrato1_precio', ud:'#pap_d_sustrato1_ud'});
    const d2 = unitCostRow({on:'#pap_d_sustrato2_on', cant:'#pap_d_sustrato2_cant', precio:'#pap_d_sustrato2_precio', ud:'#pap_d_sustrato2_ud'});
    const d3 = unitCostRow({on:'#pap_d_adh1_on',      cant:'#pap_d_adh1_cant',      precio:'#pap_d_adh1_precio',      ud:'#pap_d_adh1_ud'});
    const d4 = unitCostRow({on:'#pap_d_adh2_on',      cant:'#pap_d_adh2_cant',      precio:'#pap_d_adh2_precio',      ud:'#pap_d_adh2_ud'});
    const d5 = unitCostRow({on:'#pap_d_extra_on',     cant:'#pap_d_extra_cant',     precio:'#pap_d_extra_precio',     ud:'#pap_d_extra_ud'});
    const d6 = unitCostRow({on:'#pap_d_pack_on',      cant:'#pap_d_pack_cant',      precio:'#pap_d_pack_precio',      ud:'#pap_d_pack_ud'});
    const directos = d1+d2+d3+d4+d5+d6;
    $('#pap_total_directos') && ($('#pap_total_directos').textContent = fmtUSD(directos));

    // Depreciación
    const e1 = depMonthRow({on:'#pap_e_plotter_on',    precio:'#pap_e_plotter_precio',    mes:'#pap_e_plotter_mes',    ud:'#pap_e_plotter_ud'});
    const e2 = depMonthRow({on:'#pap_e_imp_on',        precio:'#pap_e_imp_precio',        mes:'#pap_e_imp_mes',        ud:'#pap_e_imp_ud'});
    const e3 = depMonthRow({on:'#pap_e_guillotina_on', precio:'#pap_e_guillotina_precio', mes:'#pap_e_guillotina_mes', ud:'#pap_e_guillotina_ud'});
    const e4 = depMonthRow({on:'#pap_e_laminadora_on', precio:'#pap_e_laminadora_precio', mes:'#pap_e_laminadora_mes', ud:'#pap_e_laminadora_ud'});
    const e5 = depMonthRow({on:'#pap_e_pc_on',         precio:'#pap_e_pc_precio',         mes:'#pap_e_pc_mes',         ud:'#pap_e_pc_ud'});
    const e6 = depLifeRow ({on:'#pap_e_cuchilla_on',   precio:'#pap_e_cuchilla_precio',   vida:'#pap_e_cuchilla_vida', ud:'#pap_e_cuchilla_ud'});
    const e7 = depLifeRow ({on:'#pap_e_tapete_on',     precio:'#pap_e_tapete_precio',     vida:'#pap_e_tapete_vida',   ud:'#pap_e_tapete_ud'});
    const depr = e1+e2+e3+e4+e5+e6+e7;
    $('#pap_total_depr') && ($('#pap_total_depr').textContent = fmtUSD(depr));

    const indUd = parseEU($('#pap_ind_ud')?.textContent || '$ 0,00');
    const noGI = directos + depr + indUd;
    $('#pap_subtotal_no_gi') && ($('#pap_subtotal_no_gi').textContent = fmtUSD(noGI));

    try { if(window.resumen_update) window.resumen_update(); } catch(_){}
  }

  // ===== Reset behaviors =====
  // Capture defaults for "Reset general" (restaura valores por defecto del módulo)
  const DEFAULTS = [];
  $$('input, select').forEach(el => {
    DEFAULTS.push({ id: el.id, type: el.type, value: el.type === 'checkbox' ? el.checked : el.value });
  });
  function resetPapeleriaDefaults(){
    DEFAULTS.forEach(s => {
      const el = document.getElementById(s.id);
      if(!el) return;
      if(s.type === 'checkbox') el.checked = !!s.value;
      else el.value = s.value;
    });
    recalc();
  }
  // Nuevo: Reset del módulo => desactivar TODOS los checkbox (valores se mantienen)
  function resetPapeleriaUncheck(){
    $$('input[type="checkbox"]').forEach(chk => { chk.checked = false; });
    recalc();
  }

  // Exponer (por si otros scripts lo requieren)
  window.reset_papeleria_defaults = resetPapeleriaDefaults;
  window.reset_papeleria_uncheck  = resetPapeleriaUncheck;

  // ===== Bindings =====
  $$('input, select').forEach(el => {
    el.addEventListener('input', recalc);
    el.addEventListener('change', recalc);
  });
  // Botón Reset del módulo => desactivar checkboxes
  const btnModuleReset = $('#pap_btn_reset');
  if(btnModuleReset) btnModuleReset.addEventListener('click', resetPapeleriaUncheck);

  // Botón Reset general => restaurar defaults (si existe)
  const btnGeneral = document.getElementById('btn_reset_general');
  if(btnGeneral) btnGeneral.addEventListener('click', resetPapeleriaUncheck);

  // Primera ejecución
  recalc();
})();
</script>
<script>
// === Papelería — Reset de módulo desde 0 (reforzado, no altera otros módulos) ===
(function(){
  function papParse(n){ try{ if(typeof parseEU==='function') return parseEU(n); }catch(_){}
    var s = (n==null?'':String(n)).trim().replace(/[^0-9,.-]/g,'');
    if(s.includes(',') && s.includes('.')) s = s.replace(/\./g,'').replace(',', '.');
    else if(s.includes(',')) s = s.replace(',', '.');
    var x = parseFloat(s); return isNaN(x)?0:x;
  }
  function papEuro(n){
    try{ return '$ ' + new Intl.NumberFormat('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2}).format(+n||0); }
    catch(_){ var x = Math.round(((+n)||0)*100)/100; return '$ ' + (x.toFixed(2).replace('.',',')); }
  }

  function papResetStrict(){
    var root = document.getElementById('view-papeleria');
    if(!root){ try{ if (typeof window.resumen_update==='function') window.resumen_update(); }catch(_){ } return; }

    // 1) Apagar TODOS los checkboxes del módulo (Directos/Depreciación/Indirectos/GI/MO)
    root.querySelectorAll('input[type="checkbox"]').forEach(function(chk){
      if (chk.checked) chk.checked = false;
      try{ chk.dispatchEvent(new Event('change',{bubbles:true})); }catch(_){}
      try{ chk.dispatchEvent(new Event('input',{bubbles:true})); }catch(_){}
      try{ chk.dispatchEvent(new Event('click',{bubbles:true})); }catch(_){}
    });

    // 1b) Restablecer consumo real (Cantidad a utilizar / Cant. de usos) a 1
    root.querySelectorAll('input[id$="_use"], input[id$="_usos"]').forEach(function(inp){
      try{ inp.value = '1'; }catch(_){}
      try{ inp.dispatchEvent(new Event('input',{bubbles:true})); }catch(_){}
      try{ inp.dispatchEvent(new Event('change',{bubbles:true})); }catch(_){}
    });

    // 2) Ocultar paneles de configuración y restaurar el texto del botón
    var indBtn = document.getElementById('pap_ind_cfg_btn');
    var indCfg = document.getElementById('pap_ind_cfg');
    if (indCfg){ indCfg.style.setProperty('display','none','important'); }
    if (indBtn){ indBtn.textContent = 'Configurar'; }

    var moBtn = document.getElementById('pap_mo_cfg_btn');
    var moCfg = document.getElementById('pap_mo_cfg');
    if (moCfg){ moCfg.style.setProperty('display','none','important'); }
    if (moBtn){ moBtn.textContent = 'Configurar'; }

    // 3) Forzar espejos/labels a cero (solo si estaban vacíos: no tocamos entradas del usuario)
    var indUd = document.getElementById('pap_ind_ud'); if (indUd) indUd.textContent = papEuro(0);
    var tdir  = document.getElementById('pap_total_directos'); if (tdir && !tdir.textContent)  tdir.textContent  = papEuro(0);
    var tdep  = document.getElementById('pap_total_depr');     if (tdep && !tdep.textContent)  tdep.textContent  = papEuro(0);
    var tnogi = document.getElementById('pap_subtotal_no_gi'); if (tnogi && !tnogi.textContent) tnogi.textContent = papEuro(0);
    var tsub  = document.getElementById('pap_subtotal');       if (tsub && !tsub.textContent)  tsub.textContent  = papEuro(0);
    var ttot  = document.getElementById('pap_total');          if (ttot)                         ttot.textContent  = papEuro(0);

    // 4) Notificar a resumen para que deje de sumar este módulo
    try{ if (typeof window.updateResumen==='function') window.updateResumen(); }catch(_){}
    try{ if (typeof window.resumen_update==='function') window.resumen_update(); }catch(_){}
  }

  function bindPapeleriaReset(){
    var btn = document.getElementById('pap_btn_reset');
    if (!btn) return;
    // Clonar para limpiar oyentes previos y evitar duplicados
    var clone = btn.cloneNode(true);
    btn.parentNode.replaceChild(clone, btn);
    clone.addEventListener('click', function(ev){
      ev.preventDefault();
      papResetStrict();
    });
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bindPapeleriaReset);
  else bindPapeleriaReset();

  // Exponer por si el Reset General desea invocarlo en cadena
  window.pap_reset_strict = papResetStrict;

  // [Papelería] Botón "Exportar a PDF / Imprimir" (patrón Esferas/Sublimación)
  const papRoot = document.getElementById('view-papeleria');
  if(papRoot){
    const papPrintBtn = document.getElementById('pap_btn_print');
    if(papPrintBtn){
      papPrintBtn.addEventListener('click', function(){
        const views = document.querySelectorAll('.view');
        const wasActive = Array.prototype.map.call(views, v => v.classList.contains('active'));
        views.forEach(v => v.classList.remove('active'));
        papRoot.classList.add('active');
        setTimeout(()=>window.print(), 30);
        setTimeout(()=>{
          views.forEach((v,i)=>{ if(wasActive[i]) v.classList.add('active'); });
        }, 1000);
      });
    }
  }
})();
</script>
<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));
  const parseEU = (v)=>{
    if(v==null) return 0;
    const s = String(v).trim().replace(/\s/g,'').replace(/\./g,'').replace(',', '.');
    const n = parseFloat(s);
    return isFinite(n)?n:0;
  };
  const fmtEU = (n)=>{
    n = Number(n)||0;
    const sign = n<0 ? '-' : '';
    n = Math.abs(n);
    let s = n.toFixed(2).replace('.',',');
    s = s.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return sign + '$ ' + s;
  };
  const setMoney = (el, n)=>{ if(el) el.value = fmtEU(n); };
  function unit(cant, precio){ cant = parseEU(cant); precio = parseEU(precio); return cant>0 ? (precio/cant) : 0; }

  function vinil_directos_base(){
    const on = $('#cd_enabled')?.checked;
    const ud = unit($('#cd_cant')?.value, $('#cd_precio')?.value);
    setMoney($('#cd_costo_ud'), ud);
    return on ? ud : 0;
  }
  function vinil_extras_sum(){
    let sum = 0;
    ['papel','cinta','tinta'].forEach(k=>{
      const ud = unit($('#vin_d_'+k+'_cant')?.value, $('#vin_d_'+k+'_precio')?.value);
      setMoney($('#vin_d_'+k+'_ud'), ud);
      if($('#vin_d_'+k+'_on')?.checked) sum += ud;
    });
    const pill = $('#vinil_pro_adic'); if(pill) pill.textContent = fmtEU(sum);
    const legacy = $('#vinil_adicionales'); if(legacy) legacy.textContent = fmtEU(sum);
    return sum;
  }
  function vinil_dep_sum(){
    let sum = 0;
    ['impresora','plancha','pc','plotter','cuchilla','tapete'].forEach(k=>{
      const on = document.querySelector('.dep_enabled[data-row="'+k+'"]')?.checked;
      const precio = parseEU(document.querySelector('.dep_precio[data-row="'+k+'"]')?.value);
      if(k==='cuchilla' || k==='tapete'){
        const vida = parseEU(document.querySelector('.dep_vida[data-row="'+k+'"]')?.value);
        const ud = vida>0 ? (precio/vida) : 0;
        const udEl = document.querySelector('.dep_ud[data-row="'+k+'"]'); if(udEl) setMoney(udEl, ud);
        if(on) sum += ud;
      }else{
        const mes = precio>0 ? (precio/24/100) : 0;
        const mesEl = document.querySelector('.dep_mes[data-row="'+k+'"]'); if(mesEl) setMoney(mesEl, mes);
        if(on) sum += mes;
      }
    });
    const pdep = $('#vinil_pro_dep'); if(pdep) pdep.textContent = fmtEU(sum);
    const ldep = $('#vinil_dep'); if(ldep) ldep.textContent = fmtEU(sum);
    return sum;
  }
  function recalc_all_vinil(){
    const dir = vinil_directos_base();
    const adic = vinil_extras_sum();
    const dep = vinil_dep_sum();
    const pdir = $('#vinil_pro_directos'); if(pdir) pdir.textContent = fmtEU(dir);
    const ldir = $('#vinil_directos'); if(ldir) ldir.textContent = fmtEU(dir);
    try{
      window._vinilExtras = adic;
      if(typeof window.vinil_pro_adjust === 'function') window.vinil_pro_adjust();
      if(typeof window.vinil_actualizarTotal === 'function') window.vinil_actualizarTotal();
    }catch(e){}
  }
  function bind(){
    ['#cd_enabled','#cd_cant','#cd_precio',
     '#vin_d_papel_on','#vin_d_papel_cant','#vin_d_papel_precio',
     '#vin_d_cinta_on','#vin_d_cinta_cant','#vin_d_cinta_precio',
     '#vin_d_tinta_on','#vin_d_tinta_cant','#vin_d_tinta_precio'
    ].forEach(sel=>{ const el = $(sel); if(el && !el.__wiredV){ el.__wiredV=true; el.addEventListener('input', recalc_all_vinil, true); el.addEventListener('change', recalc_all_vinil, true);} });
    $$('.dep_enabled,.dep_precio,.dep_vida').forEach(el=>{ if(!el.__wiredV){ el.__wiredV=true; el.addEventListener('input', recalc_all_vinil, true); el.addEventListener('change', recalc_all_vinil, true);} });
    setTimeout(recalc_all_vinil, 0);
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind);
  else bind();
})();
</script>
<script>
(function(){
  const card = document.getElementById('vinil_costos_directos');
  function safe(){ try{ if (typeof recalc_all_vinil==='function') recalc_all_vinil(); }catch(e){} }
  if(card && !card.__delegated){
    card.__delegated = true;
    card.addEventListener('input', safe, true);
    card.addEventListener('change', safe, true);
    setTimeout(safe, 0);
  }
})();
</script>
<script>
(function(){
  if(!window.__vinilInitRef){
    window.__vinilInitRef = true;
    function fire(){ try{ if(typeof recalc_all_vinil==='function') recalc_all_vinil(); }catch(e){} }
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', fire);
    else setTimeout(fire,0);
  }
})();
</script>
<script id="vinil-logic-v24-fix">
(() => {
  const R = document.querySelector("#view-vinil");
  if (!R) return;
  const $ = (s, r=R) => r.querySelector(s);
  const $$ = (s, r=R) => Array.from(r.querySelectorAll(s));
  const parseEU = v => {
    if (v == null) return 0;
    if (typeof v === "number") return v;
    v = (""+v).replace(/\$/g,"").replace(/\s/g,"");
    if (v.includes(",")) v = v.replace(/\./g,"").replace(",", ".");
    const n = parseFloat(v);
    return isNaN(n) ? 0 : n;
  };
  const fmtEU = n => {
    if (!isFinite(n)) n = 0;
    const s = (Math.round(n*100)/100).toFixed(2);
    const [i,d] = s.split(".");
    return "$ " + i.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + "," + d;
  };
  const fmtUSD = n => "$" + (Math.round((n||0)*100)/100).toFixed(2);

  // --- refs
  const cd_enabled = $("#cd_enabled");
  const cd_cant = $("#cd_cant");
  const cd_precio = $("#cd_precio");
  const cd_ud = $("#cd_costo_ud");

  const d_items = [
    {on:"#vin_d_papel_on", cant:"#vin_d_papel_cant", precio:"#vin_d_papel_precio", ud:"#vin_d_papel_ud"},
    {on:"#vin_d_cinta_on", cant:"#vin_d_cinta_cant", precio:"#vin_d_cinta_precio", ud:"#vin_d_cinta_ud"},
    {on:"#vin_d_tinta_on", cant:"#vin_d_tinta_cant", precio:"#vin_d_tinta_precio", ud:"#vin_d_tinta_ud"}
  ].map(s => ({ on:$(s.on), cant:$(s.cant), precio:$(s.precio), ud:$(s.ud) }));

  const depRows = ["impresora","plancha","pc","plotter","cuchilla","tapete"];
  const dep = depRows.map(r => ({
    on:   R.querySelector(`.dep_enabled[data-row="${r}"]`),
    p:    R.querySelector(`.dep_precio[data-row="${r}"]`),
    vida: R.querySelector(`.dep_vida[data-row="${r}"]`),
    mes:  R.querySelector(`.dep_mes[data-row="${r}"]`),
    ud:   R.querySelector(`.dep_ud[data-row="${r}"]`),
    key:  r
  }));

  // Indirectos & GI & MO
  const ind_on = $("#vin_ind_on");
  const ind_inputs = ["#vin_ind_alquiler","#vin_ind_internet","#vin_ind_suscripciones","#vin_ind_transporte","#vin_ind_electricidad","#vin_ind_publicidad","#vin_ind_otros"].map(s => $(s));
  const ind_units = $("#vin_ind_units");
  const ind_pill = $("#vin_ind_ud");

  const g_on = $("#vin_chk_ganancia");
  const g_in = $("#vin_ganancia");
  const i_on = $("#vin_chk_impuestos");
  const i_in = $("#vin_impuestos");

  const mo_on = $("#vin_mo_on");
  const mo = {
    sueldo: $("#vin_mo_sueldo"),
    horas:  $("#vin_mo_horas_mes"),
    setup:  $("#vin_mo_setup"),
    run:    $("#vin_mo_run"),
    units:  $("#vin_mo_units"),
    pill:   $("#vin_mo_pill"),
    val:    $("#vin_mo_val"),
  };

  // Salidas
  const out = {
    pro_directos: $("#vinil_pro_directos"),
    pro_dep: $("#vinil_pro_dep"),
    pro_adic: $("#vinil_pro_adic"),
    pro_merma: $("#vinil_pro_merma"),
    pro_total: $("#vinil_pro_total"),
    subtotal_no_gi: $("#vin_subtotal_no_gi"),
    subtotal: $("#vin_subtotal"),
    g_val: $("#vin_ganancia_val"),
    i_val: $("#vin_impuestos_val"),
    total: $("#vin_total"),
    legacy_dir: $("#vinil_directos"),
    legacy_dep: $("#vinil_dep"),
    legacy_adic: $("#vinil_adicionales"),
    legacy_total: $("#totalFinal"),
  };

  // Visual ancho/merma (no afecta cálculos)
  const anchoStd = $("#ancho_estandar");
  const bordeLado = $("#borde_lado");
  const anchoEf = $("#ancho_efectivo");
  const mermaPct = $("#merma_pct");
  const mermaRange = $("#merma_range");
  const updateAncho = () => {
    if (!anchoStd || !bordeLado || !anchoEf) return;
    const eff = Math.max(0, parseEU(anchoStd.value) - 2*parseEU(bordeLado.value));
    anchoEf.textContent = eff ? eff.toFixed(1) + " cm" : "—";
  };
  const syncMerma = (e) => {
    if (!mermaPct || !mermaRange) return;
    if (e?.target === mermaPct) mermaRange.value = mermaPct.value;
    if (e?.target === mermaRange) mermaPct.value = mermaRange.value;
    out.pro_merma && (out.pro_merma.textContent = (parseEU(mermaPct.value)||0).toFixed(0) + "%");
  };

  function calc(){
    // DIRECTOS
    let directos = 0;
    // producto principal (suma SI y SOLO SI el checkbox está activo)
    if (cd_enabled?.checked) {
      const c = parseEU(cd_cant?.value);
      const p = parseEU(cd_precio?.value);
      const ud = c>0 ? p/c : 0;
      cd_ud && (cd_ud.value = fmtEU(ud));
      directos += ud;
    } else {
      cd_ud && (cd_ud.value = fmtEU(0));
    }
    // resto de directos
    d_items.forEach(it => {
      if (!it.cant || !it.precio || !it.ud) return;
      const c = parseEU(it.cant.value);
      const p = parseEU(it.precio.value);
      const ud = c>0 ? p/c : 0;
      it.ud.value = fmtEU(ud);
      if (it.on?.checked) directos += ud;
    });

    // DEPRECIACIÓN (cada fila independiente; tapete usa vida)
    let depTotal = 0;
    dep.forEach(row => {
      if (!row.p || !row.ud) return;
      const price = parseEU(row.p.value);
      let ud = 0;
      if (row.vida){ // con vida → precio/vida
        const vida = Math.max(1, parseEU(row.vida.value));
        ud = price / vida;
        row.mes && (row.mes.value = fmtEU(0));
      } else {       // sin vida → precio/24meses/100uds
        const mes = price / 24;
        ud = mes / 100;
        row.mes && (row.mes.value = fmtEU(mes));
      }
      row.ud.value = fmtEU(ud);
      if (row.on?.checked) depTotal += ud;
    });

    // INDIRECTOS
    let indUd = 0;
    if (ind_on?.checked){
      const units = Math.max(1, parseEU(ind_units?.value));
      const monthly = ind_inputs.reduce((s,el)=> s + parseEU(el?.value), 0);
      indUd = monthly / units;
    }
    ind_pill && (ind_pill.textContent = fmtEU(indUd));

    // MANO DE OBRA
    let moUd = 0;
    if (mo_on?.checked){
      const sueldo = parseEU(mo.sueldo?.value);
      const horas  = Math.max(1, parseEU(mo.horas?.value));
      const setup  = parseEU(mo.setup?.value);
      const run    = parseEU(mo.run?.value);
      const units  = Math.max(1, parseEU(mo.units?.value));
      const vHora  = sueldo / horas;
      moUd = vHora * ((setup/units + run) / 60);
      mo.pill && (mo.pill.style.display = "");
      mo.val && (mo.val.textContent = fmtEU(moUd));
    } else {
      mo.pill && (mo.pill.style.display = "none");
      mo.val && (mo.val.textContent = fmtEU(0));
    }

    // SUBTOTALES + GI
    const subtotal_no_gi = directos + depTotal + moUd;
    const gval = g_on?.checked ? subtotal_no_gi * (parseEU(g_in?.value)/100) : 0;
    const ival = i_on?.checked ? subtotal_no_gi * (parseEU(i_in?.value)/100) : 0;
    const total = subtotal_no_gi + gval + ival;

    // PINTAR — Resumen de Vinil (solo lo de arriba)
    out.pro_directos && (out.pro_directos.textContent = fmtUSD(directos));
    out.pro_dep      && (out.pro_dep.textContent      = fmtUSD(depTotal));
    out.pro_total    && (out.pro_total.textContent    = fmtUSD(directos + depTotal));

    // PINTAR — Totales abajo
    out.subtotal_no_gi && (out.subtotal_no_gi.textContent = fmtUSD(subtotal_no_gi));
    out.subtotal       && (out.subtotal.textContent       = fmtUSD(subtotal_no_gi));
    out.g_val          && (out.g_val.textContent          = fmtUSD(gval));
    out.i_val          && (out.i_val.textContent          = fmtUSD(ival));
    out.total          && (out.total.textContent          = fmtUSD(total));

    // Legacy (otras vistas)
    out.legacy_dir   && (out.legacy_dir.textContent   = fmtEU(directos));
    out.legacy_dep   && (out.legacy_dep.textContent   = fmtEU(depTotal));
    // No tocar #vinil_adicionales aquí (es Adicionales vinil, no Indirectos)
    out.legacy_total && (out.legacy_total.textContent = "Total Vinil: " + fmtEU(subtotal_no_gi));
}

  // Wire minimal listeners
  const watchers = [
    cd_enabled, cd_cant, cd_precio,
    ...d_items.flatMap(it => [it.on, it.cant, it.precio]),
    ...dep.flatMap(r => [r.on, r.p, r.vida]),
    ind_on, ...ind_inputs, ind_units,
    g_on, g_in, i_on, i_in,
    mo_on, mo.sueldo, mo.horas, mo.setup, mo.run, mo.units,
    anchoStd, bordeLado, mermaPct, mermaRange
  ].filter(Boolean);
  watchers.forEach(el => { el.addEventListener("input", calc); el.addEventListener("change", calc); });

  // Inicial
  const vin_mo_cfg_btn = $("#vin_mo_cfg_btn");
  const vin_mo_cfg = $("#vin_mo_cfg");
  vin_mo_cfg_btn && vin_mo_cfg && vin_mo_cfg_btn.addEventListener("click", () => {
    vin_mo_cfg.style.display = vin_mo_cfg.style.display === "none" || !vin_mo_cfg.style.display ? "block" : "none";
  });
  updateAncho(); syncMerma(); calc();
  window.__vinil_calc_v24__ = { calc };
})();
</script>
<script>
// --- Injected patch: Vinil module guard + EU formatting + correct totals (non-destructive) ---
(function(){
  // LEGACY VINIL PATCH DISABLED: lógica reemplazada por vinil_rewrite_logic (V32)
  return;

  const $ = (q,ctx=document)=>ctx.querySelector(q);
  const $$ = (q,ctx=document)=>Array.from(ctx.querySelectorAll(q));

  // EU formatter / parser
  function fmtEU(n){
    if (isNaN(n) || n == null) n = 0;
    const parts = Number(n).toFixed(2).split('.');
    const int = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return '$ ' + int + ',' + parts[1];
  }
  function parseAny(txt){
    if (typeof txt !== 'string') return (Number(txt)||0);
    // Try EU $ 1.234,56
    let t = txt.trim();
    // remove currency and spaces
    t = t.replace(/[^\d,\.\-]/g,'');
    // if has comma as decimal and dots as thousands
    if (t.includes(',') && (t.lastIndexOf(',') > t.lastIndexOf('.'))) {
      t = t.replace(/\./g,'').replace(',','.');
    }
    // else assume dot decimal
    let v = parseFloat(t);
    return isNaN(v) ? 0 : v;
  }

  // Guard to avoid re-entrant updates that cause flicker
  let _vin_updating = false;
  function guard(fn){
    if (_vin_updating) return;
    _vin_updating = true;
    try { fn && fn(); } finally { _vin_updating = false; }
  }

  // Recompute bottom card consistently using displayed partials (directos, dep, indirectos, MO)
  function vin_recompute_totals(){
    const root = $('#view-vinil');
    if (!root) return;
    const dirTxt = $('#vinil_pro_directos')?.textContent || '0';
    const depTxt = $('#vinil_pro_dep')?.textContent || '0';
    const indOn  = $('#vin_ind_on')?.checked || false;
    const indTxt = $('#vin_ind_ud')?.textContent || '0';
    const moOn   = $('#vin_mo_on')?.checked || false;
    const moTxt  = $('#vin_mo_val')?.textContent || '0';

    const dir = parseAny(dirTxt);
    const dep = parseAny(depTxt);
    const ind = indOn ? parseAny(indTxt) : 0;
    const mo  = moOn ? parseAny(moTxt) : 0;

    const subtotalNoGI = dir + dep + ind + mo;

    const giBox = $('#vinil_gi_card');
    if (giBox){
      // pintar "Total sin G/I" y "Subtotal" en EU
      const subNoGiEl = $('#vin_subtotal_no_gi');
      if (subNoGiEl) subNoGiEl.textContent = fmtEU(subtotalNoGI);

      const subEl = $('#vin_subtotal');
      if (subEl) subEl.textContent = fmtEU(subtotalNoGI);

      // Ganancia / Impuestos
      const ganOn = $('#vin_chk_ganancia')?.checked ?? true;
      const impOn = $('#vin_chk_impuestos')?.checked ?? true;
      const ganPct = parseAny($('#vin_ganancia')?.value || '0');
      const impPct = parseAny($('#vin_impuestos')?.value || '0');

      const ganVal = ganOn ? subtotalNoGI * (ganPct/100) : 0;
      const impVal = impOn ? (subtotalNoGI + ganVal) * (impPct/100) : 0;

      const ganEl = $('#vin_ganancia_val');
      if (ganEl) ganEl.textContent = fmtEU(ganVal);
      const impEl = $('#vin_impuestos_val');
      if (impEl) impEl.textContent = fmtEU(impVal);

      const totalEl = $('#vin_total');
      if (totalEl) totalEl.textContent = fmtEU(subtotalNoGI + ganVal + impVal);
    }

    // Top "Total Vinil" debe incluir Directos + Depreciación + Indirectos (no G/I)
    const topTotal = $('#vinil_pro_total');
    if (topTotal){
      topTotal.textContent = fmtEU(dir + dep + ind);
    }

    // Normalizar formato EU en los pill superiores
    const normEU = ['#vinil_pro_directos','#vinil_pro_dep','#vinil_pro_adic','#vinil_pro_total'];
    normEU.forEach(sel => {
      const el = $(sel);
      if (!el) return;
      const v = parseAny(el.textContent);
      el.textContent = fmtEU(v);
    });

    // Mostrar/ocultar MO pill
    const moPill = $('#vin_mo_pill');
    if (moPill) moPill.style.display = moOn && parseAny(moTxt) > 0 ? '' : 'none';
  }

  // Attach guarded wrappers to existing functions (non-destructive)
  ['recalc_all_vinil','vinil_actualizarTotal','vin_update_total'].forEach(name=>{
    const orig = window[name];
    if (typeof orig === 'function'){
      window[name] = function(){
        return guard(function(){
          const out = orig.apply(this, arguments);
          vin_recompute_totals();
          return out;
        });
      };
    }
  });

  // Also recalc on typical inputs in the GI card
  const root = document;
  const triggers = ['#vin_chk_ganancia','#vin_chk_impuestos','#vin_ganancia','#vin_impuestos',
                    '#vin_ind_on','#vin_mo_on'];
  function bind(el){
    if (!el) return;
    ['input','change'].forEach(ev=>el.addEventListener(ev, ()=>guard(vin_recompute_totals)));
  }
  triggers.forEach(sel=>bind($(sel, root)));

  // Run once after load (small delay to let original scripts wire up)
  window.addEventListener('load', ()=> setTimeout(()=>guard(vin_recompute_totals), 120));
})();
</script>
<script>
// --- Injected patch: Vinil Reset unificado (apaga todos los checkboxes del módulo) ---
(function(){
  const $ = (q,ctx=document)=>ctx.querySelector(q);
  const $$ = (q,ctx=document)=>Array.from(ctx.querySelectorAll(q));
  function offAllVinil(){
    const root = $('#view-vinil');
    if (!root) return;
    $$("input[type=checkbox]", root).forEach(ch=>{ ch.checked = false; });
    const moCfg = $('#vin_mo_cfg'); if (moCfg) moCfg.style.display = 'none';
    const indCfg = $('#vin_ind_cfg'); if (indCfg) indCfg.style.display = 'none';
    if (typeof window.recalc_all_vinil === 'function') window.recalc_all_vinil();
    if (typeof window.vin_update_total === 'function') window.vin_update_total();
  }
  const btn = document.getElementById('btn_reset_vinil');
  if (btn && !btn.__patched){
    btn.__patched = true;
    btn.addEventListener('click', offAllVinil);
  }
})();
</script>
<!-- Patch: Esferas -> mostrar SIEMPRE los costos Ud. -->
<script>
(function(){
  const $ = (q,ctx=document)=>ctx.querySelector(q);
  const $$ = (q,ctx=document)=>Array.from(ctx.querySelectorAll(q));
  function fmtEU(n){ if(isNaN(n)||n==null)n=0; const parts=Number(n).toFixed(2).split('.'); const i=parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,'.'); return '$ ' + i + ',' + parts[1]; }
  function p(txt){ if(typeof txt!=='string') return Number(txt)||0; let t=txt.replace(/[^\d,\.\-]/g,''); if(t.includes(',') && t.lastIndexOf(',')>t.lastIndexOf('.')){ t=t.replace(/\./g,'').replace(',','.'); } const v=parseFloat(t); return isNaN(v)?0:v; }
  function unit(c,pr){ const cc=p(c), pp=p(pr); return cc>0? pp/cc : 0; }

  function calc_directos_always(){
    let tot=0;
    const prodUd = unit($('#esf_d_prod_cant').value, $('#esf_d_prod_precio').value);
    const prodUdEl = $('#esf_d_prod_ud'); if (prodUdEl) prodUdEl.value = fmtEU(prodUd);
    if($('#esf_d_prod_on')?.checked) tot += prodUd;

    const vinUd = unit($('#esf_d_vinil_cant').value, $('#esf_d_vinil_precio').value);
    const vinEl = $('#esf_d_vinil_ud'); if (vinEl) vinEl.value = fmtEU(vinUd);
    if($('#esf_d_vinil_on')?.checked) tot += vinUd;

    const papUd = unit($('#esf_d_papel_cant').value, $('#esf_d_papel_precio').value);
    const papEl = $('#esf_d_papel_ud'); if (papEl) papEl.value = fmtEU(papUd);
    if($('#esf_d_papel_on')?.checked) tot += papUd;

    const nivUd = unit($('#esf_d_nieve_cant').value, $('#esf_d_nieve_precio').value);
    const nivEl = $('#esf_d_nieve_ud'); if (nivEl) nivEl.value = fmtEU(nivUd);
    if($('#esf_d_nieve_on')?.checked) tot += nivUd;

    const extUd = unit($('#esf_d_extra_cant').value, $('#esf_d_extra_precio').value);
    const extEl = $('#esf_d_extra_ud'); if (extEl) extEl.value = fmtEU(extUd);
    if($('#esf_d_extra_on')?.checked) tot += extUd;

    const uds = Math.max(1, parseInt($('#esf_d_cinta_udxrollo').value||'45',10));
    const pr  = p($('#esf_d_cinta_precio').value);
    const cinUd = pr / uds;
    const cinEl = $('#esf_d_cinta_ud'); if (cinEl) cinEl.value = fmtEU(cinUd);
    if($('#esf_d_cinta_on')?.checked) tot += cinUd;

    const silUd = unit($('#esf_d_silicon_cant').value, $('#esf_d_silicon_precio').value);
    const silEl = $('#esf_d_silicon_ud'); if (silEl) silEl.value = fmtEU(silUd);
    if($('#esf_d_silicon_on')?.checked) tot += silUd;

    const totEl = $('#esf_total_directos'); if (totEl) totEl.textContent = fmtEU(tot);
    return tot;
  }

  function calc_depr_always(){
    let tot=0; const unitsPerMonth=100;
    ['impresora','plancha','pc','plotter','cuchilla','tapete','pistola'].forEach(r=>{
      const on = $(`.esf_dep_on[data-row="${r}"]`)?.checked;
      const precio = p($(`.esf_dep_precio[data-row="${r}"]`)?.value||0);
      const vida = p($(`.esf_dep_vida[data-row="${r}"]`)?.value||0);
      let ud=0, mes=0;
      if(r==='cuchilla' || r==='tapete'){ ud = vida>0 ? (precio/vida) : 0; }
      else { mes = precio/24; ud = mes/unitsPerMonth; }
      const mesEl = $(`.esf_dep_mes[data-row="${r}"]`); if (mesEl) mesEl.value = fmtEU(mes);
      const udEl  = $(`.esf_dep_ud[data-row="${r}"]`);  if (udEl)  udEl.value  = fmtEU(ud);
      if(on) tot += ud;
    });
    const totEl = $('#esf_total_depr'); if (totEl) totEl.textContent = fmtEU(tot);
    return tot;
  }

  function calc_indirectos_patch(){
    const on = $('#esf_ind_on')?.checked;
    const fields=['alquiler','internet','suscripciones','transporte','electricidad','publicidad','otros'];
    let mens=0; fields.forEach(k=> mens += p($(`#esf_ind_${k}`).value||0));
    const units=Math.max(1,parseInt($('#esf_ind_units').value||'100',10));
    const ud = mens/units; // siempre visible
    const udEl = $('#esf_ind_ud'); if (udEl) udEl.textContent = fmtEU(ud);
    return on ? ud : 0;
  }

  function calc_mo_patch(){
    const sueldo=p($('#esf_mo_sueldo').value||0);
    const horasMes=p($('#esf_mo_horas_mes').value||0);
    const setupMin=p($('#esf_mo_setup').value||0);
    const runMin=p($('#esf_mo_run').value||0);
    const units=Math.max(1,p($('#esf_mo_units').value||1));
    const costoMin=(horasMes>0)?(sueldo/(horasMes*60)):0;
    const totalMin=setupMin + (runMin*units);
    const val=(totalMin*costoMin)/units;
    const valEl = $('#esf_mo_val'); if (valEl) valEl.textContent=fmtEU(val);
    const pill = $('#esf_mo_pill'); if (pill) pill.style.display = $('#esf_mo_on').checked && val>0 ? '' : 'none';
    return $('#esf_mo_on').checked ? val : 0;
  }

  function recalc_all_patch(){
    const d = calc_directos_always();
    const e = calc_depr_always();
    const i = calc_indirectos_patch();
    const mo = calc_mo_patch();
    const subNoGI = d + e + i + mo;
    const a = $('#esf_subtotal_no_gi'); if (a) a.textContent=fmtEU(subNoGI);
    const b = $('#esf_subtotal'); if (b) b.textContent=fmtEU(subNoGI);
    const ganOn=$('#esf_chk_ganancia')?.checked;
    const impOn=$('#esf_chk_impuestos')?.checked;
    const ganPct=p($('#esf_ganancia')?.value||0);
    const impPct=p($('#esf_impuestos')?.value||0);
    const mode=(document.getElementById('esf_modo_ganancia')?.value||'markup');
    const ganVal=ganOn? (mode==='margen' ? subNoGI*(ganPct/ (100-ganPct)) : subNoGI*(ganPct/100)) : 0;
    const impVal=impOn? (subNoGI+ganVal)*(impPct/100):0;
    const gv = $('#esf_ganancia_val'); if (gv) gv.textContent=fmtEU(ganVal);
    const iv = $('#esf_impuestos_val'); if (iv) iv.textContent=fmtEU(impVal);
    const tot = $('#esf_total'); if (tot) tot.textContent=fmtEU(subNoGI+ganVal+impVal);
  }

  const root=document.getElementById('view-esferas-navidenas');
  if(root){
    $$('input,select', root).forEach(el=>{ ['input','change'].forEach(ev=> el.addEventListener(ev, recalc_all_patch)); });
    window.addEventListener('load', recalc_all_patch);

    // [Esferas] Botón "Exportar a PDF / Imprimir" (patrón Sublimación v15)
    const esfPrintBtn = document.getElementById('esf_btn_print');
    if(esfPrintBtn){
      esfPrintBtn.addEventListener('click', function(){
        const views = document.querySelectorAll('.view');
        const wasActive = Array.prototype.map.call(views, v => v.classList.contains('active'));
        views.forEach(v => v.classList.remove('active'));
        root.classList.add('active');
        setTimeout(()=>window.print(), 30);
        setTimeout(()=>{
          views.forEach((v,i)=>{ if(wasActive[i]) v.classList.add('active'); });
        }, 1000);
      });
    }
  }
})();
</script>
<div class="overlay" id="overlay"></div>
<aside aria-hidden="true" aria-label="Navegación principal" class="drawer" id="drawer">
<header style="justify-content:center; text-align:center;"><div class="brand-dot" style="margin-right:12px;"></div><div class="brand-name">Menú</div></header>
<nav class="menu" id="menu"><div class="group">Módulos</div><div class="item" data-view="vinil">
<svg class="ico" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24"><circle cx="9" cy="12" r="3"></circle><path d="M2 12h5M12 12h10"></path></svg>
<div class="txt">Costo de Vinil</div>
</div>
<div class="item" data-view="sublimacion">
<svg class="ico" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24"><path d="M4 7h16M7 7v10a3 3 0 0 0 3 3h4a3 3 0 0 0 3-3V7"></path></svg>
<div class="txt">Costos Sublimación</div>
</div>
<div class="item" data-view="esferas-navidenas">
<svg class="ico" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24"><circle cx="12" cy="13" r="7"></circle><path d="M12 6V3m0 0h3m-3 0H9"></path></svg>
<div class="txt">Esferas navideñas</div>
</div>
<div class="item" data-view="dtf">
<svg class="ico" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24"><rect height="14" rx="3" width="18" x="3" y="4"></rect><path d="M8 8h8M7 12h10M9 16h6"></path></svg>
<div class="txt">Costos DTF (terceros)</div>
</div>
<div class="item" data-view="papeleria">
<svg class="ico" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24"><path d="M7 3h8l4 4v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"></path><path d="M15 3v4h4"></path></svg>
<div class="txt">Costos de Papelería</div>
</div>
<div class="item" data-view="etiquetas">
<svg class="ico" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24"><path d="M20 12l-8 8-8-8 8-8 8 8z"></path><circle cx="12" cy="12" r="2"></circle></svg>
<div class="txt">Costos de Etiquetas</div>
</div>
<div class="item" data-view="empaques">
<svg class="ico" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24"><path d="M3 9l9-6 9 6-9 6-9-6z"></path><path d="M21 9v6l-9 6-9-6V9"></path></svg>
<div class="txt">Costos de Empaques</div>
</div>
<div class="item" data-view="envios">
<svg class="ico" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24"><path d="M3 7h13v10H3zM16 10h4l1 3v4h-5z"></path><circle cx="7.5" cy="17" r="1.5"></circle><circle cx="18.5" cy="17" r="1.5"></circle></svg>
<div class="txt">Costos de Envíos</div>
</div>
<div class="item" data-view="resumen">
<svg class="ico" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24"><path d="M4 4h16v16H4z"></path><path d="M8 10h8M8 14h5"></path></svg>
<div class="txt">Resumen General</div>
</div>
<div class="item" data-view="conversor">
<svg class="ico" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24"><path d="M4 4h7v7H4zM13 13h7v7h-7zM13 4h7v7h-7zM4 13h7v7H4z"></path></svg>
<div class="txt">Conversor de Unidades</div>
</div>
<div class="item" data-view="basica">
<svg class="ico" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24"><rect height="16" rx="3" width="18" x="3" y="4"></rect><path d="M7 9h10M7 13h6"></path></svg>
<div class="txt">Calculadora Básica</div>
</div>
<div class="item" data-view="personalizado">
<svg aria-hidden="true" class="ico" fill="none" stroke="currentColor" stroke-width="1.75" viewbox="0 0 24 24">
<path d="M4 4h7v7H4zM13 4h7v7h-7zM4 13h7v7H4z"></path>
</svg>
<div class="txt">Producto personalizable</div>
</div>
<div class="item" data-view="instrucciones">
<svg class="ico" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24"><path d="M12 20l-7-4V6l7-4 7 4v10l-7 4z"></path><path d="M9 9h6M9 13h6"></path></svg>
<div class="txt">Instrucciones / Configuración</div>
</div>
</nav>
</aside>
<script>
(function(){
  const btn = document.getElementById('btnMenu');
  const overlay = document.getElementById('overlay');
  const drawer = document.getElementById('drawer');
  const menu = document.getElementById('menu');

  function openDrawer(){ if(!overlay || !drawer) return; overlay.style.opacity='1'; overlay.style.pointerEvents='auto'; drawer.style.transform='translateX(0)'; drawer.setAttribute('aria-hidden','false'); }
  function closeDrawer(){ if(!overlay || !drawer) return; overlay.style.opacity='0'; overlay.style.pointerEvents='none'; drawer.style.transform='translateX(-105%)'; drawer.setAttribute('aria-hidden','true'); }

  btn && btn.addEventListener('click', openDrawer);
  overlay && overlay.addEventListener('click', closeDrawer);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

  // Robust navigation: map dataset view -> real element id
  function findViewEl(key){
    // 1) Try exact id "view-<key>"
    let el = document.getElementById('view-' + key);
    if (el) return el;
    // 2) Try common synonyms
    const aliases = {
      'dtf':'dtf',
      'vinil':'vinil',
      'sublimacion':'sublimacion',
      'esferas-navidenas':'esferas-navidenas',
      'papeleria':'papeleria',
      'etiquetas':'etiquetas',
      'empaques':'empaques',
      'envios':'envios',
      'resumen':'resumen',
      'conversor':'conversor',
      'basica':'basica',
      'instrucciones':'instrucciones'
    };
    const k = aliases[key] || key;
    el = document.getElementById('view-' + k);
    if (el) return el;
    // 3) Fallback: substring search among .view
    const all = document.querySelectorAll('.view[id]');
    for (const v of all){ if (v.id && v.id.indexOf(key) >= 0) return v; }
    return null;
  }

  function goToView(key){
    const all = document.querySelectorAll('.view');
    all.forEach(v => { v.classList.remove('active'); v.style.display='none'; });
    const el = findViewEl(key);
    if (el){
      el.classList.add('active');
      el.style.display='block';
      // quitar bloqueo visual (evita parpadeo al restaurar última vista)
      document.documentElement.classList.remove('booting');
      window.scrollTo({top:0, behavior:'smooth'});
      try{ localStorage.setItem('last_view', key); localStorage.setItem('Suite.has_opened','1'); }catch(_){ }
    } else {
      // Fallback seguro para evitar pantalla en blanco
      console.warn('Vista no encontrada:', key);
      if (key !== 'instrucciones'){
        return goToView('instrucciones');
      }
      document.documentElement.classList.remove('booting');
    }
  }

  // Expose for external usage
  window.selectView = goToView;

  // Init: primera apertura -> Instrucciones; siguientes -> última vista
  (function(){
    const DEFAULT_VIEW = 'instrucciones';
    let target = DEFAULT_VIEW;
    try{
      // Preferir el valor calculado antes del primer paint (evita parpadeo)
      const pre = (document.documentElement.getAttribute('data-start-view') || '').trim();
      if (pre) target = pre;
      // Asegurar marca de apertura
      localStorage.setItem('Suite.has_opened','1');
    }catch(_){}

    // Marcar item activo en el menú
    if (menu){
      menu.querySelectorAll('.item').forEach(el=>el.removeAttribute('data-active'));
      const active = menu.querySelector('.item[data-view="' + target + '"]');
      if (active) active.setAttribute('data-active','true');
    }

    // Ir a la vista destino
    goToView(target);
  })();

  // Drawer menu
  menu && menu.addEventListener('click',(e)=>{
    const item = e.target.closest('.item');
    if(!item) return;
    const view = item.dataset.view;
    // Visual state
    menu.querySelectorAll('.item').forEach(el=>el.removeAttribute('data-active'));
    item.setAttribute('data-active','true');
    // Change view
    goToView(view);
    // Emit event + close
    window.dispatchEvent(new CustomEvent('menu:navigate',{detail:{view}}));
    closeDrawer();
  });
})();
</script>
<script>
// === Esferas: Toggle panel "Configurar" Mano de obra (no afecta checkbox) ===
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  ready(function(){
    var btn = document.getElementById('esf_mo_cfg_btn');
    var panel = document.getElementById('esf_mo_cfg');
    if(!btn || !panel) return;
    // Ensure initial state
    if (!panel.style.display) panel.style.display = 'none';
    btn.addEventListener('click', function(){
      var show = (panel.style.display === 'none' || panel.style.display === '');
      panel.style.display = show ? 'flex' : 'none';
    });
  });
})();
</script>
<script>
(function(){
  // === Personalizado Module (isolated) ===
  const LS_KEY = 'Suite.pers.products';

  // EU helpers (proxy Suite.* if present)
  function pers_parseEU(str){
    try{
      if(window.Suite && typeof Suite.parseEU==='function') return Suite.parseEU(str);
    }catch(e){}
    if(typeof str!=='string') str = String(str ?? '');
    str = str.trim().replace(/\./g,'').replace(',', '.');
    const v = parseFloat(str);
    return isNaN(v) ? 0 : v;
  }
  function pers_euro(num){
    try{
      if(window.Suite && typeof Suite.euro==='function') return Suite.euro(num);
    }catch(e){}
    const n = Number(num||0);
    return '$ ' + n.toFixed(2).replace('.', ',');
  }

  // Storage
  function loadAll(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); }catch(e){ return []; }
  }
  function saveAll(arr){
    localStorage.setItem(LS_KEY, JSON.stringify(arr));
  }

  // UI refs (lazy)
	  let view, nameI, dirWrap, areaOnEl, areaWrap, areaTotalEl, areaAddBtn, depWrap, addDirBtn, addDepBtn, indOn, indMensual, indUnits,
      moOn, moSueldo, moHorasMes, moSetup, moRun, moUnits,
      gMode, gOn, gPct, iOn, iPct,
      pills = {}, actions = {}, loaderSel, importI, importCatalogI, importModeSel;

  function q(sel, root=document){ return root.querySelector(sel); }
  function el(tag, attrs={}, children=[]){
    const e = document.createElement(tag);
    Object.entries(attrs).forEach(([k,v])=>{
      if(k==='class') e.className = v;
      else if(k==='text') e.textContent = v;
      else e.setAttribute(k, v);
    });
    children.forEach(c=> e.appendChild(c));
    return e;
  }

  // Dynamic rows
  function makeDirRow(data={}){
    const row = el('div', {class:'row pers-dep-row', style:'gap:8px;align-items:flex-end;margin-top:6px;flex-wrap:nowrap;overflow-x:auto'});
    row.innerHTML = `
      <div style="min-width:220px;flex:2">
        <label>Descripción</label>
        <input type="text" class="pers-dir-desc" value="${(data.desc||'')}" />
      </div>
      <div style="min-width:100px;flex:1">
        <label>Cant.</label>
        <input type="text" class="pers-dir-cant" value="${(data.cant||'1')}" />
      </div>
      <div style="min-width:140px;flex:1">
        <label>Precio ($)</label>
        <input type="text" class="pers-dir-precio" value="${(data.precio||'0,00')}" />
      </div>
      <div style="min-width:160px;flex:1">
        <label>Costo Ud.</label>
        <input type="text" class="ud pers-dir-ud" value="$ 0,00" readonly />
      </div>
      <div style="min-width:140px;flex:1">
        <label>Cant. a utilizar</label>
        <input type="text" class="pers-dir-utilcant" value="${(data.utilcant||'1')}" />
      </div>
      <div style="min-width:170px;flex:1">
        <label>Costo utilizado</label>
        <input type="text" class="ud pers-dir-used" value="$ 0,00" readonly />
      </div>
      <div>
        <button class="copy-btn" type="button">Eliminar</button>
      </div>
    `;
    q('.copy-btn', row).addEventListener('click', ()=>{ row.remove(); update(); });
    ['input'].forEach(ev=>{
      row.addEventListener(ev, (e)=>{
        if(e.target.matches('input')) update();
      }, true);
    });
    return row;
  }

  function makeDepRow(data={}){
    const row = el('div', {class:'row pers-dep-row', style:'gap:8px;align-items:flex-end;margin-top:6px;flex-wrap:nowrap;overflow-x:auto'});
    const modoVida = (data.modo||'vida')==='vida';
    row.innerHTML = `
      <div style="min-width:200px;flex:2">
        <label>Equipo</label>
        <input type="text" class="pers-dep-desc" value="${(data.desc||'')}" />
      </div>
      <div style="min-width:120px;flex:1">
        <label>Precio ($)</label>
        <input type="text" class="pers-dep-precio" value="${(data.precio||'0,00')}" />
      </div>
      <div style="min-width:150px;flex:1">
        <label>Modo</label>
        <select class="pers-dep-modo">
          <option value="vida" ${modoVida?'selected':''}>Vida útil (usos)</option>
          <option value="capacidad" ${!modoVida?'selected':''}>Capacidad/mes + meses</option>
        </select>
      </div>
      <div class="pers-dep-vida-wrap" style="min-width:120px;flex:1;${modoVida?'':'display:none'}">
        <label>Vida (usos)</label>
        <input type="text" class="pers-dep-vida" value="${(data.vida||'100')}" />
      </div>
      <div class="pers-dep-cap-wrap" style="display:${modoVida?'none':'flex'};gap:8px;flex:0 0 auto;align-items:flex-end;min-width:10px">
        <div class="pers-dep-col-meses" style="min-width:72px;flex:0 0 72px">
          <label>Meses</label>
          <input type="text" class="pers-dep-meses" value="${(data.meses||'24')}" />
        </div>
        <div class="pers-dep-col-cap" style="min-width:96px;flex:0 0 96px">
          <label>Cap./mes (uds)</label>
          <input type="text" class="pers-dep-capacidad" value="${(data.capacidad||'100')}" />
        </div>
      </div>
      <div style="min-width:130px;flex:1">
        <label>Costo Ud.</label>
        <input type="text" class="ud pers-dep-ud" value="$ 0,00" readonly />
      </div>
      <div style="min-width:120px;flex:1">
        <label>Cant. de usos</label>
        <input type="text" class="pers-dep-usos" value="${(data.usos||'1')}" />
      </div>
      <div style="min-width:140px;flex:1">
        <label>Costo utilizado</label>
        <input type="text" class="ud pers-dep-used" value="$ 0,00" readonly />
      </div>
      <div style="flex:0 0 auto">
        <button class="copy-btn" type="button">Eliminar</button>
      </div>
    `;
    const modoSel = q('.pers-dep-modo', row);
    const vidaWrap = q('.pers-dep-vida-wrap', row);
    const capWrap  = q('.pers-dep-cap-wrap', row);
    modoSel.addEventListener('change', ()=>{
      const m = modoSel.value;
      vidaWrap.style.display = (m==='vida')?'block':'none';
      capWrap.style.display = (m==='vida')?'none':'block';
      update();
    });
    q('.copy-btn', row).addEventListener('click', ()=>{ row.remove(); update(); });
    row.addEventListener('input', (e)=>{ if(e.target.matches('input,select')) update(); }, true);
    return row;
  }

	// Material por área (cm²) — múltiples materiales (bloque independiente)
	function makeAreaRow(data={}){
	  const row = el('div', {class:'row pers-area-row', style:'gap:10px;align-items:flex-end;margin-top:10px;flex-wrap:wrap'});
	  const mode = (data.modo||'cm2');
	  row.innerHTML = `
	    <div style="min-width:200px;flex:2">
	      <label>Nombre del material</label>
	      <input type="text" class="pers-area-name" value="${(data.nombre||'')}" placeholder="Ej. Vinil adhesivo impreso" />
	    </div>
<div style="min-width:170px;flex:0 0 auto">
	      <label>Modo de precio</label>
	      <select class="pers-area-mode">
	        <option value="cm2" ${mode==='cm2'?'selected':''}>Precio por cm²</option>
	        <option value="rollo" ${mode==='rollo'?'selected':''}>Precio por rollo</option>
	      </select>
	    </div>

	    <div class="pers-area-cm2" style="min-width:160px;flex:0 0 auto;${mode==='cm2'?'':'display:none'}">
	      <label>Precio por cm² ($)</label>
	      <input type="text" class="pers-area-pcm2" value="${(data.precio_cm2||'0,00')}" />
	    </div>

	    <div class="pers-area-rollo" style="display:${mode==='rollo'?'flex':'none'};gap:8px;flex-wrap:wrap;align-items:flex-end">
	      <div style="min-width:160px">
	        <label>Precio del rollo ($)</label>
	        <input type="text" class="pers-area-prollo" value="${(data.precio_rollo||'0,00')}" />
	      </div>
	      <div style="min-width:120px">
	        <label>Ancho rollo (cm)</label>
	        <input type="text" class="pers-area-ancho" value="${(data.ancho_rollo||'0')}" />
	      </div>
	      <div style="min-width:120px">
	        <label>Largo rollo (m)</label>
	        <input type="text" class="pers-area-largo" value="${(data.largo_rollo||'0')}" />
	      </div>
	    </div>

	    <div style="min-width:120px">
	      <label>Ancho a usar (cm)</label>
	      <input type="text" class="pers-area-usoancho" value="${(data.ancho_uso||'0')}" />
	    </div>
	    <div style="min-width:120px">
	      <label>Alto a usar (cm)</label>
	      <input type="text" class="pers-area-usoalto" value="${(data.alto_uso||'0')}" />
	    </div>
	    <div style="min-width:110px">
	      <label>Cantidad</label>
	      <input type="text" class="pers-area-cant" value="${(data.cantidad||'1')}" />
	    </div>
	    <div style="min-width:110px">
	      <label>Merma (%)</label>
	      <input type="text" class="pers-area-merma" value="${(data.merma||'0')}" />
	    </div>

	    <div style="min-width:170px;flex:1">
	      <label>Precio por cm² (calc.)</label>
	      <div class="pill"><span class="pers-area-pill-pcm2">$ 0,00</span></div>
	    </div>
	    <div style="min-width:160px;flex:1">
	      <label>Área total (cm²)</label>
	      <div class="pill"><span class="pers-area-pill-area">0</span></div>
	    </div>
	    <div style="min-width:170px;flex:1">
	      <label>Costo del material</label>
	      <div class="pill"><strong class="pers-area-pill-cost">$ 0,00</strong></div>
	    </div>

	    <div style="flex:0 0 auto">
	      <button class="copy-btn pers-area-del" type="button">Eliminar</button>
	    </div>
	  `;
	  return row;
	}

  // Build view on DOMContentLoaded to avoid touching existing code
  function buildView(){
    if(document.getElementById('view-personalizado')) return; // already injected

    // (removed) Add nav button
// Add the view section
    const app = document.querySelector('.app');
    const views = Array.from(document.querySelectorAll('.view'));
    const lastView = views[views.length-1];
    const sec = document.createElement('section');
    sec.className = 'view';
    sec.id = 'view-personalizado';
    sec.innerHTML = `
      <div class="grid">
        <div class="card md-12">
          <h3 style="margin:0 0 6px">Producto personalizable</h3>
          <div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
            <div style="min-width:260px;flex:2">
              <label>Nombre del producto</label>
              <input id="pers_name" type="text" placeholder="Ej. Taza Premium 11oz">
            </div>
            <div class="row" style="gap:8px">
              <button class="btn ok" id="pers_save">Guardar</button>
              <select id="pers_load" style="min-width:220px"><option value="">— Cargar guardado —</option></select>
              <button class="btn neutral" id="pers_delete">Borrar</button>
              <button class="btn" id="pers_export_json">Exportar Producto</button>
              <button class="btn" id="pers_export_csv">Exportar CSV</button>
              <label class="btn" style="cursor:pointer">
                Importar Producto
                <input id="pers_import" type="file" accept="application/json" style="display:none">
              </label>

              <span class="pill" style="background:#eef6ff">Catálogo</span>
              <button class="btn" id="pers_export_catalog_json">Exportar Catálogo (JSON)</button>
              <button class="btn" id="pers_export_catalog_csv">Exportar Catálogo (CSV)</button>
              <select id="pers_import_mode" style="min-width:170px">
                <option value="merge" selected>Fusionar</option>
                <option value="replace">Reemplazar</option>
              </select>
              <label class="btn" style="cursor:pointer">
                Importar Catálogo
                <input id="pers_import_catalog" type="file" accept=".json,.csv,application/json,text/csv" style="display:none">
              </label>
            </div>
          </div>
        </div>

		<div class="card md-12" id="pers_area_card">
		  <div class="row" style="gap:10px;flex-wrap:wrap;align-items:center">
		    <label class="chk-label" style="display:flex;align-items:center;gap:8px;margin:0">
		      <input id="pers_area_on" type="checkbox"/> Activar
		    </label>
		    <div style="flex:1;min-width:220px">
		      <h4 style="margin:0">Material por área (cm²)</h4>
		    </div>
		    <div class="pill">Total materiales por área: <strong id="pers_area_total">$ 0,00</strong></div>
		    <button class="btn" id="pers_area_cfg" type="button">Configurar</button>
		  </div>

		  <div id="pers_area_body" style="display:none;margin-top:10px">
		    <div class="muted" style="margin:0 0 10px">
		      Calcula materiales con medidas variables usando cm² (pendones, vinil impreso, laminado, etc.).
		    </div>
		    <div id="pers_area_list"></div>
		    <div class="row" style="gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px">
		      <div style="flex:1"></div>
		      <button class="btn ok" id="pers_area_add" type="button">Agregar material por área</button>
		    </div>
		  </div>
		</div>

        <div class="card md-12" id="pers_directos_card">
          <h4 style="margin:0 0 6px">Costos directos</h4>
          <div id="pers_directos"></div>
          <div class="center-actions"><button class="btn ok" id="pers_add_dir">Agregar línea</button></div>
        </div>

        <div class="card md-12" id="pers_depreciacion_card">
          <h4 style="margin:0 0 6px">Depreciación de equipos</h4>
          <div id="pers_depreciacion"></div>
          <div class="center-actions"><button class="btn ok" id="pers_add_dep">Agregar equipo</button></div>
        </div>

        
<div class="card md-12 indA-card" id="pers_ind_card">
  <div class="row" style="align-items:center;gap:12px">
    <label class="chk-label" style="display:flex;align-items:center;gap:8px">
      <input id="pers_ind_on" type="checkbox"/> Activar
    </label>
    <div class="pill indA-pill">Costo Ud. (indirectos): <span id="pers_ind_ud" class="result">—</span></div>
    <button class="btn" id="pers_ind_cfg_btn" type="button">Configurar</button>
  </div>
  <div id="pers_ind_cfg" style="margin-top:8px;display:none">
    <div class="row" style="gap:12px;flex-wrap:wrap">
      <div style="min-width:180px;flex:1"><label>Alquiler (mensual)</label><input id="pers_ind_alquiler" type="text" value="0,00"></div>
      <div style="min-width:180px;flex:1"><label>Internet (mensual)</label><input id="pers_ind_internet" type="text" value="0,00"></div>
      <div style="min-width:180px;flex:1"><label>Suscripciones (mensual)</label><input id="pers_ind_suscripciones" type="text" value="0,00"></div>
      <div style="min-width:180px;flex:1"><label>Transporte (mensual)</label><input id="pers_ind_transporte" type="text" value="0,00"></div>
      <div style="min-width:180px;flex:1"><label>Electricidad (mensual)</label><input id="pers_ind_electricidad" type="text" value="0,00"></div>
      <div style="min-width:180px;flex:1"><label>Publicidad (mensual)</label><input id="pers_ind_publicidad" type="text" value="0,00"></div>
      <div style="min-width:180px;flex:1"><label>Otros (mensual)</label><input id="pers_ind_otros" type="text" value="0,00"></div>
      <div style="min-width:160px;flex:1"><label>Unidades/mes</label><input id="pers_ind_units" type="text" value="100"></div>
    </div>
    <!-- Campo oculto/compatibilidad para la lógica existente -->
    <input id="pers_ind_mensual" type="text" value="0,00" style="display:none">
  </div>
</div>

<div class="card md-12" id="pers_mo_card">

          <div class="row" style="align-items:center;gap:12px">
            <label class="chk-label" style="display:flex;align-items:center;gap:8px">
              <input id="pers_mo_on" type="checkbox"/> Activar mano de obra
            </label>
            <div class="pill">MO por Ud.: <span id="pers_mo_ud" class="result">—</span></div>
            <button class="btn" id="pers_mo_cfg_btn" type="button">Configurar</button>
          </div>
          <div id="pers_mo_cfg" style="margin-top:8px;display:none">
            <div class="row">
              <div style="min-width:140px"><label>Sueldo mensual ($)</label><input id="pers_mo_sueldo" type="text" value="0,00"></div>
              <div style="min-width:140px"><label>Horas/mes</label><input id="pers_mo_horas" type="text" value="160"></div>
              <div style="min-width:140px"><label>Setup (min)</label><input id="pers_mo_setup" type="text" value="0"></div>
              <div style="min-width:140px"><label>Run (min)</label><input id="pers_mo_run" type="text" value="0"></div>
              <div style="min-width:140px"><label>Unidades</label><input id="pers_mo_units" type="text" value="1"></div>
            </div>
          </div>
        </div>

        <div class="card md-12" id="pers_gi_card">
          <h4 style="margin:0 0 6px">Ganancia / Impuestos</h4>
          <div class="row" style="gap:12px;align-items:center;flex-wrap:wrap">
		  <label class="chk-label" style="display:flex;align-items:center;gap:8px">
              <input id="pers_g_on" type="checkbox"/> Aplicar Ganancia
            </label>
            <div>
              <label>Modo</label>
              <select id="pers_gmode">
                <option value="Margen">Margen</option>
                <option value="Markup">Markup</option>
              </select>
            </div>
            <div style="min-width:120px"><label>Ganancia (%)</label><input id="pers_g_pct" type="text" value="30"></div>
            <label class="chk-label" style="display:flex;align-items:center;gap:8px">
              <input id="pers_i_on" type="checkbox"/> Aplicar Impuesto
            </label>
            <div style="min-width:120px"><label>Impuesto (%)</label><input id="pers_i_pct" type="text" value="16"></div>
          </div>
        </div>

        <div class="card md-12" id="pers_summary">
          <h4 style="margin:0 0 6px">Resumen</h4>
          <div class="row" style="gap:10px;flex-wrap:wrap">
            <div class="pill">Directos: <strong id="pers_pill_dir">—</strong></div>
            <div class="pill">Depreciación: <strong id="pers_pill_dep">—</strong></div>
            <div class="pill">Indirectos: <strong id="pers_pill_ind">—</strong></div>
            <div class="pill">Mano de obra: <strong id="pers_pill_mo">—</strong></div>
            <div class="pill">Subtotal: <strong id="pers_pill_sub">—</strong></div>
            <div class="pill">+ Ganancia: <strong id="pers_pill_g">—</strong></div>
            <div class="pill">+ Impuestos: <strong id="pers_pill_i">—</strong></div>
          </div>
          <div class="sep"></div>
          <div class="tot">Precio de Venta: <span id="pers_pv">$ 0,00</span></div>
		  <div class="center-actions">
          <button class="btn reset" id="pers_reset">Reset</button>
        </div>
        </div>


        <div class="card md-12" id="pers_qty_card">
          <h4 style="margin:0 0 6px">Cantidad de productos</h4>

          <div class="row" style="align-items:center;gap:8px;flex-wrap:wrap">
            <label class="chk-label" style="display:flex;align-items:center;gap:6px;margin:0">
              <input type="checkbox" id="pers_qty_on">
              <span>Activar cantidad</span>
            </label>

            <input type="number" id="pers_qty" min="1" step="1" value="1" style="max-width:100px">

            <span class="muted">
              Multiplica los valores finales del producto por la cantidad Q (solo vista).
            </span>
          </div>

          <div class="sep"></div>

          <div class="row" style="flex-wrap:wrap;gap:8px">
            <div class="pill"><span>Base sin G/I ×Q</span><span class="result mono" id="pers_qty_base">$ 0,00</span></div>
            <div class="pill"><span>Subtotal ×Q</span><span class="result mono" id="pers_qty_subtotal">$ 0,00</span></div>
            <div class="pill"><span>Ganancia ×Q</span><span class="result mono" id="pers_qty_g">$ 0,00</span></div>
            <div class="pill"><span>Impuestos ×Q</span><span class="result mono" id="pers_qty_i">$ 0,00</span></div>
            <div class="pill"><span>Total ×Q</span><span class="result mono" id="pers_qty_total">$ 0,00</span></div>
          </div>
        </div>
      </div>
    `;
    (lastView && lastView.parentNode) ? lastView.parentNode.insertBefore(sec, lastView.nextSibling) : app.appendChild(sec);

    // cache refs
    view = sec;
    nameI = q('#pers_name', view);
    dirWrap = q('#pers_directos', view);
	    areaOnEl = q('#pers_area_on', view);
	    areaWrap = q('#pers_area_list', view);
	    areaTotalEl = q('#pers_area_total', view);
	    areaAddBtn = q('#pers_area_add', view);
    depWrap = q('#pers_depreciacion', view);
    addDirBtn = q('#pers_add_dir', view);
    addDepBtn = q('#pers_add_dep', view);
    indOn = q('#pers_ind_on', view);
    indMensual = q('#pers_ind_mensual', view);
    indUnits = q('#pers_ind_units', view);
    moOn = q('#pers_mo_on', view);
    moSueldo = q('#pers_mo_sueldo', view);
    moHorasMes = q('#pers_mo_horas', view);
    moSetup = q('#pers_mo_setup', view);
    moRun = q('#pers_mo_run', view);
    moUnits = q('#pers_mo_units', view);
    const moCfgBtn = q('#pers_mo_cfg_btn', view);
    gMode = q('#pers_gmode', view);
    gOn = q('#pers_g_on', view);
    gPct = q('#pers_g_pct', view);
    iOn = q('#pers_i_on', view);
    iPct = q('#pers_i_pct', view);
    loaderSel = q('#pers_load', view);
    importI = q('#pers_import', view);
    importCatalogI = q('#pers_import_catalog', view);
    importModeSel = q('#pers_import_mode', view);
    // Indirectos detallados
    const indAlq = q('#pers_ind_alquiler', view);
    const indInt = q('#pers_ind_internet', view);
    const indSus = q('#pers_ind_suscripciones', view);
    const indTra = q('#pers_ind_transporte', view);
    const indEle = q('#pers_ind_electricidad', view);
    const indPub = q('#pers_ind_publicidad', view);
    const indOtr = q('#pers_ind_otros', view);
    const indCfgBtn = q('#pers_ind_cfg_btn', view);

    function recalcIndirectosMensual(){
      // Suma por rubros -> indMensual (formato EU)
      const sum = [
        indAlq,indInt,indSus,indTra,indEle,indPub,indOtr
      ].map(el => el ? pers_parseEU(el.value) : 0).reduce((a,b)=>a+b,0);
      indMensual.value = pers_euro(sum).replace('$ ',''); // guardamos solo número EU
    }

    if (indCfgBtn){
      indCfgBtn.addEventListener('click', ()=>{
        const box = q('#pers_ind_cfg', view);
        if (box){
          const show = (box.style.display!=='block');
          box.style.display = show ? 'block' : 'none';
        }
      });
    }

    // MO Configurar (solo muestra/oculta el panel, sin tocar el checkbox)
    if (moCfgBtn){
      moCfgBtn.addEventListener('click', (ev)=>{
        ev.preventDefault();
        ev.stopPropagation();
        const box = q('#pers_mo_cfg', view);
        if (!box) return;
        const hidden = (getComputedStyle(box).display === 'none');
        box.style.display = hidden ? 'block' : 'none';
        // Permite abrir el panel aun si el checkbox está apagado (sin tocar el checkbox)
        box.dataset.forcedOpen = hidden ? '1' : '';
      });
    }

[indAlq,indInt,indSus,indTra,indEle,indPub,indOtr].forEach(inp=>{
      if(!inp) return;
      inp.addEventListener('input', ()=>{ recalcIndirectosMensual(); update(); });
    });
    

    pills = {
      dir: q('#pers_pill_dir', view),
      dep: q('#pers_pill_dep', view),
      ind: q('#pers_pill_ind', view),
      mo:  q('#pers_pill_mo', view),
      sub: q('#pers_pill_sub', view),
      g:   q('#pers_pill_g', view),
      i:   q('#pers_pill_i', view),
      pv:  q('#pers_pv', view),
      indUd: q('#pers_ind_ud', view),
      moUd:  q('#pers_mo_ud', view),
    };

    // events
    addDirBtn.addEventListener('click', ()=>{ dirWrap.appendChild(makeDirRow()); update(); });
    addDepBtn.addEventListener('click', ()=>{ depWrap.appendChild(makeDepRow()); update(); });

    indOn.addEventListener('change', ()=>{ q('#pers_ind_cfg', view).style.display = indOn.checked?'block':'none'; update(); });
    [indMensual, indUnits].forEach(inp=> inp.addEventListener('input', update));

    moOn.addEventListener('change', ()=>{ const box=q('#pers_mo_cfg', view); if(!moOn.checked){ if(box){ box.style.display='none'; box.dataset.forcedOpen=''; } } update(); });
[moSueldo, moHorasMes, moSetup, moRun, moUnits].forEach(inp=> inp.addEventListener('input', update));

    [gMode, gOn, gPct, iOn, iPct].forEach(inp=> inp.addEventListener('input', update));

    q('#pers_save', view).addEventListener('click', saveCurrent);
    q('#pers_delete', view).addEventListener('click', deleteCurrent);
    q('#pers_export_json', view).addEventListener('click', exportJSON);
    q('#pers_export_csv', view).addEventListener('click', exportCSV);
    importI.addEventListener('change', onImport);

    // Catálogo completo (backup / batch)
    q('#pers_export_catalog_json', view).addEventListener('click', exportCatalogJSON);
    q('#pers_export_catalog_csv', view).addEventListener('click', exportCatalogCSV);
    if (importCatalogI) importCatalogI.addEventListener('change', onImportCatalog);

    q('#pers_reset', view).addEventListener('click', reset);

	    // Material por área (cm²) — event delegation + add
    if (areaOnEl){ areaOnEl.addEventListener('change', update); }
	    if (areaAddBtn && areaWrap){
	      areaAddBtn.addEventListener('click', ()=>{ areaWrap.appendChild(makeAreaRow({})); update(); });
	    }
	    const areaCard = q('#pers_area_card', view);
	    if (areaCard){
	      const areaHandler = (ev)=>{
	        const t = ev.target;
	        // Siempre recalcular al escribir/cambiar cualquier campo del card (aunque el target no esté dentro de una fila)
	        if (ev.type==='input' || ev.type==='change') update();
	
	        const row = t && t.closest ? t.closest('.pers-area-row') : null;
	        if (ev.type==='click'){
	          const del = t.closest && t.closest('.pers-area-del');
	          if (del && row){ row.remove(); update(); return; }
	        }
	        if (row && t && t.classList && t.classList.contains('pers-area-mode')){
	          const mode = t.value;
	          const cm2Box = q('.pers-area-cm2', row);
	          const rolloBox = q('.pers-area-rollo', row);
	          if (cm2Box) cm2Box.style.display = (mode==='cm2') ? 'block' : 'none';
	          if (rolloBox) rolloBox.style.display = (mode==='rollo') ? 'flex' : 'none';
	          update();
	        }
	      };
	      areaCard.addEventListener('input', areaHandler, true);
	      areaCard.addEventListener('change', areaHandler, true);
	      areaCard.addEventListener('click', areaHandler, true);
	    }

	    
	    // Material por área (cm²) — Configurar (colapsable, igual a Mano de Obra)
	    const areaCfgBtn = q('#pers_area_cfg', view);
	    const areaBody = q('#pers_area_body', view);
	    if (areaBody) areaBody.style.display = 'none';
	    if (areaCfgBtn && areaBody){
	      areaCfgBtn.addEventListener('click', ()=>{
	        const open = areaBody.style.display !== 'none';
	        areaBody.style.display = open ? 'none' : 'block';
	        update();
	      });
	    }

// first rows
	    dirWrap.appendChild(makeDirRow({desc:'', cant:'1', precio:'0,00'}));
	    if (areaWrap) areaWrap.appendChild(makeAreaRow({}));
	    depWrap.appendChild(makeDepRow({desc:'', precio:'0,00', modo:'vida', vida:'100'}));

    refreshLoader();
    update();
  }

  // Update calculations
  function update(){
    // directos
    let dirTotal = 0;
    dirWrap.querySelectorAll('.row').forEach(r=>{
      const cant = pers_parseEU(q('.pers-dir-cant', r).value);
      const precio = pers_parseEU(q('.pers-dir-precio', r).value);
      const ud = cant>0 ? (precio / cant) : 0;
      q('.pers-dir-ud', r).value = pers_euro(ud);

      const util = Math.max(0, pers_parseEU(q('.pers-dir-utilcant', r).value || '1'));
      const used = ud * util;
      q('.pers-dir-used', r).value = pers_euro(used);

      dirTotal += used;
    });

	    // Material por área (cm²)
	    let areaTotal = 0;
	    if (areaWrap){
	      areaWrap.querySelectorAll('.pers-area-row').forEach(r=>{
	        const on = true;
        const mode = q('.pers-area-mode', r)?.value || 'cm2';
	        let precioCm2 = 0;
	        if (mode === 'cm2'){
	          precioCm2 = pers_parseEU(q('.pers-area-pcm2', r)?.value);
	        } else {
	          const pr = pers_parseEU(q('.pers-area-prollo', r)?.value);
	          const ancho = pers_parseEU(q('.pers-area-ancho', r)?.value);
	          const largoM = pers_parseEU(q('.pers-area-largo', r)?.value);
	          const areaRollo = ancho * (largoM * 100); // cm² (NO m²)
	          precioCm2 = areaRollo>0 ? (pr / areaRollo) : 0;
	        }

	        const usoA = pers_parseEU(q('.pers-area-usoancho', r)?.value);
	        const usoH = pers_parseEU(q('.pers-area-usoalto', r)?.value);
	        const cant = Math.max(0, pers_parseEU(q('.pers-area-cant', r)?.value || '1'));
	        const merma = Math.max(0, pers_parseEU(q('.pers-area-merma', r)?.value || '0'));
	        const areaPieza = usoA * usoH; // cm²
	        const areaTotalBase = areaPieza * cant;
	        const areaFinal = areaTotalBase * (1 + merma/100);
	        const costo = areaFinal * precioCm2;

	        const pillPCM2 = q('.pers-area-pill-pcm2', r);
	        const pillArea = q('.pers-area-pill-area', r);
	        const pillCost = q('.pers-area-pill-cost', r);
	        if (pillPCM2){
          const v = (isFinite(precioCm2)?precioCm2:0);
          pillPCM2.textContent = '$ ' + v.toFixed(6).replace('.', ',');
        }
        if (pillArea) pillArea.textContent = (isFinite(areaFinal)?areaFinal:0).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2});
	        if (pillCost) pillCost.textContent = pers_euro(costo);

	        if (on) areaTotal += costo;
	      });
	    }
	    const _areaOn = areaOnEl ? !!areaOnEl.checked : true;
	    if (areaTotalEl) areaTotalEl.textContent = pers_euro(_areaOn ? areaTotal : 0);
	    if (_areaOn) dirTotal += areaTotal;
// dep
    let depTotal = 0;
    depWrap.querySelectorAll('.row').forEach(r=>{
      const precio = pers_parseEU(q('.pers-dep-precio', r).value);
      const modo = q('.pers-dep-modo', r).value;
      let ud = 0;
      if(modo==='vida'){
        const vida = pers_parseEU(q('.pers-dep-vida', r).value);
        ud = vida>0 ? (precio / vida) : 0;
      }else{
        const meses = pers_parseEU(q('.pers-dep-meses', r).value);
        const cap = pers_parseEU(q('.pers-dep-capacidad', r).value);
        const porMes = meses>0 ? (precio / meses) : 0;
        ud = cap>0 ? (porMes / cap) : 0;
      }
      q('.pers-dep-ud', r).value = pers_euro(ud);

      const usos = Math.max(0, pers_parseEU(q('.pers-dep-usos', r).value || '1'));
      const used = ud * usos;
      q('.pers-dep-used', r).value = pers_euro(used);

      depTotal += used;
    });

    // indirectos
    let indUd = 0;
    if(indOn.checked){
      const mens = pers_parseEU(indMensual.value);
      const units = pers_parseEU(indUnits.value);
      indUd = units>0 ? (mens/units) : 0;
    }
    pills.indUd.textContent = pers_euro(indUd);

    // mano de obra
    let moUd = 0;
    if(moOn.checked){
      const sueldo = pers_parseEU(moSueldo.value);
      const horasMes = pers_parseEU(moHorasMes.value);
      const setup = pers_parseEU(moSetup.value);
      const run = pers_parseEU(moRun.value);
      const units = pers_parseEU(moUnits.value);
      const valorMin = (horasMes>0) ? (sueldo / (horasMes*60)) : 0;
      const minsTot = setup + run;
      moUd = (units>0) ? (valorMin * minsTot / units) : 0;
    }
    pills.moUd.textContent = pers_euro(moUd);

    const subtotal = dirTotal + depTotal + (indOn.checked?indUd:0) + (moOn.checked?moUd:0);

    // GI
    let G = 0, I = 0;
    const g_on = gOn.checked, i_on = iOn.checked;
    const gp = pers_parseEU(gPct.value)/100;
    const ip = pers_parseEU(iPct.value)/100;
    if(g_on){
      if(gMode.value==='Margen'){
        // margen m sobre PV => G = m/(1-m) * Subtotal
        G = (gp>=1)? 0 : (subtotal * gp / (1 - gp));
      }else{
        // markup: G = Subtotal * gp
        G = subtotal * gp;
      }
    }
    const baseImp = subtotal + G;
    if(i_on){
      I = baseImp * ip;
    }

    const pv = subtotal + G + I;

    // render pills
    pills.dir.textContent = pers_euro(dirTotal);
    pills.dep.textContent = pers_euro(depTotal);
    pills.ind.textContent = pers_euro(indOn.checked?indUd:0);
    pills.mo.textContent  = pers_euro(moOn.checked?moUd:0);
    pills.sub.textContent = pers_euro(subtotal);
    pills.g.textContent   = pers_euro(G);
    pills.i.textContent   = pers_euro(I);
    pills.pv.textContent  = pers_euro(pv);

	    // sync resumen
	    if (typeof window.resumen_update === 'function') window.resumen_update();
  }

  // Save/load
  
  // Save/load
  function currentToJSON(){
    const data = {
      name: nameI.value.trim() || 'Producto sin nombre',
      directos: [],
	      materiales_area: [],
      depreciacion: [],
      indirectos: {},
      mo: {},
      gi: {}
    };

    // Directos
    if (dirWrap){
      dirWrap.querySelectorAll('.row').forEach(function(r){
        const descEl   = q('.pers-dir-desc', r);
        const cantEl   = q('.pers-dir-cant', r);
        const precioEl = q('.pers-dir-precio', r);
        data.directos.push({
          desc:   descEl   ? (descEl.value   || '') : '',
          cant:   cantEl   ? (cantEl.value   || '') : '',
          precio: precioEl ? (precioEl.value || '') : '',
          utilcant: (q('.pers-dir-utilcant', r)?.value || '')
        });
      });
    }

    // Depreciación
    if (depWrap){
      depWrap.querySelectorAll('.row').forEach(function(r){
        const modoEl   = q('.pers-dep-modo', r);
        const descEl   = q('.pers-dep-desc', r);
        const precioEl = q('.pers-dep-precio', r);
        const modo = modoEl ? modoEl.value : 'vida';
        const item = {
          desc:   descEl   ? (descEl.value   || '') : '',
          precio: precioEl ? (precioEl.value || '') : '',
          modo: modo,
          usos: (q('.pers-dep-usos', r)?.value || '')
        };
        if (modo === 'vida'){
          const vidaEl = q('.pers-dep-vida', r);
          item.vida = vidaEl ? (vidaEl.value || '') : '';
        }else{
          const mesesEl = q('.pers-dep-meses', r);
          const capEl   = q('.pers-dep-capacidad', r);
          item.meses     = mesesEl ? (mesesEl.value || '') : '';
          item.capacidad = capEl   ? (capEl.value   || '') : '';
        }

        data.depreciacion.push(item);
      });
    }

	    // Material por área (cm²)
	    if (areaWrap){
	      areaWrap.querySelectorAll('.pers-area-row').forEach(function(r){
	        data.materiales_area.push({
	          nombre: (q('.pers-area-name', r)?.value || ''),
	          incluir: true,
	          modo: (q('.pers-area-mode', r)?.value || 'cm2'),
	          precio_cm2: (q('.pers-area-pcm2', r)?.value || ''),
	          precio_rollo: (q('.pers-area-prollo', r)?.value || ''),
	          ancho_rollo: (q('.pers-area-ancho', r)?.value || ''),
	          largo_rollo: (q('.pers-area-largo', r)?.value || ''),
	          ancho_uso: (q('.pers-area-usoancho', r)?.value || ''),
	          alto_uso: (q('.pers-area-usoalto', r)?.value || ''),
	          cantidad: (q('.pers-area-cant', r)?.value || ''),
	          merma: (q('.pers-area-merma', r)?.value || ''),
	        });
	      });
	    }

	    // Material por área (cm²)
	    if (areaWrap){
	      areaWrap.innerHTML = '';
	      (data.materiales_area || []).forEach(function(m){
	        areaWrap.appendChild(makeAreaRow(m || {}));
	      });
	      if (!areaWrap.children.length){
	        areaWrap.appendChild(makeAreaRow({}));
	      }
	    }

    // Indirectos
    const ind = {};
    if (indOn) ind.on = !!indOn.checked;
    if (indMensual) ind.mensual = indMensual.value || '0,00';
    if (indUnits) ind.units = indUnits.value || '100';

    function grab(id, defVal){
      const el = q('#' + id, view);
      return el ? (el.value || defVal) : defVal;
    }
    ind.alquiler      = grab('pers_ind_alquiler', '0,00');
    ind.internet      = grab('pers_ind_internet', '0,00');
    ind.suscripciones = grab('pers_ind_suscripciones', '0,00');
    ind.transporte    = grab('pers_ind_transporte', '0,00');
    ind.electricidad  = grab('pers_ind_electricidad', '0,00');
    ind.publicidad    = grab('pers_ind_publicidad', '0,00');
    ind.otros         = grab('pers_ind_otros', '0,00');
    data.indirectos = ind;

    // Mano de obra
    const moData = {};
    if (moOn)       moData.on       = !!moOn.checked;
    if (moSueldo)   moData.sueldo   = moSueldo.value   || '0,00';
    if (moHorasMes) moData.horasMes = moHorasMes.value || '160';
    if (moSetup)    moData.setupMin = moSetup.value    || '0';
    if (moRun)      moData.runMin   = moRun.value      || '0';
    if (moUnits)    moData.units    = moUnits.value    || '1';
    data.mo = moData;

    // Ganancia / Impuestos
    const giData = {};
    if (gMode) giData.modo = gMode.value || 'Margen';
    if (gOn){
      giData.gOn = !!gOn.checked;
      giData.gPct = gPct ? (gPct.value || '0') : '0';
    }
    if (iOn){
      giData.iOn = !!iOn.checked;
      giData.iPct = iPct ? (iPct.value || '0') : '0';
    }
    data.gi = giData;

    return data;
  }



  function fillFromJSON(data){
    data = data || {};

    // Nombre
    if (nameI) nameI.value = data.name || '';

    // Directos
    if (dirWrap){
      dirWrap.innerHTML = '';
      (data.directos || []).forEach(function(d){
        dirWrap.appendChild(makeDirRow(d || {}));
      });
      if (!dirWrap.children.length){
        dirWrap.appendChild(makeDirRow({}));
      }
    }

	    // Material por área (cm²)
	    if (areaWrap){
	      areaWrap.innerHTML = '';
	      (data.materiales_area || []).forEach(function(m){
	        areaWrap.appendChild(makeAreaRow(m || {}));
	      });
	      if (!areaWrap.children.length){
	        areaWrap.appendChild(makeAreaRow({}));
	      }
	    }

    // Depreciación
    if (depWrap){
      depWrap.innerHTML = '';
      (data.depreciacion || []).forEach(function(d){
        depWrap.appendChild(makeDepRow(d || {}));
      });
      if (!depWrap.children.length){
        depWrap.appendChild(makeDepRow({}));
      }
    }

    // Indirectos
    const ind = data.indirectos || {};
    if (indOn) indOn.checked = !!ind.on;
    const indCfgBox = q('#pers_ind_cfg', view);
    if (indCfgBox) indCfgBox.style.display = indOn && indOn.checked ? 'block' : 'none';

    function setVal(id, val, defVal){
      const el = q('#' + id, view);
      if (el) el.value = (val != null && val !== '') ? val : defVal;
    }

    if (indMensual) indMensual.value = (ind.mensual != null && ind.mensual !== '') ? ind.mensual : '0,00';
    if (indUnits)   indUnits.value   = (ind.units   != null && ind.units   !== '') ? ind.units   : '100';

    setVal('pers_ind_alquiler',      ind.alquiler,      '0,00');
    setVal('pers_ind_internet',      ind.internet,      '0,00');
    setVal('pers_ind_suscripciones', ind.suscripciones, '0,00');
    setVal('pers_ind_transporte',    ind.transporte,    '0,00');
    setVal('pers_ind_electricidad',  ind.electricidad,  '0,00');
    setVal('pers_ind_publicidad',    ind.publicidad,    '0,00');
    setVal('pers_ind_otros',         ind.otros,         '0,00');

    if (typeof recalcIndirectosMensual === 'function'){
      recalcIndirectosMensual();
    }

    // Mano de obra
    const mo = data.mo || {};
    if (moOn) moOn.checked = !!mo.on;
    const moCfg = q('#pers_mo_cfg', view);
    if (moCfg) moCfg.style.display = (moOn && moOn.checked) || (moCfg.dataset.forcedOpen==='1') ? 'block' : 'none';

    if (moSueldo)   moSueldo.value   = mo.sueldo   || '0,00';
    if (moHorasMes) moHorasMes.value = mo.horasMes || '160';
    if (moSetup)    moSetup.value    = mo.setupMin || '0';
    if (moRun)      moRun.value      = mo.runMin   || '0';
    if (moUnits)    moUnits.value    = mo.units    || '1';

    // Ganancia / Impuestos
    const gi = data.gi || {};
    if (gMode) gMode.value = gi.modo || 'Margen';
    if (gOn)   gOn.checked = !!gi.gOn;
    if (gPct)  gPct.value  = gi.gPct || '30';
    if (iOn)   iOn.checked = !!gi.iOn;
    if (iPct)  iPct.value  = gi.iPct || '16';

    if (typeof update === 'function'){
      update();
    }
  }


function refreshLoader(){
    const all = loadAll();
    loaderSel.innerHTML = '<option value="">— Cargar guardado —</option>' + all.map((p,i)=> `<option value="${i}">${p.name}</option>`).join('');
    loaderSel.onchange = ()=>{
      const idx = parseInt(loaderSel.value);
      if(!isNaN(idx)){
        const p = all[idx];
        fillFromJSON(p);
      }
    };
  }

  function saveCurrent(){
    const data = currentToJSON();
    const all = loadAll();
    const idx = all.findIndex(p=> (p.name||'').toLowerCase() === data.name.toLowerCase());
    if(idx>=0){
      if(!confirm('Ya existe un producto con ese nombre. ¿Reemplazar?')) return;
      all[idx] = data;
    }else{
      all.push(data);
    }
    saveAll(all);
    refreshLoader();
    alert('Guardado.');
  }
  function deleteCurrent(){
    const name = (nameI.value||'').trim();
    if(!name){ alert('Asigna un nombre primero.'); return; }
    const all = loadAll();
    const idx = all.findIndex(p=> (p.name||'').toLowerCase() === name.toLowerCase());
    if(idx<0){ alert('No existe guardado con ese nombre.'); return; }
    if(!confirm('¿Borrar "'+name+'"?')) return;
    all.splice(idx,1);
    saveAll(all);
    refreshLoader();
    alert('Borrado.');
  }

  function exportJSON(){
    const data = currentToJSON();
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'producto-' + (data.name||'personalizado') + '.json';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function exportCSV(){
    const data = currentToJSON();
    const rows = [];
    rows.push(['Tipo','Descripción','Cantidad','Precio','Vida','Meses','Capacidad','On','Valor']);
    (data.directos||[]).forEach(d=>{
      rows.push(['Directo', d.desc, d.cant, d.precio, '', '', '', '', '']);
    });
    (data.depreciacion||[]).forEach(d=>{
      if(d.modo==='vida'){
        rows.push(['Depreciacion', d.desc, '', d.precio, d.vida, '', '', '', '']);
      }else{
        rows.push(['Depreciacion', d.desc, '', d.precio, '', d.meses, d.capacidad, '', '']);
      }
    });
    rows.push(['Indirectos','Total mensual','', data.indirectos?.mensual || '0,00', '', '', '', data.indirectos?.on ? '1':'0', data.indirectos?.units || '']);
    rows.push(['MO','Sueldo mensual','', data.mo?.sueldo || '0,00', '', '', '', data.mo?.on ? '1':'0', `H:${data.mo?.horasMes||''} Setup:${data.mo?.setupMin||''} Run:${data.mo?.runMin||''} Uds:${data.mo?.units||''}`]);
    rows.push(['GI','Modo', data.gi?.modo || 'Margen', '', '', '', '', '', `G%:${data.gi?.gPct||''} I%:${data.gi?.iPct||''} G:${data.gi?.gOn?'1':'0'} I:${data.gi?.iOn?'1':'0'}`]);

    const csv = rows.map(r=> r.map(x=>{
      const s = (x==null)?'':String(x);
      if(/[",;\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
      return s;
    }).join(';')).join('\n');

    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'}));
    a.download = 'producto-' + (data.name||'personalizado') + '.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  }


  // ====== Catálogo completo (Export/Import masivo) ======
  function catalogKey(p){
    const id = (p && (p.id || p.ID || p._id)) ? String(p.id || p.ID || p._id) : '';
    const name = (p && p.name) ? String(p.name) : '';
    return (id || name).trim().toLowerCase();
  }

  function csvEscapeCell(v){
    const s = (v==null) ? '' : String(v);
    if (/[\";\n\r]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  }

  function exportCatalogJSON(){
    const all = loadAll();
    const blob = new Blob([JSON.stringify(all, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'catalogo-productos-personalizable.json';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function exportCatalogCSV(){
    const all = loadAll();
    const header = ['name','directos','materiales_area','depreciacion','indirectos','mo','gi'];
    const lines = [header.map(csvEscapeCell).join(';')];
    all.forEach(p=>{
      const row = [
        p?.name || '',
        JSON.stringify(p?.directos || []),
        JSON.stringify(p?.materiales_area || []),
        JSON.stringify(p?.depreciacion || []),
        JSON.stringify(p?.indirectos || {}),
        JSON.stringify(p?.mo || {}),
        JSON.stringify(p?.gi || {})
      ];
      lines.push(row.map(csvEscapeCell).join(';'));
    });
    const csv = lines.join('\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'}));
    a.download = 'catalogo-productos-personalizable.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function parseCSV(text){
    const rows = [];
    let row = [];
    let cell = '';
    let inQuotes = false;
    for(let i=0;i<text.length;i++){
      const c = text[i];
      if (inQuotes){
        if (c === '"'){
          if (text[i+1] === '"'){ cell += '"'; i++; }
          else { inQuotes = false; }
        }else{
          cell += c;
        }
      }else{
        if (c === '"'){ inQuotes = true; }
        else if (c === ';'){ row.push(cell); cell=''; }
        else if (c === '\n'){
          row.push(cell); cell='';
          // trim trailing \r
          if (row.length===1 && row[0]==='' && rows.length===0){ row=[]; continue; }
          rows.push(row);
          row=[];
        }else if (c === '\r'){
          // ignore (handled by \n)
        }else{
          cell += c;
        }
      }
    }
    row.push(cell);
    if (row.length>1 || (row.length===1 && row[0]!=='')) rows.push(row);
    return rows;
  }

  function parseCatalogCSV(text){
    const rows = parseCSV(String(text||''));
    if (!rows.length) throw new Error('CSV vacío.');
    const header = rows[0].map(h=>String(h||'').trim());
    const idx = {};
    header.forEach((h,i)=>{ idx[h]=i; });
    if (idx.name == null) throw new Error('CSV inválido: falta columna "name".');

    const out = [];
    for(let r=1;r<rows.length;r++){
      const line = rows[r];
      const name = String(line[idx.name] ?? '').trim();
      if (!name) continue;

      function j(col, fallback){
        const i = idx[col];
        if (i==null) return fallback;
        const raw = String(line[i] ?? '').trim();
        if (!raw) return fallback;
        try{ return JSON.parse(raw); }catch(_){ return fallback; }
      }

      const p = {
        name,
        directos: j('directos', []),
        materiales_area: j('materiales_area', []),
        depreciacion: j('depreciacion', []),
        indirectos: j('indirectos', {}),
        mo: j('mo', {}),
        gi: j('gi', {})
      };
      out.push(p);
    }
    if (!out.length) throw new Error('No se encontraron productos válidos en el CSV.');
    return out;
  }

  function normalizeCatalogData(parsed){
    // Accept: array of products, or {products:[...]} / {catalog:[...]}
    let arr = null;
    if (Array.isArray(parsed)) arr = parsed;
    else if (parsed && Array.isArray(parsed.products)) arr = parsed.products;
    else if (parsed && Array.isArray(parsed.catalog)) arr = parsed.catalog;
    if (!Array.isArray(arr)) throw new Error('Formato inválido. Se esperaba un arreglo de productos.');
    // keep only objects with name or id
    const clean = arr.filter(p=> p && typeof p === 'object' && (String(p.name||'').trim() || String(p.id||p.ID||p._id||'').trim()))
      .map(p=>({ ...p, name: String(p.name||'').trim() || String(p.id||p.ID||p._id||'').trim() }));
    if (!clean.length) throw new Error('No se encontraron productos válidos.');
    return clean;
  }

  function mergeCatalog(existing, incoming){
    const map = new Map();
    existing.forEach(p=>{ map.set(catalogKey(p), p); });
    let replaced = 0, added = 0;
    incoming.forEach(p=>{
      const k = catalogKey(p);
      if (!k) return;
      if (map.has(k)){
        map.set(k, p);
        replaced++;
      }else{
        map.set(k, p);
        added++;
      }
    });
    return { out: Array.from(map.values()), added, replaced };
  }

  function onImportCatalog(ev){
    const file = ev.target.files && ev.target.files[0];
    if(!file) return;
    const mode = (importModeSel && importModeSel.value) ? importModeSel.value : 'merge';

    const reader = new FileReader();
    reader.onload = function(){
      try{
        const raw = String(reader.result || '');
        const isCSV = /\.csv$/i.test(file.name) || (file.type && file.type.includes('csv'));
        let incoming = [];
        if (isCSV){
          incoming = parseCatalogCSV(raw);
        }else{
          const parsed = JSON.parse(raw || 'null');
          incoming = normalizeCatalogData(parsed);
        }

        if (mode === 'replace'){
          saveAll(incoming);
          refreshLoader();
          if (incoming[0]) fillFromJSON(incoming[0]);
          alert('Catálogo importado (Reemplazar). Productos: ' + incoming.length);
        }else{
          const existing = loadAll();
          const merged = mergeCatalog(existing, incoming);
          saveAll(merged.out);
          refreshLoader();
          if (incoming[0]) fillFromJSON(incoming[0]);
          alert('Catálogo importado (Fusionar). Agregados: ' + merged.added + ' · Reemplazados: ' + merged.replaced);
        }
      }catch(e){
        alert('No se pudo importar el catálogo: ' + (e && e.message ? e.message : e));
      }
    };
    reader.readAsText(file);
    ev.target.value = '';
  }

  function onImport(ev){
    const file = ev.target.files && ev.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(){
      try{
        const data = JSON.parse(String(reader.result||'{}'));
        if(!data || !data.name){ alert('JSON inválido.'); return; }
        const all = loadAll();
        const idx = all.findIndex(p=> (p.name||'').toLowerCase() === (data.name||'').toLowerCase());
        if(idx>=0){
          const choice = confirm('Ya existe "'+data.name+'". Aceptar: Reemplazar. Cancelar: Duplicar');
          if(choice) all[idx]=data; else all.push(data);
        }else{
          all.push(data);
        }
        saveAll(all);
        refreshLoader();
        fillFromJSON(data);
        alert('Importado correctamente.');
      }catch(e){
        alert('No se pudo importar: ' + e.message);
      }
    };
    reader.readAsText(file);
    ev.target.value = '';
  }

  function reset(){
    nameI.value = '';
	    dirWrap.innerHTML = ''; depWrap.innerHTML='';
	    if (areaWrap) areaWrap.innerHTML = '';
    if (areaOnEl) areaOnEl.checked = false;
    const _areaBody = q('#pers_area_body', view); if(_areaBody){ _areaBody.style.display='none'; }
    dirWrap.appendChild(makeDirRow({}));
	    if (areaWrap) areaWrap.appendChild(makeAreaRow({}));
    depWrap.appendChild(makeDepRow({}));
    indOn.checked=false; q('#pers_ind_cfg', view).style.display='none';
    indMensual.value='0,00'; indUnits.value='100';
    moOn.checked=false; const _moCfg=q('#pers_mo_cfg', view); if(_moCfg){ _moCfg.style.display='none'; _moCfg.dataset.forcedOpen=''; }
    moSueldo.value='0,00'; moHorasMes.value='160'; moSetup.value='0'; moRun.value='0'; moUnits.value='1';
    gMode.value='Margen'; gOn.checked=true; gPct.value='30'; iOn.checked=true; iPct.value='16';
    update();
  }

	  // Expose contract (pers_update / pers_reset) + optional Suite.register
	  window.pers_update = function(){
	    try{ if (typeof update === 'function') update(); }catch(e){}
	  };
	  window.pers_reset = function(){
	    try{ if (typeof reset === 'function') reset(); }catch(e){}
	  };
	  if (window.Suite && typeof window.Suite.register === 'function'){
	    try{ window.Suite.register('personalizado', { update: window.pers_update, reset: window.pers_reset }); }catch(e){}
	  }

	  // Global navigation handler (non-invasive)
  document.addEventListener('click', function(e){
    const t = e.target.closest('[data-goto]');
    if(!t) return;
    const sel = t.getAttribute('data-goto');
    if(!sel) return;
    const target = document.querySelector(sel);
    if(!target) return;
    e.preventDefault();
    document.querySelectorAll('.view').forEach(v=> v.classList.remove('active'));
    target.classList.add('active');
    // mark nav button active
    document.querySelectorAll('nav button').forEach(b=> b.classList.toggle('active', b===t));
  }, true);

  document.addEventListener('DOMContentLoaded', buildView);
})();
</script>
<script id="vinil_rewrite_logic">
// === Vinil module: clean rewrite (EU-aware, no flicker) ===
(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const byId = id => document.getElementById(id);

  // --- EU helpers ---
  const fmtEU = (n) => {
    if (!isFinite(n)) n = 0;
    const v = Math.round((n + Number.EPSILON) * 100) / 100;
    // "$ 1.234,56" style
    return v.toLocaleString('es-ES', { style:'currency', currency:'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 }).replace('US$', '$');
  };
  const fmtEUplain = n => (isFinite(n)?n:0).toLocaleString('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2});
  const parseEU = (v) => {
    if (v == null) return 0;
    if (typeof v === 'number') return v;
    v = (''+v).trim();
    if (!v) return 0;
    v = v.replace(/[^\d,.\-]/g,'');
    if (v.indexOf(',') >= 0 && v.indexOf('.') >= 0){ v = v.replace(/\./g,'').replace(',','.'); }
    else if (v.indexOf(',') >= 0){ v = v.replace(',','.'); }
    const n = parseFloat(v);
    return isNaN(n)?0:n;
  };

  const ids = {
    // Merma / ajustes
    mermaPct:'merma_pct',
    mermaRange:'merma_range',
    // Resumen visible
    rDir:'vinil_pro_directos',
    rDep:'vinil_pro_dep',
    rAdic:'vinil_pro_adic',
    rMerma:'vinil_pro_merma',
    rTotal:'vinil_pro_total',
    // Directos principal y extras (vinil usa estos ids)
    cdOn:'cd_enabled', cdCant:'cd_cant', cdPrecio:'cd_precio', cdUd:'cd_costo_ud', cdQtyUse:'cd_qty_use', cdUtil:'cd_costo_util',
    papelOn:'vin_d_papel_on', papelCant:'vin_d_papel_cant', papelPrec:'vin_d_papel_precio', papelUd:'vin_d_papel_ud', papelQtyUse:'vin_d_papel_qty_use', papelUtil:'vin_d_papel_util',
    cintaOn:'vin_d_cinta_on', cintaCant:'vin_d_cinta_cant', cintaPrec:'vin_d_cinta_precio', cintaUd:'vin_d_cinta_ud', cintaQtyUse:'vin_d_cinta_qty_use', cintaUtil:'vin_d_cinta_util',
    tintaOn:'vin_d_tinta_on', tintaCant:'vin_d_tinta_cant', tintaPrec:'vin_d_tinta_precio', tintaUd:'vin_d_tinta_ud', tintaQtyUse:'vin_d_tinta_qty_use', tintaUtil:'vin_d_tinta_util',
    // Indirectos
    indOn:'vin_ind_on', indUD:'vin_ind_ud', indCfgBtn:'vin_ind_cfg_btn', indCfg:'vin_ind_cfg', indUnits:'vin_ind_units',
    indFields:['vin_ind_alquiler','vin_ind_internet','vin_ind_suscripciones','vin_ind_transporte','vin_ind_electricidad','vin_ind_publicidad','vin_ind_otros'],
    // Mano de obra
    moOn:'vin_mo_on', moCfgBtn:'vin_mo_cfg_btn', moCfg:'vin_mo_cfg', moSueldo:'vin_mo_sueldo', moHoras:'vin_mo_horas_mes', moSetup:'vin_mo_setup', moRun:'vin_mo_run', moUnits:'vin_mo_units', moPill:'vin_mo_pill', moVal:'vin_mo_val',
    // GI
    subNoGI:'vin_subtotal_no_gi', sub:'vin_subtotal', gChk:'vin_chk_ganancia', iChk:'vin_chk_impuestos', gPct:'vin_ganancia', iPct:'vin_impuestos', gVal:'vin_ganancia_val', iVal:'vin_impuestos_val', total:'vin_total'
  };

  // === Depreciación — SOLO dentro de #vinil_depreciacion ===
  const depRows = () => {
    const cont = document.querySelector('#vinil_depreciacion');
    if (!cont) return [];
    const rows = [];
    cont.querySelectorAll('.dep_enabled').forEach(chk => {
      const row = chk.getAttribute('data-row');
      rows.push({
        chk,
        row,
        precio: cont.querySelector(`.dep_precio[data-row="${row}"]`),
        vida:   cont.querySelector(`.dep_vida[data-row="${row}"]`),
        mes:    cont.querySelector(`.dep_mes[data-row="${row}"]`),
        ud:     cont.querySelector(`.dep_ud[data-row="${row}"]`),
        uses:   cont.querySelector(`.dep_uses[data-row="${row}"]`),
        util:   cont.querySelector(`.dep_util[data-row="${row}"]`),
      });
    });
    return rows;
  };

  const costoUd = (cant, precio) => {
    const c = Math.max(0, parseEU(cant));
    const p = Math.max(0, parseEU(precio));
    return c > 0 ? p / c : 0;
  };

  const calcDirectos = () => {
    let t = 0;

    // Item principal (cd_*)
    const cd_on = byId(ids.cdOn)?.checked;
    const cd_ud = costoUd(byId(ids.cdCant)?.value, byId(ids.cdPrecio)?.value);
    if (byId(ids.cdUd)) byId(ids.cdUd).value = '$ ' + fmtEUplain(cd_ud);

    const cd_qty = Math.max(0, parseEU(byId(ids.cdQtyUse)?.value));
    const cd_util = cd_ud * cd_qty;
    if (byId(ids.cdUtil)) byId(ids.cdUtil).value = '$ ' + fmtEUplain(cd_util);
    if (cd_on) t += cd_util;

    // papel / cinta / tinta (opcionales)
    const papel_ud = costoUd(byId(ids.papelCant)?.value, byId(ids.papelPrec)?.value);
    if (byId(ids.papelUd)) byId(ids.papelUd).value = '$ ' + fmtEUplain(papel_ud);
    const papel_qty = Math.max(0, parseEU(byId(ids.papelQtyUse)?.value));
    const papel_util = papel_ud * papel_qty;
    if (byId(ids.papelUtil)) byId(ids.papelUtil).value = '$ ' + fmtEUplain(papel_util);
    if (byId(ids.papelOn)?.checked) t += papel_util;

    const cinta_ud = costoUd(byId(ids.cintaCant)?.value, byId(ids.cintaPrec)?.value);
    if (byId(ids.cintaUd)) byId(ids.cintaUd).value = '$ ' + fmtEUplain(cinta_ud);
    const cinta_qty = Math.max(0, parseEU(byId(ids.cintaQtyUse)?.value));
    const cinta_util = cinta_ud * cinta_qty;
    if (byId(ids.cintaUtil)) byId(ids.cintaUtil).value = '$ ' + fmtEUplain(cinta_util);
    if (byId(ids.cintaOn)?.checked) t += cinta_util;

    const tinta_ud = costoUd(byId(ids.tintaCant)?.value, byId(ids.tintaPrec)?.value);
    if (byId(ids.tintaUd)) byId(ids.tintaUd).value = '$ ' + fmtEUplain(tinta_ud);
    const tinta_qty = Math.max(0, parseEU(byId(ids.tintaQtyUse)?.value));
    const tinta_util = tinta_ud * tinta_qty;
    if (byId(ids.tintaUtil)) byId(ids.tintaUtil).value = '$ ' + fmtEUplain(tinta_util);
    if (byId(ids.tintaOn)?.checked) t += tinta_util;

    if (byId(ids.rDir)) byId(ids.rDir).textContent = fmtEU(t);
    const leg = byId('vinil_directos'); if (leg) leg.textContent = '$ ' + fmtEUplain(t);
    return t;
  };

  const calcDepreciacion = () => {
    const rows = depRows();
    let totalUD = 0;
    const UNITS_PER_MONTH = 100;

    rows.forEach(({chk, precio, vida, mes, ud, uses, util}) => {
      const on = chk?.checked;
      const P = parseEU(precio?.value);

      let cMes = 0, cUd = 0;
      if (vida) {
        const V = Math.max(1, parseEU(vida.value));
        cUd = P / V;
        cMes = 0;
      } else {
        cMes = P / 24;
        cUd = (cMes / UNITS_PER_MONTH);
      }

      if (mes) mes.value = '$ ' + fmtEUplain(cMes);
      if (ud)  ud.value  = '$ ' + fmtEUplain(cUd);

      const u = Math.max(0, parseEU(uses?.value));
      const cUtil = cUd * u;
      if (util) util.value = '$ ' + fmtEUplain(cUtil);

      if (on) totalUD += cUtil;
    });

    if (byId(ids.rDep)) byId(ids.rDep).textContent = fmtEU(totalUD);
    const leg = byId('vinil_dep'); if (leg) leg.textContent = '$ ' + fmtEUplain(totalUD);
    return totalUD;
  };

  const calcAdicionales = () => {
    // 1) Sumar directamente los bloques de color (ids que comienzan con 'resultado')
    let total = 0;
    document.querySelectorAll('[id^="resultado"]').forEach(el=>{
      let t = (el.textContent||'').replace('Costo:','').replace(/[^0-9.,-]/g,'');
      if (t.indexOf(',')>=0){ t = t.replace(/\./g,'').replace(',', '.'); }
      total += parseFloat(t)||0;
    });
    // 2) Fallback a los spans si fuese necesario
    if (total<=0){
      let span = byId('vinil_adicionales') || byId('vinil_pro_adic');
      if (span) total = parseEU(span.textContent)||0;
    }
    // 3) Fallback final a cache
    if (total<=0 && typeof window.__vinilAdic === 'number' && window.__vinilAdic>0) total = window.__vinilAdic;
    return total;
  };

  const calcIndirectos = () => {
    const on = byId(ids.indOn)?.checked;
    const units = Math.max(1, parseEU(byId(ids.indUnits)?.value));
    let monthly = 0;
    (ids.indFields||[]).forEach(id => monthly += parseEU(byId(id)?.value));
    const ud = monthly / units;
    if (byId(ids.indUD)) byId(ids.indUD).textContent = '$ ' + fmtEUplain(on ? ud : 0);
    return on ? ud : 0;
  };

  const calcMO = () => {
    const on = byId(ids.moOn)?.checked;
    if (!on) {
      if (byId(ids.moPill)) byId(ids.moPill).style.display = 'none';
      if (byId(ids.moVal)) byId(ids.moVal).textContent = '$ 0,00';
      return 0;
    }
    const sueldo = parseEU(byId(ids.moSueldo)?.value);
    const horas  = Math.max(1, parseEU(byId(ids.moHoras)?.value));
    const setupM = Math.max(0, parseEU(byId(ids.moSetup)?.value));
    const runM   = Math.max(0, parseEU(byId(ids.moRun)?.value));
    const units  = Math.max(1, parseEU(byId(ids.moUnits)?.value));
    const rateHr = sueldo / horas;
    const rateMin = rateHr / 60;
    const perUnit = rateMin * ((setupM/units) + runM);
    if (byId(ids.moPill)) byId(ids.moPill).style.display = 'inline-flex';
    if (byId(ids.moVal))  byId(ids.moVal).textContent = '$ ' + fmtEUplain(perUnit);
    return perUnit;
  };

  const syncMerma = (src) => {
    const p = byId(ids.mermaPct), r = byId(ids.mermaRange);
    if (!p || !r) return;
    const clamp = (x,min,max)=>Math.max(min,Math.min(max,x));
    if (src === 'pct') { r.value = String(clamp(parseEU(p.value),0,100)); }
    else if (src === 'range') { p.value = String(clamp(parseEU(r.value),0,100)); }
    if (byId(ids.rMerma)) byId(ids.rMerma).textContent = (parseEU(p.value)||0).toFixed(0).replace('.',',') + '%';
  };

  let scheduled = false;

  // Hook to respond when color blocks recalc their total (vinil_actualizarTotal or #vinil_adicionales changes)
  function hookColorTotals(){
    if (typeof window.__vinilAdic === 'undefined') window.__vinilAdic = 0;
    const watchIds = ['vinil_adicionales','vinil_pro_adic'];
    watchIds.forEach(id=>{
      const el = document.getElementById(id);
      if (!el || el.__observed) return;
      const mo = new MutationObserver(()=>{ 
        const t = parseEU(el.textContent);
        if (!isNaN(t) && t>0) window.__vinilAdic = t;
        recompute(); 
      });
      mo.observe(el, { childList:true, characterData:true, subtree:true });
      el.__observed = true;
    });
    try{
      if(window.vinil_actualizarTotal && !window.__vinilPatch){
        const _orig = window.vinil_actualizarTotal;
        window.vinil_actualizarTotal = function(){
          try{ _orig.apply(this, arguments);
          var span = (document.getElementById('vinil_adicionales')||document.getElementById('vinil_pro_adic'));
          var t = span ? parseEU(span.textContent) : 0;
          if (!isNaN(t) && t>0) window.__vinilAdic = t;
        } finally { recompute(); }
        };
        window.__vinilPatch = true;
      }
    }catch(e){}
  }

  const recompute = () => {
    if (scheduled) return;
    scheduled = true;
    requestAnimationFrame(()=>{
      scheduled = false;

      const directos = calcDirectos();
      const dep      = calcDepreciacion();
      const adicionales = calcAdicionales();

      // Merma sobre (Directos + Dep + Adicionales)
      const merma = Math.max(0, parseEU(byId(ids.mermaPct)?.value));
      const baseVinil = directos + dep + (adicionales * (1 + merma/100));
      if (byId(ids.rTotal)) byId(ids.rTotal).textContent = fmtEU(baseVinil);

      // Indirectos + Mano de obra
      const ind = calcIndirectos();
      const mo  = calcMO();

      // Total sin G/I (SIN mano de obra)
      const subtotalNoGI = baseVinil + ind;
      if (byId(ids.subNoGI)) byId(ids.subNoGI).textContent = fmtEU(subtotalNoGI);

      // Blindaje: asegurar que "Total Vinil" NO incluya costos indirectos ni mano de obra.
      // Si alguna lógica legacy intenta sumarlos, lo corregimos forzando:
      //   Total Vinil = Total sin G/I − Indirectos
      if (byId(ids.rTotal)) byId(ids.rTotal).textContent = fmtEU(subtotalNoGI - ind);

      // Base para Ganancia/Impuestos incluye MO
      const baseMO = subtotalNoGI + mo;

      const gOn = byId(ids.gChk)?.checked;
      const iOn = byId(ids.iChk)?.checked;
      const gPct = Math.max(0, parseEU(byId(ids.gPct)?.value));
      const iPct = Math.max(0, parseEU(byId(ids.iPct)?.value));
      const G = gOn ? baseMO * (gPct/100) : 0;
      const I = iOn ? (baseMO + G) * (iPct/100) : 0;


if (byId(ids.gVal)) byId(ids.gVal).textContent = fmtEU(G);
      if (byId(ids.iVal)) byId(ids.iVal).textContent = fmtEU(I);
      if (byId(ids.sub))  byId(ids.sub).textContent  = fmtEU(baseMO);
      if (byId(ids.total))byId(ids.total).textContent= fmtEU(baseMO + G + I);
    });
  };

  const bind = () => {
    const listenIds = [
      ids.mermaPct, ids.mermaRange,
      ids.cdOn, ids.cdCant, ids.cdPrecio, ids.cdQtyUse,
      ids.papelOn, ids.papelCant, ids.papelPrec, ids.papelQtyUse,
      ids.cintaOn, ids.cintaCant, ids.cintaPrec, ids.cintaQtyUse,
      ids.tintaOn, ids.tintaCant, ids.tintaPrec, ids.tintaQtyUse,
      ids.gChk, ids.iChk, ids.gPct, ids.iPct,
      ids.moOn, ids.moSueldo, ids.moHoras, ids.moSetup, ids.moRun, ids.moUnits,
      ids.indOn, ids.indUnits, ...ids.indFields
    ];
    listenIds.forEach(id => {
      const el = byId(id); if (!el) return;
      el.oninput = el.onchange = null;
      const handler = ()=>{ if (id===ids.mermaPct) syncMerma('pct'); if (id===ids.mermaRange) syncMerma('range'); recompute(); };
      el.addEventListener('input', handler);
      el.addEventListener('change', handler);
    });
    // Dep rows
    depRows().forEach(({chk,precio,vida,uses})=>{
      [chk,precio,vida,uses].forEach(el=>{
        if (!el) return;
        el.oninput = el.onchange = null;
        el.addEventListener('input', recompute);
        el.addEventListener('change', recompute);
      });
    });
    // Toggles
    const moBtn = byId(ids.moCfgBtn), moCfg = byId(ids.moCfg);
    if (moBtn && moCfg) moBtn.addEventListener('click', ()=>{
      moCfg.style.display = (moCfg.style.display==='none'||!moCfg.style.display)?'flex':'none';
    });
    const indBtn = byId(ids.indCfgBtn), indCfg = byId(ids.indCfg);
    if (indBtn && indCfg) indBtn.addEventListener('click', ()=>{
      indCfg.style.display = (indCfg.style.display==='none'||!indCfg.style.display)?'block':'none';
    });
    // Initial
    syncMerma('pct');
    ['papelUd','cintaUd','tintaUd','cdUd','cdUtil','papelUtil','cintaUtil','tintaUtil'].forEach(k=>{ const el=byId(ids[k]); if (el) el.readOnly=true; });
    hookColorTotals();
    setTimeout(hookColorTotals, 300);
    setTimeout(hookColorTotals, 1200);
  };

  const init = () => {
    if (!byId('view-vinil')) return;
    bind(); recompute();
  };

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init, {once:true});
  else init();
})();
</script>
<script>
(function(){
  // Anti-duplicated listeners for Vinil direct costs
  function safeCloneReplace(id){
    var el = document.getElementById(id);
    if(!el) return;
    var newEl = el.cloneNode(true); // drops listeners
    el.parentNode.replaceChild(newEl, el);
    return newEl;
  }
  document.addEventListener('DOMContentLoaded', function(){
    var ids = ['cd_enabled','cd_cant','cd_precio','cd_costo_ud','cd_qty_use','cd_costo_util','vin_d_papel_on','vin_d_papel_cant','vin_d_papel_precio','vin_d_papel_ud','vin_d_papel_qty_use','vin_d_papel_util','vin_d_cinta_on','vin_d_cinta_cant','vin_d_cinta_precio','vin_d_cinta_ud','vin_d_cinta_qty_use','vin_d_cinta_util','vin_d_tinta_on','vin_d_tinta_cant','vin_d_tinta_precio','vin_d_tinta_ud','vin_d_tinta_qty_use','vin_d_tinta_util'];
    ids.forEach(safeCloneReplace);
    // Reattach only our clean listeners by triggering a synthetic input (our vinil_rewrite_logic listens to input/change)
    var any = document.getElementById('cd_precio') || document.getElementById('cd_cant');
    if(any){ var evt = new Event('input',{bubbles:true}); any.dispatchEvent(evt); }
  });
})();
</script>
<script>
(function(){
  const btn = document.getElementById('btnMenu');
  const overlay = document.getElementById('overlay');
  const drawer = document.getElementById('drawer');
  const menu = document.getElementById('menu');

  function openDrawer(){ if(!overlay || !drawer) return; overlay.style.opacity='1'; overlay.style.pointerEvents='auto'; drawer.style.transform='translateX(0)'; drawer.setAttribute('aria-hidden','false'); }
  function closeDrawer(){ if(!overlay || !drawer) return; overlay.style.opacity='0'; overlay.style.pointerEvents='none'; drawer.style.transform='translateX(-105%)'; drawer.setAttribute('aria-hidden','true'); }

  btn && btn.addEventListener('click', openDrawer);
  overlay && overlay.addEventListener('click', closeDrawer);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

  // Robust navigation: map dataset view -> real element id
  function findViewEl(key){
    // 1) Try exact id "view-<key>"
    let el = document.getElementById('view-' + key);
    if (el) return el;
    // 2) Try common synonyms
    const aliases = {
      'dtf':'dtf',
      'vinil':'vinil',
      'sublimacion':'sublimacion',
      'esferas-navidenas':'esferas-navidenas',
      'papeleria':'papeleria',
      'etiquetas':'etiquetas',
      'empaques':'empaques',
      'envios':'envios',
      'resumen':'resumen',
      'conversor':'conversor',
      'basica':'basica',
      'instrucciones':'instrucciones'
    };
    const k = aliases[key] || key;
    el = document.getElementById('view-' + k);
    if (el) return el;
    // 3) Fallback: substring search among .view
    const all = document.querySelectorAll('.view[id]');
    for (const v of all){ if (v.id && v.id.indexOf(key) >= 0) return v; }
    return null;
  }

  function goToView(key){
    const all = document.querySelectorAll('.view');
    all.forEach(v => { v.classList.remove('active'); v.style.display='none'; });
    const el = findViewEl(key);
    if (el){
      el.classList.add('active');
      el.style.display='block';
      window.scrollTo({top:0, behavior:'smooth'});
    } else {
      console.warn('Vista no encontrada:', key);
    }
  }

  // Expose for external usage
  window.selectView = goToView;

  // Drawer menu
  menu && menu.addEventListener('click',(e)=>{
    const item = e.target.closest('.item');
    if(!item) return;
    const view = item.dataset.view;
    // Visual state
    menu.querySelectorAll('.item').forEach(el=>el.removeAttribute('data-active'));
    item.setAttribute('data-active','true');
    // Change view
    goToView(view);
    // Emit event + close
    window.dispatchEvent(new CustomEvent('menu:navigate',{detail:{view}}));
    closeDrawer();
  });
})();
</script>
<script>
(function(){
  var btn = document.getElementById("vin_ind_cfg_btn");
  var panel = document.getElementById("vin_ind_cfg");
  if (!btn || !panel) return;
  btn.addEventListener("click", function(){
    var current = panel.style.display;
    if (!current) {
      // si no hay estilo inline, usar el display actual computado
      try {
        current = window.getComputedStyle(panel).display;
      } catch(e) {
        current = "block";
      }
    }
    panel.style.display = (current === "none") ? "block" : "none";
  });
})();
</script>

<script>
// Header compacto en móviles — versión ENTER/EXIT con histéresis fuerte
(function(){
  const header = document.querySelector('.app > header.app-header');
  if (!header) return;

  const mq = window.matchMedia('(max-width: 840px)');
  const ENTER_Y = 80;  // Compactar al pasar esta altura
  const EXIT_Y  = 5;   // Descompactar solo al volver casi arriba

  let isCompact = false;

  function applyState(shouldCompact){
    if (shouldCompact === isCompact) return;
    isCompact = shouldCompact;
    if (isCompact){
      header.classList.add('header-compact');
    } else {
      header.classList.remove('header-compact');
    }
  }

  function updateHeader(){
    const y = window.scrollY || document.documentElement.scrollTop || 0;

    // En escritorio, nunca compactamos
    if (!mq.matches){
      applyState(false);
      return;
    }

    // Histéresis: dos umbrales distintos
    if (!isCompact && y > ENTER_Y){
      applyState(true);
    } else if (isCompact && y < EXIT_Y){
      applyState(false);
    }
  }

  window.addEventListener('scroll', updateHeader, {passive:true});
  if (mq.addEventListener){
    mq.addEventListener('change', updateHeader);
  } else if (mq.addListener){
    mq.addListener(updateHeader);
  }
  document.addEventListener('DOMContentLoaded', updateHeader);
  updateHeader();
})();
</script>


<script>
/* Dark toggle pill text sync (UI only, no lógica) */
(function(){
  const pill = document.querySelector('.dark-toggle-pill');
  if(!pill) return;
  const input = pill.querySelector('#dark_toggle');
  const text  = pill.querySelector('.dt-text');
  if(!input || !text) return;

  function sync(){
    // checked = dark ON -> show sun + "Claro" (to volver a claro)
    text.textContent = input.checked ? 'Claro' : 'Oscuro';
  }
  sync();
  input.addEventListener('change', sync);
})();
</script>


<!-- Cantidad de productos (Empaques) – bloque no intrusivo -->
<script>
(function(){
  function $id(id){ return document.getElementById(id); }

  function parseEUAny(v){
    try{ if (typeof euParse === 'function') return euParse(v); }catch(e){}
    try{ if (typeof parseEU === 'function') return parseEU(v); }catch(e){}
    if (v == null) return 0;
    if (typeof v !== 'string') v = String(v);
    var s = v.replace(/[^0-9.,-]/g,'').replace(/\./g,'').replace(/,/g,'.');
    var n = parseFloat(s);
    return isFinite(n) ? n : 0;
  }

  function fmtEUAny(n){
    try{ if (typeof fmtEU === 'function') return fmtEU(n); }catch(e){}
    try{ if (typeof fmtUSD === 'function') return fmtUSD(n); }catch(e){}
    if (!isFinite(n)) n = 0;
    var s = n.toFixed(2).replace('.',',');
    return '$ ' + s;
  }

  function getNumericFromSpanOrInput(id){
    var el = $id(id);
    if (!el) return 0;
    var raw = ('value' in el) ? el.value : (el.textContent || el.innerText || '');
    return parseEUAny(raw);
  }

  function setResult(id, val){
    var el = $id(id);
    if (!el) return;
    el.textContent = fmtEUAny(val);
  }

  function recalcEmpQty(){
    var qtyOn    = $id('emp_qty_on');
    var qtyInput = $id('emp_qty');
    if (!qtyOn || !qtyInput) return;

    var Q = parseInt(qtyInput.value, 10);
    if (!Q || Q < 1) Q = 1;
    if (qtyInput.value !== String(Q)) qtyInput.value = String(Q);

    if (!qtyOn.checked){
      setResult('emp_qty_base', 0);
      setResult('emp_qty_subtotal', 0);
      setResult('emp_qty_g', 0);
      setResult('emp_qty_i', 0);
      setResult('emp_qty_total', 0);
      return;
    }

    // Base sin G/I por unidad
    var base = getNumericFromSpanOrInput('emp_subtotal_no_gi');

    // Valores por unidad YA calculados por Empaques
    var subtotalUnit = getNumericFromSpanOrInput('emp_subtotal');
    var gUnit        = getNumericFromSpanOrInput('emp_ganancia_val');
    var iUnit        = getNumericFromSpanOrInput('emp_impuestos_val');
    // Total final por unidad (usa el span actual de Total directos)
    var totalUnit    = getNumericFromSpanOrInput('emp_total');

    var baseQ     = base * Q;
    var subtotalQ = subtotalUnit * Q;
    var gQ        = gUnit * Q;
    var iQ        = iUnit * Q;
    var totalQ    = totalUnit * Q;

    setResult('emp_qty_base', baseQ);
    setResult('emp_qty_subtotal', subtotalQ);
    setResult('emp_qty_g', gQ);
    setResult('emp_qty_i', iQ);
    setResult('emp_qty_total', totalQ);
  }

  function attachEmpQtyEvents(){
    var qtyOn    = $id('emp_qty_on');
    var qtyInput = $id('emp_qty');
    if (qtyOn)   qtyOn.addEventListener('change', recalcEmpQty);
    if (qtyInput){
      qtyInput.addEventListener('change', recalcEmpQty);
      qtyInput.addEventListener('input', recalcEmpQty);
    }

    var chkG = $id('emp_chk_ganancia');
    var gPct = $id('emp_ganancia');
    var chkI = $id('emp_chk_impuestos');
    var iPct = $id('emp_impuestos');
    var moOn = $id('emp_mo_on');
    var moCfg= $id('emp_mo_cfg');

    if (chkG) chkG.addEventListener('change', recalcEmpQty);
    if (gPct){
      gPct.addEventListener('change', recalcEmpQty);
      gPct.addEventListener('input', recalcEmpQty);
    }
    if (chkI) chkI.addEventListener('change', recalcEmpQty);
    if (iPct){
      iPct.addEventListener('change', recalcEmpQty);
      iPct.addEventListener('input', recalcEmpQty);
    }
    if (moOn) moOn.addEventListener('change', recalcEmpQty);
    if (moCfg){
      moCfg.addEventListener('input', recalcEmpQty);
      moCfg.addEventListener('change', recalcEmpQty);
    }
  }

  function attachEmpQtyObservers(){
    if (!window.MutationObserver) return;
    var observer = new MutationObserver(recalcEmpQty);
    [
      'emp_subtotal_no_gi',
      'emp_subtotal',
      'emp_ganancia_val',
      'emp_impuestos_val',
      'emp_total',
      'emp_mo_val'
    ].forEach(function(id){
      var el = $id(id);
      if (el) observer.observe(el, {childList:true, characterData:true, subtree:true});
    });
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive'){
    attachEmpQtyEvents();
    attachEmpQtyObservers();
    recalcEmpQty();
  } else {
    window.addEventListener('load', function(){
      attachEmpQtyEvents();
      attachEmpQtyObservers();
      recalcEmpQty();
    });
  }
})();
</script>


<script>
// --- Producto personalizable: Cantidad de productos (solo vista, espejo de pills por unidad) ---
(function(){
  if (window.__PERS_QTY_BOUND__) return;
  window.__PERS_QTY_BOUND__ = true;

  function parseEUAny(text){
    if (text == null) return 0;
    let s = String(text).trim();
    if (!s) return 0;
    let clean = s.replace(/[^\d,.\-]/g, '');
    if (!clean) return 0;

    if (clean.indexOf(',') >= 0){
      const lastComma = clean.lastIndexOf(',');
      const left = clean.slice(0, lastComma).replace(/\./g,'').replace(/,/g,'');
      const right = clean.slice(lastComma+1).replace(/[^\d]/g,'');
      const num = parseFloat((left || '0') + '.' + (right || '0'));
      return isFinite(num) ? num : 0;
    }
    clean = clean.replace(/,/g,'');
    const num = parseFloat(clean);
    return isFinite(num) ? num : 0;
  }

  function getPrefixFrom(text){
    const s = String(text||'').trim();
    const m = s.match(/^\s*([^\d\-]+)/);
    let p = (m && m[1]) ? m[1].trim() : '';
    if (!p) p = '$';
    return (p + ' ').replace(/\s+/g,' ');
  }

  function fmtEUAny(num, prefix){
    const n = isFinite(num) ? num : 0;
    const out = n.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const p = (prefix && String(prefix).trim()) ? (String(prefix).trim() + ' ') : '$ ';
    return p + out;
  }

  function bindWhenReady(){
    const view = document.getElementById('view-personalizado');
    if (!view) return false;

    const card = document.getElementById('pers_qty_card');
    if (!card) return false;

    const onEl = document.getElementById('pers_qty_on');
    const qEl  = document.getElementById('pers_qty');

    const outBase = document.getElementById('pers_qty_base');
    const outSub  = document.getElementById('pers_qty_subtotal');
    const outG    = document.getElementById('pers_qty_g');
    const outI    = document.getElementById('pers_qty_i');
    const outTot  = document.getElementById('pers_qty_total');

    const pills = [
      document.getElementById('pers_pill_dir'),
      document.getElementById('pers_pill_dep'),
      document.getElementById('pers_pill_ind'),
      document.getElementById('pers_pill_sub'),
      document.getElementById('pers_pill_g'),
      document.getElementById('pers_pill_i'),
      document.getElementById('pers_pv')
    ].filter(Boolean);

    if (!onEl || !qEl || !outBase || !outSub || !outG || !outI || !outTot || pills.length < 7) return false;

    let mo = null;

    function setZeros(prefix){
      outBase.textContent = fmtEUAny(0, prefix);
      outSub.textContent  = fmtEUAny(0, prefix);
      outG.textContent    = fmtEUAny(0, prefix);
      outI.textContent    = fmtEUAny(0, prefix);
      outTot.textContent  = fmtEUAny(0, prefix);
    }

    function refresh(){
      const prefix = getPrefixFrom(
        document.getElementById('pers_pv')?.textContent ||
        document.getElementById('pers_pill_dir')?.textContent ||
        '$'
      );

      if (!onEl.checked){
        setZeros(prefix);
        return;
      }

      const Q = Math.max(1, parseInt(qEl.value, 10) || 1);

      const dir = parseEUAny(document.getElementById('pers_pill_dir')?.textContent);
      const dep = parseEUAny(document.getElementById('pers_pill_dep')?.textContent);
      const ind = parseEUAny(document.getElementById('pers_pill_ind')?.textContent);
      const sub = parseEUAny(document.getElementById('pers_pill_sub')?.textContent);
      const g   = parseEUAny(document.getElementById('pers_pill_g')?.textContent);
      const i   = parseEUAny(document.getElementById('pers_pill_i')?.textContent);
      const pv  = parseEUAny(document.getElementById('pers_pv')?.textContent);

      const baseUnit = dir + dep + ind;

      outBase.textContent = fmtEUAny(baseUnit * Q, prefix);
      outSub.textContent  = fmtEUAny(sub * Q, prefix);
      outG.textContent    = fmtEUAny(g * Q, prefix);
      outI.textContent    = fmtEUAny(i * Q, prefix);
      outTot.textContent  = fmtEUAny(pv * Q, prefix);
    }

    function observe(){
      if (mo) return;
      mo = new MutationObserver(()=>refresh());
      pills.forEach(el=>{
        mo.observe(el, { childList:true, characterData:true, subtree:true });
      });
    }

    onEl.addEventListener('change', refresh, {passive:true});
    qEl.addEventListener('input', refresh, {passive:true});
    qEl.addEventListener('change', refresh, {passive:true});

    observe();
    refresh();
    return true;
  }

  function boot(){
    let tries = 0;
    const t = setInterval(()=>{
      tries++;
      if (bindWhenReady() || tries > 200){
        clearInterval(t);
      }
    }, 50);
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }
})();
</script>

<script>
// --- Esferas FINAL PATCH last-handler: asegura que los costos se calculen SIEMPRE y nuestros listeners se registren al final.
(function(){
  const $ = (q,ctx=document)=>ctx.querySelector(q);
  const $$ = (q,ctx=document)=>Array.from(ctx.querySelectorAll(q));
  function fmtEU(n){ if(isNaN(n)||n==null)n=0; const parts=Number(n).toFixed(2).split('.'); const i=parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,'.'); return '$ ' + i + ',' + parts[1]; }
  function p(txt){ if(typeof txt!=='string') return Number(txt)||0; let t=txt.replace(/[^\d,\.\-]/g,''); if(t.includes(',') && t.lastIndexOf(',')>t.lastIndexOf('.')){ t=t.replace(/\./g,'').replace(',','.'); } const v=parseFloat(t); return isNaN(v)?0:v; }
  function unit(c,pr){ const cc=p(c), pp=p(pr); return cc>0? pp/cc : 0; }

  function calcAlways(){
    const prodUd = unit($('#esf_d_prod_cant')?.value||0, $('#esf_d_prod_precio')?.value||0);
    if($('#esf_d_prod_ud')) $('#esf_d_prod_ud').value = fmtEU(prodUd);
    const prodUse = p($('#esf_d_prod_use')?.value||1);
    if($('#esf_d_prod_used')) $('#esf_d_prod_used').value = fmtEU(prodUd * prodUse);

    const vinUd = unit($('#esf_d_vinil_cant')?.value||0, $('#esf_d_vinil_precio')?.value||0);
    if($('#esf_d_vinil_ud')) $('#esf_d_vinil_ud').value = fmtEU(vinUd);
    const vinUse = p($('#esf_d_vinil_use')?.value||1);
    if($('#esf_d_vinil_used')) $('#esf_d_vinil_used').value = fmtEU(vinUd * vinUse);

    const papUd = unit($('#esf_d_papel_cant')?.value||0, $('#esf_d_papel_precio')?.value||0);
    if($('#esf_d_papel_ud')) $('#esf_d_papel_ud').value = fmtEU(papUd);
    const papUse = p($('#esf_d_papel_use')?.value||1);
    if($('#esf_d_papel_used')) $('#esf_d_papel_used').value = fmtEU(papUd * papUse);

    const nivUd = unit($('#esf_d_nieve_cant')?.value||0, $('#esf_d_nieve_precio')?.value||0);
    if($('#esf_d_nieve_ud')) $('#esf_d_nieve_ud').value = fmtEU(nivUd);
    const nivUse = p($('#esf_d_nieve_use')?.value||1);
    if($('#esf_d_nieve_used')) $('#esf_d_nieve_used').value = fmtEU(nivUd * nivUse);

    const extUd = unit($('#esf_d_extra_cant')?.value||0, $('#esf_d_extra_precio')?.value||0);
    if($('#esf_d_extra_ud')) $('#esf_d_extra_ud').value = fmtEU(extUd);
    const extUse = p($('#esf_d_extra_use')?.value||1);
    if($('#esf_d_extra_used')) $('#esf_d_extra_used').value = fmtEU(extUd * extUse);

    const uds = Math.max(1, parseInt($('#esf_d_cinta_udxrollo')?.value||'45',10));
    const pr  = p($('#esf_d_cinta_precio')?.value||0);
    const cinUd = pr/uds;
    if($('#esf_d_cinta_ud')) $('#esf_d_cinta_ud').value = fmtEU(cinUd);
    const cinUse = p($('#esf_d_cinta_use')?.value||1);
    if($('#esf_d_cinta_used')) $('#esf_d_cinta_used').value = fmtEU(cinUd * cinUse);

    const silUd = unit($('#esf_d_silicon_cant')?.value||0, $('#esf_d_silicon_precio')?.value||0);
    if($('#esf_d_silicon_ud')) $('#esf_d_silicon_ud').value = fmtEU(silUd);
    const silUse = p($('#esf_d_silicon_use')?.value||1);
    if($('#esf_d_silicon_used')) $('#esf_d_silicon_used').value = fmtEU(silUd * silUse);

    // Depreciación: mostrar siempre costo/mes y ud teórico
    const unitsPerMonth=100;
    ['impresora','plancha','pc','plotter','cuchilla','tapete','pistola'].forEach(r=>{
      const precio = p(document.querySelector(`.esf_dep_precio[data-row="${r}"]`)?.value||0);
      const vida   = p(document.querySelector(`.esf_dep_vida[data-row="${r}"]`)?.value||0);
      let ud=0, mes=0;
      if(r==='cuchilla' || r==='tapete'){ ud = vida>0 ? (precio/vida) : 0; }
      else { mes = precio/24; ud = mes/unitsPerMonth; }
      const mesEl=document.querySelector(`.esf_dep_mes[data-row="${r}"]`); if(mesEl) mesEl.value=fmtEU(mes);
      const udEl=document.querySelector(`.esf_dep_ud[data-row="${r}"]`); if(udEl) udEl.value=fmtEU(ud);
      const usosEl=document.querySelector(`.esf_dep_usos[data-row="${r}"]`);
      const usos = p(usosEl?.value||1);
      const usedEl=document.querySelector(`.esf_dep_used[data-row="${r}"]`); if(usedEl) usedEl.value=fmtEU(ud * usos);
    });
  }

  function bind(){
    const root=document.getElementById('view-esferas-navidenas');
    if(!root) return;
    $$('input,select', root).forEach(el=>{ ['input','change'].forEach(ev=> el.addEventListener(ev, calcAlways)); });
    calcAlways();
    setTimeout(calcAlways, 0);
    setTimeout(calcAlways, 50);
  }

  if(document.readyState==='complete') bind();
  else window.addEventListener('load', bind);
})();
</script>

<script>
// === Override Sublimación updater (root fix) ===
(function(){
  if (!document.getElementById('view-sublimacion')) return;

  const EU_FMT = new Intl.NumberFormat('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2});
  const fmtEU = (n)=>'$ '+EU_FMT.format(isFinite(n)?n:0);
  const qs=(id)=>document.getElementById(id);
  const parseNum=(v)=>{ if(typeof v==='number') return v; if(!v) return 0; v=(''+v).replace(/[^0-9.,-]/g,'').replace(/,/g,''); return parseFloat(v)||0; };
  const valNum=(id)=>parseNum(qs(id)?.value);
  const setSpan=(id,n)=>{ const el=qs(id); if(el) el.textContent = fmtEU(n); };
  const setEU=(id,n)=>{ const el=qs(id); if(el) el.value = fmtEU(n); };
  const unitCost=(on,precio,cant)=>{ const ud=(cant>0)?(precio/cant):0; return on?ud:0; };

  function dep(chk,precioId,mesId,udId){
    const en = qs(chk)?.checked;
    const precio = valNum(precioId);
    const mes = precio/24;
    const prod = 100;
    const ud = prod>0 ? (mes/prod) : 0;
    setEU(mesId, mes);
    setEU(udId, ud);
    return en ? ud : 0;
  }

  function sub_update_fixed(){
    // directos
    const d0=unitCost(qs('d_prod_on').checked,   valNum('d_prod_precio'),    valNum('d_prod_cant')); setEU('d_prod_ud', d0);
    const d1=unitCost(qs('d_papel_on').checked,  valNum('d_papel_precio'),   valNum('d_papel_cant')); setEU('d_papel_ud', d1);
    const d2=unitCost(qs('d_tinta_on').checked,  valNum('d_tinta_precio'),   valNum('d_tinta_cant')); setEU('d_tinta_ud', d2);
    const d3=unitCost(qs('d_cinta_on').checked,  valNum('d_cinta_precio'),   valNum('d_cinta_cant')); setEU('d_cinta_ud', d3);
    const d4=unitCost(qs('d_empaque_on').checked,valNum('d_empaque_precio'), valNum('d_empaque_cant')); setEU('d_empaque_ud', d4);
    const totalDirectos=d0+d1+d2+d3+d4; setSpan('sub_total_directos', totalDirectos);

    // depreciación correcta
    const e1=dep('e_impresora_on','e_impresora_precio','e_impresora_mes','e_impresora_ud');
    const e2=dep('e_plancha_on','e_plancha_precio','e_plancha_mes','e_plancha_ud');
    const e3=dep('e_pc_on','e_pc_precio','e_pc_mes','e_pc_ud');
    const e4=dep('e_prensa_on','e_prensa_precio','e_prensa_mes','e_prensa_ud');
    const e5=dep('e_resistencia_on','e_resistencia_precio','e_resistencia_mes','e_resistencia_ud');
    const totalDepr=e1+e2+e3+e4+e5; setSpan('sub_total_depr', totalDepr);

    const subtotal=totalDirectos+totalDepr; setSpan('sub_subtotal_no_gi', subtotal);
    const g=(qs('chk_ganancia')?.checked ? Math.max(0,parseNum(qs('sub_ganancia')?.value))/100 : 0);
    const i=(qs('chk_impuestos')?.checked ? Math.max(0,parseNum(qs('sub_impuestos')?.value))/100 : 0);
    const ganVal=subtotal*g; const subMasGan=subtotal+ganVal; const impVal=subMasGan*i; const total=subMasGan+impVal;
    setSpan('sub_subtotal', subtotal); setSpan('sub_ganancia_val', ganVal); setSpan('sub_impuestos_val', impVal); setSpan('sub_total', total); setSpan('sub_v15_total', total);
  }

  // Override global reference
  window.sub_update = sub_update_fixed;

  // Initial and resilient scheduling
  const schedule=()=>{ sub_update_fixed(); [0,25,60,120,250,500,800].forEach(d=>setTimeout(sub_update_fixed,d)); };
  document.addEventListener('DOMContentLoaded', schedule);
  window.addEventListener('load', schedule);
  schedule();

  // Observe resets and programmatic writes
  document.addEventListener('click', (e)=>{
    const id=(e.target && (e.target.id||'')) + ' ' + (e.target && (e.target.name||''));
    if(/reset/i.test(id)) setTimeout(schedule, 30);
  }, true);
})();
</script>
<script>
// === VINIL: Mano de Obra (solo por eventos, sin bucles, sin tocar "Total Vinil") ===
(function(){
  function euParse(x){
    try{ if (typeof parseEU === 'function') return parseEU(x); }catch(e){}
    if (x == null) return 0;
    const s = String(x).trim();
    if (!s) return 0;
    const t = s.replace(/[^0-9,.-]/g,'');
    if (t.includes(',')){
      const i = t.lastIndexOf(',');
      return parseFloat((t.slice(0,i).replace(/\./g,'')) + '.' + t.slice(i+1)) || 0;
    }
    return parseFloat(t) || 0;
  }
  function euro(n){
    try{ if (typeof fmtUSD === 'function') return fmtUSD(n); }catch(e){}
    let out = (n||0).toLocaleString('es-ES', {minimumFractionDigits:2, maximumFractionDigits:2});
    if (!/^\s*\$/u.test(out)) out = '$ ' + out;
    return out;
  }
  function setTxt(id, val){
    const el = document.getElementById(id);
    if (!el) return;
    const txt = euro(val);
    if (el.textContent !== txt) el.textContent = txt;
  }
  function recalc(){
    // Lee base sin G/I que pinta el módulo de Vinil
    const baseEl = document.getElementById('vin_subtotal_no_gi');
    if (!baseEl) return;
    const base = euParse(baseEl.textContent);
    // Mano de obra
    const on = document.getElementById('vin_mo_on')?.checked;
    let mo = 0;
    if (on){
      const sueldo = euParse(document.getElementById('vin_mo_sueldo')?.value);
      const horasMes = Math.max(1, euParse(document.getElementById('vin_mo_horas_mes')?.value) || 176);
      const setup = euParse(document.getElementById('vin_mo_setup')?.value);
      const run = euParse(document.getElementById('vin_mo_run')?.value);
      const U = Math.max(0, euParse(document.getElementById('vin_mo_units')?.value) || 0);
      const tarifaH = sueldo / horasMes;
      mo = tarifaH * ((setup + run*U)/60);
      // pill
      const pill = document.getElementById('vin_mo_pill');
      if (pill){ pill.style.display='inline-flex'; setTxt('vin_mo_val', mo); }
    } else {
      const pill = document.getElementById('vin_mo_pill');
      if (pill) pill.style.display='none';
    }
    const subtotal = base + mo;
    // Ganancia / Impuestos del módulo
    const chkG = document.getElementById('vin_chk_ganancia')?.checked;
    const chkI = document.getElementById('vin_chk_impuestos')?.checked;
    const pG = euParse(document.getElementById('vin_ganancia')?.value);
    const pI = euParse(document.getElementById('vin_impuestos')?.value);
    const g = chkG ? subtotal * (pG/100) : 0;
    const i = chkI ? (subtotal + g) * (pI/100) : 0;
    // Pintar SOLO las salidas del bloque G/I (no tocamos "Total Vinil")
    setTxt('vin_subtotal', subtotal);
    setTxt('vin_ganancia_val', g);
    setTxt('vin_impuestos_val', i);
    setTxt('vin_total', subtotal + g + i);
  }
  // Abrir/cerrar Configurar
  document.addEventListener('click', function(ev){
    const btn = ev.target.closest('#vin_mo_cfg_btn');
    if (btn){
      const panel = document.getElementById('vin_mo_cfg');
      if (panel){
        panel.style.display = getComputedStyle(panel).display === 'none' ? 'flex' : 'none';
      }
    }
  });
  // Eventos de inputs/checkbox
  function bind(){
    const ids = ['vin_mo_sueldo','vin_mo_horas_mes','vin_mo_setup','vin_mo_run','vin_mo_units','vin_ganancia','vin_impuestos'];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if (el){ ['input','change'].forEach(ev=>el.addEventListener(ev, recalc)); }
    });
    const cb1 = document.getElementById('vin_mo_on'); if (cb1){ cb1.addEventListener('change', ()=>{ if(cb1.checked){ const p=document.getElementById('vin_mo_cfg'); if(p) p.style.display='flex'; } recalc(); }); }
    const cb2 = document.getElementById('vin_chk_ganancia'); if (cb2){ cb2.addEventListener('change', recalc); }
    const cb3 = document.getElementById('vin_chk_impuestos'); if (cb3){ cb3.addEventListener('change', recalc); }
  }
  // Observer: si el módulo cambia el "Total sin G/I", recalculamos
  let observer;
  function observe(){
    const tgt = document.getElementById('vin_subtotal_no_gi');
    if (!tgt) return;
    if (observer) observer.disconnect();
    observer = new MutationObserver(()=>recalc());
    observer.observe(tgt, {characterData:true, childList:true, subtree:true});
  }
  document.addEventListener('DOMContentLoaded', function(){
    bind();
    observe();
    // corrida inicial
    recalc();
  });
})();
</script>
<script>
// Robust toggle for "Configurar" (Vinil): works even if there are other handlers/styles.
(function(){
  function toggleVinPanel(force){
    var panel = document.getElementById('vin_mo_cfg');
    if(!panel) return;
    var open = panel.dataset.open === '1';
    if (force === true) open = false;
    else if (force === false) open = true;
    panel.style.display = open ? 'none' : 'flex';
    panel.dataset.open = open ? '0' : '1';
  }
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('vin_mo_cfg_btn');
    var cb  = document.getElementById('vin_mo_on');
    var panel = document.getElementById('vin_mo_cfg');
    if(panel && panel.dataset.open == null){ panel.dataset.open = (getComputedStyle(panel).display !== 'none') ? '1' : '0'; }
    if(btn){
      btn.addEventListener('click', function(e){ e.preventDefault(); toggleVinPanel(); });
    }
    if(cb){
      cb.addEventListener('change', function(){
        // If activas MO, abre el panel; si la apagas, no lo cierro a la fuerza.
        if(cb.checked){ toggleVinPanel(true); } // 'true' fuerza abrir
      });
    }
  });
})();
</script>
<script>
// Fallback delegado (fase de captura) para el botón "Configurar" de Vinil
(function(){
  function toggle(id){
    var el = document.getElementById(id);
    if(!el) return;
    var isHidden = getComputedStyle(el).display === 'none';
    el.style.display = isHidden ? 'flex' : 'none';
    el.dataset.open = isHidden ? '1' : '0';
  }
  // Escucha a nivel documento, también en CAPTURA para no depender de otros handlers
  document.addEventListener('click', function(ev){
    var btn = ev.target && (ev.target.closest('#vin_mo_cfg_btn') || (ev.target.id==='vin_mo_cfg_btn' ? ev.target : null));
    if(btn){
      ev.preventDefault();
      ev.stopPropagation();
      toggle('vin_mo_cfg');
    }
  }, true);
})();
</script>
<!-- Safe bind for Vinil 'Agregar color' if early binding missed -->
<script>
(function(){
  try{
    if(window.__vinAddBind) return; window.__vinAddBind = true;
    function safeBind(){
      var btn = document.getElementById('btn_add_color');
      if(btn && !btn.__agregado){
        btn.addEventListener('click', function(){ try{ (window.agregarBloque||window.vin_agregarBloque||window.agregar_color||function(){})() }catch(e){} });
        btn.__agregado = true;
      }
    }
    if(document.readyState==='loading'){
      document.addEventListener('DOMContentLoaded', safeBind, {once:true});
    }else{ safeBind(); }
  }catch(e){}
})();
</script>
<script>
(function(){
  const $ = (q,ctx=document)=>ctx.querySelector(q);
  const $$ = (q,ctx=document)=>Array.from(ctx.querySelectorAll(q));
  function fmtEU(n){ if(isNaN(n)||n==null)n=0; const parts=Number(n).toFixed(2).split('.'); const i=parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,'.'); return '$ ' + i + ',' + parts[1]; }
  function p(txt){ if(typeof txt!=='string') return Number(txt)||0; let t=txt.replace(/[^\d,\.\-]/g,''); if(t.includes(',') && t.lastIndexOf(',')>t.lastIndexOf('.')){ t=t.replace(/\./g,'').replace(',','.'); } const v=parseFloat(t); return isNaN(v)?0:v; }
  function unit(c,pr){ const cc=p(c), pp=p(pr); return cc>0? pp/cc : 0; }

  function calc_directos(){
    let tot=0;

    const prodUd = unit($('#esf_d_prod_cant').value, $('#esf_d_prod_precio').value);
    $('#esf_d_prod_ud').value = fmtEU(prodUd);
    const prodUse = p($('#esf_d_prod_use')?.value||1);
    const prodUsed = prodUd * prodUse;
    if($('#esf_d_prod_used')) $('#esf_d_prod_used').value = fmtEU(prodUsed);
    if($('#esf_d_prod_on').checked) tot += prodUsed;

    const vinUd = unit($('#esf_d_vinil_cant').value,$('#esf_d_vinil_precio').value);
    $('#esf_d_vinil_ud').value=fmtEU(vinUd);
    const vinUse = p($('#esf_d_vinil_use')?.value||1);
    const vinUsed = vinUd * vinUse;
    if($('#esf_d_vinil_used')) $('#esf_d_vinil_used').value = fmtEU(vinUsed);
    if($('#esf_d_vinil_on').checked) tot += vinUsed;

    const papUd = unit($('#esf_d_papel_cant').value,$('#esf_d_papel_precio').value);
    $('#esf_d_papel_ud').value=fmtEU(papUd);
    const papUse = p($('#esf_d_papel_use')?.value||1);
    const papUsed = papUd * papUse;
    if($('#esf_d_papel_used')) $('#esf_d_papel_used').value = fmtEU(papUsed);
    if($('#esf_d_papel_on').checked) tot += papUsed;

    const nivUd = unit($('#esf_d_nieve_cant').value,$('#esf_d_nieve_precio').value);
    $('#esf_d_nieve_ud').value=fmtEU(nivUd);
    const nivUse = p($('#esf_d_nieve_use')?.value||1);
    const nivUsed = nivUd * nivUse;
    if($('#esf_d_nieve_used')) $('#esf_d_nieve_used').value = fmtEU(nivUsed);
    if($('#esf_d_nieve_on').checked) tot += nivUsed;

    const extUd = unit($('#esf_d_extra_cant').value,$('#esf_d_extra_precio').value);
    $('#esf_d_extra_ud').value=fmtEU(extUd);
    const extUse = p($('#esf_d_extra_use')?.value||1);
    const extUsed = extUd * extUse;
    if($('#esf_d_extra_used')) $('#esf_d_extra_used').value = fmtEU(extUsed);
    if($('#esf_d_extra_on').checked) tot += extUsed;

    const uds=Math.max(1,parseInt($('#esf_d_cinta_udxrollo').value||'45',10));
    const pr=p($('#esf_d_cinta_precio').value);
    const cinUd=pr/uds;
    $('#esf_d_cinta_ud').value=fmtEU(cinUd);
    const cinUse = p($('#esf_d_cinta_use')?.value||1);
    const cinUsed = cinUd * cinUse;
    if($('#esf_d_cinta_used')) $('#esf_d_cinta_used').value = fmtEU(cinUsed);
    if($('#esf_d_cinta_on').checked) tot += cinUsed;

    const silUd = unit($('#esf_d_silicon_cant').value,$('#esf_d_silicon_precio').value);
    $('#esf_d_silicon_ud').value=fmtEU(silUd);
    const silUse = p($('#esf_d_silicon_use')?.value||1);
    const silUsed = silUd * silUse;
    if($('#esf_d_silicon_used')) $('#esf_d_silicon_used').value = fmtEU(silUsed);
    if($('#esf_d_silicon_on').checked) tot += silUsed;

    $('#esf_total_directos').textContent = fmtEU(tot);
    return tot;
  }

  function calc_depr(){
    let tot=0; const unitsPerMonth=100;
    ['impresora','plancha','pc','plotter','cuchilla','tapete','pistola'].forEach(r=>{
      const on = $(`.esf_dep_on[data-row="${r}"]`)?.checked;
      const precio = p($(`.esf_dep_precio[data-row="${r}"]`)?.value||0);
      const vida = p($(`.esf_dep_vida[data-row="${r}"]`)?.value||0);
      let ud=0, mes=0;

      if(r==='cuchilla' || r==='tapete'){
        ud = vida>0? (precio/vida):0;
        mes = 0;
      } else {
        mes = precio/24;
        ud = mes/unitsPerMonth;
      }

      const mesEl = $(`.esf_dep_mes[data-row="${r}"]`); if(mesEl) mesEl.value = fmtEU(mes);
      const udEl = $(`.esf_dep_ud[data-row="${r}"]`); if(udEl) udEl.value = fmtEU(ud);

      const usos = p($(`.esf_dep_usos[data-row="${r}"]`)?.value||1);
      const used = ud * usos;
      const usedEl = $(`.esf_dep_used[data-row="${r}"]`); if(usedEl) usedEl.value = fmtEU(used);

      if(on) tot += used;
    });
    $('#esf_total_depr').textContent = fmtEU(tot);
    return tot;
  }

  function calc_indirectos(){
    const on = $('#esf_ind_on').checked;
    const fields=['alquiler','internet','suscripciones','transporte','electricidad','publicidad','otros'];
    let mens=0; fields.forEach(k=> mens += p($(`#esf_ind_${k}`).value||0));
    const units=Math.max(1,parseInt($('#esf_ind_units').value||'100',10));
    const ud = on ? (mens/units) : 0;
    $('#esf_ind_ud').textContent = fmtEU(ud);
    return ud;
  }

  function calc_mo(){
    if(!$('#esf_mo_on').checked){ $('#esf_mo_val').textContent = fmtEU(0); $('#esf_mo_pill').style.display='none'; return 0; }
    const sueldo=p($('#esf_mo_sueldo').value||0);
    const horasMes=p($('#esf_mo_horas_mes').value||0);
    const setupMin=p($('#esf_mo_setup').value||0);
    const runMin=p($('#esf_mo_run').value||0);
    const units=Math.max(1,p($('#esf_mo_units').value||1));
    const costoMin=(horasMes>0)?(sueldo/(horasMes*60)):0;
    const totalMin=setupMin + (runMin*units);
    const val=(totalMin*costoMin)/units;
    $('#esf_mo_val').textContent=fmtEU(val);
    $('#esf_mo_pill').style.display = val>0 ? '' : 'none';
    return val;
  }

  function recalc_all(){
    const d=calc_directos();
    const e=calc_depr();
    const i=calc_indirectos();
    const mo=calc_mo();
    const subNoGI=d+e+i+mo;
    $('#esf_subtotal_no_gi').textContent=fmtEU(subNoGI);
    $('#esf_subtotal').textContent=fmtEU(subNoGI);
    const ganOn=$('#esf_chk_ganancia').checked;
    const impOn=$('#esf_chk_impuestos').checked;
    const ganPct=p($('#esf_ganancia').value||0);
    const impPct=p($('#esf_impuestos').value||0);
    const mode=(document.getElementById('esf_modo_ganancia')?.value||'markup');
    const ganVal=ganOn? (mode==='margen' ? subNoGI*(ganPct/ (100-ganPct)) : subNoGI*(ganPct/100)) : 0;
    const impVal=impOn? (subNoGI+ganVal)*(impPct/100):0;
    $('#esf_ganancia_val').textContent=fmtEU(ganVal);
    $('#esf_impuestos_val').textContent=fmtEU(impVal);
    $('#esf_total').textContent=fmtEU(subNoGI+ganVal+impVal);
  }

  const root=document.getElementById('view-esferas-navidenas');
  if(root){
    $$('input,select', root).forEach(el=>{ ['input','change'].forEach(ev=> el.addEventListener(ev, recalc_all)); });
    $('#esf_ind_cfg_btn')?.addEventListener('click', ()=>{
      const el=$('#esf_ind_cfg'); el.style.display=(el.style.display==='none'||!el.style.display)?'block':'none';
    });
    $('#esf_mo_cfg_btn')?.addEventListener('click', ()=>{
      const el=$('#esf_mo_cfg'); el.style.display=(el.style.display==='none'?'flex':'none');
    });
    
    // Sincroniza visibilidad de Mano de obra con el checkbox (auto open/close)
    const moChk = $('#esf_mo_on');
    const moCfg = $('#esf_mo_cfg');
    function syncMoCfg(){
      if (!moCfg) return;
      moCfg.style.display = (moChk && moChk.checked) ? 'flex' : 'none';
    }
    moChk && moChk.addEventListener('change', syncMoCfg, {passive:true});
    // Llamar una vez para estado inicial
    syncMoCfg();
$('#esf_btn_reset')?.addEventListener('click', ()=>{
      $$('input[type=checkbox]', root).forEach(ch=> ch.checked=false);
      $('#esf_mo_cfg').style.display='none';
      $('#esf_ind_cfg').style.display='none';
      // Consumo real: reset de cantidades a utilizar
      ['esf_d_prod_use','esf_d_vinil_use','esf_d_papel_use','esf_d_nieve_use','esf_d_extra_use','esf_d_cinta_use','esf_d_silicon_use'].forEach(id=>{ const el=$('#'+id); if(el) el.value=1; });
      $$('.esf_dep_usos', root).forEach(el=>{ el.value=1; });
      recalc_all();
    });
    window.addEventListener('load', recalc_all);
  }
})();
</script>
<script>
(function(){
  function setMargenDefault(){
    var sel = document.getElementById('esf_modo_ganancia');
    if (sel) sel.value = 'margen';
  }
  window.addEventListener('load', function(){
    setMargenDefault();
    var btn = document.getElementById('esf_btn_reset');
    if (btn) btn.addEventListener('click', function(){ setMargenDefault(); });
  });
})();
</script>

<style id="vinil-summary-total-dark-fix">
/* === VINIL – Resumen / Total Vinil: modo oscuro (Total Vinil) === */
body.dark #view-vinil #vinil_summary.card{
  background:#0f1522 !important;
  border-color:#1f2536 !important;
}
body.dark #view-vinil #vinil_summary .tot{
  color:#f9fafb !important;
}
body.dark #view-vinil #vinil_summary .tot .result{
  background:#0b1120 !important;
  color:#e5e7eb !important;
}
</style>
<script>
/* Cantidad de productos (Sublimación) – bloque no intrusivo */
(function(){
  if (!document.getElementById('view-sublimacion')) return;

  // Helper local para obtener elementos
  var $id = function(id){ return document.getElementById(id); };

  // Parser tolerante a formato europeo y helpers globales (euParse/parseEU)
  function parseEUAny(v){
    try{
      if (typeof euParse === 'function') return euParse(v);
    }catch(e){}
    try{
      if (typeof parseEU === 'function') return parseEU(v);
    }catch(e){}
    if (v == null) return 0;
    if (typeof v === 'number') return isFinite(v) ? v : 0;
    if (typeof v !== 'string') v = String(v);
    // Limpia símbolos y adapta coma decimal
    var s = v.replace(/[^0-9.,-]/g,'').replace(/\./g,'').replace(/,/g,'.');
    var n = parseFloat(s);
    return isFinite(n) ? n : 0;
  }

  // Formateador tolerante: intenta fmtEU/fmtUSD, si no, usa fallback local
  function fmtEUAny(n){
    try{
      if (typeof fmtEU === 'function') return fmtEU(n);
    }catch(e){}
    try{
      if (typeof fmtUSD === 'function') return fmtUSD(n);
    }catch(e){}
    if (!isFinite(n)) n = 0;
    var s = (Math.round(n*100)/100).toFixed(2).replace('.',',');
    return '$ ' + s;
  }

  // Lee número desde span/input usando los helpers globales si existen
  function getNumericFromSpanOrInput(id){
    var el = $id(id);
    if (!el) return 0;
    var raw = (el.tagName === 'INPUT') ? el.value : (el.textContent || el.innerText || '');
    return parseEUAny(raw);
  }

  function setResult(id, n){
    var el = $id(id);
    if (!el) return;
    el.textContent = fmtEUAny(n);
  }

  function recalc(){
    var on = $id('sub_qty_on');
    var qtyInput = $id('sub_qty');

    if (!on || !qtyInput){
      return;
    }

    // Apagado: pills en 0 y salir sin tocar el módulo
    if (!on.checked){
      setResult('sub_qty_base', 0);
      setResult('sub_qty_subtotal', 0);
      setResult('sub_qty_g', 0);
      setResult('sub_qty_i', 0);
      setResult('sub_qty_total', 0);
      return;
    }

    // Cantidad Q (mínimo 1)
    var q = parseEUAny(qtyInput.value);
    if (!isFinite(q) || q < 1){
      q = 1;
      qtyInput.value = '1';
    } else {
      q = Math.floor(q);
      if (q < 1){
        q = 1;
        qtyInput.value = '1';
      } else {
        qtyInput.value = String(q);
      }
    }

    // Leer SIEMPRE las pills por unidad del módulo sub_v15 (solo lectura)
    var baseUnit     = getNumericFromSpanOrInput('sub_v15_subtotal_no_gi');
    var subtotalUnit = getNumericFromSpanOrInput('sub_v15_subtotal');
    var gUnit        = getNumericFromSpanOrInput('sub_v15_ganancia_val');
    var iUnit        = getNumericFromSpanOrInput('sub_v15_impuestos_val');
    var totalUnit    = getNumericFromSpanOrInput('sub_v15_total');

    // Multiplicación por cantidad
    var baseQ     = baseUnit * q;
    var subtotalQ = subtotalUnit * q;
    var gQ        = gUnit * q;
    var iQ        = iUnit * q;
    var totalQ    = totalUnit * q;

    // Pintar SOLO en las pills de cantidad
    setResult('sub_qty_base', baseQ);
    setResult('sub_qty_subtotal', subtotalQ);
    setResult('sub_qty_g', gQ);
    setResult('sub_qty_i', iQ);
    setResult('sub_qty_total', totalQ);
  }

  function bind(){
    var root = document.getElementById('view-sublimacion');
    if (!root) return;

    // Eventos directos sobre el bloque de cantidad y controles de G/I, modo y MO
    [
      'sub_qty_on',
      'sub_qty',
      'sub_v15_chk_ganancia',
      'sub_v15_ganancia',
      'sub_v15_chk_impuestos',
      'sub_v15_impuestos',
      'sub_v15_ganancia_mode',
      'sub_v15_mo_on'
    ].forEach(function(id){
      var el = $id(id);
      if (!el) return;
      ['input','change'].forEach(function(ev){
        el.addEventListener(ev, recalc);
      });
    });

    // Delegado para cambios dentro de la config de Mano de Obra (si existe)
    var moCfg = $id('sub_v15_mo_cfg');
    if (moCfg){
      ['input','change'].forEach(function(ev){
        moCfg.addEventListener(ev, recalc);
      });
    }

    // MutationObserver local — escucha cambios en las pills por unidad del módulo sub_v15
    if (window.MutationObserver){
      var obs = new MutationObserver(recalc);
      [
        'sub_v15_subtotal_no_gi',
        'sub_v15_subtotal',
        'sub_v15_ganancia_val',
        'sub_v15_impuestos_val',
        'sub_v15_total',
        'sub_v15_mo_val' // opcional si existe
      ].forEach(function(id){
        var el = $id(id);
        if (el){
          obs.observe(el, {childList:true, characterData:true, subtree:true});
        }
      });
    }

    // Primer cálculo
    recalc();
  }

  if (document.readyState === 'complete'){
    bind();
  } else {
    window.addEventListener('load', bind);
  }
})();
</script>



<script>

// === Papelería — Cantidad de productos (Q) — v2 sincronizada con módulo ===
(function(){
  if (!document.getElementById('view-papeleria')) return;

  // Helper local para obtener elementos
  var $id = function(id){ return document.getElementById(id); };

  // Parser tolerante a formato europeo y helpers globales
  function parseEUAny(v){
    try{ if (typeof euParse === 'function') return euParse(v); }catch(e){}
    try{ if (typeof parseEU === 'function') return parseEU(v); }catch(e){}
    if (v == null) return 0;
    if (typeof v === 'number') return isFinite(v) ? v : 0;
    if (typeof v !== 'string') v = String(v);
    var s = v.replace(/[^0-9.,-]/g,'');
    if (s.indexOf(',') >= 0 && s.indexOf('.') >= 0){
      s = s.replace(/\./g,'').replace(/,/g,'.');
    } else if (s.indexOf(',') >= 0){
      s = s.replace(/,/g,'.');
    }
    var n = parseFloat(s);
    return isFinite(n) ? n : 0;
  }

  // Formateador tolerante: intenta fmtEU/fmtUSD, fallback simple
  function fmtEUAny(n){
    try{ if (typeof fmtEU === 'function') return fmtEU(n); }catch(e){}
    try{ if (typeof fmtUSD === 'function') return fmtUSD(n); }catch(e){}
    if (!isFinite(n)) n = 0;
    var s = n.toFixed(2).replace('.',',');
    return '$ ' + s;
  }

  // Lee número desde span/input usando los helpers globales si existen
  function getNumericFromSpanOrInput(id){
    var el = $id(id);
    if (!el) return 0;
    var v = ('value' in el) ? el.value : (el.textContent || el.innerText || '');
    return parseEUAny(v);
  }

  // Escribe resultado formateado en una pill del bloque de cantidad
  function setResult(id, val){
    var el = $id(id);
    if (!el) return;
    el.textContent = fmtEUAny(val);
  }

  // Recalcula SOLO usando las pills por unidad del módulo Papelería
  function recalcPapQty(){
    var qtyOn = $id('pap_qty_on');
    var qtyInput = $id('pap_qty');
    if (!qtyOn || !qtyInput) return;

    // OFF → todas las pills del bloque en 0,00 sin tocar las per-unidad
    if (!qtyOn.checked){
      setResult('pap_qty_base', 0);
      setResult('pap_qty_subtotal', 0);
      setResult('pap_qty_g', 0);
      setResult('pap_qty_i', 0);
      setResult('pap_qty_total', 0);
      return;
    }

    // Q mínima = 1; normaliza el input
    var rawQ = (qtyInput.value || '').trim();
    var Q = parseInt(rawQ || '1', 10);
    if (!isFinite(Q) || Q < 1) Q = 1;
    if (String(Q) !== rawQ){
      qtyInput.value = Q;
    }

    // 1) Valores por unidad ya calculados por el módulo
    var base       = getNumericFromSpanOrInput('pap_subtotal_no_gi');
    var subtotalU  = getNumericFromSpanOrInput('pap_subtotal');
    var gU         = getNumericFromSpanOrInput('pap_ganancia_val');
    var iU         = getNumericFromSpanOrInput('pap_impuestos_val');
    var totalU     = getNumericFromSpanOrInput('pap_total');

    // 2) Multiplicación por cantidad
    setResult('pap_qty_base',     base      * Q);
    setResult('pap_qty_subtotal', subtotalU * Q);
    setResult('pap_qty_g',        gU        * Q);
    setResult('pap_qty_i',        iU        * Q);
    setResult('pap_qty_total',    totalU    * Q);
  }

  // Wire de eventos y observadores locales
  function wirePapQty(){
    // Eventos de bloque cantidad + G/I + modo + MO
    var ids = [
      'pap_qty_on','pap_qty',
      'pap_chk_ganancia','pap_ganancia',
      'pap_chk_impuestos','pap_impuestos',
      'pap_ganancia_mode',
      'pap_mo_on'
    ];
    ids.forEach(function(id){
      var el = $id(id);
      if (!el) return;
      el.addEventListener('change', recalcPapQty);
      if (el.tagName === 'INPUT' || el.tagName === 'SELECT'){
        el.addEventListener('input', recalcPapQty);
      }
    });

    // Listeners delegados sobre el contenedor de Mano de obra, si existe
    var moCfg = $id('pap_mo_cfg');
    if (moCfg){
      ['input','change'].forEach(function(ev){
        moCfg.addEventListener(ev, function(e){
          if (!e || !e.target) return;
          var t = e.target;
          if (t.matches && t.matches('input,select,textarea')){
            recalcPapQty();
          }
        });
      });
    }

    // Observer local para mantener sincronía con los cálculos per-unidad
    if (window.MutationObserver){
      var obs = new MutationObserver(recalcPapQty);
      [
        'pap_subtotal_no_gi',
        'pap_subtotal',
        'pap_ganancia_val',
        'pap_impuestos_val',
        'pap_total',
        'pap_mo_val'
      ].forEach(function(id){
        var el = $id(id);
        if (el){
          obs.observe(el, {childList:true,subtree:true,characterData:true});
        }
      });
    }

    // Primer cálculo para dejar el bloque consistente con el estado actual
    recalcPapQty();
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive'){
    wirePapQty();
  } else {
    window.addEventListener('load', wirePapQty);
  }
})();

// --- Vinil: bloque "Cantidad de productos" (no intrusivo, solo lectura de pills) ---
(function(){
  if (!document.getElementById('view-vinil')) return;

  // Helper local para obtener elementos
  var $id = function(id){ return document.getElementById(id); };

  // Parser tolerante a formato europeo y helpers globales
  function parseEUAny(v){
    try{
      if (typeof euParse === 'function') return euParse(v);
    }catch(e){}
    try{
      if (typeof parseEU === 'function') return parseEU(v);
    }catch(e){}
    if (v == null) return 0;
    if (typeof v === 'number') return isFinite(v) ? v : 0;
    if (typeof v !== 'string') v = String(v);
    // Limpia símbolos y adapta coma decimal
    var s = v.replace(/[^0-9.,-]/g,'').replace(/\./g,'').replace(/,/g,'.');
    var n = parseFloat(s);
    return isFinite(n) ? n : 0;
  }

  // Formateador tolerante: intenta fmtEU/fmtUSD, fallback simple
  function fmtEUAny(n){
    try{
      if (typeof fmtEU === 'function') return fmtEU(n);
    }catch(e){}
    try{
      if (typeof fmtUSD === 'function') return fmtUSD(n);
    }catch(e){}
    if (!isFinite(n)) n = 0;
    var s = n.toFixed(2).replace('.',',');
    return '$ ' + s;
  }

  // Lee número desde span/input usando los helpers globales si existen
  function getNumericFromSpanOrInput(id){
    var el = $id(id);
    if (!el) return 0;
    var v = '';
    if ('value' in el) v = el.value;
    else v = el.textContent || el.innerText || '';
    return parseEUAny(v);
  }

  // Escribe resultado formateado en una pill
  function setResult(id, val){
    var el = $id(id);
    if (!el) return;
    el.textContent = fmtEUAny(val);
  }

  // Recalcula bloque de cantidad usando SOLO las pills por unidad de Vinil
  function recalc(){
    var qtyOn    = $id('vinil_qty_on');
    var qtyInput = $id('vinil_qty');

    if (!qtyOn || !qtyInput) return;

    // OFF → todo el bloque en 0,00 sin tocar las pills originales
    if (!qtyOn.checked){
      setResult('vinil_qty_base',     0);
      setResult('vinil_qty_subtotal', 0);
      setResult('vinil_qty_g',        0);
      setResult('vinil_qty_i',        0);
      setResult('vinil_qty_total',    0);
      return;
    }

    // Q mínima = 1 (forzar y sincronizar en el input)
    var rawQ = (qtyInput.value || '').trim();
    var Q = parseInt(rawQ || '1', 10);
    if (!isFinite(Q) || Q < 1) Q = 1;
    if (String(Q) !== rawQ){
      qtyInput.value = Q;
    }

    // 1) Base sin G/I por unidad
    var base = getNumericFromSpanOrInput('vin_subtotal_no_gi');

    // 2) Subtotal, Ganancia, Impuestos y Total por unidad
    var subtotalUnit = getNumericFromSpanOrInput('vin_subtotal');
    var gUnit        = getNumericFromSpanOrInput('vin_ganancia_val');
    var iUnit        = getNumericFromSpanOrInput('vin_impuestos_val');
    var totalUnit    = getNumericFromSpanOrInput('vin_total');

    // 3) Multiplicación por cantidad
    var baseQ     = base         * Q;
    var subtotalQ = subtotalUnit * Q;
    var gQ        = gUnit        * Q;
    var iQ        = iUnit        * Q;
    var totalQ    = totalUnit    * Q;

    // 4) Pintar SOLO en las pills del bloque cantidad
    setResult('vinil_qty_base',     baseQ);
    setResult('vinil_qty_subtotal', subtotalQ);
    setResult('vinil_qty_g',        gQ);
    setResult('vinil_qty_i',        iQ);
    setResult('vinil_qty_total',    totalQ);
  }

  function bind(){
    var root = document.getElementById('view-vinil');
    if (!root) return;

    // Eventos directos sobre el bloque de cantidad y G/I + modo + MO ON/OFF
    [
      'vinil_qty_on',
      'vinil_qty',
      'vin_chk_ganancia',
      'vin_ganancia',
      'vin_chk_impuestos',
      'vin_impuestos',
      'vin_mo_on',
      'vin_ganancia_mode'
    ].forEach(function(id){
      var el = $id(id);
      if (!el) return;
      ['input','change'].forEach(function(ev){
        el.addEventListener(ev, recalc);
      });
    });

    // Listeners delegados sobre el contenedor de Mano de Obra, si existe
    var moCfg = document.getElementById('vin_mo_cfg');
    if (moCfg){
      ['input','change'].forEach(function(ev){
        moCfg.addEventListener(ev, function(e){
          var t = e.target;
          if (!t) return;
          if (t.matches('input,select,textarea')){
            recalc();
          }
        });
      });
    }

    // MutationObserver sincronizado con las pills per-unidad del módulo Vinil
    if (window.MutationObserver){
      var obs = new MutationObserver(recalc);
      [
        'vin_subtotal_no_gi',
        'vin_subtotal',
        'vin_ganancia_val',
        'vin_impuestos_val',
        'vin_total',
        'vin_mo_val'          // opcional, si existe en el DOM
      ].forEach(function(id){
        var el = $id(id);
        if (el){
          obs.observe(el, { childList:true, characterData:true, subtree:true });
        }
      });
    }

    // Primer cálculo
    recalc();
  }

  if (document.readyState === 'complete'){
    bind();
  } else {
    window.addEventListener('load', bind);
  }
})();
;

/* Cantidad de productos (Esferas navideñas) – bloque no intrusivo */
(function(){
  if (!document.getElementById('view-esferas-navidenas')) return;

  var $id = function(id){ return document.getElementById(id); };

  // Parser tolerante a formato europeo y helpers globales
  function parseEUAny(v){
    try{
      if (typeof euParse === 'function') return euParse(v);
    }catch(e){}
    try{
      if (typeof parseEU === 'function') return parseEU(v);
    }catch(e){}
    if (v == null) return 0;
    if (typeof v === 'number') return isFinite(v) ? v : 0;
    if (typeof v !== 'string') v = String(v);
    // Limpia símbolos y adapta coma decimal
    var s = v.replace(/[^0-9.,-]/g,'').replace(/\./g,'').replace(/,/g,'.');
    var n = parseFloat(s);
    return isFinite(n) ? n : 0;
  }

  // Formateador tolerante: intenta fmtEU/fmtUSD, fallback simple
  function fmtEUAny(n){
    try{
      if (typeof fmtEU === 'function') return fmtEU(n);
    }catch(e){}
    try{
      if (typeof fmtUSD === 'function') return fmtUSD(n);
    }catch(e){}
    if (!isFinite(n)) n = 0;
    var s = n.toFixed(2).replace('.',',');
    return '$ ' + s;
  }

  function getNumericFromSpanOrInput(id){
    var el = $id(id);
    if (!el) return 0;
    var v = '';
    if ('value' in el) v = el.value;
    else v = el.textContent || el.innerText || '';
    return parseEUAny(v);
  }

  function setResult(id, val){
    var el = $id(id);
    if (!el) return;
    el.textContent = fmtEUAny(val);
  }

  function bind(){
    var qtyOn = $id('esf_qty_on');
    var qtyInput = $id('esf_qty');
    if (!qtyOn || !qtyInput) return;

    function recalc(){
      if (!qtyOn || !qtyInput) return;

      if (!qtyOn.checked){
        // Cuando está apagado, dejamos el bloque en 0 (solo vista)
        setResult('esf_qty_base', 0);
        setResult('esf_qty_subtotal', 0);
        setResult('esf_qty_g', 0);
        setResult('esf_qty_i', 0);
        setResult('esf_qty_total', 0);
        return;
      }

      var Q = parseInt(qtyInput.value || '1', 10);
      if (!isFinite(Q) || Q < 1) Q = 1;

      // Base sin G/I (per‑unidad) = Directos + Depr + Indirectos (sin MO)
      var base = getNumericFromSpanOrInput('esf_subtotal_no_gi');

      // Leemos siempre desde las pills ya calculadas por el módulo (respeta Markup/Margen y demás lógica)
      var subtotalUnit = getNumericFromSpanOrInput('esf_subtotal');
      var gUnit = getNumericFromSpanOrInput('esf_ganancia_val');
      var iUnit = getNumericFromSpanOrInput('esf_impuestos_val');
      var totalUnit = getNumericFromSpanOrInput('esf_total');

      var baseQ = base * Q;
      var subtotalQ = subtotalUnit * Q;
      var gQ = gUnit * Q;
      var iQ = iUnit * Q;
      var totalQ = totalUnit * Q;

      setResult('esf_qty_base', baseQ);
      setResult('esf_qty_subtotal', subtotalQ);
      setResult('esf_qty_g', gQ);
      setResult('esf_qty_i', iQ);
      setResult('esf_qty_total', totalQ);
    }

    ['esf_qty_on','esf_qty','esf_chk_ganancia','esf_ganancia','esf_chk_impuestos','esf_impuestos','esf_mo_on','esf_modo_ganancia'].forEach(function(id){
      var el = $id(id);
      if (!el) return;
      var evs = (id === 'esf_qty') ? ['input','change'] : ['change'];
      evs.forEach(function(ev){
        el.addEventListener(ev, recalc);
      });
    });

    if (window.MutationObserver){
      var baseEl = $id('esf_subtotal_no_gi');
      var moEl = $id('esf_mo_val');
      var obs = new MutationObserver(recalc);
      if (baseEl) obs.observe(baseEl, {childList:true,characterData:true,subtree:true});
      if (moEl) obs.observe(moEl, {childList:true,characterData:true,subtree:true});
    }

    // Primer cálculo
    recalc();
  }

  if (document.readyState === 'complete') bind();
  else window.addEventListener('load', bind);
})()

</script>

<script>
// --- Papelería: bloque "Cantidad de productos" (no intrusivo, solo lectura de pills) ---
(function(){
  if (!document.getElementById('view-papeleria')) return;

  function $id(id){ return document.getElementById(id); }

  // Parser tolerante a formato europeo y helpers globales
  function parseEUAny(v){
    try{
      if (typeof euParse === 'function') return euParse(v);
    }catch(e){}
    try{
      if (typeof parseEU === 'function') return parseEU(v);
    }catch(e){}
    if (v == null) return 0;
    if (typeof v === 'number') return isFinite(v) ? v : 0;
    if (typeof v !== 'string') v = String(v);
    v = v.trim();
    if (!v) return 0;
    v = v.replace(/[^0-9,.,-]/g, '');
    if (v.indexOf(',') > -1 && v.indexOf('.') > -1){
      v = v.replace(/\./g, '').replace(',', '.');
    } else if (v.indexOf(',') > -1){
      v = v.replace(',', '.');
    }
    var n = parseFloat(v);
    return isFinite(n) ? n : 0;
  }

  // Formateador tolerante: intenta fmtEU/fmtUSD, fallback simple
  function fmtEUAny(n){
    try{
      if (typeof fmtEU === 'function') return fmtEU(n);
    }catch(e){}
    try{
      if (typeof fmtUSD === 'function') return fmtUSD(n);
    }catch(e){}
    if (!isFinite(n)) n = 0;
    var s = (Math.round(n * 100) / 100).toFixed(2).replace('.', ',');
    return '$ ' + s;
  }

  function getNumericFromSpanOrInput(id){
    var el = $id(id);
    if (!el) return 0;
    var raw = ('value' in el) ? el.value : (el.textContent || el.innerText || '');
    return parseEUAny(raw);
  }

  function setResult(id, val){
    var el = $id(id);
    if (!el) return;
    el.textContent = fmtEUAny(val);
  }

  function recalc(){
    var qtyOn = $id('pap_qty_on');
    var qtyInput = $id('pap_qty');
    if (!qtyOn || !qtyInput) return;

    if (!qtyOn.checked){
      // Apagado: solo dejamos el bloque en 0 (no toca pills originales)
      setResult('pap_qty_base', 0);
      setResult('pap_qty_subtotal', 0);
      setResult('pap_qty_g', 0);
      setResult('pap_qty_i', 0);
      setResult('pap_qty_total', 0);
      return;
    }

    var Q = parseInt(qtyInput.value || '1', 10);
    if (!isFinite(Q) || Q < 1) Q = 1;
    qtyInput.value = Q;

    // Base sin G/I per-unidad (Directos + Depr + Indirectos, sin MO)
    var base = getNumericFromSpanOrInput('pap_subtotal_no_gi');

    // Leemos siempre desde las pills ya calculadas por el módulo
    var subtotalUnit = getNumericFromSpanOrInput('pap_subtotal');
    var gUnit = getNumericFromSpanOrInput('pap_ganancia_val');
    var iUnit = getNumericFromSpanOrInput('pap_impuestos_val');
    var totalUnit = getNumericFromSpanOrInput('pap_total');

    var baseQ = base * Q;
    var subtotalQ = subtotalUnit * Q;
    var gQ = gUnit * Q;
    var iQ = iUnit * Q;
    var totalQ = totalUnit * Q;

    setResult('pap_qty_base', baseQ);
    setResult('pap_qty_subtotal', subtotalQ);
    setResult('pap_qty_g', gQ);
    setResult('pap_qty_i', iQ);
    setResult('pap_qty_total', totalQ);
  }

  function bind(){
    var root = document.getElementById('view-papeleria');
    if (!root) return;

    // Eventos directos del bloque y G/I/MO relacionados
    [
      'pap_qty_on','pap_qty',
      'pap_chk_ganancia','pap_ganancia',
      'pap_chk_impuestos','pap_impuestos',
      'pap_mo_on'
    ].forEach(function(id){
      var el = $id(id);
      if (!el) return;
      ['input','change'].forEach(function(ev){
        el.addEventListener(ev, recalc);
      });
    });

    // Observer local para mantener sincronía con los cálculos per-unidad
    if (window.MutationObserver){
      var baseEl = $id('pap_subtotal_no_gi');
      var moEl = $id('pap_mo_val');
      var obs = new MutationObserver(function(){
        recalc();
      });
      if (baseEl) obs.observe(baseEl, {childList:true,characterData:true,subtree:true});
      if (moEl) obs.observe(moEl, {childList:true,characterData:true,subtree:true});
    }

    recalc();
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive'){
    bind();
  } else {
    window.addEventListener('load', bind);
  }
})();
</script>

<script>
/* === PWA: bind update buttons (delegated) === */
(function(){
  function handler(ev){
    var t = ev.target;
    if (!t) return;
    var el = t.closest && t.closest('#btn_check_updates,[data-action="check-updates"]');
    if (!el) return;
    ev.preventDefault();
    if (window.SuitePWA && typeof window.SuitePWA.checkUpdates === 'function'){
      window.SuitePWA.checkUpdates();
    }
  }
  document.addEventListener('click', handler, true);
})();
</script>

</body>
</html>
